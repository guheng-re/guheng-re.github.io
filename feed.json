{
    "version": "https://jsonfeed.org/version/1",
    "title": "oaciaã®BbBlog~",
    "subtitle": "DEVIL or SWEET",
    "icon": "https://oacia.dev/images/favicon.ico",
    "description": "æœˆé‡ä»äº‘ èŠ±é‡å’Œé£",
    "home_page_url": "https://oacia.dev",
    "items": [
        {
            "id": "https://oacia.dev/bilibili-get-ticket/",
            "url": "https://oacia.dev/bilibili-get-ticket/",
            "title": "bç«™appæ¼«å±•æŠ¢ç¥¨",
            "date_published": "2024-07-13T10:14:21.000Z",
            "content_html": "<h1 id=\"å‰è¨€\"><a class=\"anchor\" href=\"#å‰è¨€\">#</a> å‰è¨€</h1>\n<p>æœ€è¿‘èŒç”Ÿäº†æƒ³å»æ¼«å±•çš„æƒ³æ³•ï¼Œæ¯•ç«Ÿè¿™ä¹ˆä¹…äº†è¿˜æ²¡æœ‰å»è¿‡ä¸€æ¬¡æ¼«å±•å˜ï¼Œå¬è¯´ cp30 å¥½åƒä¸é”™ï¼Œä¸è¿‡é—®é¢˜å°±æ˜¯ç¥¨ç‰¹åˆ«çš„éš¾æŠ¢ğŸ˜”</p>\n<p>è¶ç°åœ¨ cp30 ä¹°ç¥¨è¿˜æ²¡å¼€å§‹ï¼Œä»Šå¤©ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå…¶ä»–çš„äº‹æƒ…ï¼Œæ‰€ä»¥å°±ç®€å•åˆ†æäº†ä¸€ä¸‹ b ç«™çš„ appï¼Œå†™äº†ä¸ªæŠ¢ç¥¨è„šæœ¬è‡ªå¨±è‡ªä¹ä¸€ä¸‹</p>\n<p>æ„Ÿè§‰è¿™ä¸ª app è¿˜æ˜¯å¾ˆæœ‰æ„æ€çš„ï¼Œå®ƒæŠŠä¸»è¦çš„ webview ä¸šåŠ¡é€»è¾‘æ”¾åˆ°å­è¿›ç¨‹é‡Œè¿è¡Œæˆ‘è§‰å¾—è¿˜æ˜¯å¾ˆä¸é”™æ»´ï¼Œè¿™æ · frida æ³¨å…¥åˆ°ä¸»è¿›ç¨‹å°± hook ä¸åˆ°äº†ï¼ˆæˆ‘å°±è¢«å¡äº†å¿«ä¸€ä¸ªå°æ—¶ï¼ï¼‰</p>\n<p>ä½†è¿™ä¸ªæŠ¢ç¥¨è„šæœ¬å†™çš„ç›¸å½“çš„ç®€é™‹ï¼Œæˆ‘å°±ä¸å¥½æ„æ€æ”¾å‡ºæ¥å•¦ğŸ˜‚ä¸è¿‡ç›¸ä¿¡å¤§å®¶åœ¨ github ä¸Šåº”è¯¥å¯ä»¥æ‰¾åˆ°æ›´åŠ å®Œå–„çš„é¡¹ç›®å§ <code>:)</code></p>\n<p>è¿˜æœ‰å°±æ˜¯ä¸ºä»€ä¹ˆä¸ç›´æ¥å» b ç«™ä¼šå‘˜è´­ç½‘é¡µç«¯åˆ†æå‘¢ï¼Œè¿™æ ·è´­ç¥¨æ¥å£ä¸æ˜¯ä¸€ä¸‹å­å°±çœ‹åˆ°äº†å˜›å°±ä¸éœ€è¦ç»•å„ç§æ£€æµ‹äº†</p>\n<p><strong>just for fun!</strong></p>\n<h1 id=\"åŸºæœ¬ä¿¡æ¯\"><a class=\"anchor\" href=\"#åŸºæœ¬ä¿¡æ¯\">#</a> åŸºæœ¬ä¿¡æ¯</h1>\n<p>åŒ…å:  <code>tv.danmaku.bili</code></p>\n<p>å…¥å£:  <code>tv.danmaku.bili.MainActivityV2</code></p>\n<h1 id=\"fridaåè°ƒè¯•\"><a class=\"anchor\" href=\"#fridaåè°ƒè¯•\">#</a> frida åè°ƒè¯•</h1>\n<p>å…ˆçœ‹çœ‹ä¼šå‘˜è´­é¡µé¢æ˜¯å“ªä¸€ä¸ª <code>activity</code>  çš„</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS D:<span class=\"token punctuation\">\\</span>work<span class=\"token punctuation\">\\</span>analysis<span class=\"token punctuation\">\\</span>bilibili<span class=\"token operator\">></span> adb shell <span class=\"token string\">\"dumpsys activity top | grep ACTIVITY\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  ACTIVITY com.google.android.apps.nexuslauncher/.NexusLauncherActivity ad36d3f <span class=\"token assign-left variable\">pid</span><span class=\"token operator\">=</span><span class=\"token number\">2139</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  ACTIVITY tv.danmaku.bili/.MainActivityV2 e753a0a <span class=\"token assign-left variable\">pid</span><span class=\"token operator\">=</span><span class=\"token number\">12505</span></pre></td></tr></table></figure><p>ç”¨ frida å†™ä¸ªç®€å•çš„ hook è„šæœ¬æ³¨å…¥è¿›å»çœ‹çœ‹æƒ…å†µ</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Java<span class=\"token punctuation\">.</span><span class=\"token function\">perform</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">const</span> activity <span class=\"token operator\">=</span> Java<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"com.mall.ui.page.base.MallWebFragmentLoaderActivity\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        activity<span class=\"token punctuation\">.</span>onCreate<span class=\"token punctuation\">.</span><span class=\"token function\">overload</span><span class=\"token punctuation\">(</span><span class=\"token string\">'android.os.Bundle'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function-variable function\">implementation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">const</span> retv <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCreate</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">return</span> retv<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span>hook<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>oriole:/data/local/tmp <span class=\"token comment\"># /data/local/tmp/fs16.3.3 -l 0.0.0.0:1234</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>adb forward tcp:1234 tcp:1234</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>frida <span class=\"token parameter variable\">-H</span> <span class=\"token number\">127.0</span>.0.1:1234 <span class=\"token parameter variable\">-l</span> .<span class=\"token punctuation\">\\</span>hook.js <span class=\"token parameter variable\">-f</span> tv.danmaku.bili</pre></td></tr></table></figure><p>æ³¨å…¥è¿›å»ä¹‹åä¸å‡ºæ„æ–™çš„å¡åœ¨ä¸»ç•Œé¢ä¸åŠ¨äº†</p>\n<p><img data-src=\"/bilibili-get-ticket/image-20240713222856973.png\" alt=\"image-20240713222856973\" style=\"aspect-ratio:408 / 908;\"></p>\n<p>å»çœ‹çœ‹æ˜¯åœ¨å“ªä¸€ä¸ª so å¡ä½çš„</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_dlopen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>Module<span class=\"token punctuation\">.</span><span class=\"token function\">findExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"android_dlopen_ext\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token keyword\">var</span> pathptr <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pathptr <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span> pathptr <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                    <span class=\"token keyword\">var</span> path <span class=\"token operator\">=</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>pathptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"load \"</span> <span class=\"token operator\">+</span> path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span>hook_dlopen<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>å“ˆå“ˆæ²¡æƒ³åˆ°æ˜¯ <code>libmsaoaidsec.so</code> , è¿™ä¸ª so æˆ‘åœ¨å¾ˆå¤šçš„ apk é‡Œé¢éƒ½çœ‹åˆ°è¿‡äº†ï¼ŒæŒ‰ç…§ä»¥å‰é€†å‘çš„ç»éªŒè¿™ä¸ª so é‡Œé¢æ²¡æœ‰ä»»ä½•çš„ä¸šåŠ¡ä»£ç ï¼Œåœ¨ <code>init_proc</code>  é‡Œé¢æ˜¯çº¯çš„æ£€æµ‹é€»è¾‘</p>\n<p><img data-src=\"/bilibili-get-ticket/image-20240713222907116.png\" alt=\"image-20240713222907116\" style=\"aspect-ratio:2860 / 631;\"></p>\n<p>æˆ‘å¯¹ <code>libmsaoaidsec.so</code>  é‡Œé¢çš„æ§åˆ¶æµå¹³å¦åŒ–è¿˜æ˜¯å¾ˆæ„Ÿå…´è¶£çš„ï¼Œä¹‹åä¼šå»ä¸“é—¨åˆ†æä¸€ä¸‹è¿™ä¸ª so:)</p>\n<p><img data-src=\"/bilibili-get-ticket/image-20240713222916985.png\" alt=\"image-20240713222916985\" style=\"aspect-ratio:1434 / 774;\"></p>\n<p>ç°åœ¨æˆ‘ä»¬å°±ç”¨æœ€ç®€å•çš„æ–¹æ³•å»åè°ƒè¯•å¥½å•¦ï¼Œå°±æ˜¯ä¸è®© app åŠ è½½è¿™ä¸ª so, å…·ä½“åšæ³•å°±æ˜¯åœ¨æ‰“å¼€è¿™ä¸ª so æ—¶ï¼ŒæŠŠè¦åŠ è½½çš„ so çš„å­—ç¬¦ä¸²ç½®ç©º</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_dlopen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>Module<span class=\"token punctuation\">.</span><span class=\"token function\">findExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"android_dlopen_ext\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token keyword\">var</span> pathptr <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pathptr <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span> pathptr <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token keyword\">var</span> path <span class=\"token operator\">=</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>pathptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'libmsaoaidsec.so'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>pathptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8String</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"load \"</span> <span class=\"token operator\">+</span> path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span>hook_dlopen_anti<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>å†æ¬¡æ³¨å…¥ä»£ç ä¹‹åå°± hook æˆåŠŸäº†</p>\n<p><img data-src=\"/bilibili-get-ticket/image-20240713222925964.png\" alt=\"image-20240713222925964\" style=\"aspect-ratio:1348 / 497;\"></p>\n<h1 id=\"webview-chromeè°ƒè¯•\"><a class=\"anchor\" href=\"#webview-chromeè°ƒè¯•\">#</a> webview chrome è°ƒè¯•</h1>\n<p>ç”¨ <code>Device Monitor</code>  çœ‹ä¸€ä¸‹è´­ç¥¨çš„é¡µé¢ï¼Œå‘ç°æ˜¯å¥—äº†ä¸€ä¸ª <code>WebView</code></p>\n<p><img data-src=\"/bilibili-get-ticket/image-20240713222934485.png\" alt=\"image-20240713222934485\" style=\"aspect-ratio:2524 / 1446;\"></p>\n<p>æƒ³è¦åœ¨ android ä¸­ä½¿ç”¨ chrome çš„ devtool å¼€å¯ webview debug, éœ€è¦æ³¨å…¥ä¸‹é¢çš„ frida è„šæœ¬</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">webview_debug</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Java<span class=\"token punctuation\">.</span><span class=\"token function\">perform</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">var</span> WebView <span class=\"token operator\">=</span> Java<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">'android.webkit.WebView'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        WebView<span class=\"token punctuation\">.</span>$init<span class=\"token punctuation\">.</span>overloads<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">init</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            init<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">implementation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token comment\">// è°ƒç”¨åŸå§‹æ„é€ æ–¹æ³•</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token keyword\">var</span> instance <span class=\"token operator\">=</span> <span class=\"token function\">init</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> arguments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token comment\">// æ‰“å¼€ WebView çš„è°ƒè¯•åŠŸèƒ½</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                WebView<span class=\"token punctuation\">.</span><span class=\"token function\">setWebContentsDebuggingEnabled</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'[*] WebView debug open~'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token comment\">// è¿”å›å®ä¾‹</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token keyword\">return</span> instance<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨ USB å°†ç”µè„‘å’Œæ‰‹æœºç›¸è¿</p>\n<p>åœ¨ç”µè„‘ç«¯çš„ chrome æ‰“å¼€ <code>chrome://inspect/#devices</code></p>\n<p>ä¹‹åæˆ‘ä»¬ç‚¹å‡»è¿™ä¸ª <code>Port forwarding</code>  æŒ‰é’®é…ç½®ç«¯å£è½¬å‘</p>\n<p><img data-src=\"/bilibili-get-ticket/image-20240713222956316.png\" alt=\"image-20240713222956316\" style=\"aspect-ratio:565 / 226;\"></p>\n<p>ç„¶å é€‰ä¸€ä¸ªç«¯å£ç‚¹å‡» <code>Done</code></p>\n<p><img data-src=\"/bilibili-get-ticket/image-20240713223022350.png\" alt=\"image-20240713223022350\" style=\"aspect-ratio:458 / 509;\"></p>\n<p>ä½†æ˜¯è¿™æ ·åšå¹¶æ²¡æœ‰ä»€ä¹ˆç½‘é¡µå¯ä»¥ <code>inspect</code></p>\n<p><img data-src=\"/bilibili-get-ticket/image-20240713223028761.png\" alt=\"image-20240713223028761\" style=\"aspect-ratio:697 / 509;\"></p>\n<p>é€šè¿‡ <code>device monitor</code>  æ¥çœ‹ï¼Œè¿™ä¸ª b ç«™è‚¯å®šæ˜¯è°ƒç”¨äº† <code>Webview</code>  çš„ï¼Œé‚£ä¸ºä»€ä¹ˆè¿™ä¸ªè„šæœ¬æ²¡æœ‰ hook åˆ° Webview çš„åˆ›å»ºå‘¢ï¼Ÿæˆ‘è§‰å¾—å¯èƒ½çš„åŸå› å°±æ˜¯ webview å¹¶ä¸æ˜¯åœ¨ä¸»è¿›ç¨‹è¢«åˆ›å»ºçš„ï¼Œè€Œæ˜¯åœ¨å­è¿›ç¨‹è¢«åˆ›å»ºçš„ï¼Œæˆ‘ä»¬æ‰“å°ä¸€ä¸‹ bilibili å»ºç«‹çš„è¿›ç¨‹æ¥çœ‹çœ‹æƒ…å†µ</p>\n<p><img data-src=\"/bilibili-get-ticket/image-20240713223040869.png\" alt=\"image-20240713223040869\" style=\"aspect-ratio:1683 / 191;\"></p>\n<p>çš„ç¡®ï¼Œé™¤äº†ä¸»è¿›ç¨‹ä¹‹å¤–ï¼Œè¿˜å¤šäº†å…¶ä»–çš„å››ä¸ªè¿›ç¨‹ï¼Œæ„Ÿè§‰è¿™ä¸ª <code>web</code>  è¿›ç¨‹å¾ˆå¯ç–‘å‘€</p>\n<p>é‚£å†™ä¸ª python è„šæœ¬è®© frida ä¹Ÿå»æ³¨å…¥è¿™ä¸ª <code>tv.danmaku.bili:web</code>  å­è¿›ç¨‹å¥½å•¦</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> codecs</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> frida</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> sys</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> threading</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>device <span class=\"token operator\">=</span> frida<span class=\"token punctuation\">.</span>get_device_manager<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>add_remote_device<span class=\"token punctuation\">(</span><span class=\"token string\">\"127.0.0.1:1234\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>pending <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>sessions <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>scripts <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>event <span class=\"token operator\">=</span> threading<span class=\"token punctuation\">.</span>Event<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>jscode <span class=\"token operator\">=</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./hook.js'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'r'</span><span class=\"token punctuation\">,</span> encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>pkg <span class=\"token operator\">=</span> <span class=\"token string\">\"tv.danmaku.bili\"</span>  <span class=\"token comment\">#åŒ…å</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">spawn_added</span><span class=\"token punctuation\">(</span>spawn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    event<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">if</span> spawn<span class=\"token punctuation\">.</span>identifier <span class=\"token operator\">==</span> pkg <span class=\"token keyword\">or</span> spawn<span class=\"token punctuation\">.</span>identifier <span class=\"token operator\">==</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>pkg<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">:web\"</span></span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'spawn_added:'</span><span class=\"token punctuation\">,</span> spawn<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        session <span class=\"token operator\">=</span> device<span class=\"token punctuation\">.</span>attach<span class=\"token punctuation\">(</span>spawn<span class=\"token punctuation\">.</span>pid<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        script <span class=\"token operator\">=</span> session<span class=\"token punctuation\">.</span>create_script<span class=\"token punctuation\">(</span>jscode<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        script<span class=\"token punctuation\">.</span>on<span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> on_message<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        script<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    device<span class=\"token punctuation\">.</span>resume<span class=\"token punctuation\">(</span>spawn<span class=\"token punctuation\">.</span>pid<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">spawn_removed</span><span class=\"token punctuation\">(</span>spawn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'spawn_removed:'</span><span class=\"token punctuation\">,</span> spawn<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    event<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">on_message</span><span class=\"token punctuation\">(</span>spawn<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'on_message:'</span><span class=\"token punctuation\">,</span> spawn<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">on_message</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">if</span> message<span class=\"token punctuation\">[</span><span class=\"token string\">'type'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">'send'</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[*] &#123;0&#125;\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">[</span><span class=\"token string\">'payload'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>device<span class=\"token punctuation\">.</span>on<span class=\"token punctuation\">(</span><span class=\"token string\">'spawn-added'</span><span class=\"token punctuation\">,</span> spawn_added<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>device<span class=\"token punctuation\">.</span>on<span class=\"token punctuation\">(</span><span class=\"token string\">'spawn-removed'</span><span class=\"token punctuation\">,</span> spawn_removed<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>device<span class=\"token punctuation\">.</span>enable_spawn_gating<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>event <span class=\"token operator\">=</span> threading<span class=\"token punctuation\">.</span>Event<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Enabled spawn gating'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>pid <span class=\"token operator\">=</span> device<span class=\"token punctuation\">.</span>spawn<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>pkg<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>session <span class=\"token operator\">=</span> device<span class=\"token punctuation\">.</span>attach<span class=\"token punctuation\">(</span>pid<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[*] Attach Application id:\"</span><span class=\"token punctuation\">,</span> pid<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>device<span class=\"token punctuation\">.</span>resume<span class=\"token punctuation\">(</span>pid<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>sys<span class=\"token punctuation\">.</span>stdin<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è¿™æ ·å°± hook åˆ°å­è¿›ç¨‹å•¦</p>\n<p><img data-src=\"/bilibili-get-ticket/image-20240713223048889.png\" alt=\"image-20240713223048889\" style=\"aspect-ratio:1856 / 2124;\"></p>\n<p>æ‰“å¼€äº† webview çš„ debug ä¹‹åï¼Œç»ˆäºå¯ä»¥ inspect äº†ï¼</p>\n<p><img data-src=\"/bilibili-get-ticket/image-20240713223059764.png\" alt=\"image-20240713223059764\" style=\"aspect-ratio:3840 / 2059;\"></p>\n<p>ä¹‹åçš„è¿‡ç¨‹å°±å¾ˆç®€å•å•¦</p>\n<ol>\n<li>ç‚¹å‡»æ¼«å±•è¯¦æƒ…ï¼ŒæŠ“ä¸ªåŒ…</li>\n<li>ç‚¹å‡»ç«‹å³è´­ç¥¨ï¼ŒæŠ“ä¸ªåŒ…</li>\n<li>ç‚¹å‡»æäº¤è®¢å•ï¼ŒæŠ“ä¸ªåŒ…</li>\n</ol>\n<p>æˆ‘å†™äº†ä¸€ä¸ªå°è„šæœ¬è¿˜æŒºå¥½ç”¨çš„ï¼Œç”¨è¿™ä¸ª js è„šæœ¬å¯ä»¥è¯»å–å‰ªåˆ‡æ¿é‡Œçš„ curl è¯·æ±‚å¹¶è½¬æ¢ä¸º python çš„ request è¯·æ±‚å¤åˆ¶åˆ°å‰ªåˆ‡æ¿ä¸Š <code>:)</code></p>\n<p>å‰ªåˆ‡æ¿é‡Œçš„ curl è¯·æ±‚æ˜¯ä»è¿™é‡Œæ¥çš„</p>\n<p><img data-src=\"/bilibili-get-ticket/image-20240713225910636.png\" alt=\"image-20240713225910636\" style=\"aspect-ratio:664 / 810;\"></p>\n<p>è®°å¾—å®‰è£…ä¸€ä¸‹åŒ…å°±å¥½äº†</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">npm</span> i curlconverter</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">npm</span> i copy-paste</pre></td></tr></table></figure><figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> curlconverter <span class=\"token keyword\">from</span> <span class=\"token string\">'curlconverter'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> ncp <span class=\"token keyword\">from</span> <span class=\"token string\">'copy-paste'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">let</span> cmd <span class=\"token operator\">=</span> ncp<span class=\"token punctuation\">.</span><span class=\"token function\">paste</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">var</span> res <span class=\"token operator\">=</span> curlconverter<span class=\"token punctuation\">.</span><span class=\"token function\">toPython</span><span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ncp<span class=\"token punctuation\">.</span><span class=\"token function\">copy</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OK\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>åˆ†æä¸€ä¸‹æ¥å£ï¼Œå†™ä¸€ä¸‹è„šæœ¬å°±æŠ¢ç¥¨æˆåŠŸå•¦</p>\n<p><img data-src=\"/bilibili-get-ticket/image-20240713225457049.png\" alt=\"image-20240713225457049\" style=\"aspect-ratio:3435 / 1934;\"></p>\n<p><code>waiting for cp30!</code></p>\n",
            "tags": []
        },
        {
            "id": "https://oacia.dev/ollvm-study/",
            "url": "https://oacia.dev/ollvm-study/",
            "title": "ollvmä¸‰ç§æ··æ·†æ¨¡å¼çš„åæ··æ·†æ€è·¯",
            "date_published": "2024-07-12T01:24:52.000Z",
            "content_html": "<blockquote>\n<p>ollvm ç®—æ˜¯æ—¥å¸¸é€†å‘çš„è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªéš¾ç‚¹ï¼Œè¯•æƒ³ä¸€ä¸‹å½“ä½ æŠŠç¨‹åºæ‹–è¿› ida åé‚£æ— ç©·æ— å°½çš„ block å‡ºç°åœ¨é¢å‰çš„æ„Ÿå—ï¼Œè¿™æ»‹å‘³ä¸€è¨€éš¾å°½å‘â€¦</p>\n<p>æ‰€ä»¥å¾ˆæœ‰å¿…è¦å¯¹ ollvm çš„æ··æ·†ä¸åæ··æ·†è¿›è¡Œç³»ç»Ÿçš„å­¦ä¹ ï¼Œä»¥ä¾¿åœ¨æœªæ¥å®é™…ç”Ÿæ´»ä¸­é‡åˆ°æ—¶ï¼Œä¸å¿…æ…Œå¿™çš„å» google å¯»æ‰¾ç­”æ¡ˆ.</p>\n</blockquote>\n<p>æ–‡ä¸­çš„åˆ†ææ‰€ç”¨åˆ°çš„é™„ä»¶å¯ä»¥ç‚¹è¿™é‡Œä¸‹è½½å“¦<span class=\"exturl\" data-url=\"aHR0cHM6Ly9vYWNpYS5naXRodWIuaW8vb2xsdm0tc3R1ZHkvb2xsdm1fYmNmLWZsYS1zdWIuemlw\"> ollvm_bcf-fla-sub.zip</span></p>\n<h1 id=\"é¢„å¤‡çŸ¥è¯†\"><a class=\"anchor\" href=\"#é¢„å¤‡çŸ¥è¯†\">#</a> é¢„å¤‡çŸ¥è¯†</h1>\n<p>llvm æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç¼–è¯‘å™¨æ¶æ„ï¼Œä½œç”¨å¯ä»¥ç†è§£ä¸ºåˆ¶ä½œä¸€ä¸ªç¼–è¯‘å™¨ï¼Œllvm å…ˆå°†æºç ç”Ÿæˆä¸ºä¸ç›®æ ‡æœºå™¨æ— å…³çš„ LLVM IR ä»£ç ï¼Œç„¶åæŠŠ LLVMIR ä»£ç å…ˆä¼˜åŒ–ï¼Œå†å‘ç›®æ ‡æœºå™¨çš„æ±‡ç¼–è¯­è¨€è€ŒåŠªåŠ›ã€‚ç»å…¸ç¼–è¯‘å™¨éƒ½å¯ä»¥åˆ†ä¸ºå‰ç«¯ã€ä¸­å±‚ä¼˜åŒ–å’Œåç«¯ï¼š</p>\n<p><img data-src=\"/ollvm-study/image-20230726095250772.png\" alt=\"image-20230726095250772\" style=\"aspect-ratio:976 / 525;\"></p>\n<p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ° clang æ˜¯å‰ç«¯çš„ä¸€ä¸ªå¥—ä»¶ï¼Œä½†åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬åªå¯ä»¥æ„Ÿå—åˆ° clangï¼Œä¹Ÿåªæ˜¯åœ¨ä½¿ç”¨ clangï¼Œå› ä¸ºç¼–è¯‘çš„æ—¶å€™ï¼Œæ˜¯è°ƒç”¨ clang æˆ– clang++ æ¥ç¼–è¯‘æºç ã€‚</p>\n<p>è€Œ ollvm æ˜¯åŸºäº LLVM çš„ä»£ç åˆ†æ”¯çš„ä»£ç æ··æ·†ï¼Œåœ¨ä¸­é—´è¡¨ç¤º IR å±‚ï¼Œé€šè¿‡ç¼–å†™ passï¼ˆéå†ä¸€é IRï¼Œå¯ä»¥åŒæ—¶å¯¹å®ƒåšä¸€äº›æ“ä½œï¼‰æ¥æ··æ·† IRï¼Œè¿™æ ·ç›®æ ‡æœºå™¨çš„æ±‡ç¼–è¯­è¨€ä¹Ÿå°±è¢«æ··æ·†äº†</p>\n<h1 id=\"ollvmç¯å¢ƒæ­å»º\"><a class=\"anchor\" href=\"#ollvmç¯å¢ƒæ­å»º\">#</a> ollvm ç¯å¢ƒæ­å»º</h1>\n<p>ollvm æ­å»ºçš„ç¯å¢ƒä¸º</p>\n<ul>\n<li>ubuntu22.04</li>\n</ul>\n<h2 id=\"ä¸‹è½½ollvm-40æºç \"><a class=\"anchor\" href=\"#ä¸‹è½½ollvm-40æºç \">#</a> ä¸‹è½½ ollvm 4.0 æºç </h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> clone <span class=\"token parameter variable\">-b</span> llvm-4.0 <span class=\"token parameter variable\">--depth</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> https://github.com/obfuscator-llvm/obfuscator.git</pre></td></tr></table></figure><h2 id=\"å®‰è£…docker\"><a class=\"anchor\" href=\"#å®‰è£…docker\">#</a> å®‰è£… docker</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> docker.io</pre></td></tr></table></figure><h2 id=\"å®‰è£…ç¼–è¯‘ollvmçš„dockerç¯å¢ƒ\"><a class=\"anchor\" href=\"#å®‰è£…ç¼–è¯‘ollvmçš„dockerç¯å¢ƒ\">#</a> å®‰è£…ç¼–è¯‘ ollvm çš„ docker ç¯å¢ƒ</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">docker</span> pull nickdiego/ollvm-build</pre></td></tr></table></figure><h2 id=\"ç¼–è¯‘ollvm\"><a class=\"anchor\" href=\"#ç¼–è¯‘ollvm\">#</a> ç¼–è¯‘ ollvm</h2>\n<h3 id=\"ä¸‹è½½ç¼–è¯‘è„šæœ¬\"><a class=\"anchor\" href=\"#ä¸‹è½½ç¼–è¯‘è„šæœ¬\">#</a> ä¸‹è½½ç¼–è¯‘è„šæœ¬</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> clone <span class=\"token parameter variable\">--depth</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> https://github.com/oacia/docker-ollvm.git</pre></td></tr></table></figure><h3 id=\"ç¼–è¯‘\"><a class=\"anchor\" href=\"#ç¼–è¯‘\">#</a> ç¼–è¯‘</h3>\n<p><code>ollvm-build.sh</code>  åé¢è·Ÿçš„å‚æ•°æ˜¯ <code>ollvmçš„æºç ç›®å½•</code></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> docker-ollvm/ollvm-build.sh /home/oacia/Desktop/obfuscator/</pre></td></tr></table></figure><h2 id=\"åˆ›å»ºç¡¬é“¾æ¥\"><a class=\"anchor\" href=\"#åˆ›å»ºç¡¬é“¾æ¥\">#</a> åˆ›å»ºç¡¬é“¾æ¥</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">ln</span> ./obfuscator/build_release/bin/* /usr/bin/</pre></td></tr></table></figure><p>åˆ›å»ºå®Œæˆç¡¬é“¾æ¥åï¼Œä½¿ç”¨è¯¥å‘½ä»¤æ¥æ£€æµ‹ <code>clang</code>  æ˜¯å¦å¯ç”¨</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>clang <span class=\"token parameter variable\">--version</span></pre></td></tr></table></figure><h2 id=\"ä½¿ç”¨æµ‹è¯•ä»£ç å°è¯•ç¼–è¯‘\"><a class=\"anchor\" href=\"#ä½¿ç”¨æµ‹è¯•ä»£ç å°è¯•ç¼–è¯‘\">#</a> ä½¿ç”¨æµ‹è¯•ä»£ç å°è¯•ç¼–è¯‘</h2>\n<p>ä½¿ç”¨ä¸€ä¸ªç®€å•çš„ RC4 åŠ å¯†æ¥ä½œä¸ºæµ‹è¯•ä»£ç ï¼Œ<strong> è¯¥ä»£ç å°†åœ¨åç»­ ollvm çš„ä¸‰ç§æ··æ·†ä¸­ç»§ç»­ä½¿ç”¨</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//test.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span><span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>RC4 åˆå§‹åŒ–å‡½æ•°</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>*/</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">rc4_init</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> s<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> key<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> Len_k<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">char</span> k<span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> tmp <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">256</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\ts<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tk<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> key<span class=\"token punctuation\">[</span>i <span class=\"token operator\">%</span> Len_k<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">256</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tj <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">+</span> s<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> k<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\ttmp <span class=\"token operator\">=</span> s<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\ts<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> s<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\ts<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> tmp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>RC4 åŠ è§£å¯†å‡½æ•°</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>unsigned char* Data     åŠ è§£å¯†çš„æ•°æ®</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>unsigned long Len_D     åŠ è§£å¯†æ•°æ®çš„é•¿åº¦</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>unsigned char* key      å¯†é’¥</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>unsigned long Len_k     å¯†é’¥é•¿åº¦</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>*/</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">RC4</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> Data<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> Len_D<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> key<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> Len_k<span class=\"token punctuation\">)</span> <span class=\"token comment\">// åŠ è§£å¯†</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> s<span class=\"token punctuation\">[</span><span class=\"token number\">256</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token function\">rc4_init</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> Len_k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> t <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> k <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> tmp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>k <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> k <span class=\"token operator\">&lt;</span> Len_D<span class=\"token punctuation\">;</span> k<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\ti <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\tj <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">+</span> s<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\ttmp <span class=\"token operator\">=</span> s<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\ts<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> s<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\ts<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> tmp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\tt <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> s<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\tData<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> Data<span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span> <span class=\"token operator\">^</span> s<span class=\"token punctuation\">[</span>t<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">RC4encrypt</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> Data<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> Len_D<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> key<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> Len_k<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token function\">RC4</span><span class=\"token punctuation\">(</span>Data<span class=\"token punctuation\">,</span> Len_D<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> Len_k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">RC4decrypt</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> Data<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> Len_D<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> key<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> Len_k<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token function\">RC4</span><span class=\"token punctuation\">(</span>Data<span class=\"token punctuation\">,</span> Len_D<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> Len_k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token comment\">// å­—ç¬¦ä¸²å¯†é’¥</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> key<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"secret\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> key_len <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// å­—ç¬¦ä¸²æœ€åè¿˜æœ‰ä¸€ä¸ª '/0' æ‰€ä»¥éœ€è¦ - 1</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token comment\">// æ•°ç»„å¯†é’¥</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token comment\">//unsigned char key[] = &#123;'s','e','c','r','e','t'&#125;;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token comment\">//unsigned long key_len = sizeof(key);</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> data<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token number\">116</span><span class=\"token punctuation\">,</span> <span class=\"token number\">104</span><span class=\"token punctuation\">,</span> <span class=\"token number\">105</span><span class=\"token punctuation\">,</span> <span class=\"token number\">115</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span> <span class=\"token number\">105</span><span class=\"token punctuation\">,</span> <span class=\"token number\">115</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">,</span> <span class=\"token number\">82</span><span class=\"token punctuation\">,</span> <span class=\"token number\">67</span><span class=\"token punctuation\">,</span> <span class=\"token number\">52</span><span class=\"token punctuation\">,</span> <span class=\"token number\">44</span><span class=\"token punctuation\">,</span> <span class=\"token number\">111</span><span class=\"token punctuation\">,</span> <span class=\"token number\">97</span><span class=\"token punctuation\">,</span> <span class=\"token number\">99</span><span class=\"token punctuation\">,</span> <span class=\"token number\">105</span><span class=\"token punctuation\">,</span> <span class=\"token number\">97</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token comment\">// å¯¹æ˜æ–‡è¿›è¡ŒåŠ å¯†</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token function\">RC4encrypt</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> key_len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d, \"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t<span class=\"token comment\">// å¯¹å¯†æ–‡è¿›è¡Œè§£å¯†</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t<span class=\"token function\">RC4encrypt</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> key_len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%c\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t<span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>153, 94, 187, 111, 162, 205, 165, 134, 96, 136, 143, 240, 156, 135, 150, 94, 204,</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>this is RC4,oacia</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>*/</pre></td></tr></table></figure><p>è¿è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘</p>\n<pre><code>clang test.c -o test\n</code></pre>\n<ul>\n<li><strong>å¦‚æœæç¤º fatal error: â€˜stdio.hâ€™ file not found</strong></li>\n</ul>\n<p>â€‹\tå°è¯•ä¸‹è½½ g++ å’Œ gcc</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> g++</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> gcc</pre></td></tr></table></figure><ul>\n<li><strong>å¦‚æœæç¤º fatal error: 'stddef.hâ€™æˆ–è€…â€™stdarg.hâ€™ç­‰ file not found</strong></li>\n</ul>\n<p>ä½¿ç”¨è¯¥å‘½ä»¤å¤åˆ¶ clang æ‰€éœ€çš„å¤´æ–‡ä»¶åˆ° <code>/usr/include/</code> ,  <code>cp -r -i</code>  åé¢è·Ÿçš„å‚æ•°ä¸º <code>ollvmçš„æºç ç›®å½•/build_release/lib/clang/4.0.1/include/.</code> , è¿™ä¸ªæ–‡ä»¶å¤¹å†…åŒ…å«äº† <code>clang</code>  ç¼–è¯‘å™¨æ‰€éœ€çš„å¤´æ–‡ä»¶</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cp</span> <span class=\"token parameter variable\">-r</span> <span class=\"token parameter variable\">-i</span> /home/oacia/Desktop/obfuscator/build_release/lib/clang/4.0.1/include/. /usr/include/</pre></td></tr></table></figure><p>å¦‚æœæç¤ºæœ‰é‡åæ–‡ä»¶çš„è¯ï¼Œæœ€å¥½å…ˆå¯¹ <code>/usr/include</code>  å†…çš„é‡åæ–‡ä»¶ä½œå¥½å¤‡ä»½ï¼Œç„¶åå»æ‰ <code>-i</code>  å‚æ•°é‡æ–°è¿›è¡Œå¤åˆ¶å¤´æ–‡ä»¶æ“ä½œ</p>\n<h1 id=\"è™šå‡æ§åˆ¶æµbcfbogus-control-flow\"><a class=\"anchor\" href=\"#è™šå‡æ§åˆ¶æµbcfbogus-control-flow\">#</a> è™šå‡æ§åˆ¶æµ BCF (Bogus Control Flow)</h1>\n<h2 id=\"åŸç†\"><a class=\"anchor\" href=\"#åŸç†\">#</a> åŸç†</h2>\n<p>è™šå‡æ§åˆ¶æµæ··æ·†é€šè¿‡åŠ å…¥åŒ…å«<strong>ä¸é€æ˜è°“è¯</strong>çš„æ¡ä»¶è·³è½¬ï¼ˆä¹Ÿå°±æ˜¯è·³è½¬ä¸å¦åœ¨è¿è¡Œä¹‹å‰å°±å·²ç»ç¡®å®šçš„è·³è½¬ï¼Œä½† IDA æ— æ³•åˆ†æï¼‰å’Œ<strong>ä¸å¯è¾¾çš„åŸºæœ¬å—</strong>ï¼Œæ¥å¹²æ‰° IDA çš„æ§åˆ¶æµåˆ†æå’Œ F5 åæ±‡ç¼–ã€‚</p>\n<p>æ‰€è°“çš„ä¸é€æ˜è°“è¯ï¼Œä¾‹å¦‚</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>x<span class=\"token operator\">></span><span class=\"token number\">10</span> <span class=\"token operator\">&amp;&amp;</span> x<span class=\"token operator\">&lt;=</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">goto</span> Label1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å¯¹äºè¿™ç±»è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ï¼Œ <code>x&gt;10 &amp;&amp; x&lt;=10</code>  æ˜¯æ°¸å‡å¼ï¼Œæ‰€ä»¥ <code>goto Label1</code>  è¿™ä¸ªè·³è½¬æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯å¯¹äº IDA æ¥è¯´å¯ä¸æ˜¯è¿™ä¸ªæ ·å­ï¼Œåœ¨é™æ€åˆ†æçš„æ—¶å€™ï¼ŒIDA å¹¶ä¸çŸ¥é“ <code>x</code>  çš„å€¼æ˜¯å¤šå°‘ï¼Œæ‰€ä»¥è¯´è¿™ç±»è™šå‡æ§åˆ¶æµå°±ä¼šå¹²æ‰°æˆ‘ä»¬çš„é™æ€åˆ†æ.</p>\n<h2 id=\"ollvmçš„bcfæ··æ·†\"><a class=\"anchor\" href=\"#ollvmçš„bcfæ··æ·†\">#</a> ollvm çš„ BCF æ··æ·†</h2>\n<p>ä½¿ç”¨ä¸‹åˆ—å‘½ä»¤å¯¹ä»£ç è¿›è¡Œ BCF æ··æ·†</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>clang <span class=\"token parameter variable\">-mllvm</span> <span class=\"token parameter variable\">-bcf</span> <span class=\"token parameter variable\">-mllvm</span> <span class=\"token parameter variable\">-bcf_loop</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token parameter variable\">-mllvm</span> <span class=\"token parameter variable\">-bcf_prob</span><span class=\"token operator\">=</span><span class=\"token number\">40</span> test.c <span class=\"token parameter variable\">-o</span> test-bcf</pre></td></tr></table></figure><p>å¯ç”¨é€‰é¡¹ï¼š</p>\n<ul>\n<li><code>-mllvm -bcf </code> : æ¿€æ´»è™šå‡æ§åˆ¶æµ</li>\n<li><code>-mllvm -bcf_loop=3</code>  : æ··æ·†æ¬¡æ•°ï¼Œè¿™é‡Œä¸€ä¸ªå‡½æ•°ä¼šè¢«æ··æ·† 3 æ¬¡ï¼Œé»˜è®¤ä¸º 1</li>\n<li><code>-mllvm -bcf_prob=40</code>  : æ¯ä¸ªåŸºæœ¬å—è¢«æ··æ·†çš„æ¦‚ç‡ï¼Œè¿™é‡Œæ¯ä¸ªåŸºæœ¬å—è¢«æ··æ·†çš„æ¦‚ç‡ä¸º 40%ï¼Œé»˜è®¤ä¸º 30 %</li>\n</ul>\n<hr>\n<p>å¯ä»¥å‘ç°åœ¨ BCF æ··æ·†ä¹‹åï¼Œå‡½æ•°çš„æ§åˆ¶æµæ˜æ˜¾å¤æ‚äº†è®¸å¤š</p>\n<p><img data-src=\"/ollvm-study/image-20230727162443249.png\" alt=\"image-20230727162443249\" style=\"aspect-ratio:1488 / 812;\"></p>\n<p>æ‰“å¼€ BCF æ··æ·†ä¹‹å IDA çš„ä¼ªä»£ç ï¼Œå‘ç°å¤šäº†è®¸å¤šçš„ <code>while</code> , <code>if</code>  è¡¨è¾¾å¼ï¼Œä¼ªä»£ç å˜å¾—ååˆ†å¤æ‚ï¼Œä¹Ÿè®©æˆ‘ä»¬æ— æ³•ä¸€çœ¼å°±å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä½•ç§åŠ å¯†</p>\n<p><img data-src=\"/ollvm-study/image-20230727162652645.png\" alt=\"image-20230727162652645\" style=\"aspect-ratio:1286 / 684;\"></p>\n<h2 id=\"ollvmçš„bcfåæ··æ·†\"><a class=\"anchor\" href=\"#ollvmçš„bcfåæ··æ·†\">#</a> ollvm çš„ BCF åæ··æ·†</h2>\n<p>é“ºå«äº†è¿™ä¹ˆé•¿çš„æ—¶é—´ï¼Œç»ˆäºè¦æ¥åˆ°æœ¬ç¯‡æ–‡ç« çš„ç¬¬ä¸€ä¸ªæœ‰è¶£çš„ç¯èŠ‚ï¼ŒBCF çš„åæ··æ·†äº†</p>\n<p>æˆ‘ä»¬å¾€ä¸Šçœ‹ <code>while</code>  å†…çš„è¡¨è¾¾å¼ <code>y_4 &gt;= 10 &amp;&amp; (((x_3 - 1) * x_3) &amp; 1) != 0</code> , åœ¨è¿™ä¸ªå¼å­ä¸­ï¼Œ <code>(x_3 - 1) * x_3)</code>  çš„å€¼æ°¸è¿œä¸ºå¶æ•°ï¼Œæ‰€ä»¥ <code>(x_3 - 1) * x_3) &amp; 1</code>  æ°¸è¿œè¿”å› <code>0</code> , ä¸ç­‰å·å·¦è¾¹ <code>y_4 &gt;= 10 &amp;&amp; (((x_3 - 1) * x_3) &amp; 1)</code> , å› ä¸ºæ˜¯ç”¨é€»è¾‘ä¸ <code>&amp;&amp;</code>  ä½œä¸ºè¿æ¥è¯ï¼Œæ‰€ä»¥å·¦ä¾§çš„è¡¨è¾¾å¼å…¶å®ä¸ºæ°¸å‡å¼ï¼Œ <code>y_4 &gt;= 10 &amp;&amp; (((x_3 - 1) * x_3) &amp; 1) != 0</code>  æ°¸è¿œä¸æˆç«‹</p>\n<p>å¯¹äº BCF, æœ‰ 3 ç§æ€è·¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬å»è¿›è¡Œåæ··æ·†</p>\n<h3 id=\"æ€è·¯ä¸€-å°†å…¨å±€å˜é‡èµ‹å€¼å¹¶å°†segmentè®¾ä¸ºåªè¯»\"><a class=\"anchor\" href=\"#æ€è·¯ä¸€-å°†å…¨å±€å˜é‡èµ‹å€¼å¹¶å°†segmentè®¾ä¸ºåªè¯»\">#</a> æ€è·¯ä¸€ å°†å…¨å±€å˜é‡èµ‹å€¼å¹¶å°† segment è®¾ä¸ºåªè¯»</h3>\n<p>IDA å…¶å®æ˜¯æœ‰æ­»ä»£ç æ¶ˆé™¤ (DCE, Dead Code Elimination) çš„ï¼Œä½†æ˜¯ç”±äº <code>y_4</code> , <code>x_3</code>  è¢«å®šä¹‰ä¸ºäº†å…¨å±€å˜é‡ï¼Œåœ¨é™æ€åˆ†ææ—¶ï¼ŒIDA ä¸çŸ¥é“è¿™ä¸ªè¡¨è¾¾å¼çš„å€¼æ˜¯å¤šå°‘ï¼Œæ‰€ä»¥ IDA ä¹Ÿä¸æ•¢è½»æ˜“çš„å°±æŠŠè¿™æ®µä»£ç ç»™æ¶ˆé™¤äº† (ä¸‡ä¸€æŠŠé‡è¦çš„ä»£ç ä¹Ÿç»™æ¶ˆé™¤æ‰äº†é‚£é€†å‘äººå‘˜çœŸçš„è¦ *** äº†)</p>\n<p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬æŠŠè¿™ä¸ªå˜é‡çš„å€¼å®šä¸‹æ¥ï¼Œå¹¶ä¸”å°†å˜é‡æ‰€åœ¨çš„ <code>segment</code>  è®¾ä¸º <code>åªè¯»</code> ï¼Œé‚£è¿™ä¸ªå˜é‡å€¼åœ¨æ²¡è¿è¡Œå‰ä¹Ÿå˜ä¸äº†ï¼ŒIDA ä¸å°±å¯ä»¥è‡ªå·±ç®—å‡ºæ¥è¿™ä¸ªè¡¨è¾¾å¼çš„å€¼æ˜¯å¤šå°‘äº†å˜›ï¼Œè¿™æ ·é‚£äº›æ²¡æœ‰ç”¨çš„è·³è½¬ IDA å°±å¯ä»¥è‡ªåŠ¨ä¼˜åŒ–äº†</p>\n<p>æ‰€ä»¥æˆ‘ä»¬å…ˆåŒå‡» <code>x_3</code>  è·³è½¬åˆ° <code>x_3</code>  çš„åœ°å€</p>\n<p><img data-src=\"/ollvm-study/image-20230727185741834.png\" alt=\"image-20230727185741834\" style=\"aspect-ratio:849 / 81;\"></p>\n<p>ç„¶åæŒ‰ä¸‹<span class=\"kbd\"> Alt</span>+<span class=\"kbd\">S</span> æˆ–è€… <code>Edit-&gt;Segments-&gt;Edit segment...</code>  æ¥æ”¹å˜ä¸é€æ˜è°“è¯æ‰€åœ¨çš„ segment çš„è¯»å†™å±æ€§ï¼Œå¦‚å›¾å°† <code>Write</code>  å¤é€‰æ¡†å–æ¶ˆå‹¾é€‰ï¼Œ <code>.bssæ®µ</code> å°±è®¾ä¸ºåªè¯»äº†</p>\n<p><img data-src=\"/ollvm-study/image-20230727203726728.png\" alt=\"image-20230727203726728\" style=\"aspect-ratio:742 / 427;\"></p>\n<p>å…‰æ˜¯è¿™æ ·è¿˜ä¸å¤Ÿï¼Œå› ä¸º <code>.bssæ®µ</code> ä¸­çš„å˜é‡è¿˜æ²¡æœ‰è¢«èµ‹è¿‡å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ patch è¿™ä¸ªæ®µæ¥å›ºå®š <code>.bssæ®µ</code> å†…å˜é‡çš„å€¼</p>\n<p>ä¸€ä¸ªå˜é‡ä¸€ä¸ªå˜é‡å» patch æ˜¾ç„¶æ˜¾å¾—æœ‰äº›éº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ç¼–å†™ IDApython è„šæœ¬æ¥å®ç°ä¸€æ­¥åˆ°ä½çš„æ•ˆæœï¼Œå¹¶ä¸”å¯¹äºå¸¸è§„çš„ ollvm çš„ bcf æ··æ·†æ¥è¯´ï¼Œbcf çš„ä¸é€æ˜è°“è¯éƒ½æ˜¯å¤„äº <code>.bssæ®µ</code> ä¸­ã€‚å¦‚æœä¸é€æ˜è°“è¯å®šä¹‰åœ¨å…¶ä»–æ®µä¸­ï¼Œå°† IDApython ä¸­çš„ä»£ç åšå‡ºç›¸å¯¹åº”çš„ä¿®æ”¹å³å¯</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> ida_segment</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> ida_bytes</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>seg <span class=\"token operator\">=</span> ida_segment<span class=\"token punctuation\">.</span>get_segm_by_name<span class=\"token punctuation\">(</span><span class=\"token string\">'.bss'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">for</span> ea <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>seg<span class=\"token punctuation\">.</span>start_ea<span class=\"token punctuation\">,</span> seg<span class=\"token punctuation\">.</span>end_ea<span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    ida_bytes<span class=\"token punctuation\">.</span>patch_bytes<span class=\"token punctuation\">(</span>ea<span class=\"token punctuation\">,</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to_bytes<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token string\">'little'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token triple-quoted-string string\">'''</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>seg.perm: ç”±ä¸‰ä½äºŒè¿›åˆ¶æ•°è¡¨ç¤º,ä¾‹å¦‚ä¸€ä¸ªsegmentä¸ºå¯è¯»,ä¸å¯å†™,ä¸å¯æ‰§è¡Œ,åˆ™seg.perm = 0b100</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>(seg.perm >> 2)&amp;1: Read</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>(seg.perm >> 1)&amp;1: Write</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>(seg.perm >> 0)&amp;1: Execute</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>'''</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>seg<span class=\"token punctuation\">.</span>perm <span class=\"token operator\">=</span> <span class=\"token number\">0b100</span></pre></td></tr></table></figure><h3 id=\"æ€è·¯äºŒ-ä½¿ç”¨d810å»é™¤bcf\"><a class=\"anchor\" href=\"#æ€è·¯äºŒ-ä½¿ç”¨d810å»é™¤bcf\">#</a> æ€è·¯äºŒ ä½¿ç”¨ d810 å»é™¤ BCF</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRsYWIuY29tL2VzaGFyZC9kODEw\">d810</span> ä¸­å†…ç½®äº†å¾ˆå¤šçš„ä¸é€æ˜è°“è¯è¡¨è¾¾å¼ï¼Œå®ƒçš„åŒ¹é…å™¨ä¹Ÿæ˜¯éå¸¸çš„å‰å®³å®Œå…¨å¯ä»¥åšåˆ°å»é™¤è™šå‡æ§åˆ¶æµ</p>\n<p>åœ¨ <code>Edit-&gt;plugins-&gt;D-810</code>  æ‰“å¼€ä¹‹åï¼Œé€‰æ‹© <code>default_unflattening_switch_case.json</code>  ä¹‹åç‚¹å‡» <code>start</code> , å³å¯åšåˆ°å¯¹ä¸é€æ˜è°“è¯çš„å»é™¤å¹¶è¿˜åŸæ§åˆ¶æµ</p>\n<p><img data-src=\"/ollvm-study/image-20240711153007836.png\" alt=\"image-20240711153007836\" style=\"aspect-ratio:1523 / 701;\"></p>\n<p>è¿˜åŸåçš„æ•ˆæœå¦‚ä¸‹ï¼Œå¯ä»¥å‘ç°å’ŒåŸæœ¬çš„ä»£ç åŸºæœ¬æ˜¯ä¸€æ ·çš„äº†</p>\n<p><img data-src=\"/ollvm-study/image-20240711153057510.png\" alt=\"image-20240711153057510\" style=\"aspect-ratio:1034 / 646;\"></p>\n<p>å½“ç„¶å¦‚æœå‘ç°æœ‰ä¸€äº›æ’å®šå€¼çš„ä¸é€æ˜è°“è¯è¡¨è¾¾å¼ d810 æ²¡æœ‰è¯†åˆ«åˆ°æ— æ³•å»é™¤çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ·»åŠ è§„åˆ™è®© D810 è¿›è¡ŒåŒ¹é…æ¥æ¶ˆé™¤ BCF</p>\n<p>ä¾‹å¦‚å¯¹äºè¿™ä¸ªè¡¨è¾¾å¼ <code>((x_0&gt;=10 &amp;&amp; x_10&lt;10)==false) == True</code> , æˆ‘ä»¬å¯ä»¥å…ˆåœ¨ <code>\\plugins\\d810\\conf\\xxx.json</code>  é‡Œé¢æ·»åŠ æˆ‘ä»¬è‡ªå·±çš„è§„åˆ™</p>\n<p><img data-src=\"/ollvm-study/image-20240712102230251.png\" alt=\"image-20240712102230251\" style=\"aspect-ratio:658 / 547;\"></p>\n<p>éšåæ¥åˆ° <code>plugins\\d810\\optimizers\\instructions\\pattern_matching\\rewrite_and.py</code>  ä¸­åŠ ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±çš„ç±» <code>OaciaRule0</code> , è¿™æ ·å°±å¯ä»¥å®Œæˆä¸€ä¸ªè‡ªå®šä¹‰è§„åˆ™çš„å¯¼å…¥å•¦</p>\n<p><img data-src=\"/ollvm-study/image-20240712102331669.png\" alt=\"image-20240712102331669\" style=\"aspect-ratio:1220 / 499;\"></p>\n<h3 id=\"æ€è·¯ä¸‰-ä½¿ç”¨idapython-patchä¸é€æ˜è°“è¯\"><a class=\"anchor\" href=\"#æ€è·¯ä¸‰-ä½¿ç”¨idapython-patchä¸é€æ˜è°“è¯\">#</a> æ€è·¯ä¸‰ ä½¿ç”¨ idapython patch ä¸é€æ˜è°“è¯</h3>\n<p>åœ¨æ€è·¯ä¸€ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å¯¹ä¸é€æ˜è°“è¯å˜é‡è¿›è¡Œäº¤å‰å¼•ç”¨æ‰¾åˆ°äº†å®ƒä»¬æ‰€åœ¨çš„ segment, å¹¶é€šè¿‡å°†å…¨å±€å˜é‡èµ‹å€¼å¹¶å°† segment è®¾ä¸ºåªè¯»çš„æ–¹æ³•æ¶ˆé™¤äº† BCF, ä½†æ˜¯å…¶å®æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å¦å¤–çš„ä¸€ç§æ–¹å¼å»æ¶ˆé™¤ bcf, å°±æ˜¯åœ¨æ±‡ç¼–ä¸­å°†ä¸é€æ˜è°“è¯ç›´æ¥ patch æ‰</p>\n<p>ä¾‹å¦‚å¯¹äºè¯¥ä¸é€æ˜è°“è¯ <code>x_9</code> , <code>y_10</code> , å®ƒçš„ c è¡¨è¾¾å¼ä¸º <code>y_10 &gt;= 10 &amp;&amp; ((((_BYTE)x_9 - 1) * (_BYTE)x_9) &amp; 1) != 0</code></p>\n<p><img data-src=\"/ollvm-study/image-20240712103021119.png\" alt=\"image-20240712103021119\" style=\"aspect-ratio:945 / 482;\"></p>\n<p>æˆ‘ä»¬è¦åšçš„å°±æ˜¯è®© <code>mov     eax, ds:x_9</code>  æ”¹æˆ <code>mov     eax, 0</code> , è¿™æ ·å°±å¯ä»¥åšåˆ°æ¶ˆé™¤ BCF çš„ç›®çš„</p>\n<p><img data-src=\"/ollvm-study/image-20240712103224264.png\" alt=\"image-20240712103224264\" style=\"aspect-ratio:866 / 454;\"></p>\n<p>ä½†æ˜¯è¿™æ ·ä¸€ä¸ªä¸€ä¸ªæ”¹è¿‡å»æ˜¾å¾—ååˆ†çš„éº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ ida python, é€šè¿‡æ‰¾åˆ°ä¸é€æ˜è°“è¯çš„æ‰€æœ‰äº¤å‰å¼•ç”¨çš„æ–¹å¼æ¥æ‰¹é‡ä¿®æ”¹</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># å»é™¤è™šå‡æ§åˆ¶æµ idapython è„šæœ¬</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> ida_xref</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> ida_idaapi</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> ida_bytes <span class=\"token keyword\">import</span> get_bytes<span class=\"token punctuation\">,</span> patch_bytes</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># å°† mov å¯„å­˜å™¨ï¼Œä¸é€æ˜è°“è¯ ä¿®æ”¹ä¸º mov å¯„å­˜å™¨ï¼Œ0</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">do_patch</span><span class=\"token punctuation\">(</span>ea<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> get_bytes<span class=\"token punctuation\">(</span>ea<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">b\"\\x8B\"</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># mov eax-edi, dword</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        reg <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">ord</span><span class=\"token punctuation\">(</span>get_bytes<span class=\"token punctuation\">(</span>ea <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0b00111000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        patch_bytes<span class=\"token punctuation\">(</span>ea<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0xB8</span> <span class=\"token operator\">+</span> reg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to_bytes<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">'little'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">b'\\x00\\x00\\x00\\x00\\x90\\x90'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># ä¸é€æ˜è°“è¯åœ¨.bss æ®µçš„èŒƒå›´</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>seg <span class=\"token operator\">=</span> ida_segment<span class=\"token punctuation\">.</span>get_segm_by_name<span class=\"token punctuation\">(</span><span class=\"token string\">'.bss'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>start <span class=\"token operator\">=</span> seg<span class=\"token punctuation\">.</span>start_ea</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>end <span class=\"token operator\">=</span> seg<span class=\"token punctuation\">.</span>end_ea</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">for</span> addr <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span>end<span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    ref <span class=\"token operator\">=</span> ida_xref<span class=\"token punctuation\">.</span>get_first_dref_to<span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>center<span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span><span class=\"token string\">'-'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\"># è·å–æ‰€æœ‰äº¤å‰å¼•ç”¨</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>ref <span class=\"token operator\">!=</span> ida_idaapi<span class=\"token punctuation\">.</span>BADADDR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        do_patch<span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'patch at '</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>ref<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        ref <span class=\"token operator\">=</span> ida_xref<span class=\"token punctuation\">.</span>get_next_dref_to<span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">,</span> ref<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'-'</span> <span class=\"token operator\">*</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è¿™æ · BCF å°±è¢«å»æ‰å•¦</p>\n<p><img data-src=\"/ollvm-study/image-20240712104339001.png\" alt=\"image-20240712104339001\" style=\"aspect-ratio:1102 / 607;\"></p>\n<h1 id=\"æŒ‡ä»¤æ›¿æ¢sub\"><a class=\"anchor\" href=\"#æŒ‡ä»¤æ›¿æ¢sub\">#</a> æŒ‡ä»¤æ›¿æ¢ï¼ˆSUBï¼‰</h1>\n<h2 id=\"åŸç†-2\"><a class=\"anchor\" href=\"#åŸç†-2\">#</a> åŸç†</h2>\n<p>æŒ‡ä»¤æ›¿æ¢ï¼ˆInstruction Substitutionï¼‰æ˜¯ä¸€ç§ä»£ç æ··æ·†æŠ€æœ¯ï¼Œç”¨äºå°†ç¨‹åºä¸­çš„åŸå§‹æŒ‡ä»¤æ›¿æ¢ä¸ºç­‰æ•ˆä½†æ›´éš¾ç†è§£å’Œè¿˜åŸçš„æŒ‡ä»¤åºåˆ—ã€‚é€šè¿‡æŒ‡ä»¤æ›¿æ¢ï¼Œå¯ä»¥å¢åŠ ç¨‹åºçš„å¤æ‚æ€§å’ŒæŠµæŠ—é€†å‘å·¥ç¨‹çš„èƒ½åŠ›ã€‚</p>\n<p>å®ƒçš„æœ¬è´¨å…¶å®å°±æ˜¯æ•°å­¦å…¬å¼çš„ç®€åŒ–ï¼Œä¾‹å¦‚ <code>(x + y) - 2 * (x &amp; y) -&gt; x ^ y</code>  (è¿‡å»å­¦ç¦»æ•£æ•°å­¦æ„Ÿè§‰åšçš„å°±æ˜¯è¿™ç§æ ·å­çš„â€¦)</p>\n<h2 id=\"ollvmçš„subæ··æ·†\"><a class=\"anchor\" href=\"#ollvmçš„subæ··æ·†\">#</a> ollvm çš„ SUB æ··æ·†</h2>\n<p>ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯¹ä»£ç è¿›è¡Œ SUB æ··æ·†</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>clang <span class=\"token parameter variable\">-mllvm</span> <span class=\"token parameter variable\">-sub</span> <span class=\"token parameter variable\">-mllvm</span> <span class=\"token parameter variable\">-sub_loop</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> test-sub.c <span class=\"token parameter variable\">-o</span> test-sub</pre></td></tr></table></figure><p>å¯ç”¨é€‰é¡¹</p>\n<ul>\n<li><code>-mllvm -sub</code>  : æ¿€æ´»æŒ‡ä»¤æ›¿æ¢</li>\n<li><code>-mllvm -sub_loop=3</code> : æ··æ·†æ¬¡æ•°ï¼Œè¿™é‡Œä¸€ä¸ªå‡½æ•°ä¼šè¢«æ··æ·† 3 æ¬¡ï¼Œé»˜è®¤ä¸º 1 æ¬¡</li>\n</ul>\n<p>ç»è¿‡æŒ‡ä»¤æ›¿æ¢åï¼Œä»£ç æ˜æ˜¾å˜é•¿äº†å¾ˆå¤š</p>\n<p><img data-src=\"/ollvm-study/image-20240712105930858.png\" alt=\"image-20240712105930858\" style=\"aspect-ratio:1523 / 668;\"></p>\n<h2 id=\"ollvmçš„subåæ··æ·†\"><a class=\"anchor\" href=\"#ollvmçš„subåæ··æ·†\">#</a> ollvm çš„ SUB åæ··æ·†</h2>\n<h3 id=\"æ€è·¯ä¸€-ä½¿ç”¨d810å»é™¤sub\"><a class=\"anchor\" href=\"#æ€è·¯ä¸€-ä½¿ç”¨d810å»é™¤sub\">#</a> æ€è·¯ä¸€ ä½¿ç”¨ d810 å»é™¤ SUB</h3>\n<p>D810 å¤ªçŒ›äº†ï¼è¿™é‡Œåˆç”¨åˆ°äº† D810</p>\n<p>è¿˜æ˜¯å’Œå»é™¤ BCF åæ··æ·†ä¸€æ ·ï¼Œæˆ‘ä»¬ç›´æ¥è·‘ä¸€ä¸‹ d810, è™½ç„¶è¿˜æ˜¯æœ‰ä¸€äº›éƒ¨åˆ†æ²¡æœ‰å»æ‰ï¼Œä½†æ˜¯çœ‹èµ·æ¥å·²ç»å¾ˆæ¸…æ™°äº†ï¼Œå› ä¸ºæŒ‡ä»¤æ›¿æ¢ä¸å½±å“ç¨‹åºæ•´ä½“çš„æ‰§è¡Œé€»è¾‘ï¼Œæ‰€ä»¥æˆ‘æƒ³å‰©ä¸‹çš„ä¸€ç‚¹ç‚¹ SUB åº”è¯¥éš¾ä¸å€’é€†å‘çš„åŒå­¦å§ï½</p>\n<p><img data-src=\"/ollvm-study/image-20240712110422977.png\" alt=\"image-20240712110422977\" style=\"aspect-ratio:1510 / 659;\"></p>\n<h3 id=\"æ€è·¯äºŒ-ä½¿ç”¨gambaç®€åŒ–å¤æ‚çš„subè¡¨è¾¾å¼\"><a class=\"anchor\" href=\"#æ€è·¯äºŒ-ä½¿ç”¨gambaç®€åŒ–å¤æ‚çš„subè¡¨è¾¾å¼\">#</a> æ€è·¯äºŒ ä½¿ç”¨ GAMBA ç®€åŒ–å¤æ‚çš„ SUB è¡¨è¾¾å¼</h3>\n<p>è¿™ä¸ªæ€è·¯äºŒå…¶å®å°±æ˜¯æ€è·¯ä¸€é‚£ä¸€ç‚¹ç‚¹æœªè§£å†³çš„ SUB çš„è¡¥å……ï¼Œå¯¹äºä¸€äº›å¤æ‚çš„è¡¨è¾¾å¼æ¥è¯´ï¼Œgithub ä¸Šçš„å¼€æºå·¥å…·<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0RlbnV2b1NvZnR3YXJlU29sdXRpb25zL0dBTUJB\"> GAMBA</span> å¯ä»¥å¾ˆå¥½çš„å¸®åŠ©æˆ‘ä»¬ç®€åŒ–</p>\n<p>å…·ä½“å¯ä»¥å‚è€ƒ<a href=\"https://oacia.dev/sec-2023/\">ç»†å“ sec2023 å®‰å“èµ›é¢˜</a>ä¸­çš„ <code>åŠ å¯†ä¸‰ vm æŒ‡ä»¤åˆ†æ</code></p>\n<p><img data-src=\"/ollvm-study/image-20240712111021857.png\" alt=\"image-20240712111021857\" style=\"aspect-ratio:1073 / 771;\"></p>\n<h1 id=\"æ§åˆ¶æµå¹³å¦åŒ–fla\"><a class=\"anchor\" href=\"#æ§åˆ¶æµå¹³å¦åŒ–fla\">#</a> æ§åˆ¶æµå¹³å¦åŒ–ï¼ˆFLAï¼‰</h1>\n<h2 id=\"åŸç†-3\"><a class=\"anchor\" href=\"#åŸç†-3\">#</a> åŸç†</h2>\n<p>æ§åˆ¶æµå¹³å¦åŒ– (control flow flattening) çš„åŸºæœ¬æ€æƒ³ä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ªä¸»åˆ†å‘å™¨æ¥æ§åˆ¶ç¨‹åºåŸºæœ¬å—çš„æ‰§è¡Œæµç¨‹ï¼Œä¾‹å¦‚ä¸‹å›¾æ˜¯æ­£å¸¸çš„æ‰§è¡Œæµç¨‹</p>\n<p><img data-src=\"/ollvm-study/bb352c9f40d9ae979f5ac203fc2eb835.png\" alt=\"img\" style=\"aspect-ratio:579 / 169;\"></p>\n<p>ç»è¿‡æ§åˆ¶æµå¹³å¦åŒ–åçš„æ‰§è¡Œæµç¨‹å°±å¦‚ä¸‹å›¾</p>\n<p><img data-src=\"/ollvm-study/471ec1aa469805a15db47e130dde5485.png\" alt=\"img\" style=\"aspect-ratio:683 / 263;\"></p>\n<p>è¿™æ ·å¯ä»¥æ¨¡ç³ŠåŸºæœ¬å—ä¹‹é—´çš„å‰åå…³ç³»</p>\n<p>æ­¤å›¾æ˜¯ä¸€ä¸ªç»å…¸çš„æ§åˆ¶æµå¹³å¦åŒ– CFG</p>\n<p><img data-src=\"/ollvm-study/b6d9662e5a216ac6e7a976dd8d814a79.png\" alt=\"img\" style=\"aspect-ratio:1125 / 1052;\"></p>\n<p>å…¶ä¸­</p>\n<ul>\n<li>åºè¨€ï¼šå‡½æ•°çš„ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„åŸºæœ¬å—</li>\n<li>ä¸» (å­) åˆ†å‘å™¨ï¼šæ§åˆ¶ç¨‹åºè·³è½¬åˆ°ä¸‹ä¸€ä¸ªå¾…æ‰§è¡Œçš„åŸºæœ¬å—</li>\n<li>retn å—ï¼šå‡½æ•°å‡ºå£</li>\n<li>çœŸå®å—ï¼šæ··æ·†å‰çš„åŸºæœ¬å—ï¼Œç¨‹åºçœŸæ­£æ‰§è¡Œå·¥ä½œçš„å—</li>\n<li>é¢„å¤„ç†å™¨ï¼šè·³è½¬åˆ°ä¸»åˆ†å‘å™¨</li>\n</ul>\n<h2 id=\"ollvmçš„flaæ··æ·†\"><a class=\"anchor\" href=\"#ollvmçš„flaæ··æ·†\">#</a> ollvm çš„ FLA æ··æ·†</h2>\n<p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯å®Œæˆ fla æ··æ·†</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>clang <span class=\"token parameter variable\">-mllvm</span> <span class=\"token parameter variable\">-fla</span> <span class=\"token parameter variable\">-mllvm</span> <span class=\"token parameter variable\">-split</span> <span class=\"token parameter variable\">-mllvm</span> <span class=\"token parameter variable\">-split_num</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> test-fla.c <span class=\"token parameter variable\">-o</span> test-fla</pre></td></tr></table></figure><p>å¯ç”¨é€‰é¡¹ï¼š</p>\n<ul>\n<li>-mllvm -fla : æ¿€æ´»æ§åˆ¶æµå¹³å¦åŒ–</li>\n<li>-mllvm -split : æ¿€æ´»åŸºæœ¬å—åˆ†å‰²</li>\n<li>-mllvm -split_num=3 : æŒ‡å®šåŸºæœ¬å—åˆ†å‰²çš„æ•°ç›®</li>\n</ul>\n<p>ç»è¿‡æ§åˆ¶æµå¹³å¦åŒ–ä¹‹åï¼Œå‡½æ•°çš„é€»è¾‘å·²ç»å¾ˆéš¾çœ‹æ¸…æ¥šäº†</p>\n<p><img data-src=\"/ollvm-study/image-20240712132834341.png\" alt=\"image-20240712132834341\" style=\"aspect-ratio:745 / 806;\"></p>\n<h2 id=\"ollvmçš„flaåæ··æ·†\"><a class=\"anchor\" href=\"#ollvmçš„flaåæ··æ·†\">#</a> ollvm çš„ FLA åæ··æ·†</h2>\n<p>æƒ³è¦å®šä½å„ä¸ªå—å…¶å®å¾ˆç®€å•ï¼Œå¯¹äºç»å…¸çš„ ollvm æ¥è¯´ï¼Œå„ä¸ªå—ä¹‹é—´æœ‰å¦‚ä¸‹è§„åˆ™ (è¦æ˜¯é­”æ”¹çš„è¯å°±å…·ä½“æƒ…å†µå…·ä½“åˆ†æå•¦)</p>\n<ol>\n<li>æ‰¾åˆ°<strong>åºè¨€å—</strong>ï¼Œè¿™æ˜¯æ•´ä¸ªå‡½æ•°çš„å…¥å£</li>\n<li>åºè¨€å—çš„åç»§æ˜¯<strong>ä¸»åˆ†å‘å™¨</strong></li>\n<li>ä¸»åˆ†å‘å™¨çš„å‰é©±æœ‰ä¸¤ä¸ªï¼Œé™¤äº†åºè¨€å—å¤–ï¼Œå¦ä¸€ä¸ªå—å°±æ˜¯<strong>é¢„å¤„ç†å™¨</strong></li>\n<li>é¢„å¤„ç†å™¨çš„å‰é©±æ˜¯<strong>çœŸå®å—</strong></li>\n<li>é™¤æ­¤ä¹‹å¤–çš„å…¶ä»–å—æ˜¯<strong>å­åˆ†å‘å™¨</strong></li>\n</ol>\n<p><img data-src=\"/ollvm-study/image-20240712132814751.png\" alt=\"image-20240712132814751\" style=\"aspect-ratio:990 / 856;\"></p>\n<p>æƒ³è¦åæ§åˆ¶æµå¹³å¦åŒ–ï¼Œæˆ‘ä»¬åªéœ€è¦åš 3 æ­¥</p>\n<ol>\n<li>æ‰¾åˆ°çœŸå®å—ã€‚æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨æ‰¾çœŸå®å—ï¼›å¯ä»¥ç”¨ idapython é€šè¿‡å„ä¸ªå—ä¹‹é—´çš„è”ç³»é€šè¿‡ä¸€å®šçš„è§„åˆ™æ‰¾çœŸå®å—ï¼›å¯ä»¥ç”¨ unicorn æˆ– angr å¾—åˆ°å‡½æ•°çš„ CFG, åˆ©ç”¨è§„åˆ™åŒ¹é…å‡ºçœŸå®å—â€¦ æ–¹æ³•å¤šç§å¤šæ ·ï¼Œä½†æ˜¯æ ¸å¿ƒéƒ½æ˜¯æ‰¾åˆ°çœŸå®å—ï¼Œé™¤çœŸå®å—å’Œåºè¨€å¿«å¤–ï¼Œå…¶ä½™çš„å—éƒ½æ˜¯è™šå‡å—ï¼Œæˆ‘ä»¬éœ€è¦ NOP æ‰ä»–ä»¬</li>\n<li>å¾—åˆ°çœŸå®å—ä¹‹é—´çš„è”ç³»ã€‚æˆ‘ä»¬ä¸»è¦æƒ³çŸ¥é“åˆ†æ”¯è·³è½¬çš„å¦ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒç©¶ç«Ÿè·³åˆ°äº†ä»€ä¹ˆåœ°æ–¹å»çš„å‘¢ï¼Ÿæ‰€ä»¥è¿™ä¸€æ­¥æˆ‘ä»¬å¿…é¡»å¾—è®©ä»£ç è¿è¡Œèµ·æ¥ï¼Œå®ƒæŠŠæ§åˆ¶æµç»™æ··æ·†äº†ï¼Œæˆ‘ä»¬è¦æ˜¯ä¸æŠŠä»£ç è·‘èµ·æ¥å’‹çŸ¥é“æ§åˆ¶æµå˜ï¼Ÿå¯ä»¥ç”¨æ¨¡æ‹Ÿæ‰§è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨çœŸæœºè°ƒè¯•æ‰“æ–­ç‚¹ trace, æ ¸å¿ƒéƒ½æ˜¯ä¸ºäº†æ‰¾åˆ°çœŸå®å—ä¹‹é—´çš„è°ƒç”¨å…³ç³»</li>\n<li>å¾—åˆ°äº†çœŸå®å—ä¹‹é—´çš„è”ç³»ä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æ¯ä¸ªçœŸå®å—çš„æœ«å°¾ï¼Œç”¨è·³è½¬æ±‡ç¼–æŒ‡ä»¤å°†æ¯ä¸ªçœŸå®å—åƒä¸²ç³–è‘«èŠ¦ä¸€æ ·ä¸²èµ·æ¥ï¼Œæ§åˆ¶æµå¹³å¦åŒ–å°±ä¿®å¤å¥½å•¦ï½</li>\n</ol>\n<p>æ‰€ä»¥å¼€å§‹æˆ‘ä»¬çš„ç¬¬ä¸€æ­¥æ‰¾åˆ°çœŸå®å—å’Œè™šå‡å—ï¼Œå¯¹äºæ ‡å‡†çš„ ollvm æ¥è¯´ï¼Œè§‚å¯Ÿå¾—çŸ¥é¢„å¤„ç†å™¨çš„å‰é©±éƒ½æ˜¯çœŸå®å—ï¼Œæ‰€ä»¥æˆ‘ä»¬å†™å‡ºå¦‚ä¸‹çš„ idapython è„šæœ¬</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> idaapi</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> idc</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>target_func <span class=\"token operator\">=</span> <span class=\"token number\">0x401E80</span><span class=\"token comment\">#éœ€è¦åæ§åˆ¶æµå¹³å¦åŒ–çš„å‡½æ•°çš„åœ°å€</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Preprocessor_block <span class=\"token operator\">=</span> <span class=\"token number\">0x402697</span><span class=\"token comment\">#ollvm ä¸­é¢„å¤„ç†å™¨çš„åœ°å€ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡è§‚å¯Ÿ ida ä¸­çš„ CFG å¾—åˆ°çš„ï¼Œé¢„å¤„ç†å™¨çš„å‰é©±éƒ½æ˜¯çœŸå®å—</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>True_blocks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token comment\">#çœŸå®å—åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Fake_blocks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token comment\">#æ‰€æœ‰å—çš„åˆ—è¡¨</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>f_block <span class=\"token operator\">=</span> idaapi<span class=\"token punctuation\">.</span>FlowChart<span class=\"token punctuation\">(</span>idaapi<span class=\"token punctuation\">.</span>get_func<span class=\"token punctuation\">(</span><span class=\"token number\">0x401E80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> flags<span class=\"token operator\">=</span>idaapi<span class=\"token punctuation\">.</span>FC_PREDS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">for</span> block <span class=\"token keyword\">in</span> f_block<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> block<span class=\"token punctuation\">.</span>start_ea<span class=\"token operator\">==</span>Preprocessor_block<span class=\"token punctuation\">:</span><span class=\"token comment\">#é¢„å¤„ç†å™¨å—çš„å‰é©±éƒ½æ˜¯çœŸå®å—</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">#but é¢„å¤„ç†å™¨æ˜¯è™šå‡å—</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        Fake_blocks<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">.</span>start_ea<span class=\"token punctuation\">,</span>idc<span class=\"token punctuation\">.</span>prev_head<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">.</span>end_ea<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"find ture block!\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        tbs <span class=\"token operator\">=</span> block<span class=\"token punctuation\">.</span>preds<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">for</span> tb <span class=\"token keyword\">in</span> tbs<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token comment\">#print (hex (tb.start_ea),hex (idc.prev_head (tb.end_ea)))# è·å–å—çš„å¼€å§‹ / ç»“æŸåœ°å€</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            True_blocks<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>tb<span class=\"token punctuation\">.</span>start_ea<span class=\"token punctuation\">,</span>idc<span class=\"token punctuation\">.</span>prev_head<span class=\"token punctuation\">(</span>tb<span class=\"token punctuation\">.</span>end_ea<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">elif</span> <span class=\"token keyword\">not</span> <span class=\"token punctuation\">[</span>x <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> block<span class=\"token punctuation\">.</span>succs<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span><span class=\"token comment\">#è¿”å›å—æ²¡æœ‰åç»§</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"find ret block!\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        True_blocks<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">.</span>start_ea<span class=\"token punctuation\">,</span>idc<span class=\"token punctuation\">.</span>prev_head<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">.</span>end_ea<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\"># åºè¨€å—ä¸ä½œä¸ºè™šå‡å—å¤„ç†</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">elif</span> block<span class=\"token punctuation\">.</span>start_ea<span class=\"token operator\">!=</span>target_func<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token comment\">#print(hex(block.start_ea),hex(idc.prev_head(block.end_ea)))</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        Fake_blocks<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">.</span>start_ea<span class=\"token punctuation\">,</span>idc<span class=\"token punctuation\">.</span>prev_head<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">.</span>end_ea<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'true block:'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'tbs ='</span><span class=\"token punctuation\">,</span>True_blocks<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fake block:'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fbs ='</span><span class=\"token punctuation\">,</span>Fake_blocks<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>ä¹‹åå°±æ˜¯è¦å¾—åˆ°çœŸå®å—ä¹‹é—´çš„è”ç³»å•¦ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨ unicorn æ¥æ¨¡æ‹Ÿæ‰§è¡Œå¾—åˆ°çœŸå®å—çš„è°ƒç”¨å…³ç³»ï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯å› ä¸ºæˆ‘ä»¬åªå¯¹ä¸€ä¸ªå‡½æ•°ä¸­çœŸå®å—çš„å‰åè°ƒç”¨è¿›è¡Œæ¨¡æ‹Ÿæ‰§è¡Œï¼Œæ‰€ä»¥æ˜¯ä¸éœ€è¦è·³è½¬åˆ°å…¶ä»–å‡½æ•°ä¸­çš„ï¼Œé‡åˆ° <code>call</code>  æŒ‡ä»¤ç›´æ¥å°† pc å¼ºåˆ¶æ”¹æˆä¸‹ä¸€è¡Œæ±‡ç¼–çš„åœ°å€ï¼ŒåŒæ—¶ä¹Ÿè¦æ³¨æ„å†…å­˜è®¿é—®å¼‚å¸¸çš„æƒ…å†µç›´æ¥é€šè¿‡ <code>uc.hook_add(UC_HOOK_MEM_UNMAPPED|UC_HOOK_INTR, hook_mem_access)</code>  è¿›è¡Œå¿½ç•¥</p>\n<p>é€šè¿‡è¿™ä¸ª unicorn è„šæœ¬æ¨¡æ‹Ÿæ‰§è¡Œï¼Œæˆ‘ä»¬å¾—åˆ°äº†åˆ†æ”¯è·³è½¬æ—¶ä¸‹ä¸€ä¸ªè¦è·³è½¬çš„çœŸå®å—åœ°å€ï¼Œä»¥åŠæ­¤æ—¶çš„ ZF æ ‡å¿—ä½ï¼Œè¿™ä¸ªæ ‡å¿—ä½å¯æ˜¯æœ‰ç€å¤§ç”¨ï¼Œé€šè¿‡è¿™ä¸ªæ ‡å¿—ä½æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ç©¶ç«Ÿæ˜¯ <code>jz</code>  è·³è½¬è¿˜æ˜¯ <code>jnz</code>  è·³è½¬å•¦</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># code for test-fla.elf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> unicorn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> unicorn<span class=\"token punctuation\">.</span>x86_const <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> keystone <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>  <span class=\"token comment\"># pip install keystone-engine</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> capstone <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>  <span class=\"token comment\"># pip install capstone</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># import networkx as nx #pip install networkx</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># import matplotlib.pyplot as plt  # pip install matplotlib</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>BASE <span class=\"token operator\">=</span> <span class=\"token number\">0x400000</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>CODE <span class=\"token operator\">=</span> BASE <span class=\"token operator\">+</span> <span class=\"token number\">0x0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>CODE_SIZE <span class=\"token operator\">=</span> <span class=\"token number\">0x100000</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>STACK <span class=\"token operator\">=</span> <span class=\"token number\">0x7F00000000</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>STACK_SIZE <span class=\"token operator\">=</span> <span class=\"token number\">0x100000</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>FS <span class=\"token operator\">=</span> <span class=\"token number\">0x7FF0000000</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>FS_SIZE <span class=\"token operator\">=</span> <span class=\"token number\">0x100000</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>ks <span class=\"token operator\">=</span> Ks<span class=\"token punctuation\">(</span>KS_ARCH_X86<span class=\"token punctuation\">,</span> KS_MODE_64<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># æ±‡ç¼–å¼•æ“</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>uc <span class=\"token operator\">=</span> Uc<span class=\"token punctuation\">(</span>UC_ARCH_X86<span class=\"token punctuation\">,</span> UC_MODE_64<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># æ¨¡æ‹Ÿæ‰§è¡Œå¼•æ“</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>cs <span class=\"token operator\">=</span> Cs<span class=\"token punctuation\">(</span>CS_ARCH_X86<span class=\"token punctuation\">,</span> CS_MODE_64<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># åæ±‡ç¼–å¼•æ“</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># g=nx.Graph ()# åˆ›å»ºç©ºçš„æ— å‘å›¾</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># g=nx.DiGraph ()# åˆ›å»ºç©ºçš„æœ‰å‘å›¾</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>tbs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204176</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204182</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203066</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203066</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203071</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203098</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203103</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203157</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203162</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203314</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>       <span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>       <span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>       <span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203656</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203689</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203694</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203737</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203742</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203776</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>       <span class=\"token punctuation\">(</span><span class=\"token number\">4203781</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203804</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>       <span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>       <span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204138</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204171</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>tb_call <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>main_addr <span class=\"token operator\">=</span> <span class=\"token number\">0x00000000000401E80</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>main_end <span class=\"token operator\">=</span> <span class=\"token number\">0x0000000000040269C</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">hook_code</span><span class=\"token punctuation\">(</span>uc<span class=\"token punctuation\">:</span> unicorn<span class=\"token punctuation\">.</span>Uc<span class=\"token punctuation\">,</span> address<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> user_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\"># print(hex(address))</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> cs<span class=\"token punctuation\">.</span>disasm<span class=\"token punctuation\">(</span>CODE_DATA<span class=\"token punctuation\">[</span>address <span class=\"token operator\">-</span> BASE<span class=\"token punctuation\">:</span>address <span class=\"token operator\">-</span> BASE <span class=\"token operator\">+</span> size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token keyword\">if</span> i<span class=\"token punctuation\">.</span>mnemonic <span class=\"token operator\">==</span> <span class=\"token string\">\"call\"</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># å› ä¸ºåªæ˜¯é’ˆå¯¹å•ä¸ªå‡½æ•°çš„æ§åˆ¶æµï¼Œæ‰€ä»¥æˆ‘ä»¬å¹¶ä¸éœ€è¦è·³è½¬åˆ°å…¶ä»–çš„å‡½æ•°é‡Œé¢</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"find call at </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">, jump...\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            uc<span class=\"token punctuation\">.</span>reg_write<span class=\"token punctuation\">(</span>UC_X86_REG_RIP<span class=\"token punctuation\">,</span> address <span class=\"token operator\">+</span> size<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token keyword\">elif</span> i<span class=\"token punctuation\">.</span>mnemonic <span class=\"token operator\">==</span> <span class=\"token string\">\"ret\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"find ret block, emu stop~\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            uc<span class=\"token punctuation\">.</span>emu_stop<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"block emu pathâ†“â†“â†“â†“\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>tb_call<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token comment\"># for i in range(len(tb_call)-1):</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token comment\">#     g.add_edge(tb_call[i],tb_call[i+1])</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token comment\"># Plot it</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            <span class=\"token comment\"># nx.draw(g, with_labels=True)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            <span class=\"token comment\"># nx.write_gml(g,'./test-fla.gml')</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token keyword\">for</span> tb <span class=\"token keyword\">in</span> tbs<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token keyword\">if</span> address <span class=\"token operator\">==</span> tb<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            <span class=\"token comment\"># print (uc.reg_read (UC_X86_REG_FLAGS))#ZF æ ‡å¿—ä½åœ¨ç¬¬ 6 ä½</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            ZF_flag <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>uc<span class=\"token punctuation\">.</span>reg_read<span class=\"token punctuation\">(</span>UC_X86_REG_FLAGS<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0b1000000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            <span class=\"token comment\">#print(\"ZF=\", ZF_flag)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            tb_call<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>tb<span class=\"token punctuation\">,</span> ZF_flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            <span class=\"token keyword\">break</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">hook_mem_access</span><span class=\"token punctuation\">(</span>uc<span class=\"token punctuation\">:</span> unicorn<span class=\"token punctuation\">.</span>Uc<span class=\"token punctuation\">,</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">,</span> address<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> userdata<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    pc <span class=\"token operator\">=</span> uc<span class=\"token punctuation\">.</span>reg_read<span class=\"token punctuation\">(</span>UC_X86_REG_RSP<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># UC_ARM64_REG_PC</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'pc:%x type:%d addr:%x size:%x'</span> <span class=\"token operator\">%</span> <span class=\"token punctuation\">(</span>pc<span class=\"token punctuation\">,</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">,</span> address<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token comment\"># uc.emu_stop()</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">True</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">inituc</span><span class=\"token punctuation\">(</span>uc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    uc<span class=\"token punctuation\">.</span>mem_map<span class=\"token punctuation\">(</span>CODE<span class=\"token punctuation\">,</span> CODE_SIZE<span class=\"token punctuation\">,</span> UC_PROT_ALL<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    uc<span class=\"token punctuation\">.</span>mem_map<span class=\"token punctuation\">(</span>STACK<span class=\"token punctuation\">,</span> STACK_SIZE<span class=\"token punctuation\">,</span> UC_PROT_ALL<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    uc<span class=\"token punctuation\">.</span>mem_write<span class=\"token punctuation\">(</span>CODE<span class=\"token punctuation\">,</span> CODE_DATA<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    uc<span class=\"token punctuation\">.</span>reg_write<span class=\"token punctuation\">(</span>UC_X86_REG_RSP<span class=\"token punctuation\">,</span> STACK <span class=\"token operator\">+</span> <span class=\"token number\">0x1000</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    uc<span class=\"token punctuation\">.</span>hook_add<span class=\"token punctuation\">(</span>UC_HOOK_CODE<span class=\"token punctuation\">,</span> hook_code<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    uc<span class=\"token punctuation\">.</span>hook_add<span class=\"token punctuation\">(</span>UC_HOOK_MEM_UNMAPPED <span class=\"token operator\">|</span> UC_HOOK_INTR<span class=\"token punctuation\">,</span> hook_mem_access<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">init_graph</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    <span class=\"token keyword\">for</span> tb <span class=\"token keyword\">in</span> tbs<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        g<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span>tb<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./test-fla'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    CODE_DATA <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>inituc<span class=\"token punctuation\">(</span>uc<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    uc<span class=\"token punctuation\">.</span>emu_start<span class=\"token punctuation\">(</span>main_addr<span class=\"token punctuation\">,</span> main_end<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>ä¹‹åå†å»å†™ä¸€ä¸ª idapython è„šæœ¬å°†çœŸå®å—ä¸²èµ·æ¥å°±å¯ä»¥å•¦ï¼Œæˆ‘ä»¬è§‚å¯Ÿæ ‡å‡†çš„ ollvm æ··æ·†åçš„æ–‡ä»¶åå‘ç°ï¼Œå…¶å®çœŸå®å—æ‰€å¤„çš„ä½ç½®æ˜¯è¿ç»­çš„ï¼Œæ¯”å¦‚æœ‰è¿™ä¸¤ä¸ªçœŸå®å—ï¼Œè™½ç„¶ä»–ä»¬è·³è½¬çš„åœ°å€éƒ½æ˜¯ <code>loc_402697</code>  é¢„å¤„ç†å™¨çš„ä½ç½®ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªçœŸå®å—æ²¡æœ‰åˆ†æ”¯è·³è½¬ï¼Œæ‰€ä»¥è¯´æˆ‘ä»¬åªéœ€è¦å°† <code>jmp loc_402697</code>  nop æ‰ï¼Œå°±å®Œæˆäº†æ— åˆ†æ”¯è·³è½¬çœŸå®å—çš„ä¸²è”ï¼Œè€Œéº»çƒ¦çš„åªæ˜¯åˆ†æ”¯è·³è½¬ï¼Œæˆ‘ä»¬ç”±æ¨¡æ‹Ÿæ‰§è¡Œåå·²ç»å¾—åˆ°äº†åˆ†æ”¯è·³è½¬æ—¶çš„ ZF æ ‡å¿—ä½ï¼Œé€šè¿‡è¯¥æ ‡å¿—ä½æˆ‘ä»¬å°†å°† jmp æ”¹æˆä¸ºé›¶è·³è½¬ (jz) äº¦æˆ–æ˜¯éé›¶è·³è½¬ (jnz)</p>\n<p><img data-src=\"/ollvm-study/image-20240719234623318.png\" alt=\"image-20240719234623318\" style=\"aspect-ratio:1104 / 582;\"></p>\n<p>å†™ä¸€ä¸‹ patch è„šæœ¬ï¼Œä¿®å¤æˆåŠŸï½</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> idaapi</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> ida_bytes</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> idc</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> keystone <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ks <span class=\"token operator\">=</span> Ks<span class=\"token punctuation\">(</span>KS_ARCH_X86<span class=\"token punctuation\">,</span> KS_MODE_64<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># æ±‡ç¼–å¼•æ“</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">jmp_patch</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">,</span> j_code<span class=\"token operator\">=</span><span class=\"token string\">\"jmp\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">global</span> debug</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    patch_byte<span class=\"token punctuation\">,</span> count <span class=\"token operator\">=</span> ks<span class=\"token punctuation\">.</span>asm<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>j_code<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span> addr<span class=\"token operator\">=</span>start<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    patch_byte <span class=\"token operator\">=</span> <span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span>patch_byte<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">b'\\x00'</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>idc<span class=\"token punctuation\">.</span>get_item_size<span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>patch_byte<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>j_code<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span> patch_byte<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ida_bytes<span class=\"token punctuation\">.</span>patch_bytes<span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span> patch_byte<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">patch_nop</span><span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">,</span> endaddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">#print(f\"Patching from &#123;addr&#125; to &#123;endaddr&#125;\")</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">while</span> addr <span class=\"token operator\">&lt;</span> endaddr<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        ida_bytes<span class=\"token punctuation\">.</span>patch_byte<span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">,</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        addr <span class=\"token operator\">+=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">patch_nop_line</span><span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    patch_nop<span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">,</span>addr<span class=\"token operator\">+</span>idc<span class=\"token punctuation\">.</span>get_item_size<span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>preamble_block <span class=\"token operator\">=</span> <span class=\"token number\">0x401E8B</span>  <span class=\"token comment\"># åºè¨€å—çš„åœ°å€</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>internal_reg <span class=\"token operator\">=</span> <span class=\"token string\">'[rbp+var_B4]'</span><span class=\"token comment\">#ä¸­é—´å˜é‡çš„åç§°ï¼Œé‡åˆ°è¿™ä¸ªæƒ³éƒ½ä¸ç”¨æƒ³ç›´æ¥ NOP</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># æ ¼å¼: ((å—çš„èµ·å§‹åœ°å€ï¼Œå—çš„ç»“æŸåœ°å€),ZF æ ‡å¿—ä½)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>tb_path <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203071</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203098</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203103</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203157</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203162</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203314</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203656</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203689</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203694</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203737</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203742</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203776</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203781</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203804</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>           <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204138</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204171</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>tbs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">4204176</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204182</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203066</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203066</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203071</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203098</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203103</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203157</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203162</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203314</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203656</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203689</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203694</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203737</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203742</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203776</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203781</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203804</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204138</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204171</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>fbs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token number\">4202133</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202159</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202165</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202165</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202170</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202187</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202193</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202193</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202198</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202215</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202221</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202221</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202226</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202243</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202249</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202249</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202254</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202271</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202277</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202277</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202282</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202299</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202305</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202305</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202310</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202327</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202333</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202333</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202338</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202355</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202361</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202361</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202366</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202383</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202389</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202389</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202394</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202411</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202417</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202417</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202422</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202439</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202445</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202445</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202450</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202467</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202473</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202473</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202478</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202495</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202501</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202501</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202506</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202523</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202529</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202529</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202534</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202551</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202557</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202557</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202562</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202579</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202585</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202607</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202613</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202613</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202618</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202635</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202641</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202646</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202663</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202669</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202669</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202674</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202691</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202697</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202697</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202702</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202719</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202725</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202725</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202730</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202747</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202753</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202753</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202758</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202775</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202781</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202781</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202786</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202803</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202809</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202814</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202837</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202837</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202842</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202859</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202865</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202865</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202870</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202887</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202893</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202898</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202915</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202921</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202921</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202926</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202943</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202949</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202949</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202954</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202971</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202977</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202977</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4202982</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4202999</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203005</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203005</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203010</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203027</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203033</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203033</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203038</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203055</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203061</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203061</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203066</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203066</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203071</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203098</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203103</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203157</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203162</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203314</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203319</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203341</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203346</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203366</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203371</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203398</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203403</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203428</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203433</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203457</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203462</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203490</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203495</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203514</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203519</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203558</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203563</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203585</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203590</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203609</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203614</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203636</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203641</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203651</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203656</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203689</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203694</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203737</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203742</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203776</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203781</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203804</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203809</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203831</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203856</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203861</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203888</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203893</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203918</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203923</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203957</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203962</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4203981</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4203986</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204025</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204030</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204040</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204045</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204067</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204072</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204091</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204096</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204118</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204133</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204138</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204171</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token number\">4204183</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4204183</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>block_info <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span>  <span class=\"token comment\">#åˆ¤æ–­æœ‰æ²¡æœ‰ patch ç»“æŸ</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>tbs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>    block_info<span class=\"token punctuation\">[</span>tbs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'finish'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token string\">'ret'</span><span class=\"token punctuation\">:</span><span class=\"token number\">0</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre></pre></td></tr><tr><td data-num=\"142\"></td><td><pre><span class=\"token comment\">#nop æ‰æ‰€æœ‰è™šå‡å—</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre><span class=\"token keyword\">for</span> fb <span class=\"token keyword\">in</span> fbs<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>    patch_nop<span class=\"token punctuation\">(</span>fb<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> fb<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> idc<span class=\"token punctuation\">.</span>get_item_size<span class=\"token punctuation\">(</span>fb<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre><span class=\"token keyword\">for</span> tb <span class=\"token keyword\">in</span> tbs<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>    dont_patch <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>    current_addr <span class=\"token operator\">=</span> tb<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>    <span class=\"token keyword\">while</span> current_addr <span class=\"token operator\">&lt;=</span> tb<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>        <span class=\"token comment\"># print(hex(current_addr),idc.GetDisasm(current_addr))</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token string\">\"cmov\"</span> <span class=\"token keyword\">in</span> idc<span class=\"token punctuation\">.</span>print_insn_mnem<span class=\"token punctuation\">(</span>current_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>            <span class=\"token comment\">#cmov æŒ‡ä»¤ä¼šå½±å“åˆ†æ”¯è·³è½¬ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ patch æ‰</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>            patch_nop_line<span class=\"token punctuation\">(</span>current_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>            dont_patch <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>            <span class=\"token comment\"># print(hex(current_addr),hex(tb_path[i][0]))</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>        <span class=\"token keyword\">elif</span> internal_reg <span class=\"token keyword\">in</span> idc<span class=\"token punctuation\">.</span>print_operand<span class=\"token punctuation\">(</span>current_addr<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'find internal_reg!'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>            patch_nop_line<span class=\"token punctuation\">(</span>current_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>        <span class=\"token keyword\">elif</span> <span class=\"token string\">'ret'</span> <span class=\"token keyword\">in</span> idc<span class=\"token punctuation\">.</span>print_insn_mnem<span class=\"token punctuation\">(</span>current_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>            block_info<span class=\"token punctuation\">[</span>tb<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'ret'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>            dont_patch <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>        current_addr <span class=\"token operator\">=</span> idc<span class=\"token punctuation\">.</span>next_head<span class=\"token punctuation\">(</span>current_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> dont_patch<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>        patch_nop_line<span class=\"token punctuation\">(</span>tb<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>        block_info<span class=\"token punctuation\">[</span>tb<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'finish'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre><span class=\"token comment\"># åºè¨€å— -> ç¬¬ä¸€ä¸ªçœŸå®å— patch</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>jmp_patch<span class=\"token punctuation\">(</span>preamble_block<span class=\"token punctuation\">,</span> tb_path<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>tb_path<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>    <span class=\"token comment\"># ä¸æ˜¯è¿”å›å—ï¼Œä¹Ÿæœªå®Œæˆ patch, å‰©ä¸‹çš„æŒ‡ä»¤éƒ½æ˜¯æœ‰åˆ†æ”¯è·³è½¬çš„.</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>    <span class=\"token keyword\">if</span> block_info<span class=\"token punctuation\">[</span>tb_path<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'finish'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token keyword\">and</span> <span class=\"token keyword\">not</span> block_info<span class=\"token punctuation\">[</span>tb_path<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'ret'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>        ZF <span class=\"token operator\">=</span> tb_path<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>        <span class=\"token comment\">#å½“è¦è·³è½¬çš„å—å’Œå½“å‰å—ä¸è¿ç»­æ—¶ï¼Œè¿™ä¸ªåˆ†æ”¯è·³è½¬æ‰ä¿®å¤å®Œæˆ</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> idc<span class=\"token punctuation\">.</span>next_head<span class=\"token punctuation\">(</span>tb_path<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> tb_path<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>            block_info<span class=\"token punctuation\">[</span>tb_path<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'finish'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>            j_code <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'jnz'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'jz'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>            jmp_patch<span class=\"token punctuation\">(</span>tb_path<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> tb_path<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> j_code<span class=\"token punctuation\">[</span>ZF<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>patch å®Œä¹‹åçœ‹ä¸€ä¸‹ï¼Œè¿™ä¸ªä»£ç ä¹Ÿå¤ªå¥½çœ‹äº†å§å“ˆå“ˆå“ˆï¼ <code>(â—'â—¡'â—)</code></p>\n<p><img data-src=\"/ollvm-study/image-20240720005911998.png\" alt=\"image-20240720005911998\" style=\"aspect-ratio:610 / 1025;\"></p>\n<p>å°å°æ€»ç»“ä¸€ä¸‹ï¼Œæ„Ÿè§‰ ollvm çš„æ§åˆ¶æµå¹³å¦åŒ–å»æ··æ·†åŸæ¥é‚£ä¹ˆç®€å•å‘ï½å»å¹´<a href=\"https://oacia.dev/sec-2023/\"> sec2023 å®‰å“èµ›é¢˜</a>çš„ <code>CESL-BR</code>  æ··æ·†å’Œ <code>CEST-BR</code>  æ··æ·†çš„åæ··æ·† idapython è„šæœ¬å¯çœŸæ˜¯æŠŠæˆ‘å†™æ˜è¿‡å»äº† (å€’)</p>\n<h1 id=\"å‚è€ƒèµ„æ–™\"><a class=\"anchor\" href=\"#å‚è€ƒèµ„æ–™\">#</a> å‚è€ƒèµ„æ–™</h1>\n<ul>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjI1NzU2Lmh0bQ==\">ollvm å¿«é€Ÿå­¦ä¹ </span></p>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3JlYWQvY3YxMzE0ODkwMy8=\">è·Ÿç€é“å¤´å¹²æ··æ·† 3 ubuntu ä¸‹ç”¨ docker ç¼–è¯‘ ollvm (ä¿è¯æˆåŠŸ)</span></p>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qZXYwbi5jb20vMjAyMi8wNy8wNy9vbGx2bS0wLmh0bWw=\">OLLVM æ··æ·†å­¦ä¹ ï¼ˆ0ï¼‰â€”â€” ç¯å¢ƒæ­å»ºåŠæ··æ·†åˆä½“éªŒ</span></p>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjY2MDA1LTEuaHRt\">åˆ©ç”¨ angr ç¬¦å·æ‰§è¡Œå»é™¤è™šå‡æ§åˆ¶æµ</span></p>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjc0NTMyLmh0bQ==\">[åŸåˆ›] Android APP æ¼æ´ä¹‹æˆ˜ï¼ˆ14ï¼‰â€”â€”Ollvm æ··æ·†ä¸åæ··æ·†</span></p>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zZWN1cml0eS50ZW5jZW50LmNvbS9pbmRleC5waHAvYmxvZy9tc2cvMTEy\">åˆ©ç”¨ç¬¦å·æ‰§è¡Œå»é™¤æ§åˆ¶æµå¹³å¦åŒ–</span></p>\n</li>\n<li>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vT25seS14aWFveGlhby9wLzE2ODg4NjExLmh0bWw=\">ä»£ç æ··æ·†ä¸åæ··æ·†å­¦ä¹  - ç¬¬ä¸€å¼¹</span></p>\n</li>\n</ul>\n",
            "tags": [
                "ollvm"
            ]
        },
        {
            "id": "https://oacia.dev/android-binder/",
            "url": "https://oacia.dev/android-binder/",
            "title": "android binderæºç åˆ†æ",
            "date_published": "2024-07-06T06:25:21.000Z",
            "content_html": "<p>Binder æ˜¯ Android ç‹¬æœ‰çš„ä¸€ç§é€šä¿¡æœºåˆ¶ï¼Œ <code>Activity</code> ï¼Œ <code>Service</code> ï¼Œ <code>Broadcast</code> ï¼Œ <code>ContentProvider</code>  è¿™å››å¤§ç»„ä»¶æ‰€æ¶‰åŠçš„å¤šè¿›ç¨‹é—´çš„é€šä¿¡åº•å±‚éƒ½æ˜¯ä¾èµ–äº Binder IPC æœºåˆ¶ã€‚å­¦å¥½åº•å±‚çš„é€šä¿¡åŸç†å¯¹æŒæ¡å®‰å“è¿™å¹¢å¤§å¦æœ‰ç€é‡è¦çš„æ„ä¹‰.</p>\n<h1 id=\"è¯´æ˜\"><a class=\"anchor\" href=\"#è¯´æ˜\">#</a> è¯´æ˜</h1>\n<p>æœ¬æ–‡æ‰€ç ”ç©¶çš„å®‰å“å†…æ ¸ç‰ˆæœ¬ä¸º <code>Linux version 4.9.270-g862f51bac900-ab7613625</code></p>\n<p>å®‰å“æ¡†æ¶ç‰ˆæœ¬ä¸º <code>android-12.0.0_r34</code></p>\n<h1 id=\"binderç®€ä»‹\"><a class=\"anchor\" href=\"#binderç®€ä»‹\">#</a> Binder ç®€ä»‹</h1>\n<p>ä»è¿›ç¨‹è§’åº¦æ¥çœ‹ IPC (Inter Process Communication) æœºåˆ¶ï¼Œæ¯ä¸ª Android çš„è¿›ç¨‹ï¼Œåªèƒ½è¿è¡Œåœ¨è‡ªå·±è¿›ç¨‹æ‰€æ‹¥æœ‰çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚å¯¹äºç”¨æˆ·ç©ºé—´ï¼Œä¸åŒè¿›ç¨‹ä¹‹é—´å½¼æ­¤æ˜¯ä¸èƒ½å…±äº«çš„ï¼Œè€Œå†…æ ¸ç©ºé—´å´æ˜¯å¯å…±äº«çš„ã€‚Client è¿›ç¨‹å‘ Server è¿›ç¨‹é€šä¿¡ï¼Œæ°æ°æ˜¯åˆ©ç”¨è¿›ç¨‹é—´å¯å…±äº«çš„å†…æ ¸å†…å­˜ç©ºé—´æ¥å®Œæˆåº•å±‚é€šä¿¡å·¥ä½œçš„ï¼ŒClient ç«¯ä¸ Server ç«¯è¿›ç¨‹å¾€å¾€é‡‡ç”¨ ioctl ç­‰æ–¹æ³•è·Ÿå†…æ ¸ç©ºé—´çš„é©±åŠ¨è¿›è¡Œäº¤äº’ã€‚</p>\n<p><img data-src=\"/android-binder/binder_interprocess_communication.png\" alt=\"binder_interprocess_communication\" style=\"aspect-ratio:643 / 403;\"></p>\n<p>Binder é€šä¿¡é‡‡ç”¨ C/S æ¶æ„ï¼Œä»ç»„ä»¶è§†è§’æ¥è¯´ï¼ŒåŒ…å« Clientã€Serverã€ServiceManager ä»¥åŠ binder é©±åŠ¨ï¼Œå…¶ä¸­ ServiceManager ç”¨äºç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼Œå›¾ä¸­çš„ Client,Server,Service Manager ä¹‹é—´äº¤äº’éƒ½æ˜¯è™šçº¿è¡¨ç¤ºï¼Œæ˜¯ç”±äºå®ƒä»¬å½¼æ­¤ä¹‹é—´ä¸æ˜¯ç›´æ¥äº¤äº’çš„ï¼Œè€Œæ˜¯éƒ½é€šè¿‡ Binder é©±åŠ¨è¿›è¡Œäº¤äº’çš„ï¼Œä»è€Œå®ç° IPC é€šä¿¡æ–¹å¼ã€‚å…¶ä¸­ Binder é©±åŠ¨ä½äºå†…æ ¸ç©ºé—´ï¼ŒClient,Server,Service Manager ä½äºç”¨æˆ·ç©ºé—´ã€‚</p>\n<p><img data-src=\"/android-binder/IPC-Binder.jpg\" alt=\"ServiceManager\" style=\"aspect-ratio:921 / 448;\"></p>\n<h1 id=\"binderè®¾å¤‡çš„åˆå§‹åŒ–è¿‡ç¨‹\"><a class=\"anchor\" href=\"#binderè®¾å¤‡çš„åˆå§‹åŒ–è¿‡ç¨‹\">#</a> Binder è®¾å¤‡çš„åˆå§‹åŒ–è¿‡ç¨‹</h1>\n<p>åœ¨ Linux ä¸­ï¼Œä¸‡ç‰©çš†æ–‡ä»¶ï¼Œé‚£ä¹ˆæ¯«æ— ç–‘é—®ï¼ŒBinder å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒçš„åˆå§‹åŒ–å‡½æ•°æ˜¯ <code>binder_init</code> , ä¸»è¦åŠŸèƒ½æ˜¯æ³¨å†Œ binder è®¾å¤‡</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//kernel\\drivers\\android\\binder.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> __init <span class=\"token function\">binder_init</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">int</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>device_name<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>device_names<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>device_tmp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">binder_device</span> <span class=\"token operator\">*</span>device<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">hlist_node</span> <span class=\"token operator\">*</span>tmp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">// åˆå§‹åŒ– lru é“¾è¡¨ï¼Œè¯¥é“¾è¡¨ç”¨äºç®¡ç†å†…å­˜é¡µï¼›æ³¨å†Œ shrinker ç»“æ„ä½“</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tret <span class=\"token operator\">=</span> <span class=\"token function\">binder_alloc_shrinker_init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">// åŸå­æ“ä½œèµ‹å€¼</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token function\">atomic_set</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>binder_transaction_log<span class=\"token punctuation\">.</span>cur<span class=\"token punctuation\">,</span> <span class=\"token operator\">~</span><span class=\"token number\">0U</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token function\">atomic_set</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>binder_transaction_log_failed<span class=\"token punctuation\">.</span>cur<span class=\"token punctuation\">,</span> <span class=\"token operator\">~</span><span class=\"token number\">0U</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token comment\">/**debug ç›¸å…³çš„ä»£ç ï¼Œä¹‹å debug ç›¸å…³çš„ä»£ç å°†ä¸å†å‡ºç° **/</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token comment\">// åœ¨ debugfs æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºäº† binder æ–‡ä»¶å¤¹</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tbinder_debugfs_dir_entry_root <span class=\"token operator\">=</span> <span class=\"token function\">debugfs_create_dir</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"binder\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token comment\">// å¦‚æœ binder æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸï¼Œåˆ™åœ¨è¯¥æ–‡ä»¶å¤¹å†…ç»§ç»­åˆ›å»º binder/proc æ–‡ä»¶å¤¹</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>binder_debugfs_dir_entry_root<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\tbinder_debugfs_dir_entry_proc <span class=\"token operator\">=</span> <span class=\"token function\">debugfs_create_dir</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"proc\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t\t\t\t\t binder_debugfs_dir_entry_root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>binder_debugfs_dir_entry_root<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token comment\">// ç»§ç»­åœ¨ binder ç›®å½•ä¸­åˆ›å»º state,stats,transactions,transaction_log,failed_transaction_log æ–‡ä»¶ï¼Œè¯»å– Binder é©±åŠ¨ç¨‹åºçš„è¿è¡Œæƒ…å†µ</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token function\">debugfs_create_file</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"state\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\t\t    <span class=\"token number\">0444</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t\t    binder_debugfs_dir_entry_root<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t\t    <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\t\t    <span class=\"token operator\">&amp;</span>binder_state_fops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t<span class=\"token function\">debugfs_create_file</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"stats\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t\t    <span class=\"token number\">0444</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t\t    binder_debugfs_dir_entry_root<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t\t    <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t\t    <span class=\"token operator\">&amp;</span>binder_stats_fops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token function\">debugfs_create_file</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"transactions\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t\t    <span class=\"token number\">0444</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t\t    binder_debugfs_dir_entry_root<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t\t    <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t\t    <span class=\"token operator\">&amp;</span>binder_transactions_fops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t<span class=\"token function\">debugfs_create_file</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"transaction_log\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t\t    <span class=\"token number\">0444</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t\t    binder_debugfs_dir_entry_root<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t\t    <span class=\"token operator\">&amp;</span>binder_transaction_log<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\t\t    <span class=\"token operator\">&amp;</span>binder_transaction_log_fops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token function\">debugfs_create_file</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"failed_transaction_log\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t\t\t    <span class=\"token number\">0444</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t\t    binder_debugfs_dir_entry_root<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t\t    <span class=\"token operator\">&amp;</span>binder_transaction_log_failed<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\t\t    <span class=\"token operator\">&amp;</span>binder_transaction_log_fops<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t * Copy the module_parameter string, because we don't want to</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t * tokenize it in-place.</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t */</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t<span class=\"token comment\">// åœ¨å†…æ ¸ç©ºé—´ä¸­åˆ†é…å†…å­˜ï¼ŒGFP_KERNEL è¡¨ç¤ºæ­£å¸¸åˆ†é…å†…å­˜</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\tdevice_names <span class=\"token operator\">=</span> <span class=\"token function\">kzalloc</span><span class=\"token punctuation\">(</span><span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span>binder_devices_param<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> GFP_KERNEL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>device_names<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\tret <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>ENOMEM<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t<span class=\"token keyword\">goto</span> err_alloc_device_names_failed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token comment\">// å°† binder,hwbinder,vndbinder èµ‹å€¼ç»™ device_names</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token function\">strcpy</span><span class=\"token punctuation\">(</span>device_names<span class=\"token punctuation\">,</span> binder_devices_param<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\tdevice_tmp <span class=\"token operator\">=</span> device_names<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>device_name <span class=\"token operator\">=</span> <span class=\"token function\">strsep</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>device_tmp<span class=\"token punctuation\">,</span> <span class=\"token string\">\",\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t<span class=\"token comment\">// ä»¥ \",\" ä½œä¸ºåˆ†éš”ç¬¦ï¼Œæ³¨å†Œ misc è®¾å¤‡ /dev/binder/dev/hwbinder/dev/vndbinder</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\tret <span class=\"token operator\">=</span> <span class=\"token function\">init_binder_device</span><span class=\"token punctuation\">(</span>device_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> err_init_binder_device_failed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t<span class=\"token keyword\">return</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>err_init_binder_device_failed<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t<span class=\"token function\">hlist_for_each_entry_safe</span><span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">,</span> tmp<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>binder_devices<span class=\"token punctuation\">,</span> hlist<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t<span class=\"token function\">misc_deregister</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>device<span class=\"token operator\">-></span>miscdev<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t<span class=\"token function\">hlist_del</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>device<span class=\"token operator\">-></span>hlist<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t<span class=\"token function\">kfree</span><span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t<span class=\"token function\">kfree</span><span class=\"token punctuation\">(</span>device_names<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>err_alloc_device_names_failed<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t<span class=\"token function\">debugfs_remove_recursive</span><span class=\"token punctuation\">(</span>binder_debugfs_dir_entry_root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t<span class=\"token keyword\">return</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>åœ¨ <code>binder_init</code>  ä¸­ï¼Œè°ƒç”¨äº† <code>init_binder_device</code>  é€šè¿‡ <code>misc_register</code>  æ¥æ³¨å†Œ binder è®¾å¤‡</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//kernel\\drivers\\android\\binder.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">file_operations</span> binder_fops <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token punctuation\">.</span>owner <span class=\"token operator\">=</span> THIS_MODULE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token punctuation\">.</span>poll <span class=\"token operator\">=</span> binder_poll<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">.</span>unlocked_ioctl <span class=\"token operator\">=</span> binder_ioctl<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">.</span>compat_ioctl <span class=\"token operator\">=</span> binder_ioctl<span class=\"token punctuation\">,</span><span class=\"token comment\">//IO æ§åˆ¶å‡½æ•°</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">.</span>mmap <span class=\"token operator\">=</span> binder_mmap<span class=\"token punctuation\">,</span><span class=\"token comment\">// å†…å­˜æ˜ å°„å‡½æ•°</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token punctuation\">.</span>open <span class=\"token operator\">=</span> binder_open<span class=\"token punctuation\">,</span><span class=\"token comment\">//binder æ–‡ä»¶æ‰“å¼€å‡½æ•°</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token punctuation\">.</span>flush <span class=\"token operator\">=</span> binder_flush<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token punctuation\">.</span>release <span class=\"token operator\">=</span> binder_release<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> __init <span class=\"token function\">init_binder_device</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>name<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token keyword\">int</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">binder_device</span> <span class=\"token operator\">*</span>binder_device<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tbinder_device <span class=\"token operator\">=</span> <span class=\"token function\">kzalloc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>binder_device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> GFP_KERNEL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>binder_device<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token operator\">-</span>ENOMEM<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tbinder_device<span class=\"token operator\">-></span>miscdev<span class=\"token punctuation\">.</span>fops <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>binder_fops<span class=\"token punctuation\">;</span><span class=\"token comment\">//// è®¾å¤‡çš„æ–‡ä»¶æ“ä½œç»“æ„ï¼Œè¿™æ˜¯ file_operations ç»“æ„</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tbinder_device<span class=\"token operator\">-></span>miscdev<span class=\"token punctuation\">.</span>minor <span class=\"token operator\">=</span> MISC_DYNAMIC_MINOR<span class=\"token punctuation\">;</span><span class=\"token comment\">// æ¬¡è®¾å¤‡å· åŠ¨æ€åˆ†é…</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tbinder_device<span class=\"token operator\">-></span>miscdev<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span><span class=\"token comment\">//// è®¾å¤‡å</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token comment\">// è®¾ç½® binder_contextï¼Œç”¨äºè®°å½• servicemanager çš„ binder_node ä¿¡æ¯ï¼Œ</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token comment\">// ç”±äº binder_device æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œè¿™æ˜¯ servicemanager å¯ä»¥æˆä¸ºå®ˆæŠ¤è¿›</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token comment\">// ç¨‹çš„å…³é”®ã€‚</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tbinder_device<span class=\"token operator\">-></span>context<span class=\"token punctuation\">.</span>binder_context_mgr_uid <span class=\"token operator\">=</span> INVALID_UID<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tbinder_device<span class=\"token operator\">-></span>context<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token function\">mutex_init</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>binder_device<span class=\"token operator\">-></span>context<span class=\"token punctuation\">.</span>context_mgr_node_lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token comment\">// æ³¨å†Œ binder è®¾å¤‡</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tret <span class=\"token operator\">=</span> <span class=\"token function\">misc_register</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>binder_device<span class=\"token operator\">-></span>miscdev<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token function\">kfree</span><span class=\"token punctuation\">(</span>binder_device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token function\">hlist_add_head</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>binder_device<span class=\"token operator\">-></span>hlist<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>binder_devices<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token keyword\">return</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"binderè®¾å¤‡æ–‡ä»¶çš„æ‰“å¼€è¿‡ç¨‹\"><a class=\"anchor\" href=\"#binderè®¾å¤‡æ–‡ä»¶çš„æ‰“å¼€è¿‡ç¨‹\">#</a> Binder è®¾å¤‡æ–‡ä»¶çš„æ‰“å¼€è¿‡ç¨‹</h1>\n<p>ä¸€ä¸ªè¿›ç¨‹åœ¨ä½¿ç”¨ binder è¿›è¡Œé€šä¿¡ä¹‹å‰ï¼Œéœ€è¦ä½¿ç”¨ open å‡½æ•°æ¥æ‰“å¼€è®¾å¤‡æ–‡ä»¶ /dev/binder, åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œ <code>binder_open</code>  å‡½æ•°å°±ä¼šè¢«è°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å¦‚ä¸‹</p>\n<ul>\n<li>åˆ›å»º <code>binder_proc</code>  å¯¹è±¡</li>\n<li>æŠŠå½“å‰è¿›ç¨‹ç­‰ä¿¡æ¯ä¿å­˜åˆ° <code>binder_proc</code>  å¯¹è±¡</li>\n<li>æŠŠ <code>binder_proc</code>  å¯¹è±¡ä¿å­˜åˆ°æ–‡ä»¶æŒ‡é’ˆ <code>filp</code></li>\n<li>æŠŠ <code>binder_proc</code>  åŠ å…¥åˆ°å…¨å±€é“¾è¡¨ <code>binder_procs</code> ã€‚</li>\n</ul>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//kernel\\drivers\\android\\binder.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token function\">binder_open</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">inode</span> <span class=\"token operator\">*</span>nodp<span class=\"token punctuation\">,</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">file</span> <span class=\"token operator\">*</span>filp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">binder_proc</span> <span class=\"token operator\">*</span>proc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">binder_device</span> <span class=\"token operator\">*</span>binder_dev<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token function\">binder_debug</span><span class=\"token punctuation\">(</span>BINDER_DEBUG_OPEN_CLOSE<span class=\"token punctuation\">,</span> <span class=\"token string\">\"%s: %d:%d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">__func__</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t     current<span class=\"token operator\">-></span>group_leader<span class=\"token operator\">-></span>pid<span class=\"token punctuation\">,</span> current<span class=\"token operator\">-></span>pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">// åˆ›å»º binder_proc ç»“æ„ä½“éå† procï¼Œå¹¶ä¸º proc å®ç°åˆå§‹åŒ–</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tproc <span class=\"token operator\">=</span> <span class=\"token function\">kzalloc</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>proc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> GFP_KERNEL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>proc <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token operator\">-</span>ENOMEM<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token function\">spin_lock_init</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>proc<span class=\"token operator\">-></span>inner_lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token function\">spin_lock_init</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>proc<span class=\"token operator\">-></span>outer_lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token function\">atomic_set</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>proc<span class=\"token operator\">-></span>tmp_ref<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token function\">get_task_struct</span><span class=\"token punctuation\">(</span>current<span class=\"token operator\">-></span>group_leader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\tä»»ä½•ä¸€ä¸ªè¿›ç¨‹ï¼Œå¦‚æœåªæœ‰ä¸»çº¿ç¨‹ï¼Œé‚£ pid æ˜¯è‡ªå·±ï¼Œtgid æ˜¯è‡ªå·±ï¼Œgroup_leader æŒ‡å‘çš„è¿˜æ˜¯è‡ªå·±ã€‚</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹åˆ›å»ºäº†å…¶ä»–çº¿ç¨‹ï¼Œé‚£å°±ä¼šæœ‰æ‰€å˜åŒ–äº†ã€‚çº¿ç¨‹æœ‰è‡ªå·±çš„ pidï¼Œtgid å°±æ˜¯è¿›ç¨‹çš„</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tä¸»çº¿ç¨‹çš„ pidï¼Œgroup_leader æŒ‡å‘çš„å°±æ˜¯è¿›ç¨‹çš„ä¸»çº¿ç¨‹ã€‚</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tæœ‰äº† tgid ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ¤æ–­ä¸€ä¸ª task æ˜¯çº¿ç¨‹è¿˜æ˜¯è¿›ç¨‹äº†ã€‚</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\tpid : æ¯ä¸ª task éƒ½æœ‰ä¸€ä¸ª pidï¼Œæ˜¯å”¯ä¸€çš„ï¼Œä¸ç®¡æ˜¯è¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹ã€‚</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\ttgid: æŒ‡å‘ä¸»çº¿ç¨‹çš„ pid</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t*/</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token comment\">//group_leader: æŒ‡å‘è¿›ç¨‹çš„ä¸»çº¿ç¨‹</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\tproc<span class=\"token operator\">-></span>tsk <span class=\"token operator\">=</span> current<span class=\"token operator\">-></span>group_leader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token function\">mutex_init</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>proc<span class=\"token operator\">-></span>files_lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token comment\">// åˆå§‹åŒ– todo é˜Ÿåˆ—</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token function\">INIT_LIST_HEAD</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>proc<span class=\"token operator\">-></span>todo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token comment\">// åˆå§‹åŒ–è¿›ç¨‹ä¼˜å…ˆçº§</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">binder_supported_policy</span><span class=\"token punctuation\">(</span>current<span class=\"token operator\">-></span>policy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\tproc<span class=\"token operator\">-></span>default_priority<span class=\"token punctuation\">.</span>sched_policy <span class=\"token operator\">=</span> current<span class=\"token operator\">-></span>policy<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\tproc<span class=\"token operator\">-></span>default_priority<span class=\"token punctuation\">.</span>prio <span class=\"token operator\">=</span> current<span class=\"token operator\">-></span>normal_prio<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\tproc<span class=\"token operator\">-></span>default_priority<span class=\"token punctuation\">.</span>sched_policy <span class=\"token operator\">=</span> SCHED_NORMAL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\tproc<span class=\"token operator\">-></span>default_priority<span class=\"token punctuation\">.</span>prio <span class=\"token operator\">=</span> <span class=\"token function\">NICE_TO_PRIO</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token comment\">// åˆå§‹åŒ– binder_dev,proc->context,proc->alloc</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tbinder_dev <span class=\"token operator\">=</span> <span class=\"token function\">container_of</span><span class=\"token punctuation\">(</span>filp<span class=\"token operator\">-></span>private_data<span class=\"token punctuation\">,</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">binder_device</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t\t  miscdev<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tproc<span class=\"token operator\">-></span>context <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>binder_dev<span class=\"token operator\">-></span>context<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token function\">binder_alloc_init</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>proc<span class=\"token operator\">-></span>alloc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token comment\">//binder_alloc åˆå§‹åŒ–</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token function\">binder_stats_created</span><span class=\"token punctuation\">(</span>BINDER_STAT_PROC<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\tproc<span class=\"token operator\">-></span>pid <span class=\"token operator\">=</span> current<span class=\"token operator\">-></span>group_leader<span class=\"token operator\">-></span>pid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token function\">INIT_LIST_HEAD</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>proc<span class=\"token operator\">-></span>delivered_death<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token function\">INIT_LIST_HEAD</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>proc<span class=\"token operator\">-></span>waiting_threads<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token comment\">// å°†åˆå§‹åŒ–å®Œæˆçš„ binder_proc ç»“æ„ä½“ proc ä¿å­˜åˆ° filp->private_data ä¸­</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token comment\">//filp æŒ‡å‘ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶ç»“æ„ä½“ï¼Œå®ƒå’Œè¿›ç¨‹è°ƒç”¨ open å‡½æ•°æ‰“å¼€è®¾å¤‡æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t<span class=\"token comment\">///dev/binder ä¹‹åå†…æ ¸è¿”å›ç»™è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦æ˜¯ç›¸äº’å…³è”çš„</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\tfilp<span class=\"token operator\">-></span>private_data <span class=\"token operator\">=</span> proc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token function\">mutex_lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>binder_procs_lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t<span class=\"token comment\">// å°† binder_proc ç»“æ„ä½“ proc åŠ å…¥åˆ°ä¸€ä¸ªå…¨å±€å“ˆå¸Œé˜Ÿåˆ— binder_procs ä¸­</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token comment\">//binder é€šè¿‡éå†è¿™ä¸ªå“ˆå¸Œé˜Ÿåˆ—å°±å¯ä»¥çŸ¥é“æœ‰å¤šå°‘è¿›ç¨‹åœ¨ä½¿ç”¨ binder</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t<span class=\"token function\">hlist_add_head</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>proc<span class=\"token operator\">-></span>proc_node<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>binder_procs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t<span class=\"token function\">mutex_unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>binder_procs_lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"binderè®¾å¤‡æ–‡ä»¶çš„å†…å­˜æ˜ å°„è¿‡ç¨‹\"><a class=\"anchor\" href=\"#binderè®¾å¤‡æ–‡ä»¶çš„å†…å­˜æ˜ å°„è¿‡ç¨‹\">#</a> Binder è®¾å¤‡æ–‡ä»¶çš„å†…å­˜æ˜ å°„è¿‡ç¨‹</h1>\n<p>åœ¨æ‰“å¼€äº†è®¾å¤‡æ–‡ä»¶ /dev/binder ä¹‹åï¼Œè¿˜éœ€è¦è°ƒç”¨ <code>mmap</code>  å‡½æ•°æ¥æŠŠè¿™ä¸ªè®¾å¤‡æ–‡ä»¶æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œæ­¤æ—¶ binder é©±åŠ¨ç¨‹åºä¸­çš„ <code>binder_mmap</code>  å‡½æ•°å°±ä¼šè¢«è°ƒç”¨ï¼Œä¸»è¦åŠŸèƒ½ï¼šåœ¨å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç”³è¯·ä¸€å—ä¸ç”¨æˆ·è™šæ‹Ÿå†…å­˜ç›¸åŒå¤§å°çš„å†…å­˜ï¼›ç„¶åå†ç”³è¯· 1 ä¸ª page å¤§å°çš„ç‰©ç†å†…å­˜ï¼Œå†å°†åŒä¸€å—ç‰©ç†å†…å­˜åˆ†åˆ«æ˜ å°„åˆ°å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´å’Œç”¨æˆ·è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œä»è€Œå®ç°äº†ç”¨æˆ·ç©ºé—´çš„ Buffer å’Œå†…æ ¸ç©ºé—´çš„ Buffer åŒæ­¥æ“ä½œçš„åŠŸèƒ½ã€‚</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//kernel\\drivers\\android\\binder.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token function\">binder_mmap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">file</span> <span class=\"token operator\">*</span>filp<span class=\"token punctuation\">,</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">vm_area_struct</span> <span class=\"token operator\">*</span>vma<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">int</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">binder_proc</span> <span class=\"token operator\">*</span>proc <span class=\"token operator\">=</span> filp<span class=\"token operator\">-></span>private_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>failure_string<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// ä¿è¯è¯·æ±‚åˆ†é…å†…å­˜çš„çº¿ç¨‹ä¸ºä¸»çº¿ç¨‹</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>proc<span class=\"token operator\">-></span>tsk <span class=\"token operator\">!=</span> current<span class=\"token operator\">-></span>group_leader<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token operator\">-</span>EINVAL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">// ä¿è¯æ˜ å°„å†…å­˜ &lt;= 4MB, è¯´æ˜ Binder æœ€å¤šèƒ½ä¸ºè¿›ç¨‹åˆ†é… 4MB çš„å†…æ ¸ç¼“å†²åŒºæ¥ä¼ è¾“æ•°æ®</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>vma<span class=\"token operator\">-></span>vm_end <span class=\"token operator\">-</span> vma<span class=\"token operator\">-></span>vm_start<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> SZ_4M<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tvma<span class=\"token operator\">-></span>vm_end <span class=\"token operator\">=</span> vma<span class=\"token operator\">-></span>vm_start <span class=\"token operator\">+</span> SZ_4M<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token function\">binder_debug</span><span class=\"token punctuation\">(</span>BINDER_DEBUG_OPEN_CLOSE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t     <span class=\"token string\">\"%s: %d %lx-%lx (%ld K) vma %lx pagep %lx\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t     <span class=\"token constant\">__func__</span><span class=\"token punctuation\">,</span> proc<span class=\"token operator\">-></span>pid<span class=\"token punctuation\">,</span> vma<span class=\"token operator\">-></span>vm_start<span class=\"token punctuation\">,</span> vma<span class=\"token operator\">-></span>vm_end<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t     <span class=\"token punctuation\">(</span>vma<span class=\"token operator\">-></span>vm_end <span class=\"token operator\">-</span> vma<span class=\"token operator\">-></span>vm_start<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> SZ_1K<span class=\"token punctuation\">,</span> vma<span class=\"token operator\">-></span>vm_flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t     <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token function\">pgprot_val</span><span class=\"token punctuation\">(</span>vma<span class=\"token operator\">-></span>vm_page_prot<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token comment\">//#define FORBIDDEN_MMAP_FLAGS (VM_WRITE)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token comment\">// æ£€æŸ¥è¿›ç¨‹è¦æ˜ å°„çš„åœ°å€ç©ºé—´æ˜¯å¦å¯å†™</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>vma<span class=\"token operator\">-></span>vm_flags <span class=\"token operator\">&amp;</span> FORBIDDEN_MMAP_FLAGS<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tret <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>EPERM<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\tfailure_string <span class=\"token operator\">=</span> <span class=\"token string\">\"bad vm_flags\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token keyword\">goto</span> err_bad_arg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token comment\">//VM_DONTCOPY\t/* Do not copy this vma on fork */</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token comment\">//VM_MIXEDMAP\t/* Can contain \"struct page\" and pure PFN pages */</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token comment\">// ç¦æ­¢æ‹·è´</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\tvma<span class=\"token operator\">-></span>vm_flags <span class=\"token operator\">|=</span> VM_DONTCOPY <span class=\"token operator\">|</span> VM_MIXEDMAP<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token comment\">// ä¸ºè¯¥å†…å­˜èµ‹äºˆ r-x æƒé™</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\tvma<span class=\"token operator\">-></span>vm_flags <span class=\"token operator\">&amp;=</span> <span class=\"token operator\">~</span>VM_MAYWRITE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tvma<span class=\"token operator\">-></span>vm_ops <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>binder_vm_ops<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\tvma<span class=\"token operator\">-></span>vm_private_data <span class=\"token operator\">=</span> proc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token comment\">// ä¸ºè¿›ç¨‹åˆ†é…å†…æ ¸ç¼“å†²åŒºï¼Œå¹¶å°†è¿™å—ç‰©ç†å†…å­˜åˆ†åˆ«æ˜ å°„åˆ°å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´å’Œç”¨æˆ·è™šæ‹Ÿå†…å­˜ç©ºé—´</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tret <span class=\"token operator\">=</span> <span class=\"token function\">binder_alloc_mmap_handler</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>proc<span class=\"token operator\">-></span>alloc<span class=\"token punctuation\">,</span> vma<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token function\">mutex_lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>proc<span class=\"token operator\">-></span>files_lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tproc<span class=\"token operator\">-></span>files <span class=\"token operator\">=</span> <span class=\"token function\">get_files_struct</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token function\">mutex_unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>proc<span class=\"token operator\">-></span>files_lock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>err_bad_arg<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token function\">pr_err</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s: %d %lx-%lx %s failed %d\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">__func__</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t       proc<span class=\"token operator\">-></span>pid<span class=\"token punctuation\">,</span> vma<span class=\"token operator\">-></span>vm_start<span class=\"token punctuation\">,</span> vma<span class=\"token operator\">-></span>vm_end<span class=\"token punctuation\">,</span> failure_string<span class=\"token punctuation\">,</span> ret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token keyword\">return</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>Binder é©±åŠ¨ç¨‹åºä¸ºè¿›ç¨‹åˆ†é…çš„å†…æ ¸ç¼“å†²åŒºå³ä¸ºä¸€ç³»åˆ—ç‰©ç†é¡µé¢ï¼Œä»–ä»¬åˆ†åˆ«è¢«æ˜ å°„åˆ°è¿›ç¨‹çš„ç”¨æˆ·åœ°å€ç©ºé—´å’Œå†…æ ¸åœ°å€ç©ºé—´ã€‚å½“ Binder é©±åŠ¨ç¨‹åºéœ€è¦å°†ä¸€å—æ•°æ®ä¼ è¾“ç»™ä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œå®ƒå¯ä»¥å…ˆæŠŠè¿™å—æ•°æ®ä¿å­˜åœ¨ä¸ºè¯¥è¿›ç¨‹åˆ†é…æ‰€åˆ†é…çš„ä¸€å—å†…æ ¸ç¼“å†²åŒºä¸­ï¼Œç„¶åå†æŠŠè¿™å—å†…æ ¸ç¼“å†²åŒºçš„ç”¨æˆ·ç©ºé—´åœ°å€å‘Šè¯‰è¿›ç¨‹ï¼Œæœ€åè¿›ç¨‹å°±å¯ä»¥è®¿é—®åˆ°é‡Œé¢çš„æ•°æ®äº†ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸éœ€è¦å°†å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä»è€Œæé«˜äº†æ•°æ®ä¼ è¾“çš„æ•ˆç‡.</p>\n<p><img data-src=\"/android-binder/binder_physical_memory.jpg\" alt=\"binder_physical_memory\" style=\"aspect-ratio:669 / 628;\"></p>\n<h1 id=\"binderè®¾å¤‡æ–‡ä»¶çš„ioctl\"><a class=\"anchor\" href=\"#binderè®¾å¤‡æ–‡ä»¶çš„ioctl\">#</a> binder è®¾å¤‡æ–‡ä»¶çš„ ioctl</h1>\n<p><code>binder_ioctl</code>  å‡½æ•°è´Ÿè´£åœ¨ä¸¤ä¸ªè¿›ç¨‹é—´æ”¶å‘ IPC æ•°æ®å’Œ IPC reply æ•°æ®ã€‚</p>\n<blockquote>\n<p>ioctl (input/output control) æ˜¯ä¸€ä¸ªä¸“ç”¨äºè®¾å¤‡è¾“å…¥è¾“å‡ºæ“ä½œçš„ç³»ç»Ÿè°ƒç”¨ï¼Œè¯¥è°ƒç”¨ä¼ å…¥ä¸€ä¸ªè·Ÿè®¾å¤‡æœ‰å…³çš„è¯·æ±‚ç ï¼Œç³»ç»Ÿè°ƒç”¨çš„åŠŸèƒ½å®Œå…¨å–å†³äºè¯·æ±‚ç ã€‚</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">ioctl å‘½ä»¤</th>\n<th style=\"text-align:left\">æ•°æ®ç±»å‹</th>\n<th style=\"text-align:left\">æ“ä½œ</th>\n<th>ä½¿ç”¨åœºæ™¯</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><strong>BINDER_WRITE_READ</strong></td>\n<td style=\"text-align:left\">struct binder_write_read</td>\n<td style=\"text-align:left\">æ”¶å‘ Binder IPC æ•°æ®</td>\n<td>Binder è¯»å†™äº¤äº’åœºæ™¯ï¼ŒIPC.talkWithDriver</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BINDER_SET_IDLE_TIMEOUT</td>\n<td style=\"text-align:left\">__s64</td>\n<td style=\"text-align:left\"></td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BINDER_SET_MAX_THREADS</td>\n<td style=\"text-align:left\">__u32</td>\n<td style=\"text-align:left\">è®¾ç½® Binder çº¿ç¨‹æœ€å¤§ä¸ªæ•°</td>\n<td>åˆå§‹åŒ– ProcessState å¯¹è±¡ï¼Œopen_driver () ; ä¸»åŠ¨è°ƒæ•´å‚æ•°ï¼ŒProcessState.setThreadPoolMaxThreadCount ()</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BINDER_SET_IDLE_PRIORITY</td>\n<td style=\"text-align:left\">__s32</td>\n<td style=\"text-align:left\"></td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BINDER_SET_CONTEXT_MGR</td>\n<td style=\"text-align:left\">__s32</td>\n<td style=\"text-align:left\">è®¾ç½® Service Manager èŠ‚ç‚¹</td>\n<td>servicemanager è¿›ç¨‹æˆä¸ºä¸Šä¸‹æ–‡ç®¡ç†è€…ï¼Œbinder_become_context_manager ()</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BINDER_THREAD_EXIT</td>\n<td style=\"text-align:left\">__s32</td>\n<td style=\"text-align:left\">é‡Šæ”¾ Binder çº¿ç¨‹</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BINDER_VERSION</td>\n<td style=\"text-align:left\">struct binder_version</td>\n<td style=\"text-align:left\">è·å– Binder ç‰ˆæœ¬ä¿¡æ¯</td>\n<td>åˆå§‹åŒ– ProcessState å¯¹è±¡ï¼Œopen_driver ()</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BINDER_GET_NODE_DEBUG_INFO</td>\n<td style=\"text-align:left\">struct binder_node_debug_info</td>\n<td style=\"text-align:left\"></td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BINDER_GET_NODE_INFO_FOR_REF</td>\n<td style=\"text-align:left\">struct binder_node_info_for_ref</td>\n<td style=\"text-align:left\"></td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BINDER_SET_CONTEXT_MGR_EXT</td>\n<td style=\"text-align:left\">struct flat_binder_object</td>\n<td style=\"text-align:left\"></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//kernel\\drivers\\android\\binder.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">long</span> <span class=\"token function\">binder_ioctl</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">file</span> <span class=\"token operator\">*</span>filp<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> cmd<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> arg<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">int</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">binder_proc</span> <span class=\"token operator\">*</span>proc <span class=\"token operator\">=</span> filp<span class=\"token operator\">-></span>private_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">binder_thread</span> <span class=\"token operator\">*</span>thread<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> size <span class=\"token operator\">=</span> <span class=\"token function\">_IOC_SIZE</span><span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">void</span> __user <span class=\"token operator\">*</span>ubuf <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> __user <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>arg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">/*pr_info(\"binder_ioctl: %d:%d %x %lx\\n\",</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\tproc->pid, current->pid, cmd, arg);*/</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token function\">binder_selftest_alloc</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>proc<span class=\"token operator\">-></span>alloc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token function\">trace_binder_ioctl</span><span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">,</span> arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\tret <span class=\"token operator\">=</span> <span class=\"token function\">wait_event_interruptible</span><span class=\"token punctuation\">(</span>binder_user_error_wait<span class=\"token punctuation\">,</span> binder_stop_on_user_error <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token keyword\">goto</span> err_unlocked<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\tthread <span class=\"token operator\">=</span> <span class=\"token function\">binder_get_thread</span><span class=\"token punctuation\">(</span>proc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>thread <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tret <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>ENOMEM<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token comment\">// è¿›è¡Œ binder çš„è¯»å†™æ“ä½œï¼Œè¿™ä¸ªå‘½ä»¤ä½¿ç”¨çš„æœ€ä¸ºé¢‘ç¹</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token keyword\">case</span> BINDER_WRITE_READ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\tret <span class=\"token operator\">=</span> <span class=\"token function\">binder_ioctl_write_read</span><span class=\"token punctuation\">(</span>filp<span class=\"token punctuation\">,</span> cmd<span class=\"token punctuation\">,</span> arg<span class=\"token punctuation\">,</span> thread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token comment\">// è®¾ç½® binder æœ€å¤§æ”¯æŒçš„çº¿ç¨‹æ•°</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token keyword\">case</span> BINDER_SET_MAX_THREADS<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token keyword\">int</span> max_threads<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">copy_from_user</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>max_threads<span class=\"token punctuation\">,</span> ubuf<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t\t\t   <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>max_threads<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\tret <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>EINVAL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token function\">binder_inner_proc_lock</span><span class=\"token punctuation\">(</span>proc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\tproc<span class=\"token operator\">-></span>max_threads <span class=\"token operator\">=</span> max_threads<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token function\">binder_inner_proc_unlock</span><span class=\"token punctuation\">(</span>proc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token keyword\">case</span> BINDER_SET_CONTEXT_MGR_EXT<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">flat_binder_object</span> fbo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">copy_from_user</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>fbo<span class=\"token punctuation\">,</span> ubuf<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>fbo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\tret <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>EINVAL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\tret <span class=\"token operator\">=</span> <span class=\"token function\">binder_ioctl_set_ctx_mgr</span><span class=\"token punctuation\">(</span>filp<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>fbo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token comment\">// æˆä¸º binder çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…ï¼Œä¹Ÿå°±æ˜¯ ServiceManager æˆä¸ºå®ˆæŠ¤è¿›ç¨‹</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t<span class=\"token keyword\">case</span> BINDER_SET_CONTEXT_MGR<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t\tret <span class=\"token operator\">=</span> <span class=\"token function\">binder_ioctl_set_ctx_mgr</span><span class=\"token punctuation\">(</span>filp<span class=\"token punctuation\">,</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t<span class=\"token comment\">// å½“ binder çº¿ç¨‹é€€å‡ºï¼Œé‡Šæ”¾ binder çº¿ç¨‹</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token keyword\">case</span> BINDER_THREAD_EXIT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\t<span class=\"token function\">binder_debug</span><span class=\"token punctuation\">(</span>BINDER_DEBUG_THREADS<span class=\"token punctuation\">,</span> <span class=\"token string\">\"%d:%d exit\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t\t     proc<span class=\"token operator\">-></span>pid<span class=\"token punctuation\">,</span> thread<span class=\"token operator\">-></span>pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t<span class=\"token function\">binder_thread_release</span><span class=\"token punctuation\">(</span>proc<span class=\"token punctuation\">,</span> thread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\tthread <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t<span class=\"token comment\">// è·å– binder çš„ç‰ˆæœ¬å·</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t<span class=\"token keyword\">case</span> BINDER_VERSION<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">binder_version</span> __user <span class=\"token operator\">*</span>ver <span class=\"token operator\">=</span> ubuf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>size <span class=\"token operator\">!=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">binder_version</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t\t\tret <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>EINVAL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">put_user</span><span class=\"token punctuation\">(</span>BINDER_CURRENT_PROTOCOL_VERSION<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t\t     <span class=\"token operator\">&amp;</span>ver<span class=\"token operator\">-></span>protocol_version<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t\tret <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>EINVAL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t<span class=\"token keyword\">case</span> BINDER_GET_NODE_INFO_FOR_REF<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">binder_node_info_for_ref</span> info<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">copy_from_user</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>info<span class=\"token punctuation\">,</span> ubuf<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t\tret <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>EFAULT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\tret <span class=\"token operator\">=</span> <span class=\"token function\">binder_ioctl_get_node_info_for_ref</span><span class=\"token punctuation\">(</span>proc<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>info<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">copy_to_user</span><span class=\"token punctuation\">(</span>ubuf<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>info<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t\tret <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>EFAULT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t<span class=\"token keyword\">case</span> BINDER_GET_NODE_DEBUG_INFO<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">binder_node_debug_info</span> info<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">copy_from_user</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>info<span class=\"token punctuation\">,</span> ubuf<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t\t\tret <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>EFAULT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t\tret <span class=\"token operator\">=</span> <span class=\"token function\">binder_ioctl_get_node_debug_info</span><span class=\"token punctuation\">(</span>proc<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>info<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">copy_to_user</span><span class=\"token punctuation\">(</span>ubuf<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>info<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\t\tret <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>EFAULT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t<span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t\tret <span class=\"token operator\">=</span> <span class=\"token operator\">-</span>EINVAL<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t\t<span class=\"token keyword\">goto</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\tret <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>err<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>thread<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t\tthread<span class=\"token operator\">-></span>looper_need_return <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t<span class=\"token function\">wait_event_interruptible</span><span class=\"token punctuation\">(</span>binder_user_error_wait<span class=\"token punctuation\">,</span> binder_stop_on_user_error <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret <span class=\"token operator\">&amp;&amp;</span> ret <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span>ERESTARTSYS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t\t<span class=\"token function\">pr_info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%d:%d ioctl %x %lx returned %d\\n\"</span><span class=\"token punctuation\">,</span> proc<span class=\"token operator\">-></span>pid<span class=\"token punctuation\">,</span> current<span class=\"token operator\">-></span>pid<span class=\"token punctuation\">,</span> cmd<span class=\"token punctuation\">,</span> arg<span class=\"token punctuation\">,</span> ret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>err_unlocked<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t<span class=\"token function\">trace_binder_ioctl_done</span><span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t<span class=\"token keyword\">return</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"binderå†…éƒ¨é€šä¿¡åè®®\"><a class=\"anchor\" href=\"#binderå†…éƒ¨é€šä¿¡åè®®\">#</a> Binder å†…éƒ¨é€šä¿¡åè®®</h1>\n<p>Client è¿›ç¨‹é€šè¿‡ RPC (Remote Procedure Call Protocol) ä¸ Server é€šä¿¡ï¼Œå¯ä»¥ç®€å•åœ°åˆ’åˆ†ä¸ºä¸‰å±‚ï¼Œåº”ç”¨å±‚ã€IPC å±‚ã€å†…æ ¸é©±åŠ¨å±‚ã€‚ <code>demo()</code>  æ˜¯ Client ç«¯å’Œ Server å…±åŒåå•†å¥½çš„ç»Ÿä¸€æ–¹æ³•ï¼›handleã€RPC æ•°æ®ã€ä»£ç ã€åè®®è¿™ 4 é¡¹ç»„æˆäº† IPC å±‚çš„æ•°æ®ï¼Œé€šè¿‡ IPC å±‚è¿›è¡Œæ•°æ®ä¼ è¾“ï¼›è€ŒçœŸæ­£åœ¨ Client å’Œ Server ä¸¤ç«¯å»ºç«‹é€šä¿¡çš„åŸºç¡€è®¾æ–½ä¾¿æ˜¯ Binder Driverã€‚</p>\n<p><img data-src=\"/android-binder/binder_ipc.jpg\" alt=\"binder_ipc\" style=\"aspect-ratio:793 / 444;\"></p>\n<h2 id=\"é€šä¿¡æ¨¡å‹\"><a class=\"anchor\" href=\"#é€šä¿¡æ¨¡å‹\">#</a> é€šä¿¡æ¨¡å‹</h2>\n<p>ä¸€æ¬¡å®Œæ•´çš„ Binder é€šä¿¡è¿‡ç¨‹å¦‚ä¸‹</p>\n<p><img data-src=\"/android-binder/binder_transaction_ipc.jpg\" alt=\"binder_protocol\" style=\"aspect-ratio:955 / 694;\"></p>\n<p>Binder åè®®åŒ…å«åœ¨ IPC æ•°æ®ä¸­ï¼Œåˆ†ä¸ºä¸¤ç±»:</p>\n<ul>\n<li>\n<p><code>BINDER_COMMAND_PROTOCOL</code> ï¼šbinder è¯·æ±‚ç ï¼Œä»¥â€BC_â€œå¼€å¤´ï¼Œç®€ç§° BC ç ï¼Œç”¨äºä» IPC å±‚ä¼ é€’åˆ° Binder Driver å±‚ï¼›</p>\n</li>\n<li>\n<p><code>BINDER_RETURN_PROTOCOL</code>  ï¼šbinder å“åº”ç ï¼Œä»¥â€BR_â€œå¼€å¤´ï¼Œç®€ç§° BR ç ï¼Œç”¨äºä» Binder Driver å±‚ä¼ é€’åˆ° IPC å±‚ï¼›</p>\n</li>\n</ul>\n<p>Binder IPC é€šä¿¡è‡³å°‘æ˜¯ä¸¤ä¸ªè¿›ç¨‹çš„äº¤äº’ï¼š</p>\n<ul>\n<li>client è¿›ç¨‹æ‰§è¡Œ binder_thread_writeï¼Œæ ¹æ® BC_XXX å‘½ä»¤ï¼Œç”Ÿæˆç›¸åº”çš„ binder_workï¼›</li>\n<li>server è¿›ç¨‹æ‰§è¡Œ binder_thread_readï¼Œæ ¹æ® binder_work.type ç±»å‹ï¼Œç”Ÿæˆ BR_XXXï¼Œå‘é€åˆ°ç”¨æˆ·ç©ºé—´å¤„ç†ã€‚</li>\n</ul>\n<h2 id=\"é€šä¿¡è¿‡ç¨‹\"><a class=\"anchor\" href=\"#é€šä¿¡è¿‡ç¨‹\">#</a> é€šä¿¡è¿‡ç¨‹</h2>\n<p>ä¸€æ¬¡ Client å‘ Server é€šä¿¡çš„è¿‡ç¨‹å¦‚å›¾æ‰€ç¤º</p>\n<p><img data-src=\"/android-binder/binder_protocol.jpg\" alt=\"binder_protocol\" style=\"aspect-ratio:1269 / 500;\"></p>\n<h3 id=\"bc_protocol\"><a class=\"anchor\" href=\"#bc_protocol\">#</a> BC_PROTOCOL</h3>\n<p>binder è¯·æ±‚ç ï¼Œæ˜¯ç”¨ <code>enum binder_driver_command_protocol</code>  æ¥å®šä¹‰çš„ï¼Œæ˜¯ç”¨äºåº”ç”¨ç¨‹åºå‘ binder é©±åŠ¨è®¾å¤‡å‘é€è¯·æ±‚æ¶ˆæ¯</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">è¯·æ±‚ç </th>\n<th style=\"text-align:left\">å‚æ•°ç±»å‹</th>\n<th style=\"text-align:left\">ä½œç”¨</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">BC_TRANSACTION</td>\n<td style=\"text-align:left\">binder_transaction_data</td>\n<td style=\"text-align:left\">Client å‘ Binder é©±åŠ¨å‘é€è¯·æ±‚æ•°æ®</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_REPLY</td>\n<td style=\"text-align:left\">binder_transaction_data</td>\n<td style=\"text-align:left\">Server å‘ Binder é©±åŠ¨å‘é€è¯·æ±‚æ•°æ®</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_FREE_BUFFER</td>\n<td style=\"text-align:left\">binder_uintptr_t (æŒ‡é’ˆ)</td>\n<td style=\"text-align:left\">é‡Šæ”¾å†…å­˜</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_INCREFS</td>\n<td style=\"text-align:left\">__u32(descriptor)</td>\n<td style=\"text-align:left\">binder_ref å¼±å¼•ç”¨åŠ  1 æ“ä½œ</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_DECREFS</td>\n<td style=\"text-align:left\">__u32(descriptor)</td>\n<td style=\"text-align:left\">binder_ref å¼±å¼•ç”¨å‡ 1 æ“ä½œ</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_ACQUIRE</td>\n<td style=\"text-align:left\">__u32(descriptor)</td>\n<td style=\"text-align:left\">binder_ref å¼ºå¼•ç”¨åŠ  1 æ“ä½œ</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_RELEASE</td>\n<td style=\"text-align:left\">__u32(descriptor)</td>\n<td style=\"text-align:left\">binder_ref å¼ºå¼•ç”¨å‡ 1 æ“ä½œ</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_ACQUIRE_DONE</td>\n<td style=\"text-align:left\">binder_ptr_cookie</td>\n<td style=\"text-align:left\">binder_node å¼ºå¼•ç”¨å‡ 1 æ“ä½œ</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_INCREFS_DONE</td>\n<td style=\"text-align:left\">binder_ptr_cookie</td>\n<td style=\"text-align:left\">binder_node å¼±å¼•ç”¨å‡ 1 æ“ä½œ</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_REGISTER_LOOPER</td>\n<td style=\"text-align:left\">æ— å‚æ•°</td>\n<td style=\"text-align:left\">åˆ›å»ºæ–°çš„ looper çº¿ç¨‹</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_ENTER_LOOPER</td>\n<td style=\"text-align:left\">æ— å‚æ•°</td>\n<td style=\"text-align:left\">åº”ç”¨çº¿ç¨‹è¿›å…¥ looper</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_EXIT_LOOPER</td>\n<td style=\"text-align:left\">æ— å‚æ•°</td>\n<td style=\"text-align:left\">åº”ç”¨çº¿ç¨‹é€€å‡º looper</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_REQUEST_DEATH_NOTIFICATION</td>\n<td style=\"text-align:left\">binder_handle_cookie</td>\n<td style=\"text-align:left\">æ³¨å†Œæ­»äº¡é€šçŸ¥</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_CLEAR_DEATH_NOTIFICATION</td>\n<td style=\"text-align:left\">binder_handle_cookie</td>\n<td style=\"text-align:left\">å–æ¶ˆæ³¨å†Œçš„æ­»äº¡é€šçŸ¥</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_DEAD_BINDER_DONE</td>\n<td style=\"text-align:left\">binder_uintptr_t (æŒ‡é’ˆ)</td>\n<td style=\"text-align:left\">å·²å®Œæˆ binder çš„æ­»äº¡é€šçŸ¥</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_ACQUIRE_RESULT</td>\n<td style=\"text-align:left\">-</td>\n<td style=\"text-align:left\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BC_ATTEMPT_ACQUIRE</td>\n<td style=\"text-align:left\">-</td>\n<td style=\"text-align:left\">-</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>å½“ä¸€ä¸ªè¿›ç¨‹è¯·æ±‚å¦å¤–ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œä¸€ä¸ªæ“ä½œæ—¶ï¼Œæºè¿›ç¨‹å°±ä½¿ç”¨ <code>BC_TRANSACTION</code>  æ¥è¯·æ±‚ Binder é©±åŠ¨è¿›ç¨‹å°†é€šä¿¡æ•°æ®ä¼ é€’åˆ°ç›®æ ‡è¿›ç¨‹</li>\n<li>å½“ç›®æ ‡è¿›ç¨‹å¤„ç†å®Œæˆæºè¿›ç¨‹æ‰€è¯·æ±‚çš„æ“ä½œä¹‹åï¼Œå®ƒå°±ä½¿ç”¨ <code>BC_REPLY</code>  æ¥è¯·æ±‚ Binder é©±åŠ¨è¿›ç¨‹å°†ç»“æœæ•°æ®ä¼ é€’ç»™æºè¿›ç¨‹</li>\n<li><code>BC_FREE_BUFFER</code>  åé¢è·Ÿçš„é€šä¿¡æ•°æ®æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œå®ƒæŒ‡å‘äº†åœ¨ Binder é©±åŠ¨è¿›ç¨‹å†…éƒ¨æ‰€åˆ†é…çš„ä¸€å—å†…æ ¸ç¼“å†²åŒº.Binder é©±åŠ¨ç¨‹åºå°±æ˜¯é€šè¿‡è¿™ä¸ªå†…æ ¸ç¼“å†²åŒºå°†æºè¿›ç¨‹çš„é€šä¿¡æ•°æ®ä¼ é€’åˆ°ç›®æ ‡è¿›ç¨‹çš„ã€‚å½“ç›®æ ‡è¿›ç¨‹å¤„ç†å®Œæˆæºè¿›ç¨‹çš„é€šä¿¡è¯·æ±‚ä¹‹åï¼Œå®ƒä¼šä½¿ç”¨ <code>BC_FREE_BUFFER</code>  æ¥é€šçŸ¥ Binder é©±åŠ¨ç¨‹åºé‡Šæ”¾è¿™ä¸ªå†…æ ¸ç¼“å†²åŒº</li>\n<li>å½“ä¸€ä¸ªçº¿ç¨‹å°†è‡ªå·±æ³¨å†Œåˆ° Binder é©±åŠ¨ç¨‹åºä¹‹åï¼Œå®ƒä¼šä½¿ç”¨ <code>BC_ENTER_LOOPER</code>  æ¥é€šçŸ¥ Binder é©±åŠ¨ç¨‹åºï¼Œå®ƒå·²ç»å‡†å¤‡å°±ç»ªå¤„ç†è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚äº†</li>\n<li>å½“ Binder é©±åŠ¨ç¨‹åºä¸»åŠ¨è¯·æ±‚è¿›ç¨‹æ³¨å†Œä¸€ä¸ªæ–°çš„çº¿ç¨‹åˆ°å®ƒçš„ Binder çº¿ç¨‹æ± ä¸­æ¥å¤„ç†è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚ä¹‹åï¼Œæ–°åˆ›å»ºçš„çº¿ç¨‹å°±ä¼šä½¿ç”¨ <code>BC_REGISTER_LOOPER</code>  æ¥é€šçŸ¥ Binder é©±åŠ¨ç¨‹åºï¼Œå®ƒå‡†å¤‡å°±ç»ªäº†</li>\n<li>å½“ä¸€ä¸ªçº¿ç¨‹è¦é€€å‡ºæ—¶ï¼Œå®ƒä½¿ç”¨ <code>BC_EXIT_LOOPER</code>  ä» Binder é©±åŠ¨ç¨‹åºä¸­æ³¨é”€ï¼Œè¿™æ ·ä»–å°±ä¸ä¼šå†æ¥æ”¶åˆ°è¿›ç¨‹é—´é€šä¿¡è¯·æ±‚äº†</li>\n<li>å¦‚æœä¸€ä¸ªè¿›ç¨‹å¸Œæœ›è·å¾—å®ƒæ‰€å¼•ç”¨çš„ Service ç»„ä»¶çš„æ­»äº¡æ¥æ”¶é€šçŸ¥ï¼Œé‚£ä¹ˆå®ƒéœ€è¦ä½¿ç”¨ <code>BC_REQUEST_DEATH_NOTIFICATION</code>  æ¥å‘ Binder é©±åŠ¨ç¨‹åºæ³¨å†Œä¸€ä¸ªæ­»äº¡æ¥æ”¶é€šçŸ¥</li>\n<li>å¦‚æœä¸€ä¸ªè¿›ç¨‹å¸Œæœ›æ³¨é”€ä¹‹å‰æ‰€æ³¨å†Œçš„ä¸€ä¸ªæ­»äº¡æ¥æ”¶é€šçŸ¥ï¼Œé‚£ä¹ˆå®ƒéœ€è¦ä½¿ç”¨ <code>BC_CLEAR_DEATH_NOTIFICATION</code>  æ¥å‘ Binder é©±åŠ¨ç¨‹åºå‘å‡ºè¯·æ±‚</li>\n<li>å½“ä¸€ä¸ªè¿›ç¨‹è·å¾—ä¸€ä¸ª Service ç»„ä»¶çš„æ­»äº¡é€šçŸ¥æ—¶ï¼Œå®ƒä¼šä½¿ç”¨ <code>BC_DEAD_BINDER_DONE</code>  æ¥é€šçŸ¥ Binder é©±åŠ¨ç¨‹åºï¼Œå®ƒå·²ç»å¤„ç†å®Œæˆè¯¥ Service ç»„ä»¶çš„æ­»äº¡é€šçŸ¥äº†</li>\n</ul>\n<h3 id=\"binder_work\"><a class=\"anchor\" href=\"#binder_work\">#</a> binder_work</h3>\n<p>ç»“æ„ä½“ <code>binder_work</code>  ç”¨æ¥æè¿°å¾…å¤„ç†çš„å·¥ä½œé¡¹ï¼Œ <code>binder_work.entry</code>  ç”¨æ¥å°†ç»“æ„ä½“åµŒå…¥åˆ°ä¸€ä¸ªå®¿ä¸»ç»“æ„ä¸­ï¼Œé€šè¿‡ <code>binder_work.type</code>  çš„å–å€¼ï¼ŒBinder å°±å¯ä»¥åˆ¤æ–­å‡ºä¸€ä¸ª <code>binder_work</code>  ç»“æ„ä½“åµŒå…¥åˆ°ä»€ä¹ˆç±»å‹çš„å®¿ä¸»ç»“æ„ä¸­</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">binder_work</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">list_head</span> entry<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">enum</span> <span class=\"token class-name\">binder_work_type</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\tBINDER_WORK_TRANSACTION <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// æœ€å¸¸è§</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tBINDER_WORK_TRANSACTION_COMPLETE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\tBINDER_WORK_RETURN_ERROR<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tBINDER_WORK_NODE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\tBINDER_WORK_DEAD_BINDER<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\tBINDER_WORK_DEAD_BINDER_AND_CLEAR<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\tBINDER_WORK_CLEAR_DEATH_NOTIFICATION<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span> type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><table>\n<thead>\n<tr>\n<th>binder_work ç±»å‹</th>\n<th>è§¦å‘æ—¶æœº</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>BINDER_WORK_TRANSACTION</td>\n<td><code>binder_transaction()</code> ; <code>binder_release_work()</code>  è¢«è°ƒç”¨</td>\n</tr>\n<tr>\n<td>BINDER_WORK_TRANSACTION_COMPLETE</td>\n<td><code>binder_transaction()</code> ; <code>binder_release_work()</code>  è¢«è°ƒç”¨</td>\n</tr>\n<tr>\n<td>BINDER_WORK_NODE</td>\n<td><code>binder_new_node()</code>  è¢«è°ƒç”¨</td>\n</tr>\n<tr>\n<td>BINDER_WORK_DEAD_BINDER</td>\n<td><code>binder_thread_write()</code>  æ”¶åˆ° <code>BC_REQUEST_DEATH_NOTIFICATION</code></td>\n</tr>\n<tr>\n<td>BINDER_WORK_DEAD_BINDER_AND_CLEAR</td>\n<td><code>binder_thread_write()</code>  æ”¶åˆ° <code>BC_CLEAR_DEATH_NOTIFICATION</code></td>\n</tr>\n<tr>\n<td>BINDER_WORK_CLEAR_DEATH_NOTIFICATION</td>\n<td><code>binder_thread_write()</code>  æ”¶åˆ° <code>BC_CLEAR_DEATH_NOTIFICATION</code>  å’Œ <code>BC_DEAD_BINDER_DONE</code></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"br_protocol\"><a class=\"anchor\" href=\"#br_protocol\">#</a> BR_PROTOCOL</h3>\n<p>binder å“åº”ç ï¼Œæ˜¯ç”¨ <code>enum binder_driver_return_protocol</code>  æ¥å®šä¹‰çš„ï¼Œæ˜¯ binder è®¾å¤‡å‘åº”ç”¨ç¨‹åºå›å¤çš„æ¶ˆæ¯</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">å“åº”ç </th>\n<th style=\"text-align:left\">å‚æ•°ç±»å‹</th>\n<th style=\"text-align:left\">ä½œç”¨</th>\n<th>è§¦å‘æ—¶æœº</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">BR_ERROR</td>\n<td style=\"text-align:left\">__s32</td>\n<td style=\"text-align:left\">æ“ä½œå‘ç”Ÿé”™è¯¯</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_OK</td>\n<td style=\"text-align:left\">æ— å‚æ•°</td>\n<td style=\"text-align:left\">æ“ä½œå®Œæˆ</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_NOOP</td>\n<td style=\"text-align:left\">æ— å‚æ•°</td>\n<td style=\"text-align:left\">ä¸åšä»»ä½•äº‹</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_SPAWN_LOOPER</td>\n<td style=\"text-align:left\">æ— å‚æ•°</td>\n<td style=\"text-align:left\">åˆ›å»ºæ–°çš„ Looper çº¿ç¨‹</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_TRANSACTION</td>\n<td style=\"text-align:left\">binder_transaction_data</td>\n<td style=\"text-align:left\">Binder é©±åŠ¨å‘ Server ç«¯å‘é€è¯·æ±‚æ•°æ®</td>\n<td>æ”¶åˆ° BINDER_WORK_TRANSACTION</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_REPLY</td>\n<td style=\"text-align:left\">binder_transaction_data</td>\n<td style=\"text-align:left\">Binder é©±åŠ¨å‘ Client ç«¯å‘é€å›å¤æ•°æ®</td>\n<td>æ”¶åˆ° BINDER_WORK_TRANSACTION</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_TRANSACTION_COMPLETE</td>\n<td style=\"text-align:left\">æ— å‚æ•°</td>\n<td style=\"text-align:left\">å¯¹è¯·æ±‚å‘é€çš„æˆåŠŸåé¦ˆ</td>\n<td>æ”¶åˆ° BINDER_WORK_TRANSACTION_COMPLETE</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_DEAD_REPLY</td>\n<td style=\"text-align:left\">æ— å‚æ•°</td>\n<td style=\"text-align:left\">å›å¤å¤±è´¥ï¼Œå¾€å¾€æ˜¯çº¿ç¨‹æˆ–èŠ‚ç‚¹ä¸ºç©º</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_FAILED_REPLY</td>\n<td style=\"text-align:left\">æ— å‚æ•°</td>\n<td style=\"text-align:left\">å›å¤å¤±è´¥ï¼Œå¾€å¾€æ˜¯ transaction å‡ºé”™å¯¼è‡´</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_INCREFS</td>\n<td style=\"text-align:left\">binder_ptr_cookie</td>\n<td style=\"text-align:left\">binder_ref å¼±å¼•ç”¨åŠ  1 æ“ä½œï¼ˆServer ç«¯ï¼‰</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_DECREFS</td>\n<td style=\"text-align:left\">binder_ptr_cookie</td>\n<td style=\"text-align:left\">binder_ref å¼±å¼•ç”¨å‡ 1 æ“ä½œï¼ˆServer ç«¯ï¼‰</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_ACQUIRE</td>\n<td style=\"text-align:left\">binder_ptr_cookie</td>\n<td style=\"text-align:left\">binder_ref å¼ºå¼•ç”¨åŠ  1 æ“ä½œï¼ˆServer ç«¯ï¼‰</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_RELEASE</td>\n<td style=\"text-align:left\">binder_ptr_cookie</td>\n<td style=\"text-align:left\">binder_ref å¼ºå¼•ç”¨å‡ 1 æ“ä½œï¼ˆServer ç«¯ï¼‰</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_DEAD_BINDER</td>\n<td style=\"text-align:left\">binder_uintptr_t (æŒ‡é’ˆ)</td>\n<td style=\"text-align:left\">Binder é©±åŠ¨å‘ client ç«¯å‘é€æ­»äº¡é€šçŸ¥</td>\n<td>æ”¶åˆ° BINDER_WORK_DEAD_BINDER æˆ– BINDER_WORK_DEAD_BINDER_AND_CLEAR</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_CLEAR_DEATH_NOTIFICATION_DONE</td>\n<td style=\"text-align:left\">binder_uintptr_t (æŒ‡é’ˆ)</td>\n<td style=\"text-align:left\">BC_CLEAR_DEATH_NOTIFICATION å‘½ä»¤å¯¹åº”çš„å“åº”ç </td>\n<td>æ”¶åˆ° BINDER_WORK_CLEAR_DEATH_NOTIFICATION</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_ACQUIRE_RESULT</td>\n<td style=\"text-align:left\">-</td>\n<td style=\"text-align:left\">-</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_ATTEMPT_ACQUIRE</td>\n<td style=\"text-align:left\">-</td>\n<td style=\"text-align:left\">-</td>\n<td></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">BR_FINISHED</td>\n<td style=\"text-align:left\">-</td>\n<td style=\"text-align:left\">-</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"åè®®è½¬æ¢å›¾\"><a class=\"anchor\" href=\"#åè®®è½¬æ¢å›¾\">#</a> åè®®è½¬æ¢å›¾</h3>\n<blockquote>\n<p>BINDER_WORK_xxx â€“&gt; BW_xxx</p>\n</blockquote>\n<p>å›¾è§£ï¼š(ä»¥ BC_TRANSACTION ä¸ºä¾‹)</p>\n<ul>\n<li>å‘èµ·ç«¯è¿›ç¨‹ï¼šbinder_transaction () è¿‡ç¨‹å°† BC_TRANSACTION è½¬æ¢ä¸º BW_TRANSACTIONï¼›</li>\n<li>æ¥æ”¶ç«¯è¿›ç¨‹ï¼šbinder_thread_read () è¿‡ç¨‹ï¼Œå°† BW_TRANSACTION è½¬æ¢ä¸º BR_TRANSACTION;</li>\n<li>æ¥æ”¶ç«¯è¿›ç¨‹ï¼šIPC.executeCommand () è¿‡ç¨‹ï¼Œå¤„ç† BR_TRANSACTION å‘½ä»¤ã€‚</li>\n</ul>\n<p><img data-src=\"/android-binder/protocol_transaction.jpg\" alt=\"protocol_transaction.jpg\" style=\"aspect-ratio:1062 / 550;\"></p>\n<p><img data-src=\"/android-binder/protocol_binder_dead.jpg\" alt=\"protocol_binder_dead.jpg\" style=\"aspect-ratio:1087 / 538;\"></p>\n<h1 id=\"servicemanagerä»‹ç»\"><a class=\"anchor\" href=\"#servicemanagerä»‹ç»\">#</a> ServiceManager ä»‹ç»</h1>\n<p>æˆ‘ä»¬çŸ¥é“åœ¨ Android ç³»ç»Ÿä¸­ï¼Œå„ä¸ªè¿›ç¨‹ä¹‹é—´éƒ½æ˜¯éš”ç¦»çš„ï¼Œå‡å¦‚ Clinet æƒ³å’Œ Server é€šä¿¡ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•æ‰¾åˆ° Server å‘¢ï¼Ÿè¿™å°±éœ€è¦ä¾é  ServiceManager äº†</p>\n<p>ServiceManager æ˜¯ Android è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ Binder çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒæ‰®æ¼”ç€ Binder è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ä¸Šä¸‹æ–‡ç®¡ç†è€… (context Manager) çš„è§’è‰²ï¼ŒåŒæ—¶è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„ Service ç»„ä»¶ï¼Œå‘ Client ç»„ä»¶æä¾›è·å– Service ä»£ç†å¯¹è±¡çš„æœåŠ¡</p>\n<p><img data-src=\"/android-binder/IPC-Binder.jpg\" alt=\"ServiceManager\" style=\"aspect-ratio:921 / 448;\"></p>\n<p>æˆ‘ä»¬å¯ä»¥å°† binder è·¨è¿›ç¨‹é€šä¿¡å’Œ socket ç½‘ç»œé€šä¿¡ç±»æ¯”ï¼Œåœ¨ç½‘ç»œé€šä¿¡ä¸­ï¼Œå®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œä½†æ˜¯çŸ¥é“æœåŠ¡å™¨çš„åŸŸåï¼Œç°åœ¨å®¢æˆ·ç«¯æƒ³è¦å’ŒæœåŠ¡å™¨å»ºç«‹ socket è¿æ¥ï¼Œé‚£ä¹ˆé€šä¿¡çš„ç¬¬ä¸€æ­¥å°±æ˜¯é€šè¿‡ DNS æœåŠ¡å™¨å°†åŸŸåè§£æä¸º IP åœ°å€ç„¶åå±‚å±‚è·¯ç”±ï¼Œè¿™æ ·å®¢æˆ·ç«¯å°±å¯ä»¥å’ŒæœåŠ¡å™¨å»ºç«‹ç½‘ç»œè¿æ¥äº†ã€‚binder è·¨è¿›ç¨‹é€šä¿¡ä¹Ÿä¸ä¾‹å¤–ï¼ŒServiceManager å°±ç›¸å½“äºæ˜¯ socket ç½‘ç»œé€šä¿¡ä¸­çš„ DNS æœåŠ¡å™¨ï¼Œå€˜è‹¥ Server å¸Œæœ›æœ‰äººèƒ½å¤Ÿå’Œå®ƒé€šä¿¡ï¼Œé‚£ä¹ˆ Server å°±å…ˆå‰å¾€ Service Manager é‚£é‡Œ â€œå¤‡æ¡ˆâ€ ä¸€ä¸‹ï¼ˆ<strong>1. æ³¨å†ŒæœåŠ¡</strong>ï¼‰ï¼Œè¿‡äº†ä¸ä¹…ï¼ŒClient æƒ³è¦å’Œ Server å»é€šä¿¡äº†ï¼Œå®ƒå°±å»è¯¢é—® Service Managerï¼šâ€œServer åœ¨ä»€ä¹ˆåœ°æ–¹å‘€ï¼Œæˆ‘è¦æ€ä¹ˆå’Œå®ƒé€šä¿¡å‘€â€ï¼ˆ<strong>2. è·å–æœåŠ¡</strong>ï¼‰ï¼Œç„¶å Service Manager å°±å‘Šè¯‰ Client é€šä¿¡çš„æ–¹æ³•ï¼Œè¿™æ · Clinet å’Œ Server å°±å¯ä»¥æ„‰å¿«çš„é€šä¿¡äº†ï½ï¼ˆ<strong>3. ä½¿ç”¨æœåŠ¡</strong>ï¼‰</p>\n<h1 id=\"servicemanagerçš„å¯åŠ¨è¿‡ç¨‹\"><a class=\"anchor\" href=\"#servicemanagerçš„å¯åŠ¨è¿‡ç¨‹\">#</a> ServiceManager çš„å¯åŠ¨è¿‡ç¨‹</h1>\n<p>ServiceManager æ˜¯ç”± init è¿›ç¨‹é€šè¿‡è§£æ init.rc æ–‡ä»¶åˆ›å»ºçš„</p>\n<pre><code class=\"language-rc\"># platform\\system\\core\\rootdir\\init.rc\non init\n\t...\n\t# Start essential services.\n    start servicemanager\n</code></pre>\n<p>å…·ä½“çš„æœåŠ¡å£°æ˜åœ¨ <code>platform\\frameworks\\native\\cmds\\servicemanager\\servicemanager.rc</code></p>\n<pre><code class=\"language-rc\"># platform\\frameworks\\native\\cmds\\servicemanager\\servicemanager.rc\nservice servicemanager /system/bin/servicemanager\n    class core animation# æŒ‡å®šäº†æœåŠ¡çš„ç±»åˆ«ä¸ºcoreå’Œanimation\n    user system# æŒ‡å®šäº†æœåŠ¡ç”¨æˆ·ä¸ºsystem,è¡¨ç¤ºè¯¥æœåŠ¡å°†ä»¥ç³»ç»Ÿç”¨æˆ·çš„æƒé™æ¥è¿è¡Œ\n    group system readproc# æŒ‡å®šäº†æœåŠ¡çš„ç”¨æˆ·ç»„ä¸ºsystem,å¹¶å…·æœ‰ readproc æƒé™\n    critical# æ ‡å¿—è¯¥æœåŠ¡ä¸ºå…³é”®æœåŠ¡ï¼Œè¿™è¡¨ç¤ºå®ƒæ˜¯ç³»ç»Ÿå¯åŠ¨çš„ä¸€éƒ¨åˆ†ï¼Œå¿…é¡»ä¼˜å…ˆå¯åŠ¨\n\n    # è¦æ±‚åœ¨servicemanageré‡æ–°å¯åŠ¨æ—¶é‡å¯\n    # apexdæœåŠ¡, audioserveræœåŠ¡, gatekeeperdæœåŠ¡\n    # mainç±»åˆ«çš„æœåŠ¡, halç±»åˆ«çš„æœåŠ¡, early_halç±»åˆ«çš„æœåŠ¡\n    onrestart restart apexd\n    onrestart restart audioserver\n    onrestart restart gatekeeperd\n    onrestart class_restart main\n    onrestart class_restart hal\n    onrestart class_restart early_hal\n\n    # å°† servicemanager çš„è¿›ç¨‹ ID å†™å…¥\n    # /dev/cpuset/system-background/tasksæ–‡ä»¶ï¼Œè¿™å¯ç”¨äºCPUé›†åˆç®¡ç†\n    writepid /dev/cpuset/system-background/tasks\n\n    # å£°æ˜è¯¥æœåŠ¡ä¸ºå…³é”®æœåŠ¡ï¼Œåœ¨ç³»ç»Ÿå…³é—­æ—¶ï¼Œè¿™ä¸ªæœåŠ¡å°†è¢«ä¼˜å…ˆå…³é—­\n    shutdown critical\n</code></pre>\n<p><code>Service Manager</code>  çš„å…¥å£å‡½æ•°æ˜¯ <code>main.cpp</code>  ä¸­çš„ <code>main()</code> , å®ƒçš„å¯åŠ¨è¿‡ç¨‹ç”±ä»¥ä¸‹å››ä¸ªæ­¥éª¤ç»„æˆ</p>\n<ol>\n<li>è°ƒç”¨ <code>ProcessState::initWithDriver</code>  æ‰“å¼€å¹¶æ˜ å°„ binder é©±åŠ¨è®¾å¤‡</li>\n<li>å°†è‡ªèº«ä½œä¸ºæœåŠ¡ (æœåŠ¡åç§°: <code>manager</code> ) æ³¨å†Œåˆ° ServiceManager ä¸­</li>\n<li>è°ƒç”¨ <code>ps-&gt;becomeContextManager();</code>  æˆä¸º binder è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…</li>\n<li>ä½¿ç”¨ <code>looper</code>  æ— é™å¾ªç¯é˜»å¡å¤„ç†äº‹ä»¶</li>\n</ol>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\cmds\\servicemanager\\main.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>argc <span class=\"token operator\">></span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function\">LOG</span><span class=\"token punctuation\">(</span>FATAL<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"usage: \"</span> <span class=\"token operator\">&lt;&lt;</span> argv<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" [binder driver]\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// æŒ‡å®š driver çš„åç§°ï¼Œå¦‚æœæ— å‚æ•°ï¼Œåˆ™ä½¿ç”¨é»˜è®¤é©±åŠ¨ /dev/binder</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> driver <span class=\"token operator\">=</span> argc <span class=\"token operator\">==</span> <span class=\"token number\">2</span> <span class=\"token operator\">?</span> argv<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"/dev/binder\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\tæ¯ä¸€ä¸ªè¿›ç¨‹åªèƒ½æœ‰ä¸€ä¸ª ProcessState å¯¹è±¡ï¼Œservice manager é€šè¿‡ initWithDriver æ–¹æ³•</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tå®ä¾‹åŒ–äº†ä¸€ä¸ª ProcessState å¯¹è±¡ï¼Œå¹¶æ‰“å¼€ binder è®¾å¤‡å’Œè¿›è¡Œ mmap å†…å­˜æ˜ å°„ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tå°†ä¼šåŒæ—¶è°ƒç”¨ binder è®¾å¤‡å†…éƒ¨çš„å‡½æ•° binder_open å’Œ binder_mmap</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t*/</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>ProcessState<span class=\"token operator\">></span> ps <span class=\"token operator\">=</span> <span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">initWithDriver</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">// è®¾ç½®å¯ä»¥åŒæ—¶å­˜åœ¨çš„çº¿ç¨‹æ± çš„æœ€å¤§æ•°é‡ä¸º 0, å³æ­¤æ—¶åªèƒ½æœ‰ ServiceManager è¿™ä¸€ä¸ªçº¿ç¨‹å­˜åœ¨</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    ps<span class=\"token operator\">-></span><span class=\"token function\">setThreadPoolMaxThreadCount</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">// åœ¨é˜»å¡è°ƒç”¨æ—¶ä¸­æ­¢è¿›ç¨‹</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token comment\">//FATAL_IF_NOT_ONEWAY: ServiceManager å‘èµ·çš„ Binder è°ƒç”¨å¿…é¡»æ˜¯å•å‘ï¼Œå¦åˆ™æ‰“å°å †æ ˆæ—¥å¿—æç¤º</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    ps<span class=\"token operator\">-></span><span class=\"token function\">setCallRestriction</span><span class=\"token punctuation\">(</span>ProcessState<span class=\"token double-colon punctuation\">::</span>CallRestriction<span class=\"token double-colon punctuation\">::</span>FATAL_IF_NOT_ONEWAY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token comment\">// å®ä¾‹åŒ– ServiceManager, åˆå§‹åŒ–å‚æ•°ä¸º Access å¯¹è±¡çš„æ™ºèƒ½æŒ‡é’ˆ</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>ServiceManager<span class=\"token operator\">></span> manager <span class=\"token operator\">=</span> <span class=\"token class-name\">sp</span><span class=\"token operator\">&lt;</span>ServiceManager<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token generic-function\"><span class=\"token function\">make_unique</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>Access<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token comment\">//self register servicemanager,\"manager\" å°†ä½œä¸º servicemanager çš„ç¬¬ä¸€ä¸ªæœåŠ¡è¢«æ³¨å†Œ</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>manager<span class=\"token operator\">-></span><span class=\"token function\">addService</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"manager\"</span><span class=\"token punctuation\">,</span> manager<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span> <span class=\"token comment\">/*allowIsolated*/</span><span class=\"token punctuation\">,</span> IServiceManager<span class=\"token double-colon punctuation\">::</span>DUMP_FLAG_PRIORITY_DEFAULT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token function\">LOG</span><span class=\"token punctuation\">(</span>ERROR<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Could not self register servicemanager\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token comment\">// å°† \"manager\" æœåŠ¡ä½œä¸ºæœåŠ¡ç«¯ Bbinder å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token class-name\">IPCThreadState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">setTheContextObject</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token comment\">// å‘ binder é©±åŠ¨å‘é€ ioctl BINDER_SET_CONTEXT_MGR_EXT ä¿¡å·ï¼Œå°† servicemanager</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token comment\">// åœ¨ ProcessState::initWithDriver ä¸­æ‰“å¼€é©±åŠ¨è®¾å¤‡ /dev/driver æ‰€è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦å¥æŸ„</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token comment\">// ä½œä¸ºæ•´ä¸ª binder IPC é€šä¿¡ä¸­çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    ps<span class=\"token operator\">-></span><span class=\"token function\">becomeContextManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token comment\">// å‡†å¤‡ looper</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>Looper<span class=\"token operator\">></span> looper <span class=\"token operator\">=</span> <span class=\"token class-name\">Looper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span> <span class=\"token comment\">/*allowNonCallbacks*/</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token comment\">// ç›‘å¬ BC_ENTER_LOOPER ä¿¡å·ï¼Œæ”¶åˆ°è¯¥ä¿¡å·åå›è°ƒå¤„ç† binder è°ƒç”¨</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token class-name\">BinderCallback</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setupTo</span><span class=\"token punctuation\">(</span>looper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token comment\">// ç›‘å¬å®¢æˆ·ç«¯å›è°ƒ</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token class-name\">ClientCallbackCallback</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setupTo</span><span class=\"token punctuation\">(</span>looper<span class=\"token punctuation\">,</span> manager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t<span class=\"token comment\">// é˜»å¡ç­‰å¾…å’Œå¤„ç†äº‹ä»¶</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        looper<span class=\"token operator\">-></span><span class=\"token function\">pollAll</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token comment\">// should not be reached</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token keyword\">return</span> EXIT_FAILURE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"processstateinit\"><a class=\"anchor\" href=\"#processstateinit\">#</a> ProcessState::init</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\ProcessState.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>sp<span class=\"token operator\">&lt;</span>ProcessState<span class=\"token operator\">></span> <span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span>kDefaultDriver<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span> <span class=\"token comment\">/*requireDefault*/</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>sp<span class=\"token operator\">&lt;</span>ProcessState<span class=\"token operator\">></span> <span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">initWithDriver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> driver<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span> <span class=\"token comment\">/*requireDefault*/</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>sp<span class=\"token operator\">&lt;</span>ProcessState<span class=\"token operator\">></span> <span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>driver<span class=\"token punctuation\">,</span> <span class=\"token keyword\">bool</span> requireDefault<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>clang<span class=\"token double-colon punctuation\">::</span>no_destroy<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">static</span> sp<span class=\"token operator\">&lt;</span>ProcessState<span class=\"token operator\">></span> gProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>clang<span class=\"token double-colon punctuation\">::</span>no_destroy<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">static</span> std<span class=\"token double-colon punctuation\">::</span>mutex gProcessMutex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>driver <span class=\"token operator\">==</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>lock_guard<span class=\"token operator\">&lt;</span>std<span class=\"token double-colon punctuation\">::</span>mutex<span class=\"token operator\">></span> <span class=\"token function\">l</span><span class=\"token punctuation\">(</span>gProcessMutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">return</span> gProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\tè¿™é‡Œä½¿ç”¨äº†å•ä¾‹æ¨¡å¼çš„è®¾è®¡æ€æƒ³ï¼Œé€šè¿‡ std::once_flag å’Œ std::call_once</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\tæ¥ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿›å…¥åˆå§‹åŒ–ä»£ç å—ï¼Œ</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\tè¿™ä¿è¯äº†åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­åªèƒ½æœ‰ä¸€ä¸ª ProcessState å®ä¾‹</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\tå®ƒçš„å·¥ä½œæ–¹å¼å¦‚ä¸‹</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t[-] ç¬¬ä¸€æ¬¡è°ƒç”¨ std::call_once æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥ä¸ std::once_flag å…³è”çš„æ ‡è®°æ˜¯å¦å·²è¢«è®¾ç½®ã€‚</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\tå¦‚æœæ ‡è®°å°šæœªè®¾ç½®ï¼Œå®ƒå°†æ‰§è¡Œä¼ é€’ç»™ std::call_once çš„å¯è°ƒç”¨å¯¹è±¡ï¼Œ</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\tå¹¶è®¾ç½®æ ‡è®°ï¼Œä»¥æ ‡è®°åˆå§‹åŒ–å·²å®Œæˆã€‚</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t[-] å¦‚æœå…¶ä»–çº¿ç¨‹å°è¯•å†æ¬¡è°ƒç”¨ std::call_once ä¸ç›¸åŒçš„ std::once_flagï¼Œ</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\tå®ƒä¼šå‘ç°æ ‡è®°å·²ç»è®¾ç½®ï¼Œå› æ­¤ä¸ä¼šå†æ¬¡æ‰§è¡Œå¯è°ƒç”¨å¯¹è±¡ã€‚</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t*/</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>clang<span class=\"token double-colon punctuation\">::</span>no_destroy<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">static</span> std<span class=\"token double-colon punctuation\">::</span>once_flag gProcessOnce<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">call_once</span><span class=\"token punctuation\">(</span>gProcessOnce<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token comment\">// åˆ¤æ–­ binder é©±åŠ¨æ˜¯å¦å­˜åœ¨</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">,</span> R_OK<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token function\">ALOGE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Binder driver %s is unavailable. Using /dev/binder instead.\"</span><span class=\"token punctuation\">,</span> driver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            driver <span class=\"token operator\">=</span> <span class=\"token string\">\"/dev/binder\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>lock_guard<span class=\"token operator\">&lt;</span>std<span class=\"token double-colon punctuation\">::</span>mutex<span class=\"token operator\">></span> <span class=\"token function\">l</span><span class=\"token punctuation\">(</span>gProcessMutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token comment\">// å°† driver ä½œä¸ºå‚æ•°å®ä¾‹åŒ– ProcessState, å¹¶èµ‹å€¼ç»™ gProcess</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        gProcess <span class=\"token operator\">=</span> <span class=\"token class-name\">sp</span><span class=\"token operator\">&lt;</span>ProcessState<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>requireDefault<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token comment\">// Detect if we are trying to initialize with a different driver, and</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token comment\">// consider that an error. ProcessState will only be initialized once above.</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token function\">LOG_ALWAYS_FATAL_IF</span><span class=\"token punctuation\">(</span>gProcess<span class=\"token operator\">-></span><span class=\"token function\">getDriverName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> driver<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                            <span class=\"token string\">\"ProcessState was already initialized with %s,\"</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                            <span class=\"token string\">\" can't initialize with %s.\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                            gProcess<span class=\"token operator\">-></span><span class=\"token function\">getDriverName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> driver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token keyword\">return</span> gProcess<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"processstateæ„é€ å‡½æ•°\"><a class=\"anchor\" href=\"#processstateæ„é€ å‡½æ•°\">#</a> <strong>ProcessState æ„é€ å‡½æ•°</strong></h2>\n<p>åœ¨ä»£ç çš„ç¬¬ 26 è¡Œï¼Œé€šè¿‡ <code>driver</code>  å‚æ•°å®ä¾‹åŒ–äº† ProcessState, å®ƒé€šè¿‡ <code>open_driver()</code>  æ‰“å¼€äº† binder é©±åŠ¨è®¾å¤‡ï¼Œå¹¶ä½¿ç”¨ <code>mmap</code>  æ¥è¿›è¡Œå†…å­˜æ˜ å°„</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\ProcessState.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ProcessState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>driver<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token operator\">:</span> <span class=\"token function\">mDriverName</span><span class=\"token punctuation\">(</span><span class=\"token function\">String8</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">,</span> <span class=\"token function\">mDriverFD</span><span class=\"token punctuation\">(</span><span class=\"token function\">open_driver</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token comment\">// é€šè¿‡ç³»ç»Ÿè°ƒç”¨é™·å…¥å†…æ ¸ï¼Œæ‰“å¼€ /dev/binder è®¾å¤‡</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">,</span> <span class=\"token function\">mVMStart</span><span class=\"token punctuation\">(</span>MAP_FAILED<span class=\"token punctuation\">)</span><span class=\"token comment\">// æ˜ å°„å†…å­˜çš„èµ·å§‹åœ°å€</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">,</span> <span class=\"token function\">mThreadCountLock</span><span class=\"token punctuation\">(</span>PTHREAD_MUTEX_INITIALIZER<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">,</span> <span class=\"token function\">mThreadCountDecrement</span><span class=\"token punctuation\">(</span>PTHREAD_COND_INITIALIZER<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">,</span> <span class=\"token function\">mExecutingThreadsCount</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">,</span> <span class=\"token function\">mWaitingForThreads</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">,</span> <span class=\"token function\">mMaxThreads</span><span class=\"token punctuation\">(</span>DEFAULT_MAX_BINDER_THREADS<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">,</span> <span class=\"token function\">mStarvationStartTimeMs</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">,</span> <span class=\"token function\">mThreadPoolStarted</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">,</span> <span class=\"token function\">mThreadPoolSeq</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">,</span> <span class=\"token function\">mCallRestriction</span><span class=\"token punctuation\">(</span>CallRestriction<span class=\"token double-colon punctuation\">::</span>NONE<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mDriverFD <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token comment\">// mmap the binder, providing a chunk of virtual address space to receive transactions.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token comment\">// è°ƒç”¨å†…å­˜æ˜ å°„å‡½æ•° mmap, æ­¤æ—¶ binder é©±åŠ¨ä¼šåœ¨å†…æ ¸ç©ºé—´æ‰§è¡Œ binder_mmap, æ¥å°†ä¸€å—ç‰©ç†å†…å­˜åŒæ—¶æ˜ å°„åˆ°</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token comment\">// ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ï¼Œæ¥å¸®åŠ©è¿›è¡Œè·¨è¿›ç¨‹é€šä¿¡</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token comment\">// #define BINDER_VM_SIZE ((1 * 1024 * 1024) - sysconf(_SC_PAGE_SIZE) * 2) = 1016KB</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token comment\">// PAGE_SIZE è¢«å®šä¹‰ä¸º 4096</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        mVMStart <span class=\"token operator\">=</span> <span class=\"token function\">mmap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">,</span> BINDER_VM_SIZE<span class=\"token punctuation\">,</span> PROT_READ<span class=\"token punctuation\">,</span> MAP_PRIVATE <span class=\"token operator\">|</span> MAP_NORESERVE<span class=\"token punctuation\">,</span> mDriverFD<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mVMStart <span class=\"token operator\">==</span> MAP_FAILED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token comment\">// *sigh*</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token function\">ALOGE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Using %s failed: unable to mmap transaction memory.\\n\"</span><span class=\"token punctuation\">,</span> mDriverName<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>mDriverFD<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            mDriverFD <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            mDriverName<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">__ANDROID__</span></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token function\">LOG_ALWAYS_FATAL_IF</span><span class=\"token punctuation\">(</span>mDriverFD <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Binder driver '%s' could not be opened.  Terminating.\"</span><span class=\"token punctuation\">,</span> driver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"open_driver\"><a class=\"anchor\" href=\"#open_driver\">#</a> <strong>open_driver</strong></h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\ProcessState.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token function\">open_driver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>driver<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">// ä»¥è¯»å†™æ–¹å¼æ‰“å¼€ï¼Œå¹¶ä¸ºè¯¥æ–‡ä»¶æè¿°ç¬¦æ·»åŠ  close-on-exec (æ‰§è¡Œæ—¶å¯å…³é—­) çš„æ ‡å¿—ï¼Œ</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token comment\">// æ¥é˜²æ­¢è¯¥æ–‡ä»¶æè¿°ç¬¦è¢«æ„å¤–æ³„æ¼ç»™äº† fork åˆ›å»ºå‡ºæ¥çš„å­è¿›ç¨‹</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">,</span> O_RDWR <span class=\"token operator\">|</span> O_CLOEXEC<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fd <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">int</span> vers <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        status_t result <span class=\"token operator\">=</span> <span class=\"token function\">ioctl</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> BINDER_VERSION<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>vers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token function\">ALOGE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Binder ioctl to obtain version failed: %s\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strerror</span><span class=\"token punctuation\">(</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            fd <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> vers <span class=\"token operator\">!=</span> BINDER_CURRENT_PROTOCOL_VERSION<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          <span class=\"token function\">ALOGE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Binder driver protocol(%d) does not match user space protocol(%d)! ioctl() return value: %d\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                vers<span class=\"token punctuation\">,</span> BINDER_CURRENT_PROTOCOL_VERSION<span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            fd <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token comment\">// è®¾ç½®è¿™ä¸ªæ‰“å¼€çš„ binder å¯¹è±¡çš„æœ€å¤§çº¿ç¨‹æ•°ä¸º 15</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        size_t maxThreads <span class=\"token operator\">=</span> DEFAULT_MAX_BINDER_THREADS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        result <span class=\"token operator\">=</span> <span class=\"token function\">ioctl</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> BINDER_SET_MAX_THREADS<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>maxThreads<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token function\">ALOGE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Binder ioctl to set max threads failed: %s\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strerror</span><span class=\"token punctuation\">(</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">uint32_t</span> enable <span class=\"token operator\">=</span> DEFAULT_ENABLE_ONEWAY_SPAM_DETECTION<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        result <span class=\"token operator\">=</span> <span class=\"token function\">ioctl</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> BINDER_ENABLE_ONEWAY_SPAM_DETECTION<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>enable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token function\">ALOGD</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Binder ioctl to enable oneway spam detection failed: %s\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strerror</span><span class=\"token punctuation\">(</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token function\">ALOGW</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Opening '%s' failed: %s\\n\"</span><span class=\"token punctuation\">,</span> driver<span class=\"token punctuation\">,</span> <span class=\"token function\">strerror</span><span class=\"token punctuation\">(</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">return</span> fd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h2>\n<p><img data-src=\"/android-binder/1595250-20211114151720684-1823259499.png\" alt=\"img\" style=\"aspect-ratio:1611 / 1058;\"></p>\n<h1 id=\"binderä¸­å„ä¸ªç±»çš„å«ä¹‰\"><a class=\"anchor\" href=\"#binderä¸­å„ä¸ªç±»çš„å«ä¹‰\">#</a> Binder ä¸­å„ä¸ªç±»çš„å«ä¹‰</h1>\n<p>åœ¨è¿›è¡Œåç»­çš„å­¦ä¹ å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ Binder ä¸­å„ä¸ªç±»çš„å«ä¹‰</p>\n<table>\n<thead>\n<tr>\n<th>ç±»å</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>BpRefBase</td>\n<td>RefBase çš„å­ç±»ï¼Œæä¾› remote () æ–¹æ³•è·å–è¿œç¨‹ Binder</td>\n</tr>\n<tr>\n<td>IInterface</td>\n<td>Binder æœåŠ¡æ¥å£çš„åŸºç±»ï¼ŒBinder æœåŠ¡é€šå¸¸éœ€è¦åŒæ—¶æä¾›æœ¬åœ°æ¥å£å’Œè¿œç¨‹æ¥å£</td>\n</tr>\n<tr>\n<td>BpInterface</td>\n<td>è¿œç¨‹æ¥å£çš„åŸºç±»ï¼Œ<strong>è¿œç¨‹æ¥å£æ˜¯ä¾›å®¢æˆ·ç«¯è°ƒç”¨çš„æ¥å£é›†</strong></td>\n</tr>\n<tr>\n<td>BnInterface</td>\n<td>æœ¬åœ°æ¥å£çš„åŸºç±»ï¼Œ<strong>æœ¬åœ°æ¥å£æ˜¯éœ€è¦æœåŠ¡ä¸­çœŸæ­£å®ç°çš„æ¥å£é›†</strong></td>\n</tr>\n<tr>\n<td>IBinder</td>\n<td>Binder å¯¹è±¡çš„åŸºç±»ï¼ŒBBinder å’Œ BpBinder éƒ½æ˜¯è¿™ä¸ªç±»çš„å­ç±»</td>\n</tr>\n<tr>\n<td>BpBinder</td>\n<td>è¿œç¨‹ Binderï¼Œè¿™ä¸ªç±»æä¾› transact æ–¹æ³•æ¥å‘é€è¯·æ±‚ï¼ŒBpXXX å®ç°ä¸­ä¼šç”¨åˆ°</td>\n</tr>\n<tr>\n<td>BBinder</td>\n<td>æœ¬åœ° Binderï¼ŒæœåŠ¡å®ç°æ–¹çš„åŸºç±»ï¼Œæä¾›äº† onTransact æ¥å£æ¥æ¥æ”¶è¯·æ±‚</td>\n</tr>\n<tr>\n<td>ProcessState</td>\n<td>ä»£è¡¨äº†ä½¿ç”¨ Binder çš„è¿›ç¨‹</td>\n</tr>\n<tr>\n<td>IPCThreadState</td>\n<td>ä»£è¡¨äº†ä½¿ç”¨ Binder çš„çº¿ç¨‹ï¼Œè¿™ä¸ªç±»ä¸­å°è£…äº†ä¸ Binder é©±åŠ¨é€šä¿¡çš„é€»è¾‘</td>\n</tr>\n<tr>\n<td>Parcel</td>\n<td>åœ¨ Binder ä¸Šä¼ é€’çš„æ•°æ®çš„åŒ…è£…å™¨</td>\n</tr>\n</tbody>\n</table>\n<p>Binder æœåŠ¡çš„å®ç°ç±»é€šå¸¸éƒ½ä¼šéµå®ˆä¸‹é¢çš„å‘½åè§„åˆ™</p>\n<ul>\n<li>æœåŠ¡çš„æ¥å£ä½¿ç”¨ I å­—æ¯ä½œä¸ºå‰ç¼€</li>\n<li>è¿œç¨‹æ¥å£ä½¿ç”¨ Bp ä½œä¸ºå‰ç¼€</li>\n<li>æœ¬åœ°æ¥å£ä½¿ç”¨ Bn ä½œä¸ºå‰ç¼€</li>\n<li>p å³ proxy çš„æ„æ€ï¼Œæ˜¯å®¢æˆ·ç«¯ç”¨æ¥ä¸ Server äº¤äº’çš„ç±»</li>\n</ul>\n<p><strong>IBinder å®¶æ—</strong></p>\n<p><img data-src=\"/android-binder/image002.png\" alt=\"image\" style=\"aspect-ratio:224 / 200;\"></p>\n<p>BpBinder å’Œ BBinder éƒ½æ˜¯ Android ä¸­ä¸ Binder é€šä¿¡ç›¸å…³çš„ä»£è¡¨ï¼Œå®ƒä»¬éƒ½ä» IBinder ç±»ä¸­æ´¾ç”Ÿè€Œæ¥</p>\n<ul>\n<li>BpBinder æ˜¯å®¢æˆ·ç«¯ç”¨æ¥ä¸ Server äº¤äº’çš„ä»£ç†ç±»ï¼Œp å³ proxy çš„æ„æ€</li>\n<li>BBinder åˆ™æ˜¯ proxy ç›¸å¯¹çš„ä¸€ç«¯ï¼Œå®ƒæ˜¯ proxy äº¤äº’çš„ç›®çš„ç«¯ã€‚å¦‚æœè¯´ BpBinder ä»£è¡¨å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆ BBinder åˆ™ä»£è¡¨æœåŠ¡ç«¯ã€‚è¿™é‡Œçš„ BpBinder å’Œ BBinder æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå³æŸä¸ª BpBinder åªèƒ½å’Œå¯¹åº”çš„ BBinder äº¤äº’</li>\n<li>åœ¨æ³¨å†ŒæœåŠ¡å’Œè·å–æœåŠ¡çš„è¿‡ç¨‹ä¸­ï¼ŒServiceManager å‡ä¸ºæœåŠ¡ç«¯</li>\n<li>BpBinder é€šè¿‡ handle æ¥æ ‡è¯†å®ƒæ‰€å¯¹åº”çš„ BBinder ç«¯ï¼Œä¸å…¶ç›¸å…³çš„å‡½æ•°ä¸º <code>sp&lt;IBinder&gt; ProcessState::getStrongProxyForHandle(int32_t handle)</code> ,handle å€¼ä¸º 0 è¡¨ç¤º ServiceManager æ‰€å¯¹åº”çš„ BBinder</li>\n</ul>\n<p><strong>IServiceManager å®¶æ—</strong></p>\n<p><img data-src=\"/android-binder/image003.png\" alt=\"image\" style=\"aspect-ratio:392 / 355;\"></p>\n<ul>\n<li>\n<p>IServiceManagerã€BpServiceManager å’Œ BnServiceManager éƒ½ä¸ä¸šåŠ¡é€»è¾‘ç›¸å…³ã€‚</p>\n</li>\n<li>\n<p>BnServiceManager åŒæ—¶ä» BBinder æ´¾ç”Ÿï¼Œè¡¨ç¤ºå®ƒå¯ä»¥ç›´æ¥å‚ä¸ Binder é€šä¿¡ã€‚</p>\n</li>\n<li>\n<p>BpServiceManager è™½ç„¶ä» BpInterface ä¸­æ´¾ç”Ÿï¼Œä½†æ˜¯è¿™æ¡åˆ†æ”¯ä¼¼ä¹ä¸ BpBinder æ²¡æœ‰å…³ç³»ã€‚</p>\n</li>\n<li>\n<p>BnServiceManager æ˜¯ä¸€ä¸ªè™šç±»ï¼Œå®ƒçš„ä¸šåŠ¡å‡½æ•°æœ€ç»ˆéœ€è¦å­ç±»æ¥å®ç°ã€‚</p>\n</li>\n</ul>\n<h1 id=\"servicemanagerçš„è·å–è¿‡ç¨‹\"><a class=\"anchor\" href=\"#servicemanagerçš„è·å–è¿‡ç¨‹\">#</a> ServiceManager çš„è·å–è¿‡ç¨‹</h1>\n<p>å½“ä¸€ä¸ª Server æƒ³è¦æ³¨å†ŒæœåŠ¡ï¼Œé‚£å¿…é¡»è¦çŸ¥é“ &quot;ServiceManager åœ¨å“ªé‡Œæ‰å¯ä»¥&quot;, æ‰€ä»¥éœ€è¦æœ‰ä¸€ä¸ªæ–¹æ³•æ¥è®© Server æ‰¾åˆ° ServiceManager, è¿™æ˜¯é€šè¿‡å‡½æ•° <code>defaultServiceManager</code>  å®ç°çš„</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è·å– BpServiceManager å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>sp<span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span> <span class=\"token function\">sm</span><span class=\"token punctuation\">(</span><span class=\"token function\">defaultServiceManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>defaultServiceManager çš„ä¸»è¦ä½œç”¨æ˜¯è·å– BpServiceManager å¯¹è±¡ï¼Œå®ƒé€šè¿‡ <code>getContextObject</code>  è·å–åˆ°äº† ServiceManager çš„ BBinder æ‰€å¯¹åº”çš„ BpBinder å¯¹è±¡ï¼Œéšååˆ©ç”¨ <code>interface_cast</code>  å°† <code>BpBinder</code>  å¯¹è±¡è½¬æ¢æˆäº† <code>BpServiceManager</code>  å¯¹è±¡</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\IServiceManager.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>sp<span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span> <span class=\"token function\">defaultServiceManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">call_once</span><span class=\"token punctuation\">(</span>gSmOnce<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        sp<span class=\"token operator\">&lt;</span>AidlServiceManager<span class=\"token operator\">></span> sm <span class=\"token operator\">=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>sm <span class=\"token operator\">==</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t<span class=\"token comment\">// è·å– ServiceManager çš„ BBinder æ‰€å¯¹åº”çš„ BpBinder å¯¹è±¡ï¼Œ</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token comment\">// å¹¶å°†è¯¥å¯¹è±¡é€šè¿‡ interface_cast è½¬æ¢ä¸º AidlServiceManager</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            sm <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">interface_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>AidlServiceManager<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">getContextObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sm <span class=\"token operator\">==</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token function\">ALOGE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Waiting 1s on context object on %s.\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">getDriverName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token comment\">// å®ä¾‹åŒ– ServiceManagerShim</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        gDefaultServiceManager <span class=\"token operator\">=</span> <span class=\"token class-name\">sp</span><span class=\"token operator\">&lt;</span>ServiceManagerShim<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">return</span> gDefaultServiceManager<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>AidlServiceManager</strong></p>\n<p><code>AidlServiceManager</code>  å…¶å®æ˜¯ <code>android::os::IServiceManager</code>  çš„åˆ«å</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">using</span> AidlServiceManager <span class=\"token operator\">=</span> android<span class=\"token double-colon punctuation\">::</span>os<span class=\"token double-colon punctuation\">::</span>IServiceManager<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>ServiceManagerShim</strong></p>\n<p>ä¹‹å‰æ˜¯æ²¡æœ‰ <code>ServiceManagerShim</code>  çš„ï¼Œè€Œæ˜¯ç›´æ¥æ“ä½œ BpServiceManagerï¼Œè¿™ä¸ªè¾…åŠ©ç±»å°è£…äº† AIDL è‡ªåŠ¨ç”Ÿæˆçš„ BpServiceManagerï¼Œæ‰€ä»¥ç°åœ¨çš„å®¢æˆ·ç«¯ä»£ç æµå°±å˜æˆå¦‚ä¸‹ä¸‰æ­¥ï¼š</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.</span>      ç”¨æˆ·ä»£ç  </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2.</span> libbinderä»£ç   binder<span class=\"token operator\">/</span>IServiceManager<span class=\"token punctuation\">.</span>cpp#ServiceManagerShim</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">3.</span>     AIDL ä»£ç   android<span class=\"token operator\">/</span>os<span class=\"token operator\">/</span>IServiceManager<span class=\"token punctuation\">.</span>cpp#BpServiceManager æ¥å£</pre></td></tr></table></figure><p>libbinder ä¸­çš„ ServiceManagerShim èµ·åˆ°äº†ä¸€ä¸ªä¸­è½¬çš„ä½œç”¨ï¼ŒæŠŠè¯·æ±‚è½¬ç»™ out ä¸‹ AIDL è‡ªåŠ¨ç”Ÿæˆçš„ BpServiceManager, åŸæ¥æ˜¯åœ¨ libbinder#IServiceManager.cpp ä¸­æ‰‹å†™å®ç°ï¼Œç°åœ¨æ˜¯ AIDL å¸®ä½ å®ç°ã€‚</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\IServiceManager.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// From the old libbinder IServiceManager interface to IServiceManager.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">ServiceManagerShim</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">IServiceManager</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">explicit</span> <span class=\"token function\">ServiceManagerShim</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> sp<span class=\"token operator\">&lt;</span>AidlServiceManager<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> impl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> <span class=\"token function\">getService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> String16<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">override</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> <span class=\"token function\">checkService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> String16<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">override</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    status_t <span class=\"token function\">addService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> String16<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> service<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                        <span class=\"token keyword\">bool</span> allowIsolated<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> dumpsysPriority<span class=\"token punctuation\">)</span> <span class=\"token keyword\">override</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    Vector<span class=\"token operator\">&lt;</span>String16<span class=\"token operator\">></span> <span class=\"token function\">listServices</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> dumpsysPriority<span class=\"token punctuation\">)</span> <span class=\"token keyword\">override</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> <span class=\"token function\">waitForService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> String16<span class=\"token operator\">&amp;</span> name16<span class=\"token punctuation\">)</span> <span class=\"token keyword\">override</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">bool</span> <span class=\"token function\">isDeclared</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> String16<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">override</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    Vector<span class=\"token operator\">&lt;</span>String16<span class=\"token operator\">></span> <span class=\"token function\">getDeclaredInstances</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> String16<span class=\"token operator\">&amp;</span> interface<span class=\"token punctuation\">)</span> <span class=\"token keyword\">override</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>optional<span class=\"token operator\">&lt;</span>String16<span class=\"token operator\">></span> <span class=\"token function\">updatableViaApex</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> String16<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">override</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">// for legacy ABI</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">const</span> String16<span class=\"token operator\">&amp;</span> <span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">override</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">return</span> mTheRealServiceManager<span class=\"token operator\">-></span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    IBinder<span class=\"token operator\">*</span> <span class=\"token function\">onAsBinder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">override</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">IInterface</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">asBinder</span><span class=\"token punctuation\">(</span>mTheRealServiceManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">private</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>AidlServiceManager<span class=\"token operator\">></span> mTheRealServiceManager<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"getcontextobject\"><a class=\"anchor\" href=\"#getcontextobject\">#</a> getContextObject</h2>\n<p>è¿™ä¸ªå‡½æ•°æœ€ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯è·å– ServiceManager çš„ BBinder æ‰€å¯¹åº”çš„ BpBinder å¯¹è±¡ï¼Œå®ƒé€šè¿‡è°ƒç”¨ <code>getStrongProxyForHandle(0)</code>  æ¥è¿›è¡Œè·å–</p>\n<p>è¿™é‡Œä¼ å…¥çš„ handle çš„å€¼ä¸º 0, å®ƒè¡¨ç¤º ServiceManager æ‰€å¯¹åº”çš„ BBinder</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\ProcessState.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> <span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getContextObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> <span class=\"token comment\">/*caller*/</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">// åˆ›å»ºä¸€ä¸ª BpBinder å¯¹è±¡ï¼ŒgetStrongProxyForHandle ä¼ å…¥çš„å‚æ•° handle çš„å€¼ä¸º 0</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token comment\">//,0 ä»£è¡¨çš„å°±æ˜¯ ServiceManager æ‰€å¯¹åº”çš„ BBinderã€‚</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> context <span class=\"token operator\">=</span> <span class=\"token function\">getStrongProxyForHandle</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token comment\">// The root object is special since we get it directly from the driver, it is never</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// written by Parcell::writeStrongBinder.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        internal<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Stability</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">markCompilationUnit</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token function\">ALOGW</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Not able to get context object on %s.\"</span><span class=\"token punctuation\">,</span> mDriverName<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">return</span> context<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>getStrongProxyForHandle(0)</strong></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\ProcessState.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> <span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getStrongProxyForHandle</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int32_t</span> handle<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    AutoMutex <span class=\"token function\">_l</span><span class=\"token punctuation\">(</span>mLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// æ ¹æ®ç´¢å¼•æŸ¥æ‰¾å¯¹åº”èµ„æºã€‚</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    handle_entry<span class=\"token operator\">*</span> e <span class=\"token operator\">=</span> <span class=\"token function\">lookupHandleLocked</span><span class=\"token punctuation\">(</span>handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token comment\">// å¦‚æœ lookupHandleLocked å‘ç°æ²¡æœ‰å¯¹åº”çš„èµ„æºé¡¹ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹å¹¶è¿”å›ã€‚</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token comment\">// We need to create a new BpBinder if there isn't currently one, OR we</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// are unable to acquire a weak reference on this current one.  The</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token comment\">// attemptIncWeak() is safe because we know the BpBinder destructor will always</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token comment\">// call expungeHandle(), which acquires the same lock we are holding now.</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\">// We need to do this because there is a race condition between someone</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token comment\">// releasing a reference on this BpBinder, and a new reference on its handle</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token comment\">// arriving from the driver.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        IBinder<span class=\"token operator\">*</span> b <span class=\"token operator\">=</span> e<span class=\"token operator\">-></span>binder<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>b <span class=\"token operator\">==</span> <span class=\"token keyword\">nullptr</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>e<span class=\"token operator\">-></span>refs<span class=\"token operator\">-></span><span class=\"token function\">attemptIncWeak</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>handle <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                <span class=\"token comment\">// Special case for context manager...</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                <span class=\"token comment\">// The context manager is the only object for which we create</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token comment\">// a BpBinder proxy without already holding a reference.</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token comment\">// Perform a dummy transaction to ensure the context manager</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token comment\">// is registered before we create the first local reference</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                <span class=\"token comment\">// to it (which will occur when creating the BpBinder).</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                <span class=\"token comment\">// If a local reference is created for the BpBinder when the</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                <span class=\"token comment\">// context manager is not present, the driver will fail to</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                <span class=\"token comment\">// provide a reference to the context manager, but the</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token comment\">// driver API does not return status.</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token comment\">// Note that this is not race-free if the context manager</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token comment\">// dies while this code runs.</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                <span class=\"token comment\">// TODO: add a driver API to wait for context manager, or</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token comment\">// stop special casing handle 0 for context manager and add</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token comment\">// a driver API to get a handle to the context manager with</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                <span class=\"token comment\">// proper reference counting.</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                IPCThreadState<span class=\"token operator\">*</span> ipc <span class=\"token operator\">=</span> <span class=\"token class-name\">IPCThreadState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                CallRestriction originalCallRestriction <span class=\"token operator\">=</span> ipc<span class=\"token operator\">-></span><span class=\"token function\">getCallRestriction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                ipc<span class=\"token operator\">-></span><span class=\"token function\">setCallRestriction</span><span class=\"token punctuation\">(</span>CallRestriction<span class=\"token double-colon punctuation\">::</span>NONE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                Parcel data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                status_t status <span class=\"token operator\">=</span> ipc<span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                        <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> IBinder<span class=\"token double-colon punctuation\">::</span>PING_TRANSACTION<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                ipc<span class=\"token operator\">-></span><span class=\"token function\">setCallRestriction</span><span class=\"token punctuation\">(</span>originalCallRestriction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">==</span> DEAD_OBJECT<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                   <span class=\"token keyword\">return</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t\t<span class=\"token comment\">// åˆ›å»ºä¸€ä¸ª BpBinder</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            sp<span class=\"token operator\">&lt;</span>BpBinder<span class=\"token operator\">></span> b <span class=\"token operator\">=</span> <span class=\"token class-name\">BpBinder</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            e<span class=\"token operator\">-></span>binder <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span> e<span class=\"token operator\">-></span>refs <span class=\"token operator\">=</span> b<span class=\"token operator\">-></span><span class=\"token function\">getWeakRefs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            result <span class=\"token operator\">=</span> b<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            <span class=\"token comment\">// This little bit of nastyness is to allow us to add a primary</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            <span class=\"token comment\">// reference to the remote proxy when this team doesn't have one</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            <span class=\"token comment\">// but another team is sending the handle to us.</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            result<span class=\"token punctuation\">.</span><span class=\"token function\">force_set</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            e<span class=\"token operator\">-></span>refs<span class=\"token operator\">-></span><span class=\"token function\">decWeak</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"interface_cast\"><a class=\"anchor\" href=\"#interface_cast\">#</a> <strong>interface_cast</strong></h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\include\\binder\\IInterface.h</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/**</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * If this is a local object and the descriptor matches, this will return the</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * actual local object which is implementing the interface. Otherwise, this will</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * return a proxy to the interface without checking the interface descriptor.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * This means that subsequent calls may fail with BAD_TYPE.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> */</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">template</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">INTERFACE</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">inline</span> sp<span class=\"token operator\">&lt;</span>INTERFACE<span class=\"token operator\">></span> <span class=\"token function\">interface_cast</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> obj<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token class-name\">INTERFACE</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">asInterface</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ï¼Œå…¶ä¸­çš„ <code>asInterface</code>  æ˜¯åœ¨ <code>DECLARE_META_INTERFACE</code>  å®ä¸­å®šä¹‰çš„</p>\n<p><strong>asInterface</strong></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\include\\binder\\IInterface.h</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//## çš„ä½œç”¨æ˜¯å°†å‰åä¸¤ä¸ªæ ‡è¯†ç¬¦æˆ–ç¬¦å·è¿æ¥åœ¨ä¸€èµ·ï¼Œä»¥å½¢æˆä¸€ä¸ªå•ç‹¬çš„æ ‡è¯†ç¬¦æˆ–ç¬¦å·ã€‚</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// å¦‚ #define CONCATENATE (x, y) x##y</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// å¦‚æœè°ƒç”¨ CONCATENATE (a, b)ï¼Œå®ƒå°†è¢«å±•å¼€ä¸º ab</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">DECLARE_META_INTERFACE</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>INTERFACE<span class=\"token punctuation\">)</span>                               </span><span class=\"token punctuation\">\\</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token expression\"><span class=\"token keyword\">public</span><span class=\"token operator\">:</span>                                                                 </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token expression\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>String16 descriptor<span class=\"token punctuation\">;</span>                        </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token expression\"><span class=\"token keyword\">static</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token operator\">></span> <span class=\"token function\">asInterface</span><span class=\"token punctuation\">(</span>                     </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token expression\"><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>              </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token expression\"><span class=\"token keyword\">virtual</span> <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>String16<span class=\"token operator\">&amp;</span> <span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>  </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token expression\">I</span><span class=\"token punctuation\">##</span><span class=\"token expression\"><span class=\"token function\">INTERFACE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                                     </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token expression\"><span class=\"token keyword\">virtual</span> <span class=\"token operator\">~</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\"><span class=\"token function\">INTERFACE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                            </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token expression\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">setDefaultImpl</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token operator\">></span> impl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token expression\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> <span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>       </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token expression\"><span class=\"token keyword\">private</span><span class=\"token operator\">:</span>                                                                </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token expression\"><span class=\"token keyword\">static</span> std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token operator\">></span> default_impl<span class=\"token punctuation\">;</span>                  </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token expression\"><span class=\"token keyword\">public</span><span class=\"token operator\">:</span>                                                                 </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">IMPLEMENT_META_INTERFACE</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>INTERFACE<span class=\"token punctuation\">,</span> NAME<span class=\"token punctuation\">)</span>                       </span><span class=\"token punctuation\">\\</span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token expression\"><span class=\"token function\">DO_NOT_DIRECTLY_USE_ME_IMPLEMENT_META_INTERFACE</span><span class=\"token punctuation\">(</span>INTERFACE<span class=\"token punctuation\">,</span> NAME<span class=\"token punctuation\">)</span>    </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">DO_NOT_DIRECTLY_USE_ME_IMPLEMENT_META_INTERFACE</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>INTERFACE<span class=\"token punctuation\">,</span> NAME<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">\\</span></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token expression\"><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>StaticString16                                     </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token expression\">I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE</span><span class=\"token punctuation\">##</span><span class=\"token expression\"><span class=\"token function\">_descriptor_static_str16</span><span class=\"token punctuation\">(</span><span class=\"token function\">__IINTF_CONCAT</span><span class=\"token punctuation\">(</span>u<span class=\"token punctuation\">,</span> NAME<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token expression\"><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>String16 I</span><span class=\"token punctuation\">##</span><span class=\"token expression\"><span class=\"token class-name\">INTERFACE</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">descriptor</span><span class=\"token punctuation\">(</span>                 </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token expression\">I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE</span><span class=\"token punctuation\">##</span><span class=\"token expression\">_descriptor_static_str16<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                        </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token expression\"><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>String16<span class=\"token operator\">&amp;</span>                                          </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token expression\">I</span><span class=\"token punctuation\">##</span><span class=\"token expression\"><span class=\"token class-name\">INTERFACE</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span>              </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token expression\"><span class=\"token keyword\">return</span> I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token double-colon punctuation\">::</span>descriptor<span class=\"token punctuation\">;</span>                                </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token expression\"><span class=\"token punctuation\">&#125;</span>                                                                   </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token expression\"><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token operator\">></span> I</span><span class=\"token punctuation\">##</span><span class=\"token expression\"><span class=\"token class-name\">INTERFACE</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">asInterface</span><span class=\"token punctuation\">(</span>              </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token expression\"><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> obj<span class=\"token punctuation\">)</span>               </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token expression\"><span class=\"token punctuation\">&#123;</span>                                                                   </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token expression\"><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token operator\">></span> intr<span class=\"token punctuation\">;</span>                               </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token expression\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>                                           </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token expression\">intr <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">cast</span><span class=\"token punctuation\">(</span>                   </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                <span class=\"token expression\">obj<span class=\"token operator\">-></span><span class=\"token function\">queryLocalInterface</span><span class=\"token punctuation\">(</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token double-colon punctuation\">::</span>descriptor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token expression\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>intr <span class=\"token operator\">==</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>                                      </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                <span class=\"token expression\">intr <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span>Bp</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>         </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token expression\"><span class=\"token punctuation\">&#125;</span>                                                           </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token expression\"><span class=\"token punctuation\">&#125;</span>                                                               </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token expression\"><span class=\"token keyword\">return</span> intr<span class=\"token punctuation\">;</span>                                                    </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token expression\"><span class=\"token punctuation\">&#125;</span>                                                                   </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token expression\">std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token operator\">></span> I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token double-colon punctuation\">::</span>default_impl<span class=\"token punctuation\">;</span>           </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token expression\"><span class=\"token keyword\">bool</span> I</span><span class=\"token punctuation\">##</span><span class=\"token expression\"><span class=\"token class-name\">INTERFACE</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setDefaultImpl</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token operator\">></span> impl<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token expression\"><span class=\"token punctuation\">&#123;</span>                                                                   </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token comment\">/* Only one user of this interface can use this function     */</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token comment\">/* at a time. This is a heuristic to detect if two different */</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token comment\">/* users in the same process use this function.              */</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token expression\"><span class=\"token function\">assert</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token double-colon punctuation\">::</span>default_impl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                            </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token expression\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>impl<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>                                                     </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            <span class=\"token expression\">I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token double-colon punctuation\">::</span>default_impl <span class=\"token operator\">=</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">move</span><span class=\"token punctuation\">(</span>impl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>               </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            <span class=\"token expression\"><span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>                                                </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token expression\"><span class=\"token punctuation\">&#125;</span>                                                               </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token expression\"><span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>                                                   </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token expression\"><span class=\"token punctuation\">&#125;</span>                                                                   </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token expression\"><span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> I</span><span class=\"token punctuation\">##</span><span class=\"token expression\"><span class=\"token class-name\">INTERFACE</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token expression\"><span class=\"token punctuation\">&#123;</span>                                                                   </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token expression\"><span class=\"token keyword\">return</span> I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token double-colon punctuation\">::</span>default_impl<span class=\"token punctuation\">;</span>                              </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token expression\"><span class=\"token punctuation\">&#125;</span>                                                                   </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token expression\">I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token double-colon punctuation\">::</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\"><span class=\"token function\">INTERFACE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">&#125;</span>                                    </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token expression\">I</span><span class=\"token punctuation\">##</span><span class=\"token expression\">INTERFACE<span class=\"token double-colon punctuation\">::</span><span class=\"token operator\">~</span>I</span><span class=\"token punctuation\">##</span><span class=\"token expression\"><span class=\"token function\">INTERFACE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">&#125;</span>                                   </span>\\</pre></td></tr></table></figure><p>æˆ‘ä»¬å°† <code>interface_cast&lt;AidlServiceManager&gt;(new BpBinder(0))</code>  é€šè¿‡å®å®šä¹‰æ›¿æ¢ä¸€ä¸‹çœ‹çš„ä¼šæ›´åŠ æ¸…æ¥šï¼Œåœ¨è¿™é‡Œ <code>asInterface</code>  å°† <code>BpBinder</code>  è½¬æ¢æˆäº† <code>BpServiceManager</code> , <code>BpServiceManager</code>  ç»§æ‰¿äº† <code>IServiceManager</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>String16 descriptor<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span> <span class=\"token function\">asInterface</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">virtual</span> <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>String16<span class=\"token operator\">&amp;</span> <span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">IServiceManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">virtual</span> <span class=\"token operator\">~</span><span class=\"token function\">IServiceManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">setDefaultImpl</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span> impl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> <span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">private</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">static</span> std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span> default_impl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>StaticString16</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">IServiceManager_descriptor_static_str16</span><span class=\"token punctuation\">(</span><span class=\"token function\">__IINTF_CONCAT</span><span class=\"token punctuation\">(</span>u<span class=\"token punctuation\">,</span> android<span class=\"token punctuation\">.</span>os<span class=\"token punctuation\">.</span>IServiceManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>String16 <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">descriptor</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    IServiceManager_descriptor_static_str16<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>String16<span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">return</span> IServiceManager<span class=\"token double-colon punctuation\">::</span>descriptor<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">// åœ¨è¿™é‡Œç»ˆäºå‡ºç°äº† asInterface å‡½æ•°çš„å®šä¹‰ï¼Œæˆ‘ä»¬ä¹Ÿæ‰¾åˆ°äº† BpServiceManager è¿™ä¸ªç±»</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">asInterface</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> obj<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span> intr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        intr <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">sp</span><span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">cast</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            obj<span class=\"token operator\">-></span><span class=\"token function\">queryLocalInterface</span><span class=\"token punctuation\">(</span>IServiceManager<span class=\"token double-colon punctuation\">::</span>descriptor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>intr <span class=\"token operator\">==</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            intr <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">sp</span><span class=\"token operator\">&lt;</span>BpServiceManager<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">return</span> intr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span> IServiceManager<span class=\"token double-colon punctuation\">::</span>default_impl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token keyword\">bool</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setDefaultImpl</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span> impl<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">/* Only one user of this interface can use this function     */</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">/* at a time. This is a heuristic to detect if two different */</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\">/* users in the same process use this function.              */</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>IServiceManager<span class=\"token double-colon punctuation\">::</span>default_impl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>impl<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        IServiceManager<span class=\"token double-colon punctuation\">::</span>default_impl <span class=\"token operator\">=</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">move</span><span class=\"token punctuation\">(</span>impl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token keyword\">return</span> IServiceManager<span class=\"token double-colon punctuation\">::</span>default_impl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">IServiceManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token operator\">~</span><span class=\"token function\">IServiceManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"æ€»ç»“-2\"><a class=\"anchor\" href=\"#æ€»ç»“-2\">#</a> æ€»ç»“</h2>\n<p><img data-src=\"/android-binder/1595250-20211114151757336-739536801.png\" alt=\"img\" style=\"aspect-ratio:1194 / 499;\"></p>\n<h1 id=\"serverå‘servicemanageræ³¨å†ŒæœåŠ¡\"><a class=\"anchor\" href=\"#serverå‘servicemanageræ³¨å†ŒæœåŠ¡\">#</a> Server å‘ ServiceManager æ³¨å†ŒæœåŠ¡</h1>\n<p>è¿™é‡Œä»¥ <code>MediaServer</code>  ä¸ºä¾‹æ¥åˆ†æ Server å‘ ServiceManager æ³¨å†ŒæœåŠ¡çš„è¿‡ç¨‹</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\av\\media\\mediaserver\\main_mediaserver.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc __unused<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>argv __unused<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">signal</span><span class=\"token punctuation\">(</span>SIGPIPE<span class=\"token punctuation\">,</span> SIG_IGN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// åˆ›å»ºä¸€ä¸ª ProcessState å®ä¾‹ï¼Œæ‰“å¼€é»˜è®¤é©±åŠ¨ /dev/binder å¹¶è¿›è¡Œ mmap å†…å­˜æ˜ å°„</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token comment\">// æ­¤æ–¹æ³•çš„è¯¦ç»†åˆ†æè¯·å‚è§å³ä¾§ç›®å½• ServiceManager çš„å¯åŠ¨è¿‡ç¨‹ ->ProcessState::init</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>ProcessState<span class=\"token operator\">></span> <span class=\"token function\">proc</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">// å®¢æˆ·ç«¯è·å– ServiceManagerShim å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token comment\">// æ­¤æ–¹æ³•çš„è¯¦ç»†åˆ†æè¯·å‚è§å³ä¾§ç›®å½• ServiceManager çš„è·å–è¿‡ç¨‹</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span> <span class=\"token function\">sm</span><span class=\"token punctuation\">(</span><span class=\"token function\">defaultServiceManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token function\">ALOGI</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ServiceManager: %p\"</span><span class=\"token punctuation\">,</span> sm<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">// æ³¨å†Œ media.player æœåŠ¡</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token class-name\">MediaPlayerService</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token class-name\">ResourceManagerService</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token function\">registerExtensions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>hardware<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">configureRpcThreadpool</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token comment\">// å¯åŠ¨çº¿ç¨‹æ± </span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">startThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token comment\">// å°†çº¿ç¨‹åŠ å…¥çº¿ç¨‹æ± </span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token class-name\">IPCThreadState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">joinThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>hardware<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">joinRpcThreadpool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>MediaPlayerService::instantiate</strong></p>\n<p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯è°ƒç”¨ defaultServiceManager çš„ addService æ–¹æ³•æ¥æ·»åŠ å‘ ServiceManager æ³¨å†ŒæœåŠ¡</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\av\\media\\libmediaplayerservice\\MediaPlayerService.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">MediaPlayerService</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">defaultServiceManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">addService</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function\">String16</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"media.player\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token function\">MediaPlayerService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"defaultservicemanager-addservice\"><a class=\"anchor\" href=\"#defaultservicemanager-addservice\">#</a> defaultServiceManager()-&gt;addService</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\IServiceManager.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>status_t <span class=\"token class-name\">ServiceManagerShim</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">addService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> String16<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> service<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                        <span class=\"token keyword\">bool</span> allowIsolated<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> dumpsysPriority<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    Status status <span class=\"token operator\">=</span> mTheRealServiceManager<span class=\"token operator\">-></span><span class=\"token function\">addService</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token function\">String8</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> service<span class=\"token punctuation\">,</span> allowIsolated<span class=\"token punctuation\">,</span> dumpsysPriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> status<span class=\"token punctuation\">.</span><span class=\"token function\">exceptionCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨äº† <code>mTheRealServiceManager</code>  ä¸­çš„ <code>addService</code>  æ–¹æ³•ï¼Œé‚£ä¹ˆ mTheRealServiceManager æ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ</p>\n<h2 id=\"mtherealservicemanager\"><a class=\"anchor\" href=\"#mtherealservicemanager\">#</a> mTheRealServiceManager</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\IServiceManager.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">using</span> AidlServiceManager <span class=\"token operator\">=</span> android<span class=\"token double-colon punctuation\">::</span>os<span class=\"token double-colon punctuation\">::</span>IServiceManager<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// From the old libbinder IServiceManager interface to IServiceManager.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">ServiceManagerShim</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">IServiceManager</span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">private</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>AidlServiceManager<span class=\"token operator\">></span> mTheRealServiceManager<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token class-name\">ServiceManagerShim</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ServiceManagerShim</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> sp<span class=\"token operator\">&lt;</span>AidlServiceManager<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> impl<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token operator\">:</span> <span class=\"token function\">mTheRealServiceManager</span><span class=\"token punctuation\">(</span>impl<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ä»è¿™æ®µ ServiceManagerShim ç±»çš„å£°æ˜ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ° mTheRealServiceManager æ˜¯ <code>android::os::IServiceManager</code>  ç±»å‹çš„å®ä¾‹ï¼Œå¹¶ä¸”åœ¨ ServiceManagerShim å®ä¾‹åŒ–æ—¶èµ‹å€¼</p>\n<p>è€Œåœ¨ <strong>ServiceManager çš„è·å–è¿‡ç¨‹</strong> ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ <code>ServiceManagerShim </code> æ˜¯åœ¨ <code>defaultServiceManager()</code>  ä¸­å®ä¾‹åŒ–çš„</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\IServiceManager.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>sp<span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span> <span class=\"token function\">defaultServiceManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">call_once</span><span class=\"token punctuation\">(</span>gSmOnce<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        sp<span class=\"token operator\">&lt;</span>AidlServiceManager<span class=\"token operator\">></span> sm <span class=\"token operator\">=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>sm <span class=\"token operator\">==</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t\t<span class=\"token comment\">// è·å– ServiceManager çš„ BBinder æ‰€å¯¹åº”çš„ BpBinder å¯¹è±¡ï¼Œ</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t\t<span class=\"token comment\">// å¹¶å°†è¯¥å¯¹è±¡é€šè¿‡ interface_cast è½¬æ¢ä¸º AidlServiceManager</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            sm <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">interface_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>AidlServiceManager<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">getContextObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sm <span class=\"token operator\">==</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token function\">ALOGE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Waiting 1s on context object on %s.\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">getDriverName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token comment\">// å®ä¾‹åŒ– ServiceManagerShim</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        gDefaultServiceManager <span class=\"token operator\">=</span> <span class=\"token class-name\">sp</span><span class=\"token operator\">&lt;</span>ServiceManagerShim<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make</span><span class=\"token punctuation\">(</span>sm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">return</span> gDefaultServiceManager<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æ‰€ä»¥è¯´ <code>mTheRealServiceManager </code> å…¶å®æ˜¯ <code>BpServiceManager(new BpBinder(0))</code> , æ³¨å†ŒæœåŠ¡çš„é¡ºåºä¸º <code>BpServiceManager--&gt;BpBinder--&gt;IPCThreadState--&gt;ioctl</code></p>\n<p>è€Œ <code>BpServiceManager</code>  ç°åœ¨æ˜¯ç”± AIDL è‡ªåŠ¨ç”Ÿæˆï¼Œåœ¨æ¡†æ¶ç¼–è¯‘å®Œæˆä¹‹åçš„ out ç›®å½•ä¸­çš„</p>\n<p><strong>BpServiceManager::addService</strong></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform/out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_arm_armv8-a_shared/gen/aidl/android/os/IServiceManager.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">namespace</span> android <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">namespace</span> os <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">BpServiceManager</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> _aidl_impl<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token operator\">:</span> <span class=\"token generic-function\"><span class=\"token function\">BpInterface</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>_aidl_impl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token comment\">//_aidl_impl å°±æ˜¯ BpBinder (0) å®ä¾‹</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">addService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> service<span class=\"token punctuation\">,</span> <span class=\"token keyword\">bool</span> allowIsolated<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int32_t</span> dumpPriority<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">markForBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">remoteStrong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//0ã€å’Œ Rpc Binder æœ‰å…³</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_reply<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">//1ã€å†™ interface</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInterfaceToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token comment\">//2ã€å†™ name</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8AsUtf16</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token comment\">//3ã€å†™ binder å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeStrongBinder</span><span class=\"token punctuation\">(</span>service<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token comment\">//4ã€å†™ allowIsolated</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeBool</span><span class=\"token punctuation\">(</span>allowIsolated<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token comment\">//5ã€å†™ dumpPriority</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInt32</span><span class=\"token punctuation\">(</span>dumpPriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token comment\">//6ã€å€ŸåŠ© BpBinder (0)#transact æ¥å‘èµ· Binder é€šä¿¡</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_addService<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">UNLIKELY</span><span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNKNOWN_TRANSACTION <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">addService</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> service<span class=\"token punctuation\">,</span> allowIsolated<span class=\"token punctuation\">,</span> dumpPriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token comment\">//7ã€å¦‚æœæœ‰è¿”å›å€¼å°±ä»è¿™ä¸ª parcel åŒ…é‡Œè¯»</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">readFromParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  _aidl_error<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">setFromStatusT</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è¿™ä¸ªè¿‡ç¨‹ä¸»è¦æ˜¯å€ŸåŠ©  <code>BpBinder(0)#transact</code>  æ¥å‘èµ· Binder é€šä¿¡ï¼ŒBinder é©±åŠ¨æ ¹æ® handle == 0 æ‰¾åˆ°æˆ‘ä»¬çš„ ServiceManager è¿›ç¨‹ï¼Œå”¤é†’ä»–å¼€å§‹å¤„ç†è¯·æ±‚ã€‚</p>\n<p>è¿˜è®°å¾—åœ¨ <strong>ServiceManager çš„å¯åŠ¨è¿‡ç¨‹</strong> ä¸­çš„é‚£ä¸ª while å¾ªç¯å‡½æ•°å—ï¼ŸBinderCallback å°±æ˜¯ç”¨æ¥å¤„ç† Binder é©±åŠ¨å‘é€çš„ <code>BR_TRANSACTION</code>  ä¿¡å·çš„</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\cmds\\servicemanager\\main.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token comment\">// å‡†å¤‡ looper</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>Looper<span class=\"token operator\">></span> looper <span class=\"token operator\">=</span> <span class=\"token class-name\">Looper</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">prepare</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span> <span class=\"token comment\">/*allowNonCallbacks*/</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// ç›‘å¬ BC_ENTER_LOOPER ä¿¡å·ï¼Œæ”¶åˆ°è¯¥ä¿¡å·åå›è°ƒå¤„ç† binder è°ƒç”¨</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token class-name\">BinderCallback</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setupTo</span><span class=\"token punctuation\">(</span>looper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token comment\">// ç›‘å¬å®¢æˆ·ç«¯å›è°ƒ</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token class-name\">ClientCallbackCallback</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setupTo</span><span class=\"token punctuation\">(</span>looper<span class=\"token punctuation\">,</span> manager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// é˜»å¡ç­‰å¾…å’Œå¤„ç†äº‹ä»¶</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        looper<span class=\"token operator\">-></span><span class=\"token function\">pollAll</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">// should not be reached</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">return</span> EXIT_FAILURE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"bindercallback\"><a class=\"anchor\" href=\"#bindercallback\">#</a> BinderCallback</h2>\n<p><code>BinderCallback::handleEvent</code>  è°ƒç”¨äº† <code>IPCThreadState::self()-&gt;handlePolledCommands()</code>  æ¥å¤„ç†å‘½ä»¤</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\cmds\\servicemanager\\main.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">BinderCallback</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">LooperCallback</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">static</span> sp<span class=\"token operator\">&lt;</span>BinderCallback<span class=\"token operator\">></span> <span class=\"token function\">setupTo</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> sp<span class=\"token operator\">&lt;</span>Looper<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> looper<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        sp<span class=\"token operator\">&lt;</span>BinderCallback<span class=\"token operator\">></span> cb <span class=\"token operator\">=</span> <span class=\"token class-name\">sp</span><span class=\"token operator\">&lt;</span>BinderCallback<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">int</span> binder_fd <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token comment\">// ç›‘å¬ BC_ENTER_LOOPER ä¿¡å·</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token class-name\">IPCThreadState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">setupPolling</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>binder_fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token function\">LOG_ALWAYS_FATAL_IF</span><span class=\"token punctuation\">(</span>binder_fd <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Failed to setupPolling: %d\"</span><span class=\"token punctuation\">,</span> binder_fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">int</span> ret <span class=\"token operator\">=</span> looper<span class=\"token operator\">-></span><span class=\"token function\">addFd</span><span class=\"token punctuation\">(</span>binder_fd<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                                Looper<span class=\"token double-colon punctuation\">::</span>POLL_CALLBACK<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                                Looper<span class=\"token double-colon punctuation\">::</span>EVENT_INPUT<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                                cb<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                                <span class=\"token keyword\">nullptr</span> <span class=\"token comment\">/*data*/</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token function\">LOG_ALWAYS_FATAL_IF</span><span class=\"token punctuation\">(</span>ret <span class=\"token operator\">!=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Failed to add binder FD to Looper\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">return</span> cb<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">int</span> <span class=\"token function\">handleEvent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token comment\">/* fd */</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> <span class=\"token comment\">/* events */</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> <span class=\"token comment\">/* data */</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">override</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token class-name\">IPCThreadState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">handlePolledCommands</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Continue receiving callbacks.</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"ipcthreadstatehandlepolledcommands\"><a class=\"anchor\" href=\"#ipcthreadstatehandlepolledcommands\">#</a> IPCThreadState::handlePolledCommands</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\IPCThreadState.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>status_t <span class=\"token class-name\">IPCThreadState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">handlePolledCommands</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    status_t result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token comment\">// è·å–å¹¶æ‰§è¡Œå‘½ä»¤</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        result <span class=\"token operator\">=</span> <span class=\"token function\">getAndExecuteCommand</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>mIn<span class=\"token punctuation\">.</span><span class=\"token function\">dataPosition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> mIn<span class=\"token punctuation\">.</span><span class=\"token function\">dataSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token function\">processPendingDerefs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token function\">flushCommands</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"ipcthreadstategetandexecutecommand\"><a class=\"anchor\" href=\"#ipcthreadstategetandexecutecommand\">#</a> IPCThreadState::getAndExecuteCommand</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\IPCThreadState.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>status_t <span class=\"token class-name\">IPCThreadState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getAndExecuteCommand</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    status_t result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">int32_t</span> cmd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token comment\">// å’Œ binder é©±åŠ¨é€šä¿¡ï¼Œè·å–æˆ–ä¼ è¾“æ•°æ®</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token function\">talkWithDriver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">>=</span> NO_ERROR<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        size_t IN <span class=\"token operator\">=</span> mIn<span class=\"token punctuation\">.</span><span class=\"token function\">dataAvail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>IN <span class=\"token operator\">&lt;</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int32_t</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token comment\">// è¯»å–å‘½ä»¤</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        cmd <span class=\"token operator\">=</span> mIn<span class=\"token punctuation\">.</span><span class=\"token function\">readInt32</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token function\">IF_LOG_COMMANDS</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            alog <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Processing top-level Command: \"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                 <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">getReturnString</span><span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token function\">pthread_mutex_lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mProcess<span class=\"token operator\">-></span>mThreadCountLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        mProcess<span class=\"token operator\">-></span>mExecutingThreadsCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mProcess<span class=\"token operator\">-></span>mExecutingThreadsCount <span class=\"token operator\">>=</span> mProcess<span class=\"token operator\">-></span>mMaxThreads <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                mProcess<span class=\"token operator\">-></span>mStarvationStartTimeMs <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            mProcess<span class=\"token operator\">-></span>mStarvationStartTimeMs <span class=\"token operator\">=</span> <span class=\"token function\">uptimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token function\">pthread_mutex_unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mProcess<span class=\"token operator\">-></span>mThreadCountLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token comment\">// è§£æå¹¶æ‰§è¡Œå‘½ä»¤</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        result <span class=\"token operator\">=</span> <span class=\"token function\">executeCommand</span><span class=\"token punctuation\">(</span>cmd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token function\">pthread_mutex_lock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mProcess<span class=\"token operator\">-></span>mThreadCountLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        mProcess<span class=\"token operator\">-></span>mExecutingThreadsCount<span class=\"token operator\">--</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mProcess<span class=\"token operator\">-></span>mExecutingThreadsCount <span class=\"token operator\">&lt;</span> mProcess<span class=\"token operator\">-></span>mMaxThreads <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                mProcess<span class=\"token operator\">-></span>mStarvationStartTimeMs <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token keyword\">int64_t</span> starvationTimeMs <span class=\"token operator\">=</span> <span class=\"token function\">uptimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> mProcess<span class=\"token operator\">-></span>mStarvationStartTimeMs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>starvationTimeMs <span class=\"token operator\">></span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                <span class=\"token function\">ALOGE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"binder thread pool (%zu threads) starved for %\"</span> PRId64 <span class=\"token string\">\" ms\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                      mProcess<span class=\"token operator\">-></span>mMaxThreads<span class=\"token punctuation\">,</span> starvationTimeMs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            mProcess<span class=\"token operator\">-></span>mStarvationStartTimeMs <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token comment\">// Cond broadcast can be expensive, so don't send it every time a binder</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token comment\">// call is processed. b/168806193</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mProcess<span class=\"token operator\">-></span>mWaitingForThreads <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token function\">pthread_cond_broadcast</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mProcess<span class=\"token operator\">-></span>mThreadCountDecrement<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token function\">pthread_mutex_unlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>mProcess<span class=\"token operator\">-></span>mThreadCountLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"ipcthreadstateexecutecommand\"><a class=\"anchor\" href=\"#ipcthreadstateexecutecommand\">#</a> IPCThreadState::executeCommand</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\IPCThreadState.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>status_t <span class=\"token class-name\">IPCThreadState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">executeCommand</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int32_t</span> cmd<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span><span class=\"token punctuation\">)</span>cmd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token keyword\">case</span> BR_TRANSACTION<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span>\t<span class=\"token comment\">// å› ä¸ºç›®çš„ç«¯ SM æ‰€ä»¥ tr.target.ptr ä¸º 0</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        \t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tr<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>ptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        \t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        \t<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span><span class=\"token comment\">// å¼€å§‹ä¸šåŠ¡åˆ†å‘</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        \t    error <span class=\"token operator\">=</span> the_context_object<span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>tr<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">,</span> buffer<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>reply<span class=\"token punctuation\">,</span> tr<span class=\"token punctuation\">.</span>flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        \t<span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"ipcthreadstatesetthecontextobject\"><a class=\"anchor\" href=\"#ipcthreadstatesetthecontextobject\">#</a> IPCThreadState::setTheContextObject</h2>\n<p>åœ¨<strong> ServiceManager çš„å¯åŠ¨è¿‡ç¨‹</strong> è¿™èŠ‚çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬è®© ServiceManager æˆä¸ºäº†æ•´ä¸ª binder IPC é€šä¿¡ä¸­çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨å…¨å±€å˜é‡ <code>the_context_object</code>  ä¸­</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\cmds\\servicemanager\\main.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>sp<span class=\"token operator\">&lt;</span>BBinder<span class=\"token operator\">></span> the_context_object<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">IPCThreadState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">setTheContextObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> sp<span class=\"token operator\">&lt;</span>BBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> obj<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    the_context_object <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> argv<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token comment\">// å°† \"manager\" æœåŠ¡ä½œä¸ºæœåŠ¡ç«¯ Bbinder å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token class-name\">IPCThreadState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">setTheContextObject</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token comment\">// å‘ binder é©±åŠ¨å‘é€ ioctl BINDER_SET_CONTEXT_MGR_EXT ä¿¡å·ï¼Œå°† servicemanager</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">// åœ¨ ProcessState::initWithDriver ä¸­æ‰“å¼€é©±åŠ¨è®¾å¤‡ /dev/driver æ‰€è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦å¥æŸ„</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">// ä½œä¸ºæ•´ä¸ª binder IPC é€šä¿¡ä¸­çš„ä¸Šä¸‹æ–‡ç®¡ç†è€…</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    ps<span class=\"token operator\">-></span><span class=\"token function\">becomeContextManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"bbindertransact\"><a class=\"anchor\" href=\"#bbindertransact\">#</a> BBinder::transact</h2>\n<p>æ‰€ä»¥ <code>the_context_object-&gt;transact()</code>  è°ƒç”¨å°±èµ°åˆ°  <code>BBinder</code>  çš„ transact</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\libs\\binder\\Binder.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// NOLINTNEXTLINE(google-default-arguments)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>status_t <span class=\"token class-name\">BBinder</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">uint32_t</span> code<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> Parcel<span class=\"token operator\">&amp;</span> data<span class=\"token punctuation\">,</span> Parcel<span class=\"token operator\">*</span> reply<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint32_t</span> flags<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    data<span class=\"token punctuation\">.</span><span class=\"token function\">setDataPosition</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>reply <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>flags <span class=\"token operator\">&amp;</span> FLAG_CLEAR_BUF<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        reply<span class=\"token operator\">-></span><span class=\"token function\">markSensitive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    status_t err <span class=\"token operator\">=</span> NO_ERROR<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">case</span> PING_TRANSACTION<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            err <span class=\"token operator\">=</span> <span class=\"token function\">pingBinder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">case</span> EXTENSION_TRANSACTION<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            err <span class=\"token operator\">=</span> reply<span class=\"token operator\">-></span><span class=\"token function\">writeStrongBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">getExtension</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">case</span> DEBUG_PID_TRANSACTION<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            err <span class=\"token operator\">=</span> reply<span class=\"token operator\">-></span><span class=\"token function\">writeInt32</span><span class=\"token punctuation\">(</span><span class=\"token function\">getDebugPid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            err <span class=\"token operator\">=</span> <span class=\"token function\">onTransact</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">,</span> reply<span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token comment\">// In case this is being transacted on in the same process.</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>reply <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        reply<span class=\"token operator\">-></span><span class=\"token function\">setDataPosition</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">return</span> err<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"bnservicemanagerontransact\"><a class=\"anchor\" href=\"#bnservicemanagerontransact\">#</a> BnServiceManager::onTransact</h2>\n<p>ç„¶åå›åˆ°äº†è¿™ä¸ª AIDL è‡ªåŠ¨ç”Ÿæˆçš„ IServiceManager.cpp ä¸­ BnServiceManager çš„ onTransact () æ–¹æ³•é‡Œ</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform/out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_arm_armv8-a_shared/gen/aidl/android/os/IServiceManager.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t <span class=\"token class-name\">BnServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">onTransact</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> _aidl_code<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel<span class=\"token operator\">&amp;</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel<span class=\"token operator\">*</span> _aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint32_t</span> _aidl_flags<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>_aidl_code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">case</span> BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_addService<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string in_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span> in_service<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">bool</span> in_allowIsolated<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">int32_t</span> in_dumpPriority<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// æ£€æŸ¥ interface</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">checkInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>BAD_TYPE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// è¯» name</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8FromUtf16</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">// è¯» binder</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readStrongBinder</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_service<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">// è¯» in_allowIsolated</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readBool</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_allowIsolated<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\">// è¯» in_dumpPriority</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readInt32</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_dumpPriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">// è°ƒç”¨çœŸæ­£çš„ ServiceManager.cpp ä¸­çš„å®ç° addService</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token function\">_aidl_status</span><span class=\"token punctuation\">(</span><span class=\"token function\">addService</span><span class=\"token punctuation\">(</span>in_name<span class=\"token punctuation\">,</span> in_service<span class=\"token punctuation\">,</span> in_allowIsolated<span class=\"token punctuation\">,</span> in_dumpPriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">// å¦‚æœæœ‰è¿”å›å†™è¿”å›åˆ° _aidl_reply</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"servicemanageraddservice\"><a class=\"anchor\" href=\"#servicemanageraddservice\">#</a> ServiceManager::addService</h2>\n<p>è¿™é‡Œæ˜¯å’Œ Bp ç«¯æ˜¯å¯¹ç§°çš„æ“ä½œï¼Œä¸‹ä¸€æ­¥èµ°åˆ° ServiceManager.cpp::addService æ–¹æ³•</p>\n<div class=\"note info\">\n<p>QUESTION? ä¸ºä»€ä¹ˆé€šè¿‡ <code>::android::binder::Status _aidl_status(addService(in_name, in_service, in_allowIsolated, in_dumpPriority))</code>  å¯ä»¥è°ƒç”¨åˆ° <code>ServiceManager::addService</code> ?</p>\n</div>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\cmds\\servicemanager\\ServiceManager.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Status <span class=\"token class-name\">ServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">addService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> binder<span class=\"token punctuation\">,</span> <span class=\"token keyword\">bool</span> allowIsolated<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int32_t</span> dumpPriority<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">auto</span> ctx <span class=\"token operator\">=</span> mAccess<span class=\"token operator\">-></span><span class=\"token function\">getCallingContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// apps cannot add services</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">multiuser_get_app_id</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span>uid<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> AID_APP<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Status</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">fromExceptionCode</span><span class=\"token punctuation\">(</span>Status<span class=\"token double-colon punctuation\">::</span>EX_SECURITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mAccess<span class=\"token operator\">-></span><span class=\"token function\">canAdd</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Status</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">fromExceptionCode</span><span class=\"token punctuation\">(</span>Status<span class=\"token double-colon punctuation\">::</span>EX_SECURITY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>binder <span class=\"token operator\">==</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Status</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">fromExceptionCode</span><span class=\"token punctuation\">(</span>Status<span class=\"token double-colon punctuation\">::</span>EX_ILLEGAL_ARGUMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token comment\">// æ£€éªŒ Service åç§°çš„åˆæ³•æ€§ï¼Œåç§°é•¿åº¦è¦æ±‚å¤§äº 0 å¹¶å°äºç­‰äº 127</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token comment\">// å­—ç¬¦ä»…åŒ…æ‹¬ [a-z][A-Z][0-9]_-./</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isValidServiceName</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token function\">LOG</span><span class=\"token punctuation\">(</span>ERROR<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Invalid service name: \"</span> <span class=\"token operator\">&lt;&lt;</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Status</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">fromExceptionCode</span><span class=\"token punctuation\">(</span>Status<span class=\"token double-colon punctuation\">::</span>EX_ILLEGAL_ARGUMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifndef</span> <span class=\"token expression\">VENDORSERVICEMANAGER</span></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">meetsDeclarationRequirements</span><span class=\"token punctuation\">(</span>binder<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">// already logged</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Status</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">fromExceptionCode</span><span class=\"token punctuation\">(</span>Status<span class=\"token double-colon punctuation\">::</span>EX_ILLEGAL_ARGUMENT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span>  <span class=\"token comment\">// !VENDORSERVICEMANAGER</span></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token comment\">// implicitly unlinked when the binder is removed</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\">// ä¸º binder å¯¹è±¡è®¾ç½®æ­»äº¡ä»£ç†</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\tåœ¨å’Œ service è¿›è¡Œäº¤äº’æ—¶ï¼Œservice è¿”å›ä¸€ä¸ª Binder å¯¹è±¡ã€‚</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\tBinder æ˜¯å·¥ä½œåœ¨ service ç«¯ï¼Œå¦‚æœï¼Œç”±äºæŸç§åŸå› ï¼ŒæœåŠ¡ç«¯å‡ºç°æ•…éšœè€Œæ­»äº¡ï¼Œ</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\té‚£ä¹ˆè¯¥è¿”å›çš„ Binder å¯¹è±¡ä¹Ÿå°†æ¶ˆå¤±ï¼Œè¿™æ—¶ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯åœ¨ä½¿ç”¨ Binder å¯¹è±¡</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\tè¿›è¡ŒæŸäº›å‡½æ•°è°ƒç”¨å°†ä¼šå‡ºç°é”™è¯¯ã€‚ä¸ºäº†é¿å…è¯¥æƒ…å†µçš„å‘ç”Ÿï¼Œæˆ‘ä»¬å¯ä»¥ä¸º</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\tBinder å¯¹è±¡è®¾ç½®æ­»äº¡ä»£ç† (linkToDeath)ã€‚å½“å‡ºç°å’ŒæœåŠ¡ç«¯è¿æ¥å‘ç”Ÿæ•…éšœæ—¶ï¼Œ</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tç³»ç»Ÿå°†è‡ªåŠ¨è°ƒç”¨æ­»äº¡ä»£ç†å‡½æ•° binderDied ()ã€‚</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t*/</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>binder<span class=\"token operator\">-></span><span class=\"token function\">remoteBinder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        binder<span class=\"token operator\">-></span><span class=\"token function\">linkToDeath</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">sp</span><span class=\"token operator\">&lt;</span>ServiceManager<span class=\"token operator\">></span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">fromExisting</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> OK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token function\">LOG</span><span class=\"token punctuation\">(</span>ERROR<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Could not linkToDeath when adding \"</span> <span class=\"token operator\">&lt;&lt;</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Status</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">fromExceptionCode</span><span class=\"token punctuation\">(</span>Status<span class=\"token double-colon punctuation\">::</span>EX_ILLEGAL_STATE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token comment\">// Overwrite the old service if it exists</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token comment\">// æ·»åŠ æœåŠ¡ï¼Œä»¥ name ä½œä¸ºç´¢å¼•å€¼ï¼Œä½¿ç”¨ binder ä½œä¸ºå‚æ•°å®ä¾‹åŒ– Service å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    mNameToService<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> Service <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token punctuation\">.</span>binder <span class=\"token operator\">=</span> binder<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token punctuation\">.</span>allowIsolated <span class=\"token operator\">=</span> allowIsolated<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token punctuation\">.</span>dumpPriority <span class=\"token operator\">=</span> dumpPriority<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token punctuation\">.</span>debugPid <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>debugPid<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token comment\">/* æ£€æŸ¥æœåŠ¡æ³¨å†Œçš„åˆæ³•æ€§ï¼ŒåŒ…æ‹¬</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t1. æœåŠ¡æ˜¯å¦å­˜åœ¨</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t2. è¯¥æœåŠ¡æ˜¯å¦æ˜¯æœåŠ¡ç«¯æ³¨å†Œçš„</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t3. æ˜¯å¦æœ‰åŒåæœåŠ¡å­˜åœ¨</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t4. ä¸ºè¯¥æœåŠ¡æ³¨å†Œçš„æ­»äº¡ä»£ç†æ˜¯å¦æˆåŠŸ</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t*/</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token keyword\">auto</span> it <span class=\"token operator\">=</span> mNameToRegistrationCallback<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>it <span class=\"token operator\">!=</span> mNameToRegistrationCallback<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> sp<span class=\"token operator\">&lt;</span>IServiceCallback<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> cb <span class=\"token operator\">:</span> it<span class=\"token operator\">-></span>second<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            mNameToService<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>guaranteeClient <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            <span class=\"token comment\">// permission checked in registerForNotifications</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            cb<span class=\"token operator\">-></span><span class=\"token function\">onRegistration</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> binder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Status</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"æ€»ç»“-3\"><a class=\"anchor\" href=\"#æ€»ç»“-3\">#</a> æ€»ç»“</h2>\n<p>Server æƒ³è¦å‘ ServiceManager æ³¨å†ŒæœåŠ¡ï¼Œé¦–å…ˆé€šè¿‡ <code>defaultServiceManager</code>  è·å–åˆ°ä¸€ä¸ª Service Manager çš„ä»£ç†å¯¹è±¡ï¼Œç„¶åå†è°ƒç”¨å®ƒçš„æˆå‘˜å‡½æ•° <code>addService</code>  å°†è¯¥ Service ç»„ä»¶æ³¨å†Œåˆ° Service Manager ä¸­ï¼Œè¯¥ä»£ç†å¯¹è±¡é€šè¿‡å‘ Binder é©±åŠ¨è®¾å¤‡å‘é€ <code>BC_TRANSACTION</code>  ä¿¡å·å’Œ <code>Service Manager</code>  é€šä¿¡ï¼Œåœ¨ <code>Service Manager</code>  å¯åŠ¨ä¹‹åä¼šè¿›å…¥ä¸€ä¸ªé˜»å¡çš„æ— é™å¾ªç¯ï¼Œ <code>Service Manager</code>  é€šè¿‡ <code>BinderCallback</code>  å›è°ƒå‡½æ•°å¤„ç† Binder é©±åŠ¨è®¾å¤‡è¿”å›çš„ <code>BR_TRANSACTION</code> , è°ƒç”¨ BBinder çš„ transact æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°†ä¼šæŠŠæˆ‘ä»¬å¼•åˆ° BnServiceManager çš„ onTransact () æ–¹æ³•ï¼Œç»ˆäºè¿™ä¸ªæ–¹æ³•å°†æˆ‘ä»¬å¸¦åˆ°äº†çœŸæ­£æ·»åŠ æœåŠ¡çš„æ–¹æ³•<strong> ServiceManager.cpp::addService</strong>, å¹¶å‘ <code>mNameToService</code>  å­—å…¸ä¸­æ·»åŠ  <code>name: Service</code>  çš„é”®å€¼å¯¹ï¼Œæ¥ä¸º Client å‘ ServiceManager è·å–æœåŠ¡çš„è¿‡ç¨‹åšæ•°æ®å‡†å¤‡.</p>\n<p><img data-src=\"/android-binder/1595250-20211114151811263-2017459210.png\" alt=\"img\" style=\"aspect-ratio:1241 / 601;\"></p>\n<h1 id=\"clientå‘servicemanagerè·å–æœåŠ¡\"><a class=\"anchor\" href=\"#clientå‘servicemanagerè·å–æœåŠ¡\">#</a> Client å‘ ServiceManager è·å–æœåŠ¡</h1>\n<p>è¿™é‡Œä»¥ <code>MediaServer</code>  ä¸ºä¾‹æ¥åˆ†æ Client å‘ ServiceManager è·å–æœåŠ¡çš„è¿‡ç¨‹</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// android-platform\\frameworks\\av\\media\\libmedia\\IMediaDeathNotifier.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// establish binder interface to MediaPlayerService</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/*static*/</span><span class=\"token keyword\">const</span> sp<span class=\"token operator\">&lt;</span>IMediaPlayerService<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">IMediaDeathNotifier</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getMediaPlayerService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">ALOGV</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getMediaPlayerService\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    Mutex<span class=\"token double-colon punctuation\">::</span>Autolock <span class=\"token function\">_l</span><span class=\"token punctuation\">(</span>sServiceLock<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sMediaPlayerService <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        sp<span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span> sm <span class=\"token operator\">=</span> <span class=\"token function\">defaultServiceManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> binder<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            binder <span class=\"token operator\">=</span> sm<span class=\"token operator\">-></span><span class=\"token function\">getService</span><span class=\"token punctuation\">(</span><span class=\"token function\">String16</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"media.player\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// æ ¸å¿ƒå‡½æ•°ï¼Œè·å–åä¸º media.player çš„æœåŠ¡ï¼Œå› ä¸ºåœ¨ä¹‹å‰ Server å·²ç»å‘ ServiceManager æ³¨å†Œè¿‡äº†</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>binder <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token function\">ALOGW</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Media player service not published, waiting...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token function\">usleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">500000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 0.5 s ä¸€ä¸ªæ— é™å¾ªç¯æ¯ 0.5 ç§’å°±è·å–ä¸€æ¬¡æœåŠ¡ï¼ŒçŸ¥é“è·å–åˆ°æƒé™</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sDeathNotifier <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            sDeathNotifier <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token function\">DeathNotifier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//Service æ­»äº¡ååˆ›å»ºæ­»äº¡é€šçŸ¥</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        binder<span class=\"token operator\">-></span><span class=\"token function\">linkToDeath</span><span class=\"token punctuation\">(</span>sDeathNotifier<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        sMediaPlayerService <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">interface_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>IMediaPlayerService<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>binder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token function\">ALOGE_IF</span><span class=\"token punctuation\">(</span>sMediaPlayerService <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"no media player service!?\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">return</span> sMediaPlayerService<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"servicemanagershimgetservice\"><a class=\"anchor\" href=\"#servicemanagershimgetservice\">#</a> ServiceManagerShim::getService</h2>\n<p>è¿™é‡Œè°ƒç”¨ <code>ServiceManagerShim::checkService</code>  æ¥å¯»æ‰¾ä»¥æ³¨å†Œçš„æœåŠ¡</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\frameworks\\native\\libs\\binder\\IServiceManager.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// This implementation could be simplified and made more efficient by delegating</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// to waitForService. However, this changes the threading structure in some</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// cases and could potentially break prebuilts. Once we have higher logistical</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// complexity, this could be attempted.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> <span class=\"token class-name\">ServiceManagerShim</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> String16<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">static</span> <span class=\"token keyword\">bool</span> gSystemBootCompleted <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> svc <span class=\"token operator\">=</span> <span class=\"token function\">checkService</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// æ£€æŸ¥ä¸€ä¸‹æŒ‡å®šçš„æœåŠ¡åç§°æ˜¯å¦å­˜åœ¨</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>svc <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> svc<span class=\"token punctuation\">;</span><span class=\"token comment\">// æ‰¾åˆ°äº† ç›´æ¥è¿”å›</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">//verder è¿›ç¨‹æœåŠ¡è·å–é€»è¾‘ï¼Œè¿™é‡Œä¸åšåˆ†æ</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token keyword\">bool</span> isVendorService <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">getDriverName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/dev/vndbinder\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">constexpr</span> <span class=\"token keyword\">int64_t</span> timeout <span class=\"token operator\">=</span> <span class=\"token number\">5000</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">int64_t</span> startTime <span class=\"token operator\">=</span> <span class=\"token function\">uptimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">// Vendor code can't access system properties</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>gSystemBootCompleted <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>isVendorService<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifdef</span> <span class=\"token expression\">__ANDROID__</span></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">char</span> bootCompleted<span class=\"token punctuation\">[</span>PROPERTY_VALUE_MAX<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token function\">property_get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sys.boot_completed\"</span><span class=\"token punctuation\">,</span> bootCompleted<span class=\"token punctuation\">,</span> <span class=\"token string\">\"0\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        gSystemBootCompleted <span class=\"token operator\">=</span> <span class=\"token function\">strcmp</span><span class=\"token punctuation\">(</span>bootCompleted<span class=\"token punctuation\">,</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> <span class=\"token boolean\">true</span> <span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        gSystemBootCompleted <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\">// retry interval in millisecond; note that vendor services stay at 100ms</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">const</span> useconds_t sleepTime <span class=\"token operator\">=</span> gSystemBootCompleted <span class=\"token operator\">?</span> <span class=\"token number\">1000</span> <span class=\"token operator\">:</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token function\">ALOGI</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Waiting for service '%s' on '%s'...\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">String8</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          <span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">getDriverName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">int</span> n <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token function\">uptimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startTime <span class=\"token operator\">&lt;</span> timeout<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        n<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token function\">usleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token operator\">*</span>sleepTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> svc <span class=\"token operator\">=</span> <span class=\"token function\">checkService</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>svc <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token function\">ALOGI</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Waiting for service '%s' on '%s' successful after waiting %\"</span> PRIi64 <span class=\"token string\">\"ms\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                  <span class=\"token function\">String8</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">ProcessState</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">self</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">getDriverName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                  <span class=\"token function\">uptimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startTime<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token keyword\">return</span> svc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token function\">ALOGW</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Service %s didn't start. Returning NULL\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">String8</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"servicemanagershimcheckservice\"><a class=\"anchor\" href=\"#servicemanagershimcheckservice\">#</a> ServiceManagerShim::checkService</h2>\n<p>è¿™é‡Œå’Œ<a href=\"#Server%E5%90%91ServiceManager%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1\"> Server å‘ ServiceManager æ³¨å†ŒæœåŠ¡</a>ä¸€èŠ‚å¼€å¤´ä¸­çš„å½¢å¼ä¸€æ ·ï¼Œä¹Ÿæ˜¯é€šè¿‡ <code>mTheRealServiceManager</code>  æ¥æ‰§è¡Œæ ¸å¿ƒçš„è·å–æœåŠ¡é€»è¾‘ï¼Œå¯¹è¯¥å˜é‡çš„èµ‹å€¼äºåˆ†æå¯å‚é˜…<a href=\"##mTheRealServiceManager\"> mTheRealServiceManager</a></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> <span class=\"token class-name\">ServiceManagerShim</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">checkService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> String16<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mTheRealServiceManager<span class=\"token operator\">-></span><span class=\"token function\">checkService</span><span class=\"token punctuation\">(</span><span class=\"token function\">String8</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"bpservicemanagercheckservice\"><a class=\"anchor\" href=\"#bpservicemanagercheckservice\">#</a> BpServiceManager::checkService</h2>\n<p>åŒæ ·çš„ï¼Œæˆ‘ä»¬éœ€è¦ä»å®‰å“æ¡†æ¶ç¼–è¯‘ä¹‹åçš„è¾“å…¥æ–‡ä»¶ä¸­æ‰¾åˆ°ç”±æ¨¡æ¿ aidl ç”Ÿæˆçš„ <code>IServiceManager.cpp</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">///android-platform/out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_arm64_armv8-a_shared/gen/aidl/android/os/IServiceManager.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">checkService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">*</span> _aidl_return<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">markForBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">remoteStrong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_reply<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">//1. å†™ interface</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInterfaceToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">//2. å°†è¦æŸ¥è¯¢çš„ Service name å†™å…¥</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8AsUtf16</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token comment\">// å€ŸåŠ© BpBinder (0)#transact æ¥å‘èµ· Binder é€šä¿¡</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_checkService<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">UNLIKELY</span><span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNKNOWN_TRANSACTION <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">checkService</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> _aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">readFromParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token punctuation\">.</span><span class=\"token function\">readNullableStrongBinder</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  _aidl_error<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">setFromStatusT</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"bnservicemanagerontransact-2\"><a class=\"anchor\" href=\"#bnservicemanagerontransact-2\">#</a> BnServiceManager::onTransact</h2>\n<p>ä¸ <code>Serverå‘ServiceManageræ³¨å†ŒæœåŠ¡</code> ä¸­ç›¸ç±»ä¼¼ï¼Œ <code>BpBinder(0)#transact</code>  æ¥å‘èµ· Binder é€šä¿¡åï¼ŒBinderCallback å¤„ç† Binder é©±åŠ¨å‘é€çš„ <code>BR_TRANSACTION</code>  ä¿¡å·ï¼Œå¹¶äº¤ç”± <code>IPCThreadState::self()-&gt;handlePolledCommands()</code>  æ¥å¤„ç†å‘½ä»¤ï¼Œæœ€ç»ˆæ¥åˆ°ç”± aidl ç”Ÿæˆçš„ <code>aidl/android/os/IServiceManager.cpp</code>  çš„ <code>BnServiceManager::onTransact</code>  å»æ‰§è¡Œå‘½ä»¤ï¼Œä¸ ServiceManager é€šè¿‡ Binder é€šä¿¡</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t <span class=\"token class-name\">BnServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">onTransact</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> _aidl_code<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel<span class=\"token operator\">&amp;</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel<span class=\"token operator\">*</span> _aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint32_t</span> _aidl_flags<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>_aidl_code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">case</span> BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_checkService<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string in_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span> _aidl_return<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">checkInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>BAD_TYPE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token comment\">// å†™å…¥è¦æŸ¥è¯¢çš„åç§°</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8FromUtf16</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token comment\">// è°ƒç”¨çœŸæ­£çš„ ServiceManager.cpp ä¸­çš„å®ç° addService</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token function\">_aidl_status</span><span class=\"token punctuation\">(</span><span class=\"token function\">checkService</span><span class=\"token punctuation\">(</span>in_name<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token operator\">-></span><span class=\"token function\">writeStrongBinder</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNEXPECTED_NULL<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Status</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">fromExceptionCode</span><span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status<span class=\"token double-colon punctuation\">::</span>EX_NULL_POINTER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_ret_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"servicemanagercheckservice\"><a class=\"anchor\" href=\"#servicemanagercheckservice\">#</a> ServiceManager::checkService</h2>\n<p>åŒæ ·å’Œ Bp ç«¯æ˜¯å¯¹ç§°çš„æ“ä½œï¼Œä¸‹ä¸€æ­¥èµ°åˆ° ServiceManager.cpp::checkService æ–¹æ³•ä¸­</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\cmds\\servicemanager\\ServiceManager.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Status <span class=\"token class-name\">ServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">checkService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">*</span> outBinder<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token operator\">*</span>outBinder <span class=\"token operator\">=</span> <span class=\"token function\">tryGetService</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// returns ok regardless of result for legacy reasons</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Status</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"servicemanagertrygetservice\"><a class=\"anchor\" href=\"#servicemanagertrygetservice\">#</a> ServiceManager::tryGetService</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\cmds\\servicemanager\\ServiceManager.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> <span class=\"token class-name\">ServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">tryGetService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">bool</span> startIfNotFound<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">auto</span> ctx <span class=\"token operator\">=</span> mAccess<span class=\"token operator\">-></span><span class=\"token function\">getCallingContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span> out<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    Service<span class=\"token operator\">*</span> service <span class=\"token operator\">=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\">// è°ƒç”¨ mNameToService.find åˆ©ç”¨ id æŸ¥æ‰¾ Service</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span> it <span class=\"token operator\">=</span> mNameToService<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> it <span class=\"token operator\">!=</span> mNameToService<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        service <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>it<span class=\"token operator\">-></span>second<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>service<span class=\"token operator\">-></span>allowIsolated<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            uid_t appid <span class=\"token operator\">=</span> <span class=\"token function\">multiuser_get_app_id</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">.</span>uid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token keyword\">bool</span> isIsolated <span class=\"token operator\">=</span> appid <span class=\"token operator\">>=</span> AID_ISOLATED_START <span class=\"token operator\">&amp;&amp;</span> appid <span class=\"token operator\">&lt;=</span> AID_ISOLATED_END<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isIsolated<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token keyword\">return</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        out <span class=\"token operator\">=</span> service<span class=\"token operator\">-></span>binder<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>mAccess<span class=\"token operator\">-></span><span class=\"token function\">canFind</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token comment\">// å¦‚æœ Service æ²¡æœ‰å¯åŠ¨çš„è¯å°±å°è¯•å¯åŠ¨ Servicve</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>out <span class=\"token operator\">&amp;&amp;</span> startIfNotFound<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">tryStartService</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token comment\">// Setting this guarantee each time we hand out a binder ensures that the client-checking</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token comment\">// loop knows about the event even if the client immediately drops the service</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        service<span class=\"token operator\">-></span>guaranteeClient <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">return</span> out<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è€Œå€˜è‹¥æˆ‘ä»¬æ·±ç©¶ <code>mNameToService</code> , å®ƒå¯ä»¥åœ¨ <code>ServiceManager.h</code>  æ‰¾åˆ°å®šä¹‰</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform/frameworks/native/libs/fakeservicemanager/ServiceManager.h</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">ServiceManager</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">IServiceManager</span></span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">public</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">private</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>map<span class=\"token operator\">&lt;</span>String16<span class=\"token punctuation\">,</span> sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">>></span> mNameToService<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  <span class=\"token comment\">// namespace android</span></pre></td></tr></table></figure><p>è¿™æ ·ä¸€çœ‹åŸæ¥æŸ¥æ‰¾çš„è¿‡ç¨‹å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ä¸€ä¸ª map å­—å…¸é‡Œæ‰¾æ‰¾æ˜¯å¦å«æœ‰è¿™ä¸ªé”®ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œå°±æ˜¯æŸ¥æ‰¾æˆåŠŸäº†å¹¶ä¸”è¿”å› <code>IBinder</code>  ç±»å‹çš„å€¼ï¼Œæ·»åŠ å‘å­—å…¸ä¸­æ·»åŠ é”®å€¼çš„è¿‡ç¨‹å…¶å®å·²ç»åœ¨æ³¨å†ŒæœåŠ¡çš„æ—¶å€™åšå¥½äº†</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\frameworks\\native\\cmds\\servicemanager\\ServiceManager.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Status <span class=\"token class-name\">ServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">addService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> sp<span class=\"token operator\">&lt;</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> binder<span class=\"token punctuation\">,</span> <span class=\"token keyword\">bool</span> allowIsolated<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int32_t</span> dumpPriority<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// Overwrite the old service if it exists</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// æ·»åŠ æœåŠ¡ï¼Œä»¥ name ä½œä¸ºç´¢å¼•å€¼ï¼Œä½¿ç”¨ binder ä½œä¸ºå‚æ•°å®ä¾‹åŒ– Service å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    mNameToService<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> Service <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">.</span>binder <span class=\"token operator\">=</span> binder<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">.</span>allowIsolated <span class=\"token operator\">=</span> allowIsolated<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">.</span>dumpPriority <span class=\"token operator\">=</span> dumpPriority<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">.</span>debugPid <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>debugPid<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token comment\">/* æ£€æŸ¥æœåŠ¡æ³¨å†Œçš„åˆæ³•æ€§ï¼ŒåŒ…æ‹¬</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t1. æœåŠ¡æ˜¯å¦å­˜åœ¨</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t2. è¯¥æœåŠ¡æ˜¯å¦æ˜¯æœåŠ¡ç«¯æ³¨å†Œçš„</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t3. æ˜¯å¦æœ‰åŒåæœåŠ¡å­˜åœ¨</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t4. ä¸ºè¯¥æœåŠ¡æ³¨å†Œçš„æ­»äº¡ä»£ç†æ˜¯å¦æˆåŠŸ</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t*/</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">auto</span> it <span class=\"token operator\">=</span> mNameToRegistrationCallback<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>it <span class=\"token operator\">!=</span> mNameToRegistrationCallback<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> sp<span class=\"token operator\">&lt;</span>IServiceCallback<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> cb <span class=\"token operator\">:</span> it<span class=\"token operator\">-></span>second<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            mNameToService<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>guaranteeClient <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token comment\">// permission checked in registerForNotifications</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            cb<span class=\"token operator\">-></span><span class=\"token function\">onRegistration</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> binder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Status</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"æ€»ç»“-4\"><a class=\"anchor\" href=\"#æ€»ç»“-4\">#</a> æ€»ç»“</h2>\n<p>Client å‘ ServiceManager è·å–æœåŠ¡çš„è¿‡ç¨‹å…¶å®å¾ˆç®€å•ï¼Œä¸»è¦å°±æ˜¯ä¸€ä¸ª map å­—å…¸æŸ¥è¯¢çš„è¿‡ç¨‹ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒClient ä¸ ServiceManager çš„é€šä¿¡ä¹Ÿæ˜¯é€šè¿‡ Binder é©±åŠ¨è¿›è¡Œçš„</p>\n<h1 id=\"é™„å½•\"><a class=\"anchor\" href=\"#é™„å½•\">#</a> é™„å½•</h1>\n<h2 id=\"å®‰å“ç³»ç»Ÿç¼–è¯‘åç”±aidlç”Ÿæˆçš„iservicemanagercpp\"><a class=\"anchor\" href=\"#å®‰å“ç³»ç»Ÿç¼–è¯‘åç”±aidlç”Ÿæˆçš„iservicemanagercpp\">#</a> å®‰å“ç³»ç»Ÿç¼–è¯‘åç”± aidl ç”Ÿæˆçš„ IServiceManager.cpp</h2>\n<p>ç¼–è¯‘ç³»ç»Ÿç‰ˆæœ¬:  <code>android-12.0.0_r34</code></p>\n<p><code>platform/out/soong/.intermediates/frameworks/native/libs/binder/libbinder/android_arm64_armv8-a_shared/gen/aidl/android/os/IServiceManager.cpp</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;android/os/IServiceManager.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;android/os/BpServiceManager.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">namespace</span> android <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">namespace</span> os <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">DO_NOT_DIRECTLY_USE_ME_IMPLEMENT_META_INTERFACE</span><span class=\"token punctuation\">(</span>ServiceManager<span class=\"token punctuation\">,</span> <span class=\"token string\">\"android.os.IServiceManager\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  <span class=\"token comment\">// namespace os</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  <span class=\"token comment\">// namespace android</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;android/os/BpServiceManager.h></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;android/os/BnServiceManager.h></span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;binder/Parcel.h></span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;android-base/macros.h></span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">namespace</span> android <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">namespace</span> os <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">BpServiceManager</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> _aidl_impl<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token operator\">:</span> <span class=\"token generic-function\"><span class=\"token function\">BpInterface</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>IServiceManager<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>_aidl_impl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">*</span> _aidl_return<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">markForBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">remoteStrong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_reply<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInterfaceToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8AsUtf16</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_getService<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">UNLIKELY</span><span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNKNOWN_TRANSACTION <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">getService</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> _aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">readFromParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token punctuation\">.</span><span class=\"token function\">readNullableStrongBinder</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  _aidl_error<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">setFromStatusT</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">checkService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">*</span> _aidl_return<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">markForBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">remoteStrong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_reply<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInterfaceToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8AsUtf16</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_checkService<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">UNLIKELY</span><span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNKNOWN_TRANSACTION <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">checkService</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> _aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">readFromParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token punctuation\">.</span><span class=\"token function\">readNullableStrongBinder</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  _aidl_error<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">setFromStatusT</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">addService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> service<span class=\"token punctuation\">,</span> <span class=\"token keyword\">bool</span> allowIsolated<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int32_t</span> dumpPriority<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">markForBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">remoteStrong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_reply<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInterfaceToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8AsUtf16</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeStrongBinder</span><span class=\"token punctuation\">(</span>service<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeBool</span><span class=\"token punctuation\">(</span>allowIsolated<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInt32</span><span class=\"token punctuation\">(</span>dumpPriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_addService<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">UNLIKELY</span><span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNKNOWN_TRANSACTION <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">addService</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> service<span class=\"token punctuation\">,</span> allowIsolated<span class=\"token punctuation\">,</span> dumpPriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">readFromParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>  _aidl_error<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>  _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">setFromStatusT</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre></pre></td></tr><tr><td data-num=\"145\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">listServices</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int32_t</span> dumpPriority<span class=\"token punctuation\">,</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">></span><span class=\"token operator\">*</span> _aidl_return<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>  _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">markForBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">remoteStrong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_reply<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInterfaceToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInt32</span><span class=\"token punctuation\">(</span>dumpPriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_listServices<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">UNLIKELY</span><span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNKNOWN_TRANSACTION <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">listServices</span><span class=\"token punctuation\">(</span>dumpPriority<span class=\"token punctuation\">,</span> _aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">readFromParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>    <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8VectorFromUtf16Vector</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>  _aidl_error<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>  _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">setFromStatusT</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre></pre></td></tr><tr><td data-num=\"182\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">registerForNotifications</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>os<span class=\"token double-colon punctuation\">::</span>IServiceCallback<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>  _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">markForBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">remoteStrong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_reply<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInterfaceToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8AsUtf16</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeStrongBinder</span><span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>os<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">IServiceCallback</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">asBinder</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_registerForNotifications<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">UNLIKELY</span><span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNKNOWN_TRANSACTION <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">registerForNotifications</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">readFromParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>    <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>  _aidl_error<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>  _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">setFromStatusT</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre></pre></td></tr><tr><td data-num=\"219\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">unregisterForNotifications</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>os<span class=\"token double-colon punctuation\">::</span>IServiceCallback<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>  _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">markForBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">remoteStrong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_reply<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInterfaceToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8AsUtf16</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeStrongBinder</span><span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>os<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">IServiceCallback</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">asBinder</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_unregisterForNotifications<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">UNLIKELY</span><span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNKNOWN_TRANSACTION <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">unregisterForNotifications</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">readFromParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>    <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>  _aidl_error<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>  _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">setFromStatusT</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre></pre></td></tr><tr><td data-num=\"256\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">isDeclared</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">bool</span><span class=\"token operator\">*</span> _aidl_return<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>  _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">markForBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">remoteStrong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_reply<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInterfaceToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8AsUtf16</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_isDeclared<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">UNLIKELY</span><span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNKNOWN_TRANSACTION <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">isDeclared</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> _aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">readFromParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>    <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"284\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token punctuation\">.</span><span class=\"token function\">readBool</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"286\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"288\"></td><td><pre>  _aidl_error<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>  _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">setFromStatusT</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"290\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"291\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre></pre></td></tr><tr><td data-num=\"293\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDeclaredInstances</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> iface<span class=\"token punctuation\">,</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">></span><span class=\"token operator\">*</span> _aidl_return<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre>  _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">markForBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">remoteStrong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"296\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_reply<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"297\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInterfaceToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"303\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8AsUtf16</span><span class=\"token punctuation\">(</span>iface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"305\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"307\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_getDeclaredInstances<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">UNLIKELY</span><span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNKNOWN_TRANSACTION <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"309\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">getDeclaredInstances</span><span class=\"token punctuation\">(</span>iface<span class=\"token punctuation\">,</span> _aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"311\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"312\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"314\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">readFromParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"315\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"316\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"317\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"318\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"319\"></td><td><pre>    <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"321\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8VectorFromUtf16Vector</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"322\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"323\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"324\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"325\"></td><td><pre>  _aidl_error<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"326\"></td><td><pre>  _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">setFromStatusT</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"327\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"328\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"329\"></td><td><pre></pre></td></tr><tr><td data-num=\"330\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">updatableViaApex</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>optional<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">></span><span class=\"token operator\">*</span> _aidl_return<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"331\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"332\"></td><td><pre>  _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">markForBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">remoteStrong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"333\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_reply<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"334\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"335\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"336\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInterfaceToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"337\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"338\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"339\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"340\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8AsUtf16</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"341\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"342\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"343\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"344\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_updatableViaApex<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"345\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">UNLIKELY</span><span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNKNOWN_TRANSACTION <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"346\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">updatableViaApex</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> _aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"347\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"348\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"349\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"350\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"351\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">readFromParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"352\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"353\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"354\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"355\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"356\"></td><td><pre>    <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"357\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"358\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8FromUtf16</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"359\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"360\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"361\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"362\"></td><td><pre>  _aidl_error<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"363\"></td><td><pre>  _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">setFromStatusT</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"364\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"365\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"366\"></td><td><pre></pre></td></tr><tr><td data-num=\"367\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">registerClientCallback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> service<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>os<span class=\"token double-colon punctuation\">::</span>IClientCallback<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"368\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"369\"></td><td><pre>  _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">markForBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">remoteStrong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"370\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_reply<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"371\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"372\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"373\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInterfaceToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"374\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"375\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"376\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"377\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8AsUtf16</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"378\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"379\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"380\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"381\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeStrongBinder</span><span class=\"token punctuation\">(</span>service<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"382\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"383\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"384\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"385\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeStrongBinder</span><span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>os<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">IClientCallback</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">asBinder</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"386\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"387\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"388\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"389\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_registerClientCallback<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"390\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">UNLIKELY</span><span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNKNOWN_TRANSACTION <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"391\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">registerClientCallback</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> service<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"392\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"393\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"394\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"395\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"396\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">readFromParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"397\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"398\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"399\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"400\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"401\"></td><td><pre>    <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"402\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"403\"></td><td><pre>  _aidl_error<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"404\"></td><td><pre>  _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">setFromStatusT</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"405\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"406\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"407\"></td><td><pre></pre></td></tr><tr><td data-num=\"408\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">tryUnregisterService</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> service<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"409\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"410\"></td><td><pre>  _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">markForBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">remoteStrong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"411\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_reply<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"412\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"413\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"414\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInterfaceToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"415\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"416\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"417\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"418\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8AsUtf16</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"419\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"420\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"421\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"422\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeStrongBinder</span><span class=\"token punctuation\">(</span>service<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"423\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"424\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"425\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"426\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_tryUnregisterService<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"427\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">UNLIKELY</span><span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNKNOWN_TRANSACTION <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"428\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">tryUnregisterService</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> service<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"429\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"430\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"431\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"432\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"433\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">readFromParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"434\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"435\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"436\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"437\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"438\"></td><td><pre>    <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"439\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"440\"></td><td><pre>  _aidl_error<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"441\"></td><td><pre>  _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">setFromStatusT</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"442\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"443\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"444\"></td><td><pre></pre></td></tr><tr><td data-num=\"445\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token class-name\">BpServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getServiceDebugInfo</span><span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>os<span class=\"token double-colon punctuation\">::</span>ServiceDebugInfo<span class=\"token operator\">></span><span class=\"token operator\">*</span> _aidl_return<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"446\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_data<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"447\"></td><td><pre>  _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">markForBinder</span><span class=\"token punctuation\">(</span><span class=\"token function\">remoteStrong</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"448\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel _aidl_reply<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"449\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"450\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"451\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">writeInterfaceToken</span><span class=\"token punctuation\">(</span><span class=\"token function\">getInterfaceDescriptor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"452\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"453\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"454\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"455\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token function\">remote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">transact</span><span class=\"token punctuation\">(</span>BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_getServiceDebugInfo<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"456\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">UNLIKELY</span><span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNKNOWN_TRANSACTION <span class=\"token operator\">&amp;&amp;</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"457\"></td><td><pre>     <span class=\"token keyword\">return</span> <span class=\"token class-name\">IServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">getDefaultImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">getServiceDebugInfo</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"458\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"459\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"460\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"461\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"462\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">readFromParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"463\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"464\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"465\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"466\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"467\"></td><td><pre>    <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"468\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"469\"></td><td><pre>  _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token punctuation\">.</span><span class=\"token function\">readParcelableVector</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"470\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"471\"></td><td><pre>    <span class=\"token keyword\">goto</span> _aidl_error<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"472\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"473\"></td><td><pre>  _aidl_error<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"474\"></td><td><pre>  _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">setFromStatusT</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"475\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"476\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"477\"></td><td><pre></pre></td></tr><tr><td data-num=\"478\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  <span class=\"token comment\">// namespace os</span></pre></td></tr><tr><td data-num=\"479\"></td><td><pre></pre></td></tr><tr><td data-num=\"480\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  <span class=\"token comment\">// namespace android</span></pre></td></tr><tr><td data-num=\"481\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;android/os/BnServiceManager.h></span></span></pre></td></tr><tr><td data-num=\"482\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;binder/Parcel.h></span></span></pre></td></tr><tr><td data-num=\"483\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;binder/Stability.h></span></span></pre></td></tr><tr><td data-num=\"484\"></td><td><pre></pre></td></tr><tr><td data-num=\"485\"></td><td><pre><span class=\"token keyword\">namespace</span> android <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"486\"></td><td><pre></pre></td></tr><tr><td data-num=\"487\"></td><td><pre><span class=\"token keyword\">namespace</span> os <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"488\"></td><td><pre></pre></td></tr><tr><td data-num=\"489\"></td><td><pre><span class=\"token class-name\">BnServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">BnServiceManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"490\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"491\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>internal<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Stability</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">markCompilationUnit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"492\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"493\"></td><td><pre></pre></td></tr><tr><td data-num=\"494\"></td><td><pre><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t <span class=\"token class-name\">BnServiceManager</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">onTransact</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> _aidl_code<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel<span class=\"token operator\">&amp;</span> _aidl_data<span class=\"token punctuation\">,</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>Parcel<span class=\"token operator\">*</span> _aidl_reply<span class=\"token punctuation\">,</span> <span class=\"token keyword\">uint32_t</span> _aidl_flags<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"495\"></td><td><pre>  <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>status_t _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"496\"></td><td><pre>  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>_aidl_code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"497\"></td><td><pre>  <span class=\"token keyword\">case</span> BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_getService<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"498\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"499\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string in_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"500\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span> _aidl_return<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"501\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">checkInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"502\"></td><td><pre>      _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>BAD_TYPE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"503\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"504\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"505\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8FromUtf16</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"506\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"507\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"508\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"509\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token function\">_aidl_status</span><span class=\"token punctuation\">(</span><span class=\"token function\">getService</span><span class=\"token punctuation\">(</span>in_name<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"510\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"511\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"512\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"513\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"514\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"515\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"516\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"517\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token operator\">-></span><span class=\"token function\">writeStrongBinder</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"518\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"519\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"520\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"521\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"522\"></td><td><pre>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"523\"></td><td><pre>  <span class=\"token keyword\">case</span> BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_checkService<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"524\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"525\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string in_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"526\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span> _aidl_return<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"527\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">checkInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"528\"></td><td><pre>      _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>BAD_TYPE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"529\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"530\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"531\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8FromUtf16</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"532\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"533\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"534\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"535\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token function\">_aidl_status</span><span class=\"token punctuation\">(</span><span class=\"token function\">checkService</span><span class=\"token punctuation\">(</span>in_name<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"536\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"537\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"538\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"539\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"540\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"541\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"542\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"543\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token operator\">-></span><span class=\"token function\">writeStrongBinder</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"544\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"545\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"546\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"547\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"548\"></td><td><pre>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"549\"></td><td><pre>  <span class=\"token keyword\">case</span> BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_addService<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"550\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"551\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string in_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"552\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span> in_service<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"553\"></td><td><pre>    <span class=\"token keyword\">bool</span> in_allowIsolated<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"554\"></td><td><pre>    <span class=\"token keyword\">int32_t</span> in_dumpPriority<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"555\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">checkInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"556\"></td><td><pre>      _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>BAD_TYPE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"557\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"558\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"559\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8FromUtf16</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"560\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"561\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"562\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"563\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readStrongBinder</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_service<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"564\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"565\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"566\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"567\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readBool</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_allowIsolated<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"568\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"569\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"570\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"571\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readInt32</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_dumpPriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"572\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"573\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"574\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"575\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token function\">_aidl_status</span><span class=\"token punctuation\">(</span><span class=\"token function\">addService</span><span class=\"token punctuation\">(</span>in_name<span class=\"token punctuation\">,</span> in_service<span class=\"token punctuation\">,</span> in_allowIsolated<span class=\"token punctuation\">,</span> in_dumpPriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"576\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"577\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"578\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"579\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"580\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"581\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"582\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"583\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"584\"></td><td><pre>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"585\"></td><td><pre>  <span class=\"token keyword\">case</span> BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_listServices<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"586\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"587\"></td><td><pre>    <span class=\"token keyword\">int32_t</span> in_dumpPriority<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"588\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">></span> _aidl_return<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"589\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">checkInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"590\"></td><td><pre>      _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>BAD_TYPE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"591\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"592\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"593\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readInt32</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_dumpPriority<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"594\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"595\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"596\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"597\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token function\">_aidl_status</span><span class=\"token punctuation\">(</span><span class=\"token function\">listServices</span><span class=\"token punctuation\">(</span>in_dumpPriority<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"598\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"599\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"600\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"601\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"602\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"603\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"604\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"605\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token operator\">-></span><span class=\"token function\">writeUtf8VectorAsUtf16Vector</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"606\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"607\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"608\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"609\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"610\"></td><td><pre>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"611\"></td><td><pre>  <span class=\"token keyword\">case</span> BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_registerForNotifications<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"612\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"613\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string in_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"614\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>os<span class=\"token double-colon punctuation\">::</span>IServiceCallback<span class=\"token operator\">></span> in_callback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"615\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">checkInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"616\"></td><td><pre>      _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>BAD_TYPE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"617\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"618\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"619\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8FromUtf16</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"620\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"621\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"622\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"623\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readStrongBinder</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"624\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"625\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"626\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"627\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token function\">_aidl_status</span><span class=\"token punctuation\">(</span><span class=\"token function\">registerForNotifications</span><span class=\"token punctuation\">(</span>in_name<span class=\"token punctuation\">,</span> in_callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"628\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"629\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"630\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"631\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"632\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"633\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"634\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"635\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"636\"></td><td><pre>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"637\"></td><td><pre>  <span class=\"token keyword\">case</span> BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_unregisterForNotifications<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"638\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"639\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string in_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"640\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>os<span class=\"token double-colon punctuation\">::</span>IServiceCallback<span class=\"token operator\">></span> in_callback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"641\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">checkInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"642\"></td><td><pre>      _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>BAD_TYPE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"643\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"644\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"645\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8FromUtf16</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"646\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"647\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"648\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"649\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readStrongBinder</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"650\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"651\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"652\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"653\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token function\">_aidl_status</span><span class=\"token punctuation\">(</span><span class=\"token function\">unregisterForNotifications</span><span class=\"token punctuation\">(</span>in_name<span class=\"token punctuation\">,</span> in_callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"654\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"655\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"656\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"657\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"658\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"659\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"660\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"661\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"662\"></td><td><pre>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"663\"></td><td><pre>  <span class=\"token keyword\">case</span> BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_isDeclared<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"664\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"665\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string in_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"666\"></td><td><pre>    <span class=\"token keyword\">bool</span> _aidl_return<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"667\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">checkInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"668\"></td><td><pre>      _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>BAD_TYPE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"669\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"670\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"671\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8FromUtf16</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"672\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"673\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"674\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"675\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token function\">_aidl_status</span><span class=\"token punctuation\">(</span><span class=\"token function\">isDeclared</span><span class=\"token punctuation\">(</span>in_name<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"676\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"677\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"678\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"679\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"680\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"681\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"682\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"683\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token operator\">-></span><span class=\"token function\">writeBool</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"684\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"685\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"686\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"687\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"688\"></td><td><pre>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"689\"></td><td><pre>  <span class=\"token keyword\">case</span> BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_getDeclaredInstances<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"690\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"691\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string in_iface<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"692\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">></span> _aidl_return<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"693\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">checkInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"694\"></td><td><pre>      _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>BAD_TYPE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"695\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"696\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"697\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8FromUtf16</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_iface<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"698\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"699\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"700\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"701\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token function\">_aidl_status</span><span class=\"token punctuation\">(</span><span class=\"token function\">getDeclaredInstances</span><span class=\"token punctuation\">(</span>in_iface<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"702\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"703\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"704\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"705\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"706\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"707\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"708\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"709\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token operator\">-></span><span class=\"token function\">writeUtf8VectorAsUtf16Vector</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"710\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"711\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"712\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"713\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"714\"></td><td><pre>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"715\"></td><td><pre>  <span class=\"token keyword\">case</span> BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_updatableViaApex<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"716\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"717\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string in_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"718\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>optional<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">></span> _aidl_return<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"719\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">checkInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"720\"></td><td><pre>      _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>BAD_TYPE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"721\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"722\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"723\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8FromUtf16</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"724\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"725\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"726\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"727\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token function\">_aidl_status</span><span class=\"token punctuation\">(</span><span class=\"token function\">updatableViaApex</span><span class=\"token punctuation\">(</span>in_name<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"728\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"729\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"730\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"731\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"732\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"733\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"734\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"735\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token operator\">-></span><span class=\"token function\">writeUtf8AsUtf16</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"736\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"737\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"738\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"739\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"740\"></td><td><pre>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"741\"></td><td><pre>  <span class=\"token keyword\">case</span> BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_registerClientCallback<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"742\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"743\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string in_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"744\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span> in_service<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"745\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>os<span class=\"token double-colon punctuation\">::</span>IClientCallback<span class=\"token operator\">></span> in_callback<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"746\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">checkInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"747\"></td><td><pre>      _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>BAD_TYPE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"748\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"749\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"750\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8FromUtf16</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"751\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"752\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"753\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"754\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readStrongBinder</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_service<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"755\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"756\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"757\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"758\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readStrongBinder</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"759\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"760\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"761\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"762\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token function\">_aidl_status</span><span class=\"token punctuation\">(</span><span class=\"token function\">registerClientCallback</span><span class=\"token punctuation\">(</span>in_name<span class=\"token punctuation\">,</span> in_service<span class=\"token punctuation\">,</span> in_callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"763\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"764\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"765\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"766\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"767\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"768\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"769\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"770\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"771\"></td><td><pre>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"772\"></td><td><pre>  <span class=\"token keyword\">case</span> BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_tryUnregisterService<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"773\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"774\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>string in_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"775\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>sp<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>IBinder<span class=\"token operator\">></span> in_service<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"776\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">checkInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"777\"></td><td><pre>      _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>BAD_TYPE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"778\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"779\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"780\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8FromUtf16</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"781\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"782\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"783\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"784\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">readStrongBinder</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>in_service<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"785\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"786\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"787\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"788\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token function\">_aidl_status</span><span class=\"token punctuation\">(</span><span class=\"token function\">tryUnregisterService</span><span class=\"token punctuation\">(</span>in_name<span class=\"token punctuation\">,</span> in_service<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"789\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"790\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"791\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"792\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"793\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"794\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"795\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"796\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"797\"></td><td><pre>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"798\"></td><td><pre>  <span class=\"token keyword\">case</span> BnServiceManager<span class=\"token double-colon punctuation\">::</span>TRANSACTION_getServiceDebugInfo<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"799\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"800\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>os<span class=\"token double-colon punctuation\">::</span>ServiceDebugInfo<span class=\"token operator\">></span> _aidl_return<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"801\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>_aidl_data<span class=\"token punctuation\">.</span><span class=\"token function\">checkInterface</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"802\"></td><td><pre>      _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>BAD_TYPE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"803\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"804\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"805\"></td><td><pre>    <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status <span class=\"token function\">_aidl_status</span><span class=\"token punctuation\">(</span><span class=\"token function\">getServiceDebugInfo</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"806\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"807\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"808\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"809\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"810\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>_aidl_status<span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"811\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"812\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"813\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> _aidl_reply<span class=\"token operator\">-></span><span class=\"token function\">writeParcelableVector</span><span class=\"token punctuation\">(</span>_aidl_return<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"814\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>_aidl_ret_status<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>OK<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"815\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"816\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"817\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"818\"></td><td><pre>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"819\"></td><td><pre>  <span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"820\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"821\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">BBinder</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">onTransact</span><span class=\"token punctuation\">(</span>_aidl_code<span class=\"token punctuation\">,</span> _aidl_data<span class=\"token punctuation\">,</span> _aidl_reply<span class=\"token punctuation\">,</span> _aidl_flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"822\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"823\"></td><td><pre>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"824\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"825\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_aidl_ret_status <span class=\"token operator\">==</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>UNEXPECTED_NULL<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"826\"></td><td><pre>    _aidl_ret_status <span class=\"token operator\">=</span> <span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span><span class=\"token class-name\">Status</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">fromExceptionCode</span><span class=\"token punctuation\">(</span><span class=\"token double-colon punctuation\">::</span>android<span class=\"token double-colon punctuation\">::</span>binder<span class=\"token double-colon punctuation\">::</span>Status<span class=\"token double-colon punctuation\">::</span>EX_NULL_POINTER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeToParcel</span><span class=\"token punctuation\">(</span>_aidl_reply<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"827\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"828\"></td><td><pre>  <span class=\"token keyword\">return</span> _aidl_ret_status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"829\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"830\"></td><td><pre></pre></td></tr><tr><td data-num=\"831\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  <span class=\"token comment\">// namespace os</span></pre></td></tr><tr><td data-num=\"832\"></td><td><pre></pre></td></tr><tr><td data-num=\"833\"></td><td><pre><span class=\"token punctuation\">&#125;</span>  <span class=\"token comment\">// namespace android</span></pre></td></tr></table></figure><h1 id=\"å‚è€ƒèµ„æ–™\"><a class=\"anchor\" href=\"#å‚è€ƒèµ„æ–™\">#</a> å‚è€ƒèµ„æ–™</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXR5dWFuLmNvbS8yMDE0LzAxLzAxL2JpbmRlci1nYWlzaHUv\">gityuan å¤§ä½¬çš„ Binder ç³»åˆ—</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2MueW9ueW91Y2xvdWQuY29tL2RvYy93aWtpL3Byb2plY3QvZGVlcC1hbmRyb2lkLXYxL2JpbmRlci5odG1sIzA3ZjcwNTE0YmIzODhkYmUyYTFmYzJjYmU3ZGNmZGM4\">ç¬¬ 6 ç«  æ·±å…¥ç†è§£ Binder</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vd2FuZ2hvbmd6aHUvcC8xNTU1MTk3OC5odG1s\">Android 12 ç³»ç»Ÿæºç åˆ†æ | Native Binder ä»£ç å˜è¿ </span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaW5ub3N0L2FyY2hpdmUvMjAxMS8wMS8wOS8xOTMxNDU2Lmh0bWw=\">Android æ·±å…¥æµ…å‡ºä¹‹ Binder æœºåˆ¶ </span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaGVsbG9raXR0eTIvcC8xNTA4ODI2NS5odG1s\">ç†è§£ Android Binder æœºåˆ¶ (2/3)ï¼šC++ å±‚</span></li>\n</ul>\n",
            "tags": []
        },
        {
            "id": "https://oacia.dev/android-platform-compile/",
            "url": "https://oacia.dev/android-platform-compile/",
            "title": "pixel3å®‰å“ç³»ç»Ÿç¼–è¯‘åŠåˆ·å…¥è¿‡ç¨‹è®°å½•",
            "date_published": "2024-06-20T09:33:17.000Z",
            "content_html": "<div class=\"note warning\">\n<p>æƒ³è¦ä¸‹è½½å¹¶ç¼–è¯‘å®‰å“ç³»ç»Ÿï¼Œè¯·å¿…é¡»é¢„ç•™è‡³å°‘ 250G åŠä»¥ä¸Šçš„ç©ºä½™ç©ºé—´ï¼Œå¹¶ä¿æŒä»£ç†è¿æ¥ç¨³å®šï¼Œå¦åˆ™å°†å¯¼è‡´ä¸‹è½½å¤±è´¥å¹¶ä»å¤´ä¸‹è½½ï¼</p>\n</div>\n<h1 id=\"å®‰å“ç³»ç»Ÿç¼–è¯‘ç¯å¢ƒé…ç½®\"><a class=\"anchor\" href=\"#å®‰å“ç³»ç»Ÿç¼–è¯‘ç¯å¢ƒé…ç½®\">#</a> å®‰å“ç³»ç»Ÿç¼–è¯‘ç¯å¢ƒé…ç½®</h1>\n<h2 id=\"ä¸ºè™šæ‹Ÿæœºé…ç½®ä»£ç†\"><a class=\"anchor\" href=\"#ä¸ºè™šæ‹Ÿæœºé…ç½®ä»£ç†\">#</a> ä¸ºè™šæ‹Ÿæœºé…ç½®ä»£ç†</h2>\n<h3 id=\"æŸ¥çœ‹è™šæ‹Ÿæœºä»£ç†åœ°å€\"><a class=\"anchor\" href=\"#æŸ¥çœ‹è™šæ‹Ÿæœºä»£ç†åœ°å€\">#</a> æŸ¥çœ‹è™šæ‹Ÿæœºä»£ç†åœ°å€</h3>\n<p>æ‰“å¼€ <code>clash for windows</code> , å¹¶æ‰“å¼€ <code>Allow LAN</code>  çš„å¼€å…³ï¼Œéšåç‚¹å‡» <code>network interfaces</code></p>\n<p><img data-src=\"/android-platform-compile/image-20230811175325211.png\" alt=\"image-20230811175325211\" style=\"aspect-ratio:1070 / 760;\"></p>\n<p>è¯·æ³¨æ„æˆ‘çš„è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œè¿æ¥æ–¹å¼ä¸º NAT æ¨¡å¼ï¼Œæ‰€ä»¥éœ€è¦å…³æ³¨ <code>VMnet8</code>  çš„åœ°å€ï¼Œæ‰€ä»¥å¯¹äºè¯¥è™šæ‹Ÿæœºï¼Œä»£ç†åœ°å€ä¸º <code>192.168.27.1</code> , ç«¯å£å°±æ˜¯ <code>clash</code>  ä¸­ <code>Port</code>  é€‰é¡¹æ‰€æ˜¾ç¤ºçš„ç«¯å£</p>\n<p><img data-src=\"/android-platform-compile/image-20230811175516413.png\" alt=\"image-20230811175516413\" style=\"aspect-ratio:1070 / 760;\"></p>\n<h3 id=\"å¯ç”¨è™šæ‹Ÿæœºä»£ç†\"><a class=\"anchor\" href=\"#å¯ç”¨è™šæ‹Ÿæœºä»£ç†\">#</a> å¯ç”¨è™šæ‹Ÿæœºä»£ç†</h3>\n<p>ä¾æ¬¡ç‚¹å‡»å¦‚ä¸‹é€‰é¡¹è¿›å…¥ä»£ç†é…ç½®</p>\n<p><img data-src=\"/android-platform-compile/image-20230811180538737.png\" alt=\"image-20230811180538737\" style=\"aspect-ratio:1278 / 772;\"></p>\n<p>è¾“å…¥ä»£ç†åœ°å€ä¿å­˜å³å¯</p>\n<p><img data-src=\"/android-platform-compile/image-20230811180608202.png\" alt=\"image-20230811180608202\" style=\"aspect-ratio:840 / 516;\"></p>\n<h2 id=\"é…ç½®docker-ubuntué•œåƒ\"><a class=\"anchor\" href=\"#é…ç½®docker-ubuntué•œåƒ\">#</a> é…ç½® docker ubuntu é•œåƒ</h2>\n<h3 id=\"å®‰è£…docker\"><a class=\"anchor\" href=\"#å®‰è£…docker\">#</a> å®‰è£… docker</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> docker.io</pre></td></tr></table></figure><h3 id=\"docker-pullä»£ç†é…ç½®\"><a class=\"anchor\" href=\"#docker-pullä»£ç†é…ç½®\">#</a> docker pull ä»£ç†é…ç½®</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /etc/systemd/system/docker.service.d</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> gedit /etc/systemd/system/docker.service.d/proxy.conf</pre></td></tr></table></figure><p>è¾“å…¥ä»¥ä¸‹ä»£ç†æœåŠ¡å™¨å†…å®¹</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span><span class=\"token string\">\"HTTP_PROXY=http://192.168.27.1:7890/\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span><span class=\"token string\">\"HTTPS_PROXY=http://192.168.27.1:7890/\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span><span class=\"token string\">\"NO_PROXY=localhost,127.0.0.1\"</span></pre></td></tr></table></figure><h3 id=\"åˆ·æ–°é…ç½®å¹¶é‡å¯-docker-æœåŠ¡\"><a class=\"anchor\" href=\"#åˆ·æ–°é…ç½®å¹¶é‡å¯-docker-æœåŠ¡\">#</a> åˆ·æ–°é…ç½®å¹¶é‡å¯ docker æœåŠ¡</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> systemctl daemon-reload</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> systemctl restart <span class=\"token function\">docker</span></pre></td></tr></table></figure><h3 id=\"dockeré•œåƒä»£ç†é…ç½®\"><a class=\"anchor\" href=\"#dockeré•œåƒä»£ç†é…ç½®\">#</a> docker é•œåƒä»£ç†é…ç½®</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> ~/.docker/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> gedit ~/.docker/config.json</pre></td></tr></table></figure><p>è¾“å…¥ä»¥ä¸‹å†…å®¹</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> <span class=\"token string\">\"proxies\"</span><span class=\"token builtin class-name\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token string\">\"default\"</span><span class=\"token builtin class-name\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     <span class=\"token string\">\"httpProxy\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"http://192.168.27.1:7890/\"</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     <span class=\"token string\">\"httpsProxy\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"http://192.168.27.1:7890/\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     <span class=\"token string\">\"noProxy\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"localhost,127.0.0.1\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"ä¸‹è½½ubuntué•œåƒ\"><a class=\"anchor\" href=\"#ä¸‹è½½ubuntué•œåƒ\">#</a> ä¸‹è½½ Ubuntu é•œåƒ</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> pull ubuntu</pre></td></tr></table></figure><h3 id=\"è¿è¡Œubuntué•œåƒ\"><a class=\"anchor\" href=\"#è¿è¡Œubuntué•œåƒ\">#</a> è¿è¡Œ Ubuntu é•œåƒ</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">--privileged</span> <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--net</span> <span class=\"token function\">host</span> <span class=\"token parameter variable\">--name</span> aplatform ubuntu /bin/bash</pre></td></tr></table></figure><h2 id=\"å®‰è£…sudovim\"><a class=\"anchor\" href=\"#å®‰è£…sudovim\">#</a> å®‰è£… sudo,vim</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">apt-get</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token function\">vim</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token function\">sudo</span></pre></td></tr></table></figure><h2 id=\"ä¿®æ”¹apt-getçš„è½¯ä»¶æºä¸ºé˜¿é‡Œæº\"><a class=\"anchor\" href=\"#ä¿®æ”¹apt-getçš„è½¯ä»¶æºä¸ºé˜¿é‡Œæº\">#</a> ä¿®æ”¹ apt-get çš„è½¯ä»¶æºä¸ºé˜¿é‡Œæº</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">cp</span> /etc/apt/sources.list /etc/apt/sources.list_backup</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> /etc/apt/sources.list</pre></td></tr></table></figure><p>æ›¿æ¢ä¸ºå¦‚ä¸‹å†…å®¹</p>\n<figure class=\"highlight text\"><figcaption data-lang=\"text\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>deb-src http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>deb-src http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>deb-src http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre># deb http://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiverse</pre></td></tr><tr><td data-num=\"11\"></td><td><pre># deb-src http://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiverse</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>deb-src http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse</pre></td></tr></table></figure><p>éšåå°† <code>apt-get</code>  æ›´æ–°è‡³æœ€æ–°ç‰ˆæœ¬</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> upgrade</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> build-essential</pre></td></tr></table></figure><h2 id=\"å®‰è£…å¿…è¦çš„åº“\"><a class=\"anchor\" href=\"#å®‰è£…å¿…è¦çš„åº“\">#</a> å®‰è£…å¿…è¦çš„åº“</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> git-core gnupg flex bison build-essential <span class=\"token function\">zip</span> <span class=\"token function\">curl</span> zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc <span class=\"token function\">unzip</span> fontconfig libssl-dev <span class=\"token function\">bc</span> kmod cpio <span class=\"token function\">git</span> <span class=\"token function\">curl</span> <span class=\"token function\">rsync</span></pre></td></tr></table></figure><h2 id=\"ä¸ºgité…ç½®åŸºæœ¬ä¿¡æ¯\"><a class=\"anchor\" href=\"#ä¸ºgité…ç½®åŸºæœ¬ä¿¡æ¯\">#</a> ä¸º git é…ç½®åŸºæœ¬ä¿¡æ¯</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> user.email <span class=\"token string\">\"xxx@gmail.com\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> user.name <span class=\"token string\">\"xxx\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> http.proxy <span class=\"token number\">192.168</span>.27.1:7890</pre></td></tr></table></figure><h2 id=\"å®‰è£…repo\"><a class=\"anchor\" href=\"#å®‰è£…repo\">#</a> å®‰è£… repo</h2>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> ~/bin</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">curl</span> https://storage.googleapis.com/git-repo-downloads/repo <span class=\"token operator\">></span> ~/bin/repo</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">chmod</span> a+x ~/bin/repo</pre></td></tr></table></figure><h2 id=\"ä¿®æ”¹repoçš„ä¸‹è½½æºä¸ºæ¸…åæºå¹¶æ·»åŠ repoè‡³å…¨å±€å˜é‡\"><a class=\"anchor\" href=\"#ä¿®æ”¹repoçš„ä¸‹è½½æºä¸ºæ¸…åæºå¹¶æ·»åŠ repoè‡³å…¨å±€å˜é‡\">#</a> ä¿®æ”¹ repo çš„ä¸‹è½½æºä¸ºæ¸…åæºï¼Œå¹¶æ·»åŠ  repo è‡³å…¨å±€å˜é‡</h2>\n<h3 id=\"æ‰“å¼€å…¨å±€å˜é‡é…ç½®æ–‡ä»¶\"><a class=\"anchor\" href=\"#æ‰“å¼€å…¨å±€å˜é‡é…ç½®æ–‡ä»¶\">#</a> æ‰“å¼€å…¨å±€å˜é‡é…ç½®æ–‡ä»¶</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">vim</span> ~/.bashrc</pre></td></tr></table></figure><h3 id=\"æ·»åŠ å…¨å±€å˜é‡\"><a class=\"anchor\" href=\"#æ·»åŠ å…¨å±€å˜é‡\">#</a> æ·»åŠ å…¨å±€å˜é‡</h3>\n<p>åœ¨æœ«å°¾æ·»åŠ è¿™ä¸‰è¡Œå¹¶ä¿å­˜</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># repo</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">REPO_URL</span><span class=\"token operator\">=</span><span class=\"token string\">'https://mirrors.tuna.tsinghua.edu.cn/git/git-repo/'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"~/bin:<span class=\"token environment constant\">$PATH</span>\"</span></pre></td></tr></table></figure><h3 id=\"ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ\"><a class=\"anchor\" href=\"#ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ\">#</a> ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ</h3>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">source</span> ~/.bashrc</pre></td></tr></table></figure><h2 id=\"å®‰è£…python\"><a class=\"anchor\" href=\"#å®‰è£…python\">#</a> å®‰è£… python</h2>\n<p>å¦‚æœä½¿ç”¨ <code>python --version</code>  æœ‰æ‰“å° python ç‰ˆæœ¬çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸€æ­¥å°±ä¸éœ€è¦äº†ï¼Œå¦‚æœ docker ä¸­æ²¡æœ‰å®‰è£… <code>python</code> , åœ¨ docker å†…ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> software-properties-common</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>add-apt-repository ppa:deadsnakes/ppa</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> python3.9</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">ln</span> <span class=\"token parameter variable\">-s</span> /usr/bin/python3 /usr/bin/python</pre></td></tr></table></figure><h2 id=\"ä¿®æ”¹äº¤æ¢åŒºå¤§å°\"><a class=\"anchor\" href=\"#ä¿®æ”¹äº¤æ¢åŒºå¤§å°\">#</a> ä¿®æ”¹äº¤æ¢åŒºå¤§å°</h2>\n<p>ä¸ºäº†é˜²æ­¢ç¼–è¯‘æºç çš„è¿‡ç¨‹ä¸­ç”±äºäº¤æ¢åŒºä¸è¶³è€Œå¤±è´¥ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»ä¿®æ”¹<strong>è™šæ‹Ÿæœº</strong>çš„äº¤æ¢åŒºçš„å¤§å°</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># å¦‚æœæç¤º No such file or directoryï¼Œé‚£å°±ç›´æ¥è¿›è¡Œä¸‹é¢è®¾ç½®äº¤æ¢åŒºçš„æ“ä½œ</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> swapoff /swapfile</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">rm</span> /swapfile</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># è®¾ç½®äº† 32g äº¤æ¢åŒºï¼Œé˜²æ­¢ç¼–è¯‘å¤±è´¥ï¼Œæ‰§è¡Œä¸‹åˆ—å‘½ä»¤éœ€è¦èŠ±è´¹ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœæ‰§è¡Œå‘½ä»¤åæ²¡æœ‰è¾“å‡ºï¼Œè¯·è€å¿ƒç­‰å¾…å‘½ä»¤æ‰§è¡Œå®Œæ¯•</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">dd</span> <span class=\"token assign-left variable\">if</span><span class=\"token operator\">=</span>/dev/zero <span class=\"token assign-left variable\">of</span><span class=\"token operator\">=</span>/swapfile <span class=\"token assign-left variable\">bs</span><span class=\"token operator\">=</span>1GB <span class=\"token assign-left variable\">count</span><span class=\"token operator\">=</span><span class=\"token number\">32</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">chmod</span> <span class=\"token number\">600</span> /swapfile</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">mkswap</span> <span class=\"token parameter variable\">-f</span> /swapfile</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">sudo</span> <span class=\"token function\">swapon</span> /swapfile</pre></td></tr></table></figure><h1 id=\"å®‰å“ç³»ç»Ÿæºç ä¸‹è½½\"><a class=\"anchor\" href=\"#å®‰å“ç³»ç»Ÿæºç ä¸‹è½½\">#</a> å®‰å“ç³»ç»Ÿæºç ä¸‹è½½</h1>\n<h2 id=\"æŸ¥çœ‹androidç‰ˆæœ¬\"><a class=\"anchor\" href=\"#æŸ¥çœ‹androidç‰ˆæœ¬\">#</a> æŸ¥çœ‹ android ç‰ˆæœ¬</h2>\n<p>è¿›å…¥<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb3VyY2UuYW5kcm9pZC5jb20vZG9jcy9zZXR1cC9hYm91dC9idWlsZC1udW1iZXJzP2hsPXpoLWNu\">ä»£å·ï¼Œæ ‡è®°å’Œ build å·</span>æ¥æŸ¥çœ‹å®‰å“ç³»ç»Ÿçš„ç‰ˆæœ¬</p>\n<p>å¦‚æœæ˜¯é¢„è£…çš„ç³»ç»Ÿï¼Œé‚£ä¹ˆ kernel ç‰ˆæœ¬å’Œç³»ç»Ÿç‰ˆæœ¬æ˜¯æœ‰å¯¹åº”å…³ç³»çš„ï¼Œä¾‹å¦‚æˆ‘ç»™ pixel3 åˆ·å…¥çš„ç³»ç»Ÿä¸º <code>blueline-sp1a.210812.016.c2-factory-fa981d87</code> , é‚£ä¹ˆåœ¨ä¸Šé¢æåˆ°çš„ç½‘å€å†…æ‰¾åˆ°è¯¥å®‰å“ç³»ç»Ÿè¯¥ <code>build ID</code>  æ‰€å¯¹åº”çš„å®‰å“ç³»ç»Ÿç‰ˆæœ¬ <code>android-12.0.0_r34</code>  å¦‚å›¾æ‰€ç¤º</p>\n<p><img data-src=\"/android-platform-compile/image-20231010095645706.png\" alt=\"image-20231010095645706\" style=\"aspect-ratio:1920 / 1078;\"></p>\n<h2 id=\"ä¸‹è½½\"><a class=\"anchor\" href=\"#ä¸‹è½½\">#</a> ä¸‹è½½</h2>\n<p>è¾“å…¥å¦‚ä¸‹å‘½ä»¤æ¥è¿›è¡Œå®‰å“ç³»ç»Ÿæºç ä¸‹è½½ï¼Œåˆ†æ”¯å°±é€‰æ‹©æˆ‘ä»¬ä¹‹å‰æŸ¥æ‰¾åˆ°çš„é‚£ä¸ªåˆ†æ”¯</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> android-platform <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">cd</span> android-platform</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>repo init <span class=\"token parameter variable\">-u</span> https://android.googlesource.com/platform/manifest <span class=\"token parameter variable\">-b</span> android-12.0.0_r34 <span class=\"token parameter variable\">--depth</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>repo <span class=\"token function\">sync</span> <span class=\"token parameter variable\">-j4</span></pre></td></tr></table></figure><h1 id=\"å®‰å“ç³»ç»Ÿç¼–è¯‘\"><a class=\"anchor\" href=\"#å®‰å“ç³»ç»Ÿç¼–è¯‘\">#</a> å®‰å“ç³»ç»Ÿç¼–è¯‘</h1>\n<p>åœ¨æºç ä¸‹è½½å®Œæˆä¹‹åï¼Œæˆ‘ä»¬é¦–å…ˆä½¿ç”¨ <code>envsetup.sh</code>  è®¾ç½®æ„å»ºç¯å¢ƒ</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">source</span> build/envsetup.sh</pre></td></tr></table></figure><p>ä¹‹åä½¿ç”¨ lunch å‘½ä»¤é€‰æ‹©ç›®æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è¾“å…¥ <code>lunch</code>  æ¥æŸ¥çœ‹å¯ä¾›ç¼–è¯‘çš„ç¼–è¯‘</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>lunch</pre></td></tr></table></figure><p>åœ¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb3VyY2UuYW5kcm9pZC5jb20vZG9jcy9zZXR1cC9yZWZlcmVuY2UvYnVpbGQtbnVtYmVycz9obD16aC1jbiNidWlsZC10YXJnZXRz\"> google è®¾å¤‡ä»£å·</span>ä¸­å¯ä»¥çŸ¥é“ pixel3 çš„è®¾å¤‡ä»£å·æ˜¯ <code>blueline</code></p>\n<p><img data-src=\"/android-platform-compile/image-20240620192202983.png\" alt=\"image-20240620192202983\" style=\"aspect-ratio:531 / 648;\"></p>\n<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è®¾ç½®å¥½ç¼–è¯‘ç›®æ ‡</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>lunch aosp_blueline-userdebug</pre></td></tr></table></figure><p>è¿™é‡Œå‡ºç°äº† <code>Build sandboxing disabled due to nsjail error</code>  æŠ¥é”™ï¼Œè¿™ä¸ªæŠ¥é”™åº”è¯¥æ˜¯ä¸ä¼šå½±å“åç»­çš„ç³»ç»Ÿç¼–è¯‘çš„</p>\n<p><img data-src=\"/android-platform-compile/image-20240620194321797.png\" alt=\"image-20240620194321797\" style=\"aspect-ratio:815 / 543;\"></p>\n<details class=\"info\"><summary>lunchè‡ªå®šä¹‰å‘½ä»¤ç»„åˆ</summary><div>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>lunch product_name-release-build_variant</pre></td></tr></table></figure><p>æ­¤å­—ç¬¦ä¸²çš„ç»„æˆéƒ¨åˆ†åŒ…æ‹¬ï¼š</p>\n<ul>\n<li>\n<p>product_name æ˜¯æˆ‘ä»¬è¦æ„å»ºçš„äº§å“çš„åç§°ï¼Œä¾‹å¦‚  <code>aosp_cf_x86_64_phone</code>  æˆ–  <code>aosp_husky</code> ã€‚ç‰¹å®šçš„  <code>product_name</code>  å¯ä»¥éµå¾ªæˆ‘ä»¬è‡ªå·±çš„è®¾å¤‡æ ¼å¼ï¼Œä½† Google ä¸ºå…¶è®¾å¤‡é‡‡ç”¨çš„æ ¼å¼åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š</p>\n<ul>\n<li><code>aosp</code>  æ˜¯æŒ‡ Android å¼€æºå¹³å°ã€‚</li>\n<li>ï¼ˆå¯é€‰ï¼‰å¦‚æœè¦åœ¨ Cuttlefish æ¨¡æ‹Ÿå™¨ä¸­è¿è¡Œç›®æ ‡ï¼Œåˆ™åŒ…å«  <code>cf</code> ã€‚</li>\n<li>æ¶æ„å’Œç¡¬ä»¶ï¼ˆä»£å·ï¼‰ï¼Œä¾‹å¦‚  <code>x86_64_phone</code>  æˆ–  <code>husky</code> ï¼ˆPixel 8 Pro çš„ä»£å·ï¼‰ã€‚å¦‚éœ€æŸ¥çœ‹ Google è®¾å¤‡çš„ä»£å·åˆ—è¡¨ï¼Œè¯·å‚é˜…<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb3VyY2UuYW5kcm9pZC5jb20vZG9jcy9zZXR1cC9yZWZlcmVuY2UvYnVpbGQtbnVtYmVycz9obD16aC1jbiNidWlsZC10YXJnZXRz\">è®¾å¤‡ä»£å·</span>ã€‚</li>\n</ul>\n<p>æ‰€ä»¥å¯¹äº pixel3 æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å°† <code>product_name</code>  é…ç½®ä¸º <code>aosp_blueline</code></p>\n</li>\n<li>\n<p>å°† release è®¾ç½®ä¸º  <code>trunk_staging</code> ã€‚</p>\n</li>\n<li>\n<p>æ­¤å­—ç¬¦ä¸²çš„ build_variant éƒ¨åˆ†å¯ä»¥æ˜¯ä¸‹è¡¨ä¸­çš„ä¸‰ä¸ªå€¼ä¹‹ä¸€ï¼Œè¿™é‡Œæˆ‘é€‰æ‹© user ä¸ºç›®æ ‡æ¥æ„å»ºï¼Œæ¯•ç«Ÿè°çŸ¥é“ä¸‡ä¸€ç¼–è¯‘æˆ debug ä¼šä¸ä¼šæœ‰ app æ£€æµ‹åˆ°ç‰¹å¾äº†å˜ï½</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">build_variant</th>\n<th>æ¦‚è¿°</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n<th>ro.secure</th>\n<th>ro.debuggable</th>\n<th>ro.kernel.android.checkjni</th>\n<th>adb åŠŸèƒ½</th>\n<th>Proguard æ··æ·†å™¨</th>\n<th>DEXPREOPT é¢„å…ˆç¼–è¯‘ä¼˜åŒ–</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\"><code>user</code></td>\n<td>release ç‰ˆæœ¬</td>\n<td style=\"text-align:left\">æ­¤ build å˜ä½“æä¾›æœ‰é™çš„å®‰å…¨è®¿é—®æƒé™ï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚</td>\n<td>è®¾å®šå±æ€§ ro.secure=1ï¼Œæ‰“å¼€å®‰å…¨æ£€æŸ¥åŠŸèƒ½</td>\n<td>è®¾å®šå±æ€§ ro.debuggable=0ï¼Œå…³é—­åº”ç”¨è°ƒè¯•åŠŸèƒ½</td>\n<td>è®¾å®šå±æ€§ ro.kernel.android.checkjni=0ï¼Œå…³é—­ JNI è°ƒç”¨æ£€æŸ¥</td>\n<td>å…³é—­</td>\n<td>æ‰“å¼€</td>\n<td>æ‰“å¼€</td>\n</tr>\n<tr>\n<td style=\"text-align:left\"><code>userdebug</code></td>\n<td>éƒ¨åˆ† debug ç‰ˆæœ¬</td>\n<td style=\"text-align:left\">æ­¤ build å˜ä½“å¯å¸®åŠ©è®¾å¤‡å¼€å‘è€…äº†è§£å¼€å‘ä¸­ç‰ˆæœ¬çš„æ€§èƒ½å’ŒåŠŸè€—ã€‚ä½¿ç”¨  <code>userdebug</code>  build è¿›è¡Œå¼€å‘æ—¶ï¼Œè¯·éµå¾ª <span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb3VyY2UuYW5kcm9pZC5jb20vZG9jcy9zZXR1cC9jcmVhdGUvbmV3LWRldmljZT9obD16aC1jbiN1c2VyZGVidWctZ3VpZGVsaW5lcw==\">userdebug æŒ‡å—</span>ã€‚</td>\n<td>è®¾å®šå±æ€§ ro.secure=1ï¼Œæ‰“å¼€å®‰å…¨æ£€æŸ¥åŠŸèƒ½</td>\n<td>è®¾å®šå±æ€§ ro.debuggable=1ï¼Œå¯ç”¨åº”ç”¨è°ƒè¯•åŠŸèƒ½</td>\n<td>è®¾å®šå±æ€§ ro.kernel.android.checkjni=0ï¼Œå…³é—­ JNI è°ƒç”¨æ£€æŸ¥</td>\n<td>æ‰“å¼€</td>\n<td>æ‰“å¼€</td>\n<td>æ‰“å¼€</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">eng</td>\n<td>debug ç‰ˆæœ¬</td>\n<td style=\"text-align:left\">æ­¤ build å˜ä½“çš„æ„å»ºæ—¶é—´æ›´çŸ­ï¼Œå¦‚æœæ‚¨ä¸åœ¨æ„æ€§èƒ½å’ŒåŠŸè€—ï¼Œå®ƒæœ€é€‚åˆç”¨äºæ—¥å¸¸å¼€å‘ã€‚</td>\n<td>è®¾å®šå±æ€§ ro.secure=0ï¼Œå…³é—­å®‰å…¨æ£€æŸ¥åŠŸèƒ½</td>\n<td>è®¾å®šå±æ€§ ro.debuggable=1ï¼Œå¯ç”¨åº”ç”¨è°ƒè¯•åŠŸèƒ½</td>\n<td>è®¾å®šå±æ€§ ro.kernel.android.checkjni=1ï¼Œå¯ç”¨ JNI è°ƒç”¨æ£€æŸ¥</td>\n<td>æ‰“å¼€</td>\n<td>å…³é—­</td>\n<td>å…³é—­</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ul>\n<p>æ‰€ä»¥å¯¹äºæˆ‘çš„ pixel3 æ¥è¯´ç¼–è¯‘å‘½ä»¤å¦‚ä¸‹</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>lunch aosp_blueline-trunk_staging-user</pre></td></tr></table></figure><p>ä½†æ˜¯æ²¡æƒ³åˆ°çš„æ˜¯ç«Ÿç„¶æŠ¥é”™äº†ï¼Ÿä¼°è®¡æ˜¯ä¸èƒ½ä»¥ user ä½œä¸ºç›®æ ‡ç¼–è¯‘ï¼Ÿä¹‹åçœ‹çœ‹ userdebug ä¼šä¸ä¼šè¢«æ£€æµ‹åˆ°å†å†³å®šæ˜¯å¦ç»§ç»­ç ”ç©¶æ­¤å¤„çš„æŠ¥é”™</p>\n<p><img data-src=\"/android-platform-compile/image-20240620191331546.png\" alt=\"image-20240620191331546\" style=\"aspect-ratio:973 / 246;\"></p>\n</div></details>\n<p>ç„¶åå¼€å§‹ç¼–è¯‘ï¼Œç»™è™šæ‹Ÿæœºåˆ†é… 12 æ ¸çš„è¯ç¬¬ä¸€æ¬¡å¤§æ¦‚éœ€è¦ä¸¤ä¸ªå°æ—¶å·¦å³å¯ä»¥ç¼–è¯‘å®Œæˆï¼Œåé¢å†æ¬¡ç¼–è¯‘çš„é€Ÿåº¦å°±å¾ˆå¿«äº†</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token parameter variable\">-j8</span></pre></td></tr></table></figure><p>ç¼–è¯‘å®Œæˆåä¼šç”Ÿæˆä¸€ä¸ª <code>vbmeta.img</code>  æ–‡ä»¶ï¼Œåˆ°æ—¶å€™æˆ‘ä»¬è¦åˆ·å…¥çš„ä¹Ÿæ˜¯è¿™ä¸€ä¸ªæ–‡ä»¶</p>\n<p><img data-src=\"/android-platform-compile/image-20240620215327602.png\" alt=\"image-20240620215327602\" style=\"aspect-ratio:1982 / 590;\"></p>\n<h1 id=\"ç¼–è¯‘åçš„é•œåƒåˆ·å…¥æ‰‹æœº\"><a class=\"anchor\" href=\"#ç¼–è¯‘åçš„é•œåƒåˆ·å…¥æ‰‹æœº\">#</a> ç¼–è¯‘åçš„é•œåƒåˆ·å…¥æ‰‹æœº</h1>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//TODO 6.24 å·å‘¨ä¸€çš„æ—¶å€™åˆ·è¿›å»è¯•è¯•çœ‹åŠŸèƒ½æ˜¯ä¸æ˜¯æ­£å¸¸ï¼</span></pre></td></tr></table></figure><h1 id=\"å‚è€ƒèµ„æ–™\"><a class=\"anchor\" href=\"#å‚è€ƒèµ„æ–™\">#</a> å‚è€ƒèµ„æ–™</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb3VyY2UuYW5kcm9pZC5jb20vZG9jcy9zZXR1cC9idWlsZC9idWlsZGluZz9obD16aC1jbg==\">æ„å»º Android</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGl4dWVqaWFuL3AvMTY3MjA1NjEuaHRtbA==\">Android ç¼–è¯‘é€‰é¡¹ engã€userã€userdebug çš„åŒºåˆ«</span></li>\n</ul>\n",
            "tags": []
        },
        {
            "id": "https://oacia.dev/android-bcc/",
            "url": "https://oacia.dev/android-bcc/",
            "title": "EBPF android bccåˆä½“éªŒ",
            "date_published": "2024-05-07T07:31:28.000Z",
            "content_html": "<p>pixel6 åˆ°æ‰‹çš„ç¬¬ä¸€ä»¶äº‹ï¼Œå½“ç„¶æ˜¯å»ç©ç©çœ‹ ebpf äº†ï½ebpf çš„æ— ç—• hook å¬ä¸Šå»å°±æ„Ÿè§‰ç›¸å½“çš„å¼ºå¤§ï¼Œå»<span class=\"exturl\" data-url=\"aHR0cHM6Ly9lYnBmLmlvL2FwcGxpY2F0aW9ucy8=\">å®˜ç½‘</span>çœ‹äº†ä¸€ä¸‹ ebpf çŸ¥ååº¦æ’åå‰å‡ çš„é¡¹ç›®ï¼Œé‚£é<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2lvdmlzb3IvYmNj\"> bcc</span> è«å±äº†ï¼Œç”¨ python å°±å¯ä»¥è¿è¡Œ ebpf ä»£ç ï¼Œè™½ç„¶ ebpf çš„æ ¸å¿ƒä»£ç è¿˜æ˜¯ C å†™çš„ï¼Œä½†æ˜¯ç”¨ python å»æ‰§è¡Œå°±æ„Ÿè§‰ååˆ†çš„èˆ’é€‚</p>\n<p>åœ¨ç½‘ä¸Šä¹Ÿæ‰¾åˆ°äº†ä¸‰ç¯‡éå¸¸è¯¦ç»†çš„ Android bcc ç¼–è¯‘æ•™ç¨‹ï¼Œå‰äººç§æ ‘ï¼Œåäººä¹˜å‡‰ <code>^.^</code>  å¯ä»¥è¯•è¯•çœ‹ ebpf ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ ·å­çš„å•¦</p>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLnNlZWZsb3dlci5kZXYvYXJjaGl2ZXMvMTQwLw==\">eBPF on Android ä¹‹ bcc ç¯å¢ƒå‡†å¤‡ â€”â€”eadb åŸç‰ˆ</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjc1MTc2Lmh0bQ==\">[åŸåˆ›] 60 ç§’å­¦ä¼šç”¨ eBPF-BCC hook ç³»ç»Ÿè°ƒç”¨ ( 2 ) hook å®‰å“æ‰€æœ‰ syscall</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLnNlZWZsb3dlci5kZXYvYXJjaGl2ZXMvMTExLyM=\">eBPF on Android ä¹‹ bcc ç¼–è¯‘ä¸ä½“éªŒ</span></li>\n</ul>\n<h1 id=\"bccç¯å¢ƒæ­å»º\"><a class=\"anchor\" href=\"#bccç¯å¢ƒæ­å»º\">#</a> bcc ç¯å¢ƒæ­å»º</h1>\n<p>æ¥ä¸‹æ¥è¿›è¡Œ bcc çš„ç¯å¢ƒæ­å»ºï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RpYW5uL2VhZGI=\"> eadb</span> åœ¨æ‰‹æœºä¸­é…ç½® Debian ç³»ç»Ÿï¼Œå¹¶é€šè¿‡ ssh è®© Windows ä¸Šçš„ vscode å¯ä»¥è¿æ¥æ‰‹æœºä¸­çš„ Debian</p>\n<p>æƒ³è¦ä½¿ç”¨ bcc çš„å…¨éƒ¨åŠŸèƒ½ï¼Œé¦–å…ˆæ£€æŸ¥ linux å†…æ ¸ç‰ˆæœ¬ï¼Œæˆ‘çš„å†…æ ¸ç‰ˆæœ¬ä¸º <code>5.10</code></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">uname</span> <span class=\"token parameter variable\">-a</span></pre></td></tr></table></figure><p>ç„¶åæ£€æŸ¥ BPF çš„é…ç½®æ˜¯å¦å¼€å¯</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>oriole:/ <span class=\"token comment\"># zcat /proc/config.gz | grep PROBE</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">CONFIG_GENERIC_IRQ_PROBE</span><span class=\"token operator\">=</span>y</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">CONFIG_ARCH_SUPPORTS_UPROBES</span><span class=\"token operator\">=</span>y</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">CONFIG_KPROBES</span><span class=\"token operator\">=</span>y</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">CONFIG_UPROBES</span><span class=\"token operator\">=</span>y</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">CONFIG_KRETPROBES</span><span class=\"token operator\">=</span>y</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">CONFIG_HAVE_KPROBES</span><span class=\"token operator\">=</span>y</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">CONFIG_HAVE_KRETPROBES</span><span class=\"token operator\">=</span>y</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># CONFIG_TEST_ASYNC_DRIVER_PROBE is not set</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">CONFIG_GENERIC_CPU_AUTOPROBE</span><span class=\"token operator\">=</span>y</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">CONFIG_TIMER_PROBE</span><span class=\"token operator\">=</span>y</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">CONFIG_KPROBE_EVENTS</span><span class=\"token operator\">=</span>y</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">CONFIG_UPROBE_EVENTS</span><span class=\"token operator\">=</span>y</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">CONFIG_PROBE_EVENTS</span><span class=\"token operator\">=</span>y</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># CONFIG_BPF_KPROBE_OVERRIDE is not set</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># CONFIG_KPROBE_EVENT_GEN_TEST is not set</span></pre></td></tr></table></figure><p>éšåä½¿ç”¨ magisk root æ‰‹æœºï¼Œç„¶åå®‰è£…<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRsYWIuY29tL2Q0cmNtNHJjL01hZ2lza1NTSF9yZWxlYXNlcw==\"> MagiskSSH</span></p>\n<p>ubuntu ä¸­åœ¨ root æƒé™ä¸‹å®‰è£… adb å’Œ fastboot</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">apt</span> <span class=\"token function\">install</span> adb,fastboot</pre></td></tr></table></figure><p>éšååœ¨ ubuntu ä¸­è¾“å…¥ä¸‹åˆ—å‘½ä»¤ç”Ÿæˆ rsa å¯†é’¥ï¼Œä¸€è·¯å›è½¦</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ssh-keygen <span class=\"token parameter variable\">-t</span> rsa <span class=\"token parameter variable\">-b</span> <span class=\"token number\">4096</span> <span class=\"token parameter variable\">-C</span> <span class=\"token string\">\"your_email@example.com\"</span></pre></td></tr></table></figure><p>å°†å…¬é’¥æ¨é€åˆ°æ‰‹æœºä¸­</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb push ~/.ssh/id_rsa.pub /data/local/tmp</pre></td></tr></table></figure><p>å°†å…¬é’¥è¿½åŠ å†™å…¥ MagiskSSH çš„é…ç½®æ–‡ä»¶ä¸­</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> /data/local/tmp/id_rsa.pub <span class=\"token operator\">>></span> /data/ssh/shell/.ssh/authorized_keys</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">chmod</span> <span class=\"token number\">600</span> /data/ssh/shell/.ssh/authorized_keys</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">cat</span> /data/local/tmp/id_rsa.pub <span class=\"token operator\">>></span> /data/ssh/root/.ssh/authorized_keys</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">chmod</span> <span class=\"token number\">600</span> /data/ssh/root/.ssh/authorized_keys</pre></td></tr></table></figure><p>ä½¿ç”¨ MT ç®¡ç†å™¨ç¼–è¾‘ <code>/data/ssh/sshd_config</code> , æŠŠä¸‹é¢çš„å†…å®¹ç²˜è´´åˆ°æ–‡ä»¶å¼€å¤´å¹¶ä¿å­˜å³å¯</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Port <span class=\"token number\">22225</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>PasswordAuthentication yes</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PermitEmptyPasswords yes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>PermitUserEnvironment yes</pre></td></tr></table></figure><p><img data-src=\"/android-bcc/image-20240507160213733.png\" alt=\"image-20240507160213733\" style=\"aspect-ratio:432 / 381;\"></p>\n<p>é‡å¯ sshd æœåŠ¡</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>/data/adb/modules/ssh/opensshd.init stop</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>/data/adb/modules/ssh/opensshd.init start</pre></td></tr></table></figure><p>éšååœ¨ ubuntu ä¸­ä¸‹è½½<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RpYW5uL2VhZGIvcmVsZWFzZXM=\"> eadb å’Œ debianfs</span></p>\n<p><img data-src=\"/android-bcc/image-20240507154231052.png\" alt=\"image-20240507154231052\" style=\"aspect-ratio:470 / 463;\"></p>\n<p>åœ¨æ‰‹æœºçš„ WLAN ç½‘ç»œè¯¦æƒ…é‡Œæ‰¾åˆ°æ‰‹æœºçƒ­ç‚¹çš„ IP åœ°å€</p>\n<p>é…ç½® debian ç¯å¢ƒ</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./eadb <span class=\"token parameter variable\">--ssh</span> root@192.168.50.191 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">22225</span> prepare <span class=\"token parameter variable\">-a</span> debianfs-arm64-full.tar.gz</pre></td></tr></table></figure><p>ç„¶åè¿è¡Œä¸‹é¢çš„å‘½ä»¤å°±å¯ä»¥è¿æ¥ä¸Šäº†</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>./eadb <span class=\"token parameter variable\">--ssh</span> root@192.168.50.191 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">22225</span> shell</pre></td></tr></table></figure><p>ä¸º Debian é…ç½® ssh</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">apt-get</span> update</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token function\">ssh</span></pre></td></tr></table></figure><p>æ‰“å¼€ <code>/etc/ssh/sshd_config</code></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /etc/ssh/sshd_config</pre></td></tr></table></figure><p>å¹¶æŒ‰ä¸‹ <code>ctrl+shift+v</code>  ç²˜è´´ä¸‹åˆ—çš„å†…å®¹</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>AuthorizedKeysFile <span class=\"token punctuation\">.</span>ssh<span class=\"token operator\">/</span>authorized_keys</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Port <span class=\"token number\">11111</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PubkeyAuthentication yes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>PermitRootLogin yes</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>PasswordAuthentication yes</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>GSSAPIAuthentication  no  # åŠ é€ŸSSH</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>UseDNS no   # åŠ é€ŸSSH</pre></td></tr></table></figure><p>åœ¨è™šæ‹Ÿæœº ubuntu ä¸­æŸ¥çœ‹ç”Ÿæˆçš„å…¬é’¥</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> ~/.ssh/id_rsa.pub</pre></td></tr></table></figure><p>åœ¨æ‰‹æœº Debian ä¸­æ‰‹åŠ¨ç²˜è´´å¯¼å…¥å…¬é’¥</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> id_rsa.pub</pre></td></tr></table></figure><p>åœ¨æ‰‹æœº Debian ä¸­å¢åŠ å…¬é’¥å¹¶é…ç½®æƒé™</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> id_rsa.pub <span class=\"token operator\">>></span> ~/.ssh/authorized_keys</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">chmod</span> <span class=\"token number\">600</span> ~/.ssh/authorized_keys<span class=\"token punctuation\">;</span><span class=\"token function\">chmod</span> <span class=\"token number\">700</span> ~/.ssh</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">service</span> <span class=\"token function\">ssh</span> restart          <span class=\"token comment\"># æ‰‹æœºæ¯æ¬¡é‡å¯åï¼Œç¬¬ä¸€æ¬¡è¿›å…¥ debian, å¯èƒ½éƒ½éœ€è¦æ‰‹åŠ¨å¯åŠ¨ä¸‹ ssh æœåŠ¡</span></pre></td></tr></table></figure><div class=\"note info\">\n<p>å¦‚æœæ²¡æœ‰ <code>~/.ssh/authorized_keys</code>  æ–‡ä»¶ï¼Œæ–°å»ºä¸€ä¸ªå°±è¡Œäº†</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> ~/.ssh<span class=\"token punctuation\">;</span><span class=\"token function\">touch</span> ~/.ssh/authorized_keys</pre></td></tr></table></figure></div>\n<p>ä¿®æ”¹ Debian çš„ root å¯†ç </p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">passwd</span> root</pre></td></tr></table></figure><p>åœ¨ ubuntu ä¸­æŸ¥çœ‹ç§é’¥ï¼Œç„¶åå¤åˆ¶åˆ° Windows çš„ä¸€ä¸ªæ–‡ä»¶ <code>id_rsa</code>  ä¸­</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> ~/.ssh/id_rsa</pre></td></tr></table></figure><p>ç„¶åæ‰“å¼€ <code>C:\\Users\\admin\\.ssh\\config</code> , é…ç½® ssh, å¹¶åœ¨ vscode ä¸­å®‰è£… ssh æ’ä»¶</p>\n<p><img data-src=\"/android-bcc/image-20240509205100257.png\" alt=\"image-20240509205100257\" style=\"aspect-ratio:712 / 178;\"></p>\n<p>ä¹‹åå…³é—­è™šæ‹Ÿæœºè®©æ‰‹æœºçš„ USB è¿ä¸Š Windows, åœ¨ vscode ä¸­å°±å¯ä»¥è¿ä¸Šå•¦</p>\n<div class=\"note info\">\n<p>vscode ç¬¬ä¸€æ¬¡è¿æ¥ Debian, ä¼šåœ¨ Debian ä¸­å®‰è£… vscode æœåŠ¡å™¨ï¼Œå¦‚æœä¸å¼€ä»£ç†çš„è¯é€Ÿåº¦ä¼šç›¸å½“ç›¸å½“çš„æ…¢ï¼Œè¦æƒ³ç»™ Debian æŒ‚ä»£ç†çš„è¯ï¼Œåªè¦åœ¨æ‰‹æœºä¸­æŠŠ Clash å¼€èµ·æ¥å°±å¯ä»¥å•¦</p>\n</div>\n<h1 id=\"bccç¼–è¯‘è¿è¡Œ\"><a class=\"anchor\" href=\"#bccç¼–è¯‘è¿è¡Œ\">#</a> bcc ç¼–è¯‘è¿è¡Œ</h1>\n<p>ç¯å¢ƒæ­å»ºå¥½äº†ä¹‹åï¼Œå°±å¯ä»¥ç¼–è¯‘ bcc äº†</p>\n<p>å…ˆæŠŠ bcc ä¸‹è¿‡æ¥</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> clone https://github.com/iovisor/bcc.git</pre></td></tr></table></figure><p>ç¼–è¯‘ bcc</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> bcc/build<span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">cd</span> bcc/build</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>cmake <span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">make</span></pre></td></tr></table></figure><p>æˆ‘åœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†å¦‚ä¸‹çš„æŠ¥é”™</p>\n<p><img data-src=\"/android-bcc/image-20240512122600431.png\" alt=\"image-20240512122600431\" style=\"aspect-ratio:1482 / 265;\"></p>\n<p>å…ˆè£…ä¸ª pip</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">wget</span> https://bootstrap.pypa.io/get-pip.py</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>python get-pip.py</pre></td></tr></table></figure><p>ç„¶åå†å®‰è£… setuptools</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">wget</span> https://files.pythonhosted.org/packages/af/e7/02db816dc88c598281bacebbb7ccf2c9f1a6164942e88f1a0fded8643659/setuptools-45.0.0-py2.py3-none-any.whl</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>pip <span class=\"token function\">install</span> setuptools-45.0.0-py2.py3-none-any.whl</pre></td></tr></table></figure><p>åæ¥åˆæŠ¥é”™ zip æ²¡å®‰è£…</p>\n<p><img data-src=\"/android-bcc/image-20240512124227438.png\" alt=\"image-20240512124227438\" style=\"aspect-ratio:1179 / 150;\"></p>\n<p>è£…ä¸€ä¸ª zip</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> <span class=\"token function\">zip</span></pre></td></tr></table></figure><p>é‡æ–° <code>make</code>  ä¹‹åç¼–è¯‘æˆåŠŸï½</p>\n<p>ç„¶åæŠŠ bcc å®‰è£…ä¸€ä¸‹</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token function\">install</span></pre></td></tr></table></figure><p>éšåå†ç¼–è¯‘ä¸€ä¸‹ python çš„ bcc</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cmake <span class=\"token parameter variable\">-DPYTHON_CMD</span><span class=\"token operator\">=</span>python3 <span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">pushd</span> src/python/</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">make</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token function\">install</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">popd</span></pre></td></tr></table></figure><p>è¯•è¯•çœ‹å®˜æ–¹çš„ä¾‹å­</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>python3 bcc/examples/hello_world.py</pre></td></tr></table></figure><p>ç»“æœç«Ÿç„¶æ²¡è¾“å‡ºï¼Ÿ</p>\n<p>å“ˆå“ˆï¼ŒåŸæ¥æ˜¯ tracing çš„å¼€å…³æ²¡å¼€ï¼Œå¼€ä¸€ä¸‹</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token number\">1</span> <span class=\"token operator\">></span> /sys/kernel/tracing/tracing_on</pre></td></tr></table></figure><p><strong>Hello, World!</strong></p>\n<p><img data-src=\"/android-bcc/image-20240512135018318.png\" alt=\"image-20240512135018318\" style=\"aspect-ratio:1030 / 192;\"></p>\n<h1 id=\"å‚è€ƒèµ„æ–™\"><a class=\"anchor\" href=\"#å‚è€ƒèµ„æ–™\">#</a> å‚è€ƒèµ„æ–™</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLnNlZWZsb3dlci5kZXYvYXJjaGl2ZXMvMTQwLw==\">eBPF on Android ä¹‹ bcc ç¯å¢ƒå‡†å¤‡ â€”â€”eadb åŸç‰ˆ</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjc1MTc2Lmh0bQ==\">[åŸåˆ›] 60 ç§’å­¦ä¼šç”¨ eBPF-BCC hook ç³»ç»Ÿè°ƒç”¨ ( 2 ) hook å®‰å“æ‰€æœ‰ syscall</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLnNlZWZsb3dlci5kZXYvYXJjaGl2ZXMvMTExLyM=\">eBPF on Android ä¹‹ bcc ç¼–è¯‘ä¸ä½“éªŒ</span></li>\n</ul>\n",
            "tags": []
        },
        {
            "id": "https://oacia.dev/d3ctf-2024/",
            "url": "https://oacia.dev/d3ctf-2024/",
            "title": "d3ctf2024 reverse wp",
            "date_published": "2024-04-28T16:12:07.000Z",
            "content_html": "<h1 id=\"å‰è¨€\"><a class=\"anchor\" href=\"#å‰è¨€\">#</a> å‰è¨€</h1>\n<p>å·²ç»æ˜¯å››æœˆåº•äº†ï¼Œä½†æ˜¯å´çªç„¶å‘ç°è¿™ä¸€æ•´ä¸ªæœˆéƒ½æ²¡æœ‰åœ¨åšå®¢å†™äº›ä»€ä¹ˆï¼Œæ„Ÿè§‰åˆæ˜¯åœ¨ä¸æ˜æ‰€ä»¥ä¸­åº¦è¿‡äº†ï¼Œæƒ³çœ‹çš„ <code>magisk</code> , <code>frida</code>  æºç æ²¡æœ‰çœ‹å®Œï¼Œæƒ³åšçš„å°å¤çš„ live2d ä¹Ÿè¿Ÿè¿Ÿæ²¡æœ‰åŠ¨å·¥ï¼Œä¸‹ä¸ªæœˆåŠªåŠªåŠ›ï¼Œå¤šå­¦ç‚¹ï¼Œå¤šåšç‚¹ï¼ŒåŠ æ²¹åŠ æ²¹</p>\n<p>æ€»è§‰å¾—è‡ªå·±è¿˜æ˜¯è¦å†™ä¸‹ç‚¹ä»€ä¹ˆæ‰å¥½ï¼Œæ°å¥½è¿™å‘¨å¬é—»æœ‰ä¸ª d3ctf, äºæ˜¯ä¾¿æƒ³æ¥çœ‹çœ‹é€†å‘é¢˜ï¼Œå»å­¦ä¹ ä¸€ä¸‹æ–°çŸ¥è¯†å¼€æ‹“è§†é‡ï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†åº¦è¿‡ä¸€æ®µå……å®çš„å‘¨æœ«æ—¶å…‰</p>\n<p>å›æƒ³å»å¹´çš„ d3ctf, æ„Ÿè§‰é‚£æ—¶çš„è‡ªå·±æœ‰å¤ªå¤šä¸äº†è§£çš„åœ°æ–¹äº†ï¼Œäºæ˜¯ä¹æƒ…ç†ä¹‹ä¸­çš„ä¹Ÿæ˜¯ä¸€é¢˜éƒ½æ²¡åšå‡ºæ¥äº†ï¼Œå¤ç°çš„é¢˜ç›®çš„è®¡åˆ’åœ¨æˆ‘çš„ todolist é‡Œé¢èººäº†å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œç„¶è€Œä¸çŸ¥ä¸è§‰é—´å˜æˆäº† undo, æœ€ååˆ°ç°åœ¨çš„ forget do,never do</p>\n<p>åŒæ—¶æˆ‘ä¹Ÿæƒ³æ¥çœ‹çœ‹ä¸€ä¸‹è¿™ä¸€å¹´çš„è‡ªå·±æœ‰äº†ä»€ä¹ˆå˜åŒ–ï¼Œæ„Ÿè§‰ç°åœ¨å¯ä»¥ç§°è‡ªå·±æ˜¯ä¸€ä½å…¥é—¨é€†å‘å·¥ç¨‹å¸ˆäº†å§å“ˆå“ˆå“ˆï¼Œæ€»å…±äº”é“é€†å‘é¢˜åšå¥½äº†ä¸‰é¢˜ï¼Œå¯æƒœå‘¨æ—¥å› ä¸ºè¦è°ƒä¼‘çš„ç¼˜æ•… (è°å‘æ˜çš„è°ƒä¼‘ï¼Ÿï¼) ä¾¿æ²¡æœ‰å†ç»§ç»­çœ‹é¢˜äº†ï¼Œé¢˜ç›®æŒºä¸é”™çš„ï¼Œä¸è¿‡è¦æ˜¯å¯ä»¥æœ‰å®‰å“é¢˜çš„è¯æˆ‘åº”è¯¥ä¼šæœ‰ç™¾åˆ†ä¹‹ä¸‰ç™¾çš„ç²¾æ°”ç¥å»åšå§ <code>^.^</code></p>\n<p>ç¿»äº†ç¿»è‡ªå·±è¿‡å»å†™çš„ ctf æ–‡ç« ï¼Œé‚£ä¹Ÿä»…ä»…æ˜¯ wp å‡ºä¸ª flag è€Œå·²ï¼Œä½†æ˜¯ flag ä¸æ˜¯é¢˜ç›®çš„ç»ˆç‚¹ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶ä¸­è•´è—çš„æŠ€å·§ï¼Œæ‰‹æ³•æ‰æ˜¯çœŸæ­£å€¼å¾—æ€»ç»“ä¸€ç¯‡æ–‡ç« çš„åœ°æ–¹ï¼Œæˆ‘å¯ä¸å¸Œæœ›è‡ªå·±å†™çš„æ–‡ç« åœ¨æœªæ¥è¿æˆ‘è‡ªå·±éƒ½ä¸æ„¿é‡æ–°ç¿»çœ‹ <code>(â—Ë‡âˆ€Ë‡â—)</code></p>\n<p>é¢˜ç›®é™„ä»¶ç‚¹<span class=\"exturl\" data-url=\"aHR0cHM6Ly9vYWNpYS5naXRodWIuaW8vZDNjdGYtMjAyNC9kM2N0ZjIwMjQuemlw\">è¿™é‡Œ</span>ä¸‹è½½ï½</p>\n<h1 id=\"forest\"><a class=\"anchor\" href=\"#forest\">#</a> forest</h1>\n<p>å¾ˆå¥½çš„ä¸€é“é¢˜ï¼Œå°† MSVC çš„ SEH å¼‚å¸¸å¤„ç†ä½¿ç”¨çš„ååˆ†å·§å¦™ï¼ŒåŒæ—¶ç‚¹å’Œå›¾çš„æ€æƒ³ä¹Ÿåœ¨è¿™é¢˜æœ‰äº†å……åˆ†çš„ä½“ç°ï¼Œåœ¨åšè¿™é¢˜çš„æ—¶å€™æœ‰ä¸€ä¸ªå¤±è´¥çš„è§£æ³•ï¼Œä¸è¿‡æˆ‘æ„Ÿè§‰å¾ˆæœ‰æ„æ€æ‰€ä»¥ä¹Ÿåœ¨è¿™é‡Œè®°å½•ä¸‹æ¥å•¦</p>\n<p>è¿™é‡Œä½ ä¼šçœ‹åˆ°åœ°å€éƒ½æ˜¯ 61 å¼€å¤´ï¼Œé‚£æ—¶å› ä¸ºç”¨ od çš„æ—¶å€™é‡Œé¢çš„åŸºå€å°±æ˜¯ <code>0x610000</code> , æ‰€ä»¥å½“æ—¶ä¸ºäº†å’Œ ida ä¸­å¯¹åº”èµ·æ¥æˆ‘ä¹Ÿæ”¹æˆäº† 61 å¼€å¤´ï¼Œä¸è¿‡æœ€å od è¿˜æ˜¯æ²¡æœ‰æ’ä¸Šç”¨åœºå…¨é  ida åŠ¨æ€è°ƒè¯•å•¦</p>\n<p>è¿™é‡Œé€šè¿‡ä¸»åŠ¨è®¾ç½® <code>int 3</code>  æ–­ç‚¹è§¦å‘ <code>0x80000003</code>  æ–­ç‚¹å¼‚å¸¸è¿›å…¥ sub_611A00</p>\n<p><img data-src=\"/d3ctf-2024/image-20240427182852533-1714325058585-5.png\" alt=\"image-20240427182852533\" style=\"aspect-ratio:1321 / 382;\"></p>\n<p>åœ¨ sub_611A00 ä¸­ï¼Œå¯¹å¼‚å¸¸ç è¿›è¡Œåˆ¤æ–­ï¼Œè¿™é‡Œå¯ä»¥é‡å®šä¹‰ this å‚æ•°ç±»å‹ä¸º <code>_EXCEPTION_POINTERS</code> , è¿™æ ·çœ‹èµ·æ¥æ›´æ–¹ä¾¿äº›ï¼Œæ„Ÿè§‰æ˜¯ä¸€ä¸ªå°å°çš„çªç ´å£å“¦</p>\n<p><img data-src=\"/d3ctf-2024/image-20240427182955955.png\" alt=\"image-20240427182955955\" style=\"aspect-ratio:1485 / 448;\"></p>\n<p>é¦–æ¬¡è§¦å‘æ–­ç‚¹å¼‚å¸¸ï¼Œè§£å¯†ç”± <code>VirtualProtect</code>  åˆ†é…çš„å†…å­˜åœ°å€çš„å€¼ï¼Œå¹¶è®¾ç½® <code>byte_616028</code>  æ ‡å¿—ä¸º 0, ä¸‹ä¸€æ¬¡è§¦å‘æ–­ç‚¹å¼‚å¸¸å°†è§†ä¸º flag é”™è¯¯ï¼Œè¿›ç¨‹é€€å‡º</p>\n<p><img data-src=\"/d3ctf-2024/image-20240427183012954.png\" alt=\"image-20240427183012954\" style=\"aspect-ratio:945 / 839;\"></p>\n<p>è§£å¯†å®Œæˆåè®¾ç½® EIP, å¹¶é€šè¿‡ <code>this-&gt;ContextRecord-&gt;EFlags |= 0x100</code>  è®¾ç½®å•æ­¥è°ƒè¯•æ¨¡å¼ï¼Œä½¿æ ‡å¿—å¯„å­˜å™¨ç¬¬ 8 ä½ TF ä¸º 1</p>\n<p><img data-src=\"/d3ctf-2024/image-20240427183214681.png\" alt=\"image-20240427183214681\" style=\"aspect-ratio:768 / 274;\"></p>\n<p>éšåç¨‹åºä¼šé€šè¿‡è°ƒç”¨ <code>cli</code>  ç‰¹æƒæŒ‡ä»¤å®ç° shellcode çš„è·³è½¬</p>\n<p><img data-src=\"/d3ctf-2024/image-20240427184042129.png\" alt=\"image-20240427184042129\" style=\"aspect-ratio:1260 / 371;\"></p>\n<p><img data-src=\"/d3ctf-2024/image-20240427184106659.png\" alt=\"image-20240427184106659\" style=\"aspect-ratio:1005 / 382;\"></p>\n<p><code>int 2Dh</code>  è¡¨ç¤º flag é”™è¯¯<img data-src=\"/d3ctf-2024/image-20240427184528371.png\" alt=\"image-20240427184528371\" style=\"aspect-ratio:1245 / 193;\"></p>\n<h2 id=\"å¤±è´¥-frida-ä¾§ä¿¡é“\"><a class=\"anchor\" href=\"#å¤±è´¥-frida-ä¾§ä¿¡é“\">#</a> [å¤±è´¥] frida ä¾§ä¿¡é“</h2>\n<p>è¯´çš„é«˜å¤§ä¸Šä¸€ç‚¹å«ä¾§ä¿¡é“ï¼Œå®é™…ä¸Šå°±æ˜¯çˆ†ç ´å“ˆå“ˆå“ˆï¼Œæˆ‘è°ƒè¯•çš„æ—¶å€™å‘ç°æ¯ä¸€æ¬¡è¾“å…¥çš„ flag ä¸ä¸€æ ·ï¼Œè°ƒç”¨ <code>cli</code>  ç‰¹æƒæŒ‡ä»¤è§¦å‘ <code>0xC0000096</code>  çš„æ¬¡æ•°ä¹Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘å°±åœ¨æƒ³ï¼Œè¦æ˜¯æˆ‘å¯ä»¥ä¸€ä½ä¸€ä½çš„çˆ†ç ´ï¼Œé€šè¿‡åœ¨å¤„ç† <code>0xC0000096</code>  å¼‚å¸¸çš„åœ°æ–¹ä¸‹æ–­ç‚¹ç»Ÿè®¡è°ƒç”¨æ¬¡æ•°ï¼Œç„¶åç„¶è°ƒç”¨æœ€å¤šçš„é‚£ä¸ªå­—ç¬¦ä½œä¸ºè¿™ä¸€ä½çš„ flag, é‚£ä¸å°±å¾—åˆ°æœ€åçš„ flag äº†å˜›ï½</p>\n<p>æ‰€ä»¥è¿™å›ç”¨ä¸Šäº†æˆ‘çš„è€ä¼™è®¡ frida, æƒ³è¦é€šè¿‡ frida å®ç°çˆ†ç ´ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨ frida çš„ python è„šæœ¬ï¼ŒåŒæ—¶è¾“å…¥ä¹Ÿä¸èƒ½å†æ˜¯ <code>console.log</code> , è€Œæ˜¯éœ€è¦ä½¿ç”¨ <code>send</code>  å°†ç»“æœè¿”å›åˆ° python ä¸­å»åšå¤„ç†</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">my_hook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByName</span><span class=\"token punctuation\">(</span>exe_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x1BDE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>eax<span class=\"token punctuation\">.</span><span class=\"token function\">compare</span><span class=\"token punctuation\">(</span><span class=\"token number\">0xC0000096</span><span class=\"token punctuation\">)</span><span class=\"token operator\">===</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    count<span class=\"token operator\">=</span>count<span class=\"token operator\">+</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                    <span class=\"token comment\">//console.log(this.context.eax)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    <span class=\"token comment\">//console.log(ptr(module.base.add(0xAD20).readS32()).readS32().toString(16))</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                    <span class=\"token comment\">//console.log(ptr(module.base.add(0xAD24).readS32()).readS32().toString(16))</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                    <span class=\"token function\">send</span><span class=\"token punctuation\">(</span>count<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">retval</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">// d3ctf&#123;01234567890123456&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span>my_hook<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>è¿™ä¸ª python çš„ä»£ç è™½ç„¶å¾ˆç®€å•ä½†æ˜¯ä¹Ÿå·§å¦™ï¼Œå˜»å˜»</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> os</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> subprocess</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> frida</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> string</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#d3ctf&#123;0ut00431101002001&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">on_message</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">global</span> max_count<span class=\"token punctuation\">,</span>max_ch<span class=\"token punctuation\">,</span>current_ch</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> message<span class=\"token punctuation\">[</span><span class=\"token string\">'type'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">'send'</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> max_count<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            max_count <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">[</span><span class=\"token string\">'payload'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            max_ch <span class=\"token operator\">=</span> current_ch</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">elif</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">[</span><span class=\"token string\">'payload'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span>max_count<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            max_count <span class=\"token operator\">=</span> message<span class=\"token punctuation\">[</span><span class=\"token string\">'payload'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            max_ch <span class=\"token operator\">=</span> current_ch</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">elif</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">[</span><span class=\"token string\">'payload'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">==</span>max_count<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"NOTE! </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>max_ch<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> and </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>current_ch<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> have the same max_count </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>max_count<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">elif</span> message<span class=\"token punctuation\">[</span><span class=\"token string\">'type'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"error\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">[</span><span class=\"token string\">\"description\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">[</span><span class=\"token string\">\"stack\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">[</span><span class=\"token string\">\"fileName\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"line:\"</span><span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">[</span><span class=\"token string\">\"lineNumber\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"colum:\"</span><span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">[</span><span class=\"token string\">\"columnNumber\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>jscode <span class=\"token operator\">=</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"trace_forest.js\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"rb\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>t_flag <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"d3ctf&#123;01234567890123456&#125;\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token number\">23</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    max_count<span class=\"token punctuation\">,</span> max_ch <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">None</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    break_flag <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">for</span> c <span class=\"token keyword\">in</span> string<span class=\"token punctuation\">.</span>printable<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        current_ch <span class=\"token operator\">=</span> c</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        t_flag<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> c</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        process <span class=\"token operator\">=</span> subprocess<span class=\"token punctuation\">.</span>Popen<span class=\"token punctuation\">(</span><span class=\"token string\">\"forest.exe\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                                   stdin<span class=\"token operator\">=</span>subprocess<span class=\"token punctuation\">.</span>PIPE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                                   stdout<span class=\"token operator\">=</span>subprocess<span class=\"token punctuation\">.</span>PIPE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                                   stderr<span class=\"token operator\">=</span>subprocess<span class=\"token punctuation\">.</span>PIPE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                                   universal_newlines<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        session <span class=\"token operator\">=</span> frida<span class=\"token punctuation\">.</span>attach<span class=\"token punctuation\">(</span><span class=\"token string\">\"forest.exe\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        script <span class=\"token operator\">=</span> session<span class=\"token punctuation\">.</span>create_script<span class=\"token punctuation\">(</span>jscode<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        script<span class=\"token punctuation\">.</span>on<span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> on_message<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        script<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        process<span class=\"token punctuation\">.</span>stdin<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>t_flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        output<span class=\"token punctuation\">,</span> error <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>communicate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        process<span class=\"token punctuation\">.</span>terminate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    t_flag<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> max_ch</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token string\">''</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>t_flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">, max: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>max_count<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>ä½†æ˜¯å¯æƒœçš„æ˜¯ç¨‹åºè·‘å®Œå‡ºæ¥äº†è¿™ä¸ª <code>d3ctf&#123;0ut00431101002001&#125;</code> , è™½ç„¶æ˜¯é”™çš„ä½†æ˜¯å›æ˜¾ä¸ä¸€æ ·äº† <code>^.^</code></p>\n<p>è¿™ä½•å°ä¸æ˜¯ä¸€ç§èƒœåˆ©ï½ä¸è¿‡æ¢ä¸ªæ–¹æ³•å’¯</p>\n<p><img data-src=\"/d3ctf-2024/image-20240429013314486.png\" alt=\"image-20240429013314486\" style=\"aspect-ratio:1023 / 281;\"></p>\n<h2 id=\"æˆåŠŸ-å›¾-ç‚¹-è·¯å¾„\"><a class=\"anchor\" href=\"#æˆåŠŸ-å›¾-ç‚¹-è·¯å¾„\">#</a> [æˆåŠŸ] å›¾ ç‚¹ è·¯å¾„</h2>\n<p>å¦‚æœæƒ³è¦äº§ç”Ÿæ­£ç¡®çš„å›æ˜¾ï¼Œå¿…é¡»è§¦å‘ <code>0xC0000005</code>  å¼‚å¸¸</p>\n<p><img data-src=\"/d3ctf-2024/image-20240427210553263.png\" alt=\"image-20240427210553263\" style=\"aspect-ratio:1474 / 275;\"></p>\n<p>è¾“å…¥çš„å­—ç¬¦ä¸²å°†ä¼šè¢«å…¨éƒ¨è½¬æ¢ä¸ºäºŒè¿›åˆ¶çš„å½¢å¼ï¼Œæ¯æ‰§è¡Œ <code>cli</code>  ç‰¹æƒæŒ‡ä»¤è§¦å‘ <code>0xC0000096</code>  å¼‚å¸¸åéƒ½ä¼šè¯»å–ä¸€ä½</p>\n<p><img data-src=\"/d3ctf-2024/image-20240427211258536.png\" alt=\"image-20240427211258536\" style=\"aspect-ratio:935 / 180;\"></p>\n<p>å¦‚æœä¸º 0, åˆ™ä¸‹ä¸€æ¬¡è§¦å‘ <code>0x80000004</code>  å•æ­¥è°ƒè¯•å¼‚å¸¸ä¸”å½“å‰æŒ‡ä»¤çš„åç§»é€»è¾‘ <code>&amp;0x3F</code>  ç­‰äº 7 æ—¶ï¼Œå°†ä¼šè®©å½“å‰çš„ Eip åŠ ä¸Š 23</p>\n<p><img data-src=\"/d3ctf-2024/image-20240427211317024.png\" alt=\"image-20240427211317024\" style=\"aspect-ratio:1109 / 241;\"></p>\n<p>è¿›å…¥ä¸‹ä¸€ä¸ªå—çš„ä½ç½®ç”± unk_EAA720 å’Œ unk_EA8658 è¿›è¡Œæ§åˆ¶ï¼Œç®—æ³•ä¸º <code>(unk_EAA720+unk_EA8658+(unk_EA8658&lt;&lt;4))&lt;&lt;6</code></p>\n<p><img data-src=\"/d3ctf-2024/image-20240427211804141.png\" alt=\"image-20240427211804141\" style=\"aspect-ratio:560 / 172;\"></p>\n<p>è§‚å¯Ÿåå‘ç°è¿™æ˜æ˜¾å°±æ˜¯ä¸€ä¸ªå›¾å‘€ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ idapython æ‰¾åˆ°å›¾çš„æ‰€æœ‰è¾¹</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># d3ctf&#123;0ut00431101002001&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> idautils</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> idc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> ida_bytes</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>base <span class=\"token operator\">=</span> <span class=\"token number\">0x616035</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>pattern <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"B8 FF FF FF FF C7 00 ?? 00 00 00 B8 FF FF FF FF C7 00 ?? 00 00 00 FA\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>pl <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># point list</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>pattern<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    cur_addr <span class=\"token operator\">=</span> <span class=\"token number\">0x616035</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    end_addr <span class=\"token operator\">=</span> <span class=\"token number\">0x616035</span> <span class=\"token operator\">+</span> <span class=\"token number\">0x483D</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">while</span> cur_addr <span class=\"token operator\">&lt;</span> end_addr<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        cur_addr <span class=\"token operator\">=</span> idc<span class=\"token punctuation\">.</span>find_binary<span class=\"token punctuation\">(</span>cur_addr<span class=\"token punctuation\">,</span> idc<span class=\"token punctuation\">.</span>SEARCH_DOWN<span class=\"token punctuation\">,</span> pattern<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">if</span> cur_addr <span class=\"token operator\">==</span> idc<span class=\"token punctuation\">.</span>BADADDR<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">break</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            a <span class=\"token operator\">=</span> ida_bytes<span class=\"token punctuation\">.</span>get_byte<span class=\"token punctuation\">(</span>cur_addr <span class=\"token operator\">+</span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            b <span class=\"token operator\">=</span> ida_bytes<span class=\"token punctuation\">.</span>get_byte<span class=\"token punctuation\">(</span>cur_addr <span class=\"token operator\">+</span> <span class=\"token number\">18</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            pl<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token string\">\"cur\"</span><span class=\"token punctuation\">:</span> cur_addr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                <span class=\"token string\">\"off\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>a <span class=\"token operator\">+</span> b <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>b <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token string\">\"s\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        cur_addr <span class=\"token operator\">=</span> idc<span class=\"token punctuation\">.</span>next_head<span class=\"token punctuation\">(</span>cur_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>pattern <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"8B 00\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>pattern<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    cur_addr <span class=\"token operator\">=</span> <span class=\"token number\">0x616035</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    end_addr <span class=\"token operator\">=</span> <span class=\"token number\">0x616035</span> <span class=\"token operator\">+</span> <span class=\"token number\">0x483D</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">while</span> cur_addr <span class=\"token operator\">&lt;</span> end_addr<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        cur_addr <span class=\"token operator\">=</span> idc<span class=\"token punctuation\">.</span>find_binary<span class=\"token punctuation\">(</span>cur_addr<span class=\"token punctuation\">,</span> idc<span class=\"token punctuation\">.</span>SEARCH_DOWN<span class=\"token punctuation\">,</span> pattern<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token keyword\">if</span> cur_addr <span class=\"token operator\">==</span> idc<span class=\"token punctuation\">.</span>BADADDR<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token keyword\">break</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token comment\"># if cur_addr-(base+5) &amp;0x3F==7,eax->1, eip+23</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            pl<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token string\">\"cur\"</span><span class=\"token punctuation\">:</span> cur_addr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                <span class=\"token string\">\"off\"</span><span class=\"token punctuation\">:</span> cur_addr <span class=\"token operator\">+</span> <span class=\"token number\">23</span> <span class=\"token operator\">-</span> base<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token string\">\"s\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        cur_addr <span class=\"token operator\">=</span> idc<span class=\"token punctuation\">.</span>next_head<span class=\"token punctuation\">(</span>cur_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>pl<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>ç„¶åæ‰“å°ä¸€ä¸‹æ²¡æœ‰å¯¹åº”ç«¯ç‚¹çš„ç‚¹ï¼Œè¿™é‡Œåªæ˜¯éƒ¨åˆ†ï¼Œå®é™…ä¸Šè¿˜æœ‰å¾ˆå¤šâ€¦</p>\n<p><img data-src=\"/d3ctf-2024/image-20240427232406322.png\" alt=\"image-20240427232406322\" style=\"aspect-ratio:600 / 286;\"></p>\n<p>ä¹‹åä¸€ä¸ªä¸€ä¸ªè¯•è¿‡å»ï¼Œå°±æœ‰ flag äº† (ä¸ºä»€ä¹ˆä¸ç”¨ for å¾ªç¯å°è¯•æ‰€æœ‰å¯èƒ½çš„ç‚¹ï¼Œå› ä¸ºç”¨ for å¾ªç¯ <code>all_simple_paths</code>  ä¸å‡ºç»“æœå‘œ)</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>base <span class=\"token operator\">=</span> <span class=\"token number\">0x616035</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>pl <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">]</span><span class=\"token comment\"># ida python çš„ç»“æœ</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> networkx <span class=\"token keyword\">as</span> nx</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>G <span class=\"token operator\">=</span> nx<span class=\"token punctuation\">.</span>DiGraph<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">for</span> p <span class=\"token keyword\">in</span> pl<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    G<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">\"cur\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>out_way <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">for</span> p <span class=\"token keyword\">in</span> pl<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> p<span class=\"token punctuation\">[</span><span class=\"token string\">\"s\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">if</span> G<span class=\"token punctuation\">.</span>has_node<span class=\"token punctuation\">(</span>base<span class=\"token operator\">+</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">\"off\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            G<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">\"cur\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>base<span class=\"token operator\">+</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">\"off\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">if</span> base<span class=\"token operator\">+</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">'off'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span><span class=\"token number\">0x616035</span> <span class=\"token operator\">+</span> <span class=\"token number\">0x483D</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"find a way out: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">'cur'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> --> </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>base<span class=\"token operator\">+</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">'off'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                G<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span>base<span class=\"token operator\">+</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">'off'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                G<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>base<span class=\"token punctuation\">,</span>base<span class=\"token operator\">+</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">'off'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                out_way<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>base<span class=\"token operator\">+</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">'off'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"no taget point: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">'cur'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> --> </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>base <span class=\"token operator\">+</span> p<span class=\"token punctuation\">[</span><span class=\"token string\">'off'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                out_way<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>base <span class=\"token operator\">+</span> p<span class=\"token punctuation\">[</span><span class=\"token string\">'off'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">if</span> G<span class=\"token punctuation\">.</span>has_node<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">\"cur\"</span><span class=\"token punctuation\">]</span><span class=\"token operator\">+</span><span class=\"token number\">2</span><span class=\"token operator\">+</span><span class=\"token number\">23</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            G<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">\"cur\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">\"cur\"</span><span class=\"token punctuation\">]</span><span class=\"token operator\">+</span><span class=\"token number\">2</span><span class=\"token operator\">+</span><span class=\"token number\">23</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">if</span> G<span class=\"token punctuation\">.</span>has_node<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">\"cur\"</span><span class=\"token punctuation\">]</span><span class=\"token operator\">+</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            G<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">[</span><span class=\"token string\">\"cur\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">[</span><span class=\"token string\">\"cur\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ERRR\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>start <span class=\"token operator\">=</span> <span class=\"token number\">0x616035</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>tem <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>out <span class=\"token operator\">=</span> <span class=\"token number\">0x616c0e</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">for</span> path <span class=\"token keyword\">in</span> nx<span class=\"token punctuation\">.</span>all_simple_paths<span class=\"token punctuation\">(</span>G<span class=\"token punctuation\">,</span> source<span class=\"token operator\">=</span>start<span class=\"token punctuation\">,</span> target<span class=\"token operator\">=</span>out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    tem<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">#print(tem)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token comment\">#print(len(tem[0]))</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    pll <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">for</span> t <span class=\"token keyword\">in</span> tem<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token keyword\">for</span> p <span class=\"token keyword\">in</span> pl<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token keyword\">if</span> p<span class=\"token punctuation\">[</span><span class=\"token string\">\"cur\"</span><span class=\"token punctuation\">]</span><span class=\"token operator\">==</span>t<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token comment\">#print(p[\"cur\"],p[\"s\"])</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                pll<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token keyword\">break</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    start <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    flag<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">for</span> p <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>pll<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token keyword\">if</span> p<span class=\"token operator\">!=</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> pll<span class=\"token punctuation\">[</span>p<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"s\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                <span class=\"token keyword\">if</span> pll<span class=\"token punctuation\">[</span>p<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"cur\"</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-</span>pll<span class=\"token punctuation\">[</span>p<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"cur\"</span><span class=\"token punctuation\">]</span><span class=\"token operator\">==</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                    flag<span class=\"token operator\">+=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                    flag<span class=\"token operator\">+=</span><span class=\"token string\">\"1\"</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span><span class=\"token operator\">//</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">chr</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token operator\">*</span>i<span class=\"token punctuation\">:</span><span class=\"token number\">8</span><span class=\"token operator\">*</span>i<span class=\"token operator\">+</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>end<span class=\"token operator\">=</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h1 id=\"ezjunk\"><a class=\"anchor\" href=\"#ezjunk\">#</a> ezjunk</h1>\n<p>ä»æ•´ä¸ªç¨‹åºçš„å…¥å£ <code>start</code>  å‡½æ•°å¼€å§‹åˆ†æï¼Œåœ¨æ‰§è¡Œ main å‡½æ•°å‰ï¼Œè¿˜ä¼šè°ƒç”¨ <code>sub_401CC0</code>  å‡½æ•°</p>\n<p><img data-src=\"/d3ctf-2024/image-20240429004720898.png\" alt=\"image-20240429004720898\" style=\"aspect-ratio:869 / 231;\"></p>\n<p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œä¼šå¯¹ <code>sub_401550</code>  è¿›è¡Œè°ƒç”¨</p>\n<p><img data-src=\"/d3ctf-2024/image-20240429004856409.png\" alt=\"image-20240429004856409\" style=\"aspect-ratio:700 / 168;\"></p>\n<p>ä½†æ˜¯å´æ²¡æ³•ç›´æ¥åç¼–è¯‘ï¼Œæ—¢ç„¶æ˜¯æ ˆçš„é—®é¢˜ï¼ŒæŠŠ <code>sub rsp, 30h</code>  nop æ‰å°±å¥½å•¦</p>\n<p><img data-src=\"/d3ctf-2024/image-20240429005457581.png\" alt=\"image-20240429005457581\" style=\"aspect-ratio:863 / 399;\"></p>\n<p>æœ‰ä¸ªåè°ƒè¯•ï¼Œè¿‡ä¸€ä¸‹å°±å¥½äº†</p>\n<p><img data-src=\"/d3ctf-2024/image-20240427151306234.png\" alt=\"image-20240427151306234\" style=\"aspect-ratio:621 / 582;\"></p>\n<p><img data-src=\"/d3ctf-2024/image-20240429005548792.png\" alt=\"image-20240429005548792\" style=\"aspect-ratio:590 / 577;\"></p>\n<p>main å‡½æ•°çš„èŠ±æŒ‡ä»¤ä¹Ÿå¾ˆç®€å•ï¼Œå»ä¸€ä¸‹å°±çœ‹åˆ°é€»è¾‘å•¦</p>\n<p><img data-src=\"/d3ctf-2024/image-20240429010852125.png\" alt=\"image-20240429010852125\" style=\"aspect-ratio:1106 / 577;\"></p>\n<p>è¿›åˆ° <code>sub_401917</code>  é‡Œé¢ï¼Œåªæ˜¯ä¸€ä¸ª tea ç®—æ³•</p>\n<p><img data-src=\"/d3ctf-2024/image-20240429010317189.png\" alt=\"image-20240429010317189\" style=\"aspect-ratio:1234 / 418;\"></p>\n<p>ä¹‹åå°±æ˜¯ä¸€ä¸ªç±»ä¼¼ crc çš„ç®—æ³•</p>\n<p><img data-src=\"/d3ctf-2024/image-20240429010928318.png\" alt=\"image-20240429010928318\" style=\"aspect-ratio:848 / 653;\"></p>\n<p>ä¸è¿‡åœ¨è°ƒè¯•çš„æ—¶å€™è¿˜æ˜¯ä¸èƒ½ç›´æ¥æŠŠèŠ±æŒ‡ä»¤ nop æ‰çš„ï¼Œå› ä¸ºè¿™é‡Œè¯»å–çš„æ˜¯ <code>loc401A1C</code>  èŠ±æŒ‡ä»¤çš„æ±‡ç¼–ï¼Œå¦‚æœ nop æ‰å˜æˆ 90 çš„è¯ï¼Œtea çš„å¸¸æ•°å€¼ä¼šå‡ºé”™çš„</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> ctypes <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">encrypt</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    v0<span class=\"token punctuation\">,</span> v1 <span class=\"token operator\">=</span> c_uint32<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> c_uint32<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    delta <span class=\"token operator\">=</span> <span class=\"token number\">0xff58f981</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    total <span class=\"token operator\">=</span> c_uint32<span class=\"token punctuation\">(</span><span class=\"token number\">0xE8017300</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        v0<span class=\"token punctuation\">.</span>value <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">.</span>value <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">.</span>value <span class=\"token operator\">>></span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> v1<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span>total<span class=\"token punctuation\">.</span>value <span class=\"token operator\">+</span> key<span class=\"token punctuation\">[</span>total<span class=\"token punctuation\">.</span>value <span class=\"token operator\">&amp;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token number\">0x44</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        v1<span class=\"token punctuation\">.</span>value <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>v0<span class=\"token punctuation\">.</span>value <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span>v0<span class=\"token punctuation\">.</span>value <span class=\"token operator\">>></span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> v0<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                    total<span class=\"token punctuation\">.</span>value <span class=\"token operator\">+</span> key<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>total<span class=\"token punctuation\">.</span>value <span class=\"token operator\">>></span> <span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token number\">0x33</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        total<span class=\"token punctuation\">.</span>value <span class=\"token operator\">-=</span> delta</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">return</span> v0<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span> v1<span class=\"token punctuation\">.</span>value</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">decrypt</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    v0<span class=\"token punctuation\">,</span> v1 <span class=\"token operator\">=</span> c_uint32<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> c_uint32<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    delta <span class=\"token operator\">=</span> <span class=\"token number\">0xff58f981</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    total <span class=\"token operator\">=</span> c_uint32<span class=\"token punctuation\">(</span><span class=\"token number\">0xE8017300</span> <span class=\"token operator\">-</span> <span class=\"token number\">32</span> <span class=\"token operator\">*</span> delta<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        total<span class=\"token punctuation\">.</span>value <span class=\"token operator\">+=</span> delta</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        v1<span class=\"token punctuation\">.</span>value <span class=\"token operator\">-=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>v0<span class=\"token punctuation\">.</span>value <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span>v0<span class=\"token punctuation\">.</span>value <span class=\"token operator\">>></span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> v0<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                    total<span class=\"token punctuation\">.</span>value <span class=\"token operator\">+</span> key<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>total<span class=\"token punctuation\">.</span>value <span class=\"token operator\">>></span> <span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token number\">0x33</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        v0<span class=\"token punctuation\">.</span>value <span class=\"token operator\">-=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">.</span>value <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">.</span>value <span class=\"token operator\">>></span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> v1<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span>total<span class=\"token punctuation\">.</span>value <span class=\"token operator\">+</span> key<span class=\"token punctuation\">[</span>total<span class=\"token punctuation\">.</span>value <span class=\"token operator\">&amp;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token number\">0x44</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">return</span> v0<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span> v1<span class=\"token punctuation\">.</span>value</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\"># test</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\"># å¾…åŠ å¯†çš„æ˜æ–‡ï¼Œä¸¤ä¸ª 32 ä½æ•´å‹ï¼Œå³ 64bit çš„æ˜æ–‡æ•°æ®</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token comment\"># fakeflag&#123;Is_there_anywhere_else&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\"># value = [0x5406CBB1, 0xA4A41EA2, 0x34489AC5, 0x53D68797, 0xB8E0C06F, 0x0259F2DB, 0x52E38D82, 0x595D5E1D]</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    value <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0xB6DDB3A9</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x36162C23</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x1889FABF</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x6CE4E73B</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0A5AF8FC</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x21FF8415</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x44859557</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x2DC227B7</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    value <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>c_uint<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> v <span class=\"token keyword\">in</span> value<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token keyword\">if</span> value<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value<span class=\"token operator\">&amp;</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                value<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> c_uint<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">^</span> <span class=\"token number\">0x84A6972F</span><span class=\"token punctuation\">)</span><span class=\"token operator\">//</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x80000000</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#2086826726</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                value<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> c_uint<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value<span class=\"token operator\">//</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    value <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>v<span class=\"token punctuation\">.</span>value <span class=\"token keyword\">for</span> v <span class=\"token keyword\">in</span> value<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token comment\">#for v in value:</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token comment\">#print(hex(v))</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token comment\"># value = []</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token comment\"># å››ä¸ª keyï¼Œæ¯ä¸ªæ˜¯ 32bitï¼Œå³å¯†é’¥é•¿åº¦ä¸º 128bit</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    key <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0x00005454</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00004602</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00004477</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00005E5E</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    v <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">//</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        v<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value<span class=\"token punctuation\">[</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">[</span><span class=\"token number\">2</span> <span class=\"token operator\">*</span> i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        res <span class=\"token operator\">=</span> decrypt<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>res<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>to_bytes<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'little'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>res<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>to_bytes<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'little'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span> end<span class=\"token operator\">=</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h1 id=\"randomvm\"><a class=\"anchor\" href=\"#randomvm\">#</a> RandomVM</h1>\n<p>VM é¢˜å‹ï¼Œä¸è¿‡ç®—æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„é‚£ç§çœŸæ­£ç”¨åˆ°çš„æŒ‡ä»¤ä¸æ˜¯å¾ˆå¤šï¼Œida trace åœ¨å…³é”®å‡½æ•° trace ä¸€ä¸‹ï¼Œä¸è¿‡æœ‰ä¸ª ptrace åè°ƒè¯•æ³¨æ„ä¸€ä¸‹å°±å¥½å•¦</p>\n<p>syscall (0x65) ptrace åè°ƒè¯•ï¼Œè·³è¿‡è¿™æ¡æŒ‡ä»¤å°±å¥½äº†</p>\n<p><img data-src=\"/d3ctf-2024/image-20240427014538097.png\" alt=\"image-20240427014538097\" style=\"aspect-ratio:827 / 163;\"></p>\n<p>æ¯”è¾ƒé‡è¦çš„æœ‰è¿™äº›å‡½æ•°</p>\n<p><img data-src=\"/d3ctf-2024/image-20240427032349722.png\" alt=\"image-20240427032349722\" style=\"aspect-ratio:348 / 457;\"></p>\n<p>idapython trace ä¸€ä¸‹</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#xor</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> idc</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> ida_bytes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> idaapi</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ea <span class=\"token operator\">=</span> ida_bytes<span class=\"token punctuation\">.</span>get_byte<span class=\"token punctuation\">(</span>idaapi<span class=\"token punctuation\">.</span>get_imagebase<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">0xB072</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ecx<span class=\"token operator\">=</span>idc<span class=\"token punctuation\">.</span>get_reg_value<span class=\"token punctuation\">(</span><span class=\"token string\">\"ECX\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>eax<span class=\"token operator\">=</span>idc<span class=\"token punctuation\">.</span>get_reg_value<span class=\"token punctuation\">(</span><span class=\"token string\">\"EAX\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"final[</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>ea<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">] = </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>ecx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">^</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>eax<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> = </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>ecx<span class=\"token operator\">^</span>eax<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#mov</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">import</span> idc</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">import</span> ida_bytes</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">import</span> idaapi</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>ea <span class=\"token operator\">=</span> ida_bytes<span class=\"token punctuation\">.</span>get_byte<span class=\"token punctuation\">(</span>idaapi<span class=\"token punctuation\">.</span>get_imagebase<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">0xB072</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>eax<span class=\"token operator\">=</span>idc<span class=\"token punctuation\">.</span>get_reg_value<span class=\"token punctuation\">(</span><span class=\"token string\">\"EAX\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"final[</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>ea<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">] = </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>eax<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#circleRmov</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">import</span> idc</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">import</span> ida_bytes</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">import</span> idaapi</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">import</span> ctypes</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>ea <span class=\"token operator\">=</span> ida_bytes<span class=\"token punctuation\">.</span>get_byte<span class=\"token punctuation\">(</span>idaapi<span class=\"token punctuation\">.</span>get_imagebase<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">0xB072</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>edx<span class=\"token operator\">=</span>idc<span class=\"token punctuation\">.</span>get_reg_value<span class=\"token punctuation\">(</span><span class=\"token string\">\"EDX\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>ecx<span class=\"token operator\">=</span>idc<span class=\"token punctuation\">.</span>get_reg_value<span class=\"token punctuation\">(</span><span class=\"token string\">\"ECX\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">%</span><span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>res <span class=\"token operator\">=</span> ctypes<span class=\"token punctuation\">.</span>c_uint8<span class=\"token punctuation\">(</span>edx<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">if</span> ecx<span class=\"token operator\">!=</span><span class=\"token number\">0xffffffff</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    res <span class=\"token operator\">=</span> ctypes<span class=\"token punctuation\">.</span>c_uint8<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>value<span class=\"token operator\">>></span>ecx<span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>value<span class=\"token operator\">&lt;&lt;</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token operator\">-</span>ecx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    res <span class=\"token operator\">=</span> ctypes<span class=\"token punctuation\">.</span>c_uint8<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"final[</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>ea<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">] = </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>edx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">>></span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>ecx<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> | </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>edx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">&lt;&lt;</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token number\">8</span><span class=\"token operator\">-</span>ecx<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> = </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è¾“å…¥ <code>0123456789ab</code>  å¾—åˆ°è¾“å‡º</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span><span class=\"token operator\">^</span><span class=\"token number\">0x30</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x30</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x30</span><span class=\"token operator\">>></span><span class=\"token number\">3</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x30</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">5</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x6</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x6</span><span class=\"token operator\">^</span><span class=\"token number\">0x3</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x5</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x5</span><span class=\"token operator\">^</span><span class=\"token number\">0x31</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x34</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x2</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x31</span><span class=\"token operator\">>></span><span class=\"token number\">5</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x31</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">3</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x89</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x89</span><span class=\"token operator\">^</span><span class=\"token number\">0x32</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xbb</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x32</span><span class=\"token operator\">>></span><span class=\"token number\">6</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x32</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">2</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xc8</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xc8</span><span class=\"token operator\">^</span><span class=\"token number\">0x33</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xfb</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x4</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x33</span><span class=\"token operator\">>></span><span class=\"token number\">7</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x33</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">1</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x66</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x66</span><span class=\"token operator\">^</span><span class=\"token number\">0x7</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x61</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x61</span><span class=\"token operator\">^</span><span class=\"token number\">0x34</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x55</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x5</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x34</span><span class=\"token operator\">>></span><span class=\"token number\">4</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x34</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">4</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x43</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x43</span><span class=\"token operator\">^</span><span class=\"token number\">0x4</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x47</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x47</span><span class=\"token operator\">^</span><span class=\"token number\">0x35</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x72</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x6</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x35</span><span class=\"token operator\">>></span><span class=\"token number\">4</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x35</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">4</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x53</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x53</span><span class=\"token operator\">^</span><span class=\"token number\">0x36</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x65</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x7</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x36</span><span class=\"token operator\">>></span><span class=\"token number\">7</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x36</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">1</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x6c</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x6c</span><span class=\"token operator\">^</span><span class=\"token number\">0x7</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x6b</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x6b</span><span class=\"token operator\">^</span><span class=\"token number\">0x37</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x5c</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x8</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x37</span><span class=\"token operator\">>></span><span class=\"token number\">7</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x37</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">1</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x6e</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x6e</span><span class=\"token operator\">^</span><span class=\"token number\">0x38</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x56</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x9</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x38</span><span class=\"token operator\">>></span><span class=\"token number\">2</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x38</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">6</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xe</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xe</span><span class=\"token operator\">^</span><span class=\"token number\">0x39</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x37</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xa</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x39</span><span class=\"token operator\">>></span><span class=\"token number\">4</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x39</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">4</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x93</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x93</span><span class=\"token operator\">^</span><span class=\"token number\">0x61</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xf2</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xb</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x61</span><span class=\"token operator\">>></span><span class=\"token number\">4</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x61</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">4</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x16</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x16</span><span class=\"token operator\">^</span><span class=\"token number\">0x62</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x74</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xc</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x62</span><span class=\"token operator\">>></span><span class=\"token number\">7</span> <span class=\"token operator\">|</span> <span class=\"token number\">0x62</span><span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">1</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xc4</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xc4</span><span class=\"token operator\">^</span><span class=\"token number\">0x7</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xc3</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xbb</span><span class=\"token operator\">^</span><span class=\"token number\">0x34</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x8f</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xfb</span><span class=\"token operator\">^</span><span class=\"token number\">0x8f</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x74</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x55</span><span class=\"token operator\">^</span><span class=\"token number\">0x74</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x21</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x72</span><span class=\"token operator\">^</span><span class=\"token number\">0x21</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x53</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x65</span><span class=\"token operator\">^</span><span class=\"token number\">0x53</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x36</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x5c</span><span class=\"token operator\">^</span><span class=\"token number\">0x36</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x6a</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x56</span><span class=\"token operator\">^</span><span class=\"token number\">0x6a</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x3c</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x37</span><span class=\"token operator\">^</span><span class=\"token number\">0x3c</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xb</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xf2</span><span class=\"token operator\">^</span><span class=\"token number\">0xb</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xf9</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x74</span><span class=\"token operator\">^</span><span class=\"token number\">0xf9</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x8d</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>final<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0xc3</span><span class=\"token operator\">^</span><span class=\"token number\">0x8d</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x4e</span></pre></td></tr></table></figure><p>exp å¦‚ä¸‹</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> ctypes</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">circleR_rev</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> r<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    res <span class=\"token operator\">=</span> ctypes<span class=\"token punctuation\">.</span>c_uint8<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    res <span class=\"token operator\">=</span> ctypes<span class=\"token punctuation\">.</span>c_uint8<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>value <span class=\"token operator\">&lt;&lt;</span> r<span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>value <span class=\"token operator\">>></span> <span class=\"token punctuation\">(</span><span class=\"token number\">8</span> <span class=\"token operator\">-</span> r<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span>value</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>key <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0x9D</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x6B</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xA1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x02</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xD7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xED</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x40</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xF6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x0E</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xAE</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x84</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x19</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>circle_R <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>xor <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>flag <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> flag<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        flag<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> circleR_rev<span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">^</span>key<span class=\"token punctuation\">[</span>i<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">^</span>xor<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>circle_R<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        flag<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> circleR_rev<span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">^</span>key<span class=\"token punctuation\">[</span>i<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">^</span>xor<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">^</span>flag<span class=\"token punctuation\">[</span>i<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>circle_R<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> i<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        flag<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> circleR_rev<span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">^</span>xor<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">^</span>flag<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> circle_R<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span><span class=\"token builtin\">map</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">chr</span><span class=\"token punctuation\">,</span> flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure>",
            "tags": []
        },
        {
            "id": "https://oacia.dev/python-memory-leak/",
            "url": "https://oacia.dev/python-memory-leak/",
            "title": "è®°ä¸€æ¬¡python ctypes.castå¼•èµ·çš„å†…å­˜æ³„æ¼",
            "date_published": "2024-03-02T07:00:00.000Z",
            "content_html": "<div class=\"note info\">\n<p><strong>å†…å­˜æ³„æ¼</strong>ï¼ˆè‹±è¯­ï¼šmemory leakï¼‰æ˜¯<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU4JUFFJUExJUU3JUFFJTk3JUU2JTlDJUJBJUU3JUE3JTkxJUU1JUFEJUE2\">è®¡ç®—æœºç§‘å­¦</span>ä¸­çš„ä¸€ç§<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU4JUI1JTg0JUU2JUJBJTkwJUU2JUIzJTg0JUU2JUJDJThG\">èµ„æºæ³„æ¼</span>ï¼Œä¸»å› æ˜¯<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU4JUE4JTg4JUU3JUFFJTk3JUU2JUE5JTlGJUU3JUE4JThCJUU1JUJBJThG\">è®¡ç®—æœºç¨‹åº</span>çš„<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU4JUE4JTk4JUU2JTg2JUI2JUU5JUFCJTk0JUU3JUFFJUExJUU3JTkwJTg2\">å†…å­˜ç®¡ç†</span>å¤±å½“ [<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JTg2JTg1JUU1JUFEJTk4JUU2JUIzJTg0JUU2JUJDJThGI2NpdGVfbm90ZS0x\">1]</span>ï¼Œå› è€Œå¤±å»å¯¹ä¸€æ®µå·²åˆ†é…å†…å­˜ç©ºé—´çš„æ§åˆ¶ï¼Œç¨‹åºç»§ç»­å ç”¨å·²ä¸å†ä½¿ç”¨çš„<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JTg2JTg1JUU1JUFEJTk4\">å†…å­˜</span>ç©ºé—´ï¼Œæˆ–æ˜¯å­˜å‚¨å™¨æ‰€å­˜å‚¨ä¹‹å¯¹è±¡æ— æ³•é€è¿‡æ‰§è¡Œä»£ç è€Œè®¿é—®ï¼Œä»¤å†…å­˜èµ„æºç©ºè€— [<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JTg2JTg1JUU1JUFEJTk4JUU2JUIzJTg0JUU2JUJDJThGI2NpdGVfbm90ZS0y\">2]</span>ã€‚</p>\n</div>\n<p>ç›¸ä¿¡æ¯ä¸€ä¸ªæ•²è¿‡ä»£ç çš„æœ‹å‹è‚¯å®šéƒ½é‡åˆ°è¿‡å†…å­˜æ³„æ¼ï¼Œå¯¹äº c è¯­è¨€è¿™ç§åˆ†é…äº†å†…å­˜å´ä¸ä¼šè‡ªå·±é‡Šæ”¾çš„è¯­è¨€æ¥è¯´ï¼Œå†…å­˜æ³„æ¼ç®—æ˜¯å®¶å¸¸ä¾¿é¥­äº†ï¼Œä½†æ˜¯æˆ‘æœ€è¿‘åœ¨å†™ä¸€ä¸ª python ä»£ç çš„æ—¶å€™åŒæ ·ä¹Ÿé‡åˆ°äº†å†…å­˜æ³„æ¼ï¼Œæœ‰æœ‹å‹å¯èƒ½ä¼šé—®ï¼Œpython è¿™ç§è‡ªå¸¦å†…å­˜å›æ”¶æœºåˆ¶çš„è¯­è¨€æ€ä¹ˆè¿˜ä¼šå†…å­˜æ³„æ¼å‘¢ï¼Ÿ</p>\n<p>çœŸç›¸æ˜¯â€¦ æˆ‘åœ¨ python ä¸­è°ƒç”¨äº† c ç¼–è¯‘å‡ºæ¥çš„åŠ¨æ€é“¾æ¥åº“ï¼Œç„¶åå°±å†…å­˜æ³„æ¼äº†ï¼Œè€Œä¸”è¿™ä¸ªæ³„æ¼ç‚¹è—å¾—ç›¸å½“ä¹‹æ·±ï¼Œæˆ‘æ’æŸ¥äº†æ•´æ•´ä¸€æ•´å¤©æ‰æ‰¾åˆ° <code>-_-!</code></p>\n<h1 id=\"demo\"><a class=\"anchor\" href=\"#demo\">#</a> demo</h1>\n<p>ä¸‹é¢æ˜¯æœ‰å†…å­˜æ³„æ¼çš„ä»£ç çš„ demo, è¿™ä¸ªä»£ç å®ç°çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ <code>main.py</code>  ä¸­è°ƒç”¨ <code>double.dll</code>  çš„å¯¼å‡ºå‡½æ•° <code>double_string</code> , å®ç°çš„åŠŸèƒ½æ˜¯ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿”å›çš„å­—ç¬¦ä¸²æ˜¯ä¼ å…¥å­—ç¬¦ä¸²çš„ä¸¤å€ï¼Œç„¶è€Œå†…å­˜å´åœ¨ä¸æ–­çš„å¢å¤§</p>\n<p><img data-src=\"/python-memory-leak/image-20240302154453894.png\" alt=\"image-20240302154453894\" style=\"aspect-ratio:618 / 35;\"></p>\n<h2 id=\"doublec\"><a class=\"anchor\" href=\"#doublec\">#</a> double.c</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//gcc -fPIC -shared double.c -o double.dll</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token function\">double_string</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>input<span class=\"token punctuation\">,</span><span class=\"token keyword\">int</span> len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> double_input <span class=\"token operator\">=</span> <span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token operator\">*</span>len<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">strcpy</span><span class=\"token punctuation\">(</span>double_input<span class=\"token punctuation\">,</span> input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">strcat</span><span class=\"token punctuation\">(</span>double_input<span class=\"token punctuation\">,</span> input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">return</span> double_input<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"mainpy\"><a class=\"anchor\" href=\"#mainpy\">#</a> main.py</h2>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># main.py</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> ctypes</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dll <span class=\"token operator\">=</span> ctypes<span class=\"token punctuation\">.</span>CDLL<span class=\"token punctuation\">(</span><span class=\"token string\">'./double.dll'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>c_double_string <span class=\"token operator\">=</span> dll<span class=\"token punctuation\">.</span>double_string</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>c_double_string<span class=\"token punctuation\">.</span>argtypes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>ctypes<span class=\"token punctuation\">.</span>POINTER<span class=\"token punctuation\">(</span>ctypes<span class=\"token punctuation\">.</span>c_uint8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> ctypes<span class=\"token punctuation\">.</span>c_int<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>c_double_string<span class=\"token punctuation\">.</span>restype <span class=\"token operator\">=</span> ctypes<span class=\"token punctuation\">.</span>POINTER<span class=\"token punctuation\">(</span>ctypes<span class=\"token punctuation\">.</span>c_uint8<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">call_C_func</span><span class=\"token punctuation\">(</span>_data<span class=\"token punctuation\">:</span> <span class=\"token builtin\">bytes</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">bytes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    data <span class=\"token operator\">=</span> ctypes<span class=\"token punctuation\">.</span>create_string_buffer<span class=\"token punctuation\">(</span>_data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    data <span class=\"token operator\">=</span> ctypes<span class=\"token punctuation\">.</span>cast<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> ctypes<span class=\"token punctuation\">.</span>POINTER<span class=\"token punctuation\">(</span>ctypes<span class=\"token punctuation\">.</span>c_uint8<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ret <span class=\"token operator\">=</span> c_double_string<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    _ret <span class=\"token operator\">=</span> ctypes<span class=\"token punctuation\">.</span>string_at<span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">,</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>_data<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">return</span> _ret</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    call_C_func<span class=\"token punctuation\">(</span><span class=\"token string\">b\"abcd\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h1 id=\"å†…å­˜æ³„æ¼ç‚¹ä¸€\"><a class=\"anchor\" href=\"#å†…å­˜æ³„æ¼ç‚¹ä¸€\">#</a> å†…å­˜æ³„æ¼ç‚¹ä¸€</h1>\n<p>è¿™ç¬¬ä¸€ä¸ªæ³„æ¼ç‚¹å¾ˆæ˜æ˜¾ï¼Œæ˜¯åœ¨ <code>double.c</code>  ä¸­ï¼Œå› ä¸ºåœ¨ <code>double_string</code>  ä¸­åªæœ‰ä¸€ä¸ªå­¤é›¶é›¶çš„ <code>malloc</code> , ä½†æ˜¯å´æ²¡æœ‰ <code>free</code>  é™ªç€ä»–ï¼Œæ‰€ä»¥ç†æ‰€åº”å½“çš„å°±å†…å­˜æ³„æ¼äº†</p>\n<div class=\"note info\">\n<p>(malloc/realloc/colloc) å’Œ free å¿…é¡»ä¸¤ä¸¤å¯¹åº”æ‰ä¸ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œmalloc å°±æ˜¯å‘ç³»ç»Ÿç”³è¯·ä¸€å—æŒ‡å®šå¤§å°çš„å†…å­˜ï¼Œfree åˆ™æ˜¯å‘ç³»ç»Ÿå½’è¿˜æŒ‡å®šåœ°å€å¼€å§‹çš„ä¸€å—å†…å­˜</p>\n<p>åœ¨ c++ ä¸­ï¼Œ <code>newå’Œdelete</code>  æˆ–è€… <code>new[]å’Œdelete[]</code>  ä¹Ÿå¿…é¡»ä¸¤ä¸¤å¯¹åº”ï¼Œæ‰ä¸ä¼šå¯¼è‡´å†…å­˜æ³„æ¼</p>\n</div>\n<p>ä½†æ˜¯è¿™ä¸ª <code>free</code>  åº”è¯¥æ”¾åœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿé¦–å…ˆè‚¯å®šæ˜¯ä¸èƒ½åœ¨ <code>double_string</code>  ä¸­ free çš„ï¼Œä¸ç„¶å¥½ä¸å®¹æ˜“æŠŠä¼ è¿›æ¥çš„å­—ç¬¦ä¸²å¤„ç†å¥½æ­£å‡†å¤‡ä½œä¸ºè¿”å›å€¼ä¼ å›å»ï¼Œä½ åæ‰‹ä¸€ä¸ª free ç›´æ¥æŠŠè¿”å›å€¼ç»™ free æ²¡äº†è¿™æ€ä¹ˆè¡Œå‘¢</p>\n<p>æ‰€ä»¥è¿™ä¸ª free çš„æ—¶æœºåªèƒ½æ˜¯åœ¨ <code>main.py</code>  ä¸­è°ƒç”¨å®Œ <code>c_double_string</code>  ä¹‹åï¼Œpython ä¸­è¯¥æ€ä¹ˆæ‰§è¡Œ <code>free</code>  å‡½æ•°å‘€</p>\n<p>è¿™è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>\n<p>è®© c å¯¼å‡ºä¸€ä¸ªé‡Šæ”¾å†…å­˜çš„å‡½æ•° <code>c_free</code> , ç„¶ååœ¨ python é‡Œé¢å†å»è°ƒç”¨å®ƒä¸å°±å¥½äº†</p>\n<p><img data-src=\"/python-memory-leak/image-20240306113800822.png\" alt=\"image-20240306113800822\" style=\"aspect-ratio:1920 / 1079;\"></p>\n<p>ä½†æ˜¯è¿™æ ·ä¿®æ”¹äº†ä¹‹åï¼Œå†…å­˜ä¾ç„¶åœ¨ä¸æ–­çš„å¢åŠ </p>\n<p><img data-src=\"/python-memory-leak/image-20240302154600511.png\" alt=\"image-20240302154600511\" style=\"aspect-ratio:622 / 34;\"></p>\n<h1 id=\"å†…å­˜æ³„æ¼ç‚¹äºŒ\"><a class=\"anchor\" href=\"#å†…å­˜æ³„æ¼ç‚¹äºŒ\">#</a> å†…å­˜æ³„æ¼ç‚¹äºŒ</h1>\n<p>å†…å­˜æ—¢ç„¶è¿˜åœ¨æ³„æ¼ï¼Œå¹¶ä¸” c è¯­è¨€é‡Œé¢ä¹Ÿæ²¡æœ‰æ³„æ¼ç‚¹äº†ï¼Œé‚£ä¹ˆå”¯ä¸€è¿˜æœ‰å¯èƒ½çš„æ³„æ¼ç‚¹å°±æ˜¯åœ¨ python ä¸­äº†</p>\n<p>åœ¨ python ä¸­è°ƒç”¨äº†ä¸‰ä¸ª <code>ctypes</code>  ç›¸å…³çš„å‡½æ•°ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªåˆ†ææ¥çœ‹çœ‹æœ‰æ²¡æœ‰å¯èƒ½å­˜åœ¨çš„å†…å­˜æ³„æ¼</p>\n<p><strong>create_string_buffer</strong></p>\n<p>è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½æ˜¯å°† <code>bytes</code>  ç±»å‹è½¬æ¢æˆ <code>char[]</code>  ç±»å‹ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œ <code>buf</code>  å˜é‡çš„å†…å­˜æ˜¯é€šè¿‡ <code>c_char * size</code>  æ¥åˆ†é…çš„ï¼Œç”±äºå†…å­˜æ˜¯åœ¨ python ä¸­åˆ†é…ï¼Œpython ä¼šè‡ªå·±æŠŠä¸ç”¨çš„å†…å­˜å›æ”¶æ‰ï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šå†…å­˜æ³„æ¼<img data-src=\"/python-memory-leak/image-20240302155232066.png\" alt=\"image-20240302155232066\" style=\"aspect-ratio:1034 / 634;\"></p>\n<p><strong>string_at</strong></p>\n<p>è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½æ˜¯ä»ä¸€ä¸ªåœ°å€è¯»å–æŒ‡å®šé•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œå®ƒä»…ä»…åªæ˜¯è¯»æ•°æ®æ‰€ä»¥æ ¹æœ¬å°±æ²¡æœ‰èƒ½åŠ›å»å¯¼è‡´å†…å­˜æ³„æ¼</p>\n<p><img data-src=\"/python-memory-leak/image-20240305225058946.png\" alt=\"image-20240305225058946\" style=\"aspect-ratio:1133 / 204;\"></p>\n<p><strong>cast</strong></p>\n<p>å«Œç–‘äºº <code>cast</code>  ç»ˆäºå‡ºç°äº†ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯å°†ä¸€ä¸ªæ•°æ®è½¬æ¢æˆæŒ‡å®šç±»å‹çš„æ•°æ®</p>\n<blockquote>\n<p>ctypes.<strong>cast</strong>(<em>obj</em>, <em>type</em>)</p>\n<p>æ­¤å‡½æ•°ç±»ä¼¼äº C çš„å¼ºåˆ¶è½¬æ¢è¿ç®—ç¬¦ã€‚ å®ƒè¿”å›ä¸€ä¸ª <em>type</em> çš„æ–°å®ä¾‹ï¼Œè¯¥å®ä¾‹æŒ‡å‘ä¸ <em>obj</em> ç›¸åŒçš„å†…å­˜å—ã€‚ <em>type</em> å¿…é¡»ä¸ºæŒ‡é’ˆç±»å‹ï¼Œè€Œ <em>obj</em> å¿…é¡»ä¸ºå¯ä»¥è¢«ä½œä¸ºæŒ‡é’ˆæ¥è§£è¯»çš„å¯¹è±¡ã€‚</p>\n</blockquote>\n<p>æ‰¾æ‰¾è¿™ä¸ªå‡½æ•°åœ¨ python ä¸­çš„å®ç°æ˜¯ä»€ä¹ˆæ ·å­çš„</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># Python39\\Lib\\ctypes\\__init__.py</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">PYFUNCTYPE</span><span class=\"token punctuation\">(</span>restype<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>argtypes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">class</span> <span class=\"token class-name\">CFunctionType</span><span class=\"token punctuation\">(</span>_CFuncPtr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        _argtypes_ <span class=\"token operator\">=</span> argtypes</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        _restype_ <span class=\"token operator\">=</span> restype</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        _flags_ <span class=\"token operator\">=</span> _FUNCFLAG_CDECL <span class=\"token operator\">|</span> _FUNCFLAG_PYTHONAPI</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> CFunctionType</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>_cast <span class=\"token operator\">=</span> PYFUNCTYPE<span class=\"token punctuation\">(</span>py_object<span class=\"token punctuation\">,</span> c_void_p<span class=\"token punctuation\">,</span> py_object<span class=\"token punctuation\">,</span> py_object<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>_cast_addr<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">cast</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> typ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> _cast<span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">,</span> typ<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å†å»è¿½è¸ª <code>_cast_addr</code>  çš„å£°æ˜ï¼Œå‘ç° <code>cast</code>  æ˜¯ä» <code>_ctypes.pyd</code>  ä¸­å¯¼å‡ºçš„å‡½æ•°</p>\n<p><img data-src=\"/python-memory-leak/image-20240306115239843.png\" alt=\"image-20240306115239843\" style=\"aspect-ratio:1038 / 723;\"></p>\n<p>ä½†æ˜¯ <code>_ctypes.pyd</code>  æ¯•ç«Ÿæ˜¯å·²ç»ç¼–è¯‘è¿‡çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œæˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„æ˜¯ <code>cast</code>  çš„æºç ï¼Œè€Œå®ƒåœ¨ python çš„ github ä»“åº“ä¸­å¯ä»¥æ‰¾åˆ°ï¼Œ<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3B5dGhvbi9jcHl0aG9uL2Jsb2IvMy45L01vZHVsZXMvX2N0eXBlcy9fY3R5cGVzLmMjTDU2MTM=\">cast æºç </span></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> PyObject <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token function\">cast</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>ptr<span class=\"token punctuation\">,</span> PyObject <span class=\"token operator\">*</span>src<span class=\"token punctuation\">,</span> PyObject <span class=\"token operator\">*</span>ctype<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    CDataObject <span class=\"token operator\">*</span>result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// ç¡®ä¿è¢«è½¬æ¢çš„ç±»å‹æ˜¯ä¸€ä¸ªæŒ‡é’ˆ</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> <span class=\"token operator\">==</span> <span class=\"token function\">cast_check_pointertype</span><span class=\"token punctuation\">(</span>ctype<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    result <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>CDataObject <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">_PyObject_CallNoArg</span><span class=\"token punctuation\">(</span>ctype<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      The casted objects '_objects' member:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      It must certainly contain the source objects one.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      It must contain the source object itself.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>     */</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">CDataObject_Check</span><span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        CDataObject <span class=\"token operator\">*</span>obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>CDataObject <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>src<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        CDataObject <span class=\"token operator\">*</span>container<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token comment\">/* PyCData_GetContainer will initialize src.b_objects, we need</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>           this so it can be shared */</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        container <span class=\"token operator\">=</span> <span class=\"token function\">PyCData_GetContainer</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>container <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">goto</span> failed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token comment\">/* But we need a dictionary! */</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj<span class=\"token operator\">-></span>b_objects <span class=\"token operator\">==</span> Py_None<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token function\">Py_DECREF</span><span class=\"token punctuation\">(</span>Py_None<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            obj<span class=\"token operator\">-></span>b_objects <span class=\"token operator\">=</span> <span class=\"token function\">PyDict_New</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj<span class=\"token operator\">-></span>b_objects <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token keyword\">goto</span> failed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token function\">Py_XINCREF</span><span class=\"token punctuation\">(</span>obj<span class=\"token operator\">-></span>b_objects<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        result<span class=\"token operator\">-></span>b_objects <span class=\"token operator\">=</span> obj<span class=\"token operator\">-></span>b_objects<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token operator\">-></span>b_objects <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">PyDict_CheckExact</span><span class=\"token punctuation\">(</span>result<span class=\"token operator\">-></span>b_objects<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            PyObject <span class=\"token operator\">*</span>index<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token keyword\">int</span> rc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            index <span class=\"token operator\">=</span> <span class=\"token function\">PyLong_FromVoidPtr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>src<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token keyword\">goto</span> failed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            rc <span class=\"token operator\">=</span> <span class=\"token function\">PyDict_SetItem</span><span class=\"token punctuation\">(</span>result<span class=\"token operator\">-></span>b_objects<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">,</span> src<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token function\">Py_DECREF</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rc <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                <span class=\"token keyword\">goto</span> failed<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token comment\">/* Should we assert that result is a pointer type? */</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span>result<span class=\"token operator\">-></span>b_ptr<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ptr<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>PyObject <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    failed<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token function\">Py_DECREF</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è¿™é‡Œçš„ç¬¬ 50 è¡Œæœ‰ä¸€ä¸ª <code>memcpy</code> , ä½œç”¨æ˜¯å°† <code>ptr</code>  çš„åœ°å€èµ‹å€¼ç»™ <code>result-&gt;b_ptr</code> , <code>result-&gt;b_ptr</code>  æ˜¯ç»è¿‡ç±»å‹è½¬æ¢ä¹‹åæŒ‡å‘è½¬æ¢åå†…å­˜çš„æŒ‡é’ˆï¼Œè€Œè¿™ä¸ªå˜é‡ <code>ptr</code>  ä¸å°±æ˜¯ <code>cast</code>  ä¼ é€’è¿›æ¥çš„å‚æ•°ï¼ï¼Ÿ</p>\n<p><img data-src=\"/python-memory-leak/image-20240306161734881.png\" alt=\"image-20240306161734881\" style=\"aspect-ratio:729 / 151;\"></p>\n<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹ <code>cast</code>  å‡½æ•°åœ¨ python ä¸­çš„å£°æ˜ï¼Œè¿™é‡Œå®šä¹‰äº†ä¸€ä¸ª <code>cast</code> , è¿”å›çš„æ˜¯ <code>_cast</code> , è€Œä¸”æˆ‘ä»¬å±…ç„¶å‘ç°å‚æ•° <code>obj</code>  ç«Ÿç„¶åŒæ—¶æˆä¸ºäº† <code>c</code>  ä¸­ <code>cast</code>  çš„ç¬¬ä¸€ä¸ªå‚æ•° <code>void *ptr</code>  å’Œç¬¬äºŒä¸ªå‚æ•° <code>PyObject *src</code> , è€Œä¸”è¿™ç¬¬ä¸€ä¸ªå‚æ•°å’Œç¬¬äºŒä¸ªå‚æ•°çš„ç±»å‹è¿˜ä¸ä¸€æ ·ï¼Œåˆ†åˆ«æ˜¯ <code>c_void_p</code>  å’Œ <code>py_object</code></p>\n<p><img data-src=\"/python-memory-leak/image-20240306162125031.png\" alt=\"image-20240306162125031\" style=\"aspect-ratio:1183 / 106;\"></p>\n<p><code>obj</code>  æ˜æ˜æ˜¯æˆ‘ä»¬å‡†å¤‡è¦ç±»å‹è½¬æ¢çš„ç›®æ ‡æ•°æ®ï¼Œæ€ä¹ˆå®ƒå¹»åŒ–å‡ºäº†å¦å¤–ä¸€ä¸ªç±»å‹ <code>void *ptr</code>  æ¥ä½œä¸ºç»è¿‡ <code>cast</code>  å‡½æ•°ç±»å‹è½¬æ¢ä¹‹åçš„å†…å­˜æŒ‡é’ˆå‘¢ï¼Ÿ</p>\n<p>è¿™å°±ä¸å¾—ä¸è¯´ä¸€ä¸‹ python ä¸­è°ƒç”¨å¤–éƒ¨å‡½æ•°çš„ä¸€ä¸ªæœºåˆ¶äº†ï¼Œå³<strong>å¼ºåˆ¶ç±»å‹è½¬æ¢</strong></p>\n<blockquote>\n<p><strong>argtypes</strong></p>\n<p>å½“è°ƒç”¨å¤–éƒ¨å‡½æ•°æ—¶ï¼Œæ¯ä¸ªå®é™…å‚æ•°éƒ½ä¼šè¢«ä¼ ç»™ <a href=\"https://docs.python.org/zh-tw/3/library/ctypes.html#ctypes._FuncPtr.argtypes\"> <code>argtypes</code> </a> å…ƒç»„ä¸­æ¡ç›®çš„ <a href=\"https://docs.python.org/zh-tw/3/library/ctypes.html#ctypes._CData.from_param\"> <code>from_param()</code> </a> ç±»æ–¹æ³•ï¼Œ<strong>è¯¥æ–¹æ³•å…è®¸å°†å®é™…å‚æ•°é€‚é…ä¸ºæ­¤å¤–éƒ¨å‡½æ•°æ‰€æ¥å—çš„å¯¹è±¡</strong>ã€‚ ä¾‹å¦‚ï¼Œ<a href=\"https://docs.python.org/zh-tw/3/library/ctypes.html#ctypes._FuncPtr.argtypes\"> <code>argtypes</code> </a> å…ƒç»„ä¸­çš„ <a href=\"https://docs.python.org/zh-tw/3/library/ctypes.html#ctypes.c_char_p\"> <code>c_char_p</code> </a> æ¡ç›®å°†ä½¿ç”¨ ctypes è½¬æ¢è§„åˆ™æŠŠä½œä¸ºå‚æ•°ä¼ å…¥çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚ä¸²å¯¹è±¡ã€‚</p>\n</blockquote>\n<p>æ‰€ä»¥è¯´ <code>obj</code>  æœ¬èº«æ˜¯ <code>py_object</code> , ä½†æ˜¯ç”±äºè¿™ä¸ªæœºåˆ¶çš„å­˜åœ¨ï¼Œè¢«å¼ºåˆ¶è½¬æ¢ä¸ºäº† <code>c_void_p</code> , æˆ‘ä»¬ä¸å¦¨æ‰“å°å„ä¸ªå‚æ•°çš„åœ°å€æ¥å°è¯ä¸€ä¸‹</p>\n<p>è¿™é‡Œæˆ‘ä»¬é€šè¿‡ cast å°† <code>py_object</code>  å¼ºåˆ¶è½¬æ¢ä¸ºäº† <code>c_void_p</code> , å¯ä»¥å‘ç°ç¬¬ä¸€ä¸ªå‚æ•°çš„åœ°å€å’Œè¿”å›å€¼çš„åœ°å€æ˜¯<strong>ä¸€æ¨¡ä¸€æ ·</strong>çš„</p>\n<p><img data-src=\"/python-memory-leak/image-20240306163659369.png\" alt=\"image-20240306163659369\" style=\"aspect-ratio:1694 / 928;\"></p>\n<p>åœ¨è°ƒç”¨ cast å°†ç›®æ ‡æ•°æ®è½¬æ¢æˆç›®æ ‡ç±»å‹å‰ï¼Œpython åˆåˆ†é…äº†ä¸€å—æ–°çš„å†…å­˜æ¥å­˜å‚¨ç»è¿‡ cast è½¬æ¢ä¹‹åçš„ data, ç„¶è€Œåˆ†é…äº†å†…å­˜ä¹‹åå´æ²¡æœ‰å³æ—¶çš„é‡Šæ”¾è¿™å—å†…å­˜ï¼Œé€ æˆå†…å­˜æ³„æ¼ä¹Ÿä¸è¶³ä¸ºå¥‡äº†</p>\n<p>æ‰€ä»¥æˆ‘ä»¬ç°åœ¨è¦åšçš„å°±æ˜¯é‡Šæ”¾æ‰è¿™ä¸€å—å†…å­˜ï¼Œè€Œè¿™å¯ä»¥ä½¿ç”¨ <code>ctypes.memset</code>  å®ç°ï¼Œå°†è¿™å—å†…å­˜å…¨éƒ¨éƒ½ç½®ä¸º 0, ä¸å°±ç›¸å½“äºæŠŠè¿™å—å†…å­˜ free æ‰äº†å˜›</p>\n<p><img data-src=\"/python-memory-leak/image-20240306164150381.png\" alt=\"image-20240306164150381\" style=\"aspect-ratio:1114 / 330;\"></p>\n<p>å†èµ·ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œé€šè¿‡ä»»åŠ¡ç®¡ç†å™¨è§‚å¯Ÿ python è¿›ç¨‹çš„å†…å­˜å ç”¨ï¼Œç»ˆäºâ€¦ ä¸å†å†…å­˜æ³„æ¼äº†</p>\n<p><img data-src=\"/python-memory-leak/image-20240306164236590.png\" alt=\"image-20240306164236590\" style=\"aspect-ratio:920 / 31;\"></p>\n",
            "tags": []
        },
        {
            "id": "https://oacia.dev/360-jiagu/",
            "url": "https://oacia.dev/360-jiagu/",
            "title": "360åŠ å›ºdexè§£å¯†æµç¨‹åˆ†æ",
            "date_published": "2024-02-21T19:14:53.000Z",
            "content_html": "<h1 id=\"å‰è¨€\"><a class=\"anchor\" href=\"#å‰è¨€\">#</a> å‰è¨€</h1>\n<blockquote>\n<p>åœ¨å»å¹´ 9 æœˆçš„æ—¶å€™ï¼Œæˆ‘å°±æƒ³ç ”ç©¶ä¸€ä¸‹ apk çš„åŠ å›ºï¼Œåœ¨ç½‘ä¸Šé€›äº†ä¸€åœˆï¼Œæ„Ÿè§‰ 360 åŠ å›ºä¸é”™ï¼Œæ‰€ä»¥å…ˆé€‰å®ƒå•¦ï¼Œå†™äº†ä¸€ä¸ªæµ‹è¯• apk ä¸¢åˆ° 360 åŠ å›ºé‡Œé¢åŠ å›ºäº†ä¸€ä¸‹</p>\n<p>è¿™é‡Œæˆ‘ç”¨çš„æ˜¯ 360 åŠ å›ºçš„å…è´¹ç‰ˆ (å› ä¸ºä»˜è´¹ç‰ˆå¤ªè´µå•¦)</p>\n<p>æœ¬æ¥è®¡åˆ’ç€å»å¹´åˆ†æå®Œ 360 åŠ å›ºçš„ï¼Œä½†æ˜¯æ€»æ˜¯æŠ½ä¸å‡ºä¸€æ®µå®Œæ•´çš„æ—¶é—´æ¥æ‰€ä»¥å°±æ‹–åˆ°äº†ç°åœ¨ï¼Œç»ˆäºæœ€è¿‘å› ä¸ºè¿‡å¹´èµ‹é—²åœ¨å®¶ï¼Œå°±èŠ±äº†å‡ å¤©åˆ†æäº†ä¸€ä¸‹ 360 åŠ å›ºï¼Œæ„Ÿè§‰è¿™å‡ å¤©æ¢ç´¢ 360 åŠ å›ºçš„è¿‡ç¨‹çœŸæ˜¯å……æ»¡äº†æƒŠå–œå’Œä¹è¶£å‘¢ï½</p>\n</blockquote>\n<p>2024 å¹´ 3 æœˆ 8 å·è®°:</p>\n<blockquote>\n<p>è·ç¦»ä¸Šæ¬¡çœ‹ 360 åŠ å›ºå·²ç»åŠä¸ªæœˆå•¦ï¼Œä»Šå¤©æ­£æƒ³ç€è‡ªå·±è¦åšä»€ä¹ˆäº‹æƒ…çš„æ—¶å€™ï¼Œåˆ°åšå®¢çœ‹äº†çœ¼ TODOlist, çªç„¶å‘ç°å’¦æˆ‘æ˜¯ä¸æ˜¯è¿˜æ²¡çœ‹è¿‡ dex çš„è§£å¯†ç®—æ³•é•¿ä»€ä¹ˆæ ·ï¼Ÿæ‰€ä»¥ä»Šå¤©å°±æŠŠè¿™ä¸ªç»™åšå®Œäº†ï¼Œä¸å¾—ä¸è¯´é€†å‘çœŸçš„æ˜¯æ¶ˆç£¨æ— èŠæ—¶é—´æœ€æœ‰æ•ˆçš„æ–¹æ³•å“ˆå“ˆå“ˆ</p>\n</blockquote>\n<p>360 åŠ å›ºæµ‹è¯• apk: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9vYWNpYS5naXRodWIuaW8vMzYwLWppYWd1LzM2MGppYWd1LmFwaw==\">ä¸‹è½½åœ°å€</span></p>\n<p>æœªåŠ å›ºçš„åŸç‰ˆ apk: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9vYWNpYS5naXRodWIuaW8vMzYwLWppYWd1L29yaWdpbmFsLmFwaw==\">ä¸‹è½½åœ°å€</span></p>\n<h1 id=\"javaå±‚åˆæ­¥åˆ†æ\"><a class=\"anchor\" href=\"#javaå±‚åˆæ­¥åˆ†æ\">#</a> java å±‚åˆæ­¥åˆ†æ</h1>\n<p>åŒ…å: <code>com.oacia.apk_protect</code></p>\n<p>å…¥å£: <code>com.stub.StubApp</code></p>\n<p>æˆ‘ä»¬ä» <code>AndroidManifest.xml</code>  ä¸­å¯ä»¥å¾—çŸ¥ï¼Œ360 åŠ å›ºçš„å…¥å£æ˜¯ <code>com.stub.StubApp</code> , æ‰€ä»¥æˆ‘ä»¬å°±å…ˆè¿›åˆ° apk çš„å…¥å£è¿›è¡Œåˆ†æ</p>\n<p><img data-src=\"/360-jiagu/image-20230930183634640.png\" alt=\"image-20230930183634640\" style=\"aspect-ratio:804 / 196;\"></p>\n<p>åœ¨è¿™ä¸ªå…¥å£ç±»ä¸­ï¼Œä¸ä»…æœ‰å¸¸è§„çš„ <code>onCreate()</code>  å‡½æ•°ï¼Œè¿˜æœ‰ä¸€ä¸ªå‡½æ•°å€¼å¾—æ³¨æ„ï¼Œä»–å°±æ˜¯ <code>attachBaseContext(Context context)</code></p>\n<p><img data-src=\"/360-jiagu/image-20230930183713453.png\" alt=\"image-20230930183713453\" style=\"aspect-ratio:1557 / 449;\"></p>\n<blockquote>\n<p>Application çš„ <code>onCreate</code>  å’Œ <code>attachBaseContext</code>  æ˜¯ Application çš„ä¸¤ä¸ªå›è°ƒæ–¹æ³•ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåœ¨å…¶ä¸­åšä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œ <code>attachBaseContext</code>  åœ¨ <code>onCreate</code> <strong> ä¹‹å‰æ‰§è¡Œ</strong></p>\n</blockquote>\n<p>å…¶ä¸­å‡ºç°çš„å­—ç¬¦ä¸²ç»è¿‡äº†åŠ å¯†æ··æ·†æ“ä½œï¼ŒåŠ å¯†å‡½æ•°å¦‚ä¸‹ï¼Œç®—æ³•æ˜¯å°†æ‰€æœ‰çš„å­—ç¬¦ä¸ <code>16</code>  è¿›è¡Œå¼‚æˆ–</p>\n<p><img data-src=\"/360-jiagu/image-20230930183731411.png\" alt=\"image-20230930183731411\" style=\"aspect-ratio:604 / 274;\"></p>\n<p>æˆ‘ä»¬å†™ä¸ª jeb è„šæœ¬æŠŠåŠ å¯†å­—ç¬¦ä¸²è§£å¯†æ¥æ–¹ä¾¿åç»­çš„é™æ€åˆ†æ</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># coding=utf-8</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> com<span class=\"token punctuation\">.</span>pnfsoftware<span class=\"token punctuation\">.</span>jeb<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">.</span>api <span class=\"token keyword\">import</span> IScript<span class=\"token punctuation\">,</span> IconType<span class=\"token punctuation\">,</span> ButtonGroupType</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">from</span> com<span class=\"token punctuation\">.</span>pnfsoftware<span class=\"token punctuation\">.</span>jeb<span class=\"token punctuation\">.</span>core <span class=\"token keyword\">import</span> RuntimeProjectUtil</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> com<span class=\"token punctuation\">.</span>pnfsoftware<span class=\"token punctuation\">.</span>jeb<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>units<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">.</span>java <span class=\"token keyword\">import</span> IJavaSourceUnit</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">from</span> com<span class=\"token punctuation\">.</span>pnfsoftware<span class=\"token punctuation\">.</span>jeb<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>units<span class=\"token punctuation\">.</span>code <span class=\"token keyword\">import</span> ICodeUnit<span class=\"token punctuation\">,</span> ICodeItem</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">from</span> com<span class=\"token punctuation\">.</span>pnfsoftware<span class=\"token punctuation\">.</span>jeb<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">.</span>text <span class=\"token keyword\">import</span> ITextDocument</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">from</span> com<span class=\"token punctuation\">.</span>pnfsoftware<span class=\"token punctuation\">.</span>jeb<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>units<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">.</span>java <span class=\"token keyword\">import</span> IJavaSourceUnit<span class=\"token punctuation\">,</span> IJavaStaticField<span class=\"token punctuation\">,</span> IJavaNewArray<span class=\"token punctuation\">,</span> IJavaConstant<span class=\"token punctuation\">,</span> IJavaCall<span class=\"token punctuation\">,</span> IJavaField<span class=\"token punctuation\">,</span> IJavaMethod<span class=\"token punctuation\">,</span> IJavaClass</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">from</span> com<span class=\"token punctuation\">.</span>pnfsoftware<span class=\"token punctuation\">.</span>jeb<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>events <span class=\"token keyword\">import</span> JebEvent<span class=\"token punctuation\">,</span> J</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">from</span> com<span class=\"token punctuation\">.</span>pnfsoftware<span class=\"token punctuation\">.</span>jeb<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span>util <span class=\"token keyword\">import</span> DecompilerHelper</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># è§£å¯†å­—ç¬¦ä¸²å‡½æ•°çš„ç±»åä»¥åŠæ–¹æ³•å</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>methodName <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'Lcom/qihoo/util/a;'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">dec_str_360jiagu</span><span class=\"token punctuation\">(</span>IScript<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'start deal with strings'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        self<span class=\"token punctuation\">.</span>ctx <span class=\"token operator\">=</span> ctx</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        engctx <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>getEnginesContext<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> engctx<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Back-end engines not initialized'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        projects <span class=\"token operator\">=</span> engctx<span class=\"token punctuation\">.</span>getProjects<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> projects<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'There is no opened project'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        units <span class=\"token operator\">=</span> RuntimeProjectUtil<span class=\"token punctuation\">.</span>findUnitsByType<span class=\"token punctuation\">(</span>projects<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> IJavaSourceUnit<span class=\"token punctuation\">,</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token keyword\">for</span> unit <span class=\"token keyword\">in</span> units<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            javaClass <span class=\"token operator\">=</span> unit<span class=\"token punctuation\">.</span>getClassElement<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'[+] decrypt:'</span> <span class=\"token operator\">+</span> javaClass<span class=\"token punctuation\">.</span>getName<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            self<span class=\"token punctuation\">.</span>cstbuilder <span class=\"token operator\">=</span> unit<span class=\"token punctuation\">.</span>getFactories<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>getConstantFactory<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            self<span class=\"token punctuation\">.</span>processClass<span class=\"token punctuation\">(</span>javaClass<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            unit<span class=\"token punctuation\">.</span>notifyListeners<span class=\"token punctuation\">(</span>JebEvent<span class=\"token punctuation\">(</span>J<span class=\"token punctuation\">.</span>UnitChange<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Done.'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">processClass</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> javaClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token keyword\">if</span> javaClass<span class=\"token punctuation\">.</span>getName<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> methodName<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token keyword\">return</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token keyword\">for</span> method <span class=\"token keyword\">in</span> javaClass<span class=\"token punctuation\">.</span>getMethods<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            block <span class=\"token operator\">=</span> method<span class=\"token punctuation\">.</span>getBody<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            i <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            <span class=\"token keyword\">while</span> i <span class=\"token operator\">&lt;</span> block<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                stm <span class=\"token operator\">=</span> block<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                self<span class=\"token punctuation\">.</span>checkElement<span class=\"token punctuation\">(</span>block<span class=\"token punctuation\">,</span> stm<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                i <span class=\"token operator\">+=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">checkElement</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> parent<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span> IJavaCall<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                mmethod <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>getMethod<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                mname <span class=\"token operator\">=</span> mmethod<span class=\"token punctuation\">.</span>getName<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                msig <span class=\"token operator\">=</span> mmethod<span class=\"token punctuation\">.</span>getSignature<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token keyword\">if</span> mname <span class=\"token operator\">==</span> methodName<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">and</span> methodName<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">in</span> msig<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                    v <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                    <span class=\"token keyword\">for</span> arg <span class=\"token keyword\">in</span> e<span class=\"token punctuation\">.</span>getArguments<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                        <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">,</span> IJavaConstant<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                            v<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">.</span>getString<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                        decstr <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>decryptstring<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                        parent<span class=\"token punctuation\">.</span>replaceSubElement<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>cstbuilder<span class=\"token punctuation\">.</span>createString<span class=\"token punctuation\">(</span>decstr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            <span class=\"token keyword\">for</span> subelt <span class=\"token keyword\">in</span> e<span class=\"token punctuation\">.</span>getSubElements<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>subelt<span class=\"token punctuation\">,</span> IJavaClass<span class=\"token punctuation\">)</span> <span class=\"token keyword\">or</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>subelt<span class=\"token punctuation\">,</span> IJavaField<span class=\"token punctuation\">)</span> <span class=\"token keyword\">or</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>subelt<span class=\"token punctuation\">,</span> IJavaMethod<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                    <span class=\"token keyword\">continue</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                self<span class=\"token punctuation\">.</span>checkElement<span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span> subelt<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">decryptstring</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        src <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token keyword\">for</span> index<span class=\"token punctuation\">,</span> char <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            src<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token builtin\">chr</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">ord</span><span class=\"token punctuation\">(</span>char<span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token string\">''</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>src<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'unicode_escape'</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è§£å¯†åçš„æ•ˆæœå¦‚ä¸‹</p>\n<p><img data-src=\"/360-jiagu/image-20230930182440462.png\" alt=\"image-20230930182440462\" style=\"aspect-ratio:1575 / 816;\"></p>\n<p>æˆ‘ä»¬å¾€ä¸‹è¿›è¡Œåˆ†æï¼Œå¯ä»¥çŸ¥é“ <code>attachBaseContext</code>  çš„ç¬¬ä¸€ä¸ªä½œç”¨æ˜¯æ ¹æ®ç›®æ ‡æ‰‹æœºçš„æ¶æ„åŠ è½½ <code>libjiagu_xxx.so</code>  å¦‚å›¾</p>\n<p><img data-src=\"/360-jiagu/image-20230930184207278.png\" alt=\"image-20230930184207278\" style=\"aspect-ratio:1304 / 899;\"></p>\n<p>è¿™äº› so åœ¨ <code>assets</code>  ç›®å½•ä¸‹</p>\n<p><img data-src=\"/360-jiagu/image-20230930184336555.png\" alt=\"image-20230930184336555\" style=\"aspect-ratio:810 / 261;\"></p>\n<p>åœ¨åŠ è½½å®Œ <code>libjiagu_xxx.so</code>  ä¹‹åï¼Œè¿˜è°ƒç”¨äº† <code>DtcLoader</code>  ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™é‡Œä½¿ç”¨çš„ jadx çš„åç¼–è¯‘ç»“æœï¼Œå› ä¸º jeb æ²¡æœ‰åç¼–è¯‘å‡º <code>DtcLoader.init();</code>  æ–¹æ³•æ¥</p>\n<p><img data-src=\"/360-jiagu/image-20230930184605448.png\" alt=\"image-20230930184605448\" style=\"aspect-ratio:765 / 198;\"></p>\n<p><code>DtcLoader</code>  ç±»å¦‚å›¾æ‰€ç¤º</p>\n<p><img data-src=\"/360-jiagu/image-20230930184748578.png\" alt=\"image-20230930184748578\" style=\"aspect-ratio:1344 / 636;\"></p>\n<p>å½“ <code>DtcLoader</code>  ç±»è¢«åŠ è½½åˆ° JVM ä¸­æ—¶ï¼Œä¼šå»åŠ è½½ <code>libjgdtc.so</code> , å¦‚æœåŠ è½½å¤±è´¥ï¼Œåˆ™ä¼šå°è¯•ä» <code>/data/app/com.oacia.apk_protect/lib/arm64/libjgdtc.so</code>  æˆ–è€… <code>/data/data/com.oacia.apk_protect/lib/libjgdtc.so</code>  ä¸­å»åŠ è½½è¿™ä¸ª so</p>\n<p>ä½†æ˜¯å½“æˆ‘ä»¬å»è¿›å…¥åˆ°è¿™ä¸¤ä¸ªç›®å½•è¿›è¡Œå¯»æ‰¾æ—¶ï¼Œå´å‘ç°æ²¡æœ‰è¿™ä¸ª <code>libjgdtc.so</code>  å­˜åœ¨</p>\n<p><img data-src=\"/360-jiagu/image-20230930190258638.png\" alt=\"image-20230930190258638\" style=\"aspect-ratio:494 / 1023;\"></p>\n<p>æ‰€ä»¥æˆ‘ä»¬çš„åˆ†æé‡ç‚¹æ˜¯åœ¨ <code>libjiagu.so</code>  ä¸­ï¼Œè¿™é‡Œæˆ‘é€‰å–äº† arm64 æ¶æ„çš„ so æ–‡ä»¶ <code>libjiagu_a64.so</code>  è¿›è¡Œåˆ†æ</p>\n<h1 id=\"å£³elfå¯¼å…¥å¯¼å‡ºè¡¨ä¿®å¤\"><a class=\"anchor\" href=\"#å£³elfå¯¼å…¥å¯¼å‡ºè¡¨ä¿®å¤\">#</a> å£³ ELF å¯¼å…¥å¯¼å‡ºè¡¨ä¿®å¤</h1>\n<p>æˆ‘ä»¬ä½¿ç”¨ ida åˆ†æ <code>libjiagu_a64.so</code> , å‘ç°å¯¼å…¥è¡¨å’Œå¯¼å‡ºè¡¨éƒ½æ²¡æœ‰å†…å®¹ï¼Œæ—¢ç„¶æ˜¯è¿™ç§æƒ…å†µï¼Œé‚£ä¹ˆåº”è¯¥æ˜¯åœ¨ so è£…è½½è¿›å†…å­˜æ—¶å¯¼å…¥å¯¼å‡ºè¡¨æ‰ä¼šå»è¿›è¡Œç›¸åº”çš„é“¾æ¥æ“ä½œ</p>\n<p><img data-src=\"/360-jiagu/image-20231118145804113.png\" alt=\"image-20231118145804113\" style=\"aspect-ratio:1920 / 596;\"></p>\n<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆç”¨ frida æŠŠè¿™ä¸ª so ç»™ dump ä¸‹æ¥</p>\n<p>é¦–å…ˆæˆ‘ä»¬åœ¨æ‰‹æœºä¸Šè¿è¡Œä¸€ä¸‹ frida server</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS D:<span class=\"token punctuation\">\\</span>frida<span class=\"token operator\">></span> adb shell</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>blueline:/ $ <span class=\"token function\">su</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>blueline:/ <span class=\"token comment\"># cd /data/local/tmp</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>blueline:/data/local/tmp <span class=\"token comment\"># ./fs -l 0.0.0.0:1234</span></pre></td></tr></table></figure><p>éšååšä¸€ä¸‹ç«¯å£è½¬å‘</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>adb forward tcp:1234 tcp:1234</pre></td></tr></table></figure><p>frida å‘½ä»¤è¡Œè¯­å¥å¦‚ä¸‹</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>frida <span class=\"token parameter variable\">-H</span> <span class=\"token number\">127.0</span>.0.1:1234 <span class=\"token parameter variable\">-l</span> .<span class=\"token punctuation\">\\</span>hook.js <span class=\"token parameter variable\">-f</span> <span class=\"token string\">\"com.oacia.apk_protect\"</span></pre></td></tr></table></figure><p>æ³¨å…¥å¦‚ä¸‹è„šæœ¬</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">my_hook_dlopen</span><span class=\"token punctuation\">(</span>soName <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>Module<span class=\"token punctuation\">.</span><span class=\"token function\">findExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"android_dlopen_ext\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token keyword\">var</span> pathptr <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pathptr <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span> pathptr <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                    <span class=\"token keyword\">var</span> path <span class=\"token operator\">=</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>pathptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>soName<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>is_can_hook <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">retval</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>is_can_hook<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                    <span class=\"token function\">dump_so</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">dump_so</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">so_name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">var</span> libso <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">getModuleByName</span><span class=\"token punctuation\">(</span>so_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[name]:\"</span><span class=\"token punctuation\">,</span> libso<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[base]:\"</span><span class=\"token punctuation\">,</span> libso<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[size]:\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>libso<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[path]:\"</span><span class=\"token punctuation\">,</span> libso<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">var</span> file_path <span class=\"token operator\">=</span> <span class=\"token string\">\"/data/data/com.oacia.apk_protect/\"</span> <span class=\"token operator\">+</span> libso<span class=\"token punctuation\">.</span>name <span class=\"token operator\">+</span> <span class=\"token string\">\"_\"</span> <span class=\"token operator\">+</span> libso<span class=\"token punctuation\">.</span>base <span class=\"token operator\">+</span> <span class=\"token string\">\"_\"</span> <span class=\"token operator\">+</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>libso<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\".so\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">var</span> file_handle <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span>file_path<span class=\"token punctuation\">,</span> <span class=\"token string\">\"wb\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file_handle <span class=\"token operator\">&amp;&amp;</span> file_handle <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        Memory<span class=\"token punctuation\">.</span><span class=\"token function\">protect</span><span class=\"token punctuation\">(</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>libso<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> libso<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span> <span class=\"token string\">'rwx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">var</span> libso_buffer <span class=\"token operator\">=</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>libso<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readByteArray</span><span class=\"token punctuation\">(</span>libso<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        file_handle<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>libso_buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        file_handle<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        file_handle<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[dump]:\"</span><span class=\"token punctuation\">,</span> file_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span><span class=\"token function\">my_hook_dlopen</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"/360-jiagu/image-20231118150855726.png\" alt=\"image-20231118150855726\" style=\"aspect-ratio:998 / 155;\"></p>\n<p>éšåæˆ‘ä»¬ä½¿ç”¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0Y4TEVGVC9Tb0ZpeGVy\"> SoFixer</span> ä¿®å¤ä¸€ä¸‹è¿™ä¸ª so, è¿™é‡Œçš„ <code>-m</code>  å‚æ•°å³è¿™ä¸ª so åœ¨å†…å­˜ä¸­çš„ <code>base</code>  åŸºåœ°å€</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.<span class=\"token punctuation\">\\</span>SoFixer-Windows-64.exe <span class=\"token parameter variable\">-s</span> .<span class=\"token punctuation\">\\</span>libjiagu_64.so_0x74a2845000_0x274000.so <span class=\"token parameter variable\">-o</span> .<span class=\"token punctuation\">\\</span>libjiagu_64_0x74a2845000_0x274000_fix.so <span class=\"token parameter variable\">-m</span> 0x74a2845000 <span class=\"token parameter variable\">-d</span></pre></td></tr></table></figure><p>ä¿®å¤å®Œæˆåï¼Œå¯¼å…¥è¡¨å’Œå¯¼å‡ºè¡¨å°±æ¢å¤äº†</p>\n<p><img data-src=\"/360-jiagu/image-20231118151321228.png\" alt=\"image-20231118151321228\" style=\"aspect-ratio:1537 / 706;\"></p>\n<h1 id=\"åŠ å›ºå£³åè°ƒè¯•åˆæ­¥åˆ†æ\"><a class=\"anchor\" href=\"#åŠ å›ºå£³åè°ƒè¯•åˆæ­¥åˆ†æ\">#</a> åŠ å›ºå£³åè°ƒè¯•åˆæ­¥åˆ†æ</h1>\n<p>é¦–å…ˆæˆ‘ä»¬å» hook ä¸€ä¸‹æ‰“å¼€ so çš„å‡½æ•°</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_dlopen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>Module<span class=\"token punctuation\">.</span><span class=\"token function\">findExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"android_dlopen_ext\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token keyword\">var</span> pathptr <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pathptr <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span> pathptr <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                    <span class=\"token keyword\">var</span> path <span class=\"token operator\">=</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>pathptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"load \"</span> <span class=\"token operator\">+</span> path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span>hook_dlopen<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>æ—¥å¿—å¦‚ä¸‹ï¼Œæ‰€ä»¥åè°ƒè¯•æ˜¯åœ¨ <code>libjiagu_64.so</code>  ä¸­</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>load libstats_jni.so</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>load /data/app/~~P6meiEqXSQZrP2ChUgVgOg<span class=\"token operator\">==</span>/com.oacia.apk_protect-ezyVSLdtBZmLTZejgPlSoQ<span class=\"token operator\">==</span>/oat/arm64/base.odex</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>load /data/data/com.oacia.apk_protect/.jiagu/libjiagu_64.so</pre></td></tr></table></figure><p>ç„¶åå» hook æ‰“å¼€æ–‡ä»¶çš„å‡½æ•° <code>open</code></p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">my_hook_dlopen</span><span class=\"token punctuation\">(</span>soName <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>Module<span class=\"token punctuation\">.</span><span class=\"token function\">findExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"android_dlopen_ext\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token keyword\">var</span> pathptr <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pathptr <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span> pathptr <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                    <span class=\"token keyword\">var</span> path <span class=\"token operator\">=</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>pathptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>soName<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>is_can_hook <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">retval</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>is_can_hook<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                    <span class=\"token function\">hook_open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">var</span> pth <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">findExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"open\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>pth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>filename <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>filename<span class=\"token punctuation\">.</span><span class=\"token function\">readCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span><span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">retval</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span>my_hook_dlopen<span class=\"token punctuation\">,</span><span class=\"token string\">\"libjiagu\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>æ—¥å¿—å¦‚ä¸‹</p>\n<p><img data-src=\"/360-jiagu/image-20231119122024522.png\" alt=\"image-20231119122024522\" style=\"aspect-ratio:849 / 170;\"></p>\n<p>è¿™é‡Œæˆ‘ä»¬å‘ç°äº† <code>/proc/self/maps</code> , è¿™æ˜¯å¸¸è§çš„åè°ƒè¯•ï¼Œè¦ç»•è¿‡è¿™ä¸ªæ£€æµ‹ï¼Œæˆ‘ä»¬å¯ä»¥å¤‡ä»½ä¸€ä¸ªæ­£å¸¸çš„ <code>maps</code>  æ–‡ä»¶ï¼Œç„¶åç”¨ frida å» hook  <code>open</code>  å‡½æ•°ï¼Œå¦‚æœåŒ¹é…åˆ°å­—ç¬¦ä¸² <code>maps</code> , å°±å°†å­—ç¬¦ä¸²é‡å®šå‘åˆ°æˆ‘ä»¬å¤‡ä»½çš„ <code>maps</code>  æ–‡ä»¶</p>\n<p>é¦–å…ˆæˆ‘ä»¬æ­£å¸¸æ‰“å¼€ä¸€æ¬¡åŠ å£³çš„ apk, ç„¶åä½¿ç”¨ä¸‹åˆ—å‘½ä»¤å¤‡ä»½ maps</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cp</span> /proc/self/maps /data/data/com.oacia.apk_protect/maps</pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬æ³¨å…¥å¦‚ä¸‹ frida è„šæœ¬</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">my_hook_dlopen</span><span class=\"token punctuation\">(</span>soName <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>Module<span class=\"token punctuation\">.</span><span class=\"token function\">findExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"android_dlopen_ext\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                <span class=\"token keyword\">var</span> pathptr <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pathptr <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span> pathptr <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                    <span class=\"token keyword\">var</span> path <span class=\"token operator\">=</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>pathptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>soName<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>is_can_hook <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">retval</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>is_can_hook<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                    <span class=\"token function\">hook_proc_self_maps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_proc_self_maps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">const</span> openPtr <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">getExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'open'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">const</span> open <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NativeFunction</span><span class=\"token punctuation\">(</span>openPtr<span class=\"token punctuation\">,</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'pointer'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">var</span> fakePath <span class=\"token operator\">=</span> <span class=\"token string\">\"/data/data/com.oacia.apk_protect/maps\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>openPtr<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NativeCallback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">pathnameptr<span class=\"token punctuation\">,</span> flag</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">var</span> pathname <span class=\"token operator\">=</span> Memory<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8String</span><span class=\"token punctuation\">(</span>pathnameptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open\"</span><span class=\"token punctuation\">,</span>pathname<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pathname<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"maps\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"find\"</span><span class=\"token punctuation\">,</span>pathname<span class=\"token punctuation\">,</span><span class=\"token string\">\",redirect to\"</span><span class=\"token punctuation\">,</span>fakePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token keyword\">var</span> filename <span class=\"token operator\">=</span> Memory<span class=\"token punctuation\">.</span><span class=\"token function\">allocUtf8String</span><span class=\"token punctuation\">(</span>fakePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">var</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span>pathnameptr<span class=\"token punctuation\">,</span> flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token keyword\">return</span> fd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'pointer'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span>my_hook_dlopen<span class=\"token punctuation\">,</span><span class=\"token string\">\"libjiagu\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>ä½†æ˜¯å½“æ³¨å…¥è¿™æ®µè„šæœ¬åï¼Œè¿›ç¨‹ç”±äºéæ³•å†…å­˜è®¿é—®è€Œé€€å‡ºäº†ï¼Œè¿™è¯´æ˜ 360 åŠ å›ºä¸ä»…è¯»å– maps æ–‡ä»¶ï¼Œå¹¶ä¸”ä¼šå°è¯•è®¿é—® maps æ–‡ä»¶ä¸­æ‰€è®°å½•çš„æ–‡ä»¶æˆ–å†…å­˜æ˜ å°„ã€‚è¿™é‡Œç”±äº frida æ³¨å…¥åé‡å¯ apk, ä½†æ˜¯å¤‡ä»½çš„ maps æ–‡ä»¶ä¸­è®°å½•çš„æ˜¯å…ˆå‰çš„æ˜ å°„èµ·å§‹åœ°å€ (è¿™å—å†…å­˜åœ¨å…³é—­ apk åå°±è¢«æŠ¹å»äº†), æ‰€ä»¥å½“å£³å°è¯•è®¿é—®å…¶ä¸­çš„æ˜ å°„æ—¶äº§ç”Ÿäº†éæ³•å†…å­˜è®¿é—®ä»è€Œè®©è¿›ç¨‹å´©æºƒ</p>\n<p><img data-src=\"/360-jiagu/image-20240212225108205.png\" alt=\"image-20240212225108205\" style=\"aspect-ratio:1901 / 667;\"></p>\n<p>è¿™é‡Œæˆ‘çš„è§£å†³æ–¹å¼æ˜¯å°†ä¸Šè¿° frida ä»£ç ä¸­çš„ <code>fakePath</code>  èµ‹å€¼ä¸ºä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶ä¾‹å¦‚ <code>/data/data/com.oacia.apk_protect/maps_nonexistent</code> , æ¥è®©å£³æ²¡æœ‰å†…å®¹å¯ä»¥è®¿é—®</p>\n<p>ä¿®æ”¹å®Œ <code>fakePath</code>  åé‡æ–°æ³¨å…¥ä»£ç ï¼Œè¿™ä¸ªæ‰“å°å‡ºæ¥çš„æ—¥å¿—å¯ä»¥è¯´éå¸¸æœ‰æ„æ€ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼Œç›¸æ¯” hook  <code>open</code>  ä¹‹å‰çš„æ—¥å¿—ï¼Œæˆ‘ä»¬æˆåŠŸçš„è®© 360 åŠ å›ºçš„å£³é‡Šæ”¾å‡ºäº† dex</p>\n<p><img data-src=\"/360-jiagu/image-20240213225015953.png\" alt=\"image-20240213225015953\" style=\"aspect-ratio:1290 / 632;\"></p>\n<p>ç„¶è€Œè¿™ä¸ªå£³ä¼¼ä¹æ˜¯åˆå‘ç°äº†äº›ä»€ä¹ˆå¼‚å¸¸ï¼Œéšåèµ¶ç´§è®© app é€€å‡ºäº†ï¼Œä½†æ˜¯ç”±äºé€€å‡ºçš„å¤ªè¿‡ä»“ä¿ƒï¼Œå®ƒç”šè‡³è¿˜æ²¡æœ‰æ¥å¾—åŠæŠŠ dex ä»æ–‡ä»¶å¤¹ä¸­åˆ é™¤</p>\n<p><img data-src=\"/360-jiagu/image-20231117143717038.png\" alt=\"image-20231117143717038\" style=\"aspect-ratio:467 / 417;\"></p>\n<p>ç”¨ 010editor æ‰“å¼€ <code>classes.dex</code> , å‘ç°å‰å‡ ä½å¹¶ä¸æ˜¯ dex çš„é­”æœ¯å¤´ï¼Œè¯´æ˜è¿™ä¸ª dex è¿˜æ²¡æœ‰è¢«è§£å¯†ï¼Œä¸è¿‡ç°åœ¨æˆ‘ä»¬åªéœ€è¦åˆ†æ dex å¦‚ä½•è¢«å£³ä»å†…å­˜ä¸­é‡Šæ”¾å‡ºæ¥çš„è¿‡ç¨‹å°±å¯ä»¥äº†ï½</p>\n<p><img data-src=\"/360-jiagu/image-20231117143828767.png\" alt=\"image-20231117143828767\" style=\"aspect-ratio:788 / 577;\"></p>\n<p>å¦‚ä½•å¯ä»¥å®šä½åˆ°æ˜¯ä»€ä¹ˆä½ç½®è°ƒç”¨äº† <code>open</code>  å‡½æ•°æ¥æ‰“å¼€ <code>classes.dex</code>  å‘¢ï¼Ÿ</p>\n<p>å¾ˆç®€å•ï¼Œæ‰“å°ä¸€ä¸‹å †æ ˆå°±å¯ä»¥äº†</p>\n<p>å‡å¦‚æˆ‘ä»¬ä½¿ç”¨å¸¸è§„çš„ frida æ‰“å°å †æ ˆä»£ç ï¼Œå³ä½¿ç”¨ <code>DebugSymbol.fromAddress</code>  å‡½æ•°æ¥åˆ¤æ–­åœ°å€æ‰€åœ¨çš„ <code>so</code>  çš„ä½ç½®ï¼Œé‚£ä¹ˆè¿›ç¨‹æ˜¯ä¼šæŠ¥é”™é€€å‡ºçš„</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'RegisterNatives called from:\\\\n'</span> <span class=\"token operator\">+</span> Thread<span class=\"token punctuation\">.</span><span class=\"token function\">backtrace</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">,</span> Backtracer<span class=\"token punctuation\">.</span><span class=\"token constant\">FUZZY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>DebugSymbol<span class=\"token punctuation\">.</span>fromAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\\\n'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'\\\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™é‡Œ <code>DebugSymbol.fromAddress</code>  æ‰€å®ç°çš„é€»è¾‘éœ€è¦è‡ªå·±ç¼–å†™ï¼Œå³ä¸‹æ–¹çš„ <code>addr_in_so</code>  å‡½æ•°</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">addr_in_so</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">addr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> process_Obj_Module_Arr <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">enumerateModules</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> process_Obj_Module_Arr<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>addr<span class=\"token operator\">></span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>base <span class=\"token operator\">&amp;&amp;</span> addr<span class=\"token operator\">&lt;</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"is in\"</span><span class=\"token punctuation\">,</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span><span class=\"token string\">\"offset: 0x\"</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>addr<span class=\"token operator\">-</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_proc_self_maps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">const</span> openPtr <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">getExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'open'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">const</span> open <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NativeFunction</span><span class=\"token punctuation\">(</span>openPtr<span class=\"token punctuation\">,</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'pointer'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">var</span> fakePath <span class=\"token operator\">=</span> <span class=\"token string\">\"/data/data/com.oacia.apk_protect/maps_nonexistent\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>openPtr<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NativeCallback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">pathnameptr<span class=\"token punctuation\">,</span> flag</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">var</span> pathname <span class=\"token operator\">=</span> Memory<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8String</span><span class=\"token punctuation\">(</span>pathnameptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open\"</span><span class=\"token punctuation\">,</span>pathname<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//,Process.getCurrentThreadId()</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pathname<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"maps\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"find\"</span><span class=\"token punctuation\">,</span>pathname<span class=\"token operator\">+</span><span class=\"token string\">\", redirect to\"</span><span class=\"token punctuation\">,</span>fakePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token keyword\">var</span> filename <span class=\"token operator\">=</span> Memory<span class=\"token punctuation\">.</span><span class=\"token function\">allocUtf8String</span><span class=\"token punctuation\">(</span>fakePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pathname<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dex\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            Thread<span class=\"token punctuation\">.</span><span class=\"token function\">backtrace</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">,</span> Backtracer<span class=\"token punctuation\">.</span><span class=\"token constant\">FUZZY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>addr_in_so<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">var</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span>pathnameptr<span class=\"token punctuation\">,</span> flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">return</span> fd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'pointer'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">my_hook_dlopen</span><span class=\"token punctuation\">(</span>soName<span class=\"token operator\">=</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>Module<span class=\"token punctuation\">.</span><span class=\"token function\">findExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"android_dlopen_ext\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                <span class=\"token keyword\">var</span> pathptr <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pathptr <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span> pathptr <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    <span class=\"token keyword\">var</span> path <span class=\"token operator\">=</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>pathptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                    <span class=\"token comment\">//console.log(path);</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>soName<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>is_can_hook <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">retval</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>is_can_hook<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                    <span class=\"token function\">hook_proc_self_maps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span>my_hook_dlopen<span class=\"token punctuation\">,</span><span class=\"token string\">'libjiagu'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>äºæ˜¯æˆ‘ä»¬å¾—åˆ°äº†é‡Šæ”¾ä¸‰ä¸ª dex æ–‡ä»¶çš„å †æ ˆå›æº¯</p>\n<ul>\n<li><code>classes.dex</code> <br>\n<img data-src=\"/360-jiagu/image-20240213225949584.png\" alt=\"image-20240213225949584\" style=\"aspect-ratio:878 / 513;\"></li>\n<li><code>classes2.dex</code> <br>\n<img data-src=\"/360-jiagu/image-20240213230022534.png\" alt=\"image-20240213230022534\" style=\"aspect-ratio:896 / 518;\"></li>\n<li><code>classes3.dex</code> <br>\n<img data-src=\"/360-jiagu/image-20240213230048818.png\" alt=\"image-20240213230048818\" style=\"aspect-ratio:900 / 259;\"></li>\n</ul>\n<p>è¿™é‡Œæˆ‘ä»¬å‘ç° <code>classes.dex</code>  ä¸ <code>classes2.dex</code>  çš„å †æ ˆå›æº¯å®Œå…¨ç›¸åŒï¼Œå¹¶ä¸” <code>classes3.dex</code>  çš„å‰åŠéƒ¨åˆ†å’Œå‰ä¸¤ä¸ª dex çš„å †æ ˆä¸€æ ·ï¼Œéšåè¿›ç¨‹ä¾¿åˆé€€å‡ºäº†</p>\n<p>é€šè¿‡å¯¹å †æ ˆçš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸‰ä¸ª dex åº”è¯¥æ˜¯åœ¨ä¸€ä¸ªå¾ªç¯ä¸­è¢«ä¾æ¬¡åŠ è½½çš„</p>\n<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¾¿è·³è½¬åˆ°å †æ ˆæ‰€æ‰“å°çš„åç§»æ¥è¿›ä¸€æ­¥åˆ†æä¸‹</p>\n<p>ç„¶è€Œå½“æˆ‘ä»¬è·³è½¬åˆ°å †æ ˆå›æº¯ä¸­çš„ <code>libjiagu_64.so</code>  çš„åç§» <code>0x19b780</code>  æˆ–è€… <code>0x134598</code>  æ—¶ï¼Œå´å‘ç°è¿™äº›åœ°å€çš„å€¼éƒ½æ˜¯ 0</p>\n<p><img data-src=\"/360-jiagu/image-20240213232138840.png\" alt=\"image-20240213232138840\" style=\"aspect-ratio:721 / 104;\"></p>\n<p><img data-src=\"/360-jiagu/image-20240213232208410.png\" alt=\"image-20240213232208410\" style=\"aspect-ratio:751 / 102;\"></p>\n<p>æˆ‘ä»¬å¾ˆå¿«å°±èƒ½æƒ³åˆ°è¿™é‡Œç”¨åˆ°çš„æŠ€æœ¯åº”è¯¥æ˜¯å…ˆå°†ä¸€å—å†…å­˜æ ‡è®°ä¸ºå¯å†™å¯æ‰§è¡Œï¼Œéšåå°†å­—èŠ‚ç å¡«å……è¿›å»ï¼Œæ‰€ä»¥è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å£³æ‰“å¼€ dex æ—¶ï¼Œå°†æ­¤æ—¶çš„ <code>libjiagu_64.so</code>  ä»å†…å­˜ä¸­ dump ä¸‹æ¥å°±å¯ä»¥äº†</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">dump_so</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">so_name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> libso <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">getModuleByName</span><span class=\"token punctuation\">(</span>so_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[name]:\"</span><span class=\"token punctuation\">,</span> libso<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[base]:\"</span><span class=\"token punctuation\">,</span> libso<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[size]:\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>libso<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[path]:\"</span><span class=\"token punctuation\">,</span> libso<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">var</span> file_path <span class=\"token operator\">=</span> <span class=\"token string\">\"/data/data/com.oacia.apk_protect/\"</span> <span class=\"token operator\">+</span> libso<span class=\"token punctuation\">.</span>name <span class=\"token operator\">+</span> <span class=\"token string\">\"_\"</span> <span class=\"token operator\">+</span> libso<span class=\"token punctuation\">.</span>base <span class=\"token operator\">+</span> <span class=\"token string\">\"_\"</span> <span class=\"token operator\">+</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>libso<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\".so\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">var</span> file_handle <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span>file_path<span class=\"token punctuation\">,</span> <span class=\"token string\">\"wb\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file_handle <span class=\"token operator\">&amp;&amp;</span> file_handle <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        Memory<span class=\"token punctuation\">.</span><span class=\"token function\">protect</span><span class=\"token punctuation\">(</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>libso<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> libso<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span> <span class=\"token string\">'rwx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">var</span> libso_buffer <span class=\"token operator\">=</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>libso<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readByteArray</span><span class=\"token punctuation\">(</span>libso<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        file_handle<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>libso_buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        file_handle<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        file_handle<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[dump]:\"</span><span class=\"token punctuation\">,</span> file_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">var</span> dump_once <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// å› ä¸ºä¼šæ‰“å¼€ä¸‰æ¬¡ dex, æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä»… dump æ‰“å¼€ç¬¬ä¸€æ¬¡ dex æ—¶çš„ libjiagu_64.so</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_proc_self_maps</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">const</span> openPtr <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">getExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'open'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">const</span> open <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NativeFunction</span><span class=\"token punctuation\">(</span>openPtr<span class=\"token punctuation\">,</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'pointer'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">var</span> fakePath <span class=\"token operator\">=</span> <span class=\"token string\">\"/data/data/com.oacia.apk_protect/maps_nonexistent\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>openPtr<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NativeCallback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">pathnameptr<span class=\"token punctuation\">,</span> flag</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">var</span> pathname <span class=\"token operator\">=</span> Memory<span class=\"token punctuation\">.</span><span class=\"token function\">readUtf8String</span><span class=\"token punctuation\">(</span>pathnameptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open\"</span><span class=\"token punctuation\">,</span>pathname<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//,Process.getCurrentThreadId()</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pathname<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"maps\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"find\"</span><span class=\"token punctuation\">,</span>pathname<span class=\"token operator\">+</span><span class=\"token string\">\", redirect to\"</span><span class=\"token punctuation\">,</span>fakePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token keyword\">var</span> filename <span class=\"token operator\">=</span> Memory<span class=\"token punctuation\">.</span><span class=\"token function\">allocUtf8String</span><span class=\"token punctuation\">(</span>fakePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pathname<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dex\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>dump_once<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                dump_once <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                <span class=\"token function\">dump_so</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword\">var</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open</span><span class=\"token punctuation\">(</span>pathnameptr<span class=\"token punctuation\">,</span> flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token keyword\">return</span> fd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'pointer'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'int'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç„¶åå†å»ç”¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0Y4TEVGVC9Tb0ZpeGVy\"> SoFixer</span> ä¿®å¤è¿™ä¸ª dump ä¸‹æ¥çš„ so</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.<span class=\"token punctuation\">\\</span>SoFixer-Windows-64.exe <span class=\"token parameter variable\">-s</span> .<span class=\"token punctuation\">\\</span>libjiagu_64.so_0x7a69829000_0x274000_open_classes.dex.so <span class=\"token parameter variable\">-o</span> .<span class=\"token punctuation\">\\</span>libjiagu_64.so_0x7a69829000_0x274000_open_classes.dex_fix.so <span class=\"token parameter variable\">-m</span> 0x7a69829000 <span class=\"token parameter variable\">-d</span></pre></td></tr></table></figure><p>å†æ¬¡æ¥åˆ°åç§» <code>0x19B780</code>  å¤„ï¼Œå¯ä»¥å‘ç°è¿™å—ç©ºå†…å­˜å·²ç»è¢«å¡«å……äº†æ•°æ®</p>\n<p><img data-src=\"/360-jiagu/image-20240213233913165.png\" alt=\"image-20240213233913165\" style=\"aspect-ratio:971 / 383;\"></p>\n<p>æ¥ä¸‹æ¥æˆ‘ä»¬æƒ³çŸ¥é“çš„æ˜¯ç©¶ç«Ÿæ˜¯ä»ä»€ä¹ˆåœ°æ–¹å¼€å§‹è¢«å¡«å……äº†æ–°çš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨ WinMerge æ¥è®©å¡«å……å’Œæœªå¡«å……æ•°æ®çš„ so è¿›è¡Œæ¯”è¾ƒçœ‹çœ‹ï¼Œç»“æœå´æœ‰äº†æƒŠäººçš„å‘ç°ï¼Œè¢«å¡«å……çš„æ•°æ®æ˜¯ä» <code>0xe7000</code>  å¼€å§‹çš„ï¼Œå®ƒçš„å¼€å¤´ç«Ÿç„¶æ˜¯ ELF æ–‡ä»¶çš„é­”æ•°å¤´ï¼ï¼Ÿè¿™æœ‰æ„æ€äº†ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€ä¸ª so é‡Œé¢è—äº†å¦å¤–ä¸€ä¸ª so å’¯ï½</p>\n<p><img data-src=\"/360-jiagu/image-20240213234737987.png\" alt=\"image-20240213234737987\" style=\"aspect-ratio:1920 / 1080;\"></p>\n<p>æˆ‘ä»¬å†™ä¸ª python è„šæœ¬ï¼ŒæŠŠè¿™ä¸ª ELF ä» <code>0x0e7000</code>  å¼€å§‹åé¢çš„æ‰€æœ‰å­—èŠ‚éƒ½å¤åˆ¶åˆ°æ–°çš„æ–‡ä»¶é‡Œé¢</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'libjiagu_64.so_0x7a69829000_0x274000_open_classes.dex.so'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    s<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'libjiagu_0xe7000.so'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">[</span><span class=\"token number\">0xe7000</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>ä½†æ˜¯å½“æŠŠè¿™ä¸ª elf æå–å‡ºæ¥ä¹‹åæ‹¿ <code>010editor</code>  çœ‹å´å‘ç° <code>program header table</code>  è¢«åŠ å¯†äº†</p>\n<p><img data-src=\"/360-jiagu/image-20240220220722659.png\" alt=\"image-20240220220722659\" style=\"aspect-ratio:800 / 434;\"></p>\n<p>è¿™å°±å¯¼è‡´ ida æ ¹æœ¬å°±æ— æ³•è¿›è¡Œæ­£å¸¸çš„åˆ†æ</p>\n<p><img data-src=\"/360-jiagu/image-20240217212952888.png\" alt=\"image-20240217212952888\" style=\"aspect-ratio:472 / 149;\"></p>\n<p><img data-src=\"/360-jiagu/image-20240217213007622.png\" alt=\"image-20240217213007622\" style=\"aspect-ratio:862 / 371;\"></p>\n<h1 id=\"ä¸»elfè§£å¯†æµç¨‹åˆ†æ\"><a class=\"anchor\" href=\"#ä¸»elfè§£å¯†æµç¨‹åˆ†æ\">#</a> ä¸» ELF è§£å¯†æµç¨‹åˆ†æ</h1>\n<p>å£³ elf åŠ è½½ä¸» elf, å¹¶ä¸” program header è¿˜è¢«åŠ å¯†äº†ï¼Œæ„Ÿè§‰è¿™ç§å½¢å¼å¾ˆåƒæ˜¯ <strong>è‡ªå®ç° linker åŠ å›º so</strong></p>\n<p>å¯¹äºè¿™ç§åŠ å›ºæ–¹å¼ï¼Œå£³ elf åœ¨ä»£ç ä¸­è‡ªå·±å®ç°äº†è§£æ ELF æ–‡ä»¶çš„å‡½æ•°ï¼Œå¹¶å°†è§£æç»“æœèµ‹å€¼åˆ° <code>soinfo</code>  ç»“æ„ä½“ä¸­ï¼Œéšåè°ƒç”¨ <code>dlopen</code>  è¿›è¡Œæ‰‹åŠ¨åŠ è½½</p>\n<p>æ¥åˆ° ida é‡Œé¢åœ¨å¯¼å…¥è¡¨å¯¹ <code>dlopen</code>  è¿›è¡Œäº¤å‰å¼•ç”¨ï¼Œæˆ‘ä»¬çœ‹åˆ° dlopen æœ‰ 5 ä¸ªäº¤å‰å¼•ç”¨</p>\n<p><img data-src=\"/360-jiagu/image-20240218174655222.png\" alt=\"image-20240218174655222\" style=\"aspect-ratio:925 / 277;\"></p>\n<p>çœ‹åˆ°ç¬¬äºŒä¸ªäº¤å‰å¼•ç”¨ï¼Œæ¥åˆ° <code>sub_3C94</code>  å‡½æ•°ï¼Œè¿™ä¸ª for å¾ªç¯çœ‹èµ·æ¥åƒæ˜¯åœ¨ç”¨ç¬¦å·è¡¨é€šè¿‡ dlopen åŠ è½½ä¾èµ–é¡¹</p>\n<p><img data-src=\"/360-jiagu/image-20240218174801778.png\" alt=\"image-20240218174801778\" style=\"aspect-ratio:759 / 469;\"></p>\n<p>å‘ä¸Šé¢ç¿»ç¿»ä»£ç ï¼Œçœ‹åˆ°è¿™ä¸ª switch å°±çŸ¥é“æ‰¾å¯¹åœ°æ–¹äº†ï¼Œè¿™é‡Œåº”è¯¥å°±æ˜¯è‡ªå®ç° linker æ¥åŠ è½½ so çš„</p>\n<p><img data-src=\"/360-jiagu/image-20240218175140788.png\" alt=\"image-20240218175140788\" style=\"aspect-ratio:591 / 784;\"></p>\n<p>å› ä¸ºè¿™å’Œ AOSP æºç  ( <code>android-platform\\bionic\\linker\\linker.cpp</code> ) ä¸­çš„é¢„é“¾æ¥ ( <code>soinfo::prelink_image</code> ) è¿™éƒ¨åˆ†çš„æ“ä½œæä¸ºçš„ç›¸ä¼¼</p>\n<p><img data-src=\"/360-jiagu/image-20240218175438786.png\" alt=\"image-20240218175438786\" style=\"aspect-ratio:1097 / 757;\"></p>\n<p>é‚£æ¥ä¸‹æ¥å°±åœ¨ ida ä¸­å¯¼å…¥ soinfo ç›¸å…³çš„ç¬¦å·å°±å¯ä»¥å•¦</p>\n<p>åœ¨ ida ä¸­ä¾æ¬¡ç‚¹å‡» <code>View-&gt;Open subviews-&gt;Local Types</code> , ç„¶åæŒ‰ä¸‹é”®ç›˜ä¸Šçš„ <code>Insert</code>  å°†ä¸‹é¢çš„ç»“æ„ä½“æ·»åŠ åˆ°å¯¹è¯æ¡†ä¸­</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//IMPORTANT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//ELF64 å¯ç”¨è¯¥å®</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__LP64__</span>  <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//ELF32 å¯ç”¨è¯¥å®</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">//#define __work_around_b_24465209__  1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>//https://android.googlesource.com/platform/bionic/+/master/linker/Android.bp</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>æ¶æ„ä¸º 32 ä½ å®šä¹‰__work_around_b_24465209__å®</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>arch: &#123;</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        arm: &#123;cflags: [\"-D__work_around_b_24465209__\"],&#125;,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        x86: &#123;cflags: [\"-D__work_around_b_24465209__\"],&#125;,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>*/</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\libc\\include\\link.h</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__LP64__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">ElfW</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span> Elf64_ </span><span class=\"token punctuation\">##</span> <span class=\"token expression\">type</span></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">ElfW</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span> Elf32_ </span><span class=\"token punctuation\">##</span> <span class=\"token expression\">type</span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_common_types.h</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// Android uses RELA for LP64.</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__LP64__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">USE_RELA</span> <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\libc\\kernel\\uapi\\asm-generic\\int-ll64.h</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">//__signed__-->signed</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">signed</span> <span class=\"token keyword\">char</span> __s8<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> __u8<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">signed</span> <span class=\"token keyword\">short</span> __s16<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> __u16<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">signed</span> <span class=\"token keyword\">int</span> __s32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> __u32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">signed</span> <span class=\"token keyword\">long</span> <span class=\"token keyword\">long</span> __s64<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> <span class=\"token keyword\">long</span> __u64<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\">//A12-src\\msm-google\\include\\uapi\\linux\\elf.h</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">/* 32-bit ELF base types. */</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token keyword\">typedef</span> __u32\tElf32_Addr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token keyword\">typedef</span> __u16\tElf32_Half<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token keyword\">typedef</span> __u32\tElf32_Off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">typedef</span> __s32\tElf32_Sword<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token keyword\">typedef</span> __u32\tElf32_Word<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\">/* 64-bit ELF base types. */</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token keyword\">typedef</span> __u64\tElf64_Addr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token keyword\">typedef</span> __u16\tElf64_Half<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token keyword\">typedef</span> __s16\tElf64_SHalf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token keyword\">typedef</span> __u64\tElf64_Off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token keyword\">typedef</span> __s32\tElf64_Sword<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token keyword\">typedef</span> __u32\tElf64_Word<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">typedef</span> __u64\tElf64_Xword<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token keyword\">typedef</span> __s64\tElf64_Sxword<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">dynamic</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  Elf32_Sword d_tag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token keyword\">union</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    Elf32_Sword\td_val<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    Elf32_Addr\td_ptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> d_un<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Dyn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  Elf64_Sxword d_tag<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* entry tag value */</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    Elf64_Xword d_val<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    Elf64_Addr d_ptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> d_un<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf64_Dyn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf32_rel</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  Elf32_Addr\tr_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  Elf32_Word\tr_info<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Rel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf64_rel</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  Elf64_Addr r_offset<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Location at which to apply the action */</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  Elf64_Xword r_info<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* index and type of relocation */</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf64_Rel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf32_rela</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  Elf32_Addr\tr_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  Elf32_Word\tr_info<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  Elf32_Sword\tr_addend<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Rela<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf64_rela</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  Elf64_Addr r_offset<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Location at which to apply the action */</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  Elf64_Xword r_info<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* index and type of relocation */</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  Elf64_Sxword r_addend<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Constant addend used to compute value */</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf64_Rela<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf32_sym</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  Elf32_Word\tst_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  Elf32_Addr\tst_value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  Elf32_Word\tst_size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span>\tst_info<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span>\tst_other<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  Elf32_Half\tst_shndx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Sym<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf64_sym</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  Elf64_Word st_name<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Symbol name, index in string tbl */</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span>\tst_info<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Type and binding attributes */</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span>\tst_other<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* No defined meaning, 0 */</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  Elf64_Half st_shndx<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Associated section index */</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  Elf64_Addr st_value<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Value of the symbol */</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  Elf64_Xword st_size<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Associated symbol size */</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf64_Sym<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">EI_NIDENT</span>\t<span class=\"token expression\"><span class=\"token number\">16</span></span></span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre></pre></td></tr><tr><td data-num=\"117\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf32_hdr</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span>\te_ident<span class=\"token punctuation\">[</span>EI_NIDENT<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  Elf32_Half\te_type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  Elf32_Half\te_machine<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  Elf32_Word\te_version<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>  Elf32_Addr\te_entry<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* Entry point */</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  Elf32_Off\te_phoff<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>  Elf32_Off\te_shoff<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  Elf32_Word\te_flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  Elf32_Half\te_ehsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  Elf32_Half\te_phentsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>  Elf32_Half\te_phnum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  Elf32_Half\te_shentsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>  Elf32_Half\te_shnum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>  Elf32_Half\te_shstrndx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Ehdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre></pre></td></tr><tr><td data-num=\"134\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf64_hdr</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span>\te_ident<span class=\"token punctuation\">[</span>EI_NIDENT<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* ELF \"magic number\" */</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>  Elf64_Half e_type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>  Elf64_Half e_machine<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>  Elf64_Word e_version<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>  Elf64_Addr e_entry<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Entry point virtual address */</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>  Elf64_Off e_phoff<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Program header table file offset */</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>  Elf64_Off e_shoff<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section header table file offset */</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>  Elf64_Word e_flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>  Elf64_Half e_ehsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>  Elf64_Half e_phentsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>  Elf64_Half e_phnum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>  Elf64_Half e_shentsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>  Elf64_Half e_shnum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>  Elf64_Half e_shstrndx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf64_Ehdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre></pre></td></tr><tr><td data-num=\"151\"></td><td><pre><span class=\"token comment\">/* These constants define the permissions on sections in the program</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>   header, p_flags. */</pre></td></tr><tr><td data-num=\"153\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PF_R</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x4</span></span></span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PF_W</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x2</span></span></span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PF_X</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x1</span></span></span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre></pre></td></tr><tr><td data-num=\"157\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf32_phdr</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>  Elf32_Word\tp_type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>  Elf32_Off\tp_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>  Elf32_Addr\tp_vaddr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>  Elf32_Addr\tp_paddr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>  Elf32_Word\tp_filesz<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>  Elf32_Word\tp_memsz<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>  Elf32_Word\tp_flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>  Elf32_Word\tp_align<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Phdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre></pre></td></tr><tr><td data-num=\"168\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf64_phdr</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>  Elf64_Word p_type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>  Elf64_Word p_flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>  Elf64_Off p_offset<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment file offset */</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>  Elf64_Addr p_vaddr<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment virtual address */</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>  Elf64_Addr p_paddr<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment physical address */</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>  Elf64_Xword p_filesz<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment size in file */</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>  Elf64_Xword p_memsz<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment size in memory */</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>  Elf64_Xword p_align<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment alignment, file &amp; memory */</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf64_Phdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre></pre></td></tr><tr><td data-num=\"179\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf32_shdr</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>  Elf32_Word\tsh_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>  Elf32_Word\tsh_type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>  Elf32_Word\tsh_flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>  Elf32_Addr\tsh_addr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>  Elf32_Off\tsh_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>  Elf32_Word\tsh_size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>  Elf32_Word\tsh_link<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>  Elf32_Word\tsh_info<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>  Elf32_Word\tsh_addralign<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>  Elf32_Word\tsh_entsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Shdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre></pre></td></tr><tr><td data-num=\"192\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf64_shdr</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>  Elf64_Word sh_name<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section name, index in string tbl */</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>  Elf64_Word sh_type<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Type of section */</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>  Elf64_Xword sh_flags<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Miscellaneous section attributes */</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>  Elf64_Addr sh_addr<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section virtual addr at execution */</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>  Elf64_Off sh_offset<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section file offset */</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>  Elf64_Xword sh_size<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Size of section in bytes */</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>  Elf64_Word sh_link<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Index of another section */</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>  Elf64_Word sh_info<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Additional section information */</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>  Elf64_Xword sh_addralign<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Section alignment */</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>  Elf64_Xword sh_entsize<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Entry size if section holds table */</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf64_Shdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre></pre></td></tr><tr><td data-num=\"205\"></td><td><pre></pre></td></tr><tr><td data-num=\"206\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_soinfo.h</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token class-name\">linker_dtor_function_t</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token class-name\">linker_ctor_function_t</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre></pre></td></tr><tr><td data-num=\"210\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__work_around_b_24465209__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SOINFO_NAME_LEN</span> <span class=\"token expression\"><span class=\"token number\">128</span></span></span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre></pre></td></tr><tr><td data-num=\"214\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">soinfo</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__work_around_b_24465209__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>  <span class=\"token keyword\">char</span> old_name_<span class=\"token punctuation\">[</span>SOINFO_NAME_LEN<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Phdr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> phdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>  <span class=\"token class-name\">size_t</span> phnum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__work_around_b_24465209__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> unused0<span class=\"token punctuation\">;</span> <span class=\"token comment\">// DO NOT USE, maintained for compatibility.</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> base<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>  <span class=\"token class-name\">size_t</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre></pre></td></tr><tr><td data-num=\"226\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__work_around_b_24465209__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>  <span class=\"token class-name\">uint32_t</span> unused1<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// DO NOT USE, maintained for compatibility.</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Dyn<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> dynamic<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre></pre></td></tr><tr><td data-num=\"232\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__work_around_b_24465209__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>  <span class=\"token class-name\">uint32_t</span> unused2<span class=\"token punctuation\">;</span> <span class=\"token comment\">// DO NOT USE, maintained for compatibility</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>  <span class=\"token class-name\">uint32_t</span> unused3<span class=\"token punctuation\">;</span> <span class=\"token comment\">// DO NOT USE, maintained for compatibility</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>  soinfo<span class=\"token operator\">*</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>  <span class=\"token class-name\">uint32_t</span> flags_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> strtab_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Sym<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> symtab_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>  <span class=\"token class-name\">size_t</span> nbucket_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>  <span class=\"token class-name\">size_t</span> nchain_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>  <span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span> bucket_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>  <span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span> chain_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre></pre></td></tr><tr><td data-num=\"248\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token operator\">!</span><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__LP64__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> unused4<span class=\"token punctuation\">;</span> <span class=\"token comment\">// DO NOT USE, maintained for compatibility</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre></pre></td></tr><tr><td data-num=\"252\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>USE_RELA<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rela<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> plt_rela_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>  <span class=\"token class-name\">size_t</span> plt_rela_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rela<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> rela_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>  <span class=\"token class-name\">size_t</span> rela_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rel<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> plt_rel_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>  <span class=\"token class-name\">size_t</span> plt_rel_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rel<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> rel_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>  <span class=\"token class-name\">size_t</span> rel_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>  <span class=\"token class-name\">linker_ctor_function_t</span><span class=\"token operator\">*</span> preinit_array_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>  <span class=\"token class-name\">size_t</span> preinit_array_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>  <span class=\"token class-name\">linker_ctor_function_t</span><span class=\"token operator\">*</span> init_array_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>  <span class=\"token class-name\">size_t</span> init_array_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre>  <span class=\"token class-name\">linker_dtor_function_t</span><span class=\"token operator\">*</span> fini_array_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>  <span class=\"token class-name\">size_t</span> fini_array_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre></pre></td></tr><tr><td data-num=\"274\"></td><td><pre>  <span class=\"token class-name\">linker_ctor_function_t</span> init_func_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>  <span class=\"token class-name\">linker_dtor_function_t</span> fini_func_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre></pre></td></tr><tr><td data-num=\"277\"></td><td><pre><span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>#if defined (__arm__)</pre></td></tr><tr><td data-num=\"279\"></td><td><pre>  // ARM EABI section used for stack unwinding.</pre></td></tr><tr><td data-num=\"280\"></td><td><pre>  uint32_t* ARM_exidx;</pre></td></tr><tr><td data-num=\"281\"></td><td><pre>  size_t ARM_exidx_count;</pre></td></tr><tr><td data-num=\"282\"></td><td><pre>#endif</pre></td></tr><tr><td data-num=\"283\"></td><td><pre>  size_t ref_count_;</pre></td></tr><tr><td data-num=\"284\"></td><td><pre>// æ€ä¹ˆæ‰¾ä¸ link_map è¿™ä¸ªç±»å‹çš„å£°æ˜...</pre></td></tr><tr><td data-num=\"285\"></td><td><pre>  link_map link_map_head;</pre></td></tr><tr><td data-num=\"286\"></td><td><pre></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>  bool constructors_called;</pre></td></tr><tr><td data-num=\"288\"></td><td><pre></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>  // When you read a virtual address from the ELF file, add this</pre></td></tr><tr><td data-num=\"290\"></td><td><pre>  //value to get the corresponding address in the process' address space.</pre></td></tr><tr><td data-num=\"291\"></td><td><pre>  ElfW (Addr) load_bias;</pre></td></tr><tr><td data-num=\"292\"></td><td><pre></pre></td></tr><tr><td data-num=\"293\"></td><td><pre>#if !defined (__LP64__)</pre></td></tr><tr><td data-num=\"294\"></td><td><pre>  bool has_text_relocations;</pre></td></tr><tr><td data-num=\"295\"></td><td><pre>#endif</pre></td></tr><tr><td data-num=\"296\"></td><td><pre>  bool has_DT_SYMBOLIC;</pre></td></tr><tr><td data-num=\"297\"></td><td><pre>*/</pre></td></tr><tr><td data-num=\"298\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>å¯¼å…¥å®ŒæˆåæŒ‰ä¸‹ <code>Y</code>  é”®ï¼Œå°† <code>a1</code>  å®šä¹‰ä¸º <code>soinfo*</code></p>\n<p><img data-src=\"/360-jiagu/image-20240218175803731.png\" alt=\"image-20240218175803731\" style=\"aspect-ratio:676 / 184;\"></p>\n<p>ç„¶åå°±å¯ä»¥çœ‹åˆ°è¿™äº›ç¬¦å·äº†ï¼Œä½†æ˜¯çœ‹è¿™äº›ç¬¦å·æ€»æ„Ÿè§‰æœ‰äº›ä¸å¤ªå¯¹åŠ²ï¼Œè¿™é‡Œä¸åº”è¯¥å‡ºç° <code>a1[1]</code>  æˆ–è€… <code>a1[2]</code> , æ‰€ä»¥æˆ‘çŒœæµ‹è¿™ä¸ª soinfo æœ‰è¢«é­”æ”¹çš„ç—•è¿¹</p>\n<p><img data-src=\"/360-jiagu/image-20240219144353027.png\" alt=\"image-20240219144353027\" style=\"aspect-ratio:750 / 808;\"></p>\n<p>è™½ç„¶è¿™ä¸ª soinfo å¯èƒ½æœ‰è¢«é­”æ”¹äº†ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä» <code>sub_3C94</code>  è¿™ä¸ªé¢„é“¾æ¥ç›¸å…³å‡½æ•°å…¥æ‰‹å¥½äº†ï¼Œäº¤å‰å¼•ç”¨å‘ç° <code>sub_3C94</code>  æ˜¯è¢« <code>sub_49F0</code>  è°ƒç”¨</p>\n<p>éšåæˆ‘ä»¬æ¥åˆ° <code>sub_49F0</code>  å†…è°ƒç”¨ <code>sub_3C94</code>  å‡½æ•°çš„ä½ç½®ï¼Œå‘ä¸‹çœ‹ï¼Œè¿›å…¥ <code>sub_4918</code>  å‡½æ•°ä¸­</p>\n<p><img data-src=\"/360-jiagu/image-20240219181823744.png\" alt=\"image-20240219181823744\" style=\"aspect-ratio:782 / 307;\"></p>\n<p><code>sub_4918</code>  ä¸­è°ƒç”¨äº† <code>sub_5E6C</code> , æˆ‘ä»¬è¿›å…¥ <code>sub_5E6C</code></p>\n<p><img data-src=\"/360-jiagu/image-20240219181928308.png\" alt=\"image-20240219181928308\" style=\"aspect-ratio:1023 / 727;\"></p>\n<p>è¿™ä¸ªå‡½æ•°ä¸­å‡ºç°äº† <code>0x38</code>  è¿™ä¸ªæ•°å­—ï¼Œ <code>0x38</code>  æ˜¯è¿™ä¸ªå¾ªç¯çš„æ­¥é•¿</p>\n<p><img data-src=\"/360-jiagu/image-20240219184405967.png\" alt=\"image-20240219184405967\" style=\"aspect-ratio:1118 / 714;\"></p>\n<p>0x38 è¿™ä¸ªæ•°å­—æœ‰ä»€ä¹ˆç‰¹æ®Šçš„å«ä¹‰å—ï¼Ÿå½“ç„¶æœ‰äº†ï¼ï¼</p>\n<p>æˆ‘ä»¬æŠŠåˆšåˆšæå–å‡ºæ¥çš„ elf ç”¨ <code>010editor</code>  æ‰“å¼€ï¼Œçœ‹åˆ° <code>elf_header</code>  çš„ <code>phentsize</code>  è¿™ä¸ªå­—æ®µï¼Œè¿™ä¸ªå­—æ®µçš„å«ä¹‰æ˜¯ä¸€ä¸ª <code>Program header table</code>  çš„é•¿åº¦ï¼Œå®ƒæ­£æ­£å¥½å¥½ä¹Ÿæ˜¯ <code>0x38</code></p>\n<p><img data-src=\"/360-jiagu/image-20240219184824589.png\" alt=\"image-20240219184824589\" style=\"aspect-ratio:1907 / 798;\"></p>\n<p>æ‰€ä»¥è¯´åœ¨ <code>sub_5E6C</code>  ä¸­å˜é‡ <code>v5</code>  çš„ç±»å‹åº”è¯¥æ˜¯ <code>Elf64_Phdr *</code> , æˆ‘ä»¬ç›´æ¥é‡å®šä¹‰ç±»å‹</p>\n<p><img data-src=\"/360-jiagu/image-20240219185005955.png\" alt=\"image-20240219185005955\" style=\"aspect-ratio:1323 / 307;\"></p>\n<p>æ—¢ç„¶çŸ¥é“äº†çœŸæ­£çš„ <code>program header table</code>  å°±æ˜¯åœ¨è¿™ä¸ªä½ç½®çš„ï¼Œé‚£æˆ‘ä»¬ç›´æ¥åœ¨è¿™ä¸ªåœ°æ–¹æŠŠ <code>program header table</code>  æ•´ä¸ªç»™ dump ä¸‹æ¥ä¸å°±è¡Œäº†</p>\n<p>æ‰€ä»¥æˆ‘ä»¬ç›´æ¥å» hook <code>sub_5E6C</code>  çš„ä¸‰ä¸ªä¼ å…¥çš„å€¼</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_5E6C</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x5E6C</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// fd, buff, len</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">hexdump</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>              <span class=\"token literal-property property\">offset</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// ç›¸å¯¹åç§»</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>              <span class=\"token literal-property property\">length</span><span class=\"token operator\">:</span> <span class=\"token number\">0x38</span><span class=\"token operator\">*</span><span class=\"token number\">0x6</span><span class=\"token operator\">+</span><span class=\"token number\">0x20</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//dump çš„å¤§å°</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>              <span class=\"token literal-property property\">header</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>              <span class=\"token literal-property property\">ansi</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">base = </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>module<span class=\"token punctuation\">.</span>base<span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"/360-jiagu/image-20240219185724473.png\" alt=\"image-20240219185724473\" style=\"aspect-ratio:1718 / 884;\"></p>\n<p>ä¸Šé¢çš„ç¬¬ä¸€ä¸ª hexdump å°±æ˜¯ <code>program header table</code> , æˆ‘ä»¬å¯ä»¥ç”¨ <code>cyberchef</code>  å°† <code>hexdump</code>  è½¬æˆæ•°ç»„çš„å½¢å¼</p>\n<p><img data-src=\"/360-jiagu/image-20240219190012572.png\" alt=\"image-20240219190012572\" style=\"aspect-ratio:1920 / 973;\"></p>\n<p><code>0x6</code>  åˆ™å¯¹åº”ç€ <code>phnum</code> , è¿™è¡¨ç¤ºå…±æœ‰ 6 ä¸ª <code>program header table</code></p>\n<p><code>0x793ca38000</code>  è¡¨ç¤ºè¿™ä¸ªä¸» ELF çš„åŸºå€ï¼Œå› ä¸ºè¿™ä¸ªä¸» ELF çš„ä½ç½®åœ¨å£³ ELF åŸºå€çš„åç§» <code>0xe7000</code>  å¤„ï¼Œè€Œæœ€ä¸‹é¢è¿™è¡Œä¹Ÿå·²ç»æ‰“å°å‡ºäº†å£³ ELF çš„åŸºå€ä¸º <code>0x793c951000</code> , <code>0x793ca38000==0x793c951000+0xe7000</code>  ç­‰å¼æˆç«‹</p>\n<p>è‡³æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬æ‹¿åˆ°äº†è§£å¯†ä¹‹åçš„ <code>program header table</code> , åŒæ—¶æˆ‘ä»¬ä¹ŸçŸ¥é“äº† <code>sub_5E6C</code>  ä¼ å…¥çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ <code>phdr</code> , <code>phnum</code>  ä»¥åŠ <code>base</code></p>\n<p>ä½†æ˜¯ <code>phdr</code>  æˆå‘˜å‘½åæ˜¯åœ¨ soinfo åç§»çš„ <code>0x0</code>  çš„ä½ç½®</p>\n<p><img data-src=\"/360-jiagu/image-20240219191502430.png\" alt=\"image-20240219191502430\" style=\"aspect-ratio:601 / 296;\"></p>\n<p>é‚£å‡å¦‚ <code>a1</code>  çš„ç±»å‹å°±æ˜¯ <code>soinfo*</code> , ä¸ºä»€ä¹ˆåœ¨ <code>sub_4918</code>  é‡Œé¢è°ƒç”¨ <code>sub_5E6C</code>  ä¼ å…¥çš„æ˜¯åç§»æ˜¯ <code>232</code>  å‘¢ï¼Ÿ</p>\n<p><img data-src=\"/360-jiagu/image-20240219191628154.png\" alt=\"image-20240219191628154\" style=\"aspect-ratio:1047 / 206;\"></p>\n<p>æ‰€ä»¥ <code>soinfo*</code>  å¿…å®šæœ‰è¢«é­”æ”¹ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ soinfo å‰å¡«å……ä¸€ä¸ªå¤§å°ä¸º 232 çš„ char ç±»å‹æ•°ç»„çœ‹çœ‹æ˜¯ä»€ä¹ˆæƒ…å†µ</p>\n<p><img data-src=\"/360-jiagu/image-20240219191808113.png\" alt=\"image-20240219191808113\" style=\"aspect-ratio:355 / 229;\"></p>\n<p>å¾ˆå¥½ï¼Œè¿™éªŒè¯äº†æˆ‘ä»¬å¯¹äº <code>soinfo*</code>  è¢«é­”æ”¹çš„çŒœæµ‹ï¼Œå› ä¸ºåœ¨ä¸€åˆ‡æ­£å¸¸çš„æƒ…å†µä¹‹ä¸‹ï¼Œå‡½æ•°çš„è°ƒç”¨åº”è¯¥æ˜¯ <code>sub_5E6C(a1-&gt;phdr, a1-&gt;phnum, a1-&gt;base)</code>  æ‰å¯¹</p>\n<p><img data-src=\"/360-jiagu/image-20240219191839316.png\" alt=\"image-20240219191839316\" style=\"aspect-ratio:986 / 145;\"></p>\n<p>ä½†æ˜¯æˆ‘å¾ˆæƒ³çŸ¥é“è¿™ä¸ªå£³ ELF ç©¶ç«Ÿæ˜¯å¦‚ä½•è¢«è§£å¯†å‡ºæ¥çš„ï¼Œé‚£ä¹ˆé¦–å…ˆæ¥çœ‹çœ‹ä¸» ELF çš„å‡½æ•°è°ƒç”¨é“¾æ˜¯ä»€ä¹ˆæ ·å­çš„å§ï½</p>\n<p>æˆ‘å†™äº†ä¸€ä¸ª ida æ’ä»¶æ¥å®ç°è¿™ä¸ªè¿‡ç¨‹<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL29hY2lhL3N0YWxrZXJfdHJhY2Vfc28=\"> stalker_trace_so</span></p>\n<p>åœ¨ IDA ä¸­ä½¿ç”¨ <code>Edit-&gt;Plugins-&gt;stalker_trace_so</code>  åï¼Œåœ¨ so æ‰€åœ¨çš„ç›®å½•ä¸‹ä¼šç”Ÿæˆä¸€ä¸ª js è„šæœ¬ï¼Œæˆ‘ä»¬ç”¨ frida æ³¨å…¥åˆ° apk ä¸­å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ <code>so_name</code>  éœ€è¦æ”¹æˆ <code>libjiagu_64.so</code></p>\n<p><img data-src=\"/360-jiagu/image-20231118152818874.png\" alt=\"image-20231118152818874\" style=\"aspect-ratio:733 / 171;\"></p>\n<p>æ‰“å°å‡ºæ¥çš„å®Œæ•´æ—¥å¿—å¦‚ä¸‹</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>call1<span class=\"token operator\">:</span>JNI_OnLoad</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>call2<span class=\"token operator\">:</span><span class=\"token class-name\">j_interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>call3<span class=\"token operator\">:</span><span class=\"token class-name\">interpreter_wrap_int64_t</span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>call4<span class=\"token operator\">:</span>getenv</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>call5<span class=\"token operator\">:</span>sub_13908</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>call6<span class=\"token operator\">:</span>inotify_add_watch</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>call7<span class=\"token operator\">:</span>sub_11220</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>call8<span class=\"token operator\">:</span>fopen</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>call9<span class=\"token operator\">:</span>sub_9DD8</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>call10<span class=\"token operator\">:</span>sub_E3E0</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>call11<span class=\"token operator\">:</span>strtol</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>call12<span class=\"token operator\">:</span>feof</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>call13<span class=\"token operator\">:</span>raise</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>call14<span class=\"token operator\">:</span>memset</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>call15<span class=\"token operator\">:</span>sub_C918</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>call16<span class=\"token operator\">:</span>sub_9988</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>call17<span class=\"token operator\">:</span>sub_9964</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>call18<span class=\"token operator\">:</span>sub_9AC4</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>call19<span class=\"token operator\">:</span>j_ffi_prep_cif</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>call20<span class=\"token operator\">:</span>ffi_prep_cif</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>call21<span class=\"token operator\">:</span>j_ffi_prep_cif_machdep</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>call22<span class=\"token operator\">:</span>ffi_prep_cif_machdep</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>call23<span class=\"token operator\">:</span>j_ffi_call</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>call24<span class=\"token operator\">:</span>ffi_call</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>call25<span class=\"token operator\">:</span>sub_1674C</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>call26<span class=\"token operator\">:</span>j_ffi_call_SYSV</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>call27<span class=\"token operator\">:</span>ffi_call_SYSV</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>call28<span class=\"token operator\">:</span>sub_167BC</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>call29<span class=\"token operator\">:</span>sub_1647C</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>call30<span class=\"token operator\">:</span>sub_163DC</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>call31<span class=\"token operator\">:</span>sub_9900</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>call32<span class=\"token operator\">:</span>sub_94BC</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>call33<span class=\"token operator\">:</span>inotify_init</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>call34<span class=\"token operator\">:</span>fmod</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>call35<span class=\"token operator\">:</span>strncpy</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>call36<span class=\"token operator\">:</span>_Z9__arm_a_1P7_JavaVMP7_JNIEnvPvRi</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>call37<span class=\"token operator\">:</span>sub_9E58</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>call38<span class=\"token operator\">:</span>sub_999C</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>call39<span class=\"token operator\">:</span>sub_10964</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>call40<span class=\"token operator\">:</span>j_lseek_1</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>call41<span class=\"token operator\">:</span>lseek</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>call42<span class=\"token operator\">:</span>sub_96E0</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>call43<span class=\"token operator\">:</span>sub_8000</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>call44<span class=\"token operator\">:</span>dlopen</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>call45<span class=\"token operator\">:</span>sub_60E0</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>call46<span class=\"token operator\">:</span>sub_6544</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>call47<span class=\"token operator\">:</span>sub_4B54</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>call48<span class=\"token operator\">:</span>sub_6128</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>call49<span class=\"token operator\">:</span>_ZN9__arm_c_19__arm_c_0Ev</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>call50<span class=\"token operator\">:</span>sub_A3EC</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>call51<span class=\"token operator\">:</span>sub_99CC</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>call52<span class=\"token operator\">:</span>sub_9944</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>call53<span class=\"token operator\">:</span>sub_6484</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>call54<span class=\"token operator\">:</span>sub_6590</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>call55<span class=\"token operator\">:</span>prctl</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>call56<span class=\"token operator\">:</span>sub_6698</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>call57<span class=\"token operator\">:</span>sub_9FFC</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>call58<span class=\"token operator\">:</span>j_lseek_3</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>call59<span class=\"token operator\">:</span>j_lseek_2</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>call60<span class=\"token operator\">:</span>j_lseek_0</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>call61<span class=\"token operator\">:</span>sub_9A90</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>call62<span class=\"token operator\">:</span>sub_5F20</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>call63<span class=\"token operator\">:</span>sub_6044</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>call64<span class=\"token operator\">:</span>sub_3574</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>call65<span class=\"token operator\">:</span>uncompress</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>call66<span class=\"token operator\">:</span>sub_49F0</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>call67<span class=\"token operator\">:</span>sub_5400</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>call68<span class=\"token operator\">:</span>sub_5478</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>call69<span class=\"token operator\">:</span>sub_5B08</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>call70<span class=\"token operator\">:</span>sub_5650</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>call71<span class=\"token operator\">:</span>sub_580C</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>call72<span class=\"token operator\">:</span>open</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>call73<span class=\"token operator\">:</span>atoi</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>call74<span class=\"token operator\">:</span>sub_3C94</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>call75<span class=\"token operator\">:</span>strncmp</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>call76<span class=\"token operator\">:</span>sub_4918</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>call77<span class=\"token operator\">:</span>sub_4000</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>call78<span class=\"token operator\">:</span>sub_41B4</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>call79<span class=\"token operator\">:</span>sub_35AC</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>call80<span class=\"token operator\">:</span>sigaction</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>call81<span class=\"token operator\">:</span>sub_5E6C</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>call82<span class=\"token operator\">:</span>sub_5444</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>call83<span class=\"token operator\">:</span>sub_633C</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>call84<span class=\"token operator\">:</span>sub_8130</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>call85<span class=\"token operator\">:</span>sub_4C70</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>call86<span class=\"token operator\">:</span>sub_825C</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>call87<span class=\"token operator\">:</span>sub_8B50</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>call88<span class=\"token operator\">:</span>sub_8ED4</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>call89<span class=\"token operator\">:</span>sub_8430</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>call90<span class=\"token operator\">:</span>interpreter_wrap_int64_t_bridge</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>call91<span class=\"token operator\">:</span>sub_9D60</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>call92<span class=\"token operator\">:</span>sub_166C4</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>call93<span class=\"token operator\">:</span>memcpy</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>call94<span class=\"token operator\">:</span>_Z9__arm_a_2PcmS_Rii</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>call95<span class=\"token operator\">:</span>j_ffi_prep_cif_var</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>call96<span class=\"token operator\">:</span>ffi_prep_cif_var</pre></td></tr></table></figure><p>æˆ‘ä»¬ä»¥ <code>sub_3C94</code>  ä¸ºèµ·ç‚¹å¼€å§‹åˆ†æï¼Œå› ä¸ºè¿™æ˜¯æˆ‘ä»¬é€šè¿‡ <code>dlopen</code>  äº¤å‰å¼•ç”¨æ‰¾åˆ°çš„<strong>è‡ªå®ç° linker åŠ å›º so</strong> çš„ä¸€ä¸ªåŠŸèƒ½å‡½æ•°</p>\n<p>å¯¹ <code>sub_3C94</code>  ä¸æ–­æŒ‰ä¸‹ <code>X</code>  æŸ¥çœ‹äº¤å‰å¼•ç”¨ï¼Œå¾—åˆ°å¦‚ä¸‹çš„è°ƒç”¨å…³ç³» <code>sub_4B54-&gt;sub_49F0-&gt;sub_3C94</code></p>\n<p><code>sub_4B54</code>  å¯èƒ½è¢« <code>sub_8000</code>  æˆ– <code>sub_8C74</code>  è°ƒç”¨</p>\n<p><img data-src=\"/360-jiagu/image-20240219195550519.png\" alt=\"image-20240219195550519\" style=\"aspect-ratio:879 / 220;\"></p>\n<p>æˆ‘ä»¬å°† <code>stalker_trace_so</code>  æ‰“å°å‡ºæ¥çš„å†…å®¹ä¸­ï¼Œæå–å…³é”®çš„éƒ¨åˆ†æ‹¿è¿‡æ¥çœ‹çœ‹ï¼Œè¯´æ˜ <code>sub_4B54</code>  æ˜¯è¢« <code>sub_8000</code>  è°ƒç”¨çš„</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>call43<span class=\"token operator\">:</span>sub_8000 <span class=\"token operator\">&lt;</span><span class=\"token operator\">--</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>call44<span class=\"token operator\">:</span>dlopen</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>call45<span class=\"token operator\">:</span>sub_60E0</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>call46<span class=\"token operator\">:</span>sub_6544</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>call47<span class=\"token operator\">:</span>sub_4B54 <span class=\"token operator\">&lt;</span><span class=\"token operator\">--</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>call48<span class=\"token operator\">:</span>sub_6128</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>call49<span class=\"token operator\">:</span>_ZN9__arm_c_19__arm_c_0Ev</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>call50<span class=\"token operator\">:</span>sub_A3EC</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>call51<span class=\"token operator\">:</span>sub_99CC</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>call52<span class=\"token operator\">:</span>sub_9944</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>call53<span class=\"token operator\">:</span>sub_6484</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>call54<span class=\"token operator\">:</span>sub_6590</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>call55<span class=\"token operator\">:</span>prctl</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>call56<span class=\"token operator\">:</span>sub_6698</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>call57<span class=\"token operator\">:</span>sub_9FFC</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>call58<span class=\"token operator\">:</span>j_lseek_3</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>call59<span class=\"token operator\">:</span>j_lseek_2</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>call60<span class=\"token operator\">:</span>j_lseek_0</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>call61<span class=\"token operator\">:</span>sub_9A90</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>call62<span class=\"token operator\">:</span>sub_5F20</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>call63<span class=\"token operator\">:</span>sub_6044</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>call64<span class=\"token operator\">:</span>sub_3574</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>call65<span class=\"token operator\">:</span>uncompress</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>call66<span class=\"token operator\">:</span>sub_49F0 <span class=\"token operator\">&lt;</span><span class=\"token operator\">--</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>call67<span class=\"token operator\">:</span>sub_5400</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>call68<span class=\"token operator\">:</span>sub_5478</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>call69<span class=\"token operator\">:</span>sub_5B08</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>call70<span class=\"token operator\">:</span>sub_5650</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>call71<span class=\"token operator\">:</span>sub_580C</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>call72<span class=\"token operator\">:</span>open</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>call73<span class=\"token operator\">:</span>atoi</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>call74<span class=\"token operator\">:</span>sub_3C94 <span class=\"token operator\">&lt;</span><span class=\"token operator\">--</span></pre></td></tr></table></figure><p><code>sub_8000</code>  çš„å‡½æ•°é•¿è¿™ä¸ªæ ·å­ï¼Œè¯·è®°ä½ç¬¬ 25 è¡Œ <code>0xB8010</code>  è¿™ä¸ªæ•°å­—ï¼Œåé¢ä¼šæ´¾ä¸Šç”¨åœºçš„</p>\n<p><img data-src=\"/360-jiagu/image-20240219200830705.png\" alt=\"image-20240219200830705\" style=\"aspect-ratio:791 / 678;\"></p>\n<p>è·Ÿç€å‡½æ•°è°ƒç”¨é“¾ä¸€å¤„ä¸€å¤„çš„åœ¨ IDA ä¸­è·³è½¬åˆ°ç›¸åº”çš„åœ°å€è¿›è¡ŒæŸ¥çœ‹ï¼Œåœ¨ <code>call62:sub_5F20</code>  æˆ‘ä»¬å‘ç°äº†æœ‰æ„æ€çš„ä»£ç </p>\n<p>è¿™ä¸ªå‡½æ•°ï¼Œä¸€çœ¼ RC4 å‘€</p>\n<p><img data-src=\"/360-jiagu/image-20240219200139731.png\" alt=\"image-20240219200139731\" style=\"aspect-ratio:1387 / 810;\"></p>\n<p>ç”¨ frida å» hook ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çœ‹çœ‹ RC4 çš„å¯†é’¥æ˜¯ä»€ä¹ˆ</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_5f20_guess_rc4</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span><span class=\"token comment\">// åƒæ˜¯ RC4 çš„æ ·å­ï¼Œhook çœ‹çœ‹</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x5f20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// fd, buff, len</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">hexdump</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>              <span class=\"token literal-property property\">offset</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// ç›¸å¯¹åç§»</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>              <span class=\"token literal-property property\">length</span><span class=\"token operator\">:</span> <span class=\"token number\">0x10</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//dump çš„å¤§å°</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>              <span class=\"token literal-property property\">header</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>              <span class=\"token literal-property property\">ansi</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">hexdump</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              <span class=\"token literal-property property\">offset</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// ç›¸å¯¹åç§»</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              <span class=\"token literal-property property\">length</span><span class=\"token operator\">:</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//dump çš„å¤§å°</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>              <span class=\"token literal-property property\">header</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>              <span class=\"token literal-property property\">ansi</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"/360-jiagu/image-20240219200302071.png\" alt=\"image-20240219200302071\" style=\"aspect-ratio:1214 / 231;\"></p>\n<p>æ‰€ä»¥å¯†é’¥å°±æ˜¯è¿™ä¸ªå’¯</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>key <span class=\"token operator\">=</span> <span class=\"token string\">b\"vUV4#\\x91#SVt\"</span></pre></td></tr></table></figure><p>ç»§ç»­è·Ÿç€å‡½æ•°è°ƒç”¨é“¾èµ°ï¼Œåœ¨ <code>call63:sub_6044</code>  æˆ‘ä»¬å‘ç°äº† RC4 çš„è§£å¯†å‡½æ•°</p>\n<p><img data-src=\"/360-jiagu/image-20240219200510607.png\" alt=\"image-20240219200510607\" style=\"aspect-ratio:811 / 731;\"></p>\n<p>hook ä¸€ä¸‹ <code>call63:sub_6044</code>  çœ‹çœ‹åˆ°åº•ç»™ä»€ä¹ˆæ•°æ®è§£å¯†äº†</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">var</span> rc4_enc_text_addr<span class=\"token punctuation\">,</span>rc4_enc_size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_rc4_enc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x6044</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">// fd, buff, len</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            rc4_enc_text_addr <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            rc4_enc_size <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">hexdump</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>              <span class=\"token literal-property property\">offset</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// ç›¸å¯¹åç§»</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>              <span class=\"token literal-property property\">length</span><span class=\"token operator\">:</span> <span class=\"token number\">0x30</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//dump çš„å¤§å°</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>              <span class=\"token literal-property property\">header</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>              <span class=\"token literal-property property\">ansi</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">hexdump</span><span class=\"token punctuation\">(</span>rc4_enc_text_addr<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>              <span class=\"token literal-property property\">offset</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// ç›¸å¯¹åç§»</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>              <span class=\"token literal-property property\">length</span><span class=\"token operator\">:</span> <span class=\"token number\">0x30</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//dump çš„å¤§å°</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>              <span class=\"token literal-property property\">header</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              <span class=\"token literal-property property\">ansi</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"/360-jiagu/image-20240219200703480.png\" alt=\"image-20240219200703480\" style=\"aspect-ratio:1193 / 269;\"></p>\n<p>è¿™ä¸ªå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ <code>0xb8010</code> , æ„Ÿè§‰æ˜¯è§£å¯†çš„æ•°æ®çš„é•¿åº¦çš„æ ·å­ï¼Œè€Œä¸”è¿™ä¸ªæ•°å­—ï¼Œæœ‰æ²¡æœ‰æ„Ÿè§‰åœ¨å“ªé‡Œè§è¿‡å‘¢ï¼Ÿ</p>\n<p>æ²¡é”™ï¼Œè¿™ä¸ªæ•°å­—åˆšåˆšå°±å‡ºç°åœ¨ <code>sub_8000</code>  ä¸­</p>\n<p><img data-src=\"/360-jiagu/image-20240219201000793.png\" alt=\"image-20240219201000793\" style=\"aspect-ratio:479 / 184;\"></p>\n<p>è€Œ <code>v5[0]</code>  çš„å€¼æ˜¯ <code>qword_2E270</code> , è¿™ä¸ªæ•°ç»„ä¹Ÿæ˜¯ <code>01 18 25 e7</code>  å¼€å¤´çš„</p>\n<p><img data-src=\"/360-jiagu/image-20240219201131482.png\" alt=\"image-20240219201131482\" style=\"aspect-ratio:1100 / 471;\"></p>\n<p>ç»§ç»­è·Ÿç€è°ƒç”¨é“¾èµ°ï¼Œæ¥ä¸‹æ¥æ˜¯è°ƒç”¨ <code>call65:uncompress</code> , è¿›è¡Œè§£å‹ç¼©æ“ä½œ</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_uncompress_res</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>Module<span class=\"token punctuation\">.</span><span class=\"token function\">findExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"uncompress\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hook uncompress\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">hexdump</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>              <span class=\"token literal-property property\">offset</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// ç›¸å¯¹åç§»</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>              <span class=\"token literal-property property\">length</span><span class=\"token operator\">:</span> <span class=\"token number\">0x30</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//dump çš„å¤§å°</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>              <span class=\"token literal-property property\">header</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>              <span class=\"token literal-property property\">ansi</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token function\">dump_memory</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">uncompress_</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token string\">_</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$&#123;</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token interpolation-punctuation punctuation\">&#125;</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ç°è§£å‹ç¼©çš„æ•°æ®ï¼Œå‰é¢å››ä¸ªå­—èŠ‚ <code>b9 0e 1a 00</code>  æ²¡æœ‰åŒ…å«åœ¨è§£å‹ç¼©çš„å­—èŠ‚ä¹‹å†…</p>\n<p><img data-src=\"/360-jiagu/image-20240219202037098.png\" alt=\"image-20240219202037098\" style=\"aspect-ratio:1193 / 464;\"></p>\n<p>ç°åœ¨æ—¢ç„¶æˆ‘ä»¬å·²ç»çŸ¥é“äº†ä¸» ELF åœ¨å£³ ELF ä¸­çš„ä½ç½®ï¼Œä»¥åŠè§£å¯†çš„ç®—æ³•ï¼Œé‚£æˆ‘ä»¬ç›´æ¥ä»è§£å‹ apk, æ‰¾åˆ°é‡Œé¢çš„ <code>assets/libjiagu_a64.so</code> , ä¸å°±èƒ½ç›´æ¥æŠŠå£³ ELF è§£å¯†å‡ºæ¥å’¯</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> zlib</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> struct</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">RC4</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    S <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    j <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    out <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\"># KSA Phase</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        j <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">+</span> S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> key<span class=\"token punctuation\">[</span>i <span class=\"token operator\">%</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\"># PRGA Phase</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    i <span class=\"token operator\">=</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">for</span> ch <span class=\"token keyword\">in</span> data<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        i <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        j <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">+</span> S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        out<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>ch <span class=\"token operator\">^</span> S<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">return</span> out</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">RC4decrypt</span><span class=\"token punctuation\">(</span>ciphertext<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">return</span> RC4<span class=\"token punctuation\">(</span>ciphertext<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>wrap_elf_start <span class=\"token operator\">=</span> <span class=\"token number\">0x1e270</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>wrap_elf_size <span class=\"token operator\">=</span> <span class=\"token number\">0xb8010</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>key <span class=\"token operator\">=</span> <span class=\"token string\">b\"vUV4#\\x91#SVt\"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'com.oacia.apk_protect/assets/libjiagu_a64.so'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    wrap_elf <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\"># å¯¹å¯†æ–‡è¿›è¡Œè§£å¯†</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>dec_compress_elf <span class=\"token operator\">=</span> RC4decrypt<span class=\"token punctuation\">(</span>wrap_elf<span class=\"token punctuation\">[</span>wrap_elf_start<span class=\"token punctuation\">:</span>wrap_elf_start<span class=\"token operator\">+</span>wrap_elf_size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>dec_elf <span class=\"token operator\">=</span> zlib<span class=\"token punctuation\">.</span>decompress<span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span>dec_compress_elf<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'wrap_elf'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>dec_elf<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è§£å¯†å®Œæˆåï¼Œæˆ‘ä»¬å‘ç° <code>0x1a0eb9</code>  åº”è¯¥è¡¨ç¤ºè§£å‹ç¼©ä¹‹åæ•°æ®çš„å¤§å°</p>\n<p><img data-src=\"/360-jiagu/image-20240220214503336.png\" alt=\"image-20240220214503336\" style=\"aspect-ratio:926 / 305;\"></p>\n<p><img data-src=\"/360-jiagu/image-20240220131405321.png\" alt=\"image-20240220131405321\" style=\"aspect-ratio:831 / 258;\"></p>\n<p><code>wrap_elf</code>  çš„å‰åŠéƒ¨åˆ†æ˜¯ä¸€å¤§å †è«åå…¶å¦™æœ‰å¾ˆå¤š <code>D3</code>  çš„ä¸œè¥¿ï¼Œä½†æ˜¯çœ‹åˆ°ä¸­é—´è¿˜æ˜¯å‘ç°äº†å£³ ELF çš„èº«å½±</p>\n<p><img data-src=\"/360-jiagu/image-20240219203139130.png\" alt=\"image-20240219203139130\" style=\"aspect-ratio:811 / 423;\"></p>\n<p>æˆ‘ä»¬ä»¥ <code>.ELF</code>  ä¸ºæ ‡å¿—å°†è¿™ä¸¤éƒ¨åˆ†åˆ†ç¦»ä¸€ä¸‹</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'wrap_elf'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    wrap_elf <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ELF_magic <span class=\"token operator\">=</span> <span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0x7F</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x45</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x4C</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x46</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>wrap_elf<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>ELF_magic<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> wrap_elf<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">:</span>i <span class=\"token operator\">+</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>ELF_magic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> ELF_magic<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'wrap_elf_part1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>wrap_elf<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'wrap_elf_part2'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>wrap_elf<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">break</span></pre></td></tr></table></figure><p>è·Ÿç€å‡½æ•°è°ƒç”¨é“¾æ¥åˆ° <code>call69:sub_5B08</code> , è¿™é‡Œåˆå‡ºç°äº† <code>0x38</code> , å¹¶ä¸” <code>word_38</code>  è·³è½¬è¿‡å»çš„å€¼ä¸º 6</p>\n<p><img data-src=\"/360-jiagu/image-20240220000932490.png\" alt=\"image-20240220000932490\" style=\"aspect-ratio:677 / 365;\"></p>\n<p>è¿™æ­£å¥½å’Œ <code>phentsize</code>  å’Œ <code>phnum</code>  çš„å€¼ç›¸å¯¹åº”</p>\n<p><img data-src=\"/360-jiagu/image-20240220001104708.png\" alt=\"image-20240220001104708\" style=\"aspect-ratio:1079 / 51;\"></p>\n<p>æ‰€ä»¥å¯æƒ³è€ŒçŸ¥ï¼Œè¿™åˆæ˜¯ä¸€ä¸ªå…³é”®ç‚¹äº†ï¼Œå¾€ä¸‹çœ‹ä¸€ä¸‹ä»£ç ï¼Œå‘ç°äº†å¾ªç¯å¼‚æˆ–ï¼Œé‚£æˆ‘ä»¬ä¸å¦¨ç”¨ frida æŠŠ <code>v4</code>  çš„å€¼ hook ä¸‹æ¥çœ‹çœ‹æ˜¯ä»€ä¹ˆ</p>\n<p><img data-src=\"/360-jiagu/image-20240220001342895.png\" alt=\"image-20240220001342895\" style=\"aspect-ratio:641 / 741;\"></p>\n<p>v4 çš„å€¼å‡ºç°äº†é‚£ä¹ˆå¤šçš„ <code>d3</code></p>\n<p><img data-src=\"/360-jiagu/image-20240220001528743.png\" alt=\"image-20240220001528743\" style=\"aspect-ratio:1200 / 470;\"></p>\n<p>è€Œè¿™å°±æ˜¯ <code>wrap_elf</code>  çš„å‰åŠéƒ¨åˆ†é‚£ä¸€å¤§å †æˆ‘ä»¬çœ‹ä¸æ‡‚çš„å­—èŠ‚</p>\n<p><img data-src=\"/360-jiagu/image-20240220012621743.png\" alt=\"image-20240220012621743\" style=\"aspect-ratio:794 / 494;\"></p>\n<p>æ¥ä¸‹æ¥ç”¨æ¥è§£å¯†çš„å¾ªç¯å°±æ˜¯ä¸€ä¸ª arm64 çš„ neon è¿ç®—</p>\n<p><img data-src=\"/360-jiagu/image-20240220003908902.png\" alt=\"image-20240220003908902\" style=\"aspect-ratio:645 / 327;\"></p>\n<p>å®˜ç½‘å¯ä»¥æ‰¾åˆ°<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYXJtLmNvbS9hcmNoaXRlY3R1cmVzL2luc3RydWN0aW9uLXNldHMvaW50cmluc2ljcy8jcT12ZHVwcV9uX3M4\"> vdupq_n_s8</span> å’Œ<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYXJtLmNvbS9hcmNoaXRlY3R1cmVzL2luc3RydWN0aW9uLXNldHMvaW50cmluc2ljcy8jcT12ZW9ycV9zOA==\"> veorq_s8</span>, æ ¹æ®å‡½æ•°æè¿°å¯ä»¥çŸ¥é“è¿™é‡Œç”¨å‘é‡è¿ç®—ï¼ŒæŠŠå‘é‡ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¼‚æˆ–äº† <code>0xd3</code></p>\n<p><img data-src=\"/360-jiagu/image-20240220004233903.png\" alt=\"image-20240220004233903\" style=\"aspect-ratio:1225 / 511;\"></p>\n<p><img data-src=\"/360-jiagu/image-20240220004029770.png\" alt=\"image-20240220004029770\" style=\"aspect-ratio:1232 / 517;\"></p>\n<p>å¯¹ <code>sub_5B08</code>  è¿›è¡Œåˆ†æä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥çŸ¥é“ <code>wrap_elf_part1</code>  çš„è¯»å–æ–¹å¼æ˜¯ç¬¬ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºè¢«å¼‚æˆ–çš„æ•°å­—ï¼Œè¿™é‡Œæ˜¯ <code>0xD3</code> , åé¢çš„å››ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªæ®µçš„é•¿åº¦ï¼Œéšåè¯»å–æŒ‡å®šé•¿åº¦çš„å­—èŠ‚å¹¶å¼‚æˆ–ï¼Œä¹‹åå†è¯»å–å››ä¸ªå­—èŠ‚è·å–åˆ°ä¸‹ä¸€ä¸ªæ®µçš„é•¿åº¦ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°è¯»å–åˆ°æ–‡ä»¶æœ«å°¾</p>\n<p><img data-src=\"/360-jiagu/image-20240220012939262.png\" alt=\"image-20240220012939262\" style=\"aspect-ratio:800 / 628;\"></p>\n<p>åœ¨ <code>sub_5B08</code>  çš„æœ€åï¼Œå› ä¸º <code>v31</code> , <code>v19</code> , <code>v43</code> , <code>v7</code>  ä»£è¡¨å¯¹åº”çš„æ•°æ®ç»„çš„é•¿åº¦ï¼Œæ‰€ä»¥è¿™é‡Œå…±æœ‰å››ä¸ªæ•°æ®ç»„ï¼Œè€Œä¸ºäº†è¡¨ç¤ºæ¯ä¸€ä¸ªæ•°æ®ç»„çš„é•¿åº¦å…±éœ€å ç”¨ <code>4*4=16</code>  å­—èŠ‚ï¼Œå¹¶ä¸”æ–‡ä»¶å¼€å¤´è¿˜æœ‰ <code>1</code>  ä½çš„å¼‚æˆ–å€¼ï¼Œäºæ˜¯è¿™äº›é•¿åº¦åŠ èµ·æ¥ï¼Œ <code>*(a1 + 0x98)</code>  çš„åç§»å°±æ¥åˆ°äº†ä¸» ELF çš„é­”æœ¯å¤´ <code>.ELF</code>  çš„ä½ç½®äº†</p>\n<p><img data-src=\"/360-jiagu/image-20240220013039190.png\" alt=\"image-20240220013039190\" style=\"aspect-ratio:630 / 66;\"></p>\n<p><img data-src=\"/360-jiagu/image-20240220013502056.png\" alt=\"image-20240220013502056\" style=\"aspect-ratio:900 / 363;\"></p>\n<p>æˆ‘ä»¬å¯ä»¥åœ¨ <code>sub_5B08</code>  ä¸­ä¸ºå˜é‡ <code>a1</code>  å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œæˆå‘˜åˆ†åˆ«è¡¨ç¤ºæ•°æ®ç»„çš„ 1,2,3,4 è¿™å››ä¸ªéƒ¨åˆ†ï¼Œè¿™æ ·æˆ‘ä»¬å°±çŸ¥é“è¿™å››ä¸ªéƒ¨åˆ†åˆ†åˆ«è¢«ç”¨åˆ°ä»€ä¹ˆåœ°æ–¹äº†</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">deal_extra</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">char</span> blank<span class=\"token punctuation\">[</span><span class=\"token number\">72</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">int</span> phnum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>extra_part1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">int</span> phdr_size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">char</span> blank2<span class=\"token punctuation\">[</span><span class=\"token number\">36</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>extra_part2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>extra_part3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>extra_part4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>main_elf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"/360-jiagu/image-20240220023743626.png\" alt=\"image-20240220023743626\" style=\"aspect-ratio:656 / 200;\"></p>\n<p>æ¥ä¸‹æ¥å†æ‹ä¸€ä¸‹å‡½æ•°çš„è°ƒç”¨é“¾ <code>sub_49F0-&gt;sub_5478(&amp;v16, a1, v4)-&gt;sub_5B08(a1, a2, a3)</code> , åœ¨ <code>sub_5B08</code>  ä¸­ï¼Œæˆ‘ä»¬æŠŠ <code>a1</code>  çš„ç±»å‹å®šä¹‰æˆäº† <code>deal_extra</code> , æ‰€ä»¥ç†æ‰€åº”å½“çš„ï¼Œæˆ‘ä»¬ä¹ŸæŠŠ <code>sub_49F0</code>  ä¸­çš„å˜é‡ <code>v16</code>  çš„ç±»å‹å®šä¹‰ä¸º <code>deal_extra</code></p>\n<p>åœ¨ <code>sub_49F0</code>  ä¸­æˆ‘ä»¬å‘ç°æˆå‘˜ <code>extra_part</code>  èµ‹å€¼ç»™äº†å˜é‡ <code>v7</code> , æ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸º <code>v7</code>  å»ºç«‹ä¸€ä¸ªç»“æ„ä½“è®© v7 çš„åç§»å¯ä»¥å¯¹åº”è¿™äº›å˜é‡</p>\n<p><img data-src=\"/360-jiagu/image-20240220024254105.png\" alt=\"image-20240220024254105\" style=\"aspect-ratio:507 / 288;\"></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">deal_extra_B</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">char</span> blank<span class=\"token punctuation\">[</span><span class=\"token number\">232</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>extra_part1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">char</span> blank1<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">int</span> phnum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>extra_part4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">char</span> blank2<span class=\"token punctuation\">[</span><span class=\"token number\">24</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>extra_part2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">char</span> blank3<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">int</span> <span class=\"token operator\">*</span>extra_part3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"/360-jiagu/image-20240220024130734.png\" alt=\"image-20240220024130734\" style=\"aspect-ratio:595 / 331;\"></p>\n<p>è¿™æ ·åšæœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ</p>\n<p>æˆ‘ä»¬å‘ç°å˜é‡ <code>v7</code>  åˆ†åˆ«è¢«ä¼ å…¥åˆ°äº† <code>sub_3C94</code>  å’Œ <code>sub_4918</code>  ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«è¿›å»çœ‹çœ‹</p>\n<p><img data-src=\"/360-jiagu/image-20240220024433454.png\" alt=\"image-20240220024433454\" style=\"aspect-ratio:785 / 287;\"></p>\n<p>åœ¨ <code>sub_3C94</code>  ä¸­è§£æäº† <code>extra_part4</code> , æ˜¾è€Œæ˜“è§ï¼Œè¿™ä¸ª <code>switch</code>  æ˜¯ç”¨æ¥å¤„ç†åŠ¨æ€é“¾æ¥åº“çš„ï¼Œå³ <code>extra_part4</code>  å¯¹åº” <code>.dynamic</code>  æ®µ</p>\n<p><img data-src=\"/360-jiagu/image-20240220024522541.png\" alt=\"image-20240220024522541\" style=\"aspect-ratio:801 / 716;\"></p>\n<p><img data-src=\"/360-jiagu/image-20240220024831366.png\" alt=\"image-20240220024831366\" style=\"aspect-ratio:1097 / 757;\"></p>\n<p>åœ¨ <code>sub_4918</code>  ä¸­ï¼Œ <code>extra_part2</code>  å’Œ <code>extra_part3</code>  è¢«ä¼ å…¥åˆ° <code>sub_4000</code>  ä¸­</p>\n<p><img data-src=\"/360-jiagu/image-20240220024916186.png\" alt=\"image-20240220024916186\" style=\"aspect-ratio:972 / 248;\"></p>\n<p>è€Œè¿™ä¸ªå‡½æ•°ä¸­çš„ <code>switch</code>  æ˜¯ç”¨æ¥å¤„ç†é‡å®šä½çš„ï¼Œå› ä¸ºé‡å®šä½ä¸»è¦æœ‰åŸºå€é‡å®šä½å’Œç¬¦å·é‡å®šä½ï¼Œè¿™ä¸¤ä¸ªçš„å€¼åˆ†åˆ«æ˜¯ <code>0x403</code>  å’Œ <code>0x402</code></p>\n<p>æ‰€ä»¥ <code>extra_part2</code>  å’Œ <code>extra_part3</code>  åˆ†åˆ«å¯¹åº”ç€ <code>.rela.dyn</code>  (403 é‡å®šä½) å’Œ <code>.rela.plt</code>  (402 é‡å®šä½)</p>\n<p><img data-src=\"/360-jiagu/image-20240220025025814.png\" alt=\"image-20240220025025814\" style=\"aspect-ratio:713 / 577;\"></p>\n<p><img data-src=\"/360-jiagu/image-20240220145850194.png\" alt=\"image-20240220145850194\" style=\"aspect-ratio:1100 / 208;\"></p>\n<p>è€Œä¹‹å <code>extra_part1</code>  è¢«ä¼ å…¥åˆ°äº† <code>sub_5E6C</code>  ä¸­</p>\n<p><img data-src=\"/360-jiagu/image-20240220025453629.png\" alt=\"image-20240220025453629\" style=\"aspect-ratio:1189 / 232;\"></p>\n<p>è€Œæ¥åˆ° <code>sub_5E6C</code>  ä¹Ÿæ¥åˆ°äº†æˆ‘ä»¬æœ€å¼€å§‹åˆ†æçš„èµ·ç‚¹ (å…œå…œè½¬è½¬åˆå›æ¥äº†), æ‰€ä»¥ <code>extra_part1</code>  è¡¨ç¤º <code>program header table</code></p>\n<p><img data-src=\"/360-jiagu/image-20240220025540021.png\" alt=\"image-20240220025540021\" style=\"aspect-ratio:1270 / 693;\"></p>\n<p>è‡³æ­¤ä¸ºæ­¢ï¼Œå››ä¸ªæ•°æ®ç»„æ‰€å¯¹åº”çš„æ®µéƒ½åˆ†æå®Œæˆ</p>\n<ul>\n<li><code>æ•°æ®ç»„1</code>  è¡¨ç¤º <code>program header table</code></li>\n<li><code>æ•°æ®ç»„2</code>  è¡¨ç¤º <code>.rela.plt</code></li>\n<li><code>æ•°æ®ç»„3</code>  è¡¨ç¤º <code>.rela.dyn</code></li>\n<li><code>æ•°æ®ç»„4</code>  è¡¨ç¤º <code>.dynamic</code></li>\n</ul>\n<p>æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œå†™ä¸ªè„šæœ¬æŠŠè¿™å››ä¸ªæ•°æ®ç»„ç»™åˆ†ç¦»æˆå•ç‹¬çš„æ–‡ä»¶å’¯</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> copy</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> zlib</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">RC4</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    S <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    j <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    out <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\"># KSA Phase</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        j <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">+</span> S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> key<span class=\"token punctuation\">[</span>i <span class=\"token operator\">%</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\"># PRGA Phase</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    i <span class=\"token operator\">=</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">for</span> ch <span class=\"token keyword\">in</span> data<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        i <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        j <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">+</span> S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        out<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>ch <span class=\"token operator\">^</span> S<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">return</span> out</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">RC4decrypt</span><span class=\"token punctuation\">(</span>ciphertext<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">return</span> RC4<span class=\"token punctuation\">(</span>ciphertext<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>wrap_elf_start <span class=\"token operator\">=</span> <span class=\"token number\">0x1e270</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>wrap_elf_size <span class=\"token operator\">=</span> <span class=\"token number\">0xb8010</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>key <span class=\"token operator\">=</span> <span class=\"token string\">b\"vUV4#\\x91#SVt\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'com.oacia.apk_protect/assets/libjiagu_a64.so'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    wrap_elf <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\"># å¯¹å¯†æ–‡è¿›è¡Œè§£å¯†</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>dec_compress_elf <span class=\"token operator\">=</span> RC4decrypt<span class=\"token punctuation\">(</span>wrap_elf<span class=\"token punctuation\">[</span>wrap_elf_start<span class=\"token punctuation\">:</span>wrap_elf_start <span class=\"token operator\">+</span> wrap_elf_size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>dec_elf <span class=\"token operator\">=</span> zlib<span class=\"token punctuation\">.</span>decompress<span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span>dec_compress_elf<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'wrap_elf'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>dec_elf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">part</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        self<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        self<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token string\">b''</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        self<span class=\"token punctuation\">.</span>offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        self<span class=\"token punctuation\">.</span>size <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>index <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>extra_part <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>part<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> _ <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>seg <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"phdr\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\".rela.plt\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\".rela.dyn\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\".dynamic\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>v_xor <span class=\"token operator\">=</span> dec_elf<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    size <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">.</span>from_bytes<span class=\"token punctuation\">(</span>dec_elf<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">:</span>index <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'little'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    index <span class=\"token operator\">+=</span> <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    extra_part<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> seg<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    extra_part<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">lambda</span> x<span class=\"token punctuation\">:</span> x <span class=\"token operator\">^</span> v_xor<span class=\"token punctuation\">,</span> dec_elf<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">:</span>index <span class=\"token operator\">+</span> size<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    extra_part<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>size <span class=\"token operator\">=</span> size</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    index <span class=\"token operator\">+=</span> size</pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token keyword\">for</span> p <span class=\"token keyword\">in</span> extra_part<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token keyword\">if</span> p<span class=\"token punctuation\">.</span>value<span class=\"token operator\">!=</span><span class=\"token string\">b''</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        filename <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"libjiagu.so_</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">_</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>p<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"[</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>p<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">] get </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>filename<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">, size: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span><span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>äºæ˜¯æˆ‘ä»¬å¾—åˆ°äº†è¿™å››ä¸ªæ–‡ä»¶</p>\n<p><img data-src=\"/360-jiagu/image-20240220220013192.png\" alt=\"image-20240220220013192\" style=\"aspect-ratio:725 / 114;\"></p>\n<p><img data-src=\"/360-jiagu/image-20240220220022117.png\" alt=\"image-20240220220022117\" style=\"aspect-ratio:930 / 150;\"></p>\n<h1 id=\"ä¸»elfå¯¼å…¥å¯¼å‡ºè¡¨ä¿®å¤\"><a class=\"anchor\" href=\"#ä¸»elfå¯¼å…¥å¯¼å‡ºè¡¨ä¿®å¤\">#</a> ä¸» ELF å¯¼å…¥å¯¼å‡ºè¡¨ä¿®å¤</h1>\n<p>éœ€è¦è¢«ä¿®å¤çš„ä¸» ELF æ˜¯æˆ‘ä»¬åœ¨ä» <code>assets/libjiagu_a64.so</code>  åˆ©ç”¨ <code>RC4</code>  å’Œ <code>decompress</code>  è§£å¯†å‡ºæ¥çš„æ–‡ä»¶çš„ååŠéƒ¨åˆ†é‚£ä¸ª ELF</p>\n<p>å¯ä»¥å†™ä¸ª python è„šæœ¬åˆ†ç¦»å‡ºåé¢çš„ ELF</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'wrap_elf'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    wrap_elf <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ELF_magic <span class=\"token operator\">=</span> <span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0x7F</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x45</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x4C</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x46</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>wrap_elf<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>ELF_magic<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">if</span> wrap_elf<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">:</span>i <span class=\"token operator\">+</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>ELF_magic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> ELF_magic<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'libjiagu_0xe7000.so'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>wrap_elf<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">break</span></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬æ‹¿åˆ°äº†ä¸» ELF çš„å››ä¸ªé‡è¦çš„æ•°æ®æ®µï¼Œåˆ†åˆ«æ˜¯ <code>phdr</code> , <code>.rela.plt</code> , <code>.rela.dyn</code> , <code>.dynamic</code> , é‚£ä¹ˆæ¥ä¸‹æ¥éœ€è¦åšçš„å·¥ä½œå°±æ˜¯ä¿®å¤ä¸» ELF çš„å¯¼å…¥å¯¼å‡ºè¡¨äº†ï¼Œä¸ç„¶å¯¼å…¥å¯¼å‡ºå‡½æ•°éƒ½çœ‹ä¸è§æ€ä¹ˆé€†å˜ï½</p>\n<p>åœ¨ä½¿ç”¨è‡ªå®ç° linker åŠ å›º so æ—¶ï¼Œ <code>phdr</code> , <code>.rela.plt</code> , <code>.rela.dyn</code> , <code>.dynamic</code>  è¿™å››ä¸ªæ®µæ˜¯ä»å¾…åŠ å›ºçš„ so ä¸­æå–å‡ºæ¥ï¼Œç„¶ååŠ å¯†å­˜å‚¨åˆ°å…¶ä»–ä½ç½®ï¼Œ<strong> åŸæ¥çš„ä½ç½®ä¼šä½¿ç”¨æ— å…³å­—èŠ‚ç›´æ¥è¦†ç›–</strong></p>\n<p>ç­‰åˆ°éœ€è¦ä¸ºåŠ å›ºçš„ so è¿›è¡Œé¢„é“¾æ¥å’Œé‡å®šä½çš„å·¥ä½œæ—¶ï¼Œæ‰å°†è¿™äº›æ®µè§£å¯†å¹¶é€šè¿‡è‡ªå·±å®ç°çš„é¢„é“¾æ¥å’Œé‡å®šä½ä»£ç ï¼Œè®©å¾…åŠ å›ºçš„ so å¯ä»¥æ­£ç¡®çš„è¢«å£³ so åŠ è½½å‡ºæ¥</p>\n<p>æˆ‘ä»¬è¿›è¡Œä¿®å¤çš„æ–¹æ³•å…¶å®å°±è—åœ¨è¿™å¥è¯ä¸­ <code>åŸæ¥çš„ä½ç½®ä¼šä½¿ç”¨æ— å…³å­—èŠ‚ç›´æ¥è¦†ç›–</code> ï¼Œæˆ‘ä»¬å¯ä»¥å°†åˆ†ç¦»å‡ºæ¥çš„è¿™å››ä¸ªæ®µå†å¡å›åˆ°åŸæ¥çš„ä½ç½®</p>\n<p><code>è‡ªå®ç°linkeråŠ å›ºso</code>  çš„åŠ å›ºæ–¹æ¡ˆæ—¢ç„¶éƒ½æŠŠé‚£å››ä¸ªæ®µåŠ å¯†å­˜åˆ°å…¶ä»–åœ°æ–¹äº†ï¼Œé‚£æ€ä¹ˆä¸ç›´æ¥æŠŠåŸæ¥çš„å››ä¸ªæ®µç›´æ¥åˆ é™¤è€Œæ˜¯ç”¨æ— å…³å­—èŠ‚è¦†ç›–å‘¢ï¼Ÿ</p>\n<p>å› ä¸ºç›´æ¥æŠŠæ®µåˆ é™¤æ‰çš„è¯ï¼Œä¼šå½±å“äº†ä¸€æ•´ä¸ª ELF æ–‡ä»¶çš„å¸ƒå±€ï¼Œåç§»å°±ä¼šå˜å¾—å’ŒåŸå…ˆä¸ä¸€æ ·ï¼Œç„¶åäº§ç”Ÿå„ç§å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜</p>\n<blockquote>\n<p>åœ¨ 010editor ä¸­ï¼ŒæŒ‰ä¸‹ <code>ctrl+shift+C</code>  å¯ä»¥å¤åˆ¶æ•´å—å†…å­˜ï¼ŒæŒ‰ä¸‹ <code>ctrl+shift+V</code>  å¯ä»¥ç²˜è´´æ•´å—å†…å­˜</p>\n</blockquote>\n<ol>\n<li>\n<p>ä¿®å¤ <code>program header table</code></p>\n<p>å¤åˆ¶ <code>libjiagu.so_0x150_phdr</code>  çš„æ‰€æœ‰å­—èŠ‚ï¼Œç„¶åæ¥åˆ° <code>libjiagu_0xe7000.so</code>  ä¸­é€‰ä¸­ <code>struct program_header_table</code>  ç²˜è´´</p>\n<p><img data-src=\"/360-jiagu/image-20240220223148864.png\" alt=\"image-20240220223148864\" style=\"aspect-ratio:835 / 788;\"></p>\n<p>éšåæŒ‰ä¸‹ <code>F5</code>  åˆ·æ–°æ¨¡æ¿</p>\n</li>\n<li>\n<p>ä¿®å¤ <code>.dynamic</code></p>\n<p><code>program header table</code>  çš„ <code>(RW_) Dynamic Segment</code>  çš„ <code>p_offset</code>  æŒ‡å‘ <code>.dynamic</code>  æ®µçš„ä½ç½®<br>\n<img data-src=\"/360-jiagu/image-20240220223253986.png\" alt=\"image-20240220223253986\" style=\"aspect-ratio:918 / 471;\"><br>\n è·³è½¬åˆ°è¯¥ä½ç½®ï¼Œå¤åˆ¶ <code>libjiagu.so_0x1b0_.dynamic</code>  çš„å†…å®¹å¹¶ç²˜è´´åˆ°è¿™ä¸ªä½ç½®</p>\n</li>\n<li>\n<p>ä¿®å¤é‡å®šä½è¡¨<br>\næˆ‘ä»¬éœ€è¦é€šè¿‡ <code>.dynamic</code>  æ®µçš„ <code>d_tag</code>  å­—æ®µæ¥ç›´åˆ°é‡å®šä½è¡¨çš„ä½ç½®ï¼Œä¸‹é¢æ˜¯ AOSP ä¸­ <code>d_tag</code>  çš„å®å®šä¹‰<br>\n<img data-src=\"/360-jiagu/image-20240220172348458.png\" alt=\"image-20240220172348458\" style=\"aspect-ratio:480 / 708;\"></p>\n</li>\n</ol>\n<p>æ‰€æœ‰çš„ <code>d_tag</code>  æ ‡å¿—å¯¹åº”çš„å«ä¹‰å¯ä»¥åœ¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vY2QvRTI0ODQ3XzAxL2h0bWwvRTIyMTk2L3RvYy5odG1s\"> ORACLE é“¾æ¥ç¨‹åºå’Œåº“æŒ‡å— </span>ä¸­æ‰¾åˆ°</p>\n<p>å¯¹äºæˆ‘ä»¬ä¿®å¤ä¸» ELF æ¯”è¾ƒé‡è¦çš„ <code>tag</code>  æœ‰</p>\n<table>\n<thead>\n<tr>\n<th>d_tag</th>\n<th>å€¼</th>\n<th>å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>DT_JMPREL</td>\n<td>0x17</td>\n<td><code>.rela.plt</code>  åœ¨æ–‡ä»¶ä¸­çš„åç§»</td>\n</tr>\n<tr>\n<td>DT_PLTRELSZ</td>\n<td>0x2</td>\n<td><code>.rela.plt</code>  çš„å¤§å°</td>\n</tr>\n<tr>\n<td>DT_RELA</td>\n<td>0x7</td>\n<td><code>.rela.dyn</code>  åœ¨æ–‡ä»¶ä¸­çš„åç§»</td>\n</tr>\n<tr>\n<td>DT_RELASZ</td>\n<td>0x8</td>\n<td><code>.rela.dyn</code>  çš„å¤§å°</td>\n</tr>\n</tbody>\n</table>\n<p>æˆ‘ä»¬å¯ä»¥åœ¨ <code>.dynamic</code>  ä¸­å‘ç°è¿™äº› <code>tag</code>  ä»¥åŠå¯¹åº”çš„å€¼</p>\n<p><img data-src=\"/360-jiagu/image-20240221131839098.png\" alt=\"image-20240221131839098\" style=\"aspect-ratio:1139 / 558;\"></p>\n<p>çœ‹çœ‹è¿™ä¸¤ä¸ªå¤§å°åˆ†åˆ«æ˜¯ <code>0x1650</code>  å’Œ <code>0x25188</code> , è¿™ä¸å°±å’Œæˆ‘ä»¬åˆšåˆšåˆ†ç¦»å‡ºæ¥çš„æ–‡ä»¶å¤§å°ä¸€æ¨¡ä¸€æ ·å˜›ï¼Œè¯´æ˜æˆ‘ä»¬ç¦»ä¿®å¤å®Œæˆä¸è¿œäº†</p>\n<p><img data-src=\"/360-jiagu/image-20240220224638674.png\" alt=\"image-20240220224638674\" style=\"aspect-ratio:1175 / 182;\"></p>\n<p>ç„¶åå°±æ˜¯å’Œä¹‹å‰ä¸€æ ·ï¼Œè·³è½¬åˆ° <code>.rela.plt</code>  å’Œ <code>.rela.dyn</code>  çš„å¯¹åº”åœ°å€ï¼Œç„¶åæŠŠè¿™äº›æ®µæœ¬æ¥çš„æ•°æ®ç²˜è´´è¿›å»</p>\n<p>ç°åœ¨æˆ‘ä»¬å°±ä¿®å¤å¥½å•¦ï¼Œæ‹¿ ida æ‰“å¼€ä¸» ELF çœ‹çœ‹ï¼Œæ»¡æ»¡çš„éƒ½æ˜¯ç¬¦å·ï¼</p>\n<p><img data-src=\"/360-jiagu/image-20240221131944227.png\" alt=\"image-20240221131944227\" style=\"aspect-ratio:1920 / 1080;\"></p>\n<p>éšä¾¿æ‰¾ä¸ªå¯¼å…¥å‡½æ•°äº¤å‰å¼•ç”¨çœ‹çœ‹ï¼Œä¸€åˆ‡æ­£å¸¸ <code>(â—'â—¡'â—)</code></p>\n<p><img data-src=\"/360-jiagu/image-20240221132044506.png\" alt=\"image-20240221132044506\" style=\"aspect-ratio:1920 / 1080;\"></p>\n<p>ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸» ELF çš„åŸºå€å®šä¹‰æˆåœ¨å…¶åœ¨å£³ ELF çš„åç§» <code>0xe7000</code>  æ–¹ä¾¿åç»­çš„åˆ†æ</p>\n<h1 id=\"ä¸»dexè§£å¯†æµç¨‹åˆæ­¥åˆ†æ\"><a class=\"anchor\" href=\"#ä¸»dexè§£å¯†æµç¨‹åˆæ­¥åˆ†æ\">#</a> ä¸» DEX è§£å¯†æµç¨‹åˆæ­¥åˆ†æ</h1>\n<p>è¿˜è®°å¾—åœ¨<strong>åŠ å›ºå£³åè°ƒè¯•åˆæ­¥åˆ†æ</strong>ä¸­ï¼Œæˆ‘ä»¬æ‹¿åˆ°äº†æœªè§£å¯†çš„ dex å˜›</p>\n<p><img data-src=\"/360-jiagu/image-20240220231727044.png\" alt=\"image-20240220231727044\" style=\"aspect-ratio:789 / 448;\"></p>\n<p>é‚£ä¹ˆæ¥ä¸‹æ¥æœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œè¿™ä¸ªæœªè§£å¯†çš„ dex ç©¶ç«Ÿè—åœ¨äº† apk çš„ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿ</p>\n<p>æˆ‘å°†æœªåŠ å›ºçš„ apk è§£å‹å‡ºæ¥ï¼Œç„¶åç”¨ 7zip å‹ç¼©å…¶ä¸­çš„ dex, å‘ç°å¤§å°ä¾ç„¶æœ‰ 2.8MB</p>\n<p><img data-src=\"/360-jiagu/image-20240220231901275.png\" alt=\"image-20240220231901275\" style=\"aspect-ratio:602 / 59;\"></p>\n<p>éšåæˆ‘å°†ç»è¿‡ 360 åŠ å›ºä¹‹åçš„ apk è§£å‹å‡ºæ¥ï¼ŒæŒ‰å¤§å°å¯¹æ–‡ä»¶è¿›è¡Œæ’åºä¹‹åå‘ç°ï¼Œæœ€å¤§çš„æ–‡ä»¶å°±åªæœ‰è¿™ä¸ªå£³ <code>classes.dex</code> , è€Œåˆ«çš„æ–‡ä»¶ç”šè‡³è¿ 1MB éƒ½æ²¡åˆ°ï¼Œæ€»ä¸å¯èƒ½å‹ç¼©ç‡å¯ä»¥é«˜åˆ°è¿™ç§åœ°æ­¥å§</p>\n<p><img data-src=\"/360-jiagu/image-20240220232029056.png\" alt=\"image-20240220232029056\" style=\"aspect-ratio:465 / 256;\"></p>\n<p>æ‰€ä»¥æˆ‘ä»¬æ‰“å¼€ <code>classes.dex</code>  çœ‹çœ‹ï¼Œåœ¨è¿™ä¸ª <code>classes.dex</code>  çš„æœ«å°¾ï¼Œæœç„¶è—ç€ä¸€å¤§å †çš„æ•°æ®</p>\n<p><img data-src=\"/360-jiagu/image-20240220232313676.png\" alt=\"image-20240220232313676\" style=\"aspect-ratio:790 / 514;\"></p>\n<p>è€Œæœ«å°¾çš„æ•°æ®æ˜¯ç”± <code>71 68 00 01</code>  å’Œæˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„åŠ å¯†çš„ dex ä¸€æ¨¡ä¸€æ ·</p>\n<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­ç”¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL29hY2lhL3N0YWxrZXJfdHJhY2Vfc28=\"> stalker_trace_so</span> å»çœ‹çœ‹è¡¥å……ä¸Šä¸» ELF çš„å‡½æ•°åœ°å€ä»¥åŠåç§°ä¹‹åçš„å‡½æ•°è°ƒç”¨é“¾æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œé¦–å…ˆåœ¨ä¸» ELF ä¸­è¿è¡Œæ’ä»¶ <code>Edit-&gt;Plugins-&gt;stalker_trace_so</code></p>\n<p>ä¹‹ååŒæ ·çš„ï¼Œæˆ‘ä»¬éœ€è¦å°† <code>so_name</code>  æ”¹æˆ <code>libjiagu_64.so</code> , ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æŠŠå£³ ELF çš„ <code>func_addr</code>  å’Œ <code>func_name</code>  ç»™å¤åˆ¶è¿‡æ¥ï¼ŒåŒæ—¶ä½¿ç”¨ <code>concat</code>  æ–¹æ³•å°†ä¸» ELF å’Œå£³ ELF çš„å‡½æ•°åœ°å€å’Œå‡½æ•°åæ‹¼æ¥æˆä¸€ä¸ªæ–°çš„æ•°ç»„</p>\n<p><img data-src=\"/360-jiagu/image-20240221141755126.png\" alt=\"image-20240221141755126\" style=\"aspect-ratio:1201 / 264;\"></p>\n<p>ä¹‹å‰æ›¿æ¢ <code>/proc/self/maps</code>  æ¥å®ç°åˆæ­¥åè°ƒè¯•çš„ js å‡½æ•° <code>hook_proc_self_maps</code>  ä¹Ÿéœ€è¦åŒæ—¶æ‰§è¡Œ</p>\n<p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼Œ <code>KEkeELF</code>  æ ‡å¿—è¡¨ç¤ºå£³ ELF, <code>mainELF</code>  è¡¨ç¤ºä¸» ELF,(ä¸ºä»€ä¹ˆæ˜¯ <code>KEke</code> , åªæ˜¯ä¸ºäº†å¯¹é½çœ‹ç€èˆ’æœï¼š))</p>\n<p>è¦åˆ¤æ–­è°ƒç”¨çš„å‡½æ•°åœ¨å“ªä¸ª ELF é‡Œé¢ï¼Œåœ¨ <code>trace_so()</code>  é‡Œé¢ç¨ä½œä¿®æ”¹åˆ¤æ–­ä¸€ä¸‹èŒƒå›´å¯ä»¥äº†</p>\n<p><img data-src=\"/360-jiagu/image-20240221142103021.png\" alt=\"image-20240221142103021\" style=\"aspect-ratio:1414 / 490;\"></p>\n<p>æ‰“å°å‡ºæ¥çš„ç»“æœå¦‚ä¸‹</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call1<span class=\"token operator\">:</span><span class=\"token function\">JNI_OnLoad</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call2<span class=\"token operator\">:</span><span class=\"token class-name\">j_interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call3<span class=\"token operator\">:</span><span class=\"token class-name\">interpreter_wrap_int64_t</span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call4<span class=\"token operator\">:</span><span class=\"token function\">getenv</span>                    </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call5<span class=\"token operator\">:</span><span class=\"token function\">sub_13908</span>                 </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call6<span class=\"token operator\">:</span><span class=\"token function\">inotify_add_watch</span>         </pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call7<span class=\"token operator\">:</span><span class=\"token function\">sub_11220</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call8<span class=\"token operator\">:</span><span class=\"token function\">fopen</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call9<span class=\"token operator\">:</span><span class=\"token function\">sub_9DD8</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call10<span class=\"token operator\">:</span><span class=\"token function\">sub_E3E0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call11<span class=\"token operator\">:</span><span class=\"token function\">strtol</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call12<span class=\"token operator\">:</span><span class=\"token function\">feof</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call13<span class=\"token operator\">:</span><span class=\"token function\">raise</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call14<span class=\"token operator\">:</span><span class=\"token function\">memset</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call15<span class=\"token operator\">:</span><span class=\"token function\">sub_C918</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call16<span class=\"token operator\">:</span><span class=\"token function\">sub_9988</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call17<span class=\"token operator\">:</span><span class=\"token function\">sub_9964</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call18<span class=\"token operator\">:</span><span class=\"token function\">sub_9AC4</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call19<span class=\"token operator\">:</span><span class=\"token function\">j_ffi_prep_cif</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call20<span class=\"token operator\">:</span><span class=\"token function\">ffi_prep_cif</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call21<span class=\"token operator\">:</span><span class=\"token function\">j_ffi_prep_cif_machdep</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call22<span class=\"token operator\">:</span><span class=\"token function\">ffi_prep_cif_machdep</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call23<span class=\"token operator\">:</span><span class=\"token function\">j_ffi_call</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call24<span class=\"token operator\">:</span><span class=\"token function\">ffi_call</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call25<span class=\"token operator\">:</span><span class=\"token function\">sub_1674C</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call26<span class=\"token operator\">:</span><span class=\"token function\">j_ffi_call_SYSV</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call27<span class=\"token operator\">:</span><span class=\"token function\">ffi_call_SYSV</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call28<span class=\"token operator\">:</span><span class=\"token function\">sub_167BC</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call29<span class=\"token operator\">:</span><span class=\"token function\">sub_1647C</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call30<span class=\"token operator\">:</span><span class=\"token function\">sub_163DC</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call31<span class=\"token operator\">:</span><span class=\"token function\">sub_9900</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call32<span class=\"token operator\">:</span><span class=\"token function\">sub_94BC</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call33<span class=\"token operator\">:</span><span class=\"token function\">inotify_init</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call34<span class=\"token operator\">:</span><span class=\"token function\">fmod</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call35<span class=\"token operator\">:</span><span class=\"token function\">strncpy</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call36<span class=\"token operator\">:</span><span class=\"token function\">_Z9__arm_a_1P7_JavaVMP7_JNIEnvPvRi</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call37<span class=\"token operator\">:</span><span class=\"token function\">sub_9E58</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call38<span class=\"token operator\">:</span><span class=\"token function\">sub_999C</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call39<span class=\"token operator\">:</span><span class=\"token function\">sub_10964</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call40<span class=\"token operator\">:</span><span class=\"token function\">j_lseek_1</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call41<span class=\"token operator\">:</span><span class=\"token function\">lseek</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call42<span class=\"token operator\">:</span><span class=\"token function\">sub_96E0</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call43<span class=\"token operator\">:</span><span class=\"token function\">sub_8000</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call44<span class=\"token operator\">:</span><span class=\"token function\">dlopen</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call45<span class=\"token operator\">:</span><span class=\"token function\">sub_60E0</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call46<span class=\"token operator\">:</span><span class=\"token function\">sub_6544</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call47<span class=\"token operator\">:</span><span class=\"token function\">sub_4B54</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call48<span class=\"token operator\">:</span><span class=\"token function\">sub_6128</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call49<span class=\"token operator\">:</span><span class=\"token function\">_ZN9__arm_c_19__arm_c_0Ev</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call50<span class=\"token operator\">:</span><span class=\"token function\">sub_A3EC</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call51<span class=\"token operator\">:</span><span class=\"token function\">sub_99CC</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call52<span class=\"token operator\">:</span><span class=\"token function\">sub_9944</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call53<span class=\"token operator\">:</span><span class=\"token function\">sub_6484</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call54<span class=\"token operator\">:</span><span class=\"token function\">sub_6590</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call55<span class=\"token operator\">:</span><span class=\"token function\">prctl</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call56<span class=\"token operator\">:</span><span class=\"token function\">sub_6698</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call57<span class=\"token operator\">:</span><span class=\"token function\">sub_9FFC</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call58<span class=\"token operator\">:</span><span class=\"token function\">j_lseek_3</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call59<span class=\"token operator\">:</span><span class=\"token function\">j_lseek_2</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call60<span class=\"token operator\">:</span><span class=\"token function\">j_lseek_0</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call61<span class=\"token operator\">:</span><span class=\"token function\">sub_9A90</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call62<span class=\"token operator\">:</span><span class=\"token function\">sub_5F20</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call63<span class=\"token operator\">:</span><span class=\"token function\">sub_6044</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call64<span class=\"token operator\">:</span><span class=\"token function\">sub_3574</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call65<span class=\"token operator\">:</span><span class=\"token function\">uncompress</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call66<span class=\"token operator\">:</span><span class=\"token function\">sub_49F0</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call67<span class=\"token operator\">:</span><span class=\"token function\">sub_5400</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call68<span class=\"token operator\">:</span><span class=\"token function\">sub_5478</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call69<span class=\"token operator\">:</span><span class=\"token function\">sub_5B08</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call70<span class=\"token operator\">:</span><span class=\"token function\">sub_5650</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call71<span class=\"token operator\">:</span><span class=\"token function\">sub_580C</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call72<span class=\"token operator\">:</span><span class=\"token function\">open</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call73<span class=\"token operator\">:</span><span class=\"token function\">atoi</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call74<span class=\"token operator\">:</span><span class=\"token function\">sub_3C94</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call75<span class=\"token operator\">:</span><span class=\"token function\">strncmp</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call76<span class=\"token operator\">:</span><span class=\"token function\">sub_4918</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call77<span class=\"token operator\">:</span><span class=\"token function\">sub_4000</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call78<span class=\"token operator\">:</span><span class=\"token function\">sub_41B4</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call79<span class=\"token operator\">:</span><span class=\"token function\">sub_35AC</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call80<span class=\"token operator\">:</span><span class=\"token function\">sigaction</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call81<span class=\"token operator\">:</span><span class=\"token function\">sub_5E6C</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call82<span class=\"token operator\">:</span><span class=\"token function\">sub_5444</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call83<span class=\"token operator\">:</span><span class=\"token function\">sub_11603C</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call84<span class=\"token operator\">:</span><span class=\"token function\">j__Znwm</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call85<span class=\"token operator\">:</span><span class=\"token function\">_Znwm</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call86<span class=\"token operator\">:</span><span class=\"token function\">malloc</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call87<span class=\"token operator\">:</span><span class=\"token function\">__cxa_atexit</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call88<span class=\"token operator\">:</span><span class=\"token function\">sub_1160B4</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call89<span class=\"token operator\">:</span><span class=\"token function\">sub_1160C4</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call90<span class=\"token operator\">:</span><span class=\"token function\">strlen</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call91<span class=\"token operator\">:</span><span class=\"token function\">memcpy</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call92<span class=\"token operator\">:</span><span class=\"token function\">sub_1161FC</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call93<span class=\"token operator\">:</span><span class=\"token function\">sub_1164AC</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call94<span class=\"token operator\">:</span><span class=\"token function\">sub_1164D8</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call95<span class=\"token operator\">:</span><span class=\"token function\">sub_116528</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call96<span class=\"token operator\">:</span><span class=\"token function\">sub_1165C8</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call97<span class=\"token operator\">:</span><span class=\"token function\">sub_1A32C0</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call98<span class=\"token operator\">:</span><span class=\"token function\">sub_1A3150</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call99<span class=\"token operator\">:</span><span class=\"token function\">sub_1A3204</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call100<span class=\"token operator\">:</span><span class=\"token function\">sub_1166FC</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call101<span class=\"token operator\">:</span><span class=\"token function\">sub_116728</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call102<span class=\"token operator\">:</span><span class=\"token function\">sub_116750</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call103<span class=\"token operator\">:</span><span class=\"token function\">sub_116830</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call104<span class=\"token operator\">:</span><span class=\"token function\">sub_116BA0</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call105<span class=\"token operator\">:</span><span class=\"token function\">sub_633C</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call106<span class=\"token operator\">:</span><span class=\"token function\">sub_8130</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call107<span class=\"token operator\">:</span><span class=\"token function\">sub_4C70</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call108<span class=\"token operator\">:</span><span class=\"token function\">sub_825C</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call109<span class=\"token operator\">:</span><span class=\"token function\">sub_8B50</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call110<span class=\"token operator\">:</span><span class=\"token function\">sub_8ED4</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call111<span class=\"token operator\">:</span><span class=\"token function\">sub_8430</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call112<span class=\"token operator\">:</span><span class=\"token function\">JNI_OnLoad</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call113<span class=\"token operator\">:</span><span class=\"token class-name\">j_interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call114<span class=\"token operator\">:</span><span class=\"token class-name\">interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call115<span class=\"token operator\">:</span><span class=\"token function\">interpreter_wrap_int64_t_bridge</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call116<span class=\"token operator\">:</span><span class=\"token function\">sub_9D60</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call117<span class=\"token operator\">:</span><span class=\"token function\">sub_1B3F0C</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call118<span class=\"token operator\">:</span><span class=\"token function\">gettimeofday</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call119<span class=\"token operator\">:</span><span class=\"token function\">sub_11BD9C</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call120<span class=\"token operator\">:</span><span class=\"token function\">sub_1182D8</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call121<span class=\"token operator\">:</span><span class=\"token function\">sub_123970</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call122<span class=\"token operator\">:</span><span class=\"token function\">sub_1B6448</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call123<span class=\"token operator\">:</span><span class=\"token function\">getenv</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call124<span class=\"token operator\">:</span><span class=\"token function\">sub_11F130</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call125<span class=\"token operator\">:</span><span class=\"token function\">sub_12047C</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call126<span class=\"token operator\">:</span><span class=\"token function\">j__ZdlPv</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call127<span class=\"token operator\">:</span><span class=\"token function\">_ZdlPv</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call128<span class=\"token operator\">:</span><span class=\"token function\">free</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call129<span class=\"token operator\">:</span><span class=\"token function\">sub_1427E8</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call130<span class=\"token operator\">:</span><span class=\"token function\">dlopen</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call131<span class=\"token operator\">:</span><span class=\"token function\">sub_11BDA8</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call132<span class=\"token operator\">:</span><span class=\"token function\">sub_11BE58</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call133<span class=\"token operator\">:</span><span class=\"token function\">sub_11F69C</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call134<span class=\"token operator\">:</span><span class=\"token function\">sub_117BE0</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call135<span class=\"token operator\">:</span><span class=\"token function\">sub_117CA0</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call136<span class=\"token operator\">:</span><span class=\"token function\">fopen</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call137<span class=\"token operator\">:</span><span class=\"token function\">sub_117E90</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call138<span class=\"token operator\">:</span><span class=\"token function\">sub_14285C</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call139<span class=\"token operator\">:</span><span class=\"token function\">sub_1429CC</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call140<span class=\"token operator\">:</span><span class=\"token function\">sub_11C1AC</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call141<span class=\"token operator\">:</span><span class=\"token function\">sub_11C1B4</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call142<span class=\"token operator\">:</span><span class=\"token function\">sub_11C210</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call143<span class=\"token operator\">:</span><span class=\"token function\">sub_166C4</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call144<span class=\"token operator\">:</span><span class=\"token function\">memcpy</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call145<span class=\"token operator\">:</span><span class=\"token function\">sub_123324</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call146<span class=\"token operator\">:</span><span class=\"token function\">sub_1205A0</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call147<span class=\"token operator\">:</span><span class=\"token function\">sub_11F768</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call148<span class=\"token operator\">:</span><span class=\"token function\">memcmp</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call149<span class=\"token operator\">:</span><span class=\"token function\">opendir</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call150<span class=\"token operator\">:</span><span class=\"token function\">closedir</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call151<span class=\"token operator\">:</span><span class=\"token function\">sub_11859C</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call152<span class=\"token operator\">:</span><span class=\"token function\">sub_11C268</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call153<span class=\"token operator\">:</span><span class=\"token function\">sub_11C300</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call154<span class=\"token operator\">:</span><span class=\"token function\">sub_117B68</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call155<span class=\"token operator\">:</span><span class=\"token function\">sub_1186B8</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call156<span class=\"token operator\">:</span><span class=\"token function\">sub_143964</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call157<span class=\"token operator\">:</span><span class=\"token function\">sub_1B66A8</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call158<span class=\"token operator\">:</span><span class=\"token function\">pthread_mutex_lock</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call159<span class=\"token operator\">:</span><span class=\"token function\">sub_142EA0</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call160<span class=\"token operator\">:</span><span class=\"token function\">sub_143A38</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call161<span class=\"token operator\">:</span><span class=\"token function\">sub_11CF8C</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call162<span class=\"token operator\">:</span><span class=\"token function\">sub_131D58</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call163<span class=\"token operator\">:</span><span class=\"token function\">sub_1B66D0</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call164<span class=\"token operator\">:</span><span class=\"token function\">pthread_mutex_unlock</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call165<span class=\"token operator\">:</span><span class=\"token function\">sub_1178E8</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call166<span class=\"token operator\">:</span><span class=\"token function\">sub_13D70C</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call167<span class=\"token operator\">:</span><span class=\"token function\">sub_19F984</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call168<span class=\"token operator\">:</span><span class=\"token function\">sub_11F1C8</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call169<span class=\"token operator\">:</span><span class=\"token function\">atoi</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call170<span class=\"token operator\">:</span><span class=\"token function\">sub_12D2F8</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call171<span class=\"token operator\">:</span><span class=\"token function\">sub_17ABE8</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call172<span class=\"token operator\">:</span><span class=\"token function\">sub_172660</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call173<span class=\"token operator\">:</span><span class=\"token function\">sub_13BFF0</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call174<span class=\"token operator\">:</span><span class=\"token function\">sub_172AA4</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call175<span class=\"token operator\">:</span><span class=\"token function\">sub_13BD80</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call176<span class=\"token operator\">:</span><span class=\"token function\">sub_13BE2C</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call177<span class=\"token operator\">:</span><span class=\"token function\">sub_13BE4C</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call178<span class=\"token operator\">:</span><span class=\"token function\">memmove</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call179<span class=\"token operator\">:</span><span class=\"token function\">sub_13BE64</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call180<span class=\"token operator\">:</span><span class=\"token function\">sub_172D78</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call181<span class=\"token operator\">:</span><span class=\"token function\">sub_13E510</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call182<span class=\"token operator\">:</span><span class=\"token function\">sub_1926F0</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call183<span class=\"token operator\">:</span><span class=\"token function\">sub_13DB7C</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call184<span class=\"token operator\">:</span><span class=\"token function\">sub_1B7A08</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call185<span class=\"token operator\">:</span><span class=\"token function\">sub_1B7ABC</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call186<span class=\"token operator\">:</span><span class=\"token function\">pthread_cond_broadcast</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call187<span class=\"token operator\">:</span><span class=\"token function\">sub_12FA34</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call188<span class=\"token operator\">:</span><span class=\"token function\">sub_120664</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call189<span class=\"token operator\">:</span><span class=\"token function\">sub_1332B8</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call190<span class=\"token operator\">:</span><span class=\"token function\">sub_13E0F8</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call191<span class=\"token operator\">:</span><span class=\"token function\">sub_12743C</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call192<span class=\"token operator\">:</span><span class=\"token function\">sub_124C68</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call193<span class=\"token operator\">:</span><span class=\"token function\">sub_125DC4</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call194<span class=\"token operator\">:</span><span class=\"token function\">sub_124510</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call195<span class=\"token operator\">:</span><span class=\"token function\">sub_126888</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call196<span class=\"token operator\">:</span><span class=\"token function\">strdup</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call197<span class=\"token operator\">:</span><span class=\"token function\">sub_126920</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call198<span class=\"token operator\">:</span><span class=\"token function\">sub_122180</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call199<span class=\"token operator\">:</span><span class=\"token function\">sub_11BC1C</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call200<span class=\"token operator\">:</span><span class=\"token function\">sub_13DF34</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call201<span class=\"token operator\">:</span><span class=\"token function\">getpid</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call202<span class=\"token operator\">:</span><span class=\"token function\">memset</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call203<span class=\"token operator\">:</span><span class=\"token function\">snprintf</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call204<span class=\"token operator\">:</span><span class=\"token function\">sub_124FA0</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call205<span class=\"token operator\">:</span><span class=\"token function\">sub_1B6498</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call206<span class=\"token operator\">:</span><span class=\"token function\">sub_1A0C88</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call207<span class=\"token operator\">:</span><span class=\"token function\">sub_217444</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call208<span class=\"token operator\">:</span><span class=\"token function\">sub_2175E0</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call209<span class=\"token operator\">:</span><span class=\"token function\">read</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call210<span class=\"token operator\">:</span><span class=\"token function\">strncmp</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call211<span class=\"token operator\">:</span><span class=\"token function\">close</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call212<span class=\"token operator\">:</span><span class=\"token function\">sub_1B578C</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call213<span class=\"token operator\">:</span><span class=\"token function\">j___self_lseek</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call214<span class=\"token operator\">:</span><span class=\"token function\">__self_lseek</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call215<span class=\"token operator\">:</span><span class=\"token function\">sub_1B586C</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call216<span class=\"token operator\">:</span><span class=\"token function\">j_j___read_self</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call217<span class=\"token operator\">:</span><span class=\"token function\">j___read_self</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call218<span class=\"token operator\">:</span><span class=\"token function\">__read_self</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call219<span class=\"token operator\">:</span><span class=\"token function\">sub_1B6528</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call220<span class=\"token operator\">:</span><span class=\"token function\">sub_1B6578</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call221<span class=\"token operator\">:</span><span class=\"token function\">mmap</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call222<span class=\"token operator\">:</span><span class=\"token function\">sub_1B5B50</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call223<span class=\"token operator\">:</span><span class=\"token function\">calloc</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call224<span class=\"token operator\">:</span><span class=\"token function\">memchr</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call225<span class=\"token operator\">:</span><span class=\"token function\">sub_1B5D04</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call226<span class=\"token operator\">:</span><span class=\"token function\">sub_1B5EC4</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call227<span class=\"token operator\">:</span><span class=\"token function\">sub_1B6270</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call228<span class=\"token operator\">:</span><span class=\"token function\">sub_1B6180</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call229<span class=\"token operator\">:</span><span class=\"token function\">sub_1B6678</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call230<span class=\"token operator\">:</span><span class=\"token function\">inflateInit2_</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call231<span class=\"token operator\">:</span><span class=\"token function\">inflate</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call232<span class=\"token operator\">:</span><span class=\"token function\">inflateEnd</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call233<span class=\"token operator\">:</span><span class=\"token function\">sub_1B6540</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call234<span class=\"token operator\">:</span><span class=\"token function\">munmap</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call235<span class=\"token operator\">:</span><span class=\"token function\">sub_1B56F8</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call236<span class=\"token operator\">:</span><span class=\"token function\">sub_19BC9C</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call237<span class=\"token operator\">:</span><span class=\"token function\">sub_19CCD4</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call238<span class=\"token operator\">:</span><span class=\"token function\">sub_12D470</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call239<span class=\"token operator\">:</span><span class=\"token function\">sub_142FE0</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call240<span class=\"token operator\">:</span><span class=\"token function\">sub_143008</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call241<span class=\"token operator\">:</span><span class=\"token function\">sub_142ABC</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call242<span class=\"token operator\">:</span><span class=\"token function\">sub_143848</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call243<span class=\"token operator\">:</span><span class=\"token function\">sub_143B48</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call244<span class=\"token operator\">:</span><span class=\"token function\">sub_143088</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call245<span class=\"token operator\">:</span><span class=\"token function\">sub_1222D0</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call246<span class=\"token operator\">:</span><span class=\"token function\">sub_14316C</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call247<span class=\"token operator\">:</span><span class=\"token function\">sub_142954</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call248<span class=\"token operator\">:</span><span class=\"token function\">_Z9__arm_a_2PcmS_Rii</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call249<span class=\"token operator\">:</span><span class=\"token function\">sub_142894</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call250<span class=\"token operator\">:</span><span class=\"token function\">sub_1428BC</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call251<span class=\"token operator\">:</span><span class=\"token function\">sub_127DCC</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call252<span class=\"token operator\">:</span><span class=\"token function\">sub_14292C</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call253<span class=\"token operator\">:</span><span class=\"token function\">sub_121B78</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call254<span class=\"token operator\">:</span><span class=\"token function\">sub_121BE0</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call255<span class=\"token operator\">:</span><span class=\"token function\">sub_123CE8</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call256<span class=\"token operator\">:</span><span class=\"token function\">sub_123BC0</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call257<span class=\"token operator\">:</span><span class=\"token function\">sub_11959C</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call258<span class=\"token operator\">:</span><span class=\"token function\">sub_1AC170</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call259<span class=\"token operator\">:</span><span class=\"token function\">pthread_create</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call260<span class=\"token operator\">:</span><span class=\"token function\">sub_1AC210</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call261<span class=\"token operator\">:</span><span class=\"token function\">sub_1B5DE4</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call262<span class=\"token operator\">:</span><span class=\"token function\">sub_1B60E8</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call263<span class=\"token operator\">:</span><span class=\"token function\">sub_19F7C4</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call264<span class=\"token operator\">:</span><span class=\"token function\">sub_1B2DC8</span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call265<span class=\"token operator\">:</span><span class=\"token function\">sub_1B1CE8</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call266<span class=\"token operator\">:</span><span class=\"token function\">sub_1B0974</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call267<span class=\"token operator\">:</span><span class=\"token function\">sub_1AFE6C</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call268<span class=\"token operator\">:</span><span class=\"token function\">sub_126ED8</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call269<span class=\"token operator\">:</span><span class=\"token function\">sub_1AFE8C</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call270<span class=\"token operator\">:</span><span class=\"token function\">sub_1AFE90</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call271<span class=\"token operator\">:</span><span class=\"token function\">sub_1AB87C</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call272<span class=\"token operator\">:</span><span class=\"token function\">sub_1B26D4</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call273<span class=\"token operator\">:</span><span class=\"token function\">sub_1B26F4</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call274<span class=\"token operator\">:</span><span class=\"token function\">sub_1B27C8</span></pre></td></tr><tr><td data-num=\"275\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call275<span class=\"token operator\">:</span><span class=\"token function\">j_ffi_prep_cif_var</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call276<span class=\"token operator\">:</span><span class=\"token function\">ffi_prep_cif_var</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call277<span class=\"token operator\">:</span><span class=\"token function\">sub_1AAF48</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call278<span class=\"token operator\">:</span><span class=\"token function\">sub_1AAF54</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call279<span class=\"token operator\">:</span><span class=\"token function\">sub_2162D4</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call280<span class=\"token operator\">:</span><span class=\"token function\">sub_1B2898</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call281<span class=\"token operator\">:</span><span class=\"token function\">sub_1B2918</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call282<span class=\"token operator\">:</span><span class=\"token function\">sub_1ABE90</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call283<span class=\"token operator\">:</span><span class=\"token function\">sub_13E0EC</span></pre></td></tr><tr><td data-num=\"284\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call284<span class=\"token operator\">:</span><span class=\"token function\">sub_124900</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call285<span class=\"token operator\">:</span><span class=\"token function\">sub_1A0C34</span></pre></td></tr><tr><td data-num=\"286\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call286<span class=\"token operator\">:</span><span class=\"token function\">sub_217188</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call287<span class=\"token operator\">:</span><span class=\"token function\">j_strcmp</span></pre></td></tr><tr><td data-num=\"288\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call288<span class=\"token operator\">:</span><span class=\"token function\">strcmp</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call289<span class=\"token operator\">:</span><span class=\"token function\">sub_194514</span></pre></td></tr><tr><td data-num=\"290\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call290<span class=\"token operator\">:</span><span class=\"token function\">sub_1A2380</span></pre></td></tr><tr><td data-num=\"291\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call291<span class=\"token operator\">:</span><span class=\"token function\">sub_1A23CC</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call292<span class=\"token operator\">:</span><span class=\"token function\">sub_1A2718</span></pre></td></tr><tr><td data-num=\"293\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call293<span class=\"token operator\">:</span><span class=\"token function\">sub_1A2A94</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call294<span class=\"token operator\">:</span><span class=\"token function\">sub_1A25E0</span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call295<span class=\"token operator\">:</span>sub_1A2984</pre></td></tr></table></figure><p>åˆ†æè¾“å‡ºçš„ç»“æœï¼Œæˆ‘ä»¬å‘ç°äº†ä¸‰ä¸ªæœ‰è¶£çš„å‡½æ•° <code>inflateInit2_</code> , <code>inflate</code> , <code>inflateEnd</code> , è¿™ä¸æ˜¯ zlib ç”¨æ¥è§£å‹ç¼©çš„å‡½æ•°å˜›ï½</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call230<span class=\"token operator\">:</span><span class=\"token function\">inflateInit2_</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call231<span class=\"token operator\">:</span><span class=\"token function\">inflate</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call232<span class=\"token operator\">:</span>inflateEnd</pre></td></tr></table></figure><p>å¯¹ <code>inflateInit2_</code> äº¤å‰å¼•ç”¨ï¼Œå‘ç°æœ‰ä¸¤ä¸ªå‡½æ•°è°ƒç”¨äº†å®ƒ</p>\n<p><img data-src=\"/360-jiagu/image-20240221160528463.png\" alt=\"image-20240221160528463\" style=\"aspect-ratio:879 / 220;\"></p>\n<p>é‚£ä¹ˆè¦æ€ä¹ˆçŸ¥é“æ˜¯å“ªä¸€ä¸ªå‡½æ•°å…ˆè°ƒç”¨çš„ <code>inflateInit2_</code> å‘¢ï¼Ÿå‘ä¸Šçœ‹çœ‹å‡½æ•°è°ƒç”¨é“¾å°±è¡Œäº†</p>\n<p>äºæ˜¯æˆ‘ä»¬å‘ç°æ˜¯ <code>sub_1B6270</code>  è°ƒç”¨äº† <code>inflateInit2_</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call227<span class=\"token operator\">:</span>sub_1B6270 <span class=\"token operator\">&lt;</span><span class=\"token operator\">--</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call228<span class=\"token operator\">:</span><span class=\"token function\">sub_1B6180</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call229<span class=\"token operator\">:</span><span class=\"token function\">sub_1B6678</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call230<span class=\"token operator\">:</span><span class=\"token function\">inflateInit2_</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call231<span class=\"token operator\">:</span><span class=\"token function\">inflate</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call232<span class=\"token operator\">:</span>inflateEnd</pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥åˆ° <code>sub_1B6270</code> , å…ˆåˆ°<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL21hZGxlci96bGli\"> https://github.com/madler/zlib</span> æŠŠ <code>zlib.h</code>  ä¸­çš„ <code>z_stream_s</code> , å¯¼å…¥çš„æ–¹æ³•å’Œä¹‹å‰ä¸€æ ·</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span>  <span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">z_const</span> <span class=\"token expression\"><span class=\"token keyword\">const</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span>  Byte<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* 8 bits */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span>   uInt<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* 16 bits or more */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span>  uLong<span class=\"token punctuation\">;</span> <span class=\"token comment\">/* 32 bits or more */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">z_stream_s</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    z_const Bytef <span class=\"token operator\">*</span>next_in<span class=\"token punctuation\">;</span>     <span class=\"token comment\">/* next input byte */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    uInt     avail_in<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* number of bytes available at next_in */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    uLong    total_in<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* total number of input bytes read so far */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    Bytef    <span class=\"token operator\">*</span>next_out<span class=\"token punctuation\">;</span> <span class=\"token comment\">/* next output byte will go here */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    uInt     avail_out<span class=\"token punctuation\">;</span> <span class=\"token comment\">/* remaining free space at next_out */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    uLong    total_out<span class=\"token punctuation\">;</span> <span class=\"token comment\">/* total number of bytes output so far */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span> z_stream<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>é‡å®šä¹‰ <code>s</code>  çš„ç±»å‹ä¸º <code>z_stream</code> , è¿™å››ä¸ªå­—æ®µçš„å«ä¹‰å¦‚ä¸‹</p>\n<ul>\n<li><code>s.next_in</code> : å‹ç¼©æ•°æ®</li>\n<li><code>s.avail_in</code> : å‹ç¼©æ•°æ®çš„é•¿åº¦</li>\n<li><code>s.next_out</code> : è§£å‹åçš„æ•°æ®</li>\n<li><code>s.avail_out</code> : è§£å‹åæ•°æ®çš„é•¿åº¦</li>\n</ul>\n<p><img data-src=\"/360-jiagu/image-20240221162607623.png\" alt=\"image-20240221162607623\" style=\"aspect-ratio:542 / 368;\"></p>\n<p>å„ä¸ªæˆå‘˜çš„åç§»å¦‚å›¾æ‰€ç¤º</p>\n<p><img data-src=\"/360-jiagu/image-20240221162856663.png\" alt=\"image-20240221162856663\" style=\"aspect-ratio:328 / 195;\"></p>\n<p>éšåæˆ‘ä»¬ç”¨ frida å» hook ä¸€ä¸‹ <code>inflate</code>  å‡½æ•°çœ‹çœ‹è§£å‹ç¼©ä¹‹åçš„æ•°æ®æ˜¯ä»€ä¹ˆ</p>\n<p>è¿™é‡Œæœ‰ä¸ªæŠ€å·§ï¼Œå°±æ˜¯å¦‚ä½•å¯ä»¥ hook åˆ°ä¸» ELF ä¸­çš„å‡½æ•°ï¼Œå› ä¸ºåœ¨å£³ ELF åŠ è½½è¿›å†…å­˜æ—¶ï¼Œä¸» ELF è¿˜æ²¡æœ‰è¢«åŠ è½½ï¼Œæ‰€ä»¥å‡å¦‚åœ¨å£³ ELF é€šè¿‡ <code>android_dlopen_ext</code>  æ‰“å¼€æ—¶æˆ‘ä»¬è¿›è¡Œ hook, æ˜¯ä¼š hook å¤±è´¥çš„</p>\n<p>é‚£ä¹ˆå¦‚ä½•æ‰èƒ½è·å–åˆ°ä¸» ELF çš„ hook æ—¶æœºå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»Ÿè®¡å¤–éƒ¨å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°æ¥åˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½äº†ä¸» ELF, ä¾‹å¦‚æˆ‘è¿™é‡Œï¼Œæˆ‘é€šè¿‡ <code>zlib_count</code>  ç»Ÿè®¡å¤–éƒ¨å‡½æ•° <code>inflate</code>  è°ƒç”¨æ¬¡æ•°ï¼Œå› ä¸ºåœ¨å£³ ELF ä¼šä½¿ç”¨ <code>uncompress</code>  è°ƒç”¨ä¸€æ¬¡ <code>inflate</code> , æ‰€ä»¥å½“ç¬¬äºŒæ¬¡è°ƒç”¨ <code>inflate</code> , æˆ‘ä»¬å°±çŸ¥é“è¿™è‚¯å®šæ˜¯ä¸» ELF è°ƒç”¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªä½ç½®æ”¾å¿ƒå¤§èƒ†çš„ hook äº†</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">dump_memory</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">start<span class=\"token punctuation\">,</span>size<span class=\"token punctuation\">,</span>filename</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> file_path <span class=\"token operator\">=</span> <span class=\"token string\">\"/data/data/com.oacia.apk_protect/\"</span> <span class=\"token operator\">+</span> filename<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">var</span> file_handle <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span>file_path<span class=\"token punctuation\">,</span> <span class=\"token string\">\"wb\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>file_handle <span class=\"token operator\">&amp;&amp;</span> file_handle <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">var</span> libso_buffer <span class=\"token operator\">=</span> start<span class=\"token punctuation\">.</span><span class=\"token function\">readByteArray</span><span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">.</span><span class=\"token function\">toUInt32</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        file_handle<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>libso_buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        file_handle<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        file_handle<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[dump]:\"</span><span class=\"token punctuation\">,</span> file_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_zlib_result</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x1B63F0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token comment\">// fd, buff, len</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"inflate result\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">hexdump</span><span class=\"token punctuation\">(</span>next_in<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              <span class=\"token literal-property property\">offset</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// ç›¸å¯¹åç§»</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>              <span class=\"token literal-property property\">length</span><span class=\"token operator\">:</span> <span class=\"token number\">0x50</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//dump çš„å¤§å°</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>              <span class=\"token literal-property property\">header</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>              <span class=\"token literal-property property\">ansi</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">hexdump</span><span class=\"token punctuation\">(</span>next_out<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>              <span class=\"token literal-property property\">offset</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// ç›¸å¯¹åç§»</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              <span class=\"token literal-property property\">length</span><span class=\"token operator\">:</span> <span class=\"token number\">0x50</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//dump çš„å¤§å°</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              <span class=\"token literal-property property\">header</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              <span class=\"token literal-property property\">ansi</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token function\">dump_memory</span><span class=\"token punctuation\">(</span>next_out<span class=\"token punctuation\">,</span>avail_out<span class=\"token punctuation\">,</span><span class=\"token string\">\"dex001\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">var</span> zlib_count<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token keyword\">var</span> next_in<span class=\"token punctuation\">,</span>avail_in<span class=\"token punctuation\">,</span>next_out<span class=\"token punctuation\">,</span>avail_out<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_zlib</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>Module<span class=\"token punctuation\">.</span><span class=\"token function\">findExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"inflate\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token comment\">// fd, buff, len</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            zlib_count<span class=\"token operator\">+=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>zlib_count<span class=\"token operator\">></span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token function\">hook_zlib_result</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            next_in<span class=\"token operator\">=</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readS64</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            avail_in<span class=\"token operator\">=</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readS64</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            next_out<span class=\"token operator\">=</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x18</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readS64</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            avail_out<span class=\"token operator\">=</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x20</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readS64</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">hexdump</span><span class=\"token punctuation\">(</span>next_in<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>              <span class=\"token literal-property property\">offset</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// ç›¸å¯¹åç§»</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>              <span class=\"token literal-property property\">length</span><span class=\"token operator\">:</span> <span class=\"token number\">0x50</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//dump çš„å¤§å°</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>              <span class=\"token literal-property property\">header</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>              <span class=\"token literal-property property\">ansi</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è§£å‹ç¼©ä¹‹åçš„è¾“å‡ºå¦‚ä¸‹ï¼Œåœ¨è¾“å‡ºçš„æ–‡ä»¶å¤´ï¼Œæˆ‘ä»¬å‘ç°äº† <code>dex035</code> , æ‰€ä»¥æˆ‘ä»¬æŠŠè¿™å—å†…å­˜ dump ä¸‹æ¥çœ‹çœ‹ï¼Œä½¿ç”¨ä¸Šæ–¹çš„ <code>dump_memory(start,size,filename)</code>  å‡½æ•°å³å¯</p>\n<p><img data-src=\"/360-jiagu/image-20240221170453897.png\" alt=\"image-20240221170453897\" style=\"aspect-ratio:1182 / 361;\"></p>\n<p>æŠŠè¿™ä¸ªè§£å‹ç¼©ä¹‹åçš„ dex æ‹–å…¥åˆ° jadx é‡Œé¢ï¼Œå´å‘ç°è¿™ä¸ªç±»åæ€ä¹ˆå’Œå£³ DEX çš„ç±»åä¸€æ¨¡ä¸€æ ·ï¼Œé€šè¿‡æ ¡éªŒå“ˆå¸Œå‘ç° dump ä¸‹æ¥çš„ dex å’Œå£³ dex å…¶å®æ˜¯åŒä¸€ä¸ªæ–‡ä»¶</p>\n<p><img data-src=\"/360-jiagu/image-20240221170627481.png\" alt=\"image-20240221170627481\" style=\"aspect-ratio:386 / 224;\"></p>\n<p>æˆ‘ä»¬åœ¨ä¹‹å‰çš„åˆ†æä¸­çŸ¥é“å£³ dex çš„æœ«å°¾é™„å¸¦äº†ä¸€å¤§ä¸²çš„åŠ å¯†æ•°æ®ï¼Œæ‰€ä»¥é€šè¿‡å°†è¿™ä¸ªè§£å‹ç¼©å¾—åˆ°äº†è¿™ä¸ª dex, å°±è¯´æ˜é©¬ä¸Šè¦è¿›è¡ŒåŠ å¯†ä¸» DEX çš„è§£å¯†æ“ä½œäº†</p>\n<p>è§£å‹ç¼©çš„å‡½æ•°æ˜¯ <code>sub_1B6270</code> , æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­é€šè¿‡ <code>stalker_trace_so</code>  æ‰“å°å‡ºæ¥çš„å†…å®¹ï¼Œå¹¶åˆ©ç”¨äº¤å‰å¼•ç”¨æ¥è¿½è¸ªè¯¥å‡½æ•°çš„è°ƒç”¨é“¾</p>\n<p>å°±æ¯”å¦‚è¯´å¯¹äºå‡½æ•° <code>sub_1B6270</code> , å®ƒæœ‰ä¸¤ä¸ªäº¤å‰å¼•ç”¨</p>\n<p><img data-src=\"/360-jiagu/image-20240221172325310.png\" alt=\"image-20240221172325310\" style=\"aspect-ratio:879 / 220;\"></p>\n<p>é€šè¿‡ <code>stalker_trace_so</code>  æ‰“å°å‡ºæ¥çš„å‡½æ•°è°ƒç”¨é“¾ï¼Œæˆ‘ä»¬å‘ç°æ˜¯ <code>sub_1A0C88</code>  åœ¨ <code>sub_1B6270</code>  ä¹‹å‰è°ƒç”¨ï¼Œæ‰€ä»¥å‡½æ•°çš„è°ƒç”¨å…³ç³»å°±æ˜¯ <code>sub_1A0C88-&gt;sub_1B6270</code> , ä»¥æ­¤ç±»æ¨</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call206<span class=\"token operator\">:</span><span class=\"token function\">sub_1A0C88</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call227<span class=\"token operator\">:</span>sub_1B6270</pre></td></tr></table></figure><p>æ‰€ä»¥ä¸€è·¯è·Ÿè¿‡æ¥ä¹‹åï¼Œå‡½æ•°çš„è°ƒç”¨é“¾ä¸º <code>sub_1332B8-&gt;sub_124FA0-&gt;sub_1A0C88-&gt;sub_1B6270-&gt;inflate</code> , <code>sub_1332B8</code>  å‡½æ•°ä¹‹åå°±æ²¡æœ‰äº¤å‰å¼•ç”¨äº†</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call189<span class=\"token operator\">:</span><span class=\"token function\">sub_1332B8</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call204<span class=\"token operator\">:</span><span class=\"token function\">sub_124FA0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call206<span class=\"token operator\">:</span><span class=\"token function\">sub_1A0C88</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call227<span class=\"token operator\">:</span><span class=\"token function\">sub_1B6270</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call230<span class=\"token operator\">:</span><span class=\"token function\">inflateInit2_</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call231<span class=\"token operator\">:</span><span class=\"token function\">inflate</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call232<span class=\"token operator\">:</span>inflateEnd</pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº† <code>apk@classes.dex</code> , è€Œå®ƒçš„ä½œç”¨ï¼Œæ­£æ˜¯ä¸ºäº†æ‰¾åˆ°å·²åŠ è½½åˆ°å†…å­˜ä¸”ä¼˜åŒ–åçš„å£³ dex</p>\n<p><img data-src=\"/360-jiagu/image-20240221172717168.png\" alt=\"image-20240221172717168\" style=\"aspect-ratio:1261 / 182;\"></p>\n<hr>\n<p>åœ¨<strong>åŠ å›ºå£³åè°ƒè¯•åˆæ­¥åˆ†æ</strong>çš„ååŠéƒ¨åˆ†ï¼Œæˆ‘ä»¬æ‰“å°å‡ºäº†åŠ å›ºå£³æ‰“å¼€ dex çš„å †æ ˆå›æº¯ï¼Œç°åœ¨æˆ‘ä»¬ç›´æ¥è·³è½¬åˆ°ç›¸å¯¹åº”çš„åœ°æ–¹çœ‹çœ‹</p>\n<p><img data-src=\"/360-jiagu/image-20240220225331054.png\" alt=\"image-20240220225331054\" style=\"aspect-ratio:878 / 513;\"></p>\n<p>æˆ‘ä»¬åˆ° <code>0x19b780</code>  çœ‹çœ‹ï¼Œçœ‹èµ·æ¥æ˜¯ä¸€ä¸ªæ ‡å‡†çš„æ‰“å¼€å¹¶å†™å…¥æ–‡ä»¶çš„å‡½æ•°</p>\n<p><img data-src=\"/360-jiagu/image-20240221133619261.png\" alt=\"image-20240221133619261\" style=\"aspect-ratio:983 / 665;\"></p>\n<p>éšåå¯¹è¯¥å‡½æ•°è¿›è¡Œäº¤å‰å¼•ç”¨ï¼Œæˆ‘ä»¬å‘ç° <code>sub_1332B8</code>  ç«Ÿç„¶è°ƒç”¨äº†å®ƒï¼Œå°±åœ¨åˆšåˆšæˆ‘ä»¬å°±åˆ†æå‡ºè¿™ä¸ªå‡½æ•°ä¸­å¯æ˜¯åŒæ—¶ä¹Ÿæ‰§è¡Œäº†ä»å†…å­˜ä¸­è·å–å£³ dex çš„æ“ä½œçš„å‘¢</p>\n<p><img data-src=\"/360-jiagu/image-20240221173657553.png\" alt=\"image-20240221173657553\" style=\"aspect-ratio:879 / 258;\"></p>\n<p>æˆ‘ä»¬å¯¹è¿™ä¸¤å¤„è°ƒç”¨éƒ½ hook ä¸€ä¸‹çœ‹çœ‹æ˜¯ä»€ä¹ˆæƒ…å†µï¼Œæ‰“å°çš„ç»“æœå¦‚ä¸‹ï¼Œè¯´æ˜è¿™ä¸¤å¤„è°ƒç”¨éƒ½æ‰“å¼€äº† dex, <code>sub_1332B8</code>  ä¸­çš„å‰ä¸€ä¸ªè°ƒç”¨æ‰“å¼€äº† <code>classes.dex</code> , åä¸€ä¸ªè°ƒç”¨æ‰“å¼€äº† <code>classes2.dex</code>  å’Œ <code>classes3.dex</code> , è€Œ <code>classes.dex</code>  æ–‡ä»¶ä¸­çš„å†…å®¹å°±æ˜¯åŠ å¯†çš„ä¸» dex</p>\n<p><img data-src=\"/360-jiagu/image-20240221174419522.png\" alt=\"image-20240221174419522\" style=\"aspect-ratio:892 / 298;\"></p>\n<p>åœ¨åˆ›å»ºå®Œ <code>classes2.dex</code>  å’Œ <code>classes3.dex</code> , é€šè¿‡ hook å‘ç°è°ƒç”¨åœ¨è°ƒç”¨ <code>sub_128D44</code>  ä¹‹åè¿›ç¨‹å°±é€€å‡ºäº†</p>\n<p><img data-src=\"/360-jiagu/image-20240221180350649.png\" alt=\"image-20240221180350649\" style=\"aspect-ratio:1079 / 268;\"></p>\n<p>æˆ‘ä»¬å» hook ä¸€ä¸‹ <code>sub_128D44</code>  è¿™ä¸ªå‡½æ•°ï¼Œå‘ç°ä¼ å…¥çš„å‚æ•° <code>v8</code>  æ­£æ˜¯åŠ å¯†çš„ä¸» DEX</p>\n<p><img data-src=\"/360-jiagu/image-20240221184130805.png\" alt=\"image-20240221184130805\" style=\"aspect-ratio:1196 / 273;\"></p>\n<p>è€Œ <code>sub_128D44</code>  å‡½æ•°æ˜¯è¿™ä¸ªæ ·å­çš„ï¼Œå¹¶ä¸”åœ¨å£³ ELF åŠ è½½æ—¶å¯åŠ¨ <code>stalker_trace_so</code>  çš„ <code>trace_so()</code>  å‡½æ•°æ‰€æ‰“å°å‡ºçš„ç»“æœä¸­ï¼Œå¹¶æ²¡æœ‰è¿™ä¸ªå‡½æ•°çš„è°ƒç”¨è¢«æ‰“å°å‡ºæ¥</p>\n<p><img data-src=\"/360-jiagu/image-20240221180415665.png\" alt=\"image-20240221180415665\" style=\"aspect-ratio:925 / 106;\"></p>\n<p>è¿™è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>\n<p>å¾ˆç®€å•ï¼Œåœ¨è°ƒç”¨ <code>sub_128D44</code>  çš„ä½ç½®å†å»è°ƒç”¨ä¸€æ¬¡ <code>trace_so()</code>  å‡½æ•°ä»ç°åœ¨çš„ä½ç½®å¼€å§‹æ‰“å°å‡½æ•°çš„è°ƒç”¨é“¾ä¸å°±è¡Œå’¯ï¼š)</p>\n<p><img data-src=\"/360-jiagu/image-20240221180705025.png\" alt=\"image-20240221180705025\" style=\"aspect-ratio:1218 / 366;\"></p>\n<p>å‡½æ•°è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼Œæˆ‘ä»¬å‘ç°å† <code>mainELF</code>  è°ƒç”¨å®Œ <code>sub_128D44</code>  ä¹‹åï¼Œé€šè¿‡ä¸€ç³»åˆ—æ“ä½œåˆå›åˆ°äº†å£³ ELF ä¸­ï¼Œæœ€ç»ˆè°ƒç”¨ <code>raise</code>  å¯¼è‡´è¿›ç¨‹é€€å‡º</p>\n<p><img data-src=\"/360-jiagu/image-20240221185357390.png\" alt=\"image-20240221185357390\" style=\"aspect-ratio:721 / 605;\"></p>\n<p>ç„¶è€Œï¼Œå½“æˆ‘è·³è½¬åˆ°æœ€åè°ƒç”¨çš„å‡ ä¸ªå‡½æ•°æ—¶ï¼Œå¯ä»¥è¯´å‡½æ•°å¤æ‚åˆ°è®©äººå’‹èˆŒ</p>\n<p><img data-src=\"/360-jiagu/image-20240222005607295.png\" alt=\"image-20240222005607295\" style=\"aspect-ratio:1351 / 497;\"></p>\n<p><img data-src=\"/360-jiagu/image-20240222005639325.png\" alt=\"image-20240222005639325\" style=\"aspect-ratio:1619 / 626;\"></p>\n<p>è¿™ä¹ˆå¤æ‚ï¼Œæ˜¯ç»™äººåˆ†æçš„å—ï¼ï¼Ÿæ‰€ä»¥æˆ‘ä¾¿å¡åœ¨è¿™é‡Œäº†å¾ˆä¹…</p>\n<p>æˆ‘æƒ³äº†æƒ³ç°åœ¨æ‘†åœ¨é¢å‰çš„æœ‰ä¸¤æ¡è·¯ï¼Œæ˜¯å’Œä¸€çœ¼æœ›ä¸åˆ°å°½å¤´çš„è¿™ä¿©å‡½æ•°æ­»ç£•åˆ°åº•ï¼Œè¿˜æ˜¯é€‰æ‹©æŠŠ 360 åŠ å›ºçš„åè°ƒè¯•æå®šï¼Ÿ</p>\n<p>æˆ‘é€‰æ‹©åè€…ï¼Œå› ä¸ºæ˜æ˜¾æå®šåè°ƒè¯•è¦æ¯”æŠŠè¿™ä¸¤ä¸ªå‡½æ•°åˆ†ææ˜ç™½è¦ç¨å¾®ç®€å•ä¸€ç‚¹</p>\n<h1 id=\"åŠ å›ºå£³åè°ƒè¯•æ·±å…¥åˆ†æ\"><a class=\"anchor\" href=\"#åŠ å›ºå£³åè°ƒè¯•æ·±å…¥åˆ†æ\">#</a> åŠ å›ºå£³åè°ƒè¯•æ·±å…¥åˆ†æ</h1>\n<p>åœ¨<strong>åŠ å›ºå£³åè°ƒè¯•åˆæ­¥åˆ†æ</strong>ä¸­ï¼Œæˆ‘æ›¾å°è¯•è¿‡ <code>dbus</code> , <code>TracerPid</code> , <code>readlink</code> , <code>strstr</code>  éƒ½æ²¡æœ‰æ˜æ˜¾çš„æ•ˆæœï¼Œåªæœ‰ hook  <code>open</code>  å‡½æ•°è®©æˆ‘çœ‹åˆ°äº†äº›è®¸çš„æ›™å…‰ï¼Œé‚£ä¹ˆç°åœ¨åº”è¯¥è¿˜æœ‰ä¸€ç§éå¸¸é‡è¦çš„åè°ƒè¯•æ‰‹æ®µæ²¡æœ‰ç”¨åˆ°ï¼Œé‚£å°±æ˜¯ <code>pthread_create</code>  åè°ƒè¯•</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">check_pthread_create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> pthread_create_addr <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">findExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'pthread_create'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">var</span> pthread_create <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NativeFunction</span><span class=\"token punctuation\">(</span>pthread_create_addr<span class=\"token punctuation\">,</span> <span class=\"token string\">\"int\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"pointer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"pointer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"pointer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"pointer\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>pthread_create_addr<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NativeCallback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parg0<span class=\"token punctuation\">,</span> parg1<span class=\"token punctuation\">,</span> parg2<span class=\"token punctuation\">,</span> parg3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">var</span> so_name <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByAddress</span><span class=\"token punctuation\">(</span>parg2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token keyword\">var</span> so_path <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByAddress</span><span class=\"token punctuation\">(</span>parg2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">var</span> so_base <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">getBaseAddress</span><span class=\"token punctuation\">(</span>so_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token keyword\">var</span> offset <span class=\"token operator\">=</span> parg2 <span class=\"token operator\">-</span> so_base<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">var</span> <span class=\"token constant\">PC</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>so_name<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"jiagu\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"======\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"find thread func offset\"</span><span class=\"token punctuation\">,</span> so_name<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            Thread<span class=\"token punctuation\">.</span><span class=\"token function\">backtrace</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">,</span> Backtracer<span class=\"token punctuation\">.</span><span class=\"token constant\">ACCURATE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>addr_in_so<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token keyword\">var</span> check_list <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token comment\">//1769036,1771844</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>check_list<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>offset<span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"check bypass\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token constant\">PC</span> <span class=\"token operator\">=</span> <span class=\"token function\">pthread_create</span><span class=\"token punctuation\">(</span>parg0<span class=\"token punctuation\">,</span> parg1<span class=\"token punctuation\">,</span> parg2<span class=\"token punctuation\">,</span> parg3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token constant\">PC</span> <span class=\"token operator\">=</span> <span class=\"token function\">pthread_create</span><span class=\"token punctuation\">(</span>parg0<span class=\"token punctuation\">,</span> parg1<span class=\"token punctuation\">,</span> parg2<span class=\"token punctuation\">,</span> parg3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token constant\">PC</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"int\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"pointer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"pointer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"pointer\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"pointer\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">addr_in_so</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">addr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">var</span> process_Obj_Module_Arr <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">enumerateModules</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> process_Obj_Module_Arr<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>addr<span class=\"token operator\">></span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>base <span class=\"token operator\">&amp;&amp;</span> addr<span class=\"token operator\">&lt;</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"is in\"</span><span class=\"token punctuation\">,</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span><span class=\"token string\">\"offset: 0x\"</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>addr<span class=\"token operator\">-</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æ³¨å…¥ä»£ç ä¹‹åï¼Œ <code>pthread_create</code>  çš„è°ƒç”¨éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªåœ°å€ <code>0x17710</code></p>\n<p><img data-src=\"/360-jiagu/image-20240222010902622.png\" alt=\"image-20240222010902622\" style=\"aspect-ratio:735 / 781;\"></p>\n<p>æˆ‘ä»¬è·³è½¬åˆ°è¿™ä¸ªåœ°å€ä¹‹åå´å‘ç°ä¸ºä»€ä¹ˆä¼šæ²¡æœ‰ <code>pthread_create</code>  å‘¢ï¼Ÿï¼Ÿ</p>\n<p><img data-src=\"/360-jiagu/image-20240222011044885.png\" alt=\"image-20240222011044885\" style=\"aspect-ratio:1113 / 306;\"></p>\n<p>çœ‹äº†ä¸€çœ¼è¿™ä¸ªä»£ç æ‰€åœ¨çš„å‡½æ•°çš„åç§° <code>ffi_call_SYSV</code></p>\n<p><img data-src=\"/360-jiagu/image-20240222011143427.png\" alt=\"image-20240222011143427\" style=\"aspect-ratio:947 / 186;\"></p>\n<p>hmmm, çœ‹æ¥æ˜¯ç”¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hbGV4Y29kZTIuZ2l0Ym9vay5pby9pb3MtZGV2ZWxvcG1lbnQtZ3VpZGVsaW5lcy9pb3MtemEtdGFuL2xpYmZmaS1kb25nLXRhaS10aWFvLXlvbmctaGUtZGluZy15aS1jLWhhbi1zaHU=\"> libffi åŠ¨æ€è°ƒç”¨å‡½æ•°</span>å‘€</p>\n<p><img data-src=\"/360-jiagu/image-20240222011351754.png\" alt=\"image-20240222011351754\" style=\"aspect-ratio:1012 / 715;\"></p>\n<p>ç›´æ¥åˆ°<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2xpYmZmaQ==\"> libffi çš„ github ä»“åº“</span>çœ‹ä¸€çœ¼<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2xpYmZmaS9saWJmZmkvYmxvYi9tYXN0ZXIvc3JjL2FhcmNoNjQvc3lzdi5T\"> ffi_call_SYSV çš„æºç </span></p>\n<p>ä¸€è¿›å»æ³¨é‡Šéƒ½å†™å¾—æ¸…æ¸…æ¥šæ¥šäº†</p>\n<p><img data-src=\"/360-jiagu/image-20240222012001816.png\" alt=\"image-20240222012001816\" style=\"aspect-ratio:803 / 502;\"></p>\n<p>åˆ©ç”¨æ³¨é‡Šå°±å¯ä»¥çŸ¥é“æ¯è¡Œæ±‡ç¼–éƒ½ä»£è¡¨ä»€ä¹ˆäº†ï¼Œæ‰€ä»¥ <code>BLR X24</code>  è¡¨ç¤ºå»åŠ¨æ€è°ƒç”¨å‡½æ•°ï¼Œè€Œå‰é¢çš„ <code>X0</code> , <code>X2</code> , <code>X4</code> , <code>X6</code>  æ˜¯ç”¨æ¥ä¼ å‚çš„</p>\n<p><img data-src=\"/360-jiagu/image-20240222012543471.png\" alt=\"image-20240222012543471\" style=\"aspect-ratio:1845 / 790;\"></p>\n<p>æˆ‘ä»¬ hook ä¸€ä¸‹ <code>x0</code>  çœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆæ•æ„Ÿçš„å­—ç¬¦ä¸²</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">anti_frida_check</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x1770C</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">try</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x0<span class=\"token punctuation\">.</span><span class=\"token function\">readCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç„¶è€Œç¥å¥‡çš„æ˜¯ï¼Œæˆ‘ä»…ä»…å» hook å¹¶æ‰“å° x0 å­—ç¬¦ä¸²ï¼Œå…¶ä»–ä»€ä¹ˆäº‹æƒ…éƒ½ä¸å¹²ï¼Œapk ç«Ÿç„¶ç¥å¥‡çš„è¿›å»äº†ï¼Œåªä¸è¿‡ä¼šæ²¡æœ‰å“åº”ï¼Œæ„Ÿè§‰è·ç¦»æˆåŠŸä¸è¿œäº†å‘¢</p>\n<p><img data-src=\"/360-jiagu/image-20240222013454838.png\" alt=\"image-20240222013454838\" style=\"aspect-ratio:489 / 922;\"></p>\n<p>æœ‰ç‚¹æ„æ€ï¼Œç­›é€‰ä¸€ä¸‹çœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆæ•æ„Ÿçš„å­—ç¬¦ä¸²å¥½å’¯</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">anti_frida_check</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x1770C</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">try</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token keyword\">var</span> s <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x0<span class=\"token punctuation\">.</span><span class=\"token function\">readCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'frida'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'gum-js-loop'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'gmain'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'linjector'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/proc/'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç«Ÿç„¶è¿˜çœŸæœ‰ï¼Œé‚£å°±æŠŠè¿™äº›å­—ç¬¦ä¸²å…¨éƒ¨æ›¿æ¢æˆæ— æ„ä¹‰çš„å­—ç¬¦ä¸²çœ‹çœ‹å’¯</p>\n<p><img data-src=\"/360-jiagu/image-20240222013944879.png\" alt=\"image-20240222013944879\" style=\"aspect-ratio:1633 / 205;\"></p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">anti_frida_check</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x1770C</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">try</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token keyword\">var</span> s <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x0<span class=\"token punctuation\">.</span><span class=\"token function\">readCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'frida'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'gum-js-loop'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'gmain'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'linjector'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/proc/'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    Memory<span class=\"token punctuation\">.</span><span class=\"token function\">protect</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x0<span class=\"token punctuation\">,</span> Process<span class=\"token punctuation\">.</span>pointerSize<span class=\"token punctuation\">,</span> <span class=\"token string\">'rwx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                    <span class=\"token keyword\">var</span> replace_str<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>s<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                        replace_str<span class=\"token operator\">+=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x0<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8String</span><span class=\"token punctuation\">(</span>replace_str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç„¶è€Œè¿™æ ·åšè¿›ç¨‹å´ä¸€ä¸ªåŠ²çš„å´©æºƒï¼ï¼</p>\n<p>æ²¡äº‹ï¼Œå¯„å­˜å™¨ <code>x0</code>  ç”¨ä¸äº†ï¼Œè¿˜æœ‰ <code>x2</code> , <code>x4</code> , <code>x6</code>  æ²¡æ›¿æ¢è¿‡å‘¢ï¼æˆ‘ä¸€ä¸ªä¸€ä¸ªçš„è¯•è¿‡å»ï¼Œç»ˆäºï¼Œå½“æˆ‘å°†å¯„å­˜å™¨æ”¹æˆ x6 æ—¶ï¼Œè¿›ç¨‹ç»ˆäºä¸å†å´©æºƒæˆåŠŸçš„è¿›å…¥äº† apk!</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">anti_frida_check</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x1770C</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token keyword\">try</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                <span class=\"token keyword\">var</span> s <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x6<span class=\"token punctuation\">.</span><span class=\"token function\">readCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'frida'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'gum-js-loop'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'gmain'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'linjector'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/proc/'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                    <span class=\"token comment\">//console.log(s)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    Memory<span class=\"token punctuation\">.</span><span class=\"token function\">protect</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x0<span class=\"token punctuation\">,</span> Process<span class=\"token punctuation\">.</span>pointerSize<span class=\"token punctuation\">,</span> <span class=\"token string\">'rwx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                    <span class=\"token keyword\">var</span> replace_str<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>s<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                        replace_str<span class=\"token operator\">+=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x0<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8String</span><span class=\"token punctuation\">(</span>replace_str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img data-src=\"/360-jiagu/image-20240222015211639.png\" alt=\"image-20240222015211639\" style=\"aspect-ratio:492 / 984;\"></p>\n<p>çœ‹ä¸€çœ¼æ£€æµ‹çš„å­—ç¬¦ä¸²ï¼Œæ€ä¹ˆå…¨æ˜¯ <code>/memfd:frida-agent-64.so</code></p>\n<p><img data-src=\"/360-jiagu/image-20240222015139528.png\" alt=\"image-20240222015139528\" style=\"aspect-ratio:920 / 269;\"></p>\n<h1 id=\"ä¸»dexåŠ è½½æµç¨‹åˆ†æ\"><a class=\"anchor\" href=\"#ä¸»dexåŠ è½½æµç¨‹åˆ†æ\">#</a> ä¸» DEX åŠ è½½æµç¨‹åˆ†æ</h1>\n<p>å›åˆ°è¿™ä¸ªå¡äº†æˆ‘ä»¬å¾ˆä¹…ä½ç½®ï¼Œç°åœ¨è¿‡äº†åè°ƒè¯•ä¹‹åè¿™é‡Œçš„ä»£ç ç»ˆäºå¯ä»¥ç»§ç»­æ‰§è¡Œä¸‹å»äº†</p>\n<p><img data-src=\"/360-jiagu/image-20240222015651090.png\" alt=\"image-20240222015651090\" style=\"aspect-ratio:1109 / 304;\"></p>\n<p>å‘ä¸‹çœ‹æ‰¾åˆ°è¿™ä¸€ä¸ªå‡½æ•° <code>sub_18FEA8</code></p>\n<p><img data-src=\"/360-jiagu/image-20240222030003433.png\" alt=\"image-20240222030003433\" style=\"aspect-ratio:1425 / 230;\"></p>\n<p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­çš„å­—ç¬¦ä¸²å…¨éƒ¨éƒ½æ˜¯åŠ å¯†çš„ï¼Œé¢‡æœ‰ç§æ­¤åœ°æ— é“¶ä¸‰ç™¾ä¸¤çš„æ„Ÿè§‰ï¼Œæˆ‘ä»¬æŠŠå­—ç¬¦ä¸²è§£å¯†åå‘ç°äº† <code>DexFileLoader</code>  ç›¸å…³çš„å­—ç¬¦ä¸²ï¼Œè¯´æ˜è¿™ä¸ªå‡½æ•°è‚¯å®šå’ŒåŠ è½½ dex æœ‰æŸç§å…³è”</p>\n<p><img data-src=\"/360-jiagu/image-20240222030104410.png\" alt=\"image-20240222030104410\" style=\"aspect-ratio:1527 / 470;\"></p>\n<p>æˆ‘ä»¬ hook ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼Œå‘ç°è¿™ä¸ªå‡½æ•°å…±è°ƒç”¨äº†ä¸‰æ¬¡ï¼Œè€Œä¸”ä¼ å…¥çš„å€¼éƒ½æ˜¯å·²ç»è§£å¯†äº†çš„ dex, <code>classes.dex</code> , <code>classes2.dex</code> , <code>classes3.dex</code>  åˆ†åˆ«é€šè¿‡è¿™ä¸ªå‡½æ•°åŠ è½½</p>\n<p><code>classes.dex</code></p>\n<p><img data-src=\"/360-jiagu/image-20240222030239507.png\" alt=\"image-20240222030239507\" style=\"aspect-ratio:1192 / 363;\"></p>\n<p><code>classes2.dex</code></p>\n<p><img data-src=\"/360-jiagu/image-20240222030345127.png\" alt=\"image-20240222030345127\" style=\"aspect-ratio:1181 / 364;\"></p>\n<p><code>classes3.dex</code></p>\n<p><img data-src=\"/360-jiagu/image-20240222030355010.png\" alt=\"image-20240222030355010\" style=\"aspect-ratio:1193 / 358;\"></p>\n<p>æŠŠè¿™ä¸‰ä¸ª dex ç»™ dump ä¸‹æ¥çœ‹çœ‹ï¼Œäºæ˜¯æˆ‘ä»¬å¾—åˆ°äº†è¿™ä¸‰ä¸ªæ–‡ä»¶</p>\n<p><img data-src=\"/360-jiagu/image-20240222030924824.png\" alt=\"image-20240222030924824\" style=\"aspect-ratio:632 / 96;\"></p>\n<p>æŠŠæœ€å¤§çš„é‚£ä¸ª dex æ‹–åˆ° jadx åˆ†æé‡Œé¢ï¼Œå‘ç°è¿™æ­£æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ä¸» DEX</p>\n<p><img data-src=\"/360-jiagu/image-20240222172233276.png\" alt=\"image-20240222172233276\" style=\"aspect-ratio:1920 / 1078;\"></p>\n<p>å…¶ä»–å‡½æ•°éƒ½å¾ˆæ­£å¸¸ï¼Œå”¯ç‹¬ <code>onCreate</code>  å‡½æ•°å˜æˆäº† <code>native</code>  å£°æ˜ï¼Œè¦æ˜¯æœ‰åŒæ ·åˆ†æåˆ°è¿™é‡Œçš„æœ‹å‹å¯ä»¥å»ç ”ç©¶ç ”ç©¶ <code>onCreate</code>  å‡½æ•°å¯¹åº”çš„ <code>native</code>  æœ¬åœ°å‡½æ•°ç©¶ç«Ÿåœ¨ä»€ä¹ˆåœ°æ–¹ï¼Œç›¸ä¿¡æœ‰äº†æœ¬æ–‡çš„é“ºå«ï¼Œå¯¹äºè¿›è¡Œåç»­ <code>onCreate</code>  å‡½æ•°çš„åˆ†æåº”è¯¥æ˜¯æœ‰æ‰€å¸®åŠ©çš„å§ï½</p>\n<p>è€Œé™¤æ­¤ä¹‹å¤–çš„åˆ«çš„ç±»å’Œç›´æ¥åç¼–è¯‘æœªåŠ å›ºçš„ apk çš„ç±»æ˜¯ä¸€æ ·çš„</p>\n<p><img data-src=\"/360-jiagu/image-20240222031222988.png\" alt=\"image-20240222031222988\" style=\"aspect-ratio:1920 / 1079;\"></p>\n<h1 id=\"ä¸»dexè§£å¯†ç®—æ³•åˆ†æ\"><a class=\"anchor\" href=\"#ä¸»dexè§£å¯†ç®—æ³•åˆ†æ\">#</a> ä¸» DEX è§£å¯†ç®—æ³•åˆ†æ</h1>\n<p>æˆ‘ä»¬åœ¨<strong>åŠ å›ºå£³åè°ƒè¯•æ·±å…¥åˆ†æ</strong>æˆåŠŸçš„ç»•è¿‡äº† 360 åŠ å›ºçš„ frida æ£€æµ‹ï¼Œç°åœ¨æˆ‘ä»¬å†æ¬¡å›åˆ° <code>sub_1332B8</code>  ä¸­çš„ <code>sub_128D44</code> , æ¥è¿›è¡Œåç»­çš„è§£å¯†ç®—æ³•çš„åˆ†æ</p>\n<p>ä¸‹å›¾æ˜¯<strong>ä¸» DEX è§£å¯†æµç¨‹åˆæ­¥åˆ†æ</strong>æœ«å°¾éƒ¨åˆ†çš„å†…å®¹ï¼Œæˆ‘ä»¬å°†ä»¥è¿™ä¸ªå‡½æ•° <code>sub_128D44</code>  ä¸ºèµ·ç‚¹è¿›è¡Œè§£å¯†ç®—æ³•çš„åˆ†æï¼Œå› ä¸ºå‚æ•° <code>v8</code>  ä¼ å…¥çš„å€¼æ˜¯åŠ å¯†ä¹‹åçš„ä¸» DEX</p>\n<p><img data-src=\"/360-jiagu/image-20240307115103478.png\" alt=\"image-20240307115103478\" style=\"aspect-ratio:1080 / 642;\"></p>\n<p>æˆ‘ä»¬åœ¨è¿™ä¸ªå†…å­˜ç”¨ frida æ‰“ä¸€ä¸ªå†…å­˜è¯»å†™æ–­ç‚¹æ¥çœ‹çœ‹æ˜¯ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‡½æ•°è¯»å–äº†ä¸» DEX, åŒæ—¶éœ€è¦æ³¨æ„åŠ ä¸Šæˆ‘ä»¬çš„åè°ƒè¯•å‡½æ•°</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">var</span> so_name <span class=\"token operator\">=</span> <span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_dex_dec_enter_in_main_elf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x1346B4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token comment\">//memory breakpoint</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            MemoryAccessMonitor<span class=\"token punctuation\">.</span><span class=\"token function\">enable</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                    <span class=\"token literal-property property\">base</span><span class=\"token operator\">:</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x0<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    <span class=\"token literal-property property\">size</span><span class=\"token operator\">:</span><span class=\"token number\">40</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                    <span class=\"token function-variable function\">onAccess</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">details</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>details<span class=\"token punctuation\">.</span>operation<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">get_addr_in_so</span><span class=\"token punctuation\">(</span>details<span class=\"token punctuation\">.</span>from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">var</span> zlib_count<span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_zlib</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>Module<span class=\"token punctuation\">.</span><span class=\"token function\">findExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"inflate\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token comment\">// fd, buff, len</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            zlib_count<span class=\"token operator\">+=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>zlib_count<span class=\"token operator\">===</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token function\">hook_dex_dec_enter_in_main_elf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">anti_frida_check</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x1770C</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token keyword\">try</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                <span class=\"token keyword\">var</span> s <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x6<span class=\"token punctuation\">.</span><span class=\"token function\">readCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'frida'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'gum-js-loop'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'gmain'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'linjector'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                    s<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/proc/'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">!==</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                    <span class=\"token comment\">//console.log(s)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                    Memory<span class=\"token punctuation\">.</span><span class=\"token function\">protect</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x0<span class=\"token punctuation\">,</span> Process<span class=\"token punctuation\">.</span>pointerSize<span class=\"token punctuation\">,</span> <span class=\"token string\">'rwx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                    <span class=\"token keyword\">var</span> replace_str<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>s<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                        replace_str<span class=\"token operator\">+=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x0<span class=\"token punctuation\">.</span><span class=\"token function\">writeUtf8String</span><span class=\"token punctuation\">(</span>replace_str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">get_addr_in_so</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">addr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token keyword\">var</span> process_Obj_Module_Arr <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">enumerateModules</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> process_Obj_Module_Arr<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>addr<span class=\"token operator\">></span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>base <span class=\"token operator\">&amp;&amp;</span> addr<span class=\"token operator\">&lt;</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            <span class=\"token keyword\">return</span> addr<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">\" is in \"</span><span class=\"token operator\">+</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token operator\">+</span><span class=\"token string\">\" offset: 0x\"</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>addr<span class=\"token operator\">-</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token keyword\">return</span> addr<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_dlopen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token comment\">//hook_call_constructors();</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>Module<span class=\"token punctuation\">.</span><span class=\"token function\">findExportByName</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"android_dlopen_ext\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                <span class=\"token keyword\">var</span> pathptr <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pathptr <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span> pathptr <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                    <span class=\"token keyword\">var</span> path <span class=\"token operator\">=</span> <span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span>pathptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readCString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dlopen \"</span><span class=\"token operator\">+</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>so_name<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>is_can_hook <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>            <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">retval</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>is_can_hook<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                    <span class=\"token comment\">//you can do any thing before stalker trace so</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                    <span class=\"token comment\">//trace_so();</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>                    <span class=\"token function\">hook_zlib</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                    <span class=\"token function\">anti_frida_check</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                    <span class=\"token comment\">//hook_C918();</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre><span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span>hook_dlopen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>æ‰“å°æ—¥å¿—å¦‚ä¸‹</p>\n<p><img data-src=\"/360-jiagu/image-20240307120002564.png\" alt=\"image-20240307120002564\" style=\"aspect-ratio:718 / 67;\"></p>\n<p>è¯´æ˜æ˜¯åœ¨ <code>0xd364</code>  å¤„è¯»å–äº†è¿™ä¸ªä¸» DEX</p>\n<p>è·³è½¬åˆ° <code>0xd364</code>  ä¹‹åå‘ç°è¿™ä¸ªåœ°å€åœ¨å‡½æ•° <code>sub_C918</code>  ä¸­ï¼Œçœ‹èµ·æ¥è¿™ä¸ªå‡½æ•°çš„å½¢çŠ¶åƒä¸€ä¸ªç«è½¦å¤´ä¸€æ · XD</p>\n<p><img data-src=\"/360-jiagu/image-20240307120118309.png\" alt=\"image-20240307120118309\" style=\"aspect-ratio:1920 / 520;\"></p>\n<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­ä½¿ç”¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL29hY2lhL3N0YWxrZXJfdHJhY2Vfc28=\"> staker_trace_so</span> ç”Ÿæˆçš„ <code>trace_so()</code>  å‡½æ•°å»çœ‹çœ‹å‡½æ•°çš„è°ƒç”¨é“¾æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œtrace çš„èµ·ç‚¹å°±æ˜¯åœ¨ <code>sub_1332B8</code>  ä¸­çš„ <code>sub_128D44</code> , åŒæ—¶æ³¨æ„åŠ ä¸Šæˆ‘ä»¬çš„åè°ƒè¯•å‡½æ•°</p>\n<p><img data-src=\"/360-jiagu/image-20240307120333178.png\" alt=\"image-20240307120333178\" style=\"aspect-ratio:1218 / 229;\"></p>\n<p>æ‰“å°å‡ºæ¥çš„å‡½æ•°è°ƒç”¨é“¾å¦‚ä¸‹</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>start Stalker<span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Stalker end<span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call1<span class=\"token operator\">:</span><span class=\"token function\">sub_128D44</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call2<span class=\"token operator\">:</span><span class=\"token class-name\">j_interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call3<span class=\"token operator\">:</span><span class=\"token class-name\">interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call4<span class=\"token operator\">:</span><span class=\"token function\">interpreter_wrap_int64_t_bridge</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call5<span class=\"token operator\">:</span><span class=\"token function\">getenv</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call6<span class=\"token operator\">:</span><span class=\"token function\">sub_13908</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call7<span class=\"token operator\">:</span><span class=\"token function\">inotify_add_watch</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call8<span class=\"token operator\">:</span><span class=\"token function\">sub_11220</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call9<span class=\"token operator\">:</span><span class=\"token function\">fopen</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call10<span class=\"token operator\">:</span><span class=\"token function\">sub_9DD8</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call11<span class=\"token operator\">:</span><span class=\"token function\">sub_E3E0</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call12<span class=\"token operator\">:</span><span class=\"token function\">strtol</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call13<span class=\"token operator\">:</span><span class=\"token function\">feof</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call14<span class=\"token operator\">:</span><span class=\"token function\">raise</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call15<span class=\"token operator\">:</span><span class=\"token function\">memset</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call16<span class=\"token operator\">:</span>sub_C918<span class=\"token comment\">// è¿™ä¸ªå‡½æ•°ä¸­è¯»å–åŠ å¯†ä¹‹åçš„ dex</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call17<span class=\"token operator\">:</span><span class=\"token function\">sub_9964</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call18<span class=\"token operator\">:</span><span class=\"token function\">sub_9AC4</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call19<span class=\"token operator\">:</span><span class=\"token function\">sub_9988</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call20<span class=\"token operator\">:</span><span class=\"token function\">j_ffi_prep_cif</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call21<span class=\"token operator\">:</span><span class=\"token function\">ffi_prep_cif</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call22<span class=\"token operator\">:</span><span class=\"token function\">j_ffi_prep_cif_machdep</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call23<span class=\"token operator\">:</span><span class=\"token function\">ffi_prep_cif_machdep</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call24<span class=\"token operator\">:</span><span class=\"token function\">j_ffi_call</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call25<span class=\"token operator\">:</span><span class=\"token function\">ffi_call</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call26<span class=\"token operator\">:</span><span class=\"token function\">sub_1674C</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call27<span class=\"token operator\">:</span><span class=\"token function\">j_ffi_call_SYSV</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call28<span class=\"token operator\">:</span><span class=\"token function\">ffi_call_SYSV</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call29<span class=\"token operator\">:</span><span class=\"token function\">sub_167BC</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call30<span class=\"token operator\">:</span><span class=\"token function\">sub_1647C</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call31<span class=\"token operator\">:</span><span class=\"token function\">sub_163DC</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call32<span class=\"token operator\">:</span><span class=\"token function\">_Znwm</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call33<span class=\"token operator\">:</span><span class=\"token function\">malloc</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call34<span class=\"token operator\">:</span><span class=\"token function\">sub_128D64</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call35<span class=\"token operator\">:</span><span class=\"token function\">sub_9E58</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call36<span class=\"token operator\">:</span><span class=\"token function\">j_lseek_1</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call37<span class=\"token operator\">:</span><span class=\"token function\">lseek</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call38<span class=\"token operator\">:</span><span class=\"token function\">sub_A3EC</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call39<span class=\"token operator\">:</span><span class=\"token function\">sub_99CC</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call40<span class=\"token operator\">:</span><span class=\"token function\">sub_9944</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call41<span class=\"token operator\">:</span><span class=\"token function\">sub_999C</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call42<span class=\"token operator\">:</span><span class=\"token function\">sub_128D70</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call43<span class=\"token operator\">:</span><span class=\"token function\">memcpy</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call44<span class=\"token operator\">:</span><span class=\"token function\">sub_14283C</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call45<span class=\"token operator\">:</span><span class=\"token function\">j__Znwm</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call46<span class=\"token operator\">:</span><span class=\"token function\">sub_1429CC</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call47<span class=\"token operator\">:</span><span class=\"token function\">sub_142FE0</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call48<span class=\"token operator\">:</span><span class=\"token function\">sub_10964</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call49<span class=\"token operator\">:</span><span class=\"token function\">sub_9D60</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call50<span class=\"token operator\">:</span><span class=\"token function\">sub_143008</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call51<span class=\"token operator\">:</span><span class=\"token function\">sub_142ABC</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call52<span class=\"token operator\">:</span><span class=\"token function\">sub_142EA0</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call53<span class=\"token operator\">:</span><span class=\"token function\">sub_143A38</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call54<span class=\"token operator\">:</span><span class=\"token function\">sub_11CF8C</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call55<span class=\"token operator\">:</span><span class=\"token function\">sub_12047C</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call56<span class=\"token operator\">:</span><span class=\"token function\">strlen</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call57<span class=\"token operator\">:</span><span class=\"token function\">memcmp</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call58<span class=\"token operator\">:</span><span class=\"token function\">sub_117B68</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call59<span class=\"token operator\">:</span><span class=\"token function\">sub_166C4</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call60<span class=\"token operator\">:</span><span class=\"token function\">memcpy</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call61<span class=\"token operator\">:</span><span class=\"token function\">sub_143848</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call62<span class=\"token operator\">:</span><span class=\"token function\">sub_1B66A8</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call63<span class=\"token operator\">:</span><span class=\"token function\">pthread_mutex_lock</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call64<span class=\"token operator\">:</span><span class=\"token function\">sub_143B48</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call65<span class=\"token operator\">:</span><span class=\"token function\">sub_1B66D0</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call66<span class=\"token operator\">:</span><span class=\"token function\">pthread_mutex_unlock</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call67<span class=\"token operator\">:</span><span class=\"token function\">sub_143088</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call68<span class=\"token operator\">:</span><span class=\"token function\">sub_11F768</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call69<span class=\"token operator\">:</span><span class=\"token function\">j__ZdlPv</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call70<span class=\"token operator\">:</span><span class=\"token function\">_ZdlPv</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call71<span class=\"token operator\">:</span><span class=\"token function\">free</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call72<span class=\"token operator\">:</span><span class=\"token function\">sub_1178E8</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call73<span class=\"token operator\">:</span><span class=\"token function\">sub_1222D0</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call74<span class=\"token operator\">:</span><span class=\"token function\">sub_14316C</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call75<span class=\"token operator\">:</span><span class=\"token function\">sub_142954</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call76<span class=\"token operator\">:</span><span class=\"token function\">_Z9__arm_a_2PcmS_Rii</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call77<span class=\"token operator\">:</span><span class=\"token class-name\">j_interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call78<span class=\"token operator\">:</span><span class=\"token class-name\">interpreter_wrap_int64_t</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call79<span class=\"token operator\">:</span><span class=\"token function\">sub_9FFC</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call80<span class=\"token operator\">:</span><span class=\"token function\">j_lseek_3</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call81<span class=\"token operator\">:</span><span class=\"token function\">j_lseek_2</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call82<span class=\"token operator\">:</span><span class=\"token function\">sub_9A90</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call83<span class=\"token operator\">:</span><span class=\"token function\">sub_142894</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call84<span class=\"token operator\">:</span><span class=\"token function\">sub_1428BC</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call85<span class=\"token operator\">:</span><span class=\"token function\">sub_127DCC</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call86<span class=\"token operator\">:</span><span class=\"token function\">sub_14292C</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call87<span class=\"token operator\">:</span><span class=\"token function\">sub_14285C</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call88<span class=\"token operator\">:</span><span class=\"token function\">j_lseek_0</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call89<span class=\"token operator\">:</span><span class=\"token function\">_Znam</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call90<span class=\"token operator\">:</span><span class=\"token function\">sub_128E88</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call91<span class=\"token operator\">:</span><span class=\"token function\">_ZdaPv</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call92<span class=\"token operator\">:</span><span class=\"token function\">sub_142AA4</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call93<span class=\"token operator\">:</span><span class=\"token function\">sub_142A10</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call94<span class=\"token operator\">:</span><span class=\"token function\">sub_12036C</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call95<span class=\"token operator\">:</span><span class=\"token function\">sub_1B6680</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call96<span class=\"token operator\">:</span><span class=\"token function\">pthread_mutex_destroy</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call97<span class=\"token operator\">:</span><span class=\"token function\">sub_131D58</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call98<span class=\"token operator\">:</span><span class=\"token function\">sub_11F3A4</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call99<span class=\"token operator\">:</span>sub_18FEA8<span class=\"token comment\">// è¿™ä¸ªå‡½æ•°ä¸­ä¼ å…¥è§£å¯†ä¹‹åçš„ dex, ä½ç½®å¦‚ä¸‹å›¾æ‰€ç¤º</span></pre></td></tr></table></figure><p><img data-src=\"/360-jiagu/image-20240307120808017.png\" alt=\"image-20240307120808017\" style=\"aspect-ratio:1473 / 142;\"></p>\n<p>è¿½è¸ªå‡½æ•°è°ƒç”¨é“¾ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸¤ä¸ªæœ‰è¶£çš„å‡½æ•°</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call50<span class=\"token operator\">:</span><span class=\"token function\">sub_143008</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call51<span class=\"token operator\">:</span>sub_142ABC</pre></td></tr></table></figure><p><code>sub_143008</code>  çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªè§£å¯†çš„å‡½æ•°ï¼Œå…ˆåŠ ä¸Š 0x70 å†å¼‚æˆ– 0x36, æˆ‘ä»¬ hook ä¸€ä¸‹ä¼ å…¥çš„å‚æ•°çœ‹çœ‹æ˜¯ä»€ä¹ˆæƒ…å†µ</p>\n<p><img data-src=\"/360-jiagu/image-20240307120941018.png\" alt=\"image-20240307120941018\" style=\"aspect-ratio:914 / 874;\"></p>\n<p><img data-src=\"/360-jiagu/image-20240307121240701.png\" alt=\"image-20240307121240701\" style=\"aspect-ratio:1188 / 232;\"></p>\n<p>æˆ‘ä»¬å†å»çœ‹çœ‹åŠ å¯†çš„ dex, å‘ç°è¿™ä¸ªå‡½æ•°ä¼ å…¥çš„å°±æ˜¯åŠ å¯†çš„ä¸» dex</p>\n<p><img data-src=\"/360-jiagu/image-20240307121409507.png\" alt=\"image-20240307121409507\" style=\"aspect-ratio:792 / 329;\"></p>\n<p>æŠŠè¿™éƒ¨åˆ†è§£å¯†çœ‹çœ‹é‡Œé¢æ˜¯ä»€ä¹ˆå†…å®¹</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ke_classes.dex'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    s <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dexA <span class=\"token operator\">=</span> s<span class=\"token punctuation\">[</span><span class=\"token number\">0x31A4</span><span class=\"token punctuation\">:</span><span class=\"token number\">0x31A4</span> <span class=\"token operator\">+</span> <span class=\"token number\">0x41E</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dexA <span class=\"token operator\">=</span> <span class=\"token builtin\">bytearray</span><span class=\"token punctuation\">(</span>dexA<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>dexA<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    dexA<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>dexA<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token number\">0x70</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token number\">0x36</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&amp;</span><span class=\"token number\">0xff</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dexA.dex'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>dexA<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>ç®€å•çœ‹äº†çœ‹ï¼Œ <code>APPKEY</code> , <code>activityName</code>  ç­‰ç­‰åƒæ˜¯ä¸€äº›é…ç½®ä¿¡æ¯çš„æ ·å­</p>\n<p><img data-src=\"/360-jiagu/image-20240307121648094.png\" alt=\"image-20240307121648094\" style=\"aspect-ratio:793 / 738;\"></p>\n<p>è¿™éƒ¨åˆ†å†…å®¹è§£å¯†å®Œä¹‹åï¼Œåœ¨ <code>sub_142ABC</code>  ä¸­ä»¥ <code>pk</code>  ä¸ºæ ‡å¿—è¯»å–å„ä¸ªé…ç½®ä¿¡æ¯</p>\n<p><img data-src=\"/360-jiagu/image-20240307124356084.png\" alt=\"image-20240307124356084\" style=\"aspect-ratio:807 / 355;\"></p>\n<p>ä¹‹åæˆ‘ç»§ç»­ä¸€ä¸ªä¸€ä¸ªè·³è½¬åˆ°æ‰“å°å‡ºæ¥çš„å‡½æ•°ä¸­çœ‹ï¼Œå´ä¸€ç›´éƒ½æ²¡æœ‰å‘ç°åç»­éƒ¨åˆ†çš„è§£å¯†ç®—æ³•çš„èº«å½±ï¼Œéšåæˆ‘åˆä»”ç»†çš„çœ‹äº†ä¸€ä¸‹è°ƒç”¨çš„å‡½æ•°ï¼Œçªç„¶æœ‰äº†æƒŠå–œçš„å‘ç°ï¼Œè¿™é‡Œçš„ <code>pthread_mutex_lock</code>  ä¸å°±æ„å‘³ç€è¦ç”¨äº’æ–¥é”æ¥åˆ‡æ¢åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹äº†å—ï¼ï¼Ÿ</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call61<span class=\"token operator\">:</span><span class=\"token function\">sub_143848</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call62<span class=\"token operator\">:</span><span class=\"token function\">sub_1B66A8</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call63<span class=\"token operator\">:</span><span class=\"token function\">pthread_mutex_lock</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call64<span class=\"token operator\">:</span><span class=\"token function\">sub_143B48</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call65<span class=\"token operator\">:</span><span class=\"token function\">sub_1B66D0</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call66<span class=\"token operator\">:</span>pthread_mutex_unlock</pre></td></tr></table></figure><p>æˆ‘ä»¬ hook ä¸€ä¸‹ <code>sub_143848</code> , å¹¶åŒæ—¶æ‰“å°å‡º pid æ¥çœ‹çœ‹æ˜¯ä»€ä¹ˆæƒ…å†µ</p>\n<p><img data-src=\"/360-jiagu/image-20240307191208065.png\" alt=\"image-20240307191208065\" style=\"aspect-ratio:728 / 588;\"></p>\n<p>æœä¸å…¶ç„¶ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å‘ç°é™¤äº†ä¸»çº¿ç¨‹å¤–ï¼Œè¿˜æœ‰ä¸‰ä¸ªä¸åŒçš„çº¿ç¨‹è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°</p>\n<p><img data-src=\"/360-jiagu/image-20240307191316415.png\" alt=\"image-20240307191316415\" style=\"aspect-ratio:948 / 537;\"></p>\n<p>é‚£æˆ‘ä»¬åœ¨ pid å’Œä¸»çº¿ç¨‹ä¸åŒçš„æ—¶å€™ï¼Œç”¨ <code>stalker_trace_so</code>  çš„ <code>trace_so</code>  å‡½æ•°åœ¨å»çœ‹çœ‹ç©¶ç«Ÿè°ƒç”¨äº†ä»€ä¹ˆå‡½æ•°å§</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">var</span> stalker_trace_once <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x143848</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>main_thread<span class=\"token operator\">!==</span>Process<span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentThreadId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>stalker_trace_once<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                    stalker_trace_once <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                    <span class=\"token function\">trace_so</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æ‰“å°å‡ºçš„å†…å®¹å¦‚ä¸‹</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>main thread <span class=\"token number\">9434</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>start Stalker<span class=\"token operator\">!</span><span class=\"token punctuation\">,</span> pid<span class=\"token operator\">:</span> <span class=\"token number\">9472</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Stalker end<span class=\"token operator\">!</span>             </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call1<span class=\"token operator\">:</span><span class=\"token function\">sub_1B66A8</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call2<span class=\"token operator\">:</span><span class=\"token function\">pthread_mutex_lock</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call3<span class=\"token operator\">:</span><span class=\"token function\">sub_143B48</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call4<span class=\"token operator\">:</span><span class=\"token function\">memcmp</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call5<span class=\"token operator\">:</span><span class=\"token function\">sub_142EA0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call6<span class=\"token operator\">:</span><span class=\"token function\">sub_143A38</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call7<span class=\"token operator\">:</span><span class=\"token function\">sub_1B66D0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call8<span class=\"token operator\">:</span><span class=\"token function\">pthread_mutex_unlock</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call9<span class=\"token operator\">:</span><span class=\"token function\">memset</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call10<span class=\"token operator\">:</span><span class=\"token function\">inotify_add_watch</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call11<span class=\"token operator\">:</span><span class=\"token function\">sub_9AC4</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call12<span class=\"token operator\">:</span><span class=\"token function\">j_ffi_prep_cif</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call13<span class=\"token operator\">:</span><span class=\"token function\">ffi_prep_cif</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call14<span class=\"token operator\">:</span><span class=\"token function\">j_ffi_prep_cif_machdep</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call15<span class=\"token operator\">:</span><span class=\"token function\">ffi_prep_cif_machdep</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call16<span class=\"token operator\">:</span><span class=\"token function\">j_ffi_call</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call17<span class=\"token operator\">:</span><span class=\"token function\">ffi_call</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call18<span class=\"token operator\">:</span><span class=\"token function\">fopen</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call19<span class=\"token operator\">:</span><span class=\"token function\">sub_1674C</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call20<span class=\"token operator\">:</span><span class=\"token function\">j_ffi_call_SYSV</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call21<span class=\"token operator\">:</span><span class=\"token function\">ffi_call_SYSV</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call22<span class=\"token operator\">:</span><span class=\"token function\">sub_167BC</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call23<span class=\"token operator\">:</span><span class=\"token function\">sub_1647C</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call24<span class=\"token operator\">:</span><span class=\"token function\">sub_163DC</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call25<span class=\"token operator\">:</span><span class=\"token function\">sub_1178E8</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call26<span class=\"token operator\">:</span><span class=\"token function\">sub_9988</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call27<span class=\"token operator\">:</span><span class=\"token function\">sub_1236B8</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call28<span class=\"token operator\">:</span><span class=\"token function\">strlen</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call29<span class=\"token operator\">:</span><span class=\"token function\">sub_1222D0</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call30<span class=\"token operator\">:</span><span class=\"token function\">sub_128D70</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call31<span class=\"token operator\">:</span><span class=\"token function\">memcpy</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call32<span class=\"token operator\">:</span><span class=\"token function\">getenv</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call33<span class=\"token operator\">:</span><span class=\"token function\">sub_9E58</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call34<span class=\"token operator\">:</span><span class=\"token function\">j_lseek_1</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call35<span class=\"token operator\">:</span><span class=\"token function\">lseek</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call36<span class=\"token operator\">:</span><span class=\"token function\">sub_1A1AE8</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call37<span class=\"token operator\">:</span><span class=\"token function\">j_strcmp</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call38<span class=\"token operator\">:</span><span class=\"token function\">strcmp</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call39<span class=\"token operator\">:</span><span class=\"token function\">sub_19F7C4</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call40<span class=\"token operator\">:</span><span class=\"token function\">j__Znwm</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call41<span class=\"token operator\">:</span><span class=\"token function\">_Znwm</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call42<span class=\"token operator\">:</span><span class=\"token function\">malloc</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call43<span class=\"token operator\">:</span><span class=\"token function\">sub_1A1B64</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call44<span class=\"token operator\">:</span><span class=\"token function\">sub_9964</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call45<span class=\"token operator\">:</span><span class=\"token function\">sub_1A1B7C</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call46<span class=\"token operator\">:</span><span class=\"token function\">memset</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call47<span class=\"token operator\">:</span><span class=\"token function\">sub_1A1D84</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call48<span class=\"token operator\">:</span><span class=\"token function\">sub_1A1E74</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call49<span class=\"token operator\">:</span><span class=\"token function\">j_j__ZdlPv_12</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call50<span class=\"token operator\">:</span><span class=\"token function\">j__ZdlPv</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call51<span class=\"token operator\">:</span><span class=\"token function\">_ZdlPv</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call52<span class=\"token operator\">:</span><span class=\"token function\">free</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call53<span class=\"token operator\">:</span><span class=\"token function\">sub_18DC28</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call54<span class=\"token operator\">:</span><span class=\"token function\">sub_18DC4C</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call55<span class=\"token operator\">:</span><span class=\"token function\">sub_9FFC</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call56<span class=\"token operator\">:</span><span class=\"token function\">sub_19B7EC</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call57<span class=\"token operator\">:</span><span class=\"token function\">mmap</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call58<span class=\"token operator\">:</span><span class=\"token function\">sub_A3EC</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call59<span class=\"token operator\">:</span><span class=\"token function\">sub_9944</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call60<span class=\"token operator\">:</span><span class=\"token function\">sub_18DCC0</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call61<span class=\"token operator\">:</span><span class=\"token function\">sub_18F6AC</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call62<span class=\"token operator\">:</span><span class=\"token function\">sub_18DDA8</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call63<span class=\"token operator\">:</span><span class=\"token function\">sub_18DD94</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call64<span class=\"token operator\">:</span><span class=\"token function\">sub_18DDB8</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call65<span class=\"token operator\">:</span><span class=\"token function\">sub_18E8D0</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call66<span class=\"token operator\">:</span><span class=\"token function\">sub_18E244</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call67<span class=\"token operator\">:</span><span class=\"token function\">j_j__ZdlPv_5</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call68<span class=\"token operator\">:</span><span class=\"token function\">sub_129468</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call69<span class=\"token operator\">:</span><span class=\"token function\">sub_12D478</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call70<span class=\"token operator\">:</span><span class=\"token function\">sub_1A19EC</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call71<span class=\"token operator\">:</span><span class=\"token function\">raise</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call72<span class=\"token operator\">:</span><span class=\"token function\">j_lseek_2</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call73<span class=\"token operator\">:</span><span class=\"token function\">sub_9A90</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call74<span class=\"token operator\">:</span><span class=\"token function\">j_lseek_0</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">(</span>KEkeELF<span class=\"token punctuation\">)</span>call75<span class=\"token operator\">:</span><span class=\"token function\">j_lseek_3</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call76<span class=\"token operator\">:</span><span class=\"token function\">sub_19BC9C</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call77<span class=\"token operator\">:</span><span class=\"token function\">sub_11CF8C</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call78<span class=\"token operator\">:</span><span class=\"token function\">sub_131D58</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call79<span class=\"token operator\">:</span>memmove</pre></td></tr></table></figure><p>ç»§ç»­è·Ÿç€è°ƒç”¨çš„å‡½æ•°ä¸€å¤„ä¸€å¤„åˆ° ida é‡Œé¢çœ‹ï¼Œåœ¨ä¸‹é¢çš„å‡½æ•°ä¸­æˆ‘ä»¬ç»ˆäºæœ‰äº†æ”¶è·</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call45<span class=\"token operator\">:</span><span class=\"token function\">sub_1A1B7C</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call46<span class=\"token operator\">:</span><span class=\"token function\">memset</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call47<span class=\"token operator\">:</span><span class=\"token function\">sub_1A1D84</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call48<span class=\"token operator\">:</span>sub_1A1E74</pre></td></tr></table></figure><p>è¿™ä¸ªç®—æ³•ï¼Œçœ‹èµ·æ¥åˆæ˜¯ RC4 å‘</p>\n<p><img data-src=\"/360-jiagu/image-20240307191840395.png\" alt=\"image-20240307191840395\" style=\"aspect-ratio:999 / 749;\"></p>\n<p>hook ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼Œå‘ç°å¯†é’¥æ˜¯ <code>b&quot;\\x68\\x76\\x99\\x72\\x96\\x60\\x9f\\x63\\x96\\x2c\\x98\\x30\\xc2\\x36\\x51\\x42&quot;</code></p>\n<p><img data-src=\"/360-jiagu/image-20240307192203905.png\" alt=\"image-20240307192203905\" style=\"aspect-ratio:1171 / 392;\"></p>\n<p>å†å» hook  <code>sub_1A1E74</code>  çœ‹çœ‹ä¼ å…¥äº†ä»€ä¹ˆæ•°æ®ï¼Œæˆ‘ä»¬å‘ç°å‰ä¸‰éƒ¨åˆ†éƒ½æ˜¯ <code>f7 4f e8 0e</code>  å¼€å¤´çš„</p>\n<p><img data-src=\"/360-jiagu/image-20240307193744892.png\" alt=\"image-20240307193744892\" style=\"aspect-ratio:1200 / 819;\"></p>\n<p>çœ‹åˆ°è¿™äº›æ•°æ®ï¼Œç»ˆäºç¦»æˆåŠŸåˆæ›´è¿›ä¸€æ­¥äº†ï¼Œå› ä¸ºè¿™äº›æ•°æ®å°±æ˜¯æˆ‘ä»¬è¯»å–å®Œå£³ DEX å°¾éƒ¨çš„å‰ <code>0x41E</code>  ä¸ªåŠ å¯†æ•°æ®å¹¶è§£å¯†å‡ºé…ç½®ä¿¡æ¯ä¹‹åçš„é‚£éƒ¨åˆ†åŠ å¯†æ•°æ®ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ 010editor ä¸­é€šè¿‡æœç´¢å£³ DEX æ‰¾åˆ°å®ƒä»¬ï¼Œè¿™ä¸‰éƒ¨åˆ†åŠ å¯†æ•°æ®æ®µæ‰€åœ¨çš„ä½ç½®åˆ†åˆ«ä¸º <code>0x35CE</code> , <code>0x3A93AD</code> , <code>0x417064</code></p>\n<p><img data-src=\"/360-jiagu/image-20240307194101403.png\" alt=\"image-20240307194101403\" style=\"aspect-ratio:309 / 168;\"></p>\n<p>æˆ‘ä»¬å…ˆæ¥åˆ°ç¬¬ä¸€ä¸ªæ•°æ®æ®µçš„ä½ç½®æ¥åˆ†ææ•°æ®æ®µçš„ç»“æ„ï¼Œè¿™ä¸ªä½ç½®æ˜¯åœ¨ <code>0x31A4+0x41E</code> , å³ <code>0x35c2</code>  ä¹‹å</p>\n<p><img data-src=\"/360-jiagu/image-20240308004303427.png\" alt=\"image-20240308004303427\" style=\"aspect-ratio:1031 / 349;\"></p>\n<p>æ‰€ä»¥è¿™ dex çš„ç¬¬ä¸€ä¸ªè§£å¯†ç®—æ³•å¦‚ä¸‹</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">RC4</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    S <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    j <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    out <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\"># KSA Phase</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">256</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        j <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">+</span> S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> key<span class=\"token punctuation\">[</span>i <span class=\"token operator\">%</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\"># PRGA Phase</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    i <span class=\"token operator\">=</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    count <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">for</span> ch <span class=\"token keyword\">in</span> data<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        i <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        j <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">+</span> S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        out<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>ch <span class=\"token operator\">^</span> S<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> S<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">256</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">return</span> out</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">RC4decrypt</span><span class=\"token punctuation\">(</span>ciphertext<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">return</span> RC4<span class=\"token punctuation\">(</span>ciphertext<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>key <span class=\"token operator\">=</span> <span class=\"token string\">b\"\\x68\\x76\\x99\\x72\\x96\\x60\\x9f\\x63\\x96\\x2c\\x98\\x30\\xc2\\x36\\x51\\x42\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'com.oacia.apk_protect/classes.dex'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    enc_data <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>start <span class=\"token operator\">=</span> <span class=\"token number\">0x35C2</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>dexcount <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">.</span>from_bytes<span class=\"token punctuation\">(</span>enc_data<span class=\"token punctuation\">[</span>start<span class=\"token punctuation\">:</span>start<span class=\"token operator\">+</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string\">'little'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>start<span class=\"token operator\">+=</span><span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>dexcount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    total_data_len <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">.</span>from_bytes<span class=\"token punctuation\">(</span>enc_data<span class=\"token punctuation\">[</span>start<span class=\"token punctuation\">:</span>start<span class=\"token operator\">+</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string\">'little'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    start<span class=\"token operator\">+=</span><span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    rc4_data_len <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">.</span>from_bytes<span class=\"token punctuation\">(</span>enc_data<span class=\"token punctuation\">[</span>start<span class=\"token punctuation\">:</span>start<span class=\"token operator\">+</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string\">'little'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    start<span class=\"token operator\">+=</span><span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    enc_dex <span class=\"token operator\">=</span> enc_data<span class=\"token punctuation\">[</span>start<span class=\"token punctuation\">:</span>start<span class=\"token operator\">+</span>rc4_data_len<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    start<span class=\"token operator\">+=</span>rc4_data_len</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    dec_dex <span class=\"token operator\">=</span> RC4decrypt<span class=\"token punctuation\">(</span>enc_dex<span class=\"token punctuation\">,</span>key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    dec2_data_len <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">.</span>from_bytes<span class=\"token punctuation\">(</span>dec_dex<span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">:</span><span class=\"token number\">13</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token string\">'little'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'dex</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>i<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">.dex'</span></span><span class=\"token punctuation\">,</span><span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span>dec_dex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    extra <span class=\"token operator\">=</span> enc_data<span class=\"token punctuation\">[</span>start<span class=\"token punctuation\">:</span>start<span class=\"token operator\">+</span>total_data_len<span class=\"token operator\">-</span>rc4_data_len<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    extra_data_base <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">.</span>from_bytes<span class=\"token punctuation\">(</span>dec_dex<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">:</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'little'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    extra_data_len <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>extra<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    start<span class=\"token operator\">+=</span>total_data_len<span class=\"token operator\">-</span>rc4_data_len<span class=\"token operator\">-</span><span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"part</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">: total_data_len: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>total_data_len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">, rc4_data_len: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>rc4_data_len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"rc4_dec_part</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">: extra_data_base: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>extra_data_base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">,extra_data_len: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>extra_data_len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">, dec2_data_len: </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">hex</span><span class=\"token punctuation\">(</span>dec2_data_len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'dex</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>i<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">_extra.dex'</span></span><span class=\"token punctuation\">,</span><span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span>extra<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img data-src=\"/360-jiagu/image-20240308110813489.png\" alt=\"image-20240308110813489\" style=\"aspect-ratio:1370 / 203;\"></p>\n<p>ä½†æ˜¯å…‰è¿™è¿˜ä¸å¤Ÿï¼Œå› ä¸º rc4 è§£å¯†å‡ºæ¥çš„æ•°æ®ä»ç„¶ä¸æ˜¯ DEX æ ¼å¼</p>\n<p><img data-src=\"/360-jiagu/image-20240308005514430.png\" alt=\"image-20240308005514430\" style=\"aspect-ratio:791 / 222;\"></p>\n<p>ä¹‹åç»§ç»­è·Ÿç€å‡½æ•°è°ƒç”¨é“¾èµ°ï¼Œæ‰¾åˆ°è¿™äº›å‡½æ•°</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call60<span class=\"token operator\">:</span><span class=\"token function\">sub_18DCC0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call61<span class=\"token operator\">:</span><span class=\"token function\">sub_18F6AC</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call62<span class=\"token operator\">:</span><span class=\"token function\">sub_18DDA8</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call63<span class=\"token operator\">:</span><span class=\"token function\">sub_18DD94</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call64<span class=\"token operator\">:</span>sub_18DDB8</pre></td></tr></table></figure><p>åœ¨ <code>sub_18F6AC</code>  ä¸­çš„ä»£ç æ„Ÿè§‰å¾ˆåƒæ˜¯ç®—æ³•ç›¸å…³</p>\n<p><img data-src=\"/360-jiagu/image-20240308005825649.png\" alt=\"image-20240308005825649\" style=\"aspect-ratio:1123 / 715;\"></p>\n<p>é€šè¿‡ hook å…¶ä¸­çš„ <code>sub_18DDB8</code>  å‡½æ•°å‘ç° a3 æ˜¯ rc4 è§£å¯†ä¹‹åçš„ä» 0xc å¼€å§‹çš„æ•°æ®æ®µ</p>\n<p><img data-src=\"/360-jiagu/image-20240308010341488.png\" alt=\"image-20240308010341488\" style=\"aspect-ratio:1178 / 167;\"></p>\n<p><img data-src=\"/360-jiagu/image-20240308010411747.png\" alt=\"image-20240308010411747\" style=\"aspect-ratio:802 / 244;\"></p>\n<p>è€Œå‰é¢çš„ 0xc ä½é¢å¤–æ•°æ®çš„è¯»å–æ–¹å¼ä¸º 5+4+4, åœ¨ <code>sub_18DCC0</code>  ä¸­æœ‰è¯»å–æ“ä½œï¼Œé€šè¿‡è¿™æ ·çš„è¯»å–æ“ä½œæˆ‘ä»¬å¯ä»¥ä¾æ¬¡å¾—åˆ° <code>0x010000005D</code> , <code>0x400000</code> , <code>0x109492</code></p>\n<p><img data-src=\"/360-jiagu/image-20240308010524472.png\" alt=\"image-20240308010524472\" style=\"aspect-ratio:1015 / 418;\"></p>\n<p>è¿™é‡Œçš„ <code>0x109492</code>  è¡¨ç¤ºçš„æ˜¯ç¬¬äºŒæ¬¡è§£å¯†çš„æ•°æ®æ®µçš„å¤§å°ï¼Œé‚£ä¹ˆ <code>0x40000</code>  è¡¨ç¤ºä»€ä¹ˆå‘¢ï¼Ÿ</p>\n<p>è¿˜è®°å¾—æˆ‘ä»¬çš„åŠ å¯†æ•°æ®æ®µæ˜¯æœ‰å‰åä¸¤éƒ¨åˆ†çš„å˜›ï¼Œå‰åŠéƒ¨åˆ†ç”¨ rc4 è§£å¯†ï¼Œé‚£ä¹ˆååŠéƒ¨åˆ†æˆ‘ä»¬æ¥çœ‹çœ‹é•¿ä»€ä¹ˆæ ·å­å¥½äº†</p>\n<p><img data-src=\"/360-jiagu/image-20240308011028793.png\" alt=\"image-20240308011028793\" style=\"aspect-ratio:797 / 383;\"></p>\n<p>ååŠéƒ¨åˆ†çš„æ•°æ®çœ‹èµ·æ¥ååˆ†çš„è§„æ•´ï¼Œä¸åƒæ˜¯æœ‰åŠ å¯†çš„æ ·å­</p>\n<p>è€Œåœ¨<strong>ä¸» DEX åŠ è½½æµç¨‹åˆ†æ</strong>ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸçš„ dump å‡ºäº†ä¸» DEX, é‚£ä¹ˆæˆ‘ä»¬ä¸å¦¨æŠŠè¿™ä¸ªè¿™é‡Œçš„æ•°æ®åˆ°ä¸» DEX ä¸­æœç´¢ä¸€ç•ªçœ‹çœ‹æœ‰ä»€ä¹ˆå‘ç°å§</p>\n<p>åœ¨ä¸» DEX ä¸­æœç´¢ç¬¬ä¸€è¡Œçš„å­—èŠ‚ï¼Œæˆ‘ä»¬æƒŠå–œçš„å‘ç°ç«Ÿç„¶å¯ä»¥æœç´¢åˆ°ï¼Œå¹¶ä¸”å®ƒçš„ä½ç½®æ­£å¥½å°±æ˜¯ <code>0x400000</code> !</p>\n<p><img data-src=\"/360-jiagu/image-20240308011259938.png\" alt=\"image-20240308011259938\" style=\"aspect-ratio:829 / 332;\"></p>\n<p>æ‰€ä»¥è¯´ç»è¿‡ RC4 è§£å¯†ä¹‹åçš„è¿™éƒ¨åˆ†çš„æ•°æ®ç»“æ„æˆ‘ä»¬ä¹Ÿå°±å¯ä»¥çŸ¥é“äº†</p>\n<p><img data-src=\"/360-jiagu/image-20240308011627096.png\" alt=\"image-20240308011627096\" style=\"aspect-ratio:793 / 310;\"></p>\n<p>æ¥ä¸‹æ¥æˆ‘ä»¬åªè¦ææ¸…æ¥šåœ¨ <code>sub_18DDB8</code>  ä¸­ç¬¬äºŒæ¬¡è§£å¯†çš„ç®—æ³•æ˜¯ä»€ä¹ˆå°±å¯ä»¥äº†</p>\n<p>æˆ‘ä»¬å†å›åˆ°åˆ†æçš„èµ·ç‚¹ <code>sub_128D44</code>  å‡½æ•°ï¼Œæ¥çœ‹çœ‹èƒ½ä¸èƒ½æœ‰å…¶ä»–çš„å‘ç°</p>\n<p><img data-src=\"/360-jiagu/image-20240308012120417.png\" alt=\"image-20240308012120417\" style=\"aspect-ratio:1071 / 141;\"></p>\n<p>é€šè¿‡ hook  <code>sub_128D44</code>  çš„è¿”å›å€¼ v150 ä¹‹åå‘ç°ï¼Œä¸‰çº§æŒ‡é’ˆæŒ‡å‘ç€è§£å¯†ä¹‹åçš„ dex</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">hexdump</span><span class=\"token punctuation\">(</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span><span class=\"token function\">ptr</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x0<span class=\"token punctuation\">.</span><span class=\"token function\">readS64</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readS64</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">readS64</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token literal-property property\">offset</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// ç›¸å¯¹åç§»</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token literal-property property\">length</span><span class=\"token operator\">:</span> <span class=\"token number\">0x40</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//dump çš„å¤§å°</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token literal-property property\">header</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token literal-property property\">ansi</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><img data-src=\"/360-jiagu/image-20240308012312135.png\" alt=\"image-20240308012312135\" style=\"aspect-ratio:1191 / 172;\"></p>\n<p>è€Œå€˜è‹¥æˆ‘ä»¬è§‚å¯Ÿè¿™ä¸ªè§£å¯†æ•°æ®æ‰€åœ¨çš„å†…å­˜ <code>703bc75000</code> , å®ƒæ­£å¥½æ˜¯ <code>0x1000</code>  çš„å€æ•°ï¼Œè€Œ <code>0x1000</code>  æ­£å¥½å°±æ˜¯ä¸€é¡µçš„å¤§å°</p>\n<p>è¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿ</p>\n<p>è¿™è¯´æ˜ dex æ‰€åœ¨çš„å†…å­˜ææœ‰å¯èƒ½æ˜¯é€šè¿‡ <code>mmap</code>  å‡½æ•°åˆ†é…çš„ï¼</p>\n<p>è€Œåœ¨ <code>stalker_trace_so</code>  æ‰“å°çš„æ•°æ®ä¸­ï¼Œæ­£å¥½å°±æœ‰è¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨äº†</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span>mainELF<span class=\"token punctuation\">)</span>call57<span class=\"token operator\">:</span>mmap</pre></td></tr></table></figure><p>äºæ˜¯æˆ‘ä»¬æ¥åˆ° mmap è¢«è°ƒç”¨çš„å‡½æ•°</p>\n<p><img data-src=\"/360-jiagu/image-20240308012704595.png\" alt=\"image-20240308012704595\" style=\"aspect-ratio:688 / 359;\"></p>\n<p>ä½¿ç”¨ frida hook mmap è¿”å›çš„å†…å­˜æŒ‡é’ˆï¼Œç„¶åæ‰“ä¸Šå†…å­˜è¯»å†™æ–­ç‚¹ï¼Œå°±å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½åˆ°æœ€ç»ˆè§£å¯†ç®—æ³•å®Œæˆä¹‹åèµ‹å€¼çš„åœ°å€</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook_mmap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libjiagu_64.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    Interceptor<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x19B81C</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token comment\">// fd, buff, len</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token function-variable function\">onEnter</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mmap!\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            MemoryAccessMonitor<span class=\"token punctuation\">.</span><span class=\"token function\">enable</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    <span class=\"token literal-property property\">base</span><span class=\"token operator\">:</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span>x0<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                    <span class=\"token literal-property property\">size</span><span class=\"token operator\">:</span><span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                    <span class=\"token function-variable function\">onAccess</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">details</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>details<span class=\"token punctuation\">.</span>operation<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">get_addr_in_so</span><span class=\"token punctuation\">(</span>details<span class=\"token punctuation\">.</span>from<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token function-variable function\">onLeave</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">get_addr_in_so</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">addr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">var</span> process_Obj_Module_Arr <span class=\"token operator\">=</span> Process<span class=\"token punctuation\">.</span><span class=\"token function\">enumerateModules</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> process_Obj_Module_Arr<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>addr<span class=\"token operator\">></span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>base <span class=\"token operator\">&amp;&amp;</span> addr<span class=\"token operator\">&lt;</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token keyword\">return</span> addr<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token string\">\" is in \"</span><span class=\"token operator\">+</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token operator\">+</span><span class=\"token string\">\" offset: 0x\"</span><span class=\"token operator\">+</span><span class=\"token punctuation\">(</span>addr<span class=\"token operator\">-</span>process_Obj_Module_Arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">return</span> addr<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>åœ¨ <code>0x18ebd4</code>  ä¸­å°†å€¼å†™å…¥æœ€ç»ˆçš„ç›®æ ‡å†…å­˜ï¼Œè¿™ä¸ªåœ°å€åœ¨ <code>sub_18E8D0</code>  ä¸­</p>\n<p><img data-src=\"/360-jiagu/image-20240308014607722.png\" alt=\"image-20240308014607722\" style=\"aspect-ratio:737 / 132;\"></p>\n<p><img data-src=\"/360-jiagu/image-20240308012938693.png\" alt=\"image-20240308012938693\" style=\"aspect-ratio:532 / 211;\"></p>\n<p>åœ¨è¿™ä¸ªå‡½æ•°çš„å¼€å¤´ï¼Œæœ‰å¯¹å‚æ•° a1 çš„è¯»å–æ“ä½œ</p>\n<p><img data-src=\"/360-jiagu/image-20240308112313375.png\" alt=\"image-20240308112313375\" style=\"aspect-ratio:560 / 429;\"></p>\n<p>æˆ‘ä»¬ hook ä¸€ä¸‹å€¼æ¥çœ‹çœ‹ a1 å„ä¸ªéƒ¨åˆ†éƒ½æœ‰ä»€ä¹ˆå«ä¹‰</p>\n<p><img data-src=\"/360-jiagu/image-20240308112226813.png\" alt=\"image-20240308112226813\" style=\"aspect-ratio:1198 / 581;\"></p>\n<p><img data-src=\"/360-jiagu/image-20240308112237431.png\" alt=\"image-20240308112237431\" style=\"aspect-ratio:1408 / 457;\"></p>\n<p>ç»™ a1 å†™ä¸€ä¸ªç»“æ„ä½“å¥½äº†</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">dec2_struct</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">long</span> <span class=\"token keyword\">long</span> shift_bit<span class=\"token punctuation\">;</span><span class=\"token comment\">// ç§»ä½çš„ä½æ•°</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">int</span> reversed0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">int</span> reversed1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">long</span> <span class=\"token keyword\">long</span> constA<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">long</span> <span class=\"token keyword\">long</span> dest<span class=\"token punctuation\">;</span><span class=\"token comment\">// è§£å¯†åçš„ dex å­˜å‚¨çš„åœ°å€</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">long</span> <span class=\"token keyword\">long</span> constB<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">long</span> <span class=\"token keyword\">long</span> constC<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">long</span> <span class=\"token keyword\">long</span> index<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">long</span> <span class=\"token keyword\">long</span> extra_dex_base<span class=\"token punctuation\">;</span><span class=\"token comment\">// é¢å¤–æ•°æ®å°†è¦å¤åˆ¶åˆ°çš„åŸºå€</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">int</span> guess_count2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">int</span> reversed2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">int</span> flag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">int</span> key<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">int</span> reversed3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">int</span> reversed4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">int</span> reversed5<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">int</span> data_len<span class=\"token punctuation\">;</span><span class=\"token comment\">// è®°å½•é¢å¤–æ•°æ®çš„é•¿åº¦</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">int</span> input_read_index<span class=\"token punctuation\">;</span><span class=\"token comment\">// è®°å½•è¯»å–è¾“å…¥çš„åŠ å¯†æ•°æ®çš„ä¸‹æ ‡</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> data<span class=\"token punctuation\">[</span><span class=\"token number\">0x112</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// è®°å½•é¢å¤–æ•°æ®</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æœ€åå¸¦ç€æˆ‘ä»¬çš„ç»“æ„ä½“é€›é€›è¿™ä¸ªè§£å¯†ç®—æ³•çš„å‡½æ•°å¥½å’¯</p>\n<p>sub_18F6AC</p>\n<p><img data-src=\"/360-jiagu/image-20240309004158571.png\" alt=\"image-20240309004158571\" style=\"aspect-ratio:1044 / 623;\"></p>\n<p>sub_18DDB8</p>\n<p><img data-src=\"/360-jiagu/image-20240309004238199.png\" alt=\"image-20240309004238199\" style=\"aspect-ratio:1413 / 766;\"></p>\n<p>sub_18E244</p>\n<p><img data-src=\"/360-jiagu/image-20240309004324883.png\" alt=\"image-20240309004324883\" style=\"aspect-ratio:1186 / 669;\"></p>\n<p>sub_18E8D0</p>\n<p><img data-src=\"/360-jiagu/image-20240309004410712.png\" alt=\"image-20240309004410712\" style=\"aspect-ratio:1635 / 623;\"></p>\n<p>è¿™äº›å‡½æ•°æ— å£³æ— èŠ±æ— æ‰“ä¹±ï¼Œä¹Ÿæ²¡æœ‰ vmp åŠ å›ºï¼Œæ˜¾å¾—ç›¸å½“çš„å¹²å‡€ï¼Œçœ‹èµ·æ¥æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ç®—æ³•</p>\n<p>ç®—æ³•åƒå˜ä¸‡åŒ–ï¼Œä½†æ˜¯åŠ å›ºæ°¸è¿œä¸æ˜¯é‡åœ¨ç®—æ³•</p>\n<p>é€†å‘ä¸€æ¬¾ä¼˜ç§€çš„åŠ å›ºå£³ï¼Œä»ä¸­å­¦ä¹ åˆ°çš„çŸ¥è¯†å¯ä»¥å—ç›Šç»ˆç”Ÿï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å€Ÿæ­¤æ€è€ƒå¦‚ä½•é¿å…è®©åˆ«äººè½»æ˜“æ‰¾åˆ°åŠ å›ºæ–¹æ¡ˆçš„çªç ´å£</p>\n<p>é€¢å±±å¼€è·¯ï¼Œé‡æ°´æ­æ¡¥ã€‚å…µæ¥å°†æŒ¡ï¼Œæ°´æ¥åœŸæ©ã€‚</p>\n<p>æˆ‘ä»¬æœ€åæ¥ hook ä¸€ä¸‹ä¸‹é¢è¿™ä¸ªåœ°æ–¹æ¥ä¸ºæˆ‘ä»¬çš„åˆ†æç”»ä¸Šåœ†æ»¡çš„å¥å·å§</p>\n<p><img data-src=\"/360-jiagu/image-20240309011700849.png\" alt=\"image-20240309011700849\" style=\"aspect-ratio:939 / 265;\"></p>\n<p><img data-src=\"/360-jiagu/image-20240309013111976.png\" alt=\"image-20240309013111976\" style=\"aspect-ratio:558 / 225;\"></p>\n<p>è‡³æ­¤ï¼Œ360 åŠ å›ºåˆ†æå®Œæ¯•</p>\n<h1 id=\"æ€»ç»“\"><a class=\"anchor\" href=\"#æ€»ç»“\">#</a> æ€»ç»“</h1>\n<p>360 åŠ å›ºå’Œå¸¸è§„çš„åŠ å›ºæ–¹æ¡ˆç±»ä¼¼ï¼Œéƒ½æ˜¯ <code>å£³DEX-&gt;å£³ELF-&gt;ä¸»ELF-&gt;ä¸»DEX</code>  è¿™æ ·çš„è¿‡ç¨‹ï¼Œå…¶ä¸­å£³ ELF è§£å¯†ä¸» ELF æ‰€ç”¨åˆ°çš„ç®—æ³•æ˜¯ <code>RC4</code>  å’Œ <code>uncompress</code> , å£³ ELF åŠ è½½ä¸» ELF æ‰€ç”¨åˆ°çš„æŠ€æœ¯æ˜¯è‡ªå®ç° linker åŠ å›º so</p>\n<p>å½“ç„¶ 360 åŠ å›ºè¿˜æœ‰è®¸å¤šå€¼å¾—ç»§ç»­ç ”ç©¶åˆ†æçš„åœ°æ–¹ï¼Œä¾‹å¦‚åˆ†å‘ so å‡½æ•°çš„ vmp å…¶å†…éƒ¨é€»è¾‘ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ ·å­å‘¢ï¼Ÿnative åŒ–çš„ <code>onCreate</code>  å‡½æ•°ï¼Œdex2c çš„åŸç†ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>\n<p>æœˆé‡ä»äº‘ï¼ŒèŠ±é‡å’Œé£ï¼Œä»Šæ™šä¸Šçš„å¤œç©ºå¾ˆç¾</p>\n<h1 id=\"å‚è€ƒèµ„æ–™\"><a class=\"anchor\" href=\"#å‚è€ƒèµ„æ–™\">#</a> å‚è€ƒèµ„æ–™</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNzcxNjkubmV0L2h0bWwvMTcwNzI0Lmh0bWw=\">360 åŠ å›ºä¿å…³é”®æŠ€æœ¯æµ…æ</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jcnlwdGF4Lm1lZGl1bS5jb20vZGVjcnlwdGluZy1zdHJpbmdzLXdpdGgtYS1qZWItc2NyaXB0LTFhZjUyMmZhNDk3OQ==\">Decrypting strings with a JEB script</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vcmV2ZXJjYy9wLzE3MTAwMzA4Lmh0bWw=\">è‡ªå®ç° linker åŠ å›º so</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjYwMDQ5Lmh0bQ==\">360 åŠ å›ºä¿åˆ†æ</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjc1ODExLmh0bQ==\">è¯¯å…¥è™ç©´ï¼Œå–œå¾—è™å­ â€”â€” è®°ä¸€æ¬¡æ‰‹æ¸¸åŠ å›ºçš„è„±å£³ä¸ä¿®å¤</span></li>\n</ul>\n",
            "tags": []
        },
        {
            "id": "https://oacia.dev/ElfReader/",
            "url": "https://oacia.dev/ElfReader/",
            "title": "ELFç»“æ„åˆ†æåŠElfReader",
            "date_published": "2024-02-17T06:11:23.000Z",
            "content_html": "<p>åœ¨ Android ä¸­ä½¿ç”¨ <code>System.load</code>  åŠ è½½ä¸€ä¸ª so æ—¶ï¼Œæ˜¯é€šè¿‡ <code>ElfReader</code>  å»è§£æè¿™ä¸ª so çš„é‡è¦ç»“æ„åŠå±æ€§çš„ï¼Œæœ¬æ–‡å°†å¯¹ ELF çš„ç»“æ„ï¼Œé“¾æ¥è¿‡ç¨‹ï¼Œè£…è½½è¿‡ç¨‹è¿›è¡Œåˆ†æï¼Œå¹¶ç ”ç©¶ ELF åœ¨ AOSP ä¸­çš„è§£æè¿‡ç¨‹</p>\n<h1 id=\"elfç»“æ„ç®€æ\"><a class=\"anchor\" href=\"#elfç»“æ„ç®€æ\">#</a> ELF ç»“æ„ç®€æ</h1>\n<p>ELF æ–‡ä»¶ä¸»è¦åˆ†ä¸º 3 ä¸ªéƒ¨åˆ†:</p>\n<ul>\n<li>ELF Header<br>\n æè¿°æ•´ä¸ªæ–‡ä»¶çš„ç»„ç»‡</li>\n<li>Program Header Table<br>\n åŒ…å«äº†<strong>è¿è¡Œæ—¶</strong>åŠ è½½ç¨‹åºæ‰€éœ€è¦çš„ä¿¡æ¯</li>\n<li>Section Header Table<br>\n åŒ…å«äº†<strong>é“¾æ¥æ—¶</strong>æ‰€éœ€è¦ç”¨åˆ°çš„ä¿¡æ¯</li>\n</ul>\n<h2 id=\"elf-header\"><a class=\"anchor\" href=\"#elf-header\">#</a> ELF Header</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//https://github.com/bminor/glibc/blob/glibc-2.27/elf/elf.h</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">EI_NIDENT</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span>\te_ident<span class=\"token punctuation\">[</span>EI_NIDENT<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Magic number and other info */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  Elf32_Half\te_type<span class=\"token punctuation\">;</span>\t\t\t<span class=\"token comment\">/* Object file type */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  Elf32_Half\te_machine<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Architecture */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  Elf32_Word\te_version<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Object file version */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  Elf32_Addr\te_entry<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Entry point virtual address */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  Elf32_Off\te_phoff<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Program header table file offset */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  Elf32_Off\te_shoff<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section header table file offset */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  Elf32_Word\te_flags<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Processor-specific flags */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  Elf32_Half\te_ehsize<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* ELF header size in bytes */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  Elf32_Half\te_phentsize<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Program header table entry size */</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  Elf32_Half\te_phnum<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Program header table entry count */</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  Elf32_Half\te_shentsize<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section header table entry size */</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  Elf32_Half\te_shnum<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section header table entry count */</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  Elf32_Half\te_shstrndx<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section header string table index */</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Ehdr<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"e_identei_nident\"><a class=\"anchor\" href=\"#e_identei_nident\">#</a> e_ident[EI_NIDENT]</h3>\n<p>è¯¥å˜é‡ç»™å‡ºäº†ç”¨äºè§£ç å’Œè§£é‡Šæ–‡ä»¶ä¸­ä¸æœºå™¨æ— å…³çš„æ•°æ®çš„æ–¹å¼ã€‚è¿™ä¸ªæ•°ç»„å¯¹äºä¸åŒçš„ä¸‹æ ‡çš„å«ä¹‰å¦‚ä¸‹</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">å®åç§°</th>\n<th style=\"text-align:left\">ä¸‹æ ‡</th>\n<th style=\"text-align:left\">ç›®çš„</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">EI_MAG0</td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">æ–‡ä»¶æ ‡è¯†</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EI_MAG1</td>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">æ–‡ä»¶æ ‡è¯†</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EI_MAG2</td>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">æ–‡ä»¶æ ‡è¯†</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EI_MAG3</td>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\">æ–‡ä»¶æ ‡è¯†</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EI_CLASS</td>\n<td style=\"text-align:left\">4</td>\n<td style=\"text-align:left\">æ–‡ä»¶ç±»</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EI_DATA</td>\n<td style=\"text-align:left\">5</td>\n<td style=\"text-align:left\">æ•°æ®ç¼–ç </td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EI_VERSION</td>\n<td style=\"text-align:left\">6</td>\n<td style=\"text-align:left\">æ–‡ä»¶ç‰ˆæœ¬</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EI_PAD</td>\n<td style=\"text-align:left\">7</td>\n<td style=\"text-align:left\">è¡¥é½å­—èŠ‚å¼€å§‹å¤„</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"e_identei_mag0ei_mag3\"><a class=\"anchor\" href=\"#e_identei_mag0ei_mag3\">#</a> e_ident[EI_MAG0â€¦EI_MAG3]</h4>\n<p>è¿™æ˜¯ ELF æ–‡ä»¶çš„å¤´ 4 ä¸ªå­—èŠ‚ï¼Œè¢«ç§°ä½œ â€œé­”æ•°â€ï¼Œæ ‡è¯†è¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ª ELF ç›®æ ‡æ–‡ä»¶ã€‚</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">åç§°</th>\n<th style=\"text-align:left\">å€¼</th>\n<th style=\"text-align:left\">ä½ç½®</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">ELFMAG0</td>\n<td style=\"text-align:left\">0x7f</td>\n<td style=\"text-align:left\">e_ident[EI_MAG0]</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ELFMAG1</td>\n<td style=\"text-align:left\">â€˜Eâ€™</td>\n<td style=\"text-align:left\">e_ident[EI_MAG1]</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ELFMAG2</td>\n<td style=\"text-align:left\">â€˜Lâ€™</td>\n<td style=\"text-align:left\">e_ident[EI_MAG2]</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ELFMAG3</td>\n<td style=\"text-align:left\">â€˜Fâ€™</td>\n<td style=\"text-align:left\">e_ident[EI_MAG3]</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"e_identei_class\"><a class=\"anchor\" href=\"#e_identei_class\">#</a> e_ident[EI_CLASS]</h4>\n<p>æ ‡è¯†æ–‡ä»¶çš„ç±»å‹æˆ–å®¹é‡</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">åç§°</th>\n<th style=\"text-align:left\">å€¼</th>\n<th style=\"text-align:left\">æ„ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">ELFCLASSNONE</td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">æ— æ•ˆç±»å‹</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ELFCLASS32</td>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">32 ä½æ–‡ä»¶</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ELFCLASS64</td>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">64 ä½æ–‡ä»¶</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"e_identei_data\"><a class=\"anchor\" href=\"#e_identei_data\">#</a> e_ident[EI_DATA]</h4>\n<p>ç»™å‡ºç›®æ ‡æ–‡ä»¶ä¸­çš„ç‰¹å®šå¤„ç†å™¨æ•°æ®çš„ç¼–ç æ–¹å¼</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">åç§°</th>\n<th style=\"text-align:left\">å€¼</th>\n<th style=\"text-align:left\">æ„ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">ELFDATANONE</td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">æ— æ•ˆæ•°æ®ç¼–ç </td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ELFDATA2LSB</td>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">å°ç«¯</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ELFDATA2MSB</td>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">å¤§ç«¯</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"e_type\"><a class=\"anchor\" href=\"#e_type\">#</a> e_type</h3>\n<p><code>e_type</code>  æ ‡è¯†ç›®æ ‡æ–‡ä»¶ç±»å‹ã€‚</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">åç§°</th>\n<th style=\"text-align:left\">å€¼</th>\n<th style=\"text-align:left\">æ„ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">ET_NONE</td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">æ— æ–‡ä»¶ç±»å‹</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ET_REL</td>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">å¯é‡å®šä½æ–‡ä»¶</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ET_EXEC</td>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">å¯æ‰§è¡Œæ–‡ä»¶</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ET_DYN</td>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\">å…±äº«ç›®æ ‡æ–‡ä»¶</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ET_CORE</td>\n<td style=\"text-align:left\">4</td>\n<td style=\"text-align:left\">æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ET_LOPROC</td>\n<td style=\"text-align:left\">0xff00</td>\n<td style=\"text-align:left\">å¤„ç†å™¨æŒ‡å®šä¸‹é™</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ET_HIPROC</td>\n<td style=\"text-align:left\">0xffff</td>\n<td style=\"text-align:left\">å¤„ç†å™¨æŒ‡å®šä¸Šé™</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"e_machine\"><a class=\"anchor\" href=\"#e_machine\">#</a> e_machine</h3>\n<p>è¿™ä¸€é¡¹æŒ‡å®šäº†å½“å‰æ–‡ä»¶å¯ä»¥è¿è¡Œçš„æœºå™¨æ¶æ„ï¼ŒEM æ˜¯  <code>ELF Machine</code>  çš„ç®€å†™</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">åç§°</th>\n<th style=\"text-align:left\">å€¼</th>\n<th style=\"text-align:left\">æ„ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">EM_NONE</td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">æ— æœºå™¨ç±»å‹</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EM_M32</td>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">AT&amp;T WE 32100</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EM_SPARC</td>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">SPARC</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EM_386</td>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\">Intel 80386</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EM_68K</td>\n<td style=\"text-align:left\">4</td>\n<td style=\"text-align:left\">Motorola 68000</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EM_88K</td>\n<td style=\"text-align:left\">5</td>\n<td style=\"text-align:left\">Motorola 88000</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EM_860</td>\n<td style=\"text-align:left\">7</td>\n<td style=\"text-align:left\">Intel 80860</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EM_MIPS</td>\n<td style=\"text-align:left\">8</td>\n<td style=\"text-align:left\">MIPS RS3000</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"e_version\"><a class=\"anchor\" href=\"#e_version\">#</a> e_version</h3>\n<p>æ ‡è¯†ç›®æ ‡æ–‡ä»¶çš„ç‰ˆæœ¬ã€‚</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">åç§°</th>\n<th style=\"text-align:left\">å€¼</th>\n<th style=\"text-align:left\">æ„ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">EV_NONE</td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">æ— æ•ˆç‰ˆæœ¬</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">EV_CURRENT</td>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">å½“å‰ç‰ˆæœ¬</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"e_entry\"><a class=\"anchor\" href=\"#e_entry\">#</a> e_entry</h3>\n<p>è¿™ä¸€é¡¹ä¸ºç³»ç»Ÿè½¬äº¤æ§åˆ¶æƒç»™ ELF ä¸­ç›¸åº”ä»£ç çš„è™šæ‹Ÿåœ°å€ã€‚å¦‚æœæ²¡æœ‰ç›¸å…³çš„å…¥å£é¡¹ï¼Œåˆ™è¿™ä¸€é¡¹ä¸º 0ã€‚</p>\n<p>ä¾‹å¦‚å½“ <code>e_entry</code>  ä¸º <code>00 00 80 00</code>  æ—¶ï¼Œå¾—åˆ°å¯æ‰§è¡Œç¨‹åºçš„å…¥å£åœ°å€ä¸º <code>0x8000</code></p>\n<p>å®ƒæ˜¯ç¨‹åºçš„å…¥å£è™šæ‹Ÿåœ°å€ï¼Œæ³¨æ„ä¸æ˜¯ main å‡½æ•°çš„åœ°å€ï¼Œè€Œæ˜¯ <code>.text</code>  æ®µçš„é¦–åœ°å€ <code>_start</code> ã€‚å½“ç„¶è¿™ä¹Ÿè¦æ±‚ç¨‹åºæœ¬èº«é PIE ( <code>-no-pie</code> ) ç¼–è¯‘çš„ä¸” ASLR å…³é—­çš„æƒ…å†µä¸‹ï¼Œå¯¹äºé <code>ET_EXEC</code>  ç±»å‹é€šå¸¸å¹¶ä¸æ˜¯å®é™…çš„è™šæ‹Ÿåœ°å€å€¼.</p>\n<h3 id=\"e_phoff\"><a class=\"anchor\" href=\"#e_phoff\">#</a> e_phoff</h3>\n<p>è¿™ä¸€é¡¹ç»™å‡º<strong>ç¨‹åºå¤´éƒ¨è¡¨</strong>åœ¨æ–‡ä»¶ä¸­çš„å­—èŠ‚åç§»ï¼ˆ<strong>Program Header table OFFset</strong>ï¼‰ã€‚å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰ç¨‹åºå¤´éƒ¨è¡¨ï¼Œåˆ™ä¸º 0ã€‚</p>\n<h3 id=\"e_shoff\"><a class=\"anchor\" href=\"#e_shoff\">#</a> e_shoff</h3>\n<p>è¿™ä¸€é¡¹ç»™å‡º<strong>èŠ‚å¤´è¡¨</strong>åœ¨æ–‡ä»¶ä¸­çš„å­—èŠ‚åç§»ï¼ˆ <strong>Section Header table OFFset</strong> ï¼‰ã€‚å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰èŠ‚å¤´è¡¨ï¼Œåˆ™ä¸º 0ã€‚</p>\n<h3 id=\"e_flags\"><a class=\"anchor\" href=\"#e_flags\">#</a> e_flags</h3>\n<p>è¿™ä¸€é¡¹ç»™å‡ºæ–‡ä»¶ä¸­ä¸ç‰¹å®šå¤„ç†å™¨ç›¸å…³çš„æ ‡å¿—ï¼Œè¿™äº›æ ‡å¿—å‘½åæ ¼å¼ä¸º <code>EF_machine_flag</code> ã€‚</p>\n<h3 id=\"e_ehsize\"><a class=\"anchor\" href=\"#e_ehsize\">#</a> e_ehsize</h3>\n<p>è¿™ä¸€é¡¹ç»™å‡º ELF æ–‡ä»¶å¤´éƒ¨çš„å­—èŠ‚é•¿åº¦ï¼ˆELF Header Sizeï¼‰ã€‚</p>\n<h3 id=\"e_phentsize\"><a class=\"anchor\" href=\"#e_phentsize\">#</a> e_phentsize</h3>\n<p>è¿™ä¸€é¡¹ç»™å‡ºç¨‹åºå¤´éƒ¨è¡¨ä¸­æ¯ä¸ªè¡¨é¡¹çš„å­—èŠ‚é•¿åº¦ï¼ˆ<strong>Program Header ENTry SIZE</strong>ï¼‰ã€‚æ¯ä¸ªè¡¨é¡¹çš„å¤§å°ç›¸åŒã€‚</p>\n<h3 id=\"e_phnum\"><a class=\"anchor\" href=\"#e_phnum\">#</a> e_phnum</h3>\n<p>è¿™ä¸€é¡¹ç»™å‡ºç¨‹åºå¤´éƒ¨è¡¨çš„é¡¹æ•°ï¼ˆ <strong>Program Header entry NUMber</strong> ï¼‰ã€‚å› æ­¤ï¼Œ <code>e_phnum</code>  ä¸  <code>e_phentsize</code>  çš„ä¹˜ç§¯å³ä¸ºç¨‹åºå¤´éƒ¨è¡¨çš„å­—èŠ‚é•¿åº¦ã€‚å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰ç¨‹åºå¤´éƒ¨è¡¨ï¼Œåˆ™è¯¥é¡¹å€¼ä¸º 0ã€‚</p>\n<h3 id=\"e_shentsize\"><a class=\"anchor\" href=\"#e_shentsize\">#</a> e_shentsize</h3>\n<p>è¿™ä¸€é¡¹ç»™å‡ºèŠ‚å¤´çš„å­—èŠ‚é•¿åº¦ï¼ˆ<strong>Section Header ENTry SIZE</strong>ï¼‰ã€‚ä¸€ä¸ªèŠ‚å¤´æ˜¯èŠ‚å¤´è¡¨ä¸­çš„ä¸€é¡¹ï¼›èŠ‚å¤´è¡¨ä¸­æ‰€æœ‰é¡¹å æ®çš„ç©ºé—´å¤§å°ç›¸åŒã€‚</p>\n<h3 id=\"e_shnum\"><a class=\"anchor\" href=\"#e_shnum\">#</a> e_shnum</h3>\n<p>è¿™ä¸€é¡¹ç»™å‡ºèŠ‚å¤´è¡¨ä¸­çš„é¡¹æ•°ï¼ˆ<strong>Section Header NUMber</strong>ï¼‰ã€‚å› æ­¤ï¼Œ  <code>e_shnum</code>  ä¸  <code>e_shentsize</code>  çš„ä¹˜ç§¯å³ä¸ºèŠ‚å¤´è¡¨çš„å­—èŠ‚é•¿åº¦ã€‚å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰èŠ‚å¤´è¡¨ï¼Œåˆ™è¯¥é¡¹å€¼ä¸º 0ã€‚</p>\n<h3 id=\"e_shstrndx\"><a class=\"anchor\" href=\"#e_shstrndx\">#</a> e_shstrndx</h3>\n<p>è¿™ä¸€é¡¹ç»™å‡ºèŠ‚å¤´è¡¨ä¸­ä¸èŠ‚åå­—ç¬¦ä¸²è¡¨ç›¸å…³çš„è¡¨é¡¹çš„ç´¢å¼•å€¼ï¼ˆ<strong>Section Header table InDeX related with section name STRing table</strong>ï¼‰, å³ section table ä¸­çš„ç¬¬<em> e_shstrndx</em> é¡¹å…ƒç´ ï¼Œä¿å­˜äº†æ‰€æœ‰ section table åç§°çš„å­—ç¬¦ä¸²ä¿¡æ¯ã€‚å¦‚æœæ–‡ä»¶ä¸­æ²¡æœ‰èŠ‚åå­—ç¬¦ä¸²è¡¨ï¼Œåˆ™è¯¥é¡¹å€¼ä¸º <code>SHN_UNDEF</code></p>\n<h2 id=\"program-header\"><a class=\"anchor\" href=\"#program-header\">#</a> Program Header</h2>\n<p>Program Header Table æ˜¯ä¸€ä¸ªç»“æ„ä½“æ•°ç»„ï¼Œæ¯ä¸€ä¸ªå…ƒç´ çš„ç±»å‹æ˜¯  <code>Elf32_Phdr</code> ï¼Œæè¿°äº†ä¸€ä¸ªæ®µæˆ–è€…å…¶å®ƒç³»ç»Ÿåœ¨å‡†å¤‡ç¨‹åºæ‰§è¡Œæ—¶æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚å…¶ä¸­ï¼ŒELF å¤´ä¸­çš„  <code>e_phentsize</code>  å’Œ  <code>e_phnum</code>  æŒ‡å®šäº†è¯¥æ•°ç»„æ¯ä¸ªå…ƒç´ çš„å¤§å°ä»¥åŠå…ƒç´ ä¸ªæ•°ã€‚ä¸€ä¸ªç›®æ ‡æ–‡ä»¶çš„æ®µåŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªèŠ‚ã€‚<strong>ç¨‹åºçš„å¤´éƒ¨åªæœ‰å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶æœ‰æ„ä¹‰ã€‚</strong></p>\n<p>å¯ä»¥è¯´ï¼ŒProgram Header Table å°±æ˜¯ä¸“é—¨ä¸º ELF æ–‡ä»¶è¿è¡Œæ—¶ä¸­çš„æ®µæ‰€å‡†å¤‡çš„ã€‚</p>\n<p><code>Elf32_Phdr</code>  çš„æ•°æ®ç»“æ„å¦‚ä¸‹</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  Elf32_Word\tp_type<span class=\"token punctuation\">;</span>\t\t\t<span class=\"token comment\">/* Segment type */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  Elf32_Off\t    p_offset<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment file offset */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  Elf32_Addr\tp_vaddr<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment virtual address */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  Elf32_Addr\tp_paddr<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment physical address */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  Elf32_Word\tp_filesz<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment size in file */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  Elf32_Word\tp_memsz<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment size in memory */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  Elf32_Word\tp_flags<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment flags */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  Elf32_Word\tp_align<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment alignment */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Phdr<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>æ¯ä¸ªå­—æ®µçš„è¯´æ˜å¦‚ä¸‹</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">å­—æ®µ</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">p_type</td>\n<td style=\"text-align:left\">è¯¥å­—æ®µä¸ºæ®µçš„ç±»å‹ï¼Œæˆ–è€…è¡¨æ˜äº†è¯¥ç»“æ„çš„ç›¸å…³ä¿¡æ¯ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">p_offset</td>\n<td style=\"text-align:left\">è¯¥å­—æ®µç»™å‡ºäº†ä»æ–‡ä»¶å¼€å§‹åˆ°è¯¥æ®µå¼€å¤´çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åç§»ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">p_vaddr</td>\n<td style=\"text-align:left\">è¯¥å­—æ®µç»™å‡ºäº†è¯¥æ®µç¬¬ä¸€ä¸ªå­—èŠ‚åœ¨å†…å­˜ä¸­çš„è™šæ‹Ÿåœ°å€ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">p_paddr</td>\n<td style=\"text-align:left\">è¯¥å­—æ®µä»…ç”¨äºç‰©ç†åœ°å€å¯»å€ç›¸å…³çš„ç³»ç»Ÿä¸­ï¼Œ ç”±äº â€œSystem Vâ€ å¿½ç•¥äº†åº”ç”¨ç¨‹åºçš„ç‰©ç†å¯»å€ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶çš„è¯¥é¡¹å†…å®¹å¹¶æœªè¢«é™å®šã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">p_filesz</td>\n<td style=\"text-align:left\">è¯¥å­—æ®µç»™å‡ºäº†æ–‡ä»¶é•œåƒä¸­è¯¥æ®µçš„å¤§å°ï¼Œå¯èƒ½ä¸º 0ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">p_memsz</td>\n<td style=\"text-align:left\">è¯¥å­—æ®µç»™å‡ºäº†å†…å­˜é•œåƒä¸­è¯¥æ®µçš„å¤§å°ï¼Œå¯èƒ½ä¸º 0ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">p_flags</td>\n<td style=\"text-align:left\">è¯¥å­—æ®µç»™å‡ºäº†ä¸æ®µç›¸å…³çš„æ ‡è®°ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">p_align</td>\n<td style=\"text-align:left\">å¯åŠ è½½çš„ç¨‹åºçš„æ®µçš„ p_vaddr ä»¥åŠ p_offset çš„å¤§å°å¿…é¡»æ˜¯ page çš„æ•´æ•°å€ã€‚è¯¥æˆå‘˜ç»™å‡ºäº†æ®µåœ¨æ–‡ä»¶ä»¥åŠå†…å­˜ä¸­çš„å¯¹é½æ–¹å¼ã€‚å¦‚æœè¯¥å€¼ä¸º 0 æˆ– 1 çš„è¯ï¼Œè¡¨ç¤ºä¸éœ€è¦å¯¹é½ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œp_align åº”è¯¥æ˜¯ 2 çš„æ•´æ•°æŒ‡æ•°æ¬¡æ–¹ï¼Œå¹¶ä¸” p_vaddr ä¸ p_offset åœ¨æ¨¡ p_align çš„æ„ä¹‰ä¸‹ï¼Œåº”è¯¥ç›¸ç­‰ã€‚</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"p_type\"><a class=\"anchor\" href=\"#p_type\">#</a> p_type</h3>\n<p>å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„æ®µç±»å‹å¦‚ä¸‹</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">åå­—</th>\n<th style=\"text-align:left\">å–å€¼</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">PT_NULL</td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">è¡¨æ˜æ®µæœªä½¿ç”¨ï¼Œå…¶ç»“æ„ä¸­å…¶ä»–æˆå‘˜éƒ½æ˜¯æœªå®šä¹‰çš„ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">PT_LOAD</td>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">æ­¤ç±»å‹æ®µä¸ºä¸€ä¸ªå¯åŠ è½½çš„æ®µï¼Œå¤§å°ç”± p_filesz å’Œ p_memsz æè¿°ã€‚æ–‡ä»¶ä¸­çš„å­—èŠ‚è¢«æ˜ å°„åˆ°ç›¸åº”å†…å­˜æ®µå¼€å§‹å¤„ã€‚å¦‚æœ p_memsz å¤§äº p_fileszï¼Œâ€œå‰©ä½™â€ çš„å­—èŠ‚éƒ½è¦è¢«ç½®ä¸º 0ã€‚p_filesz ä¸èƒ½å¤§äº p_memszã€‚å¯åŠ è½½çš„æ®µåœ¨ç¨‹åºå¤´éƒ¨ä¸­æŒ‰ç…§ p_vaddr çš„å‡åºæ’åˆ—ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">PT_DYNAMIC</td>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">æ­¤ç±»å‹æ®µç»™å‡ºåŠ¨æ€é“¾æ¥ä¿¡æ¯ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">PT_INTERP</td>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\">æ­¤ç±»å‹æ®µç»™å‡ºäº†ä¸€ä¸ªä»¥ NULL ç»“å°¾çš„å­—ç¬¦ä¸²çš„ä½ç½®å’Œé•¿åº¦ï¼Œè¯¥å­—ç¬¦ä¸²å°†è¢«å½“ä½œè§£é‡Šå™¨è°ƒç”¨ã€‚è¿™ç§æ®µç±»å‹ä»…å¯¹å¯æ‰§è¡Œæ–‡ä»¶æœ‰æ„ä¹‰ï¼ˆä¹Ÿå¯èƒ½å‡ºç°åœ¨å…±äº«ç›®æ ‡æ–‡ä»¶ä¸­ï¼‰ã€‚æ­¤å¤–ï¼Œè¿™ç§æ®µåœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­æœ€å¤šå‡ºç°ä¸€æ¬¡ã€‚è€Œä¸”è¿™ç§ç±»å‹çš„æ®µå­˜åœ¨çš„è¯ï¼Œå®ƒå¿…é¡»åœ¨æ‰€æœ‰å¯åŠ è½½æ®µé¡¹çš„å‰é¢ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">PT_NOTE</td>\n<td style=\"text-align:left\">4</td>\n<td style=\"text-align:left\">æ­¤ç±»å‹æ®µç»™å‡ºé™„åŠ ä¿¡æ¯çš„ä½ç½®å’Œå¤§å°ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">PT_SHLIB</td>\n<td style=\"text-align:left\">5</td>\n<td style=\"text-align:left\">è¯¥æ®µç±»å‹è¢«ä¿ç•™ï¼Œä¸è¿‡è¯­ä¹‰æœªæŒ‡å®šã€‚è€Œä¸”ï¼ŒåŒ…å«è¿™ç§ç±»å‹çš„æ®µçš„ç¨‹åºä¸ç¬¦åˆ ABI æ ‡å‡†ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">PT_PHDR</td>\n<td style=\"text-align:left\">6</td>\n<td style=\"text-align:left\">è¯¥æ®µç±»å‹çš„æ•°ç»„å…ƒç´ å¦‚æœå­˜åœ¨çš„è¯ï¼Œåˆ™ç»™å‡ºäº†ç¨‹åºå¤´éƒ¨è¡¨è‡ªèº«çš„å¤§å°å’Œä½ç½®ï¼Œæ—¢åŒ…æ‹¬åœ¨æ–‡ä»¶ä¸­ä¹ŸåŒ…æ‹¬åœ¨å†…å­˜ä¸­çš„ä¿¡æ¯ã€‚æ­¤ç±»å‹çš„æ®µåœ¨æ–‡ä»¶ä¸­æœ€å¤šå‡ºç°ä¸€æ¬¡ã€‚<strong>æ­¤å¤–ï¼Œåªæœ‰ç¨‹åºå¤´éƒ¨è¡¨æ˜¯ç¨‹åºçš„å†…å­˜æ˜ åƒçš„ä¸€éƒ¨åˆ†æ—¶ï¼Œå®ƒæ‰ä¼šå‡ºç°</strong>ã€‚å¦‚æœæ­¤ç±»å‹æ®µå­˜åœ¨ï¼Œåˆ™å¿…é¡»åœ¨æ‰€æœ‰å¯åŠ è½½æ®µé¡¹ç›®çš„å‰é¢ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">PT_LOPROC~PT_HIPROC</td>\n<td style=\"text-align:left\">0x70000000 ~0x7fffffff</td>\n<td style=\"text-align:left\">æ­¤èŒƒå›´çš„ç±»å‹ä¿ç•™ç»™å¤„ç†å™¨ä¸“ç”¨è¯­ä¹‰ã€‚</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"p_flags\"><a class=\"anchor\" href=\"#p_flags\">#</a> p_flags</h3>\n<p>è¢«ç³»ç»ŸåŠ è½½åˆ°å†…å­˜ä¸­çš„ç¨‹åºè‡³å°‘æœ‰ä¸€ä¸ªå¯åŠ è½½çš„æ®µã€‚å½“ç³»ç»Ÿä¸ºå¯åŠ è½½çš„æ®µåˆ›å»ºå†…å­˜é•œåƒæ—¶ï¼Œå®ƒä¼šæŒ‰ç…§ p_flags å°†æ®µ<strong>è®¾ç½®ä¸ºå¯¹åº”çš„æƒé™</strong>ã€‚å¯èƒ½çš„æ®µæƒé™ä½æœ‰</p>\n<p><img data-src=\"/ElfReader/segment_flag_bits.png\" alt=\"img\" style=\"aspect-ratio:809 / 251;\"></p>\n<p>å…¶ä¸­ï¼Œæ‰€æœ‰åœ¨ PF_MASKPROC ä¸­çš„æ¯”ç‰¹ä½éƒ½æ˜¯è¢«ä¿ç•™ç”¨äºä¸å¤„ç†å™¨ç›¸å…³çš„è¯­ä¹‰ä¿¡æ¯ã€‚</p>\n<p>å¦‚æœä¸€ä¸ªæƒé™ä½è¢«è®¾ç½®ä¸º 0ï¼Œè¿™ç§ç±»å‹çš„æ®µæ˜¯ä¸å¯è®¿é—®çš„ã€‚å®é™…çš„å†…å­˜æƒé™å–å†³äºç›¸åº”çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œä¸åŒçš„ç³»ç»Ÿå¯èƒ½æ“ä½œæ–¹å¼ä¸ä¸€æ ·ã€‚å°½ç®¡æ‰€æœ‰çš„æƒé™ç»„åˆéƒ½æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯ç³»ç»Ÿä¸€èˆ¬ä¼šæˆäºˆæ¯”è¯·æ±‚æ›´å¤šçš„æƒé™ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œé™¤éæ˜ç¡®è¯´æ˜ï¼Œä¸€ä¸ªæ®µä¸ä¼šæœ‰å†™æƒé™ã€‚ä¸‹é¢ç»™å‡ºäº†æ‰€æœ‰çš„å¯èƒ½ç»„åˆã€‚</p>\n<p><img data-src=\"/ElfReader/segment-permission.png\" alt=\"img\" style=\"aspect-ratio:842 / 375;\"></p>\n<p>ä¾‹å¦‚ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œ.text æ®µä¸€èˆ¬å…·æœ‰è¯»å’Œæ‰§è¡Œæƒé™ï¼Œä½†æ˜¯ä¸ä¼šæœ‰å†™æƒé™ã€‚æ•°æ®æ®µä¸€èˆ¬å…·æœ‰å†™ï¼Œè¯»ï¼Œä»¥åŠæ‰§è¡Œæƒé™ã€‚</p>\n<h2 id=\"section-header\"><a class=\"anchor\" href=\"#section-header\">#</a> Section Header</h2>\n<p>ELF å¤´ä¸­çš„  <code>e_shoff</code>  é¡¹ç»™å‡ºäº†ä»æ–‡ä»¶å¼€å¤´åˆ°èŠ‚å¤´è¡¨ä½ç½®çš„å­—èŠ‚åç§»ã€‚ <code>e_shnum</code>  å‘Šè¯‰äº†æˆ‘ä»¬èŠ‚å¤´è¡¨åŒ…å«çš„é¡¹æ•°ï¼› <code>e_shentsize</code>  ç»™å‡ºäº†æ¯ä¸€é¡¹çš„å­—èŠ‚å¤§å°ã€‚</p>\n<p>èŠ‚å¤´è¡¨æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„çš„å…ƒç´ çš„ç±»å‹æ˜¯  <code>ELF32_Shdr</code>  ï¼Œæ¯ä¸€ä¸ªå…ƒç´ éƒ½æè¿°äº†ä¸€ä¸ªèŠ‚åŒºçš„æ¦‚è¦å†…å®¹ã€‚æ¯ä¸ªèŠ‚åŒºå¤´éƒ¨å¯ä»¥ç”¨ä¸‹é¢çš„æ•°æ®ç»“æ„è¿›è¡Œæè¿°ï¼š</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  Elf32_Word\tsh_name<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section name (string tbl index) */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  Elf32_Word\tsh_type<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section type */</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  Elf32_Word\tsh_flags<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section flags */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  Elf32_Addr\tsh_addr<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section virtual addr at execution */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  Elf32_Off\tsh_offset<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section file offset */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  Elf32_Word\tsh_size<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section size in bytes */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  Elf32_Word\tsh_link<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Link to another section */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  Elf32_Word\tsh_info<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Additional section information */</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  Elf32_Word\tsh_addralign<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section alignment */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  Elf32_Word\tsh_entsize<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Entry size if section holds table */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Shdr<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>æ¯ä¸ªå­—æ®µçš„å«ä¹‰å¦‚ä¸‹</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">æˆå‘˜</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">sh_name</td>\n<td style=\"text-align:left\">èŠ‚åç§°ï¼Œæ˜¯èŠ‚åŒºå¤´å­—ç¬¦ä¸²è¡¨èŠ‚åŒºä¸­ï¼ˆSection Header String Table Sectionï¼‰çš„ç´¢å¼•ï¼Œå› æ­¤è¯¥å­—æ®µå®é™…æ˜¯ä¸€ä¸ªæ•°å€¼ã€‚åœ¨å­—ç¬¦ä¸²è¡¨ä¸­çš„å…·ä½“å†…å®¹æ˜¯ä»¥ NULL ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">sh_type</td>\n<td style=\"text-align:left\">æ ¹æ®èŠ‚çš„å†…å®¹å’Œè¯­ä¹‰è¿›è¡Œåˆ†ç±»ï¼Œå…·ä½“çš„ç±»å‹ä¸‹é¢ä¼šä»‹ç»ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">sh_flags</td>\n<td style=\"text-align:left\">æ¯ä¸€æ¯”ç‰¹ä»£è¡¨ä¸åŒçš„æ ‡å¿—ï¼Œæè¿°èŠ‚æ˜¯å¦å¯å†™ï¼Œå¯æ‰§è¡Œï¼Œéœ€è¦åˆ†é…å†…å­˜ç­‰å±æ€§ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">sh_addr</td>\n<td style=\"text-align:left\">å¦‚æœèŠ‚åŒºå°†å‡ºç°åœ¨è¿›ç¨‹çš„å†…å­˜æ˜ åƒä¸­ï¼Œæ­¤æˆå‘˜ç»™å‡ºèŠ‚åŒºçš„ç¬¬ä¸€ä¸ªå­—èŠ‚åº”è¯¥åœ¨è¿›ç¨‹é•œåƒä¸­çš„ä½ç½®ã€‚å¦åˆ™ï¼Œæ­¤å­—æ®µä¸º 0ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">sh_offset</td>\n<td style=\"text-align:left\">ç»™å‡ºèŠ‚åŒºçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸æ–‡ä»¶å¼€å§‹å¤„ä¹‹é—´çš„åç§»ã€‚SHT_NOBITS ç±»å‹çš„èŠ‚åŒºä¸å ç”¨æ–‡ä»¶çš„ç©ºé—´ï¼Œå› æ­¤å…¶ sh_offset æˆå‘˜ç»™å‡ºçš„æ˜¯æ¦‚å¿µæ€§çš„åç§»ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">sh_size</td>\n<td style=\"text-align:left\">æ­¤æˆå‘˜ç»™å‡ºèŠ‚åŒºçš„å­—èŠ‚å¤§å°ã€‚é™¤éèŠ‚åŒºçš„ç±»å‹æ˜¯ SHT_NOBITS ï¼Œå¦åˆ™è¯¥èŠ‚å ç”¨æ–‡ä»¶ä¸­çš„ sh_size å­—èŠ‚ã€‚ç±»å‹ä¸º SHT_NOBITS çš„èŠ‚åŒºé•¿åº¦å¯èƒ½éé›¶ï¼Œä¸è¿‡å´ä¸å ç”¨æ–‡ä»¶ä¸­çš„ç©ºé—´ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">sh_link</td>\n<td style=\"text-align:left\">æ­¤æˆå‘˜ç»™å‡ºèŠ‚åŒºå¤´éƒ¨è¡¨ç´¢å¼•é“¾æ¥ï¼Œå…¶å…·ä½“çš„è§£é‡Šä¾èµ–äºèŠ‚åŒºç±»å‹ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">sh_info</td>\n<td style=\"text-align:left\">æ­¤æˆå‘˜ç»™å‡ºé™„åŠ ä¿¡æ¯ï¼Œå…¶è§£é‡Šä¾èµ–äºèŠ‚åŒºç±»å‹ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">sh_addralign</td>\n<td style=\"text-align:left\">æŸäº›èŠ‚åŒºçš„åœ°å€éœ€è¦å¯¹é½ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªèŠ‚åŒºæœ‰ä¸€ä¸ª doubleword ç±»å‹çš„å˜é‡ï¼Œé‚£ä¹ˆç³»ç»Ÿå¿…é¡»ä¿è¯æ•´ä¸ªèŠ‚åŒºæŒ‰åŒå­—å¯¹é½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ <code>sh_addr%sh_addralign=0</code> ã€‚ç›®å‰å®ƒä»…å…è®¸ä¸º 0ï¼Œä»¥åŠ 2 çš„æ­£æ•´æ•°å¹‚æ•°ã€‚ 0 å’Œ 1 è¡¨ç¤ºæ²¡æœ‰å¯¹é½çº¦æŸã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">sh_entsize</td>\n<td style=\"text-align:left\">æŸäº›èŠ‚åŒºä¸­å­˜åœ¨å…·æœ‰å›ºå®šå¤§å°çš„è¡¨é¡¹çš„è¡¨ï¼Œå¦‚ç¬¦å·è¡¨ã€‚å¯¹äºè¿™ç±»èŠ‚åŒºï¼Œè¯¥æˆå‘˜ç»™å‡ºæ¯ä¸ªè¡¨é¡¹çš„å­—èŠ‚å¤§å°ã€‚åä¹‹ï¼Œæ­¤æˆå‘˜å–å€¼ä¸º 0ã€‚</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"sh_type\"><a class=\"anchor\" href=\"#sh_type\">#</a> sh_type</h3>\n<p>èŠ‚ç±»å‹ç›®å‰æœ‰ä¸‹åˆ—å¯é€‰èŒƒå›´ï¼Œå…¶ä¸­ SHT æ˜¯ <strong>Section Header Table</strong> çš„ç®€å†™ã€‚</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">åç§°</th>\n<th style=\"text-align:left\">å–å€¼</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">SHT_NULL</td>\n<td style=\"text-align:left\">0</td>\n<td style=\"text-align:left\">è¯¥ç±»å‹èŠ‚åŒºæ˜¯éæ´»åŠ¨çš„ï¼Œè¿™ç§ç±»å‹çš„èŠ‚å¤´ä¸­çš„å…¶å®ƒæˆå‘˜å–å€¼æ— æ„ä¹‰ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_PROGBITS</td>\n<td style=\"text-align:left\">1</td>\n<td style=\"text-align:left\">è¯¥ç±»å‹èŠ‚åŒºåŒ…å«ç¨‹åºå®šä¹‰çš„ä¿¡æ¯ï¼Œå®ƒçš„æ ¼å¼å’Œå«ä¹‰éƒ½ç”±ç¨‹åºæ¥å†³å®šã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_SYMTAB</td>\n<td style=\"text-align:left\">2</td>\n<td style=\"text-align:left\">è¯¥ç±»å‹èŠ‚åŒºåŒ…å«ä¸€ä¸ªç¬¦å·è¡¨ï¼ˆ<strong>SYMbol TABle</strong>ï¼‰ã€‚ç›®å‰ç›®æ ‡æ–‡ä»¶å¯¹æ¯ç§ç±»å‹çš„èŠ‚åŒºéƒ½åª èƒ½åŒ…å«ä¸€ä¸ªï¼Œä¸è¿‡è¿™ä¸ªé™åˆ¶å°†æ¥å¯èƒ½å‘ç”Ÿå˜åŒ–ã€‚ ä¸€èˆ¬ï¼ŒSHT_SYMTAB èŠ‚åŒºæä¾›ç”¨äºé“¾æ¥ç¼–è¾‘ï¼ˆæŒ‡ ld è€Œè¨€ï¼‰ çš„ç¬¦å·ï¼Œå°½ç®¡ä¹Ÿå¯ç”¨æ¥å®ç°åŠ¨æ€é“¾æ¥ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_STRTAB</td>\n<td style=\"text-align:left\">3</td>\n<td style=\"text-align:left\">è¯¥ç±»å‹èŠ‚åŒºåŒ…å«å­—ç¬¦ä¸²è¡¨ï¼ˆ <strong>STRing TABle</strong> ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_RELA</td>\n<td style=\"text-align:left\">4</td>\n<td style=\"text-align:left\">è¯¥ç±»å‹èŠ‚åŒºåŒ…å«æ˜¾å¼æŒ‡å®šä½æ•°çš„é‡å®šä½é¡¹ï¼ˆ <strong>RELocation entry with Addends</strong> ï¼‰ï¼Œä¾‹å¦‚ï¼Œ32 ä½ç›®æ ‡æ–‡ä»¶ä¸­çš„ Elf32_Rela ç±»å‹ã€‚æ­¤å¤–ï¼Œç›®æ ‡æ–‡ä»¶å¯èƒ½æ‹¥æœ‰å¤šä¸ªé‡å®šä½èŠ‚åŒºã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_HASH</td>\n<td style=\"text-align:left\">5</td>\n<td style=\"text-align:left\">è¯¥ç±»å‹èŠ‚åŒºåŒ…å«ç¬¦å·å“ˆå¸Œè¡¨ï¼ˆ <strong>HASH table</strong> ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_DYNAMIC</td>\n<td style=\"text-align:left\">6</td>\n<td style=\"text-align:left\">è¯¥ç±»å‹èŠ‚åŒºåŒ…å«åŠ¨æ€é“¾æ¥çš„ä¿¡æ¯ï¼ˆ <strong>DYNAMIC linking</strong> ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_NOTE</td>\n<td style=\"text-align:left\">7</td>\n<td style=\"text-align:left\">è¯¥ç±»å‹èŠ‚åŒºåŒ…å«ä»¥æŸç§æ–¹å¼æ ‡è®°æ–‡ä»¶çš„ä¿¡æ¯ï¼ˆ<strong>NOTE</strong>ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_NOBITS</td>\n<td style=\"text-align:left\">8</td>\n<td style=\"text-align:left\">è¯¥ç±»å‹èŠ‚åŒºä¸å ç”¨æ–‡ä»¶çš„ç©ºé—´ï¼Œå…¶å®ƒæ–¹é¢å’Œ SHT_PROGBITS ç›¸ä¼¼ã€‚å°½ç®¡è¯¥ç±»å‹èŠ‚åŒºä¸åŒ…å«ä»»ä½•å­—èŠ‚ï¼Œå…¶å¯¹åº”çš„èŠ‚å¤´æˆå‘˜ sh_offset ä¸­è¿˜æ˜¯ä¼šåŒ…å«æ¦‚å¿µæ€§çš„æ–‡ä»¶åç§»ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_REL</td>\n<td style=\"text-align:left\">9</td>\n<td style=\"text-align:left\">è¯¥ç±»å‹èŠ‚åŒºåŒ…å«é‡å®šä½è¡¨é¡¹ï¼ˆ<strong>RELocation entry without Addends</strong>ï¼‰ï¼Œä¸è¿‡å¹¶æ²¡æœ‰æŒ‡å®šä½æ•°ã€‚ä¾‹å¦‚ï¼Œ32 ä½ç›®æ ‡æ–‡ä»¶ä¸­çš„ Elf32_rel ç±»å‹ã€‚ç›®æ ‡æ–‡ä»¶ä¸­å¯ä»¥æ‹¥æœ‰å¤šä¸ªé‡å®šä½èŠ‚åŒºã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_SHLIB</td>\n<td style=\"text-align:left\">10</td>\n<td style=\"text-align:left\">è¯¥ç±»å‹æ­¤èŠ‚åŒºè¢«ä¿ç•™ï¼Œä¸è¿‡å…¶è¯­ä¹‰å°šæœªè¢«å®šä¹‰ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_DYNSYM</td>\n<td style=\"text-align:left\">11</td>\n<td style=\"text-align:left\">ä½œä¸ºä¸€ä¸ªå®Œæ•´çš„ç¬¦å·è¡¨ï¼Œå®ƒå¯èƒ½åŒ…å«å¾ˆå¤šå¯¹åŠ¨æ€é“¾æ¥è€Œè¨€ä¸å¿… è¦çš„ç¬¦å·ã€‚å› æ­¤ï¼Œç›®æ ‡æ–‡ä»¶ä¹Ÿå¯ä»¥åŒ…å«ä¸€ä¸ª SHT_DYNSYM èŠ‚åŒºï¼Œå…¶ä¸­ä¿å­˜åŠ¨æ€é“¾æ¥ç¬¦å·çš„ä¸€ä¸ªæœ€å°é›†åˆï¼Œä»¥èŠ‚çœç©ºé—´ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_LOPROC</td>\n<td style=\"text-align:left\">0X70000000</td>\n<td style=\"text-align:left\">æ­¤å€¼æŒ‡å®šä¿ç•™ç»™å¤„ç†å™¨ä¸“ç”¨è¯­ä¹‰çš„ä¸‹ç•Œï¼ˆ <strong>LOw PROCessor-specific semantics</strong> ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_HIPROC</td>\n<td style=\"text-align:left\">OX7FFFFFFF</td>\n<td style=\"text-align:left\">æ­¤å€¼æŒ‡å®šä¿ç•™ç»™å¤„ç†å™¨ä¸“ç”¨è¯­ä¹‰çš„ä¸Šç•Œï¼ˆ <strong>HIgh PROCessor-specific semantics</strong> ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_LOUSER</td>\n<td style=\"text-align:left\">0X80000000</td>\n<td style=\"text-align:left\">æ­¤å€¼æŒ‡å®šä¿ç•™ç»™åº”ç”¨ç¨‹åºçš„ç´¢å¼•ä¸‹ç•Œã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_HIUSER</td>\n<td style=\"text-align:left\">0X8FFFFFFF</td>\n<td style=\"text-align:left\">æ­¤å€¼æŒ‡å®šä¿ç•™ç»™åº”ç”¨ç¨‹åºçš„ç´¢å¼•ä¸Šç•Œã€‚</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"sh_flags\"><a class=\"anchor\" href=\"#sh_flags\">#</a> sh_flags</h3>\n<p>èŠ‚å¤´ä¸­  <code>sh_flags</code>  å­—æ®µçš„æ¯ä¸€ä¸ªæ¯”ç‰¹ä½éƒ½å¯ä»¥ç»™å‡ºå…¶ç›¸åº”çš„æ ‡è®°ä¿¡æ¯ï¼Œå…¶å®šä¹‰äº†å¯¹åº”çš„èŠ‚åŒºçš„å†…å®¹æ˜¯å¦å¯ä»¥è¢«ä¿®æ”¹ã€è¢«æ‰§è¡Œç­‰ä¿¡æ¯ã€‚å¦‚æœä¸€ä¸ªæ ‡å¿—ä½è¢«è®¾ç½®ï¼Œåˆ™è¯¥ä½å–å€¼ä¸º 1ï¼Œæœªå®šä¹‰çš„ä½éƒ½ä¸º 0ã€‚ç›®å‰å·²å®šä¹‰å€¼å¦‚ä¸‹ï¼Œå…¶ä»–å€¼ä¿ç•™ã€‚</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">åç§°</th>\n<th style=\"text-align:left\">å€¼</th>\n<th style=\"text-align:left\">è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">SHF_WRITE</td>\n<td style=\"text-align:left\">0x1</td>\n<td style=\"text-align:left\">è¿™ç§èŠ‚åŒ…å«äº†è¿›ç¨‹è¿è¡Œè¿‡ç¨‹ä¸­å¯ä»¥è¢«å†™çš„æ•°æ®ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHF_ALLOC</td>\n<td style=\"text-align:left\">0x2</td>\n<td style=\"text-align:left\">è¿™ç§èŠ‚åœ¨è¿›ç¨‹è¿è¡Œæ—¶å ç”¨å†…å­˜ã€‚å¯¹äºä¸å ç”¨ç›®æ ‡æ–‡ä»¶çš„å†…å­˜é•œåƒç©ºé—´çš„æŸäº›æ§åˆ¶èŠ‚ï¼Œè¯¥å±æ€§å¤„äºå…³é—­çŠ¶æ€ (off)ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHF_EXECINSTR</td>\n<td style=\"text-align:left\">0x4</td>\n<td style=\"text-align:left\">è¿™ç§èŠ‚åŒ…å«å¯æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤ï¼ˆ<strong>EXECutable INSTRuction</strong>ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHF_MASKPROC</td>\n<td style=\"text-align:left\">0xf0000000</td>\n<td style=\"text-align:left\">æ‰€æœ‰åœ¨è¿™ä¸ªæ©ç ä¸­çš„æ¯”ç‰¹ä½ç”¨äºç‰¹å®šå¤„ç†å™¨è¯­ä¹‰ã€‚</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"sh_link-sh_info\"><a class=\"anchor\" href=\"#sh_link-sh_info\">#</a> sh_link &amp; sh_info</h3>\n<p>å½“èŠ‚åŒºç±»å‹çš„ä¸åŒçš„æ—¶å€™ï¼Œsh_link å’Œ sh_info ä¹Ÿä¼šå…·æœ‰ä¸åŒçš„å«ä¹‰ã€‚</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">sh_type</th>\n<th style=\"text-align:left\">sh_link</th>\n<th style=\"text-align:left\">sh_info</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">SHT_DYNAMIC</td>\n<td style=\"text-align:left\">èŠ‚åŒºä¸­ä½¿ç”¨çš„å­—ç¬¦ä¸²è¡¨çš„èŠ‚å¤´ç´¢å¼•</td>\n<td style=\"text-align:left\">0</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_HASH</td>\n<td style=\"text-align:left\">æ­¤å“ˆå¸Œè¡¨æ‰€ä½¿ç”¨çš„ç¬¦å·è¡¨çš„èŠ‚å¤´ç´¢å¼•</td>\n<td style=\"text-align:left\">0</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_REL/SHT_RELA</td>\n<td style=\"text-align:left\">ä¸ç¬¦å·è¡¨ç›¸å…³çš„èŠ‚å¤´ç´¢å¼•</td>\n<td style=\"text-align:left\">é‡å®šä½åº”ç”¨åˆ°çš„èŠ‚çš„èŠ‚å¤´ç´¢å¼•</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SHT_SYMTAB/SHT_DYNSYM</td>\n<td style=\"text-align:left\">æ“ä½œç³»ç»Ÿç‰¹å®šä¿¡æ¯ï¼ŒLinux ä¸­çš„ ELF æ–‡ä»¶ä¸­è¯¥é¡¹æŒ‡å‘ç¬¦å·è¡¨ä¸­ç¬¦å·æ‰€å¯¹åº”çš„å­—ç¬¦ä¸²èŠ‚åŒºåœ¨ Section Header Table ä¸­çš„åç§»ã€‚</td>\n<td style=\"text-align:left\">æ“ä½œç³»ç»Ÿç‰¹å®šä¿¡æ¯</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">other</td>\n<td style=\"text-align:left\"><code>SHN_UNDEF</code></td>\n<td style=\"text-align:left\">0</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"elf-sections\"><a class=\"anchor\" href=\"#elf-sections\">#</a> ELF sections</h2>\n<h3 id=\"èŠ‚çš„åˆ†ç±»\"><a class=\"anchor\" href=\"#èŠ‚çš„åˆ†ç±»\">#</a> èŠ‚çš„åˆ†ç±»</h3>\n<h4 id=\"textèŠ‚\"><a class=\"anchor\" href=\"#textèŠ‚\">#</a> .text èŠ‚</h4>\n<p><code>.text</code>  èŠ‚æ˜¯ä¿å­˜äº†ç¨‹åºä»£ç æŒ‡ä»¤çš„<strong>ä»£ç èŠ‚</strong>ã€‚<strong>ä¸€æ®µå¯æ‰§è¡Œç¨‹åºï¼Œå¦‚æœå­˜åœ¨ Phdrï¼Œåˆ™ <code>.text</code>  èŠ‚å°±ä¼šå­˜åœ¨äº <code>text</code>  æ®µä¸­</strong>ã€‚ç”±äº <code>.text</code>  èŠ‚ä¿å­˜äº†ç¨‹åºä»£ç ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º <code>SHT_PROGBITS</code> ã€‚</p>\n<h4 id=\"rodataèŠ‚\"><a class=\"anchor\" href=\"#rodataèŠ‚\">#</a> .rodata èŠ‚</h4>\n<p><code>rodata</code>  èŠ‚ä¿å­˜äº†åªè¯»çš„æ•°æ®ï¼Œå¦‚ä¸€è¡Œ C è¯­è¨€ä»£ç ä¸­çš„å­—ç¬¦ä¸²ã€‚ç”±äº <code>.rodata</code>  èŠ‚æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥åªèƒ½å­˜åœ¨äºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„<strong>åªè¯»æ®µ</strong>ä¸­ã€‚å› æ­¤ï¼Œåªèƒ½åœ¨ <code>text</code>  æ®µï¼ˆä¸æ˜¯ <code>data</code>  æ®µï¼‰ä¸­æ‰¾åˆ° <code>.rodata</code>  èŠ‚ã€‚ç”±äº <code>.rodata</code>  èŠ‚æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º <code>SHT_PROGBITS</code> ã€‚</p>\n<h4 id=\"pltèŠ‚è¿‡ç¨‹é“¾æ¥è¡¨\"><a class=\"anchor\" href=\"#pltèŠ‚è¿‡ç¨‹é“¾æ¥è¡¨\">#</a> .plt èŠ‚ï¼ˆè¿‡ç¨‹é“¾æ¥è¡¨ï¼‰</h4>\n<p><code>.plt</code>  èŠ‚ä¹Ÿç§°ä¸º<strong>è¿‡ç¨‹é“¾æ¥è¡¨ï¼ˆProcedure Linkage Tableï¼‰</strong>ï¼Œ<strong>å…¶åŒ…å«äº†åŠ¨æ€é“¾æ¥å™¨è°ƒç”¨ä»å…±äº«åº“å¯¼å…¥çš„å‡½æ•°æ‰€å¿…éœ€çš„ç›¸å…³ä»£ç </strong>ã€‚ç”±äº <code>.plt</code>  èŠ‚ä¿å­˜äº†ä»£ç ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º <code>SHT_PROGBITS</code> ã€‚</p>\n<h4 id=\"dataèŠ‚\"><a class=\"anchor\" href=\"#dataèŠ‚\">#</a> .data èŠ‚</h4>\n<p><code>.data</code>  èŠ‚å­˜åœ¨äº <code>data</code>  æ®µä¸­ï¼Œ<strong>å…¶ä¿å­˜äº†åˆå§‹åŒ–çš„å…¨å±€å˜é‡ç­‰æ•°æ®</strong>ã€‚ç”±äº <code>.data</code>  èŠ‚ä¿å­˜äº†ç¨‹åºçš„å˜é‡æ•°æ®ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º <code>SHT_PROGBITS</code> ã€‚</p>\n<h4 id=\"bssèŠ‚\"><a class=\"anchor\" href=\"#bssèŠ‚\">#</a> .bss èŠ‚</h4>\n<p><code>.bss</code>  èŠ‚å­˜åœ¨äº <code>data</code>  æ®µä¸­ï¼Œå ç”¨ç©ºé—´ä¸è¶…è¿‡ 4 å­—èŠ‚ï¼Œä»…è¡¨ç¤ºè¿™ä¸ªèŠ‚æœ¬çœçš„ç©ºé—´ã€‚<strong> <code>.bss</code>  èŠ‚ä¿å­˜äº†æœªè¿›è¡Œåˆå§‹åŒ–çš„å…¨å±€æ•°æ®</strong>ã€‚ç¨‹åºåŠ è½½æ—¶æ•°æ®è¢«åˆå§‹åŒ–ä¸º 0ï¼Œåœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´å¯ä»¥è¿›è¡Œèµ‹å€¼ã€‚ç”±äº <code>.bss</code>  èŠ‚æœªä¿å­˜å®é™…çš„æ•°æ®ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º <code>SHT_NOBITS</code> ã€‚</p>\n<h4 id=\"gotpltèŠ‚å…¨å±€åç§»è¡¨-è¿‡ç¨‹é“¾æ¥è¡¨\"><a class=\"anchor\" href=\"#gotpltèŠ‚å…¨å±€åç§»è¡¨-è¿‡ç¨‹é“¾æ¥è¡¨\">#</a> .got.plt èŠ‚ï¼ˆå…¨å±€åç§»è¡¨ - è¿‡ç¨‹é“¾æ¥è¡¨ï¼‰</h4>\n<p><code>.got</code>  èŠ‚ä¿å­˜äº†<strong>å…¨å±€åç§»è¡¨</strong>ã€‚<strong> <code>.got</code>  èŠ‚å’Œ <code>.plt</code>  èŠ‚ä¸€èµ·æä¾›äº†å¯¹å¯¼å…¥çš„å…±äº«åº“å‡½æ•°çš„è®¿é—®å…¥å£ï¼Œç”±åŠ¨æ€é“¾æ¥å™¨åœ¨è¿è¡Œæ—¶è¿›è¡Œä¿®æ”¹</strong>ã€‚ç”±äº <code>.got.plt</code>  èŠ‚ä¸ç¨‹åºæ‰§è¡Œæœ‰å…³ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º <code>SHT_PROGBITS</code> ã€‚</p>\n<h4 id=\"dynsymèŠ‚åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨\"><a class=\"anchor\" href=\"#dynsymèŠ‚åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨\">#</a> .dynsym èŠ‚ï¼ˆåŠ¨æ€é“¾æ¥ç¬¦å·è¡¨ï¼‰</h4>\n<p><code>.dynsym</code>  èŠ‚ä¿å­˜åœ¨ <code>text</code>  æ®µä¸­ã€‚<strong>å…¶ä¿å­˜äº†ä»å…±äº«åº“å¯¼å…¥çš„åŠ¨æ€ç¬¦å·è¡¨</strong>ã€‚èŠ‚ç±»å‹ä¸º <code>SHT_DYNSYM</code> ã€‚</p>\n<h4 id=\"dynstrèŠ‚åŠ¨æ€é“¾æ¥å­—ç¬¦ä¸²è¡¨\"><a class=\"anchor\" href=\"#dynstrèŠ‚åŠ¨æ€é“¾æ¥å­—ç¬¦ä¸²è¡¨\">#</a> .dynstr èŠ‚ï¼ˆåŠ¨æ€é“¾æ¥å­—ç¬¦ä¸²è¡¨ï¼‰</h4>\n<p><code>.dynstr</code>  ä¿å­˜äº†åŠ¨æ€é“¾æ¥å­—ç¬¦ä¸²è¡¨ï¼Œè¡¨ä¸­å­˜æ”¾äº†ä¸€ç³»åˆ—å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²ä»£è¡¨äº†ç¬¦å·åç§°ï¼Œä»¥ç©ºå­—ç¬¦ä½œä¸ºç»ˆæ­¢ç¬¦ã€‚</p>\n<h4 id=\"relèŠ‚é‡å®šä½è¡¨\"><a class=\"anchor\" href=\"#relèŠ‚é‡å®šä½è¡¨\">#</a> .rel.* èŠ‚ï¼ˆé‡å®šä½è¡¨ï¼‰</h4>\n<p>é‡å®šä½è¡¨ä¿å­˜äº†é‡å®šä½ç›¸å…³çš„ä¿¡æ¯ï¼Œ<strong>è¿™äº›ä¿¡æ¯æè¿°äº†å¦‚ä½•åœ¨é“¾æ¥æˆ–è¿è¡Œæ—¶ï¼Œå¯¹ ELF ç›®æ ‡æ–‡ä»¶çš„æŸéƒ¨åˆ†æˆ–è€…è¿›ç¨‹é•œåƒè¿›è¡Œè¡¥å……æˆ–ä¿®æ”¹</strong>ã€‚ç”±äºé‡å®šä½è¡¨ä¿å­˜äº†é‡å®šä½ç›¸å…³çš„æ•°æ®ï¼Œæ‰€ä»¥èŠ‚ç±»å‹ä¸º <code>SHT_REL</code> ã€‚</p>\n<h4 id=\"hashèŠ‚\"><a class=\"anchor\" href=\"#hashèŠ‚\">#</a> .hash èŠ‚</h4>\n<p><code>.hash</code>  èŠ‚ä¹Ÿç§°ä¸º <code>.gnu.hash</code> ï¼Œå…¶ä¿å­˜äº†ä¸€ä¸ªç”¨äºæŸ¥æ‰¾ç¬¦å·çš„æ•£åˆ—è¡¨ã€‚</p>\n<h4 id=\"symtabèŠ‚ç¬¦å·è¡¨\"><a class=\"anchor\" href=\"#symtabèŠ‚ç¬¦å·è¡¨\">#</a> .symtab èŠ‚ï¼ˆç¬¦å·è¡¨ï¼‰</h4>\n<p><code>.symtab</code>  èŠ‚æ˜¯ä¸€ä¸ª <code>ElfN_Sym</code>  çš„æ•°ç»„ï¼Œä¿å­˜äº†ç¬¦å·ä¿¡æ¯ã€‚èŠ‚ç±»å‹ä¸º <code>SHT_SYMTAB</code> ã€‚</p>\n<h4 id=\"strtabèŠ‚å­—ç¬¦ä¸²è¡¨\"><a class=\"anchor\" href=\"#strtabèŠ‚å­—ç¬¦ä¸²è¡¨\">#</a> .strtab èŠ‚ï¼ˆå­—ç¬¦ä¸²è¡¨ï¼‰</h4>\n<p><code>.strtab</code>  èŠ‚ä¿å­˜çš„æ˜¯ç¬¦å·å­—ç¬¦ä¸²è¡¨ï¼Œè¡¨ä¸­çš„å†…å®¹ä¼šè¢« <code>.symtab</code>  çš„ <code>ElfN_Sym</code>  ç»“æ„ä¸­çš„ <code>st_name</code>  å¼•ç”¨ã€‚èŠ‚ç±»å‹ä¸º <code>SHT_STRTAB</code> ã€‚</p>\n<h4 id=\"ctorsèŠ‚å’ŒdtorsèŠ‚\"><a class=\"anchor\" href=\"#ctorsèŠ‚å’ŒdtorsèŠ‚\">#</a> .ctors èŠ‚å’Œ.dtors èŠ‚</h4>\n<p><code>.ctors</code> ï¼ˆ<strong>æ„é€ å™¨</strong>ï¼‰èŠ‚å’Œ <code>.dtors</code> ï¼ˆ<strong>ææ„å™¨</strong>ï¼‰èŠ‚åˆ†åˆ«ä¿å­˜äº†æŒ‡å‘æ„é€ å‡½æ•°å’Œææ„å‡½æ•°çš„å‡½æ•°æŒ‡é’ˆï¼Œ<strong>æ„é€ å‡½æ•°æ˜¯åœ¨ main å‡½æ•°æ‰§è¡Œä¹‹å‰éœ€è¦æ‰§è¡Œçš„ä»£ç ï¼›ææ„å‡½æ•°æ˜¯åœ¨ main å‡½æ•°ä¹‹åéœ€è¦æ‰§è¡Œçš„ä»£ç </strong>ã€‚</p>\n<h3 id=\"ç¬¦å·è¡¨\"><a class=\"anchor\" href=\"#ç¬¦å·è¡¨\">#</a> ç¬¦å·è¡¨</h3>\n<p><strong>ç¬¦å·æ˜¯å¯¹æŸäº›ç±»å‹çš„æ•°æ®æˆ–ä»£ç ï¼ˆå¦‚å…¨å±€å˜é‡æˆ–å‡½æ•°ï¼‰çš„ç¬¦å·å¼•ç”¨ï¼Œå‡½æ•°åæˆ–å˜é‡åå°±æ˜¯ç¬¦å·å</strong>ã€‚ä¾‹å¦‚ï¼Œ <code>printf()</code>  å‡½æ•°ä¼šåœ¨åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨ <code>.dynsym</code>  ä¸­å­˜æœ‰ä¸€ä¸ªæŒ‡å‘è¯¥å‡½æ•°çš„ç¬¦å·é¡¹ï¼ˆä»¥ <code>Elf_Sym</code>  æ•°æ®ç»“æ„è¡¨ç¤ºï¼‰ã€‚åœ¨å¤§å¤šæ•°å…±äº«åº“å’ŒåŠ¨æ€é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œå­˜åœ¨ä¸¤ä¸ªç¬¦å·è¡¨ã€‚å³ <code>.dynsym</code>  å’Œ <code>.symtab</code> ã€‚</p>\n<p><strong> <code>.dynsym</code>  ä¿å­˜äº†å¼•ç”¨æ¥è‡ªå¤–éƒ¨æ–‡ä»¶ç¬¦å·çš„å…¨å±€ç¬¦å·</strong>ã€‚å¦‚ <code>printf</code>  åº“å‡½æ•°ã€‚<strong> <code>.dynsym</code>  ä¿å­˜çš„ç¬¦å·æ˜¯ <code>.symtab</code>  æ‰€ä¿å­˜ç¬¦åˆçš„å­é›†ï¼Œ <code>.symtab</code>  ä¸­è¿˜ä¿å­˜äº†å¯æ‰§è¡Œæ–‡ä»¶çš„æœ¬åœ°ç¬¦å·</strong>ã€‚å¦‚å…¨å±€å˜é‡ï¼Œä»£ç ä¸­å®šä¹‰çš„æœ¬åœ°å‡½æ•°ç­‰ã€‚</p>\n<p>æ—¢ç„¶ <code>.dynsym</code>  æ˜¯ <code>.symtab</code>  çš„å­é›†ï¼Œé‚£ä¸ºä½•è¦åŒæ—¶å­˜åœ¨ä¸¤ä¸ªç¬¦å·è¡¨å‘¢ï¼Ÿ</p>\n<p>é€šè¿‡ <code>readelf -S</code>  å‘½ä»¤å¯ä»¥æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶çš„è¾“å‡ºï¼Œä¸€éƒ¨åˆ†èŠ‚æ ‡å¿—ä½ï¼ˆ <code>sh_flags</code> ï¼‰è¢«æ ‡è®°ä¸ºäº†<strong> Aï¼ˆALLOCï¼‰ã€WAï¼ˆWRITE/ALLOCï¼‰ã€AXï¼ˆALLOC/EXECï¼‰</strong>ã€‚å…¶ä¸­ï¼Œ <code>.dynsym</code>  è¢«æ ‡è®°ä¸º ALLOCï¼Œè€Œ <code>.symtab</code>  åˆ™æ²¡æœ‰æ ‡è®°ã€‚</p>\n<p>ALLOC è¡¨ç¤ºæœ‰è¯¥æ ‡è®°çš„èŠ‚ä¼šåœ¨è¿è¡Œæ—¶åˆ†é…å¹¶è£…è½½è¿›å…¥å†…å­˜ï¼Œè€Œ <code>.symtab</code>  ä¸æ˜¯åœ¨è¿è¡Œæ—¶å¿…éœ€çš„ï¼Œå› æ­¤ä¸ä¼šè¢«è£…è½½åˆ°å†…å­˜ä¸­ã€‚<strong> <code>.dynsym</code>  ä¿å­˜çš„ç¬¦å·åªèƒ½åœ¨è¿è¡Œæ—¶è¢«è§£æï¼Œå› æ­¤æ˜¯è¿è¡Œæ—¶åŠ¨æ€é“¾æ¥å™¨æ‰€éœ€çš„å”¯ä¸€ç¬¦å·</strong>ã€‚ <code>.dynsym</code>  å¯¹äºåŠ¨æ€é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶çš„æ‰§è¡Œæ˜¯å¿…éœ€çš„ï¼Œè€Œ <code>.symtab</code>  åªæ˜¯ç”¨æ¥è¿›è¡Œè°ƒè¯•å’Œé“¾æ¥çš„ã€‚</p>\n<p><img data-src=\"/ElfReader/elf-symtab-strtab.png\" alt=\"img\" style=\"aspect-ratio:2148 / 1428;\"></p>\n<p>ä¸Šå›¾æ‰€ç¤ºä¸ºé€šè¿‡ç¬¦å·è¡¨ç´¢å¼•å­—ç¬¦ä¸²è¡¨çš„ç¤ºæ„å›¾ã€‚ç¬¦å·è¡¨ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ª <code>Elf_Sym</code>  ç»“æ„ï¼Œå¯¹åº”å¯ä»¥åœ¨å­—ç¬¦ä¸²è¡¨ä¸­ç´¢å¼•å¾—åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚è¯¥æ•°æ®ç»“æ„ä¸­æˆå‘˜çš„å«ä¹‰å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">æˆå‘˜</th>\n<th style=\"text-align:left\">å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">st_name</td>\n<td style=\"text-align:left\">ç¬¦å·åã€‚è¯¥å€¼ä¸ºè¯¥ç¬¦å·ååœ¨å­—ç¬¦ä¸²è¡¨ä¸­çš„åç§»åœ°å€ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">st_value</td>\n<td style=\"text-align:left\">ç¬¦å·å¯¹åº”çš„å€¼ã€‚å­˜æ”¾ç¬¦å·çš„å€¼ï¼ˆå¯èƒ½æ˜¯åœ°å€æˆ–ä½ç½®åç§»é‡ï¼‰ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">st_size</td>\n<td style=\"text-align:left\">ç¬¦å·çš„å¤§å°ã€‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">st_other</td>\n<td style=\"text-align:left\">0</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">st_shndx</td>\n<td style=\"text-align:left\">ç¬¦å·æ‰€åœ¨çš„èŠ‚</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">st_info</td>\n<td style=\"text-align:left\">ç¬¦å·ç±»å‹åŠç»‘å®šå±æ€§</td>\n</tr>\n</tbody>\n</table>\n<p>ä½¿ç”¨ readelf å·¥å…·æˆ‘ä»¬ä¹Ÿèƒ½å¤Ÿçœ‹åˆ°ç¬¦å·è¡¨çš„ç›¸å…³ä¿¡æ¯ã€‚</p>\n<pre><code>$ readelf -s hello.o\n\nSymbol table '.symtab' contains 11 entries:\n   Num:    Value          Size Type    Bind   Vis      Ndx Name\n     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND\n     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS hello.c\n     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1\n     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3\n     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4\n     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    5\n     6: 0000000000000000     0 SECTION LOCAL  DEFAULT    7\n     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    8\n     8: 0000000000000000     0 SECTION LOCAL  DEFAULT    6\n     9: 0000000000000000    21 FUNC    GLOBAL DEFAULT    1 main\n    10: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND puts\n</code></pre>\n<h3 id=\"å­—ç¬¦ä¸²è¡¨\"><a class=\"anchor\" href=\"#å­—ç¬¦ä¸²è¡¨\">#</a> å­—ç¬¦ä¸²è¡¨</h3>\n<p>ç±»ä¼¼äºç¬¦å·è¡¨ï¼Œåœ¨å¤§å¤šæ•°å…±äº«åº“å’ŒåŠ¨æ€é“¾æ¥å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œä¹Ÿå­˜åœ¨ä¸¤ä¸ªå­—ç¬¦ä¸²è¡¨ã€‚å³ <code>.dynstr</code>  å’Œ <code>.strtab</code> ï¼Œåˆ†åˆ«å¯¹åº”äº <code>.dynsym</code>  å’Œ <code>symtab</code> ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª <code>.shstrtab</code>  çš„èŠ‚å¤´å­—ç¬¦ä¸²è¡¨ï¼Œç”¨äºä¿å­˜èŠ‚å¤´è¡¨ä¸­ç”¨åˆ°çš„å­—ç¬¦ä¸²ï¼Œå¯é€šè¿‡ <code>sh_name</code>  è¿›è¡Œç´¢å¼•ã€‚</p>\n<p>ELF æ–‡ä»¶ä¸­æ‰€æœ‰å­—ç¬¦è¡¨çš„ç»“æ„åŸºæœ¬ä¸€è‡´ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p>\n<h3 id=\"é‡å®šä½è¡¨\"><a class=\"anchor\" href=\"#é‡å®šä½è¡¨\">#</a> é‡å®šä½è¡¨</h3>\n<p><strong>é‡å®šä½å°±æ˜¯å°†ç¬¦å·å®šä¹‰å’Œç¬¦å·å¼•ç”¨è¿›è¡Œè¿æ¥çš„è¿‡ç¨‹</strong>ã€‚å¯é‡å®šä½æ–‡ä»¶éœ€è¦åŒ…å«æè¿°å¦‚ä½•ä¿®æ”¹èŠ‚å†…å®¹çš„ç›¸å…³ä¿¡æ¯ï¼Œä»è€Œä½¿å¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶èƒ½å¤Ÿä¿å­˜è¿›ç¨‹çš„ç¨‹åºé•œåƒæ‰€éœ€è¦çš„æ­£ç¡®ä¿¡æ¯ã€‚</p>\n<p>é‡å®šä½è¡¨æ˜¯è¿›è¡Œé‡å®šä½çš„é‡è¦ä¾æ®ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ objdump å·¥å…·æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶çš„é‡å®šä½è¡¨ï¼š</p>\n<pre><code>$ objdump -r hello.o\n\n\nhello.o:     file format elf64-x86-64\n\nRELOCATION RECORDS FOR [.text]:\nOFFSET           TYPE              VALUE\n0000000000000005 R_X86_64_32       .rodata\n000000000000000a R_X86_64_PC32     puts-0x0000000000000004\n\n\nRELOCATION RECORDS FOR [.eh_frame]:\nOFFSET           TYPE              VALUE\n0000000000000020 R_X86_64_PC32     .text\n</code></pre>\n<p>é‡å®šä½è¡¨æ˜¯ä¸€ä¸ª <code>Elf_Rel</code>  ç±»å‹çš„æ•°ç»„ç»“æ„ï¼Œæ¯ä¸€é¡¹å¯¹åº”ä¸€ä¸ªéœ€è¦è¿›è¡Œé‡å®šä½çš„é¡¹ã€‚ å…¶æˆå‘˜å«ä¹‰å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">æˆå‘˜</th>\n<th style=\"text-align:left\">å«ä¹‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">r_offset</td>\n<td style=\"text-align:left\">é‡å®šä½å…¥å£çš„åç§»ã€‚å¯¹äº<strong>å¯é‡å®šä½æ–‡ä»¶</strong>æ¥è¯´ï¼Œè¿™ä¸ªå€¼æ˜¯è¯¥é‡å®šä½å…¥å£æ‰€è¦ä¿®æ­£çš„ä½ç½®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ç›¸å¯¹äºèŠ‚èµ·å§‹çš„åç§»ï¼›å¯¹äº<strong>å¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«å¯¹è±¡æ–‡ä»¶</strong>æ¥è¯´ï¼Œè¿™ä¸ªå€¼æ˜¯è¯¥é‡å®šä½å…¥å£æ‰€è¦ä¿®æ­£çš„ä½ç½®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„è™šæ‹Ÿåœ°å€</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">r_info</td>\n<td style=\"text-align:left\">é‡å®šä½å…¥å£çš„ç±»å‹å’Œç¬¦å·ã€‚å› ä¸ºä¸åŒå¤„ç†å™¨çš„æŒ‡ä»¤ç³»ç»Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥é‡å®šä½æ‰€è¦ä¿®æ­£çš„æŒ‡ä»¤åœ°å€æ ¼å¼ä¹Ÿä¸ä¸€æ ·ã€‚æ¯ç§å¤„ç†å™¨éƒ½æœ‰è‡ªå·±çš„ä¸€å¥—é‡å®šä½å…¥å£çš„ç±»å‹ã€‚å¯¹äº<strong>å¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶</strong>æ¥è¯´ï¼Œå®ƒä»¬çš„é‡å®šä½å…¥å£æ˜¯åŠ¨æ€é“¾æ¥ç±»å‹çš„ã€‚</td>\n</tr>\n</tbody>\n</table>\n<p>é‡å®šä½æ˜¯ç›®æ ‡æ–‡ä»¶é“¾æ¥æˆä¸ºå¯æ‰§è¡Œæ–‡ä»¶çš„å…³é”®ã€‚</p>\n<h1 id=\"elfçš„é“¾æ¥è¿‡ç¨‹\"><a class=\"anchor\" href=\"#elfçš„é“¾æ¥è¿‡ç¨‹\">#</a> ELF çš„é“¾æ¥è¿‡ç¨‹</h1>\n<blockquote>\n<p>æ­¤å¤„çš„å†…å®¹æ¥æºäº<span class=\"exturl\" data-url=\"aHR0cDovL2NodXF1YW4ubWUvMjAxOC8wNi8wMy9saW5raW5nLXN0YXRpYy1saW5raW5nLWR5bmFtaWMtbGlua2luZy8=\">è®¡ç®—æœºé‚£äº›äº‹ (5)â€”â€” é“¾æ¥ã€é™æ€é“¾æ¥ã€åŠ¨æ€é“¾æ¥</span>ï¼Œä»…ä½œå­¦ä¹ è®°å½•å’Œå¤‡ä»½ç”¨</p>\n</blockquote>\n<h2 id=\"é“¾æ¥æ¦‚è¿°\"><a class=\"anchor\" href=\"#é“¾æ¥æ¦‚è¿°\">#</a> é“¾æ¥æ¦‚è¿°</h2>\n<p>æ¨¡å—åŒ–è®¾è®¡æ˜¯è½¯ä»¶å¼€å‘ä¸­æœ€å¸¸ç”¨çš„è®¾è®¡æ€æƒ³ã€‚<strong>é“¾æ¥ï¼ˆLinkingï¼‰</strong> æœ¬è´¨ä¸Šå°±æ˜¯æŠŠå„ä¸ªæ¨¡å—ä¹‹é—´ç›¸äº’å¼•ç”¨çš„éƒ¨åˆ†å¤„ç†å¥½ï¼Œä½¿å¾—å„ä¸ªæ¨¡å—ä¹‹é—´èƒ½å¤Ÿæ­£ç¡®è¡”æ¥ã€‚æ¯”å¦‚ï¼š</p>\n<blockquote>\n<p>æˆ‘ä»¬åœ¨æ¨¡å— <code>main.c</code>  ä¸­ä½¿ç”¨å¦ä¸€ä¸ªæ¨¡å— <code>func.c</code>  ä¸­çš„ <code>foo()</code>  å‡½æ•°ã€‚æˆ‘ä»¬åœ¨ <code>main.c</code>  æ¨¡å—ä¸­æ¯ä¸€å¤„è°ƒç”¨ <code>foo</code>  æ—¶éƒ½å¿…é¡»ç¡®åˆ‡çŸ¥é“ <code>foo</code>  å‡½æ•°çš„åœ°å€ã€‚ä½†ç”±äºæ¯ä¸ªæ¨¡å—éƒ½æ˜¯å•ç‹¬ç¼–è¯‘çš„ã€‚ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ <code>main.c</code>  çš„æ—¶å€™å¹¶ä¸çŸ¥é“ <code>foo</code>  å‡½æ•°çš„åœ°å€ã€‚æ‰€ä»¥ç¼–è¯‘å™¨ä¼šæš‚æ—¶æŠŠè¿™äº›è°ƒç”¨ <code>foo</code>  çš„æŒ‡ä»¤çš„ç›®æ ‡åœ°å€æç½®ï¼Œç­‰å¾…æœ€åé“¾æ¥æ—¶ç”±é“¾æ¥å™¨å°†è¿™äº›æŒ‡ä»¤çš„ç›®æ ‡åœ°å€ä¿®æ­£ã€‚è¿™å°±æ˜¯é™æ€é“¾æ¥æœ€åŸºæœ¬çš„è¿‡ç¨‹å’Œä½œç”¨ã€‚</p>\n</blockquote>\n<p>å¦‚ä¸‹å›¾æ‰€ç¤ºä¸ºæœ€åŸºæœ¬çš„é™æ€é“¾æ¥è¿‡ç¨‹ç¤ºæ„å›¾ã€‚æ¯ä¸ªæ¨¡å—çš„æºä»£ç æ–‡ä»¶ï¼ˆå¦‚ <code>.c</code> ï¼‰æ–‡ä»¶ç»è¿‡ç¼–è¯‘å™¨ç¼–è¯‘æˆ<strong>ç›®æ ‡æ–‡ä»¶</strong>ï¼ˆObject Fileï¼Œä¸€èˆ¬æ‰©å±•åä¸º <code>.o</code>  æˆ– <code>.obj</code> ï¼‰ã€‚ç›®æ ‡æ–‡ä»¶å’Œ <strong>åº“ï¼ˆLibraryï¼‰</strong> ä¸€èµ·é“¾æ¥å½¢æˆæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>\n<p>å…¶ä¸­ï¼Œæœ€å¸¸è§çš„åº“å°±æ˜¯<strong>è¿è¡Œæ—¶åº“ï¼ˆRuntime Libraryï¼‰</strong>ï¼Œå®ƒæ˜¯æ”¯æŒç¨‹åºè¿è¡Œçš„åŸºæœ¬å‡½æ•°çš„é›†åˆã€‚<strong>åº“æœ¬è´¨ä¸Šæ˜¯ä¸€ç»„ç›®æ ‡æ–‡ä»¶çš„åŒ…ï¼Œç”±ä¸€äº›æœ€å¸¸ç”¨çš„ä»£ç ç¼–è¯‘æˆç›®æ ‡æ–‡ä»¶åæ‰“åŒ…è€Œæˆ</strong>ã€‚</p>\n<p><img data-src=\"/ElfReader/linking-process.png\" alt=\"img\" style=\"aspect-ratio:2148 / 2595;\"></p>\n<p>é“¾æ¥è¿‡ç¨‹ä¸»è¦åŒ…å«äº†ä¸‰ä¸ªæ­¥éª¤ï¼š</p>\n<ol>\n<li><strong>åœ°å€ä¸ç©ºé—´åˆ†é…ï¼ˆAddress and Storage Allocationï¼‰</strong></li>\n<li><strong>ç¬¦å·è§£æï¼ˆSymbol Resolutionï¼‰</strong></li>\n<li><strong>é‡å®šä½ï¼ˆRelocationï¼‰</strong></li>\n</ol>\n<p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä»¥ä¸¤ä¸ªæºä»£ç æ–‡ä»¶ <code>a.c</code>  å’Œ <code>b.c</code>  ä¸ºä¾‹å±•å¼€åˆ†æã€‚</p>\n<pre><code>// a.c\nextern int shared;\n\nint main() &#123;\n    int a = 100;\n    swap(&amp;a, &amp;shared);\n&#125;\n// b.c\nint shared = 1;\n\nvoid swap(int *a, int *b) &#123;\n    *a ^= *b ^= *a ^= *b;\n&#125;\n</code></pre>\n<p>å…¶ä¸­ï¼Œ <code>b.c</code>  ä¸­å®šä¹‰äº†ä¸¤ä¸ªå…¨å±€ç¬¦å·ï¼šå˜é‡ <code>shared</code> ã€å‡½æ•° <code>swap</code> ï¼› <code>a.c</code>  ä¸­å®šä¹‰äº†ä¸€ä¸ªå…¨å±€ç¬¦å·ï¼š <code>main</code> ã€‚ <code>a.c</code>  å¼•ç”¨äº† <code>b.c</code>  ä¸­çš„ <code>swap</code>  å’Œ <code>shared</code> ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¦å°†ä¸¤ä¸ªç›®æ ‡æ–‡ä»¶é“¾æ¥åœ¨ä¸€èµ·å¹¶æœ€ç»ˆå½¢æˆä¸€ä¸ªæ‰§è¡Œç¨‹æ–‡ä»¶ <code>ab</code> ã€‚</p>\n<p>ä½¿ç”¨ <code>gcc -c</code>  å‘½ä»¤æˆ‘ä»¬å¯ä»¥åˆ†åˆ«ç¼–è¯‘å¾—åˆ° <code>a.o</code>  å’Œ <code>b.o</code>  ä¸¤ä¸ªç›®æ ‡æ–‡ä»¶ã€‚</p>\n<h3 id=\"åœ°å€ä¸ç©ºé—´åˆ†é…\"><a class=\"anchor\" href=\"#åœ°å€ä¸ç©ºé—´åˆ†é…\">#</a> åœ°å€ä¸ç©ºé—´åˆ†é…</h3>\n<p>åœ¨ä»‹ç» ELF æ–‡ä»¶ç»“æ„å…³äºæ®µä¸èŠ‚çš„åŒºåˆ«æ—¶ï¼Œæˆ‘ä»¬å°±æåˆ°è¿‡å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„æ®µæ˜¯ç”±ç›®æ ‡æ–‡ä»¶ä¸­çš„èŠ‚åˆå¹¶è€Œæ¥çš„ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šå¯¹äºå¤šä¸ªè¾“å…¥ç›®æ ‡æ–‡ä»¶ï¼Œé“¾æ¥å™¨å¦‚ä½•å°†å®ƒä»¬çš„å„ä¸ªèŠ‚åˆå¹¶åˆ°è¾“å‡ºæ–‡ä»¶å‘¢ï¼Ÿæˆ–è€…è¯´ï¼Œè¾“å‡ºæ–‡ä»¶ä¸­çš„ç©ºé—´å¦‚ä½•åˆ†é…ç»™è¾“å…¥æ–‡ä»¶ã€‚</p>\n<h4 id=\"æŒ‰åºå åŠ \"><a class=\"anchor\" href=\"#æŒ‰åºå åŠ \">#</a> æŒ‰åºå åŠ </h4>\n<p>ä¸€ä¸ªæœ€ç®€å•çš„æ–¹æ¡ˆå°±æ˜¯å°†è¾“å…¥çš„æ–‡ä»¶æŒ‰åºå åŠ ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>\n<p><img data-src=\"/ElfReader/elf-simple-merge.png\" alt=\"img\" style=\"aspect-ratio:2148 / 2595;\"></p>\n<p>è™½ç„¶è¿™ç§æ–¹æ³•éå¸¸ç®€å•ï¼Œä½†æ˜¯å®ƒå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šåœ¨æœ‰å¾ˆå¤šè¾“å…¥æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œè¾“å‡ºæ–‡ä»¶ä¼šæœ‰å¾ˆå¤šé›¶æ•£çš„èŠ‚ã€‚è¿™ç§åšæ³•éå¸¸æµªè´¹ç©ºé—´ï¼Œå› ä¸ºæ¯ä¸ªèŠ‚éƒ½éœ€è¦æœ‰ä¸€å®šçš„åœ°å€å’Œç©ºé—´å¯¹é½è¦æ±‚ã€‚x86 ç¡¬ä»¶çš„å¯¹é½è¦æ±‚æ˜¯ 4KBã€‚å¦‚æœä¸€ä¸ªèŠ‚çš„å¤§å°åªæœ‰ 1 ä¸ªå­—èŠ‚ï¼Œå®ƒä¹Ÿè¦åœ¨å†…å­˜åœ¨é‡ç”¨ 4KBã€‚è¿™æ ·ä¼šé€ æˆå¤§é‡å†…éƒ¨ç¢ç‰‡ã€‚æ‰€ä»¥ä¸æ˜¯ä¸€ä¸ªå¥½çš„æ–¹æ¡ˆã€‚</p>\n<h4 id=\"åˆå¹¶ç›¸ä¼¼èŠ‚\"><a class=\"anchor\" href=\"#åˆå¹¶ç›¸ä¼¼èŠ‚\">#</a> åˆå¹¶ç›¸ä¼¼èŠ‚</h4>\n<p>ä¸€ä¸ªæ›´åŠ å®é™…çš„æ–¹æ³•ä¾¿æ˜¯åˆå¹¶ç›¸åŒæ€§è´¨çš„èŠ‚ï¼Œæ¯”å¦‚ï¼šå°†æ‰€æœ‰è¾“å…¥æ–‡ä»¶çš„ <strong> <code>.text</code>  èŠ‚</strong>åˆå¹¶åˆ°è¾“å‡ºæ–‡ä»¶çš„ <strong> <code>text</code>  æ®µ</strong>ï¼ˆæ³¨æ„ï¼Œæ­¤æ—¶å‡ºç°äº†æ®µå’ŒèŠ‚ä¸¤ä¸ªæ¦‚å¿µï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>\n<p><img data-src=\"/ElfReader/elf-similar-merge.png\" alt=\"img\" style=\"aspect-ratio:2148 / 2595;\"></p>\n<p>å…¶ä¸­ <code>.bss</code>  èŠ‚åœ¨ç›®æ ‡æ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶ä¸­ä¸å ç”¨æ–‡ä»¶çš„ç©ºé—´ï¼Œä½†æ˜¯å®ƒåœ¨è£…è½½æ—¶å ç”¨åœ°å€ç©ºé—´ã€‚äº‹å®ä¸Šï¼Œè¿™é‡Œçš„<strong>ç©ºé—´å’Œåœ°å€</strong>æœ‰ä¸¤å±‚å«ä¹‰:</p>\n<ol>\n<li>åœ¨è¾“å‡ºçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ç©ºé—´</li>\n<li>åœ¨è£…è½½åçš„è™šæ‹Ÿåœ°å€ä¸­çš„ç©ºé—´</li>\n</ol>\n<p>å¯¹äºæœ‰å®é™…æ•°æ®çš„èŠ‚ï¼Œå¦‚ <code>.text</code>  å’Œ <code>.data</code> ï¼Œå®ƒä»¬åœ¨æ–‡ä»¶ä¸­å’Œè™šæ‹Ÿåœ°å€ä¸­éƒ½è¦åˆ†é…ç©ºé—´ï¼Œå› ä¸ºå®ƒä»¬åœ¨è¿™ä¸¤è€…ä¸­éƒ½å­˜åœ¨ï¼›å¯¹äº <code>.bss</code>  æ¥ï¼Œåˆ†é…ç©ºé—´çš„æ„ä¹‰åªå±€é™äºè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå› ä¸ºå®ƒåœ¨æ–‡ä»¶ä¸­å¹¶æ²¡æœ‰å†…å®¹ã€‚<strong>æˆ‘ä»¬åœ¨è¿™é‡Œè°ˆåˆ°çš„ç©ºé—´åˆ†é…åªå…³æ³¨äºè™šæ‹Ÿåœ°å€ç©ºé—´çš„åˆ†é…</strong>ï¼Œå› ä¸ºè¿™å…³ç³»åˆ°é“¾æ¥å™¨åé¢çš„å…³äºåœ°å€è®¡ç®—çš„æ­¥éª¤ï¼Œè€Œå¯æ‰§è¡Œæ–‡ä»¶æœ¬èº«çš„ç©ºé—´åˆ†é…ä¸é“¾æ¥çš„å…³ç³»å¹¶ä¸å¤§ã€‚</p>\n<p>ç°åœ¨çš„é“¾æ¥å™¨ç©ºé—´åˆ†é…çš„ç­–ç•¥åŸºæœ¬ä¸Šéƒ½é‡‡ç”¨ â€œåˆå¹¶ç›¸ä¼¼èŠ‚â€ çš„æ–¹æ³•ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•çš„é“¾æ¥å™¨ä¸€èˆ¬é‡‡ç”¨ä¸€ç§å« <strong>ä¸¤æ­¥é“¾æ¥ï¼ˆTwo-pass Linkingï¼‰</strong> çš„æ–¹æ³•ã€‚å³æ•´ä¸ªé“¾æ¥è¿‡ç¨‹åˆ†ä¸ºä¸¤æ­¥ï¼š</p>\n<ul>\n<li><strong>ç¬¬ä¸€æ­¥ åœ°å€ä¸ç©ºé—´åˆ†é…</strong><br>\næ‰«ææ‰€æœ‰çš„è¾“å…¥ç›®æ ‡æ–‡ä»¶ï¼Œè·å¾—å®ƒä»¬çš„å„ä¸ªèŠ‚çš„é•¿åº¦ã€å±æ€§ã€ä½ç½®ï¼Œå¹¶å°†è¾“å…¥ç›®æ ‡æ–‡ä»¶ä¸­çš„ç¬¦å·è¡¨ä¸­æ‰€æœ‰çš„ç¬¦å·å®šä¹‰å’Œç¬¦å·å¼•ç”¨æ”¶é›†èµ·æ¥ï¼Œç»Ÿä¸€æ”¾åˆ°ä¸€ä¸ªå…¨å±€çš„ç¬¦å·è¡¨ã€‚è¿™ä¸€æ­¥ï¼Œé“¾æ¥å™¨èƒ½å¤Ÿè·å¾—æ‰€æœ‰è¾“å…¥ç›®æ ‡æ–‡ä»¶çš„èŠ‚çš„é•¿åº¦ï¼Œå¹¶å°†å®ƒä»¬åˆå¹¶ï¼Œè®¡ç®—å‡ºè¾“å‡ºæ–‡ä»¶ä¸­å„ä¸ªèŠ‚åˆå¹¶åçš„é•¿åº¦ä¸ä½ç½®ï¼Œå¹¶å»ºç«‹æ˜ å°„å…³ç³»ã€‚</li>\n<li><strong>ç¬¬äºŒæ­¥ ç¬¦å·è§£æä¸é‡å®šä½</strong><br>\nä½¿ç”¨å‰ä¸€æ­¥ä¸­æ”¶é›†åˆ°çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè¯»å–è¾“å…¥æ–‡ä»¶ä¸­èŠ‚çš„è¾“æ•°æ®ã€é‡å®šä½ä¿¡æ¯ï¼Œå¹¶ä¸”è¿›è¡Œç¬¦å·è§£æä¸é‡å®šä½ã€è°ƒæ•´ä»£ç ã€è°ƒæ•´ä»£ç ä¸­çš„åœ°å€ç­‰ã€‚äº‹å®ä¸Šï¼Œç¬¬äºŒæ­¥æ˜¯é“¾æ¥è¿‡ç¨‹çš„æ ¸å¿ƒï¼Œå°¤å…¶æ˜¯é‡å®šä½ã€‚</li>\n</ul>\n<p><img data-src=\"/ElfReader/two-step-linking.png\" alt=\"img\" style=\"aspect-ratio:2148 / 1257;\"></p>\n<p>åœ¨åœ°å€ä¸ç©ºé—´åˆ†é…æ­¥éª¤å®Œæˆä¹‹åï¼Œç›¸ä¼¼æƒé™çš„èŠ‚ä¼šè¢«åˆå¹¶æˆæ®µï¼Œå¹¶ç”Ÿæˆäº†<span class=\"exturl\" data-url=\"aHR0cDovL2NodXF1YW4ubWUvMjAxOC8wNS8yMS9lbGYtaW50cm9kdWNlLw==\"> ELF æ–‡ä»¶ç»“æ„</span>ä¸€æ–‡ä¸­æ²¡æœ‰ä»‹ç»çš„ <strong>ç¨‹åºå¤´è¡¨ï¼ˆProgram Header Tableï¼‰</strong> ç»“æ„ã€‚å¦‚ä¸‹å³å›¾å¯æ‰§è¡Œæ–‡ä»¶ç»“æ„æ‰€ç¤ºï¼Œä¸»è¦ç”Ÿæˆä¸¤ä¸ªæ®µï¼šä»£ç æ®µï¼ˆ  <code>text</code>  æ®µï¼‰ã€æ•°æ®æ®µï¼ˆ  <code>data</code>  æ®µ ï¼‰ã€‚</p>\n<p><img data-src=\"/ElfReader/different-elf-type.png\" alt=\"img\" style=\"aspect-ratio:2148 / 1257;\"></p>\n<p>æˆ‘ä»¬ä½¿ç”¨ ld æˆ– gcc å°† <code>a.o</code>  å’Œ <code>b.o</code>  é“¾æ¥èµ·æ¥ï¼Œç„¶åä½¿ç”¨ objdump å·¥å…·æ¥æŸ¥çœ‹é“¾æ¥å‰åçš„åœ°å€åˆ†é…æƒ…å†µã€‚</p>\n<pre><code>$ objdump -h a.o\n\nSections:\nIdx Name          Size      VMA               LMA               File off  Algn\n  0 .text         0000004f  0000000000000000  0000000000000000  00000040  2**0\n                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE\n  1 .data         00000000  0000000000000000  0000000000000000  0000008f  2**0\n                  CONTENTS, ALLOC, LOAD, DATA\n  2 .bss          00000000  0000000000000000  0000000000000000  0000008f  2**0\n                  ALLOC\n  ...\n$ objdump -h b.o\n\nSections:\nIdx Name          Size      VMA               LMA               File off  Algn\n  0 .text         0000004b  0000000000000000  0000000000000000  00000040  2**0\n                  CONTENTS, ALLOC, LOAD, READONLY, CODE\n  1 .data         00000004  0000000000000000  0000000000000000  0000008c  2**2\n                  CONTENTS, ALLOC, LOAD, DATA\n  2 .bss          00000000  0000000000000000  0000000000000000  00000090  2**0\n                  ALLOC\n  ...\n$ objdump -h ab\n\nSections:\nIdx Name          Size      VMA               LMA               File off  Algn\n  ...\n  13 .text         00000202  0000000000400450  0000000000400450  00000450  2**4\n                  CONTENTS, ALLOC, LOAD, READONLY, CODE\n  ...\n  24 .data         00000014  0000000000601028  0000000000601028  00001028  2**3\n                  CONTENTS, ALLOC, LOAD, DATA\n  25 .bss          00000004  000000000060103c  000000000060103c  0000103c  2**0\n                  ALLOC\n  ...\n</code></pre>\n<p>å¯ä»¥å‘ç°ï¼Œé“¾æ¥å‰ç›®æ ‡æ–‡ä»¶ä¸­æ‰€æœ‰èŠ‚çš„ <strong>VMAï¼ˆVirtual Memory Addressï¼‰</strong> éƒ½æ˜¯ 0ï¼Œå› ä¸ºè™šæ‹Ÿç©ºé—´è¿˜æ²¡æœ‰åˆ†é…ã€‚é“¾æ¥åï¼Œå¯æ‰§è¡Œæ–‡ä»¶ <code>ab</code>  ä¸­å„ä¸ªèŠ‚è¢«åˆ†é…åˆ°äº†ç›¸åº”çš„è™šæ‹Ÿåœ°å€ï¼Œå¦‚ <code>.text</code>  èŠ‚è¢«åˆ†é…åˆ°äº†åœ°å€ <code>0x0000000000400450</code> ã€‚</p>\n<p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆé“¾æ¥å™¨è¦å°†å¯æ‰§è¡Œæ–‡ä»¶ <code>ab</code>  çš„ <code>.text</code>  èŠ‚åˆ†é…åˆ° <code>0x0000000000400450</code> ï¼Ÿè€Œä¸æ˜¯ä»è™šæ‹Ÿç©ºé—´çš„ 0 åœ°å€å¼€å§‹åˆ†é…å‘¢ï¼Ÿè¿™æ¶‰åŠåˆ°æ“ä½œç³»ç»Ÿçš„è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„åˆ†é…è§„åˆ™ã€‚åœ¨ Linux x86-64 ç³»ç»Ÿä¸­ï¼Œä»£ç æ®µæ€»æ˜¯ä» <code>0x0000000000400000</code>  å¼€å§‹çš„ï¼Œå¦å¤– <code>.text</code>  èŠ‚ä¹‹å‰è¿˜æœ‰ <code>ELF Header</code> ã€ <code>Program Header Table</code> ã€ <code>.init</code>  ç­‰å ç”¨äº†ä¸€å®šçš„ç©ºé—´ï¼Œæ‰€ä»¥å°±è¢«åˆ†é…åˆ°äº† <code>0x0000000000400450</code> ã€‚</p>\n<h3 id=\"ç¬¦å·è§£æ\"><a class=\"anchor\" href=\"#ç¬¦å·è§£æ\">#</a> ç¬¦å·è§£æ</h3>\n<p>åœ¨<strong>ä¸¤æ­¥é“¾æ¥</strong>ä¸­ï¼Œè¿™ä¸€æ­¥å’Œé‡å®šä½è¢«åˆå¹¶æˆäº†ä¸€æ­¥ï¼Œè¿™æ˜¯å› ä¸ºé‡å®šä½çš„è¿‡ç¨‹æ˜¯ä¼´éšç€ç¬¦å·è§£æçš„ã€‚è¿™é‡Œæˆ‘ä»¬åˆ†å¼€ä»‹ç»ã€‚</p>\n<p>é“¾æ¥å™¨è§£æç¬¦å·å¼•ç”¨çš„æ–¹æ³•æ˜¯å°†æ¯ä¸ªå¼•ç”¨ä¸å®ƒè¾“å…¥çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ä¸­çš„ä¸€ä¸ªç¡®å®šçš„ç¬¦å·å®šä¹‰å…³è”èµ·æ¥ã€‚å¯¹é‚£äº›å’Œå¼•ç”¨å®šä¹‰åœ¨ç›¸åŒæ¨¡å—çš„å±€éƒ¨ç¬¦å·çš„å¼•ç”¨ï¼Œç¬¦å·è§£ææ˜¯éå¸¸ç®€å•çš„ã€‚ç¼–è¯‘å™¨åªå…è®¸æ¯ä¸ªæ¨¡å—ä¸­æ¯ä¸ªå±€éƒ¨ç¬¦å·æœ‰ä¸€ä¸ªå®šä¹‰ã€‚é™æ€å±€éƒ¨å˜é‡ä¹Ÿä¼šæœ‰æœ¬åœ°é“¾æ¥å™¨ç¬¦å·ï¼Œç¼–è¯‘å™¨è¿˜è¦ç¡®ä¿å®ƒä»¬æ‹¥æœ‰å”¯ä¸€çš„åå­—ã€‚</p>\n<p>ç„¶è€Œï¼Œå¯¹äºå…¨å±€ç¬¦å·çš„è§£æè¦å¤æ‚å¾—å¤šã€‚å½“ç¼–è¯‘å™¨é‡åˆ°ä¸€ä¸ªä¸æ˜¯åœ¨å½“å‰æ¨¡å—ä¸­å®šä¹‰çš„ç¬¦å·ï¼ˆå˜é‡æˆ–å‡½æ•°åï¼‰æ—¶ï¼Œä¼šå‡è®¾è¯¥ç¬¦å·æ˜¯åœ¨å…¶ä»–æŸä¸ªæ¨¡å—ä¸­å®šä¹‰çš„ï¼Œç”Ÿæˆä¸€ä¸ªé“¾æ¥å™¨ç¬¦å·è¡¨æ¡ç›®ï¼Œå¹¶æŠŠå®ƒäº¤ç»™é“¾æ¥å™¨å¤„ç†ã€‚å¦‚æœé“¾æ¥å™¨åœ¨å®ƒçš„ä»»ä½•è¾“å…¥æ¨¡å—ä¸­éƒ½æ‰¾ä¸åˆ°è¿™ä¸ªè¢«å¼•ç”¨ç¬¦å·çš„å®šä¹‰ï¼Œå°±è¾“å‡ºä¸€æ¡é”™è¯¯ä¿¡æ¯å¹¶ç»ˆæ­¢ã€‚</p>\n<p>å¦ä¸€æ–¹é¢ï¼Œå¯¹å…¨å±€ç¬¦å·çš„è§£æï¼Œç»å¸¸ä¼šé¢ä¸´å¤šä¸ªç›®æ ‡æ–‡ä»¶å¯èƒ½ä¼šå®šä¹‰ç›¸åŒåå­—çš„å…¨å±€ç¬¦å·ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œé“¾æ¥å™¨å¿…é¡»è¦ä¹ˆæ ‡å¿—ä¸€ä¸ªé”™è¯¯ï¼Œè¦ä¹ˆä»¥æŸç§æ–¹æ³•é€‰å‡ºä¸€ä¸ªå®šä¹‰å¹¶æŠ›å¼ƒå…¶ä»–å®šä¹‰ã€‚</p>\n<h4 id=\"å¤šé‡å®šä¹‰çš„å…¨å±€ç¬¦å·è§£æ\"><a class=\"anchor\" href=\"#å¤šé‡å®šä¹‰çš„å…¨å±€ç¬¦å·è§£æ\">#</a> å¤šé‡å®šä¹‰çš„å…¨å±€ç¬¦å·è§£æ</h4>\n<p>é“¾æ¥å™¨çš„è¾“å…¥æ˜¯ä¸€ç»„å¯é‡å®šä½ç›®æ ‡æ¨¡å—ã€‚æ¯ä¸ªæ¨¡å—å®šä¹‰ä¸€ç»„ç¬¦å·ï¼Œæœ‰äº›æ˜¯å±€éƒ¨ç¬¦å·ï¼ˆåªå¯¹å®šä¹‰è¯¥ç¬¦å·çš„æ¨¡å—å¯è§ï¼‰ï¼Œæœ‰äº›æ˜¯å…¨å±€ç¬¦å·ï¼ˆå¯¹å…¶ä»–æ¨¡å—ä¹Ÿå¯è§ï¼‰ã€‚å¦‚æœå¤šä¸ªæ¨¡å—å®šä¹‰åŒåçš„å…¨å±€ç¬¦å·ï¼Œè¯¥å¦‚ä½•è¿›è¡Œå–èˆï¼Ÿ</p>\n<p>Linux ç¼–è¯‘ç³»ç»Ÿé‡‡ç”¨å¦‚ä¸‹çš„æ–¹æ³•è§£å†³å¤šé‡å®šä¹‰çš„å…¨å±€ç¬¦å·è§£æï¼š</p>\n<p><strong>åœ¨ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨æƒ³æ±‡ç¼–å™¨è¾“å‡ºæ¯ä¸ªå…¨å±€ç¬¦å·ï¼Œæˆ–è€…æ˜¯å¼ºï¼ˆstrongï¼‰æˆ–è€…æ˜¯å¼±ï¼ˆweakï¼‰ï¼Œè€Œæ±‡ç¼–å™¨æŠŠè¿™ä¸ªä¿¡æ¯éšå«åœ°ç¼–ç åœ¨å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ä¸­ã€‚</strong></p>\n<p>æ ¹æ®å¼ºå¼±ç¬¦å·çš„å®šä¹‰ï¼ŒLinux é“¾æ¥å™¨ä½¿ç”¨ä¸‹é¢çš„è§„åˆ™æ¥å¤„ç†å¤šé‡å®šä¹‰çš„ç¬¦å·åï¼š</p>\n<ul>\n<li><strong>è§„åˆ™ 1ï¼šä¸å…è®¸æœ‰å¤šä¸ªåŒåçš„å¼ºç¬¦å·ã€‚</strong></li>\n<li><strong>è§„åˆ™ 2ï¼šå¦‚æœæœ‰ä¸€ä¸ªå¼ºç¬¦å·å’Œå¤šä¸ªå¼±ç¬¦å·åŒåï¼Œåˆ™é€‰æ‹©å¼ºç¬¦å·ã€‚</strong></li>\n<li><strong>è§„åˆ™ 3ï¼šå¦‚æœæœ‰å¤šä¸ªå¼±ç¬¦å·åŒåï¼Œåˆ™ä»è¿™äº›å¼±ç¬¦å·ä¸­ä»»æ„é€‰æ‹©ä¸€ä¸ªã€‚</strong></li>\n</ul>\n<p>å¦ä¸€æ–¹é¢ï¼Œç”±äºå…è®¸ä¸€ä¸ªç¬¦å·å®šä¹‰åœ¨å¤šä¸ªæ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœä¸€ä¸ªå¼±ç¬¦å·å®šä¹‰åœ¨å¤šä¸ªç›®æ ‡æ–‡ä»¶ä¸­ï¼Œè€Œå®ƒä»¬çš„ç±»å‹ä¸åŒï¼Œæ€ä¹ˆåŠï¼Ÿè¿™ç§æƒ…å†µä¸»è¦æœ‰ä¸‰ç§ï¼š</p>\n<ul>\n<li><strong>æƒ…å†µ 1ï¼šä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„å¼ºç¬¦å·ç±»å‹ä¸ä¸€è‡´ã€‚</strong></li>\n<li><strong>æƒ…å†µ 2ï¼šæœ‰ä¸€ä¸ªå¼ºç¬¦å·ï¼Œå…¶ä»–éƒ½æ˜¯å¼±ç¬¦å·ï¼Œå‡ºç°ç±»å‹ä¸ä¸€è‡´ã€‚</strong></li>\n<li><strong>æƒ…å†µ 3ï¼šä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šå¼±ç¬¦å·ç±»å‹ä¸ä¸€è‡´ã€‚</strong></li>\n</ul>\n<p>å…¶ä¸­ï¼Œæƒ…å†µ 1 ç”±äºå¤šä¸ªå¼ºç¬¦å·å®šä¹‰æœ¬èº«å°±æ˜¯éæ³•çš„ï¼Œæ‰€ä»¥é“¾æ¥å™¨å°±ä¼šæŠ¥é”™ã€‚å¯¹äºåä¸¤ç§æƒ…å†µï¼Œç¼–è¯‘å™¨å’Œé“¾æ¥å™¨é‡‡ç”¨ä¸€ç§å« <strong>COMMON å—ï¼ˆCommon Block ï¼‰</strong> çš„æœºåˆ¶æ¥å¤„ç†ã€‚å…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>\n<p><strong>é¦–å…ˆï¼Œç¼–è¯‘å™¨å°†æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å®šä¹‰ä¸ºå¼±ç¬¦å·å¤„ç†ã€‚å¯¹äºæƒ…å†µ 3ï¼Œæœ€ç»ˆé“¾æ¥æ—¶é€‰æ‹©æœ€å¤§çš„ç±»å‹ã€‚å¯¹äºæƒ…å†µ 2ï¼Œæœ€ç»ˆè¾“å‡ºç»“æœä¸­çš„ç¬¦å·æ‰€å ç©ºé—´ä¸å¼ºç¬¦å·ç›¸åŒï¼Œå¦‚æœé“¾æ¥è¿‡ç¨‹ä¸­æœ‰å¼±ç¬¦å·å¤§äºå¼ºç¬¦å·ï¼Œé“¾æ¥å™¨ä¼šå‘å‡ºè­¦å‘Šã€‚</strong></p>\n<h3 id=\"é‡å®šä½\"><a class=\"anchor\" href=\"#é‡å®šä½\">#</a> é‡å®šä½</h3>\n<p>äº‹å®ä¸Šï¼Œé‡å®šä½è¿‡ç¨‹ä¹Ÿä¼´éšç€ç¬¦å·çš„è§£æè¿‡ç¨‹ã€‚é“¾æ¥çš„å‰ä¸¤æ­¥å®Œæˆä¹‹åï¼Œé“¾æ¥å™¨å°±å·²ç»ç¡®å®šæ‰€æœ‰ç¬¦å·çš„è™šæ‹Ÿåœ°å€äº†ï¼Œé‚£ä¹ˆé“¾æ¥å™¨å°±å¯ä»¥æ ¹æ®ç¬¦å·çš„åœ°å€å¯¹æ¯ä¸ªéœ€è¦é‡å®šä½çš„æŒ‡ä»¤è¿›è¡Œåœ°å€ä¿®æ­£ã€‚</p>\n<p>é‚£ä¹ˆé“¾æ¥å™¨å¦‚ä½•çŸ¥é“å“ªäº›æŒ‡ä»¤æ˜¯è¦è¢«è°ƒæ•´çš„å‘¢ï¼Ÿäº‹å®ä¸Šï¼Œæˆ‘ä»¬å‰é¢æåˆ°çš„ ELF æ–‡ä»¶ä¸­çš„ <strong>é‡å®šä½è¡¨ï¼ˆRelocation Tableï¼‰</strong> ä¸“é—¨ç”¨æ¥ä¿å­˜è¿™äº›ä¸é‡å®šä½ç›¸å…³çš„ä¿¡æ¯ã€‚</p>\n<p>å¯¹äºå¯é‡å®šä½çš„ ELF æ–‡ä»¶æ¥è¯´ï¼Œå®ƒå¿…é¡»åŒ…å«é‡å®šä½è¡¨ï¼Œç”¨æ¥æè¿°å¦‚ä½•ä¿®æ”¹ç›¸åº”çš„èŠ‚çš„å†…å®¹ã€‚å¯¹äºæ¯ä¸ªè¦è¢«é‡å®šä½çš„ ELF èŠ‚éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„é‡å®šä½è¡¨ã€‚å¦‚æœ <code>.text</code>  èŠ‚éœ€è¦è¢«é‡å®šä½ï¼Œåˆ™ä¼šæœ‰ä¸€ä¸ªç›¸å¯¹åº”å« <code>.rel.text</code>  çš„èŠ‚ä¿å­˜äº†ä»£ç èŠ‚çš„é‡å®šä½è¡¨ï¼›å¦‚æœ <code>.data</code>  èŠ‚éœ€è¦è¢«é‡å®šä½ï¼Œåˆ™ä¼šæœ‰ä¸€ä¸ªç›¸å¯¹åº”çš„ <code>.rel.tdata</code>  çš„èŠ‚ä¿å­˜äº†æ•°æ®èŠ‚çš„é‡å®šä½è¡¨ã€‚</p>\n<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ objdump å·¥å…·æ¥æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶ä¸­çš„é‡å®šä½è¡¨ï¼š</p>\n<pre><code>$ objdump -r a.o\n\na.o:     file format elf64-x86-64\n\nRELOCATION RECORDS FOR [.text]:\nOFFSET           TYPE              VALUE\n0000000000000023 R_X86_64_32       share\n0000000000000030 R_X86_64_PC32     swap-0x0000000000000004\n0000000000000049 R_X86_64_PC32     __stack_chk_fail-0x0000000000000004\n\n\nRELOCATION RECORDS FOR [.eh_frame]:\nOFFSET           TYPE              VALUE\n0000000000000020 R_X86_64_PC32     .text\n</code></pre>\n<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯ä¸ªè¦è¢«é‡å®šä½çš„åœ°æ–¹æ˜¯ä¸€ä¸ª <strong>é‡å®šä½å…¥å£ï¼ˆRelocation Entryï¼‰</strong>ã€‚åˆ©ç”¨æ•°æ®ç»“æ„æˆå‘˜åŒ…å«çš„ä¿¡æ¯ï¼Œå³å¯å®Œæˆé‡å®šä½ã€‚</p>\n<h2 id=\"é™æ€é“¾æ¥\"><a class=\"anchor\" href=\"#é™æ€é“¾æ¥\">#</a> é™æ€é“¾æ¥</h2>\n<p>äº‹å®ä¸Šï¼Œé™æ€é“¾æ¥çš„è¿‡ç¨‹å°±æ˜¯ä¸Šæ–‡æ‰€æè¿°çš„è¿‡ç¨‹ã€‚åœ¨ Linux ä¸­ï¼Œé™æ€é“¾æ¥å™¨ï¼ˆstatic linkerï¼‰ <code>ld</code>  ä»¥ä¸€ç»„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶å’Œå‘½ä»¤è¡Œå‚æ•°ä½œä¸ºè¾“å…¥ï¼Œç”Ÿæˆä¸€ä¸ªå®Œå…¨é“¾æ¥çš„ã€å¯ä»¥åŠ è½½å’Œè¿è¡Œçš„å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä½œä¸ºè¾“å‡ºã€‚è¾“å…¥çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ç”±å„ç§ä¸åŒçš„èŠ‚ç»„æˆï¼Œæ¯ä¸€èŠ‚éƒ½æ˜¯ä¸€ä¸ªè¿ç»­çš„å­—èŠ‚åºåˆ—ã€‚</p>\n<h2 id=\"åŠ¨æ€é“¾æ¥\"><a class=\"anchor\" href=\"#åŠ¨æ€é“¾æ¥\">#</a> åŠ¨æ€é“¾æ¥</h2>\n<p>é™æ€é“¾æ¥ä½¿å¾—è¿›è¡Œæ¨¡å—åŒ–å¼€å‘ï¼Œå¤§å¤§æä¾›äº†ç¨‹åºçš„å¼€å‘æ•ˆç‡ã€‚éšç€ï¼Œç¨‹åºè§„æ¨¡çš„æ‰©å¤§ï¼Œé™æ€é“¾æ¥çš„è¯¸å¤šç¼ºç‚¹ä¹Ÿé€æ¸æš´éœ²å‡ºæ¥ï¼Œå¦‚ï¼šæµªè´¹å†…å­˜å’Œç£ç›˜ç©ºé—´ã€æ¨¡å—æ›´æ–°å›°éš¾ç­‰ã€‚åœ¨é™æ€é“¾æ¥ä¸­ï¼ŒC è¯­è¨€é™æ€åº“æ˜¯å¾ˆå…¸å‹çš„æµªè´¹ç©ºé—´çš„ä¾‹å­ã€‚å…³äºæ¨¡å—æ›´æ–°ï¼Œé™æ€é“¾æ¥çš„ç¨‹åºæœ‰ä»»ä½•æ›´æ–°ï¼Œéƒ½å¿…é¡»é‡æ–°ç¼–è¯‘é“¾æ¥ï¼Œç”¨æˆ·åˆ™éœ€è¦é‡æ–°ä¸‹è½½å®‰è£…è¯¥ç¨‹åºã€‚</p>\n<p>è§£å†³ç©ºé—´æµªè´¹å’Œæ›´æ–°å›°éš¾æœ€ç®€å•çš„æ–¹æ³•ä¾¿æ˜¯å°†ç¨‹åºçš„æ¨¡å—ç›¸äº’åˆ†å‰²å¼€æ¥ï¼Œå½¢æˆç‹¬ç«‹æ–‡ä»¶ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯ä¸å¯¹é‚£äº›ç»„æˆç¨‹åºçš„ç›®æ ‡æ–‡ä»¶è¿›è¡Œé“¾æ¥ï¼Œè€Œæ˜¯ç­‰åˆ°ç¨‹åºè¦è¿è¡Œæ—¶æ‰è¿›è¡Œé“¾æ¥ã€‚</p>\n<h3 id=\"åŠ¨æ€é“¾æ¥çš„åŸºæœ¬å®ç°\"><a class=\"anchor\" href=\"#åŠ¨æ€é“¾æ¥çš„åŸºæœ¬å®ç°\">#</a> åŠ¨æ€é“¾æ¥çš„åŸºæœ¬å®ç°</h3>\n<p>åŠ¨æ€é“¾æ¥æ¶‰åŠè¿è¡Œæ—¶çš„é“¾æ¥ä»¥åŠå¤šä¸ªæ–‡ä»¶çš„è£…è½½ï¼Œå¿…éœ€è¦æœ‰æ“ä½œç³»ç»Ÿçš„æ”¯æŒã€‚å› ä¸ºåŠ¨æ€é“¾æ¥çš„æƒ…å†µä¸‹ï¼Œè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„åˆ†å¸ƒä¼šæ¯”é™æ€é“¾æ¥æƒ…å†µä¸‹æ›´ä¸ºå¤æ‚ï¼Œè¿˜æœ‰ä¸€äº›å­˜å‚¨ç®¡ç†ã€å†…å­˜å…±äº«ã€è¿›ç¨‹çº¿ç¨‹ç­‰æœºåˆ¶åœ¨åŠ¨æ€é“¾æ¥ä¸‹ä¹Ÿä¼šæœ‰ä¸€äº›å¾®å¦™çš„å˜åŒ–ã€‚</p>\n<p>ç›®å‰ï¼Œä¸»æµæ“ä½œç³»ç»Ÿéƒ½æ”¯æŒåŠ¨æ€é“¾æ¥ã€‚åœ¨ Linux ä¸­ï¼ŒELF åŠ¨æ€é“¾æ¥æ–‡ä»¶è¢«ç§°ä¸º <strong>åŠ¨æ€å…±äº«å¯¹è±¡ï¼ˆDSOï¼ŒDynamic Shared Objectsï¼‰</strong>ï¼Œä¸€èˆ¬ä»¥ <code>.so</code>  ä¸ºåç¼€ï¼›åœ¨ Windows ä¸­ï¼ŒåŠ¨æ€é“¾æ¥æ–‡ä»¶è¢«ç§°ä¸º <strong>åŠ¨æ€é“¾æ¥åº“ï¼ˆDynamic Linking Libraryï¼‰</strong>ï¼Œä¸€èˆ¬ä»¥ <code>.dll</code>  ä¸ºåç¼€ã€‚</p>\n<p>åœ¨ Linux ä¸­ï¼Œå¸¸ç”¨çš„ C è¯­è¨€åº“çš„è¿è¡Œåº“ glibcï¼Œå…¶åŠ¨æ€é“¾æ¥å½¢å¼çš„ç‰ˆæœ¬ä¿ç•™åœ¨  <code>/lib</code>  ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åä¸º  <code>libc.so</code> ã€‚æ•´ä¸ªç³»ç»Ÿåªä¿ç•™ä¸€ä»½ C è¯­è¨€åŠ¨æ€é“¾æ¥æ–‡ä»¶ <code>libc.so</code> ï¼Œæ‰€æœ‰çš„ C è¯­è¨€ç¼–å†™çš„ã€åŠ¨æ€é“¾æ¥çš„ç¨‹åºéƒ½å¯ä»¥åœ¨è¿è¡Œæ—¶ä½¿ç”¨å®ƒã€‚å½“ç¨‹åºè¢«è£…è½½æ—¶ï¼Œç³»ç»Ÿçš„<strong>åŠ¨æ€é“¾æ¥å™¨</strong>ä¼šå°†ç¨‹åºæ‰€éœ€è¦çš„æ‰€æœ‰åŠ¨æ€é“¾æ¥åº“è£…è½½åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå¹¶å°†ç¨‹åºä¸­æ‰€æœ‰æœªè§£æçš„ç¬¦å·ç»‘å®šåˆ°ç›¸åº”çš„åŠ¨æ€é“¾æ¥åº“ä¸­ï¼Œå¹¶è¿›è¡Œé‡å®šä½ã€‚</p>\n<h3 id=\"åŠ¨æ€é“¾æ¥ç¨‹åºè¿è¡Œæ—¶åœ°å€ç©ºé—´åˆ†å¸ƒ\"><a class=\"anchor\" href=\"#åŠ¨æ€é“¾æ¥ç¨‹åºè¿è¡Œæ—¶åœ°å€ç©ºé—´åˆ†å¸ƒ\">#</a> åŠ¨æ€é“¾æ¥ç¨‹åºè¿è¡Œæ—¶åœ°å€ç©ºé—´åˆ†å¸ƒ</h3>\n<p>å¯¹äºé™æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶æ¥è¯´ï¼Œæ•´ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªæ–‡ä»¶è¦è¢«æ˜ å°„ï¼Œå³å¯æ‰§è¡Œæ–‡ä»¶ã€‚è€Œå¯¹äºåŠ¨æ€é“¾æ¥ï¼Œé™¤äº†å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿˜æœ‰å®ƒæ‰€ä¾èµ–çš„å…±äº«ç›®æ ‡æ–‡ä»¶ã€‚</p>\n<p>å…³äºå…±äº«ç›®æ ‡æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„åœ°å€åˆ†é…ï¼Œä¸»è¦æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œåˆ†åˆ«æ˜¯ï¼š</p>\n<ul>\n<li><strong>é™æ€å…±äº«åº“ï¼ˆStatic Shared Libraryï¼‰</strong>ï¼ˆåœ°å€å›ºå®šï¼‰</li>\n<li><strong>åŠ¨æ€å…±äº«åº“ï¼ˆDynamic Shared Libaryï¼‰</strong>ï¼ˆåœ°å€ä¸å›ºå®šï¼‰</li>\n</ul>\n<h4 id=\"é™æ€å…±äº«åº“\"><a class=\"anchor\" href=\"#é™æ€å…±äº«åº“\">#</a> é™æ€å…±äº«åº“</h4>\n<p>é™æ€å…±äº«åº“çš„åšæ³•æ˜¯å°†ç¨‹åºçš„å„ä¸ªæ¨¡å—ç»Ÿä¸€äº¤ç»™æ“ä½œç³»ç»Ÿè¿›è¡Œç®¡ç†ï¼Œæ“ä½œç³»ç»Ÿåœ¨<strong>æŸä¸ªç‰¹å®šçš„åœ°å€</strong>åˆ’åˆ†å‡ºä¸€äº›åœ°å€å—ï¼Œä¸ºé‚£äº›å·²çŸ¥çš„æ¨¡å—é¢„ç•™è¶³å¤Ÿçš„ç©ºé—´ã€‚å› ä¸ºè¿™ä¸ªåœ°å€å¯¹äºä¸åŒçš„åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œéƒ½æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥ç§°ä¹‹ä¸º<strong>é™æ€</strong>ã€‚</p>\n<p>ä½†æ˜¯é™æ€å…±äº«åº“çš„ç›®æ ‡åœ°å€ä¼šå¯¼è‡´åœ°å€å†²çªã€å‡çº§ç­‰é—®é¢˜ã€‚</p>\n<h4 id=\"åŠ¨æ€å…±äº«åº“\"><a class=\"anchor\" href=\"#åŠ¨æ€å…±äº«åº“\">#</a> åŠ¨æ€å…±äº«åº“</h4>\n<p>é‡‡ç”¨åŠ¨æ€å…±äº«åº“çš„æ–¹å¼ï¼Œä¹Ÿç§°ä¸º<strong>è£…è½½æ—¶é‡å®šä½ï¼ˆLoad Time Relocationï¼‰</strong>ã€‚å…¶åŸºæœ¬æ€è·¯æ˜¯ï¼š<strong>åœ¨é“¾æ¥æ—¶ï¼Œå¯¹æ‰€æœ‰ç»å¯¹åœ°å€çš„å¼•ç”¨éƒ½ä¸ä½œé‡å®šä½ï¼Œè€ŒæŠŠè¿™ä¸€æ­¥æ¨è¿Ÿåˆ°è£…è½½æ—¶å†å®Œæˆã€‚ä¸€æ—¦æ¨¡å—è£…è½½åœ°å€ç¡®å®šï¼Œå³ç›®æ ‡åœ°å€ç¡®å®šï¼Œé‚£ä¹ˆç³»ç»Ÿå°±å¯¹ç¨‹åºä¸­æ‰€æœ‰çš„ç»å¯¹åœ°å€å¼•ç”¨è¿›è¡Œé‡å®šä½ã€‚</strong></p>\n<p>ä½†æ˜¯è¿™ç§æ–¹å¼ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ã€‚æ¯”å¦‚ï¼ŒåŠ¨æ€é“¾æ¥æ¨¡å—è¢«è£…è½½æ˜ å°„è‡³è™šæ‹Ÿç©ºé—´åï¼ŒæŒ‡ä»¤éƒ¨åˆ†æ˜¯åœ¨å¤šä¸ªè¿›ç¨‹é—´å…±äº«çš„ï¼Œç”±äºè£…è½½æ—¶é‡å®šä½çš„æ–¹æ³•éœ€è¦ä¿®æ”¹æŒ‡ä»¤ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•åšåˆ°åŒä¸€ä»½æŒ‡ä»¤è¢«å¤šä¸ªè¿›ç¨‹å…±äº«ï¼Œå› ä¸ºæŒ‡ä»¤è¢«é‡å®šä½åå¯¹äºæ¯ä¸ªè¿›ç¨‹æ¥è¯´éƒ½æ˜¯ä¸åŒçš„ã€‚</p>\n<p>è™½ç„¶ï¼ŒåŠ¨æ€é“¾æ¥åº“ä¸­çš„ä»£ç æ˜¯å…±äº«çš„ï¼Œä½†æ˜¯å…¶ä¸­çš„å¯ä¿®æ”¹æ•°æ®éƒ¨åˆ†å¯¹äºä¸åŒè¿›ç¨‹æ¥è¯´æ˜¯ç”±å¤šä¸ªå‰¯æœ¬çš„ã€‚åŸºäºæ­¤ï¼Œä¸€ç§åä¸º<strong>åœ°å€æ— å…³ä»£ç </strong>çš„æŠ€æœ¯è¢«æå‡ºä»¥å…‹æœè¿™ä¸ªé—®é¢˜ã€‚</p>\n<h4 id=\"åœ°å€æ— å…³ä»£ç \"><a class=\"anchor\" href=\"#åœ°å€æ— å…³ä»£ç \">#</a> åœ°å€æ— å…³ä»£ç </h4>\n<blockquote>\n<p>è®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªé—´æ¥çš„ä¸­é—´å±‚æ¥è§£å†³ã€‚</p>\n</blockquote>\n<p><strong>åœ°å€æ— å…³ä»£ç ï¼ˆPICï¼ŒPosition-independent Codeï¼‰</strong> æŠ€æœ¯å®Œç¾é˜é‡Šäº†ä¸Šé¢è¿™å¥åè¨€ï¼Œå…¶åŸºæœ¬åŸç†æ˜¯ï¼šæŠŠæŒ‡ä»¤ä¸­é‚£äº›éœ€è¦è¢«ä¿®æ”¹çš„éƒ¨åˆ†åˆ†ç¦»å‡ºæ¥ï¼Œè·Ÿæ•°æ®éƒ¨åˆ†æ”¾åœ¨ä¸€èµ·ï¼Œè¿™æ ·æŒ‡ä»¤éƒ¨åˆ†å°±å¯ä»¥ä¿æŒä¸å˜ï¼Œè€Œæ•°æ®éƒ¨åˆ†å¯ä»¥åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­æ‹¥æœ‰ä¸€ä¸ªå‰¯æœ¬ã€‚</p>\n<p>å…±äº«å¯¹è±¡æ¨¡å—ä¸­çš„åœ°å€å¼•ç”¨æŒ‰ç…§æ˜¯å¦ä¸ºè·¨æ¨¡å—åˆ†ä¸ºä¸¤ç±»ï¼šæ¨¡å—å†…éƒ¨å¼•ç”¨ã€æ¨¡å—å¤–éƒ¨å¼•ç”¨ã€‚æŒ‰ç…§ä¸ç”¨çš„å¼•ç”¨æ–¹å¼åˆå¯åˆ†ä¸ºï¼šæŒ‡ä»¤å¼•ç”¨ã€æ•°æ®å¼•ç”¨ã€‚ä»¥å¦‚ä¸‹ä»£ç ä¸ºä¾‹ï¼Œå¯å¾—å‡ºå¦‚ä¸‹å››ç§ç±»å‹ï¼š</p>\n<ul>\n<li><strong>ç±»å‹ 1ï¼šæ¨¡å—å†…éƒ¨çš„å‡½æ•°è°ƒç”¨ã€‚</strong></li>\n<li><strong>ç±»å‹ 2ï¼šæ¨¡å—å†…éƒ¨çš„æ•°æ®è®¿é—®ï¼Œå¦‚æ¨¡å—ä¸­å®šä¹‰çš„å…¨å±€å˜é‡ã€é™æ€å˜é‡ã€‚</strong></li>\n<li><strong>ç±»å‹ 3ï¼šæ¨¡å—å¤–éƒ¨çš„å‡½æ•°è°ƒç”¨ã€‚</strong></li>\n<li><strong>ç±»å‹ 4ï¼šæ¨¡å—å¤–éƒ¨çš„æ•°æ®è®¿é—®ï¼Œå¦‚å…¶ä»–æ¨¡å—ä¸­å®šä¹‰çš„å…¨å±€å˜é‡ã€‚</strong></li>\n</ul>\n<pre><code>static int a;\nextern int b;\nextern void ext();\n\nvoid bar() &#123;\n    a = 1;      // ç±»å‹2ï¼šæ¨¡å—å†…éƒ¨æ•°æ®è®¿é—®\n    b = 2;      // ç±»å‹4ï¼šæ¨¡å—å¤–éƒ¨æ•°æ®è®¿é—®\n&#125;\n\nvoid foo() &#123;\n    bar();      // ç±»å‹1ï¼šæ¨¡å—å†…éƒ¨å‡½æ•°è°ƒç”¨\n    ext();      // ç±»å‹4ï¼šæ¨¡å—å¤–éƒ¨å‡½æ•°è°ƒç”¨\n&#125;\n</code></pre>\n<h5 id=\"ç±»å‹1-æ¨¡å—å†…éƒ¨å‡½æ•°è°ƒç”¨\"><a class=\"anchor\" href=\"#ç±»å‹1-æ¨¡å—å†…éƒ¨å‡½æ•°è°ƒç”¨\">#</a> ç±»å‹ 1 æ¨¡å—å†…éƒ¨å‡½æ•°è°ƒç”¨</h5>\n<p>ç”±äºè¢«è°ƒç”¨çš„å‡½æ•°ä¸è°ƒç”¨è€…éƒ½å¤„äºåŒä¸€æ¨¡å—ï¼Œå®ƒä»¬ä¹‹é—´çš„ç›¸å¯¹ä½ç½®æ˜¯å›ºå®šçš„ã€‚å¯¹äºç°ä»£çš„ç³»ç»Ÿæ¥è¯´ï¼Œæ¨¡å—å†…éƒ¨çš„è°ƒç”¨éƒ½å¯ä»¥æ˜¯ç›¸å¯¹åœ°å€è°ƒç”¨ï¼Œæˆ–è€…æ˜¯åŸºäºå¯„å­˜å™¨çš„ç›¸å¯¹è°ƒç”¨ï¼Œæ‰€ä»¥å¯¹äºè¿™ç§æŒ‡ä»¤æ˜¯ä¸éœ€è¦é‡å®šä½çš„ã€‚</p>\n<h5 id=\"ç±»å‹2-æ¨¡å—å†…éƒ¨æ•°æ®è®¿é—®\"><a class=\"anchor\" href=\"#ç±»å‹2-æ¨¡å—å†…éƒ¨æ•°æ®è®¿é—®\">#</a> ç±»å‹ 2 æ¨¡å—å†…éƒ¨æ•°æ®è®¿é—®</h5>\n<p>ä¸€ä¸ªæ¨¡å—å‰é¢ä¸€èˆ¬æ˜¯è‹¥å¹²ä¸ªé¡µçš„ä»£ç ï¼Œåé¢ç´§è·Ÿç€è‹¥å¹²ä¸ªé¡µçš„æ•°æ®ï¼Œè¿™äº›é¡µä¹‹é—´çš„ç›¸å¯¹ä½ç½®æ˜¯å›ºå®šçš„ï¼Œå³ä»»ä½•ä¸€æ¡æŒ‡ä»¤ä¸å®ƒéœ€è¦è®¿é—®çš„æ¨¡å—å†…éƒ¨æ•°æ®ä¹‹é—´çš„ç›¸å¯¹ä½ç½®æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥åªéœ€è¦ç›¸å¯¹äºå½“å‰æŒ‡ä»¤åŠ ä¸Šå›ºå®šçš„åç§»é‡å°±å¯ä»¥è®¿é—®æ¨¡å—å†…éƒ¨æ•°æ®äº†ã€‚</p>\n<h5 id=\"ç±»å‹3-æ¨¡å—é—´æ•°æ®è®¿é—®\"><a class=\"anchor\" href=\"#ç±»å‹3-æ¨¡å—é—´æ•°æ®è®¿é—®\">#</a> ç±»å‹ 3 æ¨¡å—é—´æ•°æ®è®¿é—®</h5>\n<p>æ¨¡å—é—´çš„æ•°æ®è®¿é—®æ¯”æ¨¡å—å†…éƒ¨ç¨å¾®éº»çƒ¦ä¸€äº›ï¼Œå› ä¸ºæ¨¡å—é—´çš„æ•°æ®è®¿é—®ç›®æ ‡åœ°å€è¦ç­‰åˆ°è£…è½½æ—¶æ‰å†³å®šã€‚æ­¤æ—¶ï¼ŒåŠ¨æ€é“¾æ¥éœ€è¦ä½¿ç”¨ä»£ç æ— å…³åœ°å€æŠ€æœ¯ï¼Œå…¶åŸºæœ¬æ€æƒ³æ˜¯æŠŠåœ°å€ç›¸å…³çš„éƒ¨åˆ†æ”¾åˆ°æ•°æ®æ®µã€‚ELF çš„å®ç°æ–¹æ³•æ˜¯ï¼šåœ¨æ•°æ®æ®µä¸­å»ºç«‹ä¸€ä¸ª<strong>æŒ‡å‘è¿™äº›å˜é‡çš„æŒ‡é’ˆæ•°ç»„</strong>ï¼Œä¹Ÿç§°ä¸º<strong>å…¨å±€åç§»è¡¨ï¼ˆGlobal Offset Tableï¼ŒGOTï¼‰</strong>ï¼Œå½“ä»£ç éœ€è¦å¼•ç”¨è¯¥å…¨å±€å˜é‡æ—¶ï¼Œå¯ä»¥é€šè¿‡ GOT ä¸­ç›¸å¯¹åº”çš„é¡¹é—´æ¥å¼•ç”¨ã€‚è¿‡ç¨‹ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<p><img data-src=\"/ElfReader/inter-module-data-access.png\" alt=\"img\" style=\"aspect-ratio:2148 / 1875;\"></p>\n<p>å½“æŒ‡ä»¤ä¸­éœ€è¦è®¿é—®å˜é‡ b æ—¶ï¼Œç¨‹åºä¼šå…ˆæ‰¾åˆ° GOTï¼Œç„¶åæ ¹æ® GOT ä¸­å˜é‡æ‰€å¯¹åº”çš„é¡¹æ‰¾åˆ°å˜é‡çš„ç›®æ ‡åœ°å€ã€‚æ¯ä¸ªå˜é‡éƒ½å¯¹åº”ä¸€ä¸ª 4 å­—èŠ‚çš„åœ°å€ï¼Œé“¾æ¥å™¨åœ¨è£…è½½æ¨¡å—æ—¶ä¼šæŸ¥æ‰¾æ¯ä¸ªå˜é‡æ‰€åœ¨çš„åœ°å€ï¼Œç„¶åå¡«å…… GOT ä¸­çš„å„ä¸ªé¡¹ï¼Œä»¥ç¡®ä¿æ¯ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€æ­£ç¡®ã€‚ç”±äº GOT æœ¬èº«æ˜¯æ”¾åœ¨æ•°æ®æ®µçš„ï¼Œæ‰€ä»¥å®ƒå¯ä»¥<strong>åœ¨æ¨¡å—è£…è½½æ—¶è¢«ä¿®æ”¹</strong>ï¼Œå¹¶ä¸”æ¯ä¸ªè¿›ç¨‹éƒ½å¯ä»¥æœ‰ç‹¬ç«‹çš„å‰¯æœ¬ï¼Œç›¸äº’ä¸å—å½±å“ã€‚</p>\n<h5 id=\"ç±»å‹4-æ¨¡å—é—´å‡½æ•°è°ƒç”¨\"><a class=\"anchor\" href=\"#ç±»å‹4-æ¨¡å—é—´å‡½æ•°è°ƒç”¨\">#</a> ç±»å‹ 4 æ¨¡å—é—´å‡½æ•°è°ƒç”¨</h5>\n<p>å¯¹äºæ¨¡å—é—´å‡½æ•°è°ƒç”¨ï¼ŒåŒæ ·å¯ä»¥é‡‡ç”¨ç±»å‹ 3 çš„æ–¹æ³•æ¥è§£å†³ã€‚ä¸ä¸Šé¢çš„ç±»å‹æœ‰æ‰€ä¸åŒçš„æ˜¯ï¼ŒGOT ä¸­å“åº”çš„é¡¹ä¿å­˜çš„æ˜¯ç›®æ ‡å‡½æ•°çš„åœ°å€ï¼Œå½“æ¨¡å—éœ€è¦è°ƒç”¨ç›®æ ‡å‡½æ•°æ—¶ï¼Œå¯ä»¥é€šè¿‡ GOT ä¸­çš„é¡¹è¿›è¡Œé—´æ¥è·³è½¬ã€‚</p>\n<h1 id=\"elfçš„è£…è½½è¿‡ç¨‹\"><a class=\"anchor\" href=\"#elfçš„è£…è½½è¿‡ç¨‹\">#</a> ELF çš„è£…è½½è¿‡ç¨‹</h1>\n<blockquote>\n<p>æ­¤å¤„çš„å†…å®¹æ¥æºäº<span class=\"exturl\" data-url=\"aHR0cDovL2NodXF1YW4ubWUvMjAxOC8wNi8xNy9leGVjdXRhYmxlLWZpbGUtbG9hZC1hbmQtZXhlY3V0aW9uLw==\">è®¡ç®—æœºé‚£äº›äº‹ (6)â€”â€” å¯æ‰§è¡Œæ–‡ä»¶çš„è£…è½½ä¸è¿è¡Œ</span>ï¼Œä»…ä½œå­¦ä¹ è®°å½•å’Œå¤‡ä»½ç”¨</p>\n</blockquote>\n<p>å½“æˆ‘ä»¬åœ¨ Linux çš„ bash ä¸­è¾“å…¥å‘½ä»¤æ‰§è¡ŒæŸä¸ª ELF å¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>\n<pre><code>$ ./hello.out\n</code></pre>\n<p>é‚£ä¹ˆï¼ŒLinux ç³»ç»Ÿæ˜¯å¦‚ä½•è£…è½½è¯¥ ELF æ–‡ä»¶å¹¶æ‰§è¡Œçš„å‘¢ï¼Ÿè¿™ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹è¿™äº›æ­¥éª¤ï¼š</p>\n<ul>\n<li>åˆ›å»ºæ–°è¿›ç¨‹</li>\n<li>æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶ç±»å‹</li>\n<li>æœç´¢åŒ¹é…è£…è½½å¤„ç†è¿‡ç¨‹</li>\n<li>è£…è½½æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶</li>\n</ul>\n<h2 id=\"åˆ›å»ºæ–°è¿›ç¨‹\"><a class=\"anchor\" href=\"#åˆ›å»ºæ–°è¿›ç¨‹\">#</a> åˆ›å»ºæ–°è¿›ç¨‹</h2>\n<p>é¦–å…ˆåœ¨ç”¨æˆ·å±‚é¢ï¼Œbash è¿›ç¨‹ä¼šè°ƒç”¨  <code>fork()</code>  ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ã€‚å…¶æ¬¡ï¼Œæ–°çš„è¿›ç¨‹é€šè¿‡è°ƒç”¨  <code>execve()</code>  ç³»ç»Ÿè°ƒç”¨æ¥æ‰§è¡ŒæŒ‡å®šçš„ ELF æ–‡ä»¶ã€‚åŸå…ˆçš„ bash è¿›ç¨‹ç»§ç»­è¿”å›å¹¶ç­‰å¾…åˆšæ‰å¯åŠ¨çš„æ–°è¿›ç¨‹ç»“æŸï¼Œä¹‹åç»§ç»­ç­‰å¾…ç”¨æˆ·è¾“å…¥å‘½ä»¤ã€‚</p>\n<p><code>execve()</code>  ç³»ç»Ÿè°ƒç”¨è¢«å®šä¹‰åœ¨  <code>unistd.h</code> ï¼Œå…¶åŸå‹å¦‚ä¸‹æ‰€ç¤ºã€‚å…¶ä¸­çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«å¯¹åº”è¢«æ‰§è¡Œç¨‹åºçš„ <strong>ç¨‹åºæ–‡ä»¶å</strong>ã€<strong>æ‰§è¡Œå‚æ•°</strong>ã€<strong>ç¯å¢ƒå˜é‡</strong>ã€‚</p>\n<pre><code>int execve(const char *filename, char *const argv[], char *const envp[]);\n</code></pre>\n<h2 id=\"æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶ç±»å‹\"><a class=\"anchor\" href=\"#æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶ç±»å‹\">#</a> æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶ç±»å‹</h2>\n<p>å½“è¿›å…¥  <code>execve()</code>  ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼ŒLinux å†…æ ¸å°±å¼€å§‹è¿›è¡ŒçœŸæ­£çš„è£…è½½å·¥ä½œã€‚åœ¨å†…æ ¸ä¸­ï¼Œ <code>execve()</code>  ç³»ç»Ÿè°ƒç”¨ç›¸åº”çš„å…¥å£æ˜¯  <code>sys_execve()</code> ã€‚ <code>sys_execve()</code>  è¿›è¡Œä¸€äº›å‚æ•°çš„æ£€æŸ¥å¤åˆ¶ä¹‹åï¼Œè°ƒç”¨  <code>do_execve()</code> ã€‚ <code>do_execve()</code>  ä¼šé¦–å…ˆæŸ¥æ‰¾è¢«æ‰§è¡Œçš„æ–‡ä»¶ï¼Œå¦‚æœæ‰¾åˆ°æ–‡ä»¶ï¼Œåˆ™è¯»å–æ–‡ä»¶çš„å‰ 128 ä¸ªå­—èŠ‚ã€‚</p>\n<p>ä¸ºä»€ä¹ˆè¦å…ˆè¯»å–æ–‡ä»¶çš„å‰ 128 ä¸ªå­—èŠ‚ï¼Ÿè¿™æ˜¯å› ä¸º Linux æ”¯æŒçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸æ­¢ ELF ä¸€ç§ï¼Œè¿˜åŒ…æ‹¬ <strong>a.out</strong>ã€<strong>Java ç¨‹åº</strong>ã€<strong>ä»¥  <code>#!</code>  å¼€å¤´çš„è„šæœ¬ç¨‹åº</strong>ã€‚ <code>do_execve()</code>  é€šè¿‡è¯»å–å‰ 128 ä¸ªå­—èŠ‚æ¥åˆ¤æ–­æ–‡ä»¶çš„æ ¼å¼ã€‚æ¯ç§å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼çš„å¼€å¤´å‡ ä¸ªå­—èŠ‚éƒ½æ˜¯å¾ˆç‰¹æ®Šçš„ï¼Œå°¤å…¶æ˜¯å‰ 4 ä¸ªå­—èŠ‚ï¼Œè¢«ç§°ä¸º <strong>é­”æ•°ï¼ˆMagic Numberï¼‰</strong>ã€‚æ¯”å¦‚ï¼šELF çš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼çš„å¤´ 4 ä¸ªå­—èŠ‚ä¸º  <code>0x7F</code> ã€ <code>e</code> ã€ <code>l</code> ã€ <code>f</code> ï¼›Java çš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼çš„å¤´ 4 ä¸ªå­—èŠ‚ä¸º  <code>c</code> ã€ <code>a</code> ã€ <code>f</code> ã€ <code>e</code> ï¼›å¦‚æœæ˜¯è§£é‡Šå‹è¯­è¨€çš„è„šæœ¬ï¼Œåˆ™ç¬¬ä¸€è¡Œé€šå¸¸æ˜¯  <code>#!/bin/sh</code>  æˆ–  <code>#!/user/bin/python</code> ï¼Œå…¶ä¸­  <code>#</code>  å’Œ  <code>!</code>  æ„æˆäº†é­”æ•°ï¼Œç³»ç»Ÿä¸€æ—¦åˆ¤æ–­åˆ°è¿™ä¸¤ä¸ªå­—èŠ‚ï¼Œå°±å¯¹åé¢çš„å­—ç¬¦ä¸²è¿›è¡Œè§£æï¼Œä»¥ç¡®å®šå…·ä½“çš„è§£é‡Šç¨‹åºçš„è·¯å¾„ã€‚</p>\n<h2 id=\"æœç´¢åŒ¹é…è£…è½½å¤„ç†è¿‡ç¨‹\"><a class=\"anchor\" href=\"#æœç´¢åŒ¹é…è£…è½½å¤„ç†è¿‡ç¨‹\">#</a> æœç´¢åŒ¹é…è£…è½½å¤„ç†è¿‡ç¨‹</h2>\n<p>å½“  <code>do_execve()</code>  è¯»å–äº† 128 ä¸ªå­—èŠ‚çš„æ–‡ä»¶å¤´éƒ¨ä¹‹åï¼Œè°ƒç”¨  <code>search_binary_handle()</code>  å»æœç´¢å’ŒåŒ¹é…åˆé€‚çš„å¯æ‰§è¡Œæ–‡ä»¶è£…è½½å¤„ç†è¿‡ç¨‹ã€‚<strong>Linux ä¸­æ‰€æœ‰è¢«æ”¯æŒçš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼éƒ½æœ‰ç›¸åº”çš„è£…è½½å¤„ç†è¿‡ç¨‹</strong>ï¼Œ <code>search_binary_handler()</code>  ä¼šé€šè¿‡åˆ¤æ–­å¤´éƒ¨çš„é­”æœ¯ç¡®å®šæ–‡ä»¶çš„æ ¼å¼ï¼Œå¹¶ä¸”è°ƒç”¨ç›¸åº”çš„è£…è½½å¤„ç†è¿‡ç¨‹ã€‚å¸¸è§çš„å¯æ‰§è¡Œç¨‹åºåŠå…¶è£…è½½å¤„ç†è¿‡ç¨‹çš„å¯¹åº”å…³ç³»å¦‚ä¸‹æ‰€ç¤º.</p>\n<ul>\n<li>ELF å¯æ‰§è¡Œæ–‡ä»¶ï¼š <code>load_elf_binary()</code></li>\n<li>a.out å¯æ‰§è¡Œæ–‡ä»¶ï¼š <code>load_aout_binary()</code></li>\n<li>å¯æ‰§è¡Œè„šæœ¬ç¨‹åºï¼š <code>load_script()</code></li>\n</ul>\n<h2 id=\"è£…è½½æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶\"><a class=\"anchor\" href=\"#è£…è½½æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶\">#</a> è£…è½½æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶</h2>\n<p>ä»¥ ELF çš„è£…è½½å¤„ç†è¿‡ç¨‹  <code>load_elf_binary()</code>  ä¸ºä¾‹ï¼Œå…¶æ‰€åŒ…å«çš„æ­¥éª¤å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>\n<p><img data-src=\"/ElfReader/executable-file-load-process.png\" alt=\"img\" style=\"aspect-ratio:2148 / 2460;\"></p>\n<ol>\n<li>æ“ä½œç³»ç»Ÿè¯»å–å¯æ‰§è¡Œæ–‡ä»¶ ELF çš„  <code>Header</code> ï¼Œæ£€æŸ¥æ–‡ä»¶çš„æœ‰æ•ˆæ€§ã€‚</li>\n<li>æ“ä½œç³»ç»Ÿè¯»å–å¯æ‰§è¡Œæ–‡ä»¶ ELF çš„  <code>Program Header Table</code>  ä¸­è¯»å–æ¯ä¸ª  <code>Segment</code>  çš„è™šæ‹Ÿåœ°å€ã€æ–‡ä»¶åœ°å€ã€å±æ€§ç­‰ã€‚</li>\n<li>æ“ä½œç³»ç»Ÿæ ¹æ®  <code>Program Header Table</code>  å°†å¯æ‰§è¡Œæ–‡ä»¶ ELF æ˜ å°„è‡³å†…å­˜ã€‚</li>\n<li>å¦‚æœæ˜¯é™æ€é“¾æ¥çš„æƒ…å†µï¼Œåˆ™ç›´æ¥è·³è½¬è‡³ç¬¬ 7 æ­¥ï¼›å¦‚æœæ˜¯åŠ¨æ€é“¾æ¥çš„æƒ…å†µï¼Œæ“ä½œç³»ç»Ÿå°†æŸ¥æ‰¾  <code>.interp</code>  èŠ‚ï¼Œæ‰¾åˆ° <strong>åŠ¨æ€é“¾æ¥å™¨ï¼ˆDynamic Linkerï¼‰</strong> çš„ä½ç½®ï¼Œå¹¶å¯åŠ¨åŠ¨æ€é“¾æ¥å™¨ã€‚åœ¨ Linux ä¸‹ï¼ŒåŠ¨æ€é“¾æ¥å™¨  <code>ld.so</code>  æ˜¯ä¸€ä¸ªå…±äº«å¯¹è±¡ï¼Œæ“ä½œç³»ç»ŸåŒæ ·é€šè¿‡æ˜ å°„çš„æ–¹å¼å°†å®ƒåŠ è½½åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚æ“ä½œç³»ç»Ÿåœ¨åŠ è½½å®Œåï¼Œå°†æ§åˆ¶æƒäº¤ç»™åŠ¨æ€é“¾æ¥å™¨çš„å…¥å£ã€‚</li>\n<li>åŠ¨æ€é“¾æ¥å™¨è·å¾—æ§åˆ¶æƒåï¼Œå¼€å§‹æ‰§è¡Œä¸€ç³»åˆ—åˆå§‹åŒ–æ“ä½œã€‚</li>\n<li>åŠ¨æ€é“¾æ¥å™¨æ ¹æ®å½“å‰çš„ç¯å¢ƒå‚æ•°ï¼Œå¯¹å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡ŒåŠ¨æ€é“¾æ¥å·¥ä½œã€‚</li>\n<li>æ§åˆ¶æƒè¢«è½¬äº¤åˆ°å¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£åœ°å€ï¼Œç¨‹åºå¼€å§‹æ­£å¼æ‰§è¡Œã€‚</li>\n</ol>\n<h2 id=\"technical-note-on-elf-loading\"><a class=\"anchor\" href=\"#technical-note-on-elf-loading\">#</a> TECHNICAL NOTE ON ELF LOADING</h2>\n<p>åœ¨ <code>android-platform\\bionic\\linker\\linker_phdr.cpp</code>  ä¸­å¼€å¤´çš„è¿™å¤„æ³¨é‡Šä¹Ÿå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿç†è§£ ELF çš„åŠ è½½è¿‡ç¨‹</p>\n<p>TECHNICAL NOTE ON ELF LOADING.</p>\n<p>An ELF fileâ€™s program header table contains one or more PT_LOAD<br>\nsegments, which corresponds to portions of the file that need to<br>\nbe mapped into the processâ€™ address space.</p>\n<p>Each loadable segment has the following important properties:</p>\n<pre><code>p_offset  -&gt; segment file offset\np_filesz  -&gt; segment file size\np_memsz   -&gt; segment memory size (always &gt;= p_filesz)\np_vaddr   -&gt; segment's virtual address\np_flags   -&gt; segment flags (e.g. readable, writable, executable)\np_align   -&gt; segment's in-memory and in-file alignment\n</code></pre>\n<p>We will ignore the p_paddr field of ElfW(Phdr) for now.</p>\n<p>The loadable segments can be seen as a list of [p_vaddr â€¦ p_vaddr+p_memsz)<br>\nranges of virtual addresses. A few rules apply:</p>\n<ul>\n<li>\n<p>the virtual address ranges should not overlap.</p>\n</li>\n<li>\n<p>if a segmentâ€™s p_filesz is smaller than its p_memsz, the extra bytes<br>\nbetween them should always be initialized to 0.</p>\n</li>\n<li>\n<p>ranges do not necessarily start or end at page boundaries. Two distinct<br>\nsegments can have their start and end on the same page. In this case, the<br>\npage inherits the mapping flags of the latter segment.</p>\n</li>\n</ul>\n<p>Finally, the real load addrs of each segment is not p_vaddr. Instead the<br>\nloader decides where to load the first segment, then will load all others<br>\nrelative to the first one to respect the initial range layout.</p>\n<p>For example, consider the following list:</p>\n<pre><code>[ offset:0,      filesz:0x4000, memsz:0x4000, vaddr:0x30000 ],\n[ offset:0x4000, filesz:0x2000, memsz:0x8000, vaddr:0x40000 ],\n</code></pre>\n<p>This corresponds to two segments that cover these virtual address ranges:</p>\n<pre><code>   0x30000...0x34000\n   0x40000...0x48000\n</code></pre>\n<p>If the loader decides to load the first segment at address 0xa0000000<br>\nthen the segmentsâ€™ load address ranges will be:</p>\n<pre><code>   0xa0030000...0xa0034000\n   0xa0040000...0xa0048000\n</code></pre>\n<p>In other words, all segments must be loaded at an address that has the same<br>\nconstant offset from their p_vaddr value. This offset is computed as the<br>\ndifference between the first segmentâ€™s load address, and its p_vaddr value.</p>\n<p>However, in practice, segments do <em>not</em> start at page boundaries. Since we<br>\ncan only memory-map at page boundaries, this means that the bias is<br>\ncomputed as:</p>\n<pre><code>   load_bias = phdr0_load_address - PAGE_START(phdr0-&gt;p_vaddr)\n</code></pre>\n<p>(NOTE: The value must be used as a 32-bit unsigned integer, to deal with<br>\npossible wrap around UINT32_MAX for possible large p_vaddr values).</p>\n<p>And that the phdr0_load_address must start at a page boundary, with<br>\nthe segmentâ€™s real content starting at:</p>\n<pre><code>   phdr0_load_address + PAGE_OFFSET(phdr0-&gt;p_vaddr)\n</code></pre>\n<p>Note that ELF requires the following condition to make the mmap()-ing work:</p>\n<pre><code>  PAGE_OFFSET(phdr0-&gt;p_vaddr) == PAGE_OFFSET(phdr0-&gt;p_offset)\n</code></pre>\n<p>The load_bias must be added to any p_vaddr value read from the ELF file to<br>\ndetermine the corresponding memory address.</p>\n<h1 id=\"elfreaderç±»\"><a class=\"anchor\" href=\"#elfreaderç±»\">#</a> ElfReader ç±»</h1>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_phdr.h</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>class ElfReader <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> public<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">ElfReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  bool <span class=\"token function\">Read</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">,</span> <span class=\"token class-name\">off64_t</span> file_offset<span class=\"token punctuation\">,</span> <span class=\"token class-name\">off64_t</span> file_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  bool <span class=\"token function\">Load</span><span class=\"token punctuation\">(</span>address_space_params<span class=\"token operator\">*</span> address_space<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> <span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token class-name\">size_t</span> <span class=\"token function\">phdr_count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> phdr_num_<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> <span class=\"token function\">load_start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_start_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token class-name\">size_t</span> <span class=\"token function\">load_size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> load_size_<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> <span class=\"token function\">gap_start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>gap_start_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token class-name\">size_t</span> <span class=\"token function\">gap_size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> gap_size_<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> <span class=\"token function\">load_bias</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> load_bias_<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Phdr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> <span class=\"token function\">loaded_phdr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> loaded_phdr_<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Dyn<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> <span class=\"token function\">dynamic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> dynamic_<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> <span class=\"token function\">get_string</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Word<span class=\"token punctuation\">)</span> index<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  bool <span class=\"token function\">is_mapped_by_caller</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> mapped_by_caller_<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> <span class=\"token function\">entry_point</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> header_<span class=\"token punctuation\">.</span>e_entry <span class=\"token operator\">+</span> load_bias_<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre> private<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  bool <span class=\"token function\">ReadElfHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  bool <span class=\"token function\">VerifyElfHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  bool <span class=\"token function\">ReadProgramHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  bool <span class=\"token function\">ReadSectionHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  bool <span class=\"token function\">ReadDynamicSection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  bool <span class=\"token function\">ReserveAddressSpace</span><span class=\"token punctuation\">(</span>address_space_params<span class=\"token operator\">*</span> address_space<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  bool <span class=\"token function\">LoadSegments</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  bool <span class=\"token function\">FindPhdr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  bool <span class=\"token function\">FindGnuPropertySection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  bool <span class=\"token function\">CheckPhdr</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  bool <span class=\"token function\">CheckFileRange</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> offset<span class=\"token punctuation\">,</span> <span class=\"token class-name\">size_t</span> size<span class=\"token punctuation\">,</span> <span class=\"token class-name\">size_t</span> alignment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  bool did_read_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  bool did_load_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  std<span class=\"token operator\">::</span>string name_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token keyword\">int</span> fd_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token class-name\">off64_t</span> file_offset_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token class-name\">off64_t</span> file_size_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Ehdr<span class=\"token punctuation\">)</span> header_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token class-name\">size_t</span> phdr_num_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  MappedFileFragment phdr_fragment_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Phdr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> phdr_table_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  MappedFileFragment shdr_fragment_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Shdr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> shdr_table_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token class-name\">size_t</span> shdr_num_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  MappedFileFragment dynamic_fragment_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Dyn<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> dynamic_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  MappedFileFragment strtab_fragment_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> strtab_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token class-name\">size_t</span> strtab_size_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token comment\">// First page of reserved address space.</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> load_start_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token comment\">// Size in bytes of reserved address space.</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token class-name\">size_t</span> load_size_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token comment\">// First page of inaccessible gap mapping reserved for this DSO.</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> gap_start_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  <span class=\"token comment\">// Size in bytes of the gap mapping.</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token class-name\">size_t</span> gap_size_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token comment\">// Load bias.</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> load_bias_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  <span class=\"token comment\">// Loaded phdr.</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Phdr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> loaded_phdr_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token comment\">// Is map owned by the caller</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  bool mapped_by_caller_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token comment\">// Only used by AArch64 at the moment.</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  GnuPropertySection note_gnu_property_ __unused<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"aospä¸­è§£æelfç¤ºä¾‹\"><a class=\"anchor\" href=\"#aospä¸­è§£æelfç¤ºä¾‹\">#</a> AOSP ä¸­è§£æ Elf ç¤ºä¾‹</h2>\n<p>åœ¨ AOSP ä¸­ï¼Œè°ƒç”¨ <code>ElfReader</code>  è§£æ so çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œä¼ å…¥çš„å››ä¸ªå‚æ•°çš„å«ä¹‰å¦‚ä¸‹æ‰€ç¤º</p>\n<ul>\n<li><code>realpath</code> :  <code>elf</code>  çš„è·¯å¾„</li>\n<li><code>fd_</code> : æ‰“å¼€çš„ <code>elf</code>  çš„ <code>fd</code>  æ–‡ä»¶æè¿°ç¬¦</li>\n<li><code>file_offset_</code> :  <code>elf</code>  æ–‡ä»¶æŒ‡é’ˆçš„å½“å‰åç§»ï¼Œåˆå§‹å€¼ä¸º 0</li>\n<li><code>file_size</code> :  <code>elf</code>  çš„æ–‡ä»¶å¤§å°</li>\n</ul>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//LoadTask::read</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>bool <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> realpath<span class=\"token punctuation\">,</span> <span class=\"token class-name\">off64_t</span> file_size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    ElfReader<span class=\"token operator\">&amp;</span> elf_reader <span class=\"token operator\">=</span> <span class=\"token function\">get_elf_reader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">return</span> elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">Read</span><span class=\"token punctuation\">(</span>realpath<span class=\"token punctuation\">,</span> fd_<span class=\"token punctuation\">,</span> file_offset_<span class=\"token punctuation\">,</span> file_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"elfreaderread\"><a class=\"anchor\" href=\"#elfreaderread\">#</a> ElfReader::Read</h2>\n<p>éå¸¸å…¸å‹çš„ <code>elfè§£æäº”ä»¶å¥—</code> ä»£ç ï¼Œç»è¿‡ä¸Šé¢å¯¹äº ELF çš„è¯¦ç»†åˆ†æï¼Œæˆ‘ä»¬ä¹Ÿä¸éš¾ç†è§£è¿™äº”ä¸ªå‡½æ•°çš„åŠŸèƒ½äº†</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_phdr.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bool ElfReader<span class=\"token operator\">::</span><span class=\"token function\">Read</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">,</span> <span class=\"token class-name\">off64_t</span> file_offset<span class=\"token punctuation\">,</span> <span class=\"token class-name\">off64_t</span> file_size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>did_read_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name_ <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  fd_ <span class=\"token operator\">=</span> fd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  file_offset_ <span class=\"token operator\">=</span> file_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  file_size_ <span class=\"token operator\">=</span> file_size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">ReadElfHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token function\">VerifyElfHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token function\">ReadProgramHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token function\">ReadSectionHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token function\">ReadDynamicSection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    did_read_ <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">return</span> did_read_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"readelfheader\"><a class=\"anchor\" href=\"#readelfheader\">#</a> ReadElfHeader</h3>\n<p>è¯»å– ELF Header</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_phdr.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bool ElfReader<span class=\"token operator\">::</span><span class=\"token function\">ReadElfHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">ssize_t</span> rc <span class=\"token operator\">=</span> <span class=\"token function\">TEMP_FAILURE_RETRY</span><span class=\"token punctuation\">(</span><span class=\"token function\">pread64</span><span class=\"token punctuation\">(</span>fd_<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>header_<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>header_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> file_offset_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rc <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"can't read file \\\"%s\\\": %s\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strerror</span><span class=\"token punctuation\">(</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rc <span class=\"token operator\">!=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>header_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" is too small to be an ELF executable: only found %zd bytes\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>               static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>rc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"verifyelfheader\"><a class=\"anchor\" href=\"#verifyelfheader\">#</a> VerifyElfHeader</h3>\n<p>åˆ¤æ–­æ˜¯å¦æ˜¯ ELF Header çš„åˆæ³•æ€§</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_phdr.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bool ElfReader<span class=\"token operator\">::</span><span class=\"token function\">VerifyElfHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">memcmp</span><span class=\"token punctuation\">(</span>header_<span class=\"token punctuation\">.</span>e_ident<span class=\"token punctuation\">,</span> ELFMAG<span class=\"token punctuation\">,</span> SELFMAG<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has bad ELF magic: %02x%02x%02x%02x\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>           header_<span class=\"token punctuation\">.</span>e_ident<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> header_<span class=\"token punctuation\">.</span>e_ident<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> header_<span class=\"token punctuation\">.</span>e_ident<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> header_<span class=\"token punctuation\">.</span>e_ident<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// Try to give a clear diagnostic for ELF class mismatches, since they're</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// an easy mistake to make during the 32-bit/64-bit transition period.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">int</span> elf_class <span class=\"token operator\">=</span> header_<span class=\"token punctuation\">.</span>e_ident<span class=\"token punctuation\">[</span>EI_CLASS<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__LP64__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>elf_class <span class=\"token operator\">!=</span> ELFCLASS64<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>elf_class <span class=\"token operator\">==</span> ELFCLASS32<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" is 32-bit instead of 64-bit\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has unknown ELF class: %d\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> elf_class<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>elf_class <span class=\"token operator\">!=</span> ELFCLASS32<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>elf_class <span class=\"token operator\">==</span> ELFCLASS64<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" is 64-bit instead of 32-bit\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has unknown ELF class: %d\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> elf_class<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>header_<span class=\"token punctuation\">.</span>e_ident<span class=\"token punctuation\">[</span>EI_DATA<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> ELFDATA2LSB<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" not little-endian: %d\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> header_<span class=\"token punctuation\">.</span>e_ident<span class=\"token punctuation\">[</span>EI_DATA<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>header_<span class=\"token punctuation\">.</span>e_type <span class=\"token operator\">!=</span> ET_DYN<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has unexpected e_type: %d\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> header_<span class=\"token punctuation\">.</span>e_type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>header_<span class=\"token punctuation\">.</span>e_version <span class=\"token operator\">!=</span> EV_CURRENT<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has unexpected e_version: %d\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> header_<span class=\"token punctuation\">.</span>e_version<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>header_<span class=\"token punctuation\">.</span>e_machine <span class=\"token operator\">!=</span> <span class=\"token function\">GetTargetElfMachine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" is for %s (%d) instead of %s (%d)\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>           name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>           <span class=\"token function\">EM_to_string</span><span class=\"token punctuation\">(</span>header_<span class=\"token punctuation\">.</span>e_machine<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> header_<span class=\"token punctuation\">.</span>e_machine<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>           <span class=\"token function\">EM_to_string</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetTargetElfMachine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">GetTargetElfMachine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>header_<span class=\"token punctuation\">.</span>e_shentsize <span class=\"token operator\">!=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Shdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token comment\">// Fail if app is targeting Android O or above</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">get_application_target_sdk_version</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">26</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token function\">DL_ERR_AND_LOG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has unsupported e_shentsize: 0x%x (expected 0x%zx)\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                     name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> header_<span class=\"token punctuation\">.</span>e_shentsize<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Shdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    <span class=\"token function\">DL_WARN_documented_change</span><span class=\"token punctuation\">(</span><span class=\"token number\">26</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                              <span class=\"token string\">\"invalid-elf-header_section-headers-enforced-for-api-level-26\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                              <span class=\"token string\">\"\\\"%s\\\" has unsupported e_shentsize 0x%x (expected 0x%zx)\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                              name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> header_<span class=\"token punctuation\">.</span>e_shentsize<span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Shdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token function\">add_dlwarning</span><span class=\"token punctuation\">(</span>name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"has invalid ELF header\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>header_<span class=\"token punctuation\">.</span>e_shstrndx <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token comment\">// Fail if app is targeting Android O or above</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">get_application_target_sdk_version</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">26</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      <span class=\"token function\">DL_ERR_AND_LOG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has invalid e_shstrndx\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token function\">DL_WARN_documented_change</span><span class=\"token punctuation\">(</span><span class=\"token number\">26</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                              <span class=\"token string\">\"invalid-elf-header_section-headers-enforced-for-api-level-26\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                              <span class=\"token string\">\"\\\"%s\\\" has invalid e_shstrndx\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token function\">add_dlwarning</span><span class=\"token punctuation\">(</span>name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"has invalid ELF header\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"readprogramheaders\"><a class=\"anchor\" href=\"#readprogramheaders\">#</a> ReadProgramHeaders</h3>\n<p>è¯»å– Program Header</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_phdr.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// Loads the program header table from an ELF file into a read-only private</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// anonymous mmap-ed block.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>bool ElfReader<span class=\"token operator\">::</span><span class=\"token function\">ReadProgramHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  phdr_num_ <span class=\"token operator\">=</span> header_<span class=\"token punctuation\">.</span>e_phnum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// Like the kernel, we only accept program header tables that</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// are smaller than 64KiB.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>phdr_num_ <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span> <span class=\"token operator\">||</span> phdr_num_ <span class=\"token operator\">></span> <span class=\"token number\">65536</span><span class=\"token operator\">/</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Phdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has invalid e_phnum: %zd\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> phdr_num_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// Boundary checks</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token class-name\">size_t</span> size <span class=\"token operator\">=</span> phdr_num_ <span class=\"token operator\">*</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Phdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">CheckFileRange</span><span class=\"token punctuation\">(</span>header_<span class=\"token punctuation\">.</span>e_phoff<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> <span class=\"token function\">alignof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Phdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token function\">DL_ERR_AND_LOG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has invalid phdr offset/size: %zu/%zu\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                   name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                   static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>header_<span class=\"token punctuation\">.</span>e_phoff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                   size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>phdr_fragment_<span class=\"token punctuation\">.</span><span class=\"token function\">Map</span><span class=\"token punctuation\">(</span>fd_<span class=\"token punctuation\">,</span> file_offset_<span class=\"token punctuation\">,</span> header_<span class=\"token punctuation\">.</span>e_phoff<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" phdr mmap failed: %s\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strerror</span><span class=\"token punctuation\">(</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  phdr_table_ <span class=\"token operator\">=</span> static_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Phdr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>phdr_fragment_<span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"readsectionheaders\"><a class=\"anchor\" href=\"#readsectionheaders\">#</a> ReadSectionHeaders</h3>\n<p>è¯»å– Section Header</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_phdr.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bool ElfReader<span class=\"token operator\">::</span><span class=\"token function\">ReadSectionHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  shdr_num_ <span class=\"token operator\">=</span> header_<span class=\"token punctuation\">.</span>e_shnum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shdr_num_ <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">DL_ERR_AND_LOG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has no section headers\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token class-name\">size_t</span> size <span class=\"token operator\">=</span> shdr_num_ <span class=\"token operator\">*</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Shdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">CheckFileRange</span><span class=\"token punctuation\">(</span>header_<span class=\"token punctuation\">.</span>e_shoff<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> <span class=\"token function\">alignof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Shdr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token function\">DL_ERR_AND_LOG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has invalid shdr offset/size: %zu/%zu\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                   name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                   static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>header_<span class=\"token punctuation\">.</span>e_shoff<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                   size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>shdr_fragment_<span class=\"token punctuation\">.</span><span class=\"token function\">Map</span><span class=\"token punctuation\">(</span>fd_<span class=\"token punctuation\">,</span> file_offset_<span class=\"token punctuation\">,</span> header_<span class=\"token punctuation\">.</span>e_shoff<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" shdr mmap failed: %s\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strerror</span><span class=\"token punctuation\">(</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  shdr_table_ <span class=\"token operator\">=</span> static_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Shdr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>shdr_fragment_<span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"readdynamicsection\"><a class=\"anchor\" href=\"#readdynamicsection\">#</a> ReadDynamicSection</h3>\n<p>è¯»å– Dynamic Section</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_phdr.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bool ElfReader<span class=\"token operator\">::</span><span class=\"token function\">ReadDynamicSection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// 1. Find .dynamic section (in section headers)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Shdr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> dynamic_shdr <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> shdr_num_<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shdr_table_<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>sh_type <span class=\"token operator\">==</span> SHT_DYNAMIC<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      dynamic_shdr <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>shdr_table_ <span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dynamic_shdr <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token function\">DL_ERR_AND_LOG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" .dynamic section header was not found\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">// Make sure dynamic_shdr offset and size matches PT_DYNAMIC phdr</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token class-name\">size_t</span> pt_dynamic_offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token class-name\">size_t</span> pt_dynamic_filesz <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> phdr_num_<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Phdr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> phdr <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>phdr_table_<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>phdr<span class=\"token operator\">-></span>p_type <span class=\"token operator\">==</span> PT_DYNAMIC<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      pt_dynamic_offset <span class=\"token operator\">=</span> phdr<span class=\"token operator\">-></span>p_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      pt_dynamic_filesz <span class=\"token operator\">=</span> phdr<span class=\"token operator\">-></span>p_filesz<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pt_dynamic_offset <span class=\"token operator\">!=</span> dynamic_shdr<span class=\"token operator\">-></span>sh_offset<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">get_application_target_sdk_version</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">26</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token function\">DL_ERR_AND_LOG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" .dynamic section has invalid offset: 0x%zx, \"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                     <span class=\"token string\">\"expected to match PT_DYNAMIC offset: 0x%zx\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                     name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                     static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>dynamic_shdr<span class=\"token operator\">-></span>sh_offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                     pt_dynamic_offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token function\">DL_WARN_documented_change</span><span class=\"token punctuation\">(</span><span class=\"token number\">26</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                              <span class=\"token string\">\"invalid-elf-header_section-headers-enforced-for-api-level-26\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                              <span class=\"token string\">\"\\\"%s\\\" .dynamic section has invalid offset: 0x%zx \"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                              <span class=\"token string\">\"(expected to match PT_DYNAMIC offset 0x%zx)\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                              name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                              static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>dynamic_shdr<span class=\"token operator\">-></span>sh_offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                              pt_dynamic_offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token function\">add_dlwarning</span><span class=\"token punctuation\">(</span>name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"invalid .dynamic section\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pt_dynamic_filesz <span class=\"token operator\">!=</span> dynamic_shdr<span class=\"token operator\">-></span>sh_size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">get_application_target_sdk_version</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">26</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      <span class=\"token function\">DL_ERR_AND_LOG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" .dynamic section has invalid size: 0x%zx, \"</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                     <span class=\"token string\">\"expected to match PT_DYNAMIC filesz: 0x%zx\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                     name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                     static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>dynamic_shdr<span class=\"token operator\">-></span>sh_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                     pt_dynamic_filesz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token function\">DL_WARN_documented_change</span><span class=\"token punctuation\">(</span><span class=\"token number\">26</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                              <span class=\"token string\">\"invalid-elf-header_section-headers-enforced-for-api-level-26\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>                              <span class=\"token string\">\"\\\"%s\\\" .dynamic section has invalid size: 0x%zx \"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                              <span class=\"token string\">\"(expected to match PT_DYNAMIC filesz 0x%zx)\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                              name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                              static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>dynamic_shdr<span class=\"token operator\">-></span>sh_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                              pt_dynamic_filesz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token function\">add_dlwarning</span><span class=\"token punctuation\">(</span>name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"invalid .dynamic section\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dynamic_shdr<span class=\"token operator\">-></span>sh_link <span class=\"token operator\">>=</span> shdr_num_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token function\">DL_ERR_AND_LOG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" .dynamic section has invalid sh_link: %d\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                   name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                   dynamic_shdr<span class=\"token operator\">-></span>sh_link<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Shdr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> strtab_shdr <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>shdr_table_<span class=\"token punctuation\">[</span>dynamic_shdr<span class=\"token operator\">-></span>sh_link<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>strtab_shdr<span class=\"token operator\">-></span>sh_type <span class=\"token operator\">!=</span> SHT_STRTAB<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token function\">DL_ERR_AND_LOG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" .dynamic section has invalid link(%d) sh_type: %d (expected SHT_STRTAB)\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                   name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dynamic_shdr<span class=\"token operator\">-></span>sh_link<span class=\"token punctuation\">,</span> strtab_shdr<span class=\"token operator\">-></span>sh_type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">CheckFileRange</span><span class=\"token punctuation\">(</span>dynamic_shdr<span class=\"token operator\">-></span>sh_offset<span class=\"token punctuation\">,</span> dynamic_shdr<span class=\"token operator\">-></span>sh_size<span class=\"token punctuation\">,</span> <span class=\"token function\">alignof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Dyn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token function\">DL_ERR_AND_LOG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has invalid offset/size of .dynamic section\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>dynamic_fragment_<span class=\"token punctuation\">.</span><span class=\"token function\">Map</span><span class=\"token punctuation\">(</span>fd_<span class=\"token punctuation\">,</span> file_offset_<span class=\"token punctuation\">,</span> dynamic_shdr<span class=\"token operator\">-></span>sh_offset<span class=\"token punctuation\">,</span> dynamic_shdr<span class=\"token operator\">-></span>sh_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" dynamic section mmap failed: %s\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strerror</span><span class=\"token punctuation\">(</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  dynamic_ <span class=\"token operator\">=</span> static_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Dyn<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>dynamic_fragment_<span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">CheckFileRange</span><span class=\"token punctuation\">(</span>strtab_shdr<span class=\"token operator\">-></span>sh_offset<span class=\"token punctuation\">,</span> strtab_shdr<span class=\"token operator\">-></span>sh_size<span class=\"token punctuation\">,</span> <span class=\"token function\">alignof</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    <span class=\"token function\">DL_ERR_AND_LOG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has invalid offset/size of the .strtab section linked from .dynamic section\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                   name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>strtab_fragment_<span class=\"token punctuation\">.</span><span class=\"token function\">Map</span><span class=\"token punctuation\">(</span>fd_<span class=\"token punctuation\">,</span> file_offset_<span class=\"token punctuation\">,</span> strtab_shdr<span class=\"token operator\">-></span>sh_offset<span class=\"token punctuation\">,</span> strtab_shdr<span class=\"token operator\">-></span>sh_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" strtab section mmap failed: %s\"</span><span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strerror</span><span class=\"token punctuation\">(</span>errno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>  strtab_ <span class=\"token operator\">=</span> static_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>strtab_fragment_<span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  strtab_size_ <span class=\"token operator\">=</span> strtab_fragment_<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"å‚è€ƒèµ„æ–™\"><a class=\"anchor\" href=\"#å‚è€ƒèµ„æ–™\">#</a> å‚è€ƒèµ„æ–™</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ldmlscGFuLmNvbS8yMDIwLzA4LzA5L2VsZi1pbnNpZGUtb3V0Lw==\">æ·±å…¥æµ…å‡º ELF</span></li>\n<li>https://ctf-wiki.org/executable/elf</li>\n<li><span class=\"exturl\" data-url=\"aHR0cDovL2NodXF1YW4ubWUvMjAxOC8wNS8yMS9lbGYtaW50cm9kdWNl\">è®¡ç®—æœºé‚£äº›äº‹ (4)â€”â€”ELF æ–‡ä»¶ç»“æ„</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cDovL2NodXF1YW4ubWUvMjAxOC8wNi8wMy9saW5raW5nLXN0YXRpYy1saW5raW5nLWR5bmFtaWMtbGlua2luZy8=\">è®¡ç®—æœºé‚£äº›äº‹ (5)â€”â€” é“¾æ¥ã€é™æ€é“¾æ¥ã€åŠ¨æ€é“¾æ¥</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cDovL2NodXF1YW4ubWUvMjAxOC8wNi8xNy9leGVjdXRhYmxlLWZpbGUtbG9hZC1hbmQtZXhlY3V0aW9uLw==\">è®¡ç®—æœºé‚£äº›äº‹ (6)â€”â€” å¯æ‰§è¡Œæ–‡ä»¶çš„è£…è½½ä¸è¿è¡Œ</span></li>\n</ul>\n",
            "tags": []
        },
        {
            "id": "https://oacia.dev/android-load-so/",
            "url": "https://oacia.dev/android-load-so/",
            "title": "å®‰å“soåŠ è½½æµç¨‹æºç åˆ†æ",
            "date_published": "2024-02-14T03:19:19.000Z",
            "content_html": "<blockquote>\n<p>å¯¹äºæŸäº›åŠ å›ºå£³ï¼ŒåŠ è½½è§£é‡Šå™¨ elf çš„æ–¹å¼ä¸ä¼šæ˜¯å¸¸è§„çš„ <code>System.loadLibrary</code> , è€Œæ˜¯ä»¿ç…§ <code>System.loadLibrary</code>  åœ¨ AOSP ä¸­çš„å®ç°æ–¹å¼ï¼Œåœ¨ JNI ä¸­è‡ªå·±å®ç° so çš„åŠ è½½</p>\n</blockquote>\n<p>æœ¬æ¬¡æ‰€ä½¿ç”¨åˆ°çš„ AOSP çš„æºç çš„å®‰å“ç‰ˆæœ¬ä¸º <code>android-12.0.0_r34</code></p>\n<h1 id=\"soçš„å¯åŠ¨è¿‡ç¨‹\"><a class=\"anchor\" href=\"#soçš„å¯åŠ¨è¿‡ç¨‹\">#</a> so çš„å¯åŠ¨è¿‡ç¨‹</h1>\n<h2 id=\"systemload\"><a class=\"anchor\" href=\"#systemload\">#</a> System.load</h2>\n<p>åœ¨ Android ä¸­æˆ‘ä»¬æƒ³è¦åŠ è½½ä¸€ä¸ª so æ—¶ï¼Œå¯ä»¥æœ‰ä¸¤ç§æ–¹å¼</p>\n<ul>\n<li>\n<p>é™æ€åŠ è½½</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"native\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>è¿™ç§åŠ è½½æ–¹å¼ä¸‹ï¼Œè¦åŠ è½½çš„ so ä¸€èˆ¬å·²ç»å†…ç½®åœ¨ apk çš„ <code>lib/[arch]/</code>  ä¸­</p>\n</li>\n<li>\n<p>åŠ¨æ€åŠ è½½</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token class-name\">String</span> soPath <span class=\"token operator\">=</span> <span class=\"token string\">\"/data/data/com.example.myapp/libmynative.so\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>soPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>è¿™ä¸€ç§åŠ è½½æ–¹å¼å¯ä»¥åŠ è½½ä»»æ„è·¯å¾„ä¸‹çš„ so</p>\n</li>\n</ul>\n<p>è¿™é‡Œæˆ‘ä»¬å°†åŠ¨æ€åŠ è½½ï¼Œå³ <code>System.load</code>  å‡½æ•°ä½œä¸ºåˆ†æçš„å…¥å£ï¼Œå¯ä»¥å‘ç°å®ƒå®é™…ä¸Šè°ƒç”¨çš„æ˜¯ <code>Runtime.getRuntime().load0</code></p>\n<blockquote>\n<p>å¯¹äºé™æ€åŠ è½½ <code>System.loadLibrary</code>  æ¥è¯´ï¼Œå®ƒè°ƒç”¨çš„å‡½æ•°æ˜¯ <code>Runtime.getRuntime().loadLibrary0(Reflection.getCallerClass(), libname);</code></p>\n</blockquote>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\libcore\\ojluni\\src\\main\\java\\java\\lang\\System.java</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">/**</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     * Loads the native library specified by the filename argument.  The filename</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     * argument must be an absolute path name.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     * If the filename argument, when stripped of any platform-specific library</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     * prefix, path, and file extension, indicates a library whose name is,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     * for example, L, and a native library called L is statically linked</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     * with the VM, then the JNI_OnLoad_L function exported by the library</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     * is invoked rather than attempting to load a dynamic library.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     * A filename matching the argument does not have to exist in the</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     * file system.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     * See the JNI Specification for more details.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>     * Otherwise, the filename argument is mapped to a native library image in</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>     * an implementation-dependent manner.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     * &lt;p></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     * The call &lt;code>System.load(name)&lt;/code> is effectively equivalent</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>     * to the call:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>     * &lt;blockquote>&lt;pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>     * Runtime.getRuntime().load(name)</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>     * &lt;/pre>&lt;/blockquote></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>     *</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>     * @param      filename   the file to load.</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>     * @exception  SecurityException  if a security manager exists and its</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>     *             &lt;code>checkLink&lt;/code> method doesn't allow</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     *             loading of the specified dynamic library</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>     * @exception  UnsatisfiedLinkError  if either the filename is not an</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>     *             absolute path name, the native library is not statically</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>     *             linked with the VM, or the library cannot be mapped to</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>     *             a native library image by the host system.</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>     * @exception  NullPointerException if &lt;code>filename&lt;/code> is</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>     *             &lt;code>null&lt;/code></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>     * @see        java.lang.Runtime#load(java.lang.String)</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>     * @see        java.lang.SecurityManager#checkLink(java.lang.String)</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>     */</pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token annotation punctuation\">@CallerSensitive</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> filename<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token class-name\">Runtime</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRuntime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">load0</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Reflection</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCallerClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> filename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>Reflection.getCallerClass</strong></p>\n<p>ç¬¬ä¸€ä¸ªä¼ å…¥çš„å‚æ•° <code>Reflection.getCallerClass()</code>  ç›¸å…³çš„å®ç°å³æ³¨é‡Šå¦‚ä¸‹ï¼Œè¯»èµ·æ¥å¯èƒ½ä¼šæœ‰ç‚¹ç»•ï¼Œä»€ä¹ˆå«è¿”å›æ–¹æ³•çš„æ–¹æ³•çš„è°ƒç”¨è€…çš„ç±»ï¼Ÿ</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\libcore\\ojluni\\src\\main\\java\\sun\\reflect\\Reflection.java</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/** Returns the class of the caller of the method calling this method,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        ignoring frames associated with java.lang.reflect.Method.invoke()</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        and its implementation. *</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    @CallerSensitive</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    public static native Class&lt;?> getCallerClass();</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    */</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getCallerClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token comment\">// This method (getCallerClass()) constitutes another stack frame,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token comment\">// so we need to call getStackClass2() rather than getStackClass1().</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">VMStack</span><span class=\"token punctuation\">.</span><span class=\"token function\">getStackClass2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å…¶å®æŒ‰ç…§é€†å‘çš„è§’åº¦æ¥çœ‹ï¼Œå°±æ˜¯è¿”å›è°ƒç”¨æ ˆçš„æœ€åº•å±‚çš„é‚£ä¸ªç±»ï¼Œä¾‹å¦‚æœ‰ä¸€ä¸ª <code>Class A</code>  ç»è¿‡å¦‚ä¸‹çš„è°ƒç”¨è¿‡ç¨‹: <code>Class A-&gt;åå°„1-&gt;åå°„2-&gt;åå°„n-&gt;...-&gt;Reflection.getCallerClass()</code> , æœ€ç»ˆ <code>getCallerClass</code>  æ–¹æ³•å°†è¿”å› <code>Class A</code></p>\n<h2 id=\"runtimegetruntimeload0\"><a class=\"anchor\" href=\"#runtimegetruntimeload0\">#</a> Runtime.getRuntime().load0</h2>\n<p>åœ¨ <code>Runtime.getRuntime().load0</code>  ä¸­è¿›è¡Œäº† <code>filename</code>  æ˜¯å¦æ˜¯ <code>ç»å¯¹è·¯å¾„</code> ä»¥åŠ <code>ç©ºå­—ç¬¦ä¸²</code> çš„æ£€æŸ¥ä¹‹åï¼Œä¾¿å¼€å§‹è°ƒç”¨ <code>nativeLoad</code>  çœŸæ­£çš„å»åŠ è½½ so äº†</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\libcore\\ojluni\\src\\main\\java\\java\\lang\\Runtime.java</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">load0</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> fromClass<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> filename<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isAbsolute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UnsatisfiedLinkError</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token string\">\"Expecting an absolute path of the library: \"</span> <span class=\"token operator\">+</span> filename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>filename <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NullPointerException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"filename == null\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token class-name\">String</span> error <span class=\"token operator\">=</span> <span class=\"token function\">nativeLoad</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> fromClass<span class=\"token punctuation\">.</span><span class=\"token function\">getClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UnsatisfiedLinkError</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>fromClass.getClassLoader()</strong></p>\n<p>å‘ <code>nativeLoad</code>  ä¸­ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ <code>fromClass.getClassLoader()</code> , åˆ©ç”¨è¿™ä¸ªæ–¹æ³•å¯ä»¥è·å–åˆ° <code>fromClass</code>  ç±»çš„ <code>ClassLoader</code></p>\n<blockquote>\n<p>ä¸ºä»€ä¹ˆè¦è·å– ClassLoader å¹¶å°†å…¶ä½œä¸ºå‚æ•°ä¼ å…¥ nativeLoad?</p>\n</blockquote>\n<h2 id=\"runtimejavaä¸­çš„nativeload\"><a class=\"anchor\" href=\"#runtimejavaä¸­çš„nativeload\">#</a> Runtime.java ä¸­çš„ nativeLoad</h2>\n<p>åœ¨ <code>nativeLoad</code>  é‡è½½è°ƒç”¨äº† <code>nativeLoad(String filename, ClassLoader loader, Class&lt;?&gt; caller)</code> , è€Œè¯¥å‡½æ•°çš„å£°æ˜ä¸º <code>native</code> , è¿™ä¾¿æ„å‘³ç€æˆ‘ä»¬å³å°†èµ°å‡º java æ¥åˆ° c++ çš„ä¸–ç•Œäº†</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\libcore\\ojluni\\src\\main\\java\\java\\lang\\Runtime.java</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">nativeLoad</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> filename<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClassLoader</span> loader<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">nativeLoad</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> loader<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">native</span> <span class=\"token class-name\">String</span> <span class=\"token function\">nativeLoad</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> filename<span class=\"token punctuation\">,</span> <span class=\"token class-name\">ClassLoader</span> loader<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> caller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"runtimecä¸­çš„nativeload\"><a class=\"anchor\" href=\"#runtimecä¸­çš„nativeload\">#</a> Runtime.c ä¸­çš„ nativeLoad</h2>\n<p>åœ¨å¸¸è§„çš„ JNI å‡½æ•°çš„ç¼–å†™è¿‡ç¨‹ä¸­ï¼Œæƒ³è¦è®© java å±‚è°ƒç”¨ JNI ä¸­å®šä¹‰çš„å‡½æ•°ï¼Œè¦ä¹ˆä½¿ç”¨é™æ€æ³¨å†Œï¼Œåˆ©ç”¨ <code>JNIEXPORT</code>  å…³é”®å­—å°†è¿™ä¸ªå‡½æ•°å¯¼å‡ºï¼Œæˆ–è€…ä½¿ç”¨ <code>RegisterNatives</code>  æ–¹æ³•å»è¿›è¡ŒåŠ¨æ€æ³¨å†Œï¼Œè€Œåœ¨ AOSP å®šä¹‰ <code>nativeLoad</code>  æ—¶ï¼Œè¿™ä¸¤ç§æ–¹æ³•éƒ½ä½¿ç”¨åˆ°äº†ï¼Œå¯¹äºå­¦ä¹  JNI çš„æ³¨å†Œè¿‡ç¨‹éå¸¸å…·æœ‰å‚è€ƒæ„ä¹‰</p>\n<p>æŸ¥çœ‹ <code>Runtime_nativeLoad</code>  å‡½æ•°ï¼Œå¯ä»¥å‘ç°å®ƒç»§ç»­è°ƒç”¨äº† <code>JVM_NativeLoad</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\libcore\\ojluni\\src\\main\\native\\Runtime.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>JNIEXPORT jstring JNICALL</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">Runtime_nativeLoad</span><span class=\"token punctuation\">(</span>JNIEnv<span class=\"token operator\">*</span> env<span class=\"token punctuation\">,</span> jclass ignored<span class=\"token punctuation\">,</span> jstring javaFilename<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                   jobject javaLoader<span class=\"token punctuation\">,</span> jclass caller<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">JVM_NativeLoad</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> javaFilename<span class=\"token punctuation\">,</span> javaLoader<span class=\"token punctuation\">,</span> caller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">//these macros below are defined at android-platform\\libnativehelper\\include_platform_header_only\\nativehelper\\jni_macros.h</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">FAST_NATIVE_METHOD</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>className<span class=\"token punctuation\">,</span> functionName<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">)</span>           </span><span class=\"token punctuation\">\\</span></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token expression\"><span class=\"token function\">MAKE_JNI_FAST_NATIVE_METHOD</span><span class=\"token punctuation\">(</span>#functionName<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">,</span> className </span><span class=\"token punctuation\">##</span> <span class=\"token expression\">_ </span><span class=\"token punctuation\">##</span> <span class=\"token expression\">functionName<span class=\"token punctuation\">)</span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">NATIVE_METHOD</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>className<span class=\"token punctuation\">,</span> functionName<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">)</span>                </span><span class=\"token punctuation\">\\</span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token expression\"><span class=\"token function\">MAKE_JNI_NATIVE_METHOD</span><span class=\"token punctuation\">(</span>#functionName<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">,</span> className </span><span class=\"token punctuation\">##</span> <span class=\"token expression\">_ </span><span class=\"token punctuation\">##</span> <span class=\"token expression\">functionName<span class=\"token punctuation\">)</span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">MAKE_JNI_NATIVE_METHOD</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">,</span> function<span class=\"token punctuation\">)</span>                      </span><span class=\"token punctuation\">\\</span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token expression\"><span class=\"token function\">_NATIVEHELPER_JNI_MAKE_METHOD</span><span class=\"token punctuation\">(</span>kNormalNative<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">,</span> function<span class=\"token punctuation\">)</span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">_NATIVEHELPER_JNI_MAKE_METHOD</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>kind<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> sig<span class=\"token punctuation\">,</span> fn<span class=\"token punctuation\">)</span> </span><span class=\"token punctuation\">\\</span></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token expression\"><span class=\"token function\">MAKE_CHECKED_JNI_NATIVE_METHOD</span><span class=\"token punctuation\">(</span>kind<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> sig<span class=\"token punctuation\">,</span> fn<span class=\"token punctuation\">)</span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">//MAKE_CHECKED_JNI_NATIVE_METHOD is defined at platform\\libnativehelper\\include_platform_header_only\\nativehelper\\detail\\signature_checker.h</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">MAKE_CHECKED_JNI_NATIVE_METHOD</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>native_kind<span class=\"token punctuation\">,</span> name_<span class=\"token punctuation\">,</span> signature_<span class=\"token punctuation\">,</span> fn<span class=\"token punctuation\">)</span> </span><span class=\"token punctuation\">\\</span></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>                                                                </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token expression\">using namespace nativehelper<span class=\"token operator\">::</span>detail<span class=\"token punctuation\">;</span>  </span><span class=\"token comment\">/* NOLINT(google-build-using-namespace) */</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token expression\"><span class=\"token function\">static_assert</span><span class=\"token punctuation\">(</span>                                                       </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token expression\">MatchJniDescriptorWithFunctionType<span class=\"token operator\">&lt;</span>native_kind<span class=\"token punctuation\">,</span>                  </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                                           <span class=\"token expression\"><span class=\"token function\">decltype</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>                 </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                                           <span class=\"token expression\">fn<span class=\"token punctuation\">,</span>                           </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                                           <span class=\"token expression\"><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>signature_<span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>signature_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token string\">\"JNI signature doesn't match C++ function type.\"</span><span class=\"token expression\"><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>               </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">/* Suppress implicit cast warnings by explicitly casting. */</span>         <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token expression\"><span class=\"token keyword\">return</span> JNINativeMethod <span class=\"token punctuation\">&#123;</span>                                             </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token expression\">const_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">decltype</span><span class=\"token punctuation\">(</span>JNINativeMethod<span class=\"token operator\">::</span>name<span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>name_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>              </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token expression\">const_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">decltype</span><span class=\"token punctuation\">(</span>JNINativeMethod<span class=\"token operator\">::</span>signature<span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>signature_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>    </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token expression\">reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>                                 </span><span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token expression\"><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\">//NELEM is defined at platform\\libnativehelper\\include\\nativehelper\\JNIHelp.h</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">NELEM</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">//jniRegisterNativeMethods is defined at platform\\libnativehelper\\JNIHelp.c</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">jniRegisterNativeMethods</span><span class=\"token punctuation\">(</span>JNIEnv<span class=\"token operator\">*</span> env<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> className<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">const</span> JNINativeMethod<span class=\"token operator\">*</span> methods<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> numMethods<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token function\">ALOGV</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Registering %s's %d native methods...\"</span><span class=\"token punctuation\">,</span> className<span class=\"token punctuation\">,</span> numMethods<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    jclass clazz <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>env<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">FindClass</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> className<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token function\">ALOG_ALWAYS_FATAL_IF</span><span class=\"token punctuation\">(</span>clazz <span class=\"token operator\">==</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                         <span class=\"token string\">\"Native registration unable to find class '%s'; aborting...\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                         className<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">int</span> result <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>env<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">RegisterNatives</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> clazz<span class=\"token punctuation\">,</span> methods<span class=\"token punctuation\">,</span> numMethods<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>env<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">DeleteLocalRef</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> clazz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token comment\">// Failure to register natives is fatal. Try to report the corresponding exception,</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token comment\">// otherwise abort with generic failure message.</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    jthrowable thrown <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>env<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">ExceptionOccurred</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>thrown <span class=\"token operator\">!=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token keyword\">struct</span> <span class=\"token class-name\">ExpandableString</span> summary<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        <span class=\"token function\">ExpandableStringInitialize</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>summary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">GetExceptionSummary</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> thrown<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>summary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            <span class=\"token function\">ALOGF</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s\"</span><span class=\"token punctuation\">,</span> summary<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token function\">ExpandableStringRelease</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>summary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>env<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">DeleteLocalRef</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> thrown<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token function\">ALOGF</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"RegisterNatives failed for '%s'; aborting...\"</span><span class=\"token punctuation\">,</span> className<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token keyword\">static</span> JNINativeMethod gMethods<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token function\">FAST_NATIVE_METHOD</span><span class=\"token punctuation\">(</span>Runtime<span class=\"token punctuation\">,</span> freeMemory<span class=\"token punctuation\">,</span> <span class=\"token string\">\"()J\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token function\">FAST_NATIVE_METHOD</span><span class=\"token punctuation\">(</span>Runtime<span class=\"token punctuation\">,</span> totalMemory<span class=\"token punctuation\">,</span> <span class=\"token string\">\"()J\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token function\">FAST_NATIVE_METHOD</span><span class=\"token punctuation\">(</span>Runtime<span class=\"token punctuation\">,</span> maxMemory<span class=\"token punctuation\">,</span> <span class=\"token string\">\"()J\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token function\">NATIVE_METHOD</span><span class=\"token punctuation\">(</span>Runtime<span class=\"token punctuation\">,</span> nativeGc<span class=\"token punctuation\">,</span> <span class=\"token string\">\"()V\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  <span class=\"token function\">NATIVE_METHOD</span><span class=\"token punctuation\">(</span>Runtime<span class=\"token punctuation\">,</span> nativeExit<span class=\"token punctuation\">,</span> <span class=\"token string\">\"(I)V\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  <span class=\"token function\">NATIVE_METHOD</span><span class=\"token punctuation\">(</span>Runtime<span class=\"token punctuation\">,</span> nativeLoad<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                <span class=\"token string\">\"(Ljava/lang/String;Ljava/lang/ClassLoader;Ljava/lang/Class;)\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                    <span class=\"token string\">\"Ljava/lang/String;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">register_java_lang_Runtime</span><span class=\"token punctuation\">(</span>JNIEnv<span class=\"token operator\">*</span> env<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  <span class=\"token function\">jniRegisterNativeMethods</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> <span class=\"token string\">\"java/lang/Runtime\"</span><span class=\"token punctuation\">,</span> gMethods<span class=\"token punctuation\">,</span> <span class=\"token function\">NELEM</span><span class=\"token punctuation\">(</span>gMethods<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"jvm_nativeload\"><a class=\"anchor\" href=\"#jvm_nativeload\">#</a> JVM_NativeLoad</h2>\n<p><code>JVM_NativeLoad</code>  è·å–å½“å‰è¿›ç¨‹çš„ <code>javaVM</code>  å¯¹è±¡å¹¶è°ƒç”¨ <code>javaVM</code>  çš„ <code>LoadNativeLibrary</code>  æ–¹æ³•</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\art\\openjdkjvm\\OpenjdkJvm.cc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>JNIEXPORT jstring <span class=\"token function\">JVM_NativeLoad</span><span class=\"token punctuation\">(</span>JNIEnv<span class=\"token operator\">*</span> env<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                 jstring javaFilename<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                 jobject javaLoader<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                                 jclass caller<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// å®ä¾‹åŒ–ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ScopedUtfChars <span class=\"token function\">filename</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> javaFilename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">return</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  std<span class=\"token operator\">::</span>string error_msg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// è·å–å½“å‰è¿›ç¨‹çš„ javaVM å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    art<span class=\"token operator\">::</span>JavaVMExt<span class=\"token operator\">*</span> vm <span class=\"token operator\">=</span> art<span class=\"token operator\">::</span>Runtime<span class=\"token operator\">::</span><span class=\"token function\">Current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetJavaVM</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    bool success <span class=\"token operator\">=</span> vm<span class=\"token operator\">-></span><span class=\"token function\">LoadNativeLibrary</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                                         filename<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                                         javaLoader<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                                         caller<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                                         <span class=\"token operator\">&amp;</span>error_msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>success<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token keyword\">return</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token comment\">// Don't let a pending exception from JNI_OnLoad cause a CheckJNI issue with NewStringUTF.</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  env<span class=\"token operator\">-></span><span class=\"token function\">ExceptionClear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">return</span> env<span class=\"token operator\">-></span><span class=\"token function\">NewStringUTF</span><span class=\"token punctuation\">(</span>error_msg<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"vm-loadnativelibrary\"><a class=\"anchor\" href=\"#vm-loadnativelibrary\">#</a> vm-&gt;LoadNativeLibrary</h2>\n<p><code>LoadNativeLibrary</code>  çš„ä»£ç å¾ˆé•¿ï¼Œç»†çœ‹ä¹‹åå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†</p>\n<ol>\n<li>\n<p><code>so</code>  åŠ è½½å‰<br>\nè¿™ä¸ªéƒ¨åˆ†ä¸»è¦åˆ¤æ–­å³å°†è¢« so æ˜¯å¦ä¹‹å‰å°±å·²ç»è¢«åŠ è½½è¿‡ï¼Œå¦‚æœå·²ç»è¢«åŠ è½½å¥½äº†ï¼Œé‚£ä¹ˆå°±ç›´æ¥é€€å‡ºè¿™ä¸ªå‡½æ•°å¹¶è¿”å›</p>\n</li>\n<li>\n<p><code>so</code>  åŠ è½½æ—¶<br>\nè¿™ä¸ªéƒ¨åˆ†å°±æ˜¯ AOSP å®ç°åŠ¨æ€é“¾æ¥åº“åŠ è½½çš„æ ¸å¿ƒå®ç°ï¼Œä¹‹åä¼šè¿›è¡Œè¯¦ç»†çš„åˆ†æ<br>\nå½“æ‰¾åˆ°è¿™ä¸ª so çš„ soinfo ä¹‹å (å…·ä½“æ˜¯åœ¨<a href=\"###do_dlopen\"> do_dlopen</a> ä¸­è¢«æ‰¾åˆ°), ä¼šç«‹å³è°ƒç”¨ <code>soinfo::call_constructors</code>  å‡½æ•°ä¾æ¬¡åŠ è½½ <code>init</code>  å’Œ <code>init_array</code>  å‡½æ•°</p>\n</li>\n<li>\n<p><code>so</code>  åŠ è½½å<br>\nåœ¨è¿™æœ€åä¸€ä¸ªéƒ¨åˆ†ä¸­ï¼Œå½“ä¸€ä¸ª so è¢«æˆåŠŸåŠ è½½åï¼Œä¼šç«‹å³è°ƒç”¨ <code>so</code>  çš„å¯¼å‡ºå‡½æ•°ä¸­çš„ <code>JNI_OnLoad</code>  å‡½æ•° (å¦‚æœ <code>JNI_OnLoad</code>  å­˜åœ¨çš„è¯)</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\art\\runtime\\jni\\java_vm_ext.cc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// é˜¶æ®µä¸‰ï¼šå½“ so è¢«åŠ è½½ä¹‹åï¼Œç«‹å³è°ƒç”¨å¯¼å‡ºå‡½æ•° JNI_OnLoad</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>bool was_successful <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> sym <span class=\"token operator\">=</span> library<span class=\"token operator\">-></span><span class=\"token function\">FindSymbol</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"JNI_OnLoad\"</span><span class=\"token punctuation\">,</span> nullptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sym <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[No JNI_OnLoad found in \\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"]\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    was_successful <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// Call JNI_OnLoad.  We have to override the current class</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// loader, which will always be \"null\" since the stuff at the</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">// top of the stack is around Runtime.loadLibrary().  (See</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// the comments in the JNI FindClass function.)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ScopedLocalRef<span class=\"token operator\">&lt;</span>jobject<span class=\"token operator\">></span> <span class=\"token function\">old_class_loader</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> env<span class=\"token operator\">-></span><span class=\"token function\">NewLocalRef</span><span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span><span class=\"token function\">GetClassLoaderOverride</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    self<span class=\"token operator\">-></span><span class=\"token function\">SetClassLoaderOverride</span><span class=\"token punctuation\">(</span>class_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[Calling JNI_OnLoad in \\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"]\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    using JNI_OnLoadFn <span class=\"token operator\">=</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>JavaVM<span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    JNI_OnLoadFn jni_on_load <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span>JNI_OnLoadFn<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>sym<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">int</span> version <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>jni_on_load<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>this<span class=\"token punctuation\">,</span> nullptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IsSdkVersionSetAndAtMost</span><span class=\"token punctuation\">(</span>runtime_<span class=\"token operator\">-></span><span class=\"token function\">GetTargetSdkVersion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> SdkVersion<span class=\"token operator\">::</span>kL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token comment\">// Make sure that sigchain owns SIGSEGV.</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token function\">EnsureFrontOfChain</span><span class=\"token punctuation\">(</span>SIGSEGV<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    self<span class=\"token operator\">-></span><span class=\"token function\">SetClassLoaderOverride</span><span class=\"token punctuation\">(</span>old_class_loader<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>version <span class=\"token operator\">==</span> JNI_ERR<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token function\">StringAppendF</span><span class=\"token punctuation\">(</span>error_msg<span class=\"token punctuation\">,</span> <span class=\"token string\">\"JNI_ERR returned from JNI_OnLoad in \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>JavaVMExt<span class=\"token operator\">::</span><span class=\"token function\">IsBadJniVersion</span><span class=\"token punctuation\">(</span>version<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token function\">StringAppendF</span><span class=\"token punctuation\">(</span>error_msg<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Bad JNI version returned from JNI_OnLoad in \\\"%s\\\": %d\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                      path<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> version<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token comment\">// It's unwise to call dlclose() here, but we can mark it</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token comment\">// as bad and ensure that future load attempts will fail.</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token comment\">// We don't know how far JNI_OnLoad got, so there could</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token comment\">// be some partially-initialized stuff accessible through</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token comment\">// newly-registered native method calls.  We could try to</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token comment\">// unregister them, but that doesn't seem worthwhile.</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        was_successful <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[Returned \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span>was_successful <span class=\"token operator\">?</span> <span class=\"token string\">\"successfully\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"failure\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" from JNI_OnLoad in \\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"]\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ol>\n<p>å®Œæ•´çš„ <code>LoadNativeLibrary</code>  ä»£ç </p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\art\\runtime\\jni\\java_vm_ext.cc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bool JavaVMExt<span class=\"token operator\">::</span><span class=\"token function\">LoadNativeLibrary</span><span class=\"token punctuation\">(</span>JNIEnv<span class=\"token operator\">*</span> env<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                  <span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>string<span class=\"token operator\">&amp;</span> path<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                  jobject class_loader<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                                  jclass caller_class<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                  std<span class=\"token operator\">::</span>string<span class=\"token operator\">*</span> error_msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  error_msg<span class=\"token operator\">-></span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// é˜¶æ®µä¸€ï¼šåˆ¤æ–­ç›®æ ‡ so æ˜¯å¦å·²ç»è¢«åŠ è½½è¿‡</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// See if we've already loaded this library.  If we have, and the class loader</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// matches, return successfully without doing anything.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// TODO: for better results we should canonicalize (è§„èŒƒåŒ–) the pathname (or even compare</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">// inodes). This implementation is fine if everybody is using System.loadLibrary.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  SharedLibrary<span class=\"token operator\">*</span> library<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  Thread<span class=\"token operator\">*</span> self <span class=\"token operator\">=</span> Thread<span class=\"token operator\">::</span><span class=\"token function\">Current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// TODO: move the locking (and more of this logic) into Libraries.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    MutexLock <span class=\"token function\">mu</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>Locks<span class=\"token operator\">::</span>jni_libraries_lock_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    library <span class=\"token operator\">=</span> libraries_<span class=\"token operator\">-></span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> class_loader_allocator <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  std<span class=\"token operator\">::</span>string caller_location<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    ScopedObjectAccess <span class=\"token function\">soa</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// As the incoming class loader is reachable/alive during the call of this function,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">// it's okay to decode it without worrying about unexpectedly marking it alive.</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    ObjPtr<span class=\"token operator\">&lt;</span>mirror<span class=\"token operator\">::</span>ClassLoader<span class=\"token operator\">></span> loader <span class=\"token operator\">=</span> soa<span class=\"token punctuation\">.</span>Decode<span class=\"token operator\">&lt;</span>mirror<span class=\"token operator\">::</span>ClassLoader<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>class_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    ClassLinker<span class=\"token operator\">*</span> class_linker <span class=\"token operator\">=</span> Runtime<span class=\"token operator\">::</span><span class=\"token function\">Current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetClassLinker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>class_linker<span class=\"token operator\">-></span><span class=\"token function\">IsBootClassLoader</span><span class=\"token punctuation\">(</span>soa<span class=\"token punctuation\">,</span> loader<span class=\"token punctuation\">.</span><span class=\"token function\">Ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      loader <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      class_loader <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>caller_class <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        ObjPtr<span class=\"token operator\">&lt;</span>mirror<span class=\"token operator\">::</span>Class<span class=\"token operator\">></span> caller <span class=\"token operator\">=</span> soa<span class=\"token punctuation\">.</span>Decode<span class=\"token operator\">&lt;</span>mirror<span class=\"token operator\">::</span>Class<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>caller_class<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        ObjPtr<span class=\"token operator\">&lt;</span>mirror<span class=\"token operator\">::</span>DexCache<span class=\"token operator\">></span> dex_cache <span class=\"token operator\">=</span> caller<span class=\"token operator\">-></span><span class=\"token function\">GetDexCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dex_cache <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          caller_location <span class=\"token operator\">=</span> dex_cache<span class=\"token operator\">-></span><span class=\"token function\">GetLocation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">ToModifiedUtf8</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    class_loader_allocator <span class=\"token operator\">=</span> class_linker<span class=\"token operator\">-></span><span class=\"token function\">GetAllocatorForClassLoader</span><span class=\"token punctuation\">(</span>loader<span class=\"token punctuation\">.</span><span class=\"token function\">Ptr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token function\">CHECK</span><span class=\"token punctuation\">(</span>class_loader_allocator <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>library <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">// Use the allocator pointers for class loader equality to avoid unnecessary weak root decode.</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>library<span class=\"token operator\">-></span><span class=\"token function\">GetClassLoaderAllocator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> class_loader_allocator<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token comment\">// The library will be associated with class_loader. The JNI</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      <span class=\"token comment\">// spec says we can't load the same library into more than one</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token comment\">// class loader.</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token comment\">// This isn't very common. So spend some time to get a readable message.</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      <span class=\"token keyword\">auto</span> call_to_string <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>jobject obj<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> std<span class=\"token operator\">::</span>string <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          <span class=\"token keyword\">return</span> <span class=\"token string\">\"null\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token comment\">// Handle jweaks. Ignore double local-ref.</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        ScopedLocalRef<span class=\"token operator\">&lt;</span>jobject<span class=\"token operator\">></span> <span class=\"token function\">local_ref</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> env<span class=\"token operator\">-></span><span class=\"token function\">NewLocalRef</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>local_ref <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          ScopedLocalRef<span class=\"token operator\">&lt;</span>jclass<span class=\"token operator\">></span> <span class=\"token function\">local_class</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> env<span class=\"token operator\">-></span><span class=\"token function\">GetObjectClass</span><span class=\"token punctuation\">(</span>local_ref<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          jmethodID to_string <span class=\"token operator\">=</span> env<span class=\"token operator\">-></span><span class=\"token function\">GetMethodID</span><span class=\"token punctuation\">(</span>local_class<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                                                 <span class=\"token string\">\"toString\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                                                 <span class=\"token string\">\"()Ljava/lang/String;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          <span class=\"token function\">DCHECK</span><span class=\"token punctuation\">(</span>to_string <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          ScopedLocalRef<span class=\"token operator\">&lt;</span>jobject<span class=\"token operator\">></span> <span class=\"token function\">local_string</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                                               env<span class=\"token operator\">-></span><span class=\"token function\">CallObjectMethod</span><span class=\"token punctuation\">(</span>local_ref<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> to_string<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>local_string <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            ScopedUtfChars <span class=\"token function\">utf</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> reinterpret_cast<span class=\"token operator\">&lt;</span>jstring<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>local_string<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>utf<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>              <span class=\"token keyword\">return</span> utf<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>env<span class=\"token operator\">-></span><span class=\"token function\">ExceptionCheck</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            <span class=\"token comment\">// We can't do much better logging, really. So leave it with a Describe.</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            env<span class=\"token operator\">-></span><span class=\"token function\">ExceptionDescribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>            env<span class=\"token operator\">-></span><span class=\"token function\">ExceptionClear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>          <span class=\"token keyword\">return</span> <span class=\"token string\">\"(Error calling toString)\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token string\">\"null\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      std<span class=\"token operator\">::</span>string old_class_loader <span class=\"token operator\">=</span> <span class=\"token function\">call_to_string</span><span class=\"token punctuation\">(</span>library<span class=\"token operator\">-></span><span class=\"token function\">GetClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>      std<span class=\"token operator\">::</span>string new_class_loader <span class=\"token operator\">=</span> <span class=\"token function\">call_to_string</span><span class=\"token punctuation\">(</span>class_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      <span class=\"token function\">StringAppendF</span><span class=\"token punctuation\">(</span>error_msg<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Shared library \\\"%s\\\" already opened by \"</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          <span class=\"token string\">\"ClassLoader %p(%s); can't open in ClassLoader %p(%s)\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          path<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          library<span class=\"token operator\">-></span><span class=\"token function\">GetClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>          old_class_loader<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          class_loader<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          new_class_loader<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>      <span class=\"token function\">LOG</span><span class=\"token punctuation\">(</span>WARNING<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>error_msg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[Shared library \\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\" already loaded in \"</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" ClassLoader \"</span> <span class=\"token operator\">&lt;&lt;</span> class_loader <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"]\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>library<span class=\"token operator\">-></span><span class=\"token function\">CheckOnLoadResult</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>      <span class=\"token function\">StringAppendF</span><span class=\"token punctuation\">(</span>error_msg<span class=\"token punctuation\">,</span> <span class=\"token string\">\"JNI_OnLoad failed on a previous attempt \"</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>          <span class=\"token string\">\"to load \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>    <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  <span class=\"token comment\">// é˜¶æ®µäºŒï¼šåŠ è½½ so</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  <span class=\"token comment\">// Open the shared library.  Because we're using a full path, the system</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token comment\">// doesn't have to search through LD_LIBRARY_PATH.  (It may do so to</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  <span class=\"token comment\">// resolve this library's dependencies though.)</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  <span class=\"token comment\">// Failures here are expected when java.library.path has several entries</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  <span class=\"token comment\">// and we have to hunt for the lib.</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  <span class=\"token comment\">// Below we dlopen but there is no paired dlclose, this would be necessary if we supported</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  <span class=\"token comment\">// class unloading. Libraries will only be unloaded when the reference count (incremented by</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  <span class=\"token comment\">// dlopen) becomes zero from dlclose.</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>  <span class=\"token comment\">// Retrieve the library path from the classloader, if necessary.</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  ScopedLocalRef<span class=\"token operator\">&lt;</span>jstring<span class=\"token operator\">></span> <span class=\"token function\">library_path</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> <span class=\"token function\">GetLibrarySearchPath</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> class_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  Locks<span class=\"token operator\">::</span>mutator_lock_<span class=\"token operator\">-></span><span class=\"token function\">AssertNotHeld</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> path_str <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> nullptr <span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>  bool needs_native_bridge <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> nativeloader_error_msg <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>  <span class=\"token comment\">// è°ƒç”¨ dlopen æ‰“å¼€ç›®æ ‡ so</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> handle <span class=\"token operator\">=</span> android<span class=\"token operator\">::</span><span class=\"token function\">OpenNativeLibrary</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>      env<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>      runtime_<span class=\"token operator\">-></span><span class=\"token function\">GetTargetSdkVersion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>      path_str<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>      class_loader<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>      <span class=\"token punctuation\">(</span>caller_location<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> nullptr <span class=\"token operator\">:</span> caller_location<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>      library_path<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>      <span class=\"token operator\">&amp;</span>needs_native_bridge<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>      <span class=\"token operator\">&amp;</span>nativeloader_error_msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>  <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[Call to dlopen(\\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\", RTLD_NOW) returned \"</span> <span class=\"token operator\">&lt;&lt;</span> handle <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"]\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>handle <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>    <span class=\"token operator\">*</span>error_msg <span class=\"token operator\">=</span> nativeloader_error_msg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    android<span class=\"token operator\">::</span><span class=\"token function\">NativeLoaderFreeErrorMessage</span><span class=\"token punctuation\">(</span>nativeloader_error_msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>    <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"dlopen(\\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\", RTLD_NOW) failed: \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>error_msg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>env<span class=\"token operator\">-></span><span class=\"token function\">ExceptionCheck</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> JNI_TRUE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>    <span class=\"token function\">LOG</span><span class=\"token punctuation\">(</span>ERROR<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Unexpected exception:\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>    env<span class=\"token operator\">-></span><span class=\"token function\">ExceptionDescribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>    env<span class=\"token operator\">-></span><span class=\"token function\">ExceptionClear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>  <span class=\"token comment\">// Create a new entry.</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>  <span class=\"token comment\">// TODO: move the locking (and more of this logic) into Libraries.</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>  bool created_library <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>    <span class=\"token comment\">// Create SharedLibrary ahead of taking the libraries lock to maintain lock ordering.</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>    std<span class=\"token operator\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>SharedLibrary<span class=\"token operator\">></span> <span class=\"token function\">new_library</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>        new <span class=\"token function\">SharedLibrary</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>                          self<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>                          path<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>                          handle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>                          needs_native_bridge<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>                          class_loader<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>                          class_loader_allocator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>    MutexLock <span class=\"token function\">mu</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>Locks<span class=\"token operator\">::</span>jni_libraries_lock_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>    library <span class=\"token operator\">=</span> libraries_<span class=\"token operator\">-></span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>library <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  <span class=\"token comment\">// We won race to get libraries_lock.</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>      library <span class=\"token operator\">=</span> new_library<span class=\"token punctuation\">.</span><span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>      libraries_<span class=\"token operator\">-></span><span class=\"token function\">Put</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> library<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>      created_library <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>created_library<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>    <span class=\"token function\">LOG</span><span class=\"token punctuation\">(</span>INFO<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"WOW: we lost a race to add shared library: \"</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\" ClassLoader=\"</span> <span class=\"token operator\">&lt;&lt;</span> class_loader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>    <span class=\"token keyword\">return</span> library<span class=\"token operator\">-></span><span class=\"token function\">CheckOnLoadResult</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>  <span class=\"token comment\">// åŠ¨æ€é“¾æ¥åº“è£…è½½å®Œæˆ</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>  <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[Added shared library \\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\" for ClassLoader \"</span> <span class=\"token operator\">&lt;&lt;</span> class_loader <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"]\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>  <span class=\"token comment\">// é˜¶æ®µä¸‰ï¼šå½“ so è¢«åŠ è½½ä¹‹åï¼Œç«‹å³è°ƒç”¨å¯¼å‡ºå‡½æ•° JNI_OnLoad</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>  bool was_successful <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>  <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> sym <span class=\"token operator\">=</span> library<span class=\"token operator\">-></span><span class=\"token function\">FindSymbol</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"JNI_OnLoad\"</span><span class=\"token punctuation\">,</span> nullptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sym <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>    <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[No JNI_OnLoad found in \\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"]\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>    was_successful <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>    <span class=\"token comment\">// Call JNI_OnLoad.  We have to override the current class</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>    <span class=\"token comment\">// loader, which will always be \"null\" since the stuff at the</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>    <span class=\"token comment\">// top of the stack is around Runtime.loadLibrary().  (See</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>    <span class=\"token comment\">// the comments in the JNI FindClass function.)</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>    ScopedLocalRef<span class=\"token operator\">&lt;</span>jobject<span class=\"token operator\">></span> <span class=\"token function\">old_class_loader</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> env<span class=\"token operator\">-></span><span class=\"token function\">NewLocalRef</span><span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span><span class=\"token function\">GetClassLoaderOverride</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>    self<span class=\"token operator\">-></span><span class=\"token function\">SetClassLoaderOverride</span><span class=\"token punctuation\">(</span>class_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>    <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[Calling JNI_OnLoad in \\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"]\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>    using JNI_OnLoadFn <span class=\"token operator\">=</span> <span class=\"token keyword\">int</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>JavaVM<span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>    JNI_OnLoadFn jni_on_load <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span>JNI_OnLoadFn<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>sym<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>    <span class=\"token keyword\">int</span> version <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>jni_on_load<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>this<span class=\"token punctuation\">,</span> nullptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">IsSdkVersionSetAndAtMost</span><span class=\"token punctuation\">(</span>runtime_<span class=\"token operator\">-></span><span class=\"token function\">GetTargetSdkVersion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> SdkVersion<span class=\"token operator\">::</span>kL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>      <span class=\"token comment\">// Make sure that sigchain owns SIGSEGV.</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>      <span class=\"token function\">EnsureFrontOfChain</span><span class=\"token punctuation\">(</span>SIGSEGV<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>    self<span class=\"token operator\">-></span><span class=\"token function\">SetClassLoaderOverride</span><span class=\"token punctuation\">(</span>old_class_loader<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>version <span class=\"token operator\">==</span> JNI_ERR<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>      <span class=\"token function\">StringAppendF</span><span class=\"token punctuation\">(</span>error_msg<span class=\"token punctuation\">,</span> <span class=\"token string\">\"JNI_ERR returned from JNI_OnLoad in \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>JavaVMExt<span class=\"token operator\">::</span><span class=\"token function\">IsBadJniVersion</span><span class=\"token punctuation\">(</span>version<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>      <span class=\"token function\">StringAppendF</span><span class=\"token punctuation\">(</span>error_msg<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Bad JNI version returned from JNI_OnLoad in \\\"%s\\\": %d\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>                    path<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> version<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>      <span class=\"token comment\">// It's unwise to call dlclose() here, but we can mark it</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>      <span class=\"token comment\">// as bad and ensure that future load attempts will fail.</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>      <span class=\"token comment\">// We don't know how far JNI_OnLoad got, so there could</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>      <span class=\"token comment\">// be some partially-initialized stuff accessible through</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>      <span class=\"token comment\">// newly-registered native method calls.  We could try to</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>      <span class=\"token comment\">// unregister them, but that doesn't seem worthwhile.</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>      was_successful <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>    <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[Returned \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span>was_successful <span class=\"token operator\">?</span> <span class=\"token string\">\"successfully\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"failure\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>              <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" from JNI_OnLoad in \\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"]\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>  library<span class=\"token operator\">-></span><span class=\"token function\">SetResult</span><span class=\"token punctuation\">(</span>was_successful<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>  <span class=\"token keyword\">return</span> was_successful<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"soçš„åŠ è½½è¿‡ç¨‹\"><a class=\"anchor\" href=\"#soçš„åŠ è½½è¿‡ç¨‹\">#</a> so çš„åŠ è½½è¿‡ç¨‹</h1>\n<p>åœ¨åˆšåˆšå¯¹äº <code>vm-&gt;LoadNativeLibrary</code>  å‡½æ•° <code>soåŠ è½½æ—¶</code> çš„ç®€è¦åˆ†æä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ç›®æ ‡ so æ˜¯é€šè¿‡ <code>dlopen</code>  æ‰“å¼€çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä» <code>android::OpenNativeLibrary</code>  å‡½æ•°å¼€å§‹åˆ†æ</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\art\\runtime\\jni\\java_vm_ext.cc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bool JavaVMExt<span class=\"token operator\">::</span><span class=\"token function\">LoadNativeLibrary</span><span class=\"token punctuation\">(</span>JNIEnv<span class=\"token operator\">*</span> env<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                  <span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>string<span class=\"token operator\">&amp;</span> path<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                  jobject class_loader<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                                  jclass caller_class<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                  std<span class=\"token operator\">::</span>string<span class=\"token operator\">*</span> error_msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  error_msg<span class=\"token operator\">-></span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// é˜¶æ®µä¸€ï¼šåˆ¤æ–­ç›®æ ‡ so æ˜¯å¦å·²ç»è¢«åŠ è½½è¿‡</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// é˜¶æ®µäºŒï¼šåŠ è½½ so</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// Open the shared library.  Because we're using a full path, the system</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">// doesn't have to search through LD_LIBRARY_PATH.  (It may do so to</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// resolve this library's dependencies though.)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">// Failures here are expected when java.library.path has several entries</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">// and we have to hunt for the lib.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\">// Below we dlopen but there is no paired dlclose, this would be necessary if we supported</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token comment\">// class unloading. Libraries will only be unloaded when the reference count (incremented by</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token comment\">// dlopen) becomes zero from dlclose.</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token comment\">// Retrieve the library path from the classloader, if necessary.</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  ScopedLocalRef<span class=\"token operator\">&lt;</span>jstring<span class=\"token operator\">></span> <span class=\"token function\">library_path</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> <span class=\"token function\">GetLibrarySearchPath</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> class_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  Locks<span class=\"token operator\">::</span>mutator_lock_<span class=\"token operator\">-></span><span class=\"token function\">AssertNotHeld</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> path_str <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> nullptr <span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  bool needs_native_bridge <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> nativeloader_error_msg <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token comment\">// è°ƒç”¨ dlopen æ‰“å¼€ç›®æ ‡ so</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> handle <span class=\"token operator\">=</span> android<span class=\"token operator\">::</span><span class=\"token function\">OpenNativeLibrary</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      env<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      runtime_<span class=\"token operator\">-></span><span class=\"token function\">GetTargetSdkVersion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      path_str<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      class_loader<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token punctuation\">(</span>caller_location<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> nullptr <span class=\"token operator\">:</span> caller_location<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      library_path<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token operator\">&amp;</span>needs_native_bridge<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token operator\">&amp;</span>nativeloader_error_msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[Call to dlopen(\\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\", RTLD_NOW) returned \"</span> <span class=\"token operator\">&lt;&lt;</span> handle <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"]\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>handle <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token operator\">*</span>error_msg <span class=\"token operator\">=</span> nativeloader_error_msg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    android<span class=\"token operator\">::</span><span class=\"token function\">NativeLoaderFreeErrorMessage</span><span class=\"token punctuation\">(</span>nativeloader_error_msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"dlopen(\\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\", RTLD_NOW) failed: \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token operator\">*</span>error_msg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>env<span class=\"token operator\">-></span><span class=\"token function\">ExceptionCheck</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> JNI_TRUE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token function\">LOG</span><span class=\"token punctuation\">(</span>ERROR<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Unexpected exception:\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    env<span class=\"token operator\">-></span><span class=\"token function\">ExceptionDescribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    env<span class=\"token operator\">-></span><span class=\"token function\">ExceptionClear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token comment\">// Create a new entry.</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token comment\">// TODO: move the locking (and more of this logic) into Libraries.</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  bool created_library <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token comment\">// Create SharedLibrary ahead of taking the libraries lock to maintain lock ordering.</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    std<span class=\"token operator\">::</span>unique_ptr<span class=\"token operator\">&lt;</span>SharedLibrary<span class=\"token operator\">></span> <span class=\"token function\">new_library</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        new <span class=\"token function\">SharedLibrary</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                          self<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                          path<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                          handle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                          needs_native_bridge<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                          class_loader<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                          class_loader_allocator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    MutexLock <span class=\"token function\">mu</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>Locks<span class=\"token operator\">::</span>jni_libraries_lock_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    library <span class=\"token operator\">=</span> libraries_<span class=\"token operator\">-></span><span class=\"token function\">Get</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>library <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>  <span class=\"token comment\">// We won race to get libraries_lock.</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      library <span class=\"token operator\">=</span> new_library<span class=\"token punctuation\">.</span><span class=\"token function\">release</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      libraries_<span class=\"token operator\">-></span><span class=\"token function\">Put</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> library<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      created_library <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>created_library<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token function\">LOG</span><span class=\"token punctuation\">(</span>INFO<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"WOW: we lost a race to add shared library: \"</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\" ClassLoader=\"</span> <span class=\"token operator\">&lt;&lt;</span> class_loader<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token keyword\">return</span> library<span class=\"token operator\">-></span><span class=\"token function\">CheckOnLoadResult</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  <span class=\"token comment\">// åŠ¨æ€é“¾æ¥åº“è£…è½½å®Œæˆ</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[Added shared library \\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\" for ClassLoader \"</span> <span class=\"token operator\">&lt;&lt;</span> class_loader <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"]\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  <span class=\"token comment\">// é˜¶æ®µä¸‰ï¼šå½“ so è¢«åŠ è½½ä¹‹åï¼Œç«‹å³è°ƒç”¨å¯¼å‡ºå‡½æ•° JNI_OnLoad</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"androidopennativelibrary\"><a class=\"anchor\" href=\"#androidopennativelibrary\">#</a> android::OpenNativeLibrary</h2>\n<p>è¿™ä¸ªå‡½æ•°ä¸­æœ‰æ¡ä»¶ç¼–è¯‘ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æçš„æ˜¯ <code>ART_TARGET_ANDROID</code>  çš„ç¼–è¯‘æ¡ä»¶åˆ†æ”¯</p>\n<p>è·Ÿè¸ª <code>path</code>  å‚æ•°ï¼Œå¯ä»¥å‘ç°å®ƒè¢«ä¼ å…¥åˆ°äº† <code>android_dlopen_ext(const char* filename, int flag, const android_dlextinfo* extinfo)</code>  å‡½æ•°ä¸­ï¼Œ <code>flag</code>   <code>RTLD_NOW</code>  çš„å«ä¹‰æ˜¯ç«‹å³è§£ææ‰€æœ‰ç¬¦å·ï¼Œå¹¶åœ¨åŠ è½½æ—¶æŠ¥å‘Šä»»ä½•è§£æé”™è¯¯</p>\n<blockquote>\n<p><code>android_dlopen_ext</code>  å‡½æ•°çš„å¸¸è§ <code>flag</code>  å«ä¹‰</p>\n<ul>\n<li>RTLD_NOW<br>\n ç«‹å³è§£ææ‰€æœ‰ç¬¦å·ï¼Œå¹¶åœ¨åŠ è½½æ—¶æŠ¥å‘Šä»»ä½•è§£æé”™è¯¯</li>\n<li>RTLD_LAZY<br>\n åªåœ¨ç¬¦å·é¦–æ¬¡ä½¿ç”¨æ—¶è§£æ</li>\n<li>RTLD_GLOBAL<br>\n å°†åº“åŠå…¶ç¬¦å·æ·»åŠ åˆ°å…¨å±€å‘½åç©ºé—´ä¸­ï¼Œä»¥ä¾¿å…¶ä»–åº“å¯ä»¥ä½¿ç”¨è¿™äº›ç¬¦å·</li>\n</ul>\n</blockquote>\n<p><code>extinfo</code>  çš„å€¼ä¸º <code>&#123;.flags = ANDROID_DLEXT_USE_NAMESPACE,.library_namespace = boot_namespace,&#125;;</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\art\\libnativeloader\\native_loader.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> <span class=\"token function\">OpenNativeLibrary</span><span class=\"token punctuation\">(</span>JNIEnv<span class=\"token operator\">*</span> env<span class=\"token punctuation\">,</span> <span class=\"token class-name\">int32_t</span> target_sdk_version<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> path<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                        jobject class_loader<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> caller_location<span class=\"token punctuation\">,</span> jstring library_path<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                        bool<span class=\"token operator\">*</span> needs_native_bridge<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> error_msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// æ¡ä»¶ç¼–è¯‘</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">//ART_TARGET_ANDROID - Defined for target Android builds of ART.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">//ref: https://android.googlesource.com/platform/art/+/32c8337/runtime/globals.h</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>ART_TARGET_ANDROID<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token function\">UNUSED</span><span class=\"token punctuation\">(</span>target_sdk_version<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>class_loader <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token operator\">*</span>needs_native_bridge <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>caller_location <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token class-name\">android_namespace_t</span><span class=\"token operator\">*</span> boot_namespace <span class=\"token operator\">=</span> <span class=\"token function\">FindExportedNamespace</span><span class=\"token punctuation\">(</span>caller_location<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>boot_namespace <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">const</span> android_dlextinfo dlextinfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">.</span>flags <span class=\"token operator\">=</span> ANDROID_DLEXT_USE_NAMESPACE<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token punctuation\">.</span>library_namespace <span class=\"token operator\">=</span> boot_namespace<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token comment\">// è°ƒç”¨ android_dlopen_ext, å¹¶ä¼ å…¥ path</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> handle <span class=\"token operator\">=</span> <span class=\"token function\">android_dlopen_ext</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> RTLD_NOW<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dlextinfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>handle <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          <span class=\"token operator\">*</span>error_msg <span class=\"token operator\">=</span> <span class=\"token function\">strdup</span><span class=\"token punctuation\">(</span><span class=\"token function\">dlerror</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">return</span> handle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token comment\">// Check if the library is in NATIVELOADER_DEFAULT_NAMESPACE_LIBS and should</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token comment\">// be loaded from the kNativeloaderExtraLibs namespace.</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      Result<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span> handle <span class=\"token operator\">=</span> <span class=\"token function\">TryLoadNativeloaderExtraLib</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>handle<span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token operator\">*</span>error_msg <span class=\"token operator\">=</span> <span class=\"token function\">strdup</span><span class=\"token punctuation\">(</span>handle<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">message</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token keyword\">return</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>handle<span class=\"token punctuation\">.</span><span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword\">return</span> handle<span class=\"token punctuation\">.</span><span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token comment\">// Fall back to the system namespace. This happens for preloaded JNI</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token comment\">// libraries in the zygote.</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token comment\">// TODO(b/185833744): Investigate if this should fall back to the app main</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token comment\">// namespace (aka anonymous namespace) instead.</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> handle <span class=\"token operator\">=</span> <span class=\"token function\">OpenSystemLibrary</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> RTLD_NOW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>handle <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token operator\">*</span>error_msg <span class=\"token operator\">=</span> <span class=\"token function\">strdup</span><span class=\"token punctuation\">(</span><span class=\"token function\">dlerror</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">return</span> handle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  std<span class=\"token operator\">::</span>lock_guard<span class=\"token operator\">&lt;</span>std<span class=\"token operator\">::</span>mutex<span class=\"token operator\">></span> <span class=\"token function\">guard</span><span class=\"token punctuation\">(</span>g_namespaces_mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  NativeLoaderNamespace<span class=\"token operator\">*</span> ns<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>ns <span class=\"token operator\">=</span> g_namespaces<span class=\"token operator\">-></span><span class=\"token function\">FindNamespaceByClassLoader</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> class_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token comment\">// This is the case where the classloader was not created by ApplicationLoaders</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token comment\">// In this case we create an isolated not-shared namespace for it.</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    Result<span class=\"token operator\">&lt;</span>NativeLoaderNamespace<span class=\"token operator\">*</span><span class=\"token operator\">></span> isolated_ns <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token function\">CreateClassLoaderNamespaceLocked</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                                         target_sdk_version<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                                         class_loader<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                                         <span class=\"token comment\">/*is_shared=*/</span>false<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                                         <span class=\"token comment\">/*dex_path=*/</span>nullptr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                                         library_path<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                                         <span class=\"token comment\">/*permitted_path=*/</span>nullptr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                                         <span class=\"token comment\">/*uses_library_list=*/</span>nullptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isolated_ns<span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      <span class=\"token operator\">*</span>error_msg <span class=\"token operator\">=</span> <span class=\"token function\">strdup</span><span class=\"token punctuation\">(</span>isolated_ns<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">message</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      <span class=\"token keyword\">return</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      ns <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>isolated_ns<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">OpenNativeLibraryInNamespace</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> needs_native_bridge<span class=\"token punctuation\">,</span> error_msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  <span class=\"token function\">UNUSED</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> target_sdk_version<span class=\"token punctuation\">,</span> class_loader<span class=\"token punctuation\">,</span> caller_location<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  <span class=\"token comment\">// Do some best effort to emulate library-path support. It will not</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  <span class=\"token comment\">// work for dependencies.</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  <span class=\"token comment\">// Note: null has a special meaning and must be preserved.</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  std<span class=\"token operator\">::</span>string c_library_path<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Empty string by default.</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>library_path <span class=\"token operator\">!=</span> nullptr <span class=\"token operator\">&amp;&amp;</span> path <span class=\"token operator\">!=</span> nullptr <span class=\"token operator\">&amp;&amp;</span> path<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token char\">'/'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    ScopedUtfChars <span class=\"token function\">library_path_utf_chars</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> library_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    c_library_path <span class=\"token operator\">=</span> library_path_utf_chars<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>  std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>std<span class=\"token operator\">::</span>string<span class=\"token operator\">></span> library_paths <span class=\"token operator\">=</span> base<span class=\"token operator\">::</span><span class=\"token function\">Split</span><span class=\"token punctuation\">(</span>c_library_path<span class=\"token punctuation\">,</span> <span class=\"token string\">\":\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>string<span class=\"token operator\">&amp;</span> lib_path <span class=\"token operator\">:</span> library_paths<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token operator\">*</span>needs_native_bridge <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> path_arg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    std<span class=\"token operator\">::</span>string complete_path<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>path <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>      <span class=\"token comment\">// Preserve null.</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>      path_arg <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>      complete_path <span class=\"token operator\">=</span> lib_path<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>complete_path<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        complete_path<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>      complete_path<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>      path_arg <span class=\"token operator\">=</span> complete_path<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>    <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> handle <span class=\"token operator\">=</span> <span class=\"token function\">dlopen</span><span class=\"token punctuation\">(</span>path_arg<span class=\"token punctuation\">,</span> RTLD_NOW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>handle <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>      <span class=\"token keyword\">return</span> handle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">NativeBridgeIsSupported</span><span class=\"token punctuation\">(</span>path_arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>      <span class=\"token operator\">*</span>needs_native_bridge <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>      handle <span class=\"token operator\">=</span> <span class=\"token function\">NativeBridgeLoadLibrary</span><span class=\"token punctuation\">(</span>path_arg<span class=\"token punctuation\">,</span> RTLD_NOW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>handle <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        <span class=\"token keyword\">return</span> handle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>      <span class=\"token operator\">*</span>error_msg <span class=\"token operator\">=</span> <span class=\"token function\">strdup</span><span class=\"token punctuation\">(</span><span class=\"token function\">NativeBridgeGetError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>      <span class=\"token operator\">*</span>error_msg <span class=\"token operator\">=</span> <span class=\"token function\">strdup</span><span class=\"token punctuation\">(</span><span class=\"token function\">dlerror</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>  <span class=\"token keyword\">return</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"android_dlopen_ext\"><a class=\"anchor\" href=\"#android_dlopen_ext\">#</a> android_dlopen_ext</h2>\n<p><code>android_dlopen_ext</code>  è°ƒç”¨äº† <code>__loader_android_dlopen_ext</code></p>\n<p>åœ¨ä»£ç çš„ç¬¬å››è¡Œå‡ºç°äº†å†…å»ºå‡½æ•° <code>__builtin_return_address(LEVEL)</code> , è¿™ä¸ªå‡½æ•°ç”¨æ¥è¿”å›å½“å‰å‡½æ•°æˆ–è°ƒç”¨è€…çš„è¿”å›åœ°å€ã€‚å‡½æ•°çš„å‚æ•° LEVEL è¡¨ç¤ºå‡½æ•°è°ƒç”¨é“¾ä¸­çš„ä¸åŒå±‚æ¬¡çš„å‡½æ•°ï¼Œå„ä¸ªå€¼ä»£è¡¨çš„æ„ä¹‰å¦‚ä¸‹:</p>\n<ul>\n<li>0ï¼šè¿”å›å½“å‰å‡½æ•°çš„è¿”å›åœ°å€ï¼›</li>\n<li>1ï¼šè¿”å›å½“å‰å‡½æ•°è°ƒç”¨è€…çš„è¿”å›åœ°å€ï¼›</li>\n<li>2ï¼šè¿”å›å½“å‰å‡½æ•°è°ƒç”¨è€…çš„è°ƒç”¨è€…çš„è¿”å›åœ°å€ï¼›</li>\n</ul>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\libdl\\libdl.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>__weak__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> <span class=\"token function\">android_dlopen_ext</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> filename<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> flag<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> android_dlextinfo<span class=\"token operator\">*</span> extinfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> caller_addr <span class=\"token operator\">=</span> <span class=\"token function\">__builtin_return_address</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">__loader_android_dlopen_ext</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> flag<span class=\"token punctuation\">,</span> extinfo<span class=\"token punctuation\">,</span> caller_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"__loader_android_dlopen_ext\"><a class=\"anchor\" href=\"#__loader_android_dlopen_ext\">#</a> __loader_android_dlopen_ext</h2>\n<p><code>__loader_android_dlopen_ext</code>  è°ƒç”¨äº† <code>dlopen_ext</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\dlfcn.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> <span class=\"token function\">__loader_android_dlopen_ext</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> filename<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                           <span class=\"token keyword\">int</span> flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                           <span class=\"token keyword\">const</span> android_dlextinfo<span class=\"token operator\">*</span> extinfo<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                           <span class=\"token keyword\">const</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> caller_addr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">dlopen_ext</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">,</span> extinfo<span class=\"token punctuation\">,</span> caller_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"dlopen_ext\"><a class=\"anchor\" href=\"#dlopen_ext\">#</a> dlopen_ext</h2>\n<p><code>dlopen_ext</code>  ä¸­è°ƒç”¨äº† <code>do_dlopen</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\dlfcn.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> <span class=\"token function\">dlopen_ext</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> filename<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                        <span class=\"token keyword\">int</span> flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                        <span class=\"token keyword\">const</span> android_dlextinfo<span class=\"token operator\">*</span> extinfo<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                        <span class=\"token keyword\">const</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> caller_addr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  ScopedPthreadMutexLocker <span class=\"token function\">locker</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>g_dl_mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  g_linker_logger<span class=\"token punctuation\">.</span><span class=\"token function\">ResetState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> result <span class=\"token operator\">=</span> <span class=\"token function\">do_dlopen</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">,</span> extinfo<span class=\"token punctuation\">,</span> caller_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">__bionic_format_dlerror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dlopen failed\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">linker_get_error_buffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"do_dlopen\"><a class=\"anchor\" href=\"#do_dlopen\">#</a> do_dlopen</h2>\n<p>è¿™ä¸ªå‡½æ•°ä¸­æœ€ä¸ºå…³é”®çš„æ˜¯è°ƒç”¨ <code>find_library</code>  è·å–åˆ°äº†å¾…åŠ è½½ <code>so</code>  çš„ <code>soinfo</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> <span class=\"token function\">do_dlopen</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                <span class=\"token keyword\">const</span> android_dlextinfo<span class=\"token operator\">*</span> extinfo<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                <span class=\"token keyword\">const</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> caller_addr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  std<span class=\"token operator\">::</span>string trace_prefix <span class=\"token operator\">=</span> std<span class=\"token operator\">::</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dlopen: \"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>name <span class=\"token operator\">==</span> nullptr <span class=\"token operator\">?</span> <span class=\"token string\">\"(nullptr)\"</span> <span class=\"token operator\">:</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  ScopedTrace <span class=\"token function\">trace</span><span class=\"token punctuation\">(</span>trace_prefix<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ScopedTrace <span class=\"token function\">loading_trace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>trace_prefix <span class=\"token operator\">+</span> <span class=\"token string\">\" - loading and linking\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  soinfo<span class=\"token operator\">*</span> <span class=\"token keyword\">const</span> caller <span class=\"token operator\">=</span> <span class=\"token function\">find_containing_library</span><span class=\"token punctuation\">(</span>caller_addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token class-name\">android_namespace_t</span><span class=\"token operator\">*</span> ns <span class=\"token operator\">=</span> <span class=\"token function\">get_caller_namespace</span><span class=\"token punctuation\">(</span>caller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>         <span class=\"token string\">\"dlopen(name=\\\"%s\\\", flags=0x%x, extinfo=%s, caller=\\\"%s\\\", caller_ns=%s@%p, targetSdkVersion=%i) ...\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>         name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>         flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>         <span class=\"token function\">android_dlextinfo_to_string</span><span class=\"token punctuation\">(</span>extinfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>         caller <span class=\"token operator\">==</span> nullptr <span class=\"token operator\">?</span> <span class=\"token string\">\"(null)\"</span> <span class=\"token operator\">:</span> caller<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>         ns <span class=\"token operator\">==</span> nullptr <span class=\"token operator\">?</span> <span class=\"token string\">\"(null)\"</span> <span class=\"token operator\">:</span> ns<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>         ns<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>         <span class=\"token function\">get_application_target_sdk_version</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">auto</span> purge_guard <span class=\"token operator\">=</span> android<span class=\"token operator\">::</span>base<span class=\"token operator\">::</span><span class=\"token function\">make_scope_guard</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token function\">purge_unused_memory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">auto</span> failure_guard <span class=\"token operator\">=</span> android<span class=\"token operator\">::</span>base<span class=\"token operator\">::</span><span class=\"token function\">make_scope_guard</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span> <span class=\"token string\">\"... dlopen failed: %s\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">linker_get_error_buffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token comment\">// å¯¹ flags çš„åˆæ³•æ€§è¿›è¡Œåˆ¤æ–­</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>flags <span class=\"token operator\">&amp;</span> <span class=\"token operator\">~</span><span class=\"token punctuation\">(</span>RTLD_NOW<span class=\"token operator\">|</span>RTLD_LAZY<span class=\"token operator\">|</span>RTLD_LOCAL<span class=\"token operator\">|</span>RTLD_GLOBAL<span class=\"token operator\">|</span>RTLD_NODELETE<span class=\"token operator\">|</span>RTLD_NOLOAD<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token function\">DL_OPEN_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invalid flags to dlopen: %x\"</span><span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">return</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token comment\">// å¯¹ extinfo çš„åˆæ³•æ€§è¿›è¡Œåˆ¤æ–­</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>extinfo <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>flags <span class=\"token operator\">&amp;</span> <span class=\"token operator\">~</span><span class=\"token punctuation\">(</span>ANDROID_DLEXT_VALID_FLAG_BITS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token function\">DL_OPEN_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invalid extended flags to android_dlopen_ext: 0x%\"</span> PRIx64<span class=\"token punctuation\">,</span> extinfo<span class=\"token operator\">-></span>flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token keyword\">return</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>flags <span class=\"token operator\">&amp;</span> ANDROID_DLEXT_USE_LIBRARY_FD<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>flags <span class=\"token operator\">&amp;</span> ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token function\">DL_OPEN_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invalid extended flag combination (ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET without \"</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          <span class=\"token string\">\"ANDROID_DLEXT_USE_LIBRARY_FD): 0x%\"</span> PRIx64<span class=\"token punctuation\">,</span> extinfo<span class=\"token operator\">-></span>flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      <span class=\"token keyword\">return</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>flags <span class=\"token operator\">&amp;</span> ANDROID_DLEXT_USE_NAMESPACE<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>library_namespace <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token function\">DL_OPEN_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ANDROID_DLEXT_USE_NAMESPACE is set but extinfo->library_namespace is null\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token keyword\">return</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      ns <span class=\"token operator\">=</span> extinfo<span class=\"token operator\">-></span>library_namespace<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token comment\">// Workaround for dlopen(/system/lib/&lt;soname>) when .so is in /apex. http://b/121248172</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token comment\">// The workaround works only when targetSdkVersion &lt; Q.</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token comment\">// å½“ apk çš„ targetSdkVersion&lt;Q æ—¶æ‰ä¼šå°† /system è·¯å¾„è½¬æ¢æˆ /apex è·¯å¾„ (ä¸å¤ªæ¸…æ¥šè¿™æ ·åšçš„æ„ä¹‰æ˜¯ä»€ä¹ˆ)</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  std<span class=\"token operator\">::</span>string name_to_apex<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">translateSystemPathToApexPath</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>name_to_apex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> new_name <span class=\"token operator\">=</span> name_to_apex<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span> <span class=\"token string\">\"dlopen considering translation from %s to APEX path %s\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>           name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>           new_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token comment\">// Some APEXs could be optionally disabled. Only translate the path</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token comment\">// when the old file is absent and the new file exists.</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token comment\">// TODO(b/124218500): Re-enable it once app compat issue is resolved</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    if (file_exists(name)) &#123;</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      LD_LOG(kLogDlopen, \"dlopen %s exists, not translating\", name);</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    &#125; else</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    */</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">file_exists</span><span class=\"token punctuation\">(</span>new_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span> <span class=\"token string\">\"dlopen %s does not exist, not translating\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>             new_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>      <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span> <span class=\"token string\">\"dlopen translation accepted: using %s\"</span><span class=\"token punctuation\">,</span> new_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      name <span class=\"token operator\">=</span> new_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  <span class=\"token comment\">// End Workaround for dlopen(/system/lib/&lt;soname>) when .so is in /apex.</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  std<span class=\"token operator\">::</span>string asan_name_holder<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> translated_name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>g_is_asan <span class=\"token operator\">&amp;&amp;</span> translated_name <span class=\"token operator\">!=</span> nullptr <span class=\"token operator\">&amp;&amp;</span> translated_name<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token char\">'/'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token keyword\">char</span> original_path<span class=\"token punctuation\">[</span>PATH_MAX<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">realpath</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> original_path<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      asan_name_holder <span class=\"token operator\">=</span> std<span class=\"token operator\">::</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span>kAsanLibDirPrefix<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> original_path<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">file_exists</span><span class=\"token punctuation\">(</span>asan_name_holder<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        soinfo<span class=\"token operator\">*</span> si <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">find_loaded_library_by_realpath</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span> original_path<span class=\"token punctuation\">,</span> true<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          <span class=\"token function\">PRINT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"linker_asan dlopen NOT translating \\\"%s\\\" -> \\\"%s\\\": library already loaded\"</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                asan_name_holder<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          <span class=\"token function\">PRINT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"linker_asan dlopen translating \\\"%s\\\" -> \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> translated_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>          translated_name <span class=\"token operator\">=</span> asan_name_holder<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  ProtectedDataGuard guard<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  <span class=\"token comment\">// é‡å¤´æˆï¼Œè¿™é‡Œè°ƒç”¨äº† find_library è·å–åˆ°äº†è¿™ä¸ª so çš„ soinfo</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>  soinfo<span class=\"token operator\">*</span> si <span class=\"token operator\">=</span> <span class=\"token function\">find_library</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span> translated_name<span class=\"token punctuation\">,</span> flags<span class=\"token punctuation\">,</span> extinfo<span class=\"token punctuation\">,</span> caller<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  loading_trace<span class=\"token punctuation\">.</span><span class=\"token function\">End</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>si <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> handle <span class=\"token operator\">=</span> si<span class=\"token operator\">-></span><span class=\"token function\">to_handle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>           <span class=\"token string\">\"... dlopen calling constructors: realpath=\\\"%s\\\", soname=\\\"%s\\\", handle=%p\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>           si<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> si<span class=\"token operator\">-></span><span class=\"token function\">get_soname</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token comment\">// è°ƒç”¨ call_constructors å‡½æ•°æ¥åŠ è½½ so ä¸­çš„ init ä»¥åŠ init_array</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    si<span class=\"token operator\">-></span><span class=\"token function\">call_constructors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>    failure_guard<span class=\"token punctuation\">.</span><span class=\"token function\">Disable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>           <span class=\"token string\">\"... dlopen successful: realpath=\\\"%s\\\", soname=\\\"%s\\\", handle=%p\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>           si<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> si<span class=\"token operator\">-></span><span class=\"token function\">get_soname</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>    <span class=\"token keyword\">return</span> handle<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  <span class=\"token keyword\">return</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"soinfo\"><a class=\"anchor\" href=\"#soinfo\">#</a> soinfo</h3>\n<p><code>soinfo</code>  ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥ç”¨åœ¨ frida æˆ–è€… ida ä¸­</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//IMPORTANT</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">//ELF64 å¯ç”¨è¯¥å®</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">__LP64__</span>  <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">//ELF32 å¯ç”¨è¯¥å®</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">//#define __work_around_b_24465209__  1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>//https://android.googlesource.com/platform/bionic/+/master/linker/Android.bp</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>æ¶æ„ä¸º 32 ä½ å®šä¹‰__work_around_b_24465209__å®</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>arch: &#123;</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        arm: &#123;cflags: [\"-D__work_around_b_24465209__\"],&#125;,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        x86: &#123;cflags: [\"-D__work_around_b_24465209__\"],&#125;,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    &#125;</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>*/</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\libc\\include\\link.h</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__LP64__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">ElfW</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span> Elf64_ </span><span class=\"token punctuation\">##</span> <span class=\"token expression\">type</span></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">ElfW</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span> Elf32_ </span><span class=\"token punctuation\">##</span> <span class=\"token expression\">type</span></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_common_types.h</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// Android uses RELA for LP64.</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__LP64__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">USE_RELA</span> <span class=\"token expression\"><span class=\"token number\">1</span></span></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\libc\\kernel\\uapi\\asm-generic\\int-ll64.h</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">//__signed__-->signed</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">signed</span> <span class=\"token keyword\">char</span> __s8<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span> __u8<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">signed</span> <span class=\"token keyword\">short</span> __s16<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">short</span> __u16<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">signed</span> <span class=\"token keyword\">int</span> __s32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> __u32<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">signed</span> <span class=\"token keyword\">long</span> <span class=\"token keyword\">long</span> __s64<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> <span class=\"token keyword\">long</span> __u64<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\">//A12-src\\msm-google\\include\\uapi\\linux\\elf.h</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">/* 32-bit ELF base types. */</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token keyword\">typedef</span> __u32\tElf32_Addr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token keyword\">typedef</span> __u16\tElf32_Half<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token keyword\">typedef</span> __u32\tElf32_Off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">typedef</span> __s32\tElf32_Sword<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token keyword\">typedef</span> __u32\tElf32_Word<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\">/* 64-bit ELF base types. */</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token keyword\">typedef</span> __u64\tElf64_Addr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token keyword\">typedef</span> __u16\tElf64_Half<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token keyword\">typedef</span> __s16\tElf64_SHalf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token keyword\">typedef</span> __u64\tElf64_Off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token keyword\">typedef</span> __s32\tElf64_Sword<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token keyword\">typedef</span> __u32\tElf64_Word<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">typedef</span> __u64\tElf64_Xword<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token keyword\">typedef</span> __s64\tElf64_Sxword<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">dynamic</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  Elf32_Sword d_tag<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token keyword\">union</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    Elf32_Sword\td_val<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    Elf32_Addr\td_ptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> d_un<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Dyn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  Elf64_Sxword d_tag<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* entry tag value */</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token keyword\">union</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    Elf64_Xword d_val<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    Elf64_Addr d_ptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> d_un<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf64_Dyn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf32_rel</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  Elf32_Addr\tr_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  Elf32_Word\tr_info<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Rel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf64_rel</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  Elf64_Addr r_offset<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Location at which to apply the action */</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  Elf64_Xword r_info<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* index and type of relocation */</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf64_Rel<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf32_rela</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  Elf32_Addr\tr_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  Elf32_Word\tr_info<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  Elf32_Sword\tr_addend<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Rela<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf64_rela</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  Elf64_Addr r_offset<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Location at which to apply the action */</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  Elf64_Xword r_info<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* index and type of relocation */</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  Elf64_Sxword r_addend<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Constant addend used to compute value */</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf64_Rela<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf32_sym</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  Elf32_Word\tst_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  Elf32_Addr\tst_value<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  Elf32_Word\tst_size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span>\tst_info<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span>\tst_other<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  Elf32_Half\tst_shndx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Sym<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf64_sym</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  Elf64_Word st_name<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Symbol name, index in string tbl */</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span>\tst_info<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Type and binding attributes */</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span>\tst_other<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* No defined meaning, 0 */</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  Elf64_Half st_shndx<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Associated section index */</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  Elf64_Addr st_value<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Value of the symbol */</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  Elf64_Xword st_size<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Associated symbol size */</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf64_Sym<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre></pre></td></tr><tr><td data-num=\"115\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">EI_NIDENT</span>\t<span class=\"token expression\"><span class=\"token number\">16</span></span></span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre></pre></td></tr><tr><td data-num=\"117\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf32_hdr</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span>\te_ident<span class=\"token punctuation\">[</span>EI_NIDENT<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  Elf32_Half\te_type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  Elf32_Half\te_machine<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  Elf32_Word\te_version<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>  Elf32_Addr\te_entry<span class=\"token punctuation\">;</span>  <span class=\"token comment\">/* Entry point */</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  Elf32_Off\te_phoff<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>  Elf32_Off\te_shoff<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  Elf32_Word\te_flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  Elf32_Half\te_ehsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  Elf32_Half\te_phentsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>  Elf32_Half\te_phnum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  Elf32_Half\te_shentsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>  Elf32_Half\te_shnum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>  Elf32_Half\te_shstrndx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Ehdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre></pre></td></tr><tr><td data-num=\"134\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf64_hdr</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>  <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">char</span>\te_ident<span class=\"token punctuation\">[</span>EI_NIDENT<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* ELF \"magic number\" */</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>  Elf64_Half e_type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>  Elf64_Half e_machine<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>  Elf64_Word e_version<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>  Elf64_Addr e_entry<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Entry point virtual address */</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>  Elf64_Off e_phoff<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Program header table file offset */</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>  Elf64_Off e_shoff<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section header table file offset */</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>  Elf64_Word e_flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>  Elf64_Half e_ehsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>  Elf64_Half e_phentsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>  Elf64_Half e_phnum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>  Elf64_Half e_shentsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>  Elf64_Half e_shnum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>  Elf64_Half e_shstrndx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf64_Ehdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre></pre></td></tr><tr><td data-num=\"151\"></td><td><pre><span class=\"token comment\">/* These constants define the permissions on sections in the program</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>   header, p_flags. */</pre></td></tr><tr><td data-num=\"153\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PF_R</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x4</span></span></span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PF_W</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x2</span></span></span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PF_X</span>\t\t<span class=\"token expression\"><span class=\"token number\">0x1</span></span></span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre></pre></td></tr><tr><td data-num=\"157\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf32_phdr</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>  Elf32_Word\tp_type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>  Elf32_Off\tp_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>  Elf32_Addr\tp_vaddr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>  Elf32_Addr\tp_paddr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>  Elf32_Word\tp_filesz<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>  Elf32_Word\tp_memsz<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>  Elf32_Word\tp_flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>  Elf32_Word\tp_align<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Phdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre></pre></td></tr><tr><td data-num=\"168\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf64_phdr</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>  Elf64_Word p_type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>  Elf64_Word p_flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>  Elf64_Off p_offset<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment file offset */</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>  Elf64_Addr p_vaddr<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment virtual address */</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>  Elf64_Addr p_paddr<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment physical address */</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>  Elf64_Xword p_filesz<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment size in file */</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>  Elf64_Xword p_memsz<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment size in memory */</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>  Elf64_Xword p_align<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Segment alignment, file &amp; memory */</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf64_Phdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre></pre></td></tr><tr><td data-num=\"179\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf32_shdr</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>  Elf32_Word\tsh_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>  Elf32_Word\tsh_type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>  Elf32_Word\tsh_flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>  Elf32_Addr\tsh_addr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>  Elf32_Off\tsh_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>  Elf32_Word\tsh_size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>  Elf32_Word\tsh_link<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>  Elf32_Word\tsh_info<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>  Elf32_Word\tsh_addralign<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>  Elf32_Word\tsh_entsize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf32_Shdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre></pre></td></tr><tr><td data-num=\"192\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">elf64_shdr</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>  Elf64_Word sh_name<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section name, index in string tbl */</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>  Elf64_Word sh_type<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Type of section */</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>  Elf64_Xword sh_flags<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Miscellaneous section attributes */</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>  Elf64_Addr sh_addr<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section virtual addr at execution */</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>  Elf64_Off sh_offset<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Section file offset */</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>  Elf64_Xword sh_size<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Size of section in bytes */</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>  Elf64_Word sh_link<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Index of another section */</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>  Elf64_Word sh_info<span class=\"token punctuation\">;</span>\t\t<span class=\"token comment\">/* Additional section information */</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>  Elf64_Xword sh_addralign<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Section alignment */</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>  Elf64_Xword sh_entsize<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* Entry size if section holds table */</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre><span class=\"token punctuation\">&#125;</span> Elf64_Shdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre></pre></td></tr><tr><td data-num=\"205\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> <span class=\"token class-name\">uintptr_t</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">link_map</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>    <span class=\"token class-name\">uintptr_t</span> l_addr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>    <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span> l_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>    <span class=\"token class-name\">uintptr_t</span> l_ld<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">link_map</span> <span class=\"token operator\">*</span> l_next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">link_map</span> <span class=\"token operator\">*</span> l_prev<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre></pre></td></tr><tr><td data-num=\"215\"></td><td><pre></pre></td></tr><tr><td data-num=\"216\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_soinfo.h</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token class-name\">linker_dtor_function_t</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token class-name\">linker_ctor_function_t</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre></pre></td></tr><tr><td data-num=\"220\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__work_around_b_24465209__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SOINFO_NAME_LEN</span> <span class=\"token expression\"><span class=\"token number\">128</span></span></span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre></pre></td></tr><tr><td data-num=\"224\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">soinfo</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__work_around_b_24465209__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>  <span class=\"token keyword\">char</span> old_name_<span class=\"token punctuation\">[</span>SOINFO_NAME_LEN<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Phdr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> phdr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>  <span class=\"token class-name\">size_t</span> phnum<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__work_around_b_24465209__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> unused0<span class=\"token punctuation\">;</span> <span class=\"token comment\">// DO NOT USE, maintained for compatibility.</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> base<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>  <span class=\"token class-name\">size_t</span> size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre></pre></td></tr><tr><td data-num=\"236\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__work_around_b_24465209__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>  <span class=\"token class-name\">uint32_t</span> unused1<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// DO NOT USE, maintained for compatibility.</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Dyn<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> dynamic<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre></pre></td></tr><tr><td data-num=\"242\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__work_around_b_24465209__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>  <span class=\"token class-name\">uint32_t</span> unused2<span class=\"token punctuation\">;</span> <span class=\"token comment\">// DO NOT USE, maintained for compatibility</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>  <span class=\"token class-name\">uint32_t</span> unused3<span class=\"token punctuation\">;</span> <span class=\"token comment\">// DO NOT USE, maintained for compatibility</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>  soinfo<span class=\"token operator\">*</span> next<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>  <span class=\"token class-name\">uint32_t</span> flags_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> strtab_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Sym<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> symtab_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>  <span class=\"token class-name\">size_t</span> nbucket_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>  <span class=\"token class-name\">size_t</span> nchain_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre>  <span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span> bucket_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>  <span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span> chain_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre></pre></td></tr><tr><td data-num=\"258\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token operator\">!</span><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__LP64__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> unused4<span class=\"token punctuation\">;</span> <span class=\"token comment\">// DO NOT USE, maintained for compatibility</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre></pre></td></tr><tr><td data-num=\"262\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>USE_RELA<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rela<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> plt_rela_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>  <span class=\"token class-name\">size_t</span> plt_rela_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rela<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> rela_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>  <span class=\"token class-name\">size_t</span> rela_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rel<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> plt_rel_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>  <span class=\"token class-name\">size_t</span> plt_rel_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rel<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> rel_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>  <span class=\"token class-name\">size_t</span> rel_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"275\"></td><td><pre></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>  <span class=\"token class-name\">linker_ctor_function_t</span><span class=\"token operator\">*</span> preinit_array_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>  <span class=\"token class-name\">size_t</span> preinit_array_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre></pre></td></tr><tr><td data-num=\"279\"></td><td><pre>  <span class=\"token class-name\">linker_ctor_function_t</span><span class=\"token operator\">*</span> init_array_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>  <span class=\"token class-name\">size_t</span> init_array_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>  <span class=\"token class-name\">linker_dtor_function_t</span><span class=\"token operator\">*</span> fini_array_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>  <span class=\"token class-name\">size_t</span> fini_array_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre></pre></td></tr><tr><td data-num=\"284\"></td><td><pre>  <span class=\"token class-name\">linker_ctor_function_t</span> init_func_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre>  <span class=\"token class-name\">linker_dtor_function_t</span> fini_func_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"286\"></td><td><pre></pre></td></tr><tr><td data-num=\"287\"></td><td><pre></pre></td></tr><tr><td data-num=\"288\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__arm__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>  <span class=\"token comment\">// ARM EABI section used for stack unwinding.</span></pre></td></tr><tr><td data-num=\"290\"></td><td><pre>  <span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span> ARM_exidx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"291\"></td><td><pre>  <span class=\"token class-name\">size_t</span> ARM_exidx_count<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"293\"></td><td><pre>  <span class=\"token class-name\">size_t</span> ref_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre></pre></td></tr><tr><td data-num=\"295\"></td><td><pre>  link_map link_map_head<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"296\"></td><td><pre></pre></td></tr><tr><td data-num=\"297\"></td><td><pre>  bool constructors_called<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>  <span class=\"token comment\">// When you read a virtual address from the ELF file, add this</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre>  <span class=\"token comment\">// value to get the corresponding address in the process' address space.</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> load_bias<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre></pre></td></tr><tr><td data-num=\"303\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token operator\">!</span><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__LP64__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre>  bool has_text_relocations<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"305\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre>  bool has_DT_SYMBOLIC<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"307\"></td><td><pre></pre></td></tr><tr><td data-num=\"308\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"call_constructors\"><a class=\"anchor\" href=\"#call_constructors\">#</a> call_constructors</h3>\n<p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ä¼šå…ˆåŠ è½½ <code>init</code> , åœ¨ so ä¸­çš„å‡½æ•°åä¸€èˆ¬ä¸º <code>init_proc</code> , ç„¶ååŠ è½½ <code>init_array</code>  ä¸­çš„å‡½æ•°</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\bionic\\linker\\linker_soinfo.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> soinfo<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">call_constructors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>constructors_called <span class=\"token operator\">||</span> g_is_ldd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// We set constructors_called before actually calling the constructors, otherwise it doesn't</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// protect against recursive constructor calls. One simple example of constructor recursion</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// is the libc debug malloc, which is implemented in libc_malloc_debug_leak.so:</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// 1. The program depends on libc, so libc's constructor is called here.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// 2. The libc constructor calls dlopen() to load libc_malloc_debug_leak.so.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// 3. dlopen() calls the constructors on the newly created</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">//    soinfo for libc_malloc_debug_leak.so.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// 4. The debug .so depends on libc, so CallConstructors is</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">//    called again with the libc soinfo. If it doesn't trigger the early-</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">//    out above, the libc constructor will be called again (recursively!).</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  constructors_called <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token comment\">// åœ¨å…±äº«é“¾æ¥åº“ä¸­ä¼šå¿½ç•¥ DT_PREINIT_ARRAY</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">is_main_executable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> preinit_array_ <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">// The GNU dynamic linker silently ignores these, but we warn the developer.</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token function\">PRINT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\": ignoring DT_PREINIT_ARRAY in shared library!\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token function\">get_children</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">for_each</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>soinfo<span class=\"token operator\">*</span> si<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    si<span class=\"token operator\">-></span><span class=\"token function\">call_constructors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">is_linker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token function\">bionic_trace_begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"calling constructors: \"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token comment\">// DT_INIT should be called before DT_INIT_ARRAY if both are present.</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token comment\">// é¦–å…ˆåŠ è½½ init, åœ¨ so ä¸­çš„å‡½æ•°åä¸€èˆ¬ä¸º init_proc, ç„¶ååŠ è½½ init_array ä¸­çš„å‡½æ•°</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token function\">call_function</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DT_INIT\"</span><span class=\"token punctuation\">,</span> init_func_<span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token function\">call_array</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DT_INIT_ARRAY\"</span><span class=\"token punctuation\">,</span> init_array_<span class=\"token punctuation\">,</span> init_array_count_<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">is_linker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token function\">bionic_trace_end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨å…±äº«é“¾æ¥åº“ä¸­ <code>pre_initarray</code>  ä¼šè¢«å¿½ç•¥æ‰ï¼Œå®ƒåœ¨ <code>call_pre_init_constructors</code>  ä¸­ï¼Œä½†å‡å¦‚ä½ ç”¨ <code>ndk-build</code>  ç¼–è¯‘ä¸€ä¸ªå¯ä»¥åœ¨ android ä¸Šæ‰§è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªé¢„åˆå§‹åŒ–å‡½æ•°å°±ä¸ä¼šè¢«å¿½ç•¥å•¦</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\bionic\\linker\\linker_soinfo.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> soinfo<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">call_pre_init_constructors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>g_is_ldd<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// DT_PREINIT_ARRAY functions are called before any other constructors for executables,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// but ignored in a shared library.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">call_array</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DT_PREINIT_ARRAY\"</span><span class=\"token punctuation\">,</span> preinit_array_<span class=\"token punctuation\">,</span> preinit_array_count_<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"find_library\"><a class=\"anchor\" href=\"#find_library\">#</a> find_library</h2>\n<p>æ¥ä¸‹æ¥åœ¨ <code>find_library</code>  ä¸­è°ƒç”¨äº† <code>find_libraries</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> soinfo<span class=\"token operator\">*</span> <span class=\"token function\">find_library</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">android_namespace_t</span><span class=\"token operator\">*</span> ns<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                            <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> rtld_flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                            <span class=\"token keyword\">const</span> android_dlextinfo<span class=\"token operator\">*</span> extinfo<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                            soinfo<span class=\"token operator\">*</span> needed_by<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  soinfo<span class=\"token operator\">*</span> si <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// å¦‚æœ name æ˜¯ç©ºçš„ï¼Œåˆ™ä¸º si èµ‹å€¼ä¸º somain</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">//somain: main process, always the one after libdl_info</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    si <span class=\"token operator\">=</span> <span class=\"token function\">solist_get_somain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// è¿™ä¸ªå‡½æ•°å°†ä¼šè¿”å› somain;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">find_libraries</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                             needed_by<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                             <span class=\"token operator\">&amp;</span>name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                             <span class=\"token number\">1</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                             <span class=\"token operator\">&amp;</span>si<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                             nullptr<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                             <span class=\"token number\">0</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                             rtld_flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                             extinfo<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                             false <span class=\"token comment\">/* add_as_children */</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>si <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token function\">soinfo_unload</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">return</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token comment\">// åŠ è½½ so æˆåŠŸï¼Œso çš„å¼•ç”¨æ¬¡æ•° + 1, å¯¹åº”äº† JavaVMExt::LoadNativeLibrary ä¸­</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token comment\">//so åŠ è½½æ—¶ è¿™ä¸€éƒ¨åˆ†çš„æ³¨é‡Šâ†“</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  Below we dlopen but there is no paired dlclose, this would be necessary if we supported</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  class unloading. Libraries will only be unloaded when the reference count (incremented by</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  dlopen) becomes zero from dlclose.</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  */</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  si<span class=\"token operator\">-></span><span class=\"token function\">increment_ref_count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token keyword\">return</span> si<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"find_libraries\"><a class=\"anchor\" href=\"#find_libraries\">#</a> find_libraries</h2>\n<p>åˆ†æäº†è¿™ä¹ˆä¹…ç­‰çš„å°±æ˜¯è¿™ä¸ªå‡½æ•°ï¼</p>\n<p>å‡½æ•°å£°æ˜:</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    ns                                åŠ è½½çš„å‘½åç©ºé—´ = è°ƒç”¨è€…çš„å‘½åç©ºé—´</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    start_with                        è°ƒç”¨è€…çš„ soinfo</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    library_names                     æ‰€æœ‰åŠ è½½åº“åç§°</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    library_names_count               åŠ è½½åº“æ•°é‡</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    soinfos                           ä¿å­˜åŠ è½½å®Œæˆçš„ soinfo</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    ld_preloads                       ä¿å­˜é¢„åŠ è½½åº“ï¼Œæ²¡æœ‰å¯ä»¥ä¸º null</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    ld_preloads_count                 é¢„åŠ è½½åº“æ•°é‡</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    extinfo                           Android è°ƒç”¨é™„å¸¦</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    add_as_children                   æ˜¯å¦ä½œä¸º start_with çš„å­åº“</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    search_linked_namespaces          æŸ¥è¯¢é“¾æ¥å‘½åç©ºé—´</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    namespaces                        é“¾æ¥å‘½åç©ºé—´</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>*/</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>bool <span class=\"token function\">find_libraries</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">android_namespace_t</span><span class=\"token operator\">*</span> ns<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                    soinfo<span class=\"token operator\">*</span> start_with<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> <span class=\"token keyword\">const</span> library_names<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                    <span class=\"token class-name\">size_t</span> library_names_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                    soinfo<span class=\"token operator\">*</span> soinfos<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                    std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>soinfo<span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token operator\">*</span> ld_preloads<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                    <span class=\"token class-name\">size_t</span> ld_preloads_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    <span class=\"token keyword\">int</span> rtld_flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                    <span class=\"token keyword\">const</span> android_dlextinfo<span class=\"token operator\">*</span> extinfo<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                    bool add_as_children<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                    std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token class-name\">android_namespace_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token operator\">*</span> namespaces<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å¯ä»¥åˆ†ä¸ºä¸ƒä¸ªéƒ¨åˆ†è¿›è¡Œåˆ†æ</p>\n<h3 id=\"å‡†å¤‡é˜¶æ®µ\"><a class=\"anchor\" href=\"#å‡†å¤‡é˜¶æ®µ\">#</a> å‡†å¤‡é˜¶æ®µ</h3>\n<p>è¿™ä¸€éƒ¨åˆ†å°†å¾…åŠ è½½çš„ so æ·»åŠ åˆ° <code>LoadTaskList</code>  åŠ è½½ä»»åŠ¡é˜Ÿåˆ—ä¸­</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Step 0: prepare.</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>std<span class=\"token operator\">::</span>unordered_map<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> soinfo<span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> ElfReader<span class=\"token operator\">></span> readers_map<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>LoadTaskList load_tasks<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// å¯ä»¥åŒæ—¶åŠ è½½å¤šä¸ª so, ä½†ä» find_library ä¼ å…¥çš„å‚æ•°çœ‹æ¥ï¼Œlibrary_names_count</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// çš„å€¼ä¸º 1, ä¹Ÿå°±æ˜¯è¯´ä»…åŠ è½½ä¸€ä¸ªç›®æ ‡ path çš„ so</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> library_names_count<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name <span class=\"token operator\">=</span> library_names<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// å°†è¿™ä¸ª so push åˆ° load_tasks çš„ä»»åŠ¡ä¸­</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    load_tasks<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>LoadTask<span class=\"token operator\">::</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> start_with<span class=\"token punctuation\">,</span> ns<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>readers_map<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// If soinfos array is null allocate one on stack.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// The array is needed in case of failure; for example</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// when library_names[] = &#123;libone.so, libtwo.so&#125; and libone.so</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">// is loaded correctly but libtwo.so failed for some reason.</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// In this case libone.so should be unloaded on return.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">// See also implementation of failure_guard below.</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">// ä¸º soinfos åˆ†é…ç©ºé—´</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>soinfos <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token class-name\">size_t</span> soinfos_size <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>soinfo<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span>library_names_count<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    soinfos <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span>soinfo<span class=\"token operator\">*</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token function\">alloca</span><span class=\"token punctuation\">(</span>soinfos_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>soinfos<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> soinfos_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">// list of libraries to link - see step 2.</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token class-name\">size_t</span> soinfos_count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">auto</span> scope_guard <span class=\"token operator\">=</span> android<span class=\"token operator\">::</span>base<span class=\"token operator\">::</span><span class=\"token function\">make_scope_guard</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>LoadTask<span class=\"token operator\">*</span> t <span class=\"token operator\">:</span> load_tasks<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        LoadTask<span class=\"token operator\">::</span><span class=\"token function\">deleter</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>ZipArchiveCache zip_archive_cache<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token class-name\">soinfo_list_t</span> new_global_group_members<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"å¯»æ‰¾ä¾èµ–åº“æ·»åŠ åˆ°å¾…åŠ è½½é˜Ÿåˆ—\"><a class=\"anchor\" href=\"#å¯»æ‰¾ä¾èµ–åº“æ·»åŠ åˆ°å¾…åŠ è½½é˜Ÿåˆ—\">#</a> å¯»æ‰¾ä¾èµ–åº“ï¼Œæ·»åŠ åˆ°å¾…åŠ è½½é˜Ÿåˆ—</h3>\n<p>å°†å¾…åŠ è½½çš„ so çš„ä¾èµ–åº“æ·»åŠ åˆ° <code>load_tasks</code>  é˜Ÿåˆ—ä¸­ï¼Œæ­¤æ—¶å¹¶ä¸ä¼šåŠ è½½ä¾èµ–åº“</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Step 1: expand the list of load_tasks to include</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// all DT_NEEDED libraries (do not load them just yet)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span>load_tasks<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    LoadTask<span class=\"token operator\">*</span> task <span class=\"token operator\">=</span> load_tasks<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    soinfo<span class=\"token operator\">*</span> needed_by <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_needed_by</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    bool is_dt_needed <span class=\"token operator\">=</span> needed_by <span class=\"token operator\">!=</span> nullptr <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>needed_by <span class=\"token operator\">!=</span> start_with <span class=\"token operator\">||</span> add_as_children<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    task<span class=\"token operator\">-></span><span class=\"token function\">set_extinfo</span><span class=\"token punctuation\">(</span>is_dt_needed <span class=\"token operator\">?</span> nullptr <span class=\"token operator\">:</span> extinfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    task<span class=\"token operator\">-></span><span class=\"token function\">set_dt_needed</span><span class=\"token punctuation\">(</span>is_dt_needed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span> <span class=\"token string\">\"find_libraries(ns=%s): task=%s, is_dt_needed=%d\"</span><span class=\"token punctuation\">,</span> ns<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>           task<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> is_dt_needed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// Note: start from the namespace that is stored in the LoadTask. This namespace</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">// is different from the current namespace when the LoadTask is for a transitive</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// dependency and the lib that created the LoadTask is not found in the</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// current namespace but in one of the linked namespace.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">find_library_internal</span><span class=\"token punctuation\">(</span>const_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">android_namespace_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>task<span class=\"token operator\">-></span><span class=\"token function\">get_start_from</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                               task<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                               <span class=\"token operator\">&amp;</span>zip_archive_cache<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                               <span class=\"token operator\">&amp;</span>load_tasks<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                               rtld_flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    soinfo<span class=\"token operator\">*</span> si <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_soinfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>is_dt_needed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        needed_by<span class=\"token operator\">-></span><span class=\"token function\">add_child</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\">// When ld_preloads is not null, the first</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token comment\">// ld_preloads_count libs are in fact ld_preloads.</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    bool is_ld_preload <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ld_preloads <span class=\"token operator\">!=</span> nullptr <span class=\"token operator\">&amp;&amp;</span> soinfos_count <span class=\"token operator\">&lt;</span> ld_preloads_count<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        ld_preloads<span class=\"token operator\">-></span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        is_ld_preload <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>soinfos_count <span class=\"token operator\">&lt;</span> library_names_count<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        soinfos<span class=\"token punctuation\">[</span>soinfos_count<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> si<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token comment\">// Add the new global group members to all initial namespaces. Do this secondary namespace setup</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token comment\">// at the same time that libraries are added to their primary namespace so that the order of</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">// global group members is the same in the every namespace. Only add a library to a namespace</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token comment\">// once, even if it appears multiple times in the dependency graph.</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>is_ld_preload <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>si<span class=\"token operator\">-></span><span class=\"token function\">get_dt_flags_1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> DF_1_GLOBAL<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>si<span class=\"token operator\">-></span><span class=\"token function\">is_linked</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> namespaces <span class=\"token operator\">!=</span> nullptr <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>new_global_group_members<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            new_global_group_members<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span> linked_ns <span class=\"token operator\">:</span> <span class=\"token operator\">*</span>namespaces<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>si<span class=\"token operator\">-></span><span class=\"token function\">get_primary_namespace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> linked_ns<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                    linked_ns<span class=\"token operator\">-></span><span class=\"token function\">add_soinfo</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                    si<span class=\"token operator\">-></span><span class=\"token function\">add_secondary_namespace</span><span class=\"token punctuation\">(</span>linked_ns<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥è¦åšçš„æ˜¯è°ƒç”¨ <code>find_library_internal</code>  è·å–åˆ°è¿™ä¸ª so çš„ä¾èµ–åº“ï¼Œé‚£ä¹ˆä»€ä¹ˆæ˜¯ so çš„ä¾èµ–åº“å‘¢ï¼Ÿæˆ‘ä»¬æ‹¿ ida éšä¾¿åç¼–è¯‘ä¸€ä¸ª so, <code>Needed Library</code>  å¼€å¤´çš„å°±æ˜¯è¿™ä¸€ä¸ª so çš„æ‰€æœ‰ä¾èµ–åº“</p>\n<p><img data-src=\"/android-load-so/image-20240216214503902.png\" alt=\"image-20240216214503902\" style=\"aspect-ratio:587 / 188;\"></p>\n<h4 id=\"find_library_internal\"><a class=\"anchor\" href=\"#find_library_internal\">#</a> find_library_internal</h4>\n<p>è¿™é‡Œåšäº†å››æ¬¡å¯¹äºå¾…åŠ è½½ so çš„ä¾èµ–åº“çš„å¯»æ‰¾</p>\n<ol>\n<li>è°ƒç”¨ <code>find_loaded_library_by_soname</code>  è¿™ä¸ªåº“æœ‰æ²¡æœ‰è¢«åŠ è½½è¿‡äº†ï¼ŸåŠ è½½è¿‡é‚£ä¹ˆæˆ‘æ‰¾éƒ½ä¸ç”¨æ‰¾äº†ç›´æ¥è¿”å›å¯»æ‰¾ç»“æœ</li>\n<li>æ­£å¸¸ä½¿ç”¨ <code>load_library</code>  æ‰¾ä¾èµ–åº“</li>\n<li>æ­£å¸¸å¯»æ‰¾æ‰¾ä¸åˆ°ï¼Œé‚£è¿™ä¸ªåº“æ˜¯ä¸æ˜¯å·²ç»é¢„ç½®åœ¨ç³»ç»Ÿåº“é‡Œé¢äº†ï¼Ÿè¯•è¯•åˆ°å…¨å±€å‘½åç©ºé—´ <code>g_default_namespace</code>  é‡Œé¢æ‰¾æ‰¾</li>\n<li>å‰ä¸‰ç§æ–¹å¼éƒ½å¤±è´¥äº†ï¼Ÿå¯åŠ¨ç»ˆæè§£å†³æ–¹æ¡ˆï¼Œåˆ°å…±äº«å‘½åç©ºé—´ <code>linked namespace</code>  æ‰¾è¿™ä¸ª so çš„ä¾èµ–åº“ï¼Œè¿˜æ²¡æ‰¾åˆ°é‚£å°±æ˜¯çœŸçš„æ‰¾ä¸åˆ°äº†</li>\n</ol>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> bool <span class=\"token function\">find_library_internal</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">android_namespace_t</span><span class=\"token operator\">*</span> ns<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                  LoadTask<span class=\"token operator\">*</span> task<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                  ZipArchiveCache<span class=\"token operator\">*</span> zip_archive_cache<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                                  LoadTaskList<span class=\"token operator\">*</span> load_tasks<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                  <span class=\"token keyword\">int</span> rtld_flags<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  soinfo<span class=\"token operator\">*</span> candidate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// å¦‚æœè¿™ä¸ª so å·²ç»è¢«åŠ è½½è¿‡äº†ï¼Œå°±ç›´æ¥ç»™ task è®¾ç½®å®Œ soinfo åè¿”å›</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">find_loaded_library_by_soname</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> true <span class=\"token comment\">/* search_linked_namespaces */</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                                    <span class=\"token operator\">&amp;</span>candidate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>           <span class=\"token string\">\"find_library_internal(ns=%s, task=%s): Already loaded (by soname): %s\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>           ns<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> candidate<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    task<span class=\"token operator\">-></span><span class=\"token function\">set_soinfo</span><span class=\"token punctuation\">(</span>candidate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\">// Library might still be loaded, the accurate detection</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token comment\">// of this fact is done by load_library.</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token function\">TRACE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[ \\\"%s\\\" find_loaded_library_by_soname failed (*candidate=%s@%p). Trying harder... ]\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        task<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> candidate <span class=\"token operator\">==</span> nullptr <span class=\"token operator\">?</span> <span class=\"token string\">\"n/a\"</span> <span class=\"token operator\">:</span> candidate<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> candidate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">// å…³é”®å‡½æ•°ï¼Œç”¨æ¥å¯»æ‰¾ä¾èµ–åº“</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">load_library</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">,</span> zip_archive_cache<span class=\"token punctuation\">,</span> load_tasks<span class=\"token punctuation\">,</span> rtld_flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                   true <span class=\"token comment\">/* search_linked_namespaces */</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token comment\">// TODO(dimitry): workaround for http://b/26394120 (the exempt-list)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token comment\">//exempt lib, å³å·²ç»é¢„ç½®åœ¨ç³»ç»Ÿåº“ä¸­çš„ so, ä¾‹å¦‚ libcrypto.so,libssl.so</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token comment\">// ç­‰ç­‰æ¯”è¾ƒè‘—åçš„åº“ï¼Œå‡å¦‚å‘ç°æ˜¯è¿™äº›åº“çš„è¯ï¼Œç”¨é»˜è®¤å‘½åç©ºé—´è·å– soinfo</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ns<span class=\"token operator\">-></span><span class=\"token function\">is_exempt_list_enabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">is_exempt_lib</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_needed_by</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token comment\">// For the libs in the exempt-list, switch to the default namespace and then</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\">// try the load again from there. The library could be loaded from the</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">// default namespace or from another namespace (e.g. runtime) that is linked</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\">// from the default namespace.</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>           <span class=\"token string\">\"find_library_internal(ns=%s, task=%s): Exempt system library - trying namespace %s\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>           ns<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> g_default_namespace<span class=\"token punctuation\">.</span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    ns <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>g_default_namespace<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">load_library</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">,</span> zip_archive_cache<span class=\"token punctuation\">,</span> load_tasks<span class=\"token punctuation\">,</span> rtld_flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                     true <span class=\"token comment\">/* search_linked_namespaces */</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token comment\">// END OF WORKAROUND</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token comment\">// if a library was not found - look into linked namespaces</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token comment\">// preserve current dlerror in the case it fails.</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token comment\">// å‡å¦‚æ‰¾éäº†è‡ªå·±çš„å‘½åç©ºé—´è¿˜æ˜¯æ²¡æ‰¾åˆ°è¿™ä¸ª so çš„ä¾èµ–åº“çš„è¯ï¼Œå°±å»å…±äº«å‘½åç©ºé—´ (linked namespace)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token comment\">// é‡Œé¢å»æ‰¾æ‰¾çœ‹</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  DlErrorRestorer dlerror_restorer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span> <span class=\"token string\">\"find_library_internal(ns=%s, task=%s): Trying %zu linked namespaces\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>         ns<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> ns<span class=\"token operator\">-></span><span class=\"token function\">linked_namespaces</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;</span> linked_namespace <span class=\"token operator\">:</span> ns<span class=\"token operator\">-></span><span class=\"token function\">linked_namespaces</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">find_library_in_linked_namespace</span><span class=\"token punctuation\">(</span>linked_namespace<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token comment\">// Library is already loaded.</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>task<span class=\"token operator\">-></span><span class=\"token function\">get_soinfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        <span class=\"token comment\">// n.b. This code path runs when find_library_in_linked_namespace found an already-loaded</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        <span class=\"token comment\">// library by soname. That should only be possible with a exempt-list lookup, where we</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        <span class=\"token comment\">// switch the namespace, because otherwise, find_library_in_linked_namespace is duplicating</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        <span class=\"token comment\">// the soname scan done in this function's first call to find_loaded_library_by_soname.</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">load_library</span><span class=\"token punctuation\">(</span>linked_namespace<span class=\"token punctuation\">.</span><span class=\"token function\">linked_namespace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">,</span> zip_archive_cache<span class=\"token punctuation\">,</span> load_tasks<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                       rtld_flags<span class=\"token punctuation\">,</span> false <span class=\"token comment\">/* search_linked_namespaces */</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span> <span class=\"token string\">\"find_library_internal(ns=%s, task=%s): Found in linked namespace %s\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>               ns<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> linked_namespace<span class=\"token punctuation\">.</span><span class=\"token function\">linked_namespace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"load_library\"><a class=\"anchor\" href=\"#load_library\">#</a> load_library</h4>\n<p>å‡½æ•°å£°æ˜:</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> bool <span class=\"token function\">load_library</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">android_namespace_t</span><span class=\"token operator\">*</span> ns<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                         LoadTask<span class=\"token operator\">*</span> task<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                         ZipArchiveCache<span class=\"token operator\">*</span> zip_archive_cache<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                         LoadTaskList<span class=\"token operator\">*</span> load_tasks<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                         <span class=\"token keyword\">int</span> rtld_flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                         bool search_linked_namespaces<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­ <code>extinfo-&gt;flags</code>  æ˜¯å¦æ˜¯ <code>ANDROID_DLEXT_USE_LIBRARY_FD</code> , å¦‚æœåŒæ—¶æœ‰ <code>ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET</code> , æ ‡å¿—åœ¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5jb20vbmRrL3JlZmVyZW5jZS9ncm91cC9saWJkbA==\"> Android å®˜ç½‘çš„è§£é‡Š</span>å¦‚ä¸‹</p>\n<p><img data-src=\"/android-load-so/image-20240217132018399.png\" alt=\"image-20240217132018399\" style=\"aspect-ratio:1095 / 403;\"></p>\n<p>é‚£è¿™æ ·å°±æ–¹ä¾¿äº†ï¼Œå‡å¦‚å·²ç»æœ‰äº†è¿™ä¸ª library çš„ <code>fd</code>  æ–‡ä»¶æè¿°ç¬¦ï¼Œé‚£ç›´æ¥æ‹¿è¿‡æ¥ç”¨å°±å¯ä»¥äº†</p>\n<p>ä½†æ˜¯æˆ‘ä»¬å¾…åŠ è½½çš„ so çš„ <code>extinfo-&gt;flags</code>  å·²ç»åœ¨ <code>android::OpenNativeLibrary</code>  ä¸­è¢«å®šä¹‰ä¸º <code>ANDROID_DLEXT_USE_NAMESPACE</code>  äº†ï¼Œè¿™ä¸ªæ ‡å¿—çš„å«ä¹‰åœ¨ä¸Šå›¾ä¸­ä¹Ÿæœ‰ç»™å‡ºï¼Œæ‰€ä»¥å¾ˆé—æ†¾ï¼Œè¿™ä¸ª <code>if</code>  è¯­å¥ä¸­çš„ä»£ç å¹¶ä¸ä¼šè¢«æ‰§è¡Œ</p>\n<p><img data-src=\"/android-load-so/image-20240217131920074.png\" alt=\"image-20240217131920074\" style=\"aspect-ratio:479 / 82;\"></p>\n<p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¦ç‰¹æ„åœ¨æ­¤å¤„åŠ å…¥è¿™ä¸ª if è¯­å¥å‘¢ï¼Ÿ</p>\n<p>æˆ‘çš„ç†è§£æ˜¯ä¸ºäº†æé«˜è¿è¡Œçš„æ•ˆç‡ï¼Œæœ‰ä¸€äº›åº•å±‚çš„åº“å·²ç»æ‰“å¼€è¿‡ï¼ŒåŠ è½½è¿‡äº†ï¼Œé‚£ä¹ˆå°±å®Œå…¨æ²¡æœ‰å¿…è¦å†æ‰“å¼€ï¼Œæœç´¢ä¸€æ¬¡ï¼Œç›´æ¥æŠŠ library çš„ <code>fd</code>  æ–‡ä»¶æè¿°ç¬¦æ‹¿è¿‡æ¥ç”¨å°±å¯ä»¥äº†</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>soinfo<span class=\"token operator\">*</span> needed_by <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_needed_by</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">const</span> android_dlextinfo<span class=\"token operator\">*</span> extinfo <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_extinfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// å¦‚æœ extinfo->flags çš„æ ‡è®°æ˜¯ ANDROID_DLEXT_USE_LIBRARY_FD, åˆ™ç›´æ¥é€šè¿‡</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">//fd æ–‡ä»¶æè¿°ç¬¦æ¥æ‰“å¼€</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>extinfo <span class=\"token operator\">!=</span> nullptr <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>flags <span class=\"token operator\">&amp;</span> ANDROID_DLEXT_USE_LIBRARY_FD<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token class-name\">off64_t</span> file_offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>flags <span class=\"token operator\">&amp;</span> ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        file_offset <span class=\"token operator\">=</span> extinfo<span class=\"token operator\">-></span>library_fd_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    std<span class=\"token operator\">::</span>string realpath<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">realpath_fd</span><span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>library_fd<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>realpath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">is_first_stage_init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token function\">PRINT</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                <span class=\"token string\">\"warning: unable to get realpath for the library \\\"%s\\\" by extinfo->library_fd. \"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token string\">\"Will use given name.\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        realpath <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    task<span class=\"token operator\">-></span><span class=\"token function\">set_fd</span><span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>library_fd<span class=\"token punctuation\">,</span> false<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    task<span class=\"token operator\">-></span><span class=\"token function\">set_file_offset</span><span class=\"token punctuation\">(</span>file_offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">load_library</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">,</span> load_tasks<span class=\"token punctuation\">,</span> rtld_flags<span class=\"token punctuation\">,</span> realpath<span class=\"token punctuation\">,</span> search_linked_namespaces<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ä¹‹åï¼Œæˆ‘ä»¬åƒè¾›ä¸‡è‹¦ç»ˆäºçœ‹åˆ°äº†è¿™å¯¹äºå¾…åŠ è½½çš„ so çš„ç¬¬ä¸€ä¸ªæ“ä½œï¼Œè°ƒç”¨ <code>open_library</code>  æ‰“å¼€å®ƒ</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Open the file.</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">off64_t</span> file_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>std<span class=\"token operator\">::</span>string realpath<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open_library</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span> zip_archive_cache<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> needed_by<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>file_offset<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>realpath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// å¦‚æœæ‰“å¼€ so å¤±è´¥ï¼Œå¯»æ‰¾å¤±è´¥åŸå› </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fd <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>task<span class=\"token operator\">-></span><span class=\"token function\">is_dt_needed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>needed_by<span class=\"token operator\">-></span><span class=\"token function\">is_main_executable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token function\">DL_OPEN_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"library \\\"%s\\\" not found: needed by main executable\"</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token function\">DL_OPEN_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"library \\\"%s\\\" not found: needed by %s in namespace %s\"</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                        needed_by<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_start_from</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token function\">DL_OPEN_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"library \\\"%s\\\" not found\"</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">//set fd and file_offset</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>task<span class=\"token operator\">-></span><span class=\"token function\">set_fd</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> true<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>task<span class=\"token operator\">-></span><span class=\"token function\">set_file_offset</span><span class=\"token punctuation\">(</span>file_offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“ <code>System.load</code>  éœ€è¦æŒ‡å®šå¾…åŠ è½½çš„ so çš„ç»å¯¹è·¯å¾„ï¼Œè¿™åœ¨ <code>open_library</code>  ä¸­ä¾¿ç¬¦åˆç¬¬ä¸€ä¸ª if è¯­å¥ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å°†ä¼šè°ƒç”¨ <code>open_library_at_path</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token function\">open_library</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">android_namespace_t</span><span class=\"token operator\">*</span> ns<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                        ZipArchiveCache<span class=\"token operator\">*</span> zip_archive_cache<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                        <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">,</span> soinfo <span class=\"token operator\">*</span>needed_by<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                        <span class=\"token class-name\">off64_t</span><span class=\"token operator\">*</span> file_offset<span class=\"token punctuation\">,</span> std<span class=\"token operator\">::</span>string<span class=\"token operator\">*</span> realpath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">TRACE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[ opening %s from namespace %s ]\"</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> ns<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// If the name contains a slash, we should attempt to open it directly and not search the paths.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// æœ‰æ–œæ ï¼Œè¯´æ˜æ˜¯ç»å¯¹è·¯å¾„æ‰“å¼€çš„</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strchr</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> <span class=\"token char\">'/'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">open_library_at_path</span><span class=\"token punctuation\">(</span>zip_archive_cache<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> file_offset<span class=\"token punctuation\">,</span> realpath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">// LD_LIBRARY_PATH has the highest priority. We don't have to check accessibility when searching</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// the namespace's path lists, because anything found on a namespace path list should always be</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">// accessible.</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open_library_on_paths</span><span class=\"token punctuation\">(</span>zip_archive_cache<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> file_offset<span class=\"token punctuation\">,</span> ns<span class=\"token operator\">-></span><span class=\"token function\">get_ld_library_paths</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> realpath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token comment\">// Try the DT_RUNPATH, and verify that the library is accessible.</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fd <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span> needed_by <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    fd <span class=\"token operator\">=</span> <span class=\"token function\">open_library_on_paths</span><span class=\"token punctuation\">(</span>zip_archive_cache<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> file_offset<span class=\"token punctuation\">,</span> needed_by<span class=\"token operator\">-></span><span class=\"token function\">get_dt_runpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> realpath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fd <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>ns<span class=\"token operator\">-></span><span class=\"token function\">is_accessible</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>realpath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      fd <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token comment\">// Finally search the namespace's main search path list.</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fd <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    fd <span class=\"token operator\">=</span> <span class=\"token function\">open_library_on_paths</span><span class=\"token punctuation\">(</span>zip_archive_cache<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> file_offset<span class=\"token punctuation\">,</span> ns<span class=\"token operator\">-></span><span class=\"token function\">get_default_library_paths</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> realpath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">return</span> fd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>åœ¨ <code>open_library_at_path</code>  ä¸­æ‰ç®—æ˜¯çœŸæ­£çš„ä½¿ç”¨ <code>open</code>  å‡½æ•°æ‰“å¼€äº†è¿™ä¸ª so, å¹¶è¿”å›æ–‡ä»¶æè¿°ç¬¦ <code>fd</code> , ä¼ å…¥çš„ä¸¤ä¸ªæ ‡å¿—çš„å«ä¹‰åˆ†åˆ«ä¸º</p>\n<ul>\n<li><code>O_RDONLY</code>  è¡¨ç¤ºä»¥åªè¯»æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚</li>\n<li><code>O_CLOEXEC</code>  è¡¨ç¤ºåœ¨ exec æ—å‡½æ•° (execl, execlp, execle, execv, execvp, execvpe) è°ƒç”¨åï¼Œå°†è‡ªåŠ¨å…³é—­æ–‡ä»¶æè¿°ç¬¦</li>\n</ul>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> <span class=\"token function\">open_library_at_path</span><span class=\"token punctuation\">(</span>ZipArchiveCache<span class=\"token operator\">*</span> zip_archive_cache<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                                <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> path<span class=\"token punctuation\">,</span> <span class=\"token class-name\">off64_t</span><span class=\"token operator\">*</span> file_offset<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                std<span class=\"token operator\">::</span>string<span class=\"token operator\">*</span> realpath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// å¦‚æœè·¯å¾„ä¸­åŒ…å« \"!/\", åˆ™é€šè¿‡ zipfile æ‰“å¼€åº“</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strstr</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> kZipFileSeparator<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    fd <span class=\"token operator\">=</span> <span class=\"token function\">open_library_in_zipfile</span><span class=\"token punctuation\">(</span>zip_archive_cache<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> file_offset<span class=\"token punctuation\">,</span> realpath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fd <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    fd <span class=\"token operator\">=</span> <span class=\"token function\">TEMP_FAILURE_RETRY</span><span class=\"token punctuation\">(</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> O_RDONLY <span class=\"token operator\">|</span> O_CLOEXEC<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fd <span class=\"token operator\">!=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token operator\">*</span>file_offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">realpath_fd</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> realpath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">is_first_stage_init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          <span class=\"token function\">PRINT</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"warning: unable to get realpath for the library \\\"%s\\\". Will use given path.\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token operator\">*</span>realpath <span class=\"token operator\">=</span> path<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">return</span> fd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æˆåŠŸçš„æ‰“å¼€äº†è¿™ä¸ª so ä¹‹åï¼Œé‚£å°±è¦å¼€å§‹è§£æè¿™ä¸ª so å’¯ï¼Œçœ‹çœ‹ <code>load_library</code>  æœ€ç»ˆ <code>return</code>  çš„å•¥ï¼Ÿç«Ÿç„¶è¿˜æ˜¯ <code>load_library</code> ! ä¸è¿‡ç»†çœ‹ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ€ä¹ˆæ„Ÿè§‰ç±»å‹ä¸æ˜¯ <code>ZipArchiveCache*</code>  å‘¢</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">return</span> <span class=\"token function\">load_library</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">,</span> load_tasks<span class=\"token punctuation\">,</span> rtld_flags<span class=\"token punctuation\">,</span> realpath<span class=\"token punctuation\">,</span> search_linked_namespaces<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>æ‰¾æ‰¾å‡½æ•°çš„å£°æ˜ï¼ŒåŸæ¥ <code>load_library</code>  è¿˜æœ‰ä¸€ä¸ªé‡è½½å‡½æ•°ï¼Œå®ƒçš„ç¬¬ä¸‰ä¸ªå‚æ•°çš„ç±»å‹å°±æ˜¯ <code>LoadTaskList*</code></p>\n<p>æ­¤ <code>load_library</code>  å‡½æ•°çš„å®Œæ•´ä»£ç å¦‚ä¸‹</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> bool <span class=\"token function\">load_library</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">android_namespace_t</span><span class=\"token operator\">*</span> ns<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                         LoadTask<span class=\"token operator\">*</span> task<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                         ZipArchiveCache<span class=\"token operator\">*</span> zip_archive_cache<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                         LoadTaskList<span class=\"token operator\">*</span> load_tasks<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                         <span class=\"token keyword\">int</span> rtld_flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                         bool search_linked_namespaces<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  soinfo<span class=\"token operator\">*</span> needed_by <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_needed_by</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">const</span> android_dlextinfo<span class=\"token operator\">*</span> extinfo <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_extinfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// å¦‚æœ extinfo->flags çš„æ ‡è®°æ˜¯ ANDROID_DLEXT_USE_LIBRARY_FD, åˆ™ç›´æ¥é€šè¿‡</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">//fd æ–‡ä»¶æè¿°ç¬¦æ¥æ‰“å¼€</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>extinfo <span class=\"token operator\">!=</span> nullptr <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>flags <span class=\"token operator\">&amp;</span> ANDROID_DLEXT_USE_LIBRARY_FD<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token class-name\">off64_t</span> file_offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>flags <span class=\"token operator\">&amp;</span> ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      file_offset <span class=\"token operator\">=</span> extinfo<span class=\"token operator\">-></span>library_fd_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    std<span class=\"token operator\">::</span>string realpath<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">realpath_fd</span><span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>library_fd<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>realpath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">is_first_stage_init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token function\">PRINT</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token string\">\"warning: unable to get realpath for the library \\\"%s\\\" by extinfo->library_fd. \"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token string\">\"Will use given name.\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      realpath <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    task<span class=\"token operator\">-></span><span class=\"token function\">set_fd</span><span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>library_fd<span class=\"token punctuation\">,</span> false<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    task<span class=\"token operator\">-></span><span class=\"token function\">set_file_offset</span><span class=\"token punctuation\">(</span>file_offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">load_library</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">,</span> load_tasks<span class=\"token punctuation\">,</span> rtld_flags<span class=\"token punctuation\">,</span> realpath<span class=\"token punctuation\">,</span> search_linked_namespaces<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>         <span class=\"token string\">\"load_library(ns=%s, task=%s, flags=0x%x, search_linked_namespaces=%d): calling \"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>         <span class=\"token string\">\"open_library\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>         ns<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> rtld_flags<span class=\"token punctuation\">,</span> search_linked_namespaces<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token comment\">// Open the file.</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token class-name\">off64_t</span> file_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  std<span class=\"token operator\">::</span>string realpath<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token keyword\">int</span> fd <span class=\"token operator\">=</span> <span class=\"token function\">open_library</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span> zip_archive_cache<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> needed_by<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>file_offset<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>realpath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token comment\">// å¦‚æœæ‰“å¼€ so å¤±è´¥ï¼Œå¯»æ‰¾å¤±è´¥åŸå› </span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fd <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>task<span class=\"token operator\">-></span><span class=\"token function\">is_dt_needed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>needed_by<span class=\"token operator\">-></span><span class=\"token function\">is_main_executable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token function\">DL_OPEN_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"library \\\"%s\\\" not found: needed by main executable\"</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token function\">DL_OPEN_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"library \\\"%s\\\" not found: needed by %s in namespace %s\"</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                    needed_by<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_start_from</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      <span class=\"token function\">DL_OPEN_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"library \\\"%s\\\" not found\"</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token comment\">//set fd and file_offset</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  task<span class=\"token operator\">-></span><span class=\"token function\">set_fd</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">,</span> true<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  task<span class=\"token operator\">-></span><span class=\"token function\">set_file_offset</span><span class=\"token punctuation\">(</span>file_offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">load_library</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span> task<span class=\"token punctuation\">,</span> load_tasks<span class=\"token punctuation\">,</span> rtld_flags<span class=\"token punctuation\">,</span> realpath<span class=\"token punctuation\">,</span> search_linked_namespaces<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"é‡è½½çš„load_library\"><a class=\"anchor\" href=\"#é‡è½½çš„load_library\">#</a> é‡è½½çš„ load_library</h4>\n<p>å‡½æ•°å£°æ˜:</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> bool <span class=\"token function\">load_library</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">android_namespace_t</span><span class=\"token operator\">*</span> ns<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                         LoadTask<span class=\"token operator\">*</span> task<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                         LoadTaskList<span class=\"token operator\">*</span> load_tasks<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                         <span class=\"token keyword\">int</span> rtld_flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                         <span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>string<span class=\"token operator\">&amp;</span> realpath<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                         bool search_linked_namespaces<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°çš„å¼€å¤´åšäº†ä¸€å¤§å †å‚æ•°åˆæ³•æ€§çš„æ£€æŸ¥ï¼Œéšåç»ˆäºå¼€å§‹è§£æ so äº†ï¼Œå…¶å…³é”®å‡½æ•°ä¸º <code>task-&gt;read(realpath.c_str(), file_stat.st_size)</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>soinfo<span class=\"token operator\">*</span> si <span class=\"token operator\">=</span> <span class=\"token function\">soinfo_alloc</span><span class=\"token punctuation\">(</span>ns<span class=\"token punctuation\">,</span> realpath<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>file_stat<span class=\"token punctuation\">,</span> file_offset<span class=\"token punctuation\">,</span> rtld_flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>task<span class=\"token operator\">-></span><span class=\"token function\">set_soinfo</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// Read the ELF header and some of the segments.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>task<span class=\"token operator\">-></span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>realpath<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> file_stat<span class=\"token punctuation\">.</span>st_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    task<span class=\"token operator\">-></span><span class=\"token function\">remove_cached_elf_reader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    task<span class=\"token operator\">-></span><span class=\"token function\">set_soinfo</span><span class=\"token punctuation\">(</span>nullptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">soinfo_free</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">// Find and set DT_RUNPATH, DT_SONAME, and DT_FLAGS_1.</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">// Note that these field values are temporary and are</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">// going to be overwritten on soinfo::prelink_image</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">// with values from PT_LOAD segments.</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">const</span> ElfReader<span class=\"token operator\">&amp;</span> elf_reader <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_elf_reader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Dyn<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> d <span class=\"token operator\">=</span> elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">dynamic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">!=</span> DT_NULL<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>d<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">==</span> DT_RUNPATH<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        si<span class=\"token operator\">-></span><span class=\"token function\">set_dt_runpath</span><span class=\"token punctuation\">(</span>elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">get_string</span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">==</span> DT_SONAME<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        si<span class=\"token operator\">-></span><span class=\"token function\">set_soname</span><span class=\"token punctuation\">(</span>elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">get_string</span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// We need to identify a DF_1_GLOBAL library early so we can link it to namespaces.</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">==</span> DT_FLAGS_1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        si<span class=\"token operator\">-></span><span class=\"token function\">set_dt_flags_1</span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token function\">for_each_dt_needed</span><span class=\"token punctuation\">(</span>task<span class=\"token operator\">-></span><span class=\"token function\">get_elf_reader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span> <span class=\"token string\">\"load_library(ns=%s, task=%s): Adding DT_NEEDED task: %s\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>           ns<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    load_tasks<span class=\"token operator\">-></span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>LoadTask<span class=\"token operator\">::</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">,</span> ns<span class=\"token punctuation\">,</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_readers_map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>LoadTask::read</strong></p>\n<p>åˆå§‹åŒ–äº†ä¸€ä¸ª <code>ElfReader</code> , éšåè°ƒç”¨ <code>elf_reader.Read</code>  æ­£å¼å¼€å§‹è¯»å–</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bool <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> realpath<span class=\"token punctuation\">,</span> <span class=\"token class-name\">off64_t</span> file_size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    ElfReader<span class=\"token operator\">&amp;</span> elf_reader <span class=\"token operator\">=</span> <span class=\"token function\">get_elf_reader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">Read</span><span class=\"token punctuation\">(</span>realpath<span class=\"token punctuation\">,</span> fd_<span class=\"token punctuation\">,</span> file_offset_<span class=\"token punctuation\">,</span> file_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>ElfReader::Read</strong></p>\n<p>å…œå…œè½¬è½¬äº†é‚£ä¹ˆä¹…ï¼Œç»ˆäºçœ‹åˆ°äº†è¿™ä¸ªäº²åˆ‡åˆç†Ÿæ‚‰çš„å‡½æ•°äº†ï¼ï¼</p>\n<p>å…³äºè¿™ä¸ªå‡½æ•°çš„æ›´å¤šåˆ†æè¯·å‚è€ƒ<a href=\"oacia.dev/ElfReader\"> ELF ç»“æ„åˆ†æåŠ ElfReader</a></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_phdr.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bool ElfReader<span class=\"token operator\">::</span><span class=\"token function\">Read</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">,</span> <span class=\"token class-name\">off64_t</span> file_offset<span class=\"token punctuation\">,</span> <span class=\"token class-name\">off64_t</span> file_size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>did_read_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name_ <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  fd_ <span class=\"token operator\">=</span> fd<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  file_offset_ <span class=\"token operator\">=</span> file_offset<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  file_size_ <span class=\"token operator\">=</span> file_size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">ReadElfHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      <span class=\"token function\">VerifyElfHeader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token function\">ReadProgramHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token function\">ReadSectionHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token function\">ReadDynamicSection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    did_read_ <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">return</span> did_read_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><hr>\n<p>åœ¨è·å–åˆ°å¾…åŠ è½½çš„ so çš„å„ä¸ªæ®µçš„ç»“æ„ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è§£æ <code>.dynamic</code>  ä¸­ä¿å­˜çš„ç¬¦å·</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// Find and set DT_RUNPATH, DT_SONAME, and DT_FLAGS_1.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// Note that these field values are temporary and are</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// going to be overwritten on soinfo::prelink_image</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// with values from PT_LOAD segments.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">const</span> ElfReader<span class=\"token operator\">&amp;</span> elf_reader <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_elf_reader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Dyn<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> d <span class=\"token operator\">=</span> elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">dynamic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">!=</span> DT_NULL<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>d<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">==</span> DT_RUNPATH<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        si<span class=\"token operator\">-></span><span class=\"token function\">set_dt_runpath</span><span class=\"token punctuation\">(</span>elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">get_string</span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">==</span> DT_SONAME<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        si<span class=\"token operator\">-></span><span class=\"token function\">set_soname</span><span class=\"token punctuation\">(</span>elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">get_string</span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// We need to identify a DF_1_GLOBAL library early so we can link it to namespaces.</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">==</span> DT_FLAGS_1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        si<span class=\"token operator\">-></span><span class=\"token function\">set_dt_flags_1</span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ä¹‹åæ‰¾åˆ°å¾…åŠ è½½çš„ so çš„ä¾èµ–åº“ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ¨¡æ¿å‡½æ•° <code>for_each_dt_needed</code> , æ‰¾åˆ° <code>.dynamic</code>  ä¸­æ‰€æœ‰å¸¦æœ‰ <code>DT_NEEDED</code>  æ ‡å¿—çš„å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²çš„åç§°å°±æ˜¯è¿™ä¸ª so æ‰€éœ€è¦çš„ä¾èµ–åº“ï¼Œç„¶åå°†å®ƒä»¬æ·»åŠ åˆ° <code>load_tasks</code>  é˜Ÿåˆ—ä¸­</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">for_each_dt_needed</span><span class=\"token punctuation\">(</span>task<span class=\"token operator\">-></span><span class=\"token function\">get_elf_reader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span> <span class=\"token string\">\"load_library(ns=%s, task=%s): Adding DT_NEEDED task: %s\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>           ns<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    load_tasks<span class=\"token operator\">-></span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>LoadTask<span class=\"token operator\">::</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">,</span> ns<span class=\"token punctuation\">,</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_readers_map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_soinfo.h</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>template<span class=\"token operator\">&lt;</span>typename F<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">for_each_dt_needed</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> soinfo<span class=\"token operator\">*</span> si<span class=\"token punctuation\">,</span> F action<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Dyn<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> d <span class=\"token operator\">=</span> si<span class=\"token operator\">-></span>dynamic<span class=\"token punctuation\">;</span> d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">!=</span> DT_NULL<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>d<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">==</span> DT_NEEDED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token function\">action</span><span class=\"token punctuation\">(</span><span class=\"token function\">fix_dt_needed</span><span class=\"token punctuation\">(</span>si<span class=\"token operator\">-></span><span class=\"token function\">get_string</span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> si<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"ä¹±åºåŠ è½½åº“\"><a class=\"anchor\" href=\"#ä¹±åºåŠ è½½åº“\">#</a> ä¹±åºåŠ è½½åº“</h3>\n<p>ä¹±åºåŠ è½½çš„åŸå› å¦‚ä¸‹ï¼Œçœ‹ä¸Šå»æ˜¯ä¸ºäº†æŠµå¾¡æ”»å‡»</p>\n<blockquote>\n<p>ld.so(1) on ELF platforms now loads libraries in a random order for greater resistance to attacks</p>\n</blockquote>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Step 2: Load libraries in random order (see b/24047022)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>LoadTaskList load_list<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;&amp;</span> task <span class=\"token operator\">:</span> load_tasks<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    soinfo<span class=\"token operator\">*</span> si <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_soinfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">auto</span> pred <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> LoadTask<span class=\"token operator\">*</span> t<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> t<span class=\"token operator\">-></span><span class=\"token function\">get_soinfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> si<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>si<span class=\"token operator\">-></span><span class=\"token function\">is_linked</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        std<span class=\"token operator\">::</span><span class=\"token function\">find_if</span><span class=\"token punctuation\">(</span>load_list<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> load_list<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> pred<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> load_list<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        load_list<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>bool reserved_address_recursive <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>extinfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    reserved_address_recursive <span class=\"token operator\">=</span> extinfo<span class=\"token operator\">-></span>flags <span class=\"token operator\">&amp;</span> ANDROID_DLEXT_RESERVED_ADDRESS_RECURSIVE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>reserved_address_recursive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">// Shuffle the load order in the normal case, but not if we are loading all</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">// the libraries to a reserved address range.</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token function\">shuffle</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>load_list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// Set up address space parameters.</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>address_space_params extinfo_params<span class=\"token punctuation\">,</span> default_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token class-name\">size_t</span> relro_fd_offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>extinfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>flags <span class=\"token operator\">&amp;</span> ANDROID_DLEXT_RESERVED_ADDRESS<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        extinfo_params<span class=\"token punctuation\">.</span>start_addr <span class=\"token operator\">=</span> extinfo<span class=\"token operator\">-></span>reserved_addr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        extinfo_params<span class=\"token punctuation\">.</span>reserved_size <span class=\"token operator\">=</span> extinfo<span class=\"token operator\">-></span>reserved_size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        extinfo_params<span class=\"token punctuation\">.</span>must_use_address <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>extinfo<span class=\"token operator\">-></span>flags <span class=\"token operator\">&amp;</span> ANDROID_DLEXT_RESERVED_ADDRESS_HINT<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        extinfo_params<span class=\"token punctuation\">.</span>start_addr <span class=\"token operator\">=</span> extinfo<span class=\"token operator\">-></span>reserved_addr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        extinfo_params<span class=\"token punctuation\">.</span>reserved_size <span class=\"token operator\">=</span> extinfo<span class=\"token operator\">-></span>reserved_size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;&amp;</span> task <span class=\"token operator\">:</span> load_list<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    address_space_params<span class=\"token operator\">*</span> address_space <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token punctuation\">(</span>reserved_address_recursive <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>task<span class=\"token operator\">-></span><span class=\"token function\">is_dt_needed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token operator\">&amp;</span>extinfo_params <span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>default_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\">// åŠ è½½æ‰€æœ‰çš„åº“ï¼ŒåŒ…æ‹¬å¾…åŠ è½½çš„ so</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>task<span class=\"token operator\">-></span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>address_space<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>load</code>  å‡½æ•°å°±æ˜¯å°† ELF çš„ç›¸å…³ç»“æ„çš„å€¼èµ‹å€¼ç»™ <code>si_</code> , å…¶ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯”è¾ƒé‡è¦çš„å­—æ®µæœ‰ <code>phdr_count</code> , <code>loaded_phdr</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>bool <span class=\"token function\">load</span><span class=\"token punctuation\">(</span>address_space_params<span class=\"token operator\">*</span> address_space<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    ElfReader<span class=\"token operator\">&amp;</span> elf_reader <span class=\"token operator\">=</span> <span class=\"token function\">get_elf_reader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">Load</span><span class=\"token punctuation\">(</span>address_space<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    si_<span class=\"token operator\">-></span>base <span class=\"token operator\">=</span> elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">load_start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    si_<span class=\"token operator\">-></span>size <span class=\"token operator\">=</span> elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">load_size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    si_<span class=\"token operator\">-></span><span class=\"token function\">set_mapped_by_caller</span><span class=\"token punctuation\">(</span>elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">is_mapped_by_caller</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    si_<span class=\"token operator\">-></span>load_bias <span class=\"token operator\">=</span> elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">load_bias</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    si_<span class=\"token operator\">-></span>phnum <span class=\"token operator\">=</span> elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">phdr_count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    si_<span class=\"token operator\">-></span>phdr <span class=\"token operator\">=</span> elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">loaded_phdr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    si_<span class=\"token operator\">-></span><span class=\"token function\">set_gap_start</span><span class=\"token punctuation\">(</span>elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">gap_start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    si_<span class=\"token operator\">-></span><span class=\"token function\">set_gap_size</span><span class=\"token punctuation\">(</span>elf_reader<span class=\"token punctuation\">.</span><span class=\"token function\">gap_size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"é¢„é“¾æ¥è§£ææ‰€æœ‰ä¾èµ–åº“\"><a class=\"anchor\" href=\"#é¢„é“¾æ¥è§£ææ‰€æœ‰ä¾èµ–åº“\">#</a> é¢„é“¾æ¥è§£ææ‰€æœ‰ä¾èµ–åº“</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Step 3: pre-link all DT_NEEDED libraries in breadth first order.</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;&amp;</span> task <span class=\"token operator\">:</span> load_tasks<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    soinfo<span class=\"token operator\">*</span> si <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_soinfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>si<span class=\"token operator\">-></span><span class=\"token function\">is_linked</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>si<span class=\"token operator\">-></span><span class=\"token function\">prelink_image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">register_soinfo_tls</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°è°ƒç”¨äº† <code>prelink_image</code>  æ¥é¢„é“¾æ¥ä¾èµ–åº“ï¼Œä¸»è¦æ˜¯éå† <code>.dynamic</code>  èŠ‚ï¼Œæ¥æå–å¿…è¦çš„ä¿¡æ¯ä¾‹å¦‚ <code>strtab_</code> , <code>symtab_</code> , <code>plt_rela_</code> , <code>init_array_</code> ç­‰ç­‰å„ç§å¿…è¦çš„ä¿¡æ¯</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>bool soinfo<span class=\"token operator\">::</span><span class=\"token function\">prelink_image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>flags_ <span class=\"token operator\">&amp;</span> FLAG_PRELINKED<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">/* Extract dynamic section */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Word<span class=\"token punctuation\">)</span> dynamic_flags <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// æå–åŠ¨æ€èŠ‚ï¼ˆdynamic sectionï¼‰</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">phdr_table_get_dynamic_section</span><span class=\"token punctuation\">(</span>phdr<span class=\"token punctuation\">,</span> phnum<span class=\"token punctuation\">,</span> load_bias<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dynamic<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dynamic_flags<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">/* We can't log anything until the linker is relocated */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  bool relocating_linker <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>flags_ <span class=\"token operator\">&amp;</span> FLAG_LINKER<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>relocating_linker<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token function\">INFO</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[ Linking \\\"%s\\\" ]\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"si->base = %p si->flags = 0x%08x\"</span><span class=\"token punctuation\">,</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> flags_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dynamic <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>relocating_linker<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"missing PT_DYNAMIC in \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>relocating_linker<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dynamic = %p\"</span><span class=\"token punctuation\">,</span> dynamic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__arm__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token function\">phdr_table_get_arm_exidx</span><span class=\"token punctuation\">(</span>phdr<span class=\"token punctuation\">,</span> phnum<span class=\"token punctuation\">,</span> load_bias<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                                  <span class=\"token operator\">&amp;</span>ARM_exidx<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ARM_exidx_count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  TlsSegment tls_segment<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">__bionic_get_tls_segment</span><span class=\"token punctuation\">(</span>phdr<span class=\"token punctuation\">,</span> phnum<span class=\"token punctuation\">,</span> load_bias<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>tls_segment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">__bionic_check_tls_alignment</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>tls_segment<span class=\"token punctuation\">.</span>alignment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>relocating_linker<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TLS segment alignment in \\\"%s\\\" is not a power of 2: %zu\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>               <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> tls_segment<span class=\"token punctuation\">.</span>alignment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    tls_ <span class=\"token operator\">=</span> std<span class=\"token operator\">::</span>make_unique<span class=\"token operator\">&lt;</span>soinfo_tls<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    tls_<span class=\"token operator\">-></span>segment <span class=\"token operator\">=</span> tls_segment<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token comment\">// Extract useful information from dynamic section.</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token comment\">// Note that: \"Except for the DT_NULL element at the end of the array,</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token comment\">// and the relative order of DT_NEEDED elements, entries may appear in any order.\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token comment\">// source: http://www.sco.com/developers/gabi/1998-04-29/ch5.dynamic.html</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token class-name\">uint32_t</span> needed_count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token comment\">// å¾ªç¯éå†æ¯ä¸ªåŠ¨æ€èŠ‚ï¼Œå¹¶æ ¹æ® d_tag ä¸ºå¯¹åº”èŠ‚åšç›¸åº”çš„å¤„ç†</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Dyn<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> d <span class=\"token operator\">=</span> dynamic<span class=\"token punctuation\">;</span> d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">!=</span> DT_NULL<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>d<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"d = %p, d[0](tag) = %p d[1](val) = %p\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          d<span class=\"token punctuation\">,</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_SONAME<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        <span class=\"token comment\">// this is parsed after we have strtab initialized (see below).</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_HASH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        nbucket_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        nchain_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        bucket_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr <span class=\"token operator\">+</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        chain_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr <span class=\"token operator\">+</span> <span class=\"token number\">8</span> <span class=\"token operator\">+</span> nbucket_ <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_GNU_HASH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        gnu_nbucket_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token comment\">// skip symndx</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        gnu_maskwords_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        gnu_shift2_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        gnu_bloom_filter_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr <span class=\"token operator\">+</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        gnu_bucket_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>gnu_bloom_filter_ <span class=\"token operator\">+</span> gnu_maskwords_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token comment\">// amend chain for symndx = header[1]</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        gnu_chain_ <span class=\"token operator\">=</span> gnu_bucket_ <span class=\"token operator\">+</span> gnu_nbucket_ <span class=\"token operator\">-</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>            reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uint32_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">powerof2</span><span class=\"token punctuation\">(</span>gnu_maskwords_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invalid maskwords for gnu_hash = 0x%x, in \\\"%s\\\" expecting power to two\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>              gnu_maskwords_<span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        <span class=\"token operator\">--</span>gnu_maskwords_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        flags_ <span class=\"token operator\">|=</span> FLAG_GNU_HASH<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_STRTAB<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        strtab_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_STRSZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        strtab_size_ <span class=\"token operator\">=</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_SYMTAB<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        symtab_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Sym<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_SYMENT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">!=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Sym<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>          <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invalid DT_SYMENT: %zd in \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>              static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>          <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_PLTREL<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>USE_RELA<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">!=</span> DT_RELA<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>          <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unsupported DT_PLTREL in \\\"%s\\\"; expected DT_RELA\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>          <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">!=</span> DT_REL<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>          <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unsupported DT_PLTREL in \\\"%s\\\"; expected DT_REL\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>          <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_JMPREL<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>USE_RELA<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>        plt_rela_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rela<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        plt_rel_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rel<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_PLTRELSZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>USE_RELA<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        plt_rela_count_ <span class=\"token operator\">=</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rela<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        plt_rel_count_ <span class=\"token operator\">=</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_PLTGOT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>        <span class=\"token comment\">// Ignored (because RTLD_LAZY is not supported).</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_DEBUG<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>        <span class=\"token comment\">// Set the DT_DEBUG entry to the address of _r_debug for GDB</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>        <span class=\"token comment\">// if the dynamic table is writable</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>dynamic_flags <span class=\"token operator\">&amp;</span> PF_W<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>          d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uintptr_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>_r_debug<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>USE_RELA<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_RELA<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>        rela_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rela<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_RELASZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>        rela_count_ <span class=\"token operator\">=</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rela<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_ANDROID_RELA<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        android_relocs_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uint8_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_ANDROID_RELASZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>        android_relocs_size_ <span class=\"token operator\">=</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_ANDROID_REL<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>        <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unsupported DT_ANDROID_REL in \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_ANDROID_RELSZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>        <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unsupported DT_ANDROID_RELSZ in \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_RELAENT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">!=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rela<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>          <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invalid DT_RELAENT: %zd\"</span><span class=\"token punctuation\">,</span> static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>          <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>      <span class=\"token comment\">// Ignored (see DT_RELCOUNT comments for details).</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_RELACOUNT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_REL<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>        <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unsupported DT_REL in \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_RELSZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>        <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unsupported DT_RELSZ in \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre></pre></td></tr><tr><td data-num=\"193\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_REL<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>        rel_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rel<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_RELSZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>        rel_count_ <span class=\"token operator\">=</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_RELENT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">!=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Rel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>          <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invalid DT_RELENT: %zd\"</span><span class=\"token punctuation\">,</span> static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>          <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_ANDROID_REL<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>        android_relocs_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uint8_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_ANDROID_RELSZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>        android_relocs_size_ <span class=\"token operator\">=</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_ANDROID_RELA<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>        <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unsupported DT_ANDROID_RELA in \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_ANDROID_RELASZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>        <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unsupported DT_ANDROID_RELASZ in \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>      <span class=\"token comment\">// \"Indicates that all RELATIVE relocations have been concatenated together,</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>      <span class=\"token comment\">// and specifies the RELATIVE relocation count.\"</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>      <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>      <span class=\"token comment\">// TODO: Spec also mentions that this can be used to optimize relocation process;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>      <span class=\"token comment\">// Not currently used by bionic linker - ignored.</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_RELCOUNT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_RELA<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>        <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unsupported DT_RELA in \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_RELASZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>        <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unsupported DT_RELASZ in \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre></pre></td></tr><tr><td data-num=\"241\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_RELR<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_ANDROID_RELR<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>        relr_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Relr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_RELRSZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_ANDROID_RELRSZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>        relr_count_ <span class=\"token operator\">=</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Relr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_RELRENT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_ANDROID_RELRENT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">!=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Relr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre>          <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invalid DT_RELRENT: %zd\"</span><span class=\"token punctuation\">,</span> static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>          <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>      <span class=\"token comment\">// Ignored (see DT_RELCOUNT comments for details).</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>      <span class=\"token comment\">// There is no DT_RELRCOUNT specifically because it would only be ignored.</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_ANDROID_RELRCOUNT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre></pre></td></tr><tr><td data-num=\"265\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_INIT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>        init_func_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">linker_ctor_function_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>        <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s constructors (DT_INIT) found at %p\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> init_func_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_FINI<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre>        fini_func_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">linker_dtor_function_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>        <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s destructors (DT_FINI) found at %p\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> fini_func_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_INIT_ARRAY<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>        init_array_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">linker_ctor_function_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>        <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s constructors (DT_INIT_ARRAY) found at %p\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> init_array_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_INIT_ARRAYSZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>        init_array_count_ <span class=\"token operator\">=</span> static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uint32_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre></pre></td></tr><tr><td data-num=\"284\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_FINI_ARRAY<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre>        fini_array_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">linker_dtor_function_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"286\"></td><td><pre>        <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s destructors (DT_FINI_ARRAY) found at %p\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> fini_array_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"288\"></td><td><pre></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_FINI_ARRAYSZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"290\"></td><td><pre>        fini_array_count_ <span class=\"token operator\">=</span> static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uint32_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"291\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre></pre></td></tr><tr><td data-num=\"293\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_PREINIT_ARRAY<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>        preinit_array_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">linker_ctor_function_t</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre>        <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s constructors (DT_PREINIT_ARRAY) found at %p\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> preinit_array_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"296\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"297\"></td><td><pre></pre></td></tr><tr><td data-num=\"298\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_PREINIT_ARRAYSZ<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>        preinit_array_count_ <span class=\"token operator\">=</span> static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">uint32_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre></pre></td></tr><tr><td data-num=\"302\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_TEXTREL<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"303\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__LP64__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre>        <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has text relocations\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"305\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"307\"></td><td><pre>        has_text_relocations <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"309\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre></pre></td></tr><tr><td data-num=\"311\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_SYMBOLIC<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"312\"></td><td><pre>        has_DT_SYMBOLIC <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"314\"></td><td><pre></pre></td></tr><tr><td data-num=\"315\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_NEEDED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"316\"></td><td><pre>        <span class=\"token operator\">++</span>needed_count<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"317\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"318\"></td><td><pre></pre></td></tr><tr><td data-num=\"319\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_FLAGS<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">&amp;</span> DF_TEXTREL<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"321\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__LP64__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"322\"></td><td><pre>          <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\\"%s\\\" has text relocations\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"323\"></td><td><pre>          <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"324\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"325\"></td><td><pre>          has_text_relocations <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"326\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"327\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"328\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">&amp;</span> DF_SYMBOLIC<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"329\"></td><td><pre>          has_DT_SYMBOLIC <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"330\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"331\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"332\"></td><td><pre></pre></td></tr><tr><td data-num=\"333\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_FLAGS_1<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"334\"></td><td><pre>        <span class=\"token function\">set_dt_flags_1</span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"335\"></td><td><pre></pre></td></tr><tr><td data-num=\"336\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val <span class=\"token operator\">&amp;</span> <span class=\"token operator\">~</span>SUPPORTED_DT_FLAGS_1<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"337\"></td><td><pre>          <span class=\"token function\">DL_WARN</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Warning: \\\"%s\\\" has unsupported flags DT_FLAGS_1=%p \"</span></pre></td></tr><tr><td data-num=\"338\"></td><td><pre>                  <span class=\"token string\">\"(ignoring unsupported flags)\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"339\"></td><td><pre>                  <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"340\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"341\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"342\"></td><td><pre></pre></td></tr><tr><td data-num=\"343\"></td><td><pre>      <span class=\"token comment\">// Ignored: \"Its use has been superseded by the DF_BIND_NOW flag\"</span></pre></td></tr><tr><td data-num=\"344\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_BIND_NOW<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"345\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"346\"></td><td><pre></pre></td></tr><tr><td data-num=\"347\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_VERSYM<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"348\"></td><td><pre>        versym_ <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Versym<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"349\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"350\"></td><td><pre></pre></td></tr><tr><td data-num=\"351\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_VERDEF<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"352\"></td><td><pre>        verdef_ptr_ <span class=\"token operator\">=</span> load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"353\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"354\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_VERDEFNUM<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"355\"></td><td><pre>        verdef_cnt_ <span class=\"token operator\">=</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"356\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"357\"></td><td><pre></pre></td></tr><tr><td data-num=\"358\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_VERNEED<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"359\"></td><td><pre>        verneed_ptr_ <span class=\"token operator\">=</span> load_bias <span class=\"token operator\">+</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_ptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"360\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"361\"></td><td><pre></pre></td></tr><tr><td data-num=\"362\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_VERNEEDNUM<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"363\"></td><td><pre>        verneed_cnt_ <span class=\"token operator\">=</span> d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"364\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"365\"></td><td><pre></pre></td></tr><tr><td data-num=\"366\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_RUNPATH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"367\"></td><td><pre>        <span class=\"token comment\">// this is parsed after we have strtab initialized (see below).</span></pre></td></tr><tr><td data-num=\"368\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"369\"></td><td><pre></pre></td></tr><tr><td data-num=\"370\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_TLSDESC_GOT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"371\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_TLSDESC_PLT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"372\"></td><td><pre>        <span class=\"token comment\">// These DT entries are used for lazy TLSDESC relocations. Bionic</span></pre></td></tr><tr><td data-num=\"373\"></td><td><pre>        <span class=\"token comment\">// resolves everything eagerly, so these can be ignored.</span></pre></td></tr><tr><td data-num=\"374\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"375\"></td><td><pre></pre></td></tr><tr><td data-num=\"376\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__aarch64__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"377\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_AARCH64_BTI_PLT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"378\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_AARCH64_PAC_PLT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"379\"></td><td><pre>      <span class=\"token keyword\">case</span> DT_AARCH64_VARIANT_PCS<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"380\"></td><td><pre>        <span class=\"token comment\">// Ignored: AArch64 processor-specific dynamic array tags.</span></pre></td></tr><tr><td data-num=\"381\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"382\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"383\"></td><td><pre></pre></td></tr><tr><td data-num=\"384\"></td><td><pre>      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"385\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>relocating_linker<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"386\"></td><td><pre>          <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> tag_name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"387\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">==</span> DT_RPATH<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"388\"></td><td><pre>            tag_name <span class=\"token operator\">=</span> <span class=\"token string\">\"DT_RPATH\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"389\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">==</span> DT_ENCODING<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"390\"></td><td><pre>            tag_name <span class=\"token operator\">=</span> <span class=\"token string\">\"DT_ENCODING\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"391\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">>=</span> DT_LOOS <span class=\"token operator\">&amp;&amp;</span> d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">&lt;=</span> DT_HIOS<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"392\"></td><td><pre>            tag_name <span class=\"token operator\">=</span> <span class=\"token string\">\"unknown OS-specific\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"393\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">>=</span> DT_LOPROC <span class=\"token operator\">&amp;&amp;</span> d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">&lt;=</span> DT_HIPROC<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"394\"></td><td><pre>            tag_name <span class=\"token operator\">=</span> <span class=\"token string\">\"unknown processor-specific\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"395\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"396\"></td><td><pre>            tag_name <span class=\"token operator\">=</span> <span class=\"token string\">\"unknown\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"397\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"398\"></td><td><pre>          <span class=\"token function\">DL_WARN</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Warning: \\\"%s\\\" unused DT entry: %s (type %p arg %p) (ignoring)\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"399\"></td><td><pre>                  <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"400\"></td><td><pre>                  tag_name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"401\"></td><td><pre>                  reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"402\"></td><td><pre>                  reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"403\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"404\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"405\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"406\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"407\"></td><td><pre></pre></td></tr><tr><td data-num=\"408\"></td><td><pre>  <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"si->base = %p, si->strtab = %p, si->symtab = %p\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"409\"></td><td><pre>        reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> strtab_<span class=\"token punctuation\">,</span> symtab_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"410\"></td><td><pre></pre></td></tr><tr><td data-num=\"411\"></td><td><pre>  <span class=\"token comment\">// Validity checks.</span></pre></td></tr><tr><td data-num=\"412\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>relocating_linker <span class=\"token operator\">&amp;&amp;</span> needed_count <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"413\"></td><td><pre>    <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"linker cannot have DT_NEEDED dependencies on other libraries\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"414\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"415\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"416\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nbucket_ <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> gnu_nbucket_ <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"417\"></td><td><pre>    <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"empty/missing DT_HASH/DT_GNU_HASH in \\\"%s\\\" \"</span></pre></td></tr><tr><td data-num=\"418\"></td><td><pre>        <span class=\"token string\">\"(new hash type from the future?)\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"419\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"420\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"421\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>strtab_ <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"422\"></td><td><pre>    <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"empty/missing DT_STRTAB in \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"423\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"424\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"425\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>symtab_ <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"426\"></td><td><pre>    <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"empty/missing DT_SYMTAB in \\\"%s\\\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"427\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"428\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"429\"></td><td><pre></pre></td></tr><tr><td data-num=\"430\"></td><td><pre>  <span class=\"token comment\">// Second pass - parse entries relying on strtab. Skip this while relocating the linker so as to</span></pre></td></tr><tr><td data-num=\"431\"></td><td><pre>  <span class=\"token comment\">// avoid doing heap allocations until later in the linker's initialization.</span></pre></td></tr><tr><td data-num=\"432\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>relocating_linker<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"433\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Dyn<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> d <span class=\"token operator\">=</span> dynamic<span class=\"token punctuation\">;</span> d<span class=\"token operator\">-></span>d_tag <span class=\"token operator\">!=</span> DT_NULL<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>d<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"434\"></td><td><pre>      <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_tag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"435\"></td><td><pre>        <span class=\"token keyword\">case</span> DT_SONAME<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"436\"></td><td><pre>          <span class=\"token function\">set_soname</span><span class=\"token punctuation\">(</span><span class=\"token function\">get_string</span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"437\"></td><td><pre>          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"438\"></td><td><pre>        <span class=\"token keyword\">case</span> DT_RUNPATH<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"439\"></td><td><pre>          <span class=\"token function\">set_dt_runpath</span><span class=\"token punctuation\">(</span><span class=\"token function\">get_string</span><span class=\"token punctuation\">(</span>d<span class=\"token operator\">-></span>d_un<span class=\"token punctuation\">.</span>d_val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"440\"></td><td><pre>          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"441\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"442\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"443\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"444\"></td><td><pre></pre></td></tr><tr><td data-num=\"445\"></td><td><pre>  <span class=\"token comment\">// Before M release, linker was using basename in place of soname. In the case when DT_SONAME is</span></pre></td></tr><tr><td data-num=\"446\"></td><td><pre>  <span class=\"token comment\">// absent some apps stop working because they can't find DT_NEEDED library by soname. This</span></pre></td></tr><tr><td data-num=\"447\"></td><td><pre>  <span class=\"token comment\">// workaround should keep them working. (Applies only for apps targeting sdk version &lt; M.) Make</span></pre></td></tr><tr><td data-num=\"448\"></td><td><pre>  <span class=\"token comment\">// an exception for the main executable, which does not need to have DT_SONAME. The linker has an</span></pre></td></tr><tr><td data-num=\"449\"></td><td><pre>  <span class=\"token comment\">// DT_SONAME but the soname_ field is initialized later on.</span></pre></td></tr><tr><td data-num=\"450\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>soname_<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> this <span class=\"token operator\">!=</span> <span class=\"token function\">solist_get_somain</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>relocating_linker <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"451\"></td><td><pre>      <span class=\"token function\">get_application_target_sdk_version</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">23</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"452\"></td><td><pre>    soname_ <span class=\"token operator\">=</span> <span class=\"token function\">basename</span><span class=\"token punctuation\">(</span>realpath_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"453\"></td><td><pre>    <span class=\"token function\">DL_WARN_documented_change</span><span class=\"token punctuation\">(</span><span class=\"token number\">23</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"missing-soname-enforced-for-api-level-23\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"454\"></td><td><pre>                              <span class=\"token string\">\"\\\"%s\\\" has no DT_SONAME (will use %s instead)\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"455\"></td><td><pre>                              soname_<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"456\"></td><td><pre></pre></td></tr><tr><td data-num=\"457\"></td><td><pre>    <span class=\"token comment\">// Don't call add_dlwarning because a missing DT_SONAME isn't important enough to show in the UI</span></pre></td></tr><tr><td data-num=\"458\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"459\"></td><td><pre></pre></td></tr><tr><td data-num=\"460\"></td><td><pre>  <span class=\"token comment\">// Validate each library's verdef section once, so we don't have to validate</span></pre></td></tr><tr><td data-num=\"461\"></td><td><pre>  <span class=\"token comment\">// it each time we look up a symbol with a version.</span></pre></td></tr><tr><td data-num=\"462\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">validate_verdef_section</span><span class=\"token punctuation\">(</span>this<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"463\"></td><td><pre></pre></td></tr><tr><td data-num=\"464\"></td><td><pre>  flags_ <span class=\"token operator\">|=</span> FLAG_PRELINKED<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"465\"></td><td><pre>  <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"466\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"æ„é€ å…¨å±€ç»„\"><a class=\"anchor\" href=\"#æ„é€ å…¨å±€ç»„\">#</a> æ„é€ å…¨å±€ç»„</h3>\n<p>è¿™ä¸€æ­¥ä¸ºé¢„é“¾æ¥çš„ä¾èµ–åº“è®¾ç½® <code>DF_1_GLOBAL</code>  å…¨å±€æ ‡å¿—ï¼Œæ¥æ ‡è®°è¿™ä¸ªåº“åœ¨å…¨å±€ç»„ä¸­</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Step 4: Construct the global group. DF_1_GLOBAL bit is force set for LD_PRELOADed libs because</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// they must be added to the global group. Note: The DF_1_GLOBAL bit for a library is normally set</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// in step 3.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ld_preloads <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;&amp;</span> si <span class=\"token operator\">:</span> <span class=\"token operator\">*</span>ld_preloads<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        si<span class=\"token operator\">-></span><span class=\"token function\">set_dt_flags_1</span><span class=\"token punctuation\">(</span>si<span class=\"token operator\">-></span><span class=\"token function\">get_dt_flags_1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> DF_1_GLOBAL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"æ”¶é›†local_groupsçš„æ ¹èŠ‚ç‚¹\"><a class=\"anchor\" href=\"#æ”¶é›†local_groupsçš„æ ¹èŠ‚ç‚¹\">#</a> æ”¶é›† local_groups çš„æ ¹èŠ‚ç‚¹</h3>\n<p>çœ‹æ³¨é‡Šæ„Ÿè§‰æŒºæŠ½è±¡çš„ï¼Œæ„Ÿè§‰æ˜¯ä¸ºäº†ä¿è¯å¯ä»¥é“¾æ¥åˆ°åˆ«çš„ namespace é‡Œé¢çš„ä¾èµ–åº“</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Step 5: Collect roots of local_groups.</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// Whenever needed_by->si link crosses a namespace boundary it forms its own local_group.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// Here we collect new roots to link them separately later on. Note that we need to avoid</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// collecting duplicates. Also the order is important. They need to be linked in the same</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// BFS order we link individual libraries.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span>soinfo<span class=\"token operator\">*</span><span class=\"token operator\">></span> local_group_roots<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>start_with <span class=\"token operator\">!=</span> nullptr <span class=\"token operator\">&amp;&amp;</span> add_as_children<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    local_group_roots<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>start_with<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">CHECK</span><span class=\"token punctuation\">(</span>soinfos_count <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    local_group_roots<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>soinfos<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;&amp;</span> task <span class=\"token operator\">:</span> load_tasks<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    soinfo<span class=\"token operator\">*</span> si <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_soinfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    soinfo<span class=\"token operator\">*</span> needed_by <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_needed_by</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    bool is_dt_needed <span class=\"token operator\">=</span> needed_by <span class=\"token operator\">!=</span> nullptr <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>needed_by <span class=\"token operator\">!=</span> start_with <span class=\"token operator\">||</span> add_as_children<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token class-name\">android_namespace_t</span><span class=\"token operator\">*</span> needed_by_ns <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        is_dt_needed <span class=\"token operator\">?</span> needed_by<span class=\"token operator\">-></span><span class=\"token function\">get_primary_namespace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> ns<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>si<span class=\"token operator\">-></span><span class=\"token function\">is_linked</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> si<span class=\"token operator\">-></span><span class=\"token function\">get_primary_namespace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> needed_by_ns<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">auto</span> it <span class=\"token operator\">=</span> std<span class=\"token operator\">::</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>local_group_roots<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> local_group_roots<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>               <span class=\"token string\">\"Crossing namespace boundary (si=%s@%p, si_ns=%s@%p, needed_by=%s@%p, ns=%s@%p, needed_by_ns=%s@%p) adding to local_group_roots: %s\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>               si<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>               si<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>               si<span class=\"token operator\">-></span><span class=\"token function\">get_primary_namespace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>               si<span class=\"token operator\">-></span><span class=\"token function\">get_primary_namespace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>               needed_by <span class=\"token operator\">==</span> nullptr <span class=\"token operator\">?</span> <span class=\"token string\">\"(nullptr)\"</span> <span class=\"token operator\">:</span> needed_by<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>               needed_by<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>               ns<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>               ns<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>               needed_by_ns<span class=\"token operator\">-></span><span class=\"token function\">get_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>               needed_by_ns<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>               it <span class=\"token operator\">==</span> local_group_roots<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token string\">\"yes\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"no\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>it <span class=\"token operator\">==</span> local_group_roots<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            local_group_roots<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"é“¾æ¥æ‰€æœ‰çš„local-groups\"><a class=\"anchor\" href=\"#é“¾æ¥æ‰€æœ‰çš„local-groups\">#</a> é“¾æ¥æ‰€æœ‰çš„ local groups</h3>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Step 6: Link all local groups</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span> root <span class=\"token operator\">:</span> local_group_roots<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">soinfo_list_t</span> local_group<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">android_namespace_t</span><span class=\"token operator\">*</span> local_group_ns <span class=\"token operator\">=</span> root<span class=\"token operator\">-></span><span class=\"token function\">get_primary_namespace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">walk_dependencies_tree</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                           <span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>soinfo<span class=\"token operator\">*</span> si<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                               <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>local_group_ns<span class=\"token operator\">-></span><span class=\"token function\">is_accessible</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                                   local_group<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                                   <span class=\"token keyword\">return</span> kWalkContinue<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                               <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                                   <span class=\"token keyword\">return</span> kWalkSkip<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                               <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                           <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// è·å–å…¨å±€ç»„åŒ…å«çš„ soinfoï¼Œå› ä¸ºé¢„åŠ è½½åº“æ˜¯ä¸€èµ·åŠ è½½çš„è·Ÿ local_group_ns æ˜¯åŒä¸€ä¸ªå‘½åç©ºé—´</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// æ‰€æœ‰è¿™é‡Œçš„å…¨å±€ç»„å·²ç»åŒ…å«äº†é¢„åŠ è½½åº“</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token class-name\">soinfo_list_t</span> global_group <span class=\"token operator\">=</span> local_group_ns<span class=\"token operator\">-></span><span class=\"token function\">get_global_group</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">// å°†æœ¬åœ°ç»„å’Œå…¨å±€ç»„éƒ½æ·»åŠ åˆ° lookup_list ä¸­</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    SymbolLookupList <span class=\"token function\">lookup_list</span><span class=\"token punctuation\">(</span>global_group<span class=\"token punctuation\">,</span> local_group<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    soinfo<span class=\"token operator\">*</span> local_group_root <span class=\"token operator\">=</span> local_group<span class=\"token punctuation\">.</span><span class=\"token function\">front</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    bool linked <span class=\"token operator\">=</span> local_group<span class=\"token punctuation\">.</span><span class=\"token function\">visit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>soinfo<span class=\"token operator\">*</span> si<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token comment\">// Even though local group may contain accessible soinfos from other namespaces</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token comment\">// we should avoid linking them (because if they are not linked -> they</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token comment\">// are in the local_group_roots and will be linked later).</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>si<span class=\"token operator\">-></span><span class=\"token function\">is_linked</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> si<span class=\"token operator\">-></span><span class=\"token function\">get_primary_namespace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> local_group_ns<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            <span class=\"token keyword\">const</span> android_dlextinfo<span class=\"token operator\">*</span> link_extinfo <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>si <span class=\"token operator\">==</span> soinfos<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> reserved_address_recursive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token comment\">// Only forward extinfo for the first library unless the recursive</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token comment\">// flag is set.</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                link_extinfo <span class=\"token operator\">=</span> extinfo<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">__libc_shared_globals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>load_hook<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                <span class=\"token function\">__libc_shared_globals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">load_hook</span><span class=\"token punctuation\">(</span>si<span class=\"token operator\">-></span>load_bias<span class=\"token punctuation\">,</span> si<span class=\"token operator\">-></span>phdr<span class=\"token punctuation\">,</span> si<span class=\"token operator\">-></span>phnum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            lookup_list<span class=\"token punctuation\">.</span><span class=\"token function\">set_dt_symbolic_lib</span><span class=\"token punctuation\">(</span>si<span class=\"token operator\">-></span>has_DT_SYMBOLIC <span class=\"token operator\">?</span> si <span class=\"token operator\">:</span> nullptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token comment\">// è°ƒç”¨ link_image å¼€å§‹è¿›è¡Œä¾èµ–åº“çš„åŠ¨æ€é“¾æ¥ï¼Œé‡å®šä½ç­‰å·¥ä½œ</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>si<span class=\"token operator\">-></span><span class=\"token function\">link_image</span><span class=\"token punctuation\">(</span>lookup_list<span class=\"token punctuation\">,</span> local_group_root<span class=\"token punctuation\">,</span> link_extinfo<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>relro_fd_offset<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token operator\">!</span><span class=\"token function\">get_cfi_shadow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">AfterLoad</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">,</span> <span class=\"token function\">solist_get_head</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>linked<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å½“æŠŠæ‰€æœ‰çš„æœ¬åœ°ç»„å’Œå…¨å±€ç»„åŠ å…¥åˆ° <code>lookup_list</code>  ä¸­åï¼Œå°±å¼€å§‹è°ƒç”¨ <code>si-&gt;link_image</code>  æ¥å¯¹è¿™äº›åº“è¿›è¡Œé“¾æ¥çš„æ“ä½œ</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>bool soinfo<span class=\"token operator\">::</span><span class=\"token function\">link_image</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> SymbolLookupList<span class=\"token operator\">&amp;</span> lookup_list<span class=\"token punctuation\">,</span> soinfo<span class=\"token operator\">*</span> local_group_root<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>                        <span class=\"token keyword\">const</span> android_dlextinfo<span class=\"token operator\">*</span> extinfo<span class=\"token punctuation\">,</span> <span class=\"token class-name\">size_t</span><span class=\"token operator\">*</span> relro_fd_offset<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">is_image_linked</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// already linked.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>g_is_ldd <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">is_main_executable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">async_safe_format_fd</span><span class=\"token punctuation\">(</span>STDOUT_FILENO<span class=\"token punctuation\">,</span> <span class=\"token string\">\"\\t%s => %s (%p)\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_soname</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                         <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  local_group_root_ <span class=\"token operator\">=</span> local_group_root<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>local_group_root_ <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    local_group_root_ <span class=\"token operator\">=</span> this<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>flags_ <span class=\"token operator\">&amp;</span> FLAG_LINKER<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> local_group_root_ <span class=\"token operator\">==</span> this<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    target_sdk_version_ <span class=\"token operator\">=</span> <span class=\"token function\">get_application_target_sdk_version</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">// è¿›è¡Œç¬¦å·çš„é‡å®šä½</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">relocate</span><span class=\"token punctuation\">(</span>lookup_list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[ finished linking %s ]\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>åœ¨ <code>soinfo::link_image</code>  ä¸­è°ƒç”¨äº† <code>relocate</code>  å»è¿›è¡Œç¬¦å·çš„é‡å®šä½</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_relocate.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>bool soinfo<span class=\"token operator\">::</span><span class=\"token function\">relocate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> SymbolLookupList<span class=\"token operator\">&amp;</span> lookup_list<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  VersionTracker version_tracker<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>version_tracker<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span>this<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  Relocator <span class=\"token function\">relocator</span><span class=\"token punctuation\">(</span>version_tracker<span class=\"token punctuation\">,</span> lookup_list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  relocator<span class=\"token punctuation\">.</span>si <span class=\"token operator\">=</span> this<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">//`.strtab` èŠ‚ä¿å­˜çš„æ˜¯ç¬¦å·å­—ç¬¦ä¸²è¡¨ï¼Œè¡¨ä¸­çš„å†…å®¹ä¼šè¢« `.symtab` çš„ `ElfN_Sym` ç»“æ„ä¸­çš„ `st_name` å¼•ç”¨</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  relocator<span class=\"token punctuation\">.</span>si_strtab <span class=\"token operator\">=</span> strtab_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  relocator<span class=\"token punctuation\">.</span>si_strtab_size <span class=\"token operator\">=</span> <span class=\"token function\">has_min_version</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> strtab_size_ <span class=\"token operator\">:</span> SIZE_MAX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">//`.symtab` èŠ‚æ˜¯ä¸€ä¸ª `ElfN_Sym` çš„æ•°ç»„ï¼Œä¿å­˜äº†ç¬¦å·ä¿¡æ¯</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  relocator<span class=\"token punctuation\">.</span>si_symtab <span class=\"token operator\">=</span> symtab_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  relocator<span class=\"token punctuation\">.</span>tlsdesc_args <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>tlsdesc_args_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  relocator<span class=\"token punctuation\">.</span>tls_tp_base <span class=\"token operator\">=</span> <span class=\"token function\">__libc_shared_globals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>static_tls_layout<span class=\"token punctuation\">.</span><span class=\"token function\">offset_thread_pointer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token comment\">////android_relocs_åœ¨ prelink_image () ä¸­è®¾ç½®ï¼ŒåŠ¨æ€èŠ‚æœ‰ DT_ANDROID_REL æ‰ä¼šè®¾ç½®</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>android_relocs_ <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">// check signature</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>android_relocs_size_ <span class=\"token operator\">></span> <span class=\"token number\">3</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        android_relocs_<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token char\">'A'</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        android_relocs_<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token char\">'P'</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        android_relocs_<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token char\">'S'</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        android_relocs_<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token char\">'2'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[ android relocating %s ]\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token keyword\">const</span> <span class=\"token class-name\">uint8_t</span><span class=\"token operator\">*</span> packed_relocs <span class=\"token operator\">=</span> android_relocs_ <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token keyword\">const</span> <span class=\"token class-name\">size_t</span> packed_relocs_size <span class=\"token operator\">=</span> android_relocs_size_ <span class=\"token operator\">-</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>packed_relocate<span class=\"token operator\">&lt;</span>RelocMode<span class=\"token operator\">::</span>Typical<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">,</span> <span class=\"token function\">sleb128_decoder</span><span class=\"token punctuation\">(</span>packed_relocs<span class=\"token punctuation\">,</span> packed_relocs_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bad android relocation header.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>relr_ <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[ relocating %s relr ]\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">relocate_relr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>USE_RELA<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rela_ <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[ relocating %s rela ]\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>plain_relocate<span class=\"token operator\">&lt;</span>RelocMode<span class=\"token operator\">::</span>Typical<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">,</span> rela_<span class=\"token punctuation\">,</span> rela_count_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>plt_rela_ <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[ relocating %s plt rela ]\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>plain_relocate<span class=\"token operator\">&lt;</span>RelocMode<span class=\"token operator\">::</span>JumpTable<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">,</span> plt_rela_<span class=\"token punctuation\">,</span> plt_rela_count_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>rel_ <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[ relocating %s rel ]\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>plain_relocate<span class=\"token operator\">&lt;</span>RelocMode<span class=\"token operator\">::</span>Typical<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">,</span> rel_<span class=\"token punctuation\">,</span> rel_count_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>plt_rel_ <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token function\">DEBUG</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[ relocating %s plt rel ]\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>plain_relocate<span class=\"token operator\">&lt;</span>RelocMode<span class=\"token operator\">::</span>JumpTable<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">,</span> plt_rel_<span class=\"token punctuation\">,</span> plt_rel_count_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  <span class=\"token comment\">// Once the tlsdesc_args_ vector's size is finalized, we can write the addresses of its elements</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  <span class=\"token comment\">// into the TLSDESC relocations.</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__aarch64__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  <span class=\"token comment\">// Bionic currently only implements TLSDESC for arm64.</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>pair<span class=\"token operator\">&lt;</span>TlsDescriptor<span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> pair <span class=\"token operator\">:</span> relocator<span class=\"token punctuation\">.</span>deferred_tlsdesc_relocs<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    TlsDescriptor<span class=\"token operator\">*</span> desc <span class=\"token operator\">=</span> pair<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    desc<span class=\"token operator\">-></span>func <span class=\"token operator\">=</span> tlsdesc_resolver_dynamic<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    desc<span class=\"token operator\">-></span>arg <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>tlsdesc_args_<span class=\"token punctuation\">[</span>pair<span class=\"token punctuation\">.</span>second<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>éšåä¾æ¬¡è°ƒç”¨äº† <code>plain_relocate-&gt;plain_relocate_impl-&gt;process_relocation</code></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>template <span class=\"token operator\">&lt;</span>RelocMode OptMode<span class=\"token punctuation\">,</span> typename <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>Args<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> bool <span class=\"token function\">plain_relocate</span><span class=\"token punctuation\">(</span>Relocator<span class=\"token operator\">&amp;</span> relocator<span class=\"token punctuation\">,</span> Args <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">needs_slow_relocate_loop</span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      plain_relocate_impl<span class=\"token operator\">&lt;</span>RelocMode<span class=\"token operator\">::</span>General<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      plain_relocate_impl<span class=\"token operator\">&lt;</span>OptMode<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>template <span class=\"token operator\">&lt;</span>RelocMode Mode<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>noinline<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">static</span> bool <span class=\"token function\">plain_relocate_impl</span><span class=\"token punctuation\">(</span>Relocator<span class=\"token operator\">&amp;</span> relocator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">rel_t</span><span class=\"token operator\">*</span> rels<span class=\"token punctuation\">,</span> <span class=\"token class-name\">size_t</span> rel_count<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">size_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> rel_count<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>process_relocation<span class=\"token operator\">&lt;</span>Mode<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">,</span> rels<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>template <span class=\"token operator\">&lt;</span>RelocMode Mode<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token keyword\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>always_inline<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> bool <span class=\"token function\">process_relocation</span><span class=\"token punctuation\">(</span>Relocator<span class=\"token operator\">&amp;</span> relocator<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">rel_t</span><span class=\"token operator\">&amp;</span> reloc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">return</span> Mode <span class=\"token operator\">==</span> RelocMode<span class=\"token operator\">::</span>General <span class=\"token operator\">?</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token function\">process_relocation_general</span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">,</span> reloc<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      process_relocation_impl<span class=\"token operator\">&lt;</span>Mode<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">,</span> reloc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æœ€ç»ˆåœ¨ <code>process_relocation_impl</code>  å®ç°äº†ç¬¦å·çš„é‡å®šå‘å¹¶è°ƒç”¨ <code>lookup_symbol</code>  æ¥æŸ¥æ‰¾ç¬¦å·</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>template <span class=\"token operator\">&lt;</span>RelocMode Mode<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>always_inline<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">static</span> bool <span class=\"token function\">process_relocation_impl</span><span class=\"token punctuation\">(</span>Relocator<span class=\"token operator\">&amp;</span> relocator<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token class-name\">rel_t</span><span class=\"token operator\">&amp;</span> reloc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  constexpr bool IsGeneral <span class=\"token operator\">=</span> Mode <span class=\"token operator\">==</span> RelocMode<span class=\"token operator\">::</span>General<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> <span class=\"token keyword\">const</span> rel_target <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>reloc<span class=\"token punctuation\">.</span>r_offset <span class=\"token operator\">+</span> relocator<span class=\"token punctuation\">.</span>si<span class=\"token operator\">-></span>load_bias<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token class-name\">uint32_t</span> r_type <span class=\"token operator\">=</span> <span class=\"token function\">ELFW</span><span class=\"token punctuation\">(</span>R_TYPE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>reloc<span class=\"token punctuation\">.</span>r_info<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token class-name\">uint32_t</span> r_sym <span class=\"token operator\">=</span> <span class=\"token function\">ELFW</span><span class=\"token punctuation\">(</span>R_SYM<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>reloc<span class=\"token punctuation\">.</span>r_info<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  soinfo<span class=\"token operator\">*</span> found_in <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Sym<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> sym <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> sym_name <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> sym_addr <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>r_sym <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  \t<span class=\"token comment\">// è·å–é‡å®šå‘çš„ç¬¦å·å</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    sym_name <span class=\"token operator\">=</span> relocator<span class=\"token punctuation\">.</span><span class=\"token function\">get_string</span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">.</span>si_symtab<span class=\"token punctuation\">[</span>r_sym<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>st_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>USE_RELA<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">auto</span> get_addend_rel   <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> reloc<span class=\"token punctuation\">.</span>r_addend<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">auto</span> get_addend_norel <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> reloc<span class=\"token punctuation\">.</span>r_addend<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token keyword\">auto</span> get_addend_rel   <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token operator\">*</span>static_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>rel_target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">auto</span> get_addend_norel <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>IsGeneral <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">is_tls_reloc</span><span class=\"token punctuation\">(</span>r_type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>r_sym <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token comment\">// Do nothing.</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token comment\">// åˆ©ç”¨ lookup_symbol æ¥æŸ¥æ‰¾ç¬¦å·</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>lookup_symbol<span class=\"token operator\">&lt;</span>IsGeneral<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">,</span> r_sym<span class=\"token punctuation\">,</span> sym_name<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>found_in<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>sym<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sym <span class=\"token operator\">!=</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token keyword\">const</span> bool should_protect_segments <span class=\"token operator\">=</span> handle_text_relocs <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                                             found_in <span class=\"token operator\">==</span> relocator<span class=\"token punctuation\">.</span>si <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                                             <span class=\"token function\">ELF_ST_TYPE</span><span class=\"token punctuation\">(</span>sym<span class=\"token operator\">-></span>st_info<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> STT_GNU_IFUNC<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>should_protect_segments <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">protect_segments</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        sym_addr <span class=\"token operator\">=</span> found_in<span class=\"token operator\">-></span><span class=\"token function\">resolve_symbol_address</span><span class=\"token punctuation\">(</span>sym<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>should_protect_segments <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">unprotect_segments</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token function\">constexpr</span> <span class=\"token punctuation\">(</span>IsGeneral<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token comment\">// A weak reference to an undefined symbol. We typically use a zero symbol address, but</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token comment\">// use the relocation base for PC-relative relocations, so that the value written is zero.</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>r_type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__x86_64__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          <span class=\"token keyword\">case</span> R_X86_64_PC32<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            sym_addr <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>rel_target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">elif</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>__i386__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          <span class=\"token keyword\">case</span> R_386_PC32<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            sym_addr <span class=\"token operator\">=</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>rel_target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token comment\">// å¤§éƒ¨åˆ†ç¬¦å·çš„ç±»å‹éƒ½æ˜¯ R_GENERIC_JUMP_SLOT </span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token function\">constexpr</span> <span class=\"token punctuation\">(</span>IsGeneral <span class=\"token operator\">||</span> Mode <span class=\"token operator\">==</span> RelocMode<span class=\"token operator\">::</span>JumpTable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>r_type <span class=\"token operator\">==</span> R_GENERIC_JUMP_SLOT<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      count_relocation_if<span class=\"token operator\">&lt;</span>IsGeneral<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>kRelocAbsolute<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> result <span class=\"token operator\">=</span> sym_addr <span class=\"token operator\">+</span> <span class=\"token function\">get_addend_norel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token function\">trace_reloc</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"RELO JMP_SLOT %16p &lt;- %16p %s\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                  rel_target<span class=\"token punctuation\">,</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> sym_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      <span class=\"token operator\">*</span>static_cast<span class=\"token operator\">&lt;</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>rel_target<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  å…¶ä»–ç±»å‹æˆ–æ¶æ„çš„ç›¸å…³é‡å®šå‘è®¡ç®—çœç•¥\t</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>åœ¨ <code>lookup_symbol</code>  ä¸­è°ƒç”¨äº† <code>soinfo_do_lookup</code>  æ¥æŸ¥æ‰¾ç¬¦å·</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>template <span class=\"token operator\">&lt;</span>bool DoLogging<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>always_inline<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">inline</span> bool <span class=\"token function\">lookup_symbol</span><span class=\"token punctuation\">(</span>Relocator<span class=\"token operator\">&amp;</span> relocator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">uint32_t</span> r_sym<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> sym_name<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                 soinfo<span class=\"token operator\">*</span><span class=\"token operator\">*</span> found_in<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Sym<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token operator\">*</span> sym<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">//relocator æ˜¯å‰é¢ä¼ è¿›æ¥åŒ…å«å…¨å±€ç»„å’Œæœ¬åœ°ç»„çš„ soinfosï¼Œå…¨å±€ç»„æ’åœ¨æœ€å‰é¢</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// å¦‚æœä¸Šä¸€æ¬¡å·²ç»æŸ¥æ‰¾è¿‡è¿™ä¸ªç¬¦å·ï¼Œé‚£ä¹ˆä¹…æ²¡æœ‰å¿…è¦å†æŸ¥æ‰¾ä¸€æ¬¡</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>r_sym <span class=\"token operator\">==</span> relocator<span class=\"token punctuation\">.</span>cache_sym_val<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token operator\">*</span>found_in <span class=\"token operator\">=</span> relocator<span class=\"token punctuation\">.</span>cache_si<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token operator\">*</span>sym <span class=\"token operator\">=</span> relocator<span class=\"token punctuation\">.</span>cache_sym<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    count_relocation_if<span class=\"token operator\">&lt;</span>DoLogging<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>kRelocSymbolCached<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">const</span> version_info<span class=\"token operator\">*</span> vi <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>relocator<span class=\"token punctuation\">.</span>si<span class=\"token operator\">-></span><span class=\"token function\">lookup_version_info</span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">.</span>version_tracker<span class=\"token punctuation\">,</span> r_sym<span class=\"token punctuation\">,</span> sym_name<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>vi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    soinfo<span class=\"token operator\">*</span> local_found_in <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token comment\">// æœ€ç»ˆè°ƒç”¨ soinfo_do_lookup æ¥æŸ¥æ‰¾ç¬¦å·</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Sym<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> local_sym <span class=\"token operator\">=</span> <span class=\"token function\">soinfo_do_lookup</span><span class=\"token punctuation\">(</span>sym_name<span class=\"token punctuation\">,</span> vi<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>local_found_in<span class=\"token punctuation\">,</span> relocator<span class=\"token punctuation\">.</span>lookup_list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    relocator<span class=\"token punctuation\">.</span>cache_sym_val <span class=\"token operator\">=</span> r_sym<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    relocator<span class=\"token punctuation\">.</span>cache_si <span class=\"token operator\">=</span> local_found_in<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    relocator<span class=\"token punctuation\">.</span>cache_sym <span class=\"token operator\">=</span> local_sym<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token operator\">*</span>found_in <span class=\"token operator\">=</span> local_found_in<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token operator\">*</span>sym <span class=\"token operator\">=</span> local_sym<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>sym <span class=\"token operator\">==</span> nullptr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">ELF_ST_BIND</span><span class=\"token punctuation\">(</span>relocator<span class=\"token punctuation\">.</span>si_symtab<span class=\"token punctuation\">[</span>r_sym<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>st_info<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> STB_WEAK<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token function\">DL_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cannot locate symbol \\\"%s\\\" referenced by \\\"%s\\\"...\"</span><span class=\"token punctuation\">,</span> sym_name<span class=\"token punctuation\">,</span> relocator<span class=\"token punctuation\">.</span>si<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  count_relocation_if<span class=\"token operator\">&lt;</span>DoLogging<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>kRelocSymbol<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>åœ¨ <code>soinfo_do_lookup</code>  ä¸­æœ€ç»ˆè°ƒç”¨æ¨¡æ¿å‡½æ•° <code>soinfo_do_lookup_impl</code>  è¿›è¡Œç¬¦å·æŸ¥æ‰¾</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker_soinfo.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Sym<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> <span class=\"token function\">soinfo_do_lookup</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> version_info<span class=\"token operator\">*</span> vi<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                  soinfo<span class=\"token operator\">*</span><span class=\"token operator\">*</span> si_found_in<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> SymbolLookupList<span class=\"token operator\">&amp;</span> lookup_list<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">return</span> lookup_list<span class=\"token punctuation\">.</span><span class=\"token function\">needs_slow_path</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      soinfo_do_lookup_impl<span class=\"token operator\">&lt;</span>true<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> vi<span class=\"token punctuation\">,</span> si_found_in<span class=\"token punctuation\">,</span> lookup_list<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      soinfo_do_lookup_impl<span class=\"token operator\">&lt;</span>false<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> vi<span class=\"token punctuation\">,</span> si_found_in<span class=\"token punctuation\">,</span> lookup_list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æœ‰ hash è¡¨æŸ¥ hash è¡¨ï¼Œæ²¡ hash è¡¨ç”¨ç¬¦å·æŸ¥æ‰¾</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>template <span class=\"token operator\">&lt;</span>bool IsGeneral<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>noinline<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Sym<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">soinfo_do_lookup_impl</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> version_info<span class=\"token operator\">*</span> vi<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                      soinfo<span class=\"token operator\">*</span><span class=\"token operator\">*</span> si_found_in<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> SymbolLookupList<span class=\"token operator\">&amp;</span> lookup_list<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">auto</span> <span class=\"token punctuation\">[</span> hash<span class=\"token punctuation\">,</span> name_len <span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">calculate_gnu_hash</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  constexpr <span class=\"token class-name\">uint32_t</span> kBloomMaskBits <span class=\"token operator\">=</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span><span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  SymbolName <span class=\"token function\">elf_symbol_name</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">const</span> SymbolLookupLib<span class=\"token operator\">*</span> end <span class=\"token operator\">=</span> lookup_list<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">const</span> SymbolLookupLib<span class=\"token operator\">*</span> it <span class=\"token operator\">=</span> lookup_list<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">const</span> SymbolLookupLib<span class=\"token operator\">*</span> lib<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token class-name\">uint32_t</span> sym_idx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// Iterate over libraries until we find one whose Bloom filter matches the symbol we're</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// searching for.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">// åœ¨æ¯ä¸€ä¸ªåº“ä¸­éƒ½å»å¯»æ‰¾æœ‰æ²¡æœ‰æŒ‡å®šçš„ç¬¦å·</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>it <span class=\"token operator\">==</span> end<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      lib <span class=\"token operator\">=</span> it<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t  <span class=\"token comment\">// è¦æ˜¯æ²¡æœ‰ hash è¡¨ï¼Œå°±é€šè¿‡åç§°æ¥è¿›è¡ŒæŸ¥æ‰¾</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>IsGeneral <span class=\"token operator\">&amp;&amp;</span> lib<span class=\"token operator\">-></span><span class=\"token function\">needs_sysv_lookup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Sym<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> sym <span class=\"token operator\">=</span> lib<span class=\"token operator\">-></span>si_<span class=\"token operator\">-></span><span class=\"token function\">find_symbol_by_name</span><span class=\"token punctuation\">(</span>elf_symbol_name<span class=\"token punctuation\">,</span> vi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          <span class=\"token operator\">*</span>si_found_in <span class=\"token operator\">=</span> lib<span class=\"token operator\">-></span>si_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          <span class=\"token keyword\">return</span> sym<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>IsGeneral<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token function\">TRACE_TYPE</span><span class=\"token punctuation\">(</span>LOOKUP<span class=\"token punctuation\">,</span> <span class=\"token string\">\"SEARCH %s in %s@%p (gnu)\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                   name<span class=\"token punctuation\">,</span> lib<span class=\"token operator\">-></span>si_<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>lib<span class=\"token operator\">-></span>si_<span class=\"token operator\">-></span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t  <span class=\"token comment\">// è®¡ç®—ç¬¦å· hash æ¡¶æŸ¥è¯¢é“¾</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token keyword\">const</span> <span class=\"token class-name\">uint32_t</span> word_num <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>hash <span class=\"token operator\">/</span> kBloomMaskBits<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> lib<span class=\"token operator\">-></span>gnu_maskwords_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Addr<span class=\"token punctuation\">)</span> bloom_word <span class=\"token operator\">=</span> lib<span class=\"token operator\">-></span>gnu_bloom_filter_<span class=\"token punctuation\">[</span>word_num<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token keyword\">const</span> <span class=\"token class-name\">uint32_t</span> h1 <span class=\"token operator\">=</span> hash <span class=\"token operator\">%</span> kBloomMaskBits<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token keyword\">const</span> <span class=\"token class-name\">uint32_t</span> h2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>hash <span class=\"token operator\">>></span> lib<span class=\"token operator\">-></span>gnu_shift2_<span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> kBloomMaskBits<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>bloom_word <span class=\"token operator\">>></span> h1<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>bloom_word <span class=\"token operator\">>></span> h2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        sym_idx <span class=\"token operator\">=</span> lib<span class=\"token operator\">-></span>gnu_bucket_<span class=\"token punctuation\">[</span>hash <span class=\"token operator\">%</span> lib<span class=\"token operator\">-></span>gnu_nbucket_<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sym_idx <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>IsGeneral<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token function\">TRACE_TYPE</span><span class=\"token punctuation\">(</span>LOOKUP<span class=\"token punctuation\">,</span> <span class=\"token string\">\"NOT FOUND %s in %s@%p\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                   name<span class=\"token punctuation\">,</span> lib<span class=\"token operator\">-></span>si_<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>lib<span class=\"token operator\">-></span>si_<span class=\"token operator\">-></span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    <span class=\"token comment\">// Search the library's hash table chain.</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Versym<span class=\"token punctuation\">)</span> verneed <span class=\"token operator\">=</span> kVersymNotNeeded<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    bool calculated_verneed <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    <span class=\"token class-name\">uint32_t</span> chain_value <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token keyword\">const</span> <span class=\"token function\">ElfW</span><span class=\"token punctuation\">(</span>Sym<span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> sym <span class=\"token operator\">=</span> nullptr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t<span class=\"token comment\">//// æ ¹æ®ç¬¦å· hash å¿«é€ŸæŸ¥æ‰¾</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      sym <span class=\"token operator\">=</span> lib<span class=\"token operator\">-></span>symtab_ <span class=\"token operator\">+</span> sym_idx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      chain_value <span class=\"token operator\">=</span> lib<span class=\"token operator\">-></span>gnu_chain_<span class=\"token punctuation\">[</span>sym_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>chain_value <span class=\"token operator\">>></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span>hash <span class=\"token operator\">>></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>vi <span class=\"token operator\">!=</span> nullptr <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>calculated_verneed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          calculated_verneed <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          verneed <span class=\"token operator\">=</span> <span class=\"token function\">find_verdef_version_index</span><span class=\"token punctuation\">(</span>lib<span class=\"token operator\">-></span>si_<span class=\"token punctuation\">,</span> vi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">check_symbol_version</span><span class=\"token punctuation\">(</span>lib<span class=\"token operator\">-></span>versym_<span class=\"token punctuation\">,</span> sym_idx<span class=\"token punctuation\">,</span> verneed<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>            static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>sym<span class=\"token operator\">-></span>st_name<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> name_len <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">&lt;=</span> lib<span class=\"token operator\">-></span>strtab_size_ <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            <span class=\"token function\">memcmp</span><span class=\"token punctuation\">(</span>lib<span class=\"token operator\">-></span>strtab_ <span class=\"token operator\">+</span> sym<span class=\"token operator\">-></span>st_name<span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> name_len <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token function\">is_symbol_global_and_defined</span><span class=\"token punctuation\">(</span>lib<span class=\"token operator\">-></span>si_<span class=\"token punctuation\">,</span> sym<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          <span class=\"token operator\">*</span>si_found_in <span class=\"token operator\">=</span> lib<span class=\"token operator\">-></span>si_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>IsGeneral<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            <span class=\"token function\">TRACE_TYPE</span><span class=\"token punctuation\">(</span>LOOKUP<span class=\"token punctuation\">,</span> <span class=\"token string\">\"FOUND %s in %s (%p) %zd\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                       name<span class=\"token punctuation\">,</span> lib<span class=\"token operator\">-></span>si_<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>sym<span class=\"token operator\">-></span>st_value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>                       static_cast<span class=\"token operator\">&lt;</span><span class=\"token class-name\">size_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>sym<span class=\"token operator\">-></span>st_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          <span class=\"token keyword\">return</span> sym<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      <span class=\"token operator\">++</span>sym_idx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>chain_value <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>IsGeneral<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      <span class=\"token function\">TRACE_TYPE</span><span class=\"token punctuation\">(</span>LOOKUP<span class=\"token punctuation\">,</span> <span class=\"token string\">\"NOT FOUND %s in %s@%p\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                 name<span class=\"token punctuation\">,</span> lib<span class=\"token operator\">-></span>si_<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> reinterpret_cast<span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>lib<span class=\"token operator\">-></span>si_<span class=\"token operator\">-></span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"æ”¶å°¾å·¥ä½œ\"><a class=\"anchor\" href=\"#æ”¶å°¾å·¥ä½œ\">#</a> æ”¶å°¾å·¥ä½œ</h3>\n<p>å¯¹ä¾èµ–åº“çš„é“¾æ¥æƒ…å†µè¿›è¡Œæ ‡è®°ï¼Œå¹¶å¢åŠ ä¾èµ–åº“çš„å¼•ç”¨è®¡æ•°</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// Step 7: Mark all load_tasks as linked and increment refcounts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// for references between load_groups (at this point it does not matter if</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// referenced load_groups were loaded by previous dlopen or as part of this</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">// one on step 6)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>start_with <span class=\"token operator\">!=</span> nullptr <span class=\"token operator\">&amp;&amp;</span> add_as_children<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    start_with<span class=\"token operator\">-></span><span class=\"token function\">set_linked</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;&amp;</span> task <span class=\"token operator\">:</span> load_tasks<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    soinfo<span class=\"token operator\">*</span> si <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_soinfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    si<span class=\"token operator\">-></span><span class=\"token function\">set_linked</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;&amp;</span> task <span class=\"token operator\">:</span> load_tasks<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    soinfo<span class=\"token operator\">*</span> si <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_soinfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    soinfo<span class=\"token operator\">*</span> needed_by <span class=\"token operator\">=</span> task<span class=\"token operator\">-></span><span class=\"token function\">get_needed_by</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>needed_by <span class=\"token operator\">!=</span> nullptr <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        needed_by <span class=\"token operator\">!=</span> start_with <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        needed_by<span class=\"token operator\">-></span><span class=\"token function\">get_local_group_root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> si<span class=\"token operator\">-></span><span class=\"token function\">get_local_group_root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token comment\">// å¢åŠ ä¾èµ–åº“ so çš„å¼•ç”¨è®¡æ•°</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      si<span class=\"token operator\">-></span><span class=\"token function\">increment_ref_count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>è‡³æ­¤ä¸ºæ­¢ï¼Œä¸€ä¸ª so å°±è¢«æˆåŠŸçš„åŠ è½½è¿›æ¥äº†ï½</p>\n<h1 id=\"soçš„å¸è½½è¿‡ç¨‹\"><a class=\"anchor\" href=\"#soçš„å¸è½½è¿‡ç¨‹\">#</a> so çš„å¸è½½è¿‡ç¨‹</h1>\n<p>åœ¨ android ä¸­å¹¶æ²¡æœ‰ç›´æ¥çš„æ¥å£æ¥è®©å¼€å‘è€…å¸è½½ä¸€ä¸ª so, æ‰€ä»¥å¯¹äº so çš„å¸è½½è¿‡ç¨‹æˆ‘ä»¬æ— æ³•ä½¿ç”¨è‡ªä¸Šè€Œä¸‹çš„æ–¹å¼å»åˆ†æï¼Œä½†å¯ä»¥åˆ©ç”¨é€†å‘çš„æ–¹æ³•ï¼Œè‡ªåº•å‘ä¸Šä¸€æ­¥ä¸€æ­¥æ¢ç´¢ so çš„å¸è½½è¿‡ç¨‹ç©¶ç«Ÿæ˜¯ä»€ä¹ˆæ ·å­çš„</p>\n<p>é¦–å…ˆæ•´ç†ä¸€ä¸‹ç›®å‰ä¸ºæ­¢ä» AOSP æºç ä»¥åŠç½‘ä¸Šæ‰¾çš„çº¿ç´¢:</p>\n<ol>\n<li>\n<p>android çš„ so ä¸­æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„å‡½æ•° <code>JNI_OnUnload</code> , å½“ so å¸è½½æ—¶ä¼šè¿›è¡Œè°ƒç”¨</p>\n</li>\n<li>\n<p>åœ¨ AOSP çš„ <code>platform\\bionic\\linker\\linker_soinfo.cpp</code>  ä¸­æœ‰ä¸€ä¸ªå‡½æ•° <code>call_destructors</code> , å®ƒçš„å®Œæ•´ä»£ç å¦‚ä¸‹</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\bionic\\linker\\linker_soinfo.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> soinfo<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">call_destructors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>constructors_called<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ScopedTrace <span class=\"token function\">trace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"calling destructors: \"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// DT_FINI_ARRAY must be parsed in reverse order.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token function\">call_array</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DT_FINI_ARRAY\"</span><span class=\"token punctuation\">,</span> fini_array_<span class=\"token punctuation\">,</span> fini_array_count_<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// DT_FINI should be called after DT_FINI_ARRAY if both are present.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">call_function</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DT_FINI\"</span><span class=\"token punctuation\">,</span> fini_func_<span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å½“è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œä¼šå…ˆè°ƒç”¨ <code>final_array</code>  ä¸­çš„å‡½æ•°ï¼Œæœ€åè°ƒç”¨ <code>final</code>  å‡½æ•° (æ€ä¹ˆå’Œ <code>init</code>  ä¸ <code>init_array</code>  åè¿‡æ¥äº†)</p>\n</li>\n</ol>\n<p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æå‡ºä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼Œæ¥ä¸ºé€†å‘åˆ†æçš„è¿‡ç¨‹æ˜ç¡®ä¸€ä¸ªæ¸…æ™°çš„ç›®æ ‡</p>\n<div class=\"note info\">\n<ul>\n<li>åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ <code>JNI_OnUnload</code>  ä¸ <code>call_destructors</code>  ä¼šè¢«è°ƒç”¨ï¼Ÿ</li>\n<li><code>JNI_OnUnload</code>  å’Œ <code>call_destructors</code>  è°ƒç”¨çš„å…ˆåé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ</li>\n</ul>\n</div>\n<p>å¸¦ç€è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹ <code>JNI_OnUnload</code>  è¿›è¡Œåˆ†æ</p>\n<h2 id=\"jni_onunload\"><a class=\"anchor\" href=\"#jni_onunload\">#</a> JNI_OnUnload</h2>\n<h3 id=\"unloadlibraries\"><a class=\"anchor\" href=\"#unloadlibraries\">#</a> UnloadLibraries</h3>\n<p>android ä¸­å­˜åœ¨ä¸€ä¸ªç‰¹æœ‰çš„å‡½æ•° <code>JNI_OnUnload</code> , å½“è™šæ‹Ÿæœºé‡Šæ”¾è¯¥ so æ—¶ï¼Œæ¥è¿›è¡Œå–„åæ¸…é™¤åŠ¨ä½œï¼Œé€šè¿‡åœ¨<a href=\"cs.android.com\"> android å®˜ç½‘æºç æœç´¢å¹³å°</a>ç¿»äº†å¥½å¤šé¡µçš„æœç´¢ç»“æœï¼Œç»ˆäºæ‰¾åˆ°äº† <code>JNI_OnUnload</code>  çš„<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jcy5hbmRyb2lkLmNvbS9hbmRyb2lkL3BsYXRmb3JtL3N1cGVycHJvamVjdC8rL21hc3RlcjphcnQvcnVudGltZS9qbmkvamF2YV92bV9leHQuY2M7bD0zODM/cT1KTklfb251bmxvYWQmYW1wO3NzPWFuZHJvaWQlMkZwbGF0Zm9ybSUyRnN1cGVycHJvamVjdCZhbXA7aGw9emgtY24mYW1wO3N0YXJ0PTQx\">è°ƒç”¨å‡½æ•°</span>ï¼Œä»–åœ¨ <code>art/runtime/jni/java_vm_ext.cc</code>  ä¸­çš„ <code>UnloadLibraries</code>  ä¸­è¢«è°ƒç”¨</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\art\\runtime\\jni\\java_vm_ext.cc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">UnloadLibraries</span><span class=\"token punctuation\">(</span>JavaVM<span class=\"token operator\">*</span> vm<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>SharedLibrary<span class=\"token operator\">*</span><span class=\"token operator\">></span><span class=\"token operator\">&amp;</span> libraries<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">using</span> JNI_OnUnloadFn <span class=\"token operator\">=</span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>JavaVM<span class=\"token operator\">*</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>SharedLibrary<span class=\"token operator\">*</span> library <span class=\"token operator\">:</span> libraries<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> <span class=\"token keyword\">const</span> sym <span class=\"token operator\">=</span> library<span class=\"token operator\">-></span><span class=\"token function\">FindSymbol</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"JNI_OnUnload\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">,</span> android<span class=\"token double-colon punctuation\">::</span>kJNICallTypeRegular<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sym <span class=\"token operator\">==</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[No JNI_OnUnload found in \\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> library<span class=\"token operator\">-></span><span class=\"token function\">GetPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"]\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[JNI_OnUnload found for \\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> library<span class=\"token operator\">-></span><span class=\"token function\">GetPath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\"]: Calling...\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            JNI_OnUnloadFn jni_on_unload <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">reinterpret_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>JNI_OnUnloadFn<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>sym<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token function\">jni_on_unload</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"unloadnativelibraries\"><a class=\"anchor\" href=\"#unloadnativelibraries\">#</a> UnloadNativeLibraries</h3>\n<p>å†å»çœ‹ä¸€ä¸‹ <code>UnloadLibraries</code>  çš„å¼•ç”¨ï¼Œå®ƒåœ¨ <code>UnloadNativeLibraries</code>  è¢«è°ƒç”¨</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\art\\runtime\\jni\\java_vm_ext.cc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// Unload native libraries with cleared class loaders.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">UnloadNativeLibraries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">REQUIRES</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>Locks<span class=\"token double-colon punctuation\">::</span>jni_libraries_lock_<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token function\">REQUIRES_SHARED</span><span class=\"token punctuation\">(</span>Locks<span class=\"token double-colon punctuation\">::</span>mutator_lock_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    Thread<span class=\"token operator\">*</span> <span class=\"token keyword\">const</span> self <span class=\"token operator\">=</span> <span class=\"token class-name\">Thread</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span>SharedLibrary<span class=\"token operator\">*</span><span class=\"token operator\">></span> unload_libraries<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        MutexLock <span class=\"token function\">mu</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>Locks<span class=\"token double-colon punctuation\">::</span>jni_libraries_lock_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span> it <span class=\"token operator\">=</span> libraries_<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> it <span class=\"token operator\">!=</span> libraries_<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            SharedLibrary<span class=\"token operator\">*</span> <span class=\"token keyword\">const</span> library <span class=\"token operator\">=</span> it<span class=\"token operator\">-></span>second<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token comment\">// If class loader is null then it was unloaded, call JNI_OnUnload.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token keyword\">const</span> jweak class_loader <span class=\"token operator\">=</span> library<span class=\"token operator\">-></span><span class=\"token function\">GetClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token comment\">// If class_loader is a null jobject then it is the boot class loader. We should not unload</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token comment\">// the native libraries of the boot class loader.</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>class_loader <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span> <span class=\"token operator\">&amp;&amp;</span> self<span class=\"token operator\">-></span><span class=\"token function\">IsJWeakCleared</span><span class=\"token punctuation\">(</span>class_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                unload_libraries<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>library<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                it <span class=\"token operator\">=</span> libraries_<span class=\"token punctuation\">.</span><span class=\"token function\">erase</span><span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                <span class=\"token operator\">++</span>it<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    ScopedThreadSuspension <span class=\"token function\">sts</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> kNative<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// Do this without holding the jni libraries lock to prevent possible deadlocks.</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">// è°ƒç”¨ so ä¸­çš„ JNI_OnUnload</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token function\">UnloadLibraries</span><span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span><span class=\"token function\">GetJniEnv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">GetVm</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> unload_libraries<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span> library <span class=\"token operator\">:</span> unload_libraries<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">delete</span> library<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"javavmextunloadnativelibraries\"><a class=\"anchor\" href=\"#javavmextunloadnativelibraries\">#</a> JavaVMExt::UnloadNativeLibraries</h3>\n<p>è¿™é‡Œè°ƒç”¨äº† <code>libraries_</code> ä¸­çš„ <code>UnloadNativeLibraries</code>  å‡½æ•°ï¼Œçœ‹èµ·æ¥å¸è½½çš„è¿‡ç¨‹å’Œ Java è™šæ‹Ÿæœºæœ‰äº›è®¸çš„å…³ç³»</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\art\\runtime\\jni\\java_vm_ext.cc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token class-name\">JavaVMExt</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">UnloadNativeLibraries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  libraries_<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">UnloadNativeLibraries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"heapcollectgarbageinternal\"><a class=\"anchor\" href=\"#heapcollectgarbageinternal\">#</a> Heap::CollectGarbageInternal</h3>\n<p><code>JavaVMExt::UnloadNativeLibraries</code>  åœ¨ <code>Heap::CollectGarbageInternal</code>  çš„æœ«å°¾è¢«è°ƒç”¨</p>\n<p><img data-src=\"/android-load-so/image-20240709133045436.png\" alt=\"image-20240709133045436\" style=\"aspect-ratio:910 / 168;\"></p>\n<p>è¿™å‡½æ•°çœ‹èµ·æ¥å’Œè™šæ‹Ÿæœºå †æ‰§è¡Œåƒåœ¾å›æ”¶æœ‰å…³ï¼Œåƒåœ¾å›æ”¶æ‰§è¡Œå®Œæ¯•åä¼šå»è°ƒç”¨ <code>JNI_OnUnload</code></p>\n<p>ç„¶è€Œå†å¾€ä¸Šå¯»æ‰¾å´æ‰¾ä¸åˆ°ä»€ä¹ˆæœ‰ç”¨çš„å‡½æ•°äº†ï¼Œæˆ‘ä»¬åªçŸ¥é“åœ¨ JVM åƒåœ¾å›æ”¶ä¹‹åä¼šå»è°ƒç”¨ <code>JNI_OnUnload</code></p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\art\\runtime\\gc\\heap.cc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>collector<span class=\"token double-colon punctuation\">::</span>GcType <span class=\"token class-name\">Heap</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">CollectGarbageInternal</span><span class=\"token punctuation\">(</span>collector<span class=\"token double-colon punctuation\">::</span>GcType gc_type<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                               GcCause gc_cause<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                               <span class=\"token keyword\">bool</span> clear_soft_references<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                                               <span class=\"token keyword\">uint32_t</span> requested_gc_num<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  Thread<span class=\"token operator\">*</span> self <span class=\"token operator\">=</span> <span class=\"token class-name\">Thread</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  Runtime<span class=\"token operator\">*</span> runtime <span class=\"token operator\">=</span> <span class=\"token class-name\">Runtime</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// If the heap can't run the GC, silently fail and return that no GC was run.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>gc_type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">case</span> collector<span class=\"token double-colon punctuation\">::</span>kGcTypePartial<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">HasZygoteSpace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// Do not increment gcs_completed_ . We should retry with kGcTypeFull.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token keyword\">return</span> collector<span class=\"token double-colon punctuation\">::</span>kGcTypeNone<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token comment\">// Other GC types don't have any special cases which makes them not runnable. The main case</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token comment\">// here is full GC.</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  ScopedThreadStateChange <span class=\"token function\">tsc</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> kWaitingPerformingGc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  Locks<span class=\"token double-colon punctuation\">::</span>mutator_lock_<span class=\"token operator\">-></span><span class=\"token function\">AssertNotHeld</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self<span class=\"token operator\">-></span><span class=\"token function\">IsHandlingStackOverflow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// If we are throwing a stack overflow error we probably don't have enough remaining stack</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">// space to run the GC.</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">// Count this as a GC in case someone is waiting for it to complete.</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    gcs_completed_<span class=\"token punctuation\">.</span><span class=\"token function\">fetch_add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>memory_order_release<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">return</span> collector<span class=\"token double-colon punctuation\">::</span>kGcTypeNone<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token keyword\">bool</span> compacting_gc<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    gc_complete_lock_<span class=\"token operator\">-></span><span class=\"token function\">AssertNotHeld</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    ScopedThreadStateChange <span class=\"token function\">tsc2</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> kWaitingForGcToComplete<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    MutexLock <span class=\"token function\">mu</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>gc_complete_lock_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token comment\">// Ensure there is only one GC at a time.</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token function\">WaitForGcToCompleteLocked</span><span class=\"token punctuation\">(</span>gc_cause<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>requested_gc_num <span class=\"token operator\">!=</span> GC_NUM_ANY <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">GCNumberLt</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetCurrentGcNum</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> requested_gc_num<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token comment\">// The appropriate GC was already triggered elsewhere.</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token keyword\">return</span> collector<span class=\"token double-colon punctuation\">::</span>kGcTypeNone<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    compacting_gc <span class=\"token operator\">=</span> <span class=\"token function\">IsMovingGc</span><span class=\"token punctuation\">(</span>collector_type_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token comment\">// GC can be disabled if someone has a used GetPrimitiveArrayCritical.</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>compacting_gc <span class=\"token operator\">&amp;&amp;</span> disable_moving_gc_count_ <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token function\">LOG</span><span class=\"token punctuation\">(</span>WARNING<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Skipping GC due to disable moving GC count \"</span> <span class=\"token operator\">&lt;&lt;</span> disable_moving_gc_count_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token comment\">// Again count this as a GC.</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      gcs_completed_<span class=\"token punctuation\">.</span><span class=\"token function\">fetch_add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>memory_order_release<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token keyword\">return</span> collector<span class=\"token double-colon punctuation\">::</span>kGcTypeNone<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>gc_disabled_for_shutdown_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      gcs_completed_<span class=\"token punctuation\">.</span><span class=\"token function\">fetch_add</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>memory_order_release<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token keyword\">return</span> collector<span class=\"token double-colon punctuation\">::</span>kGcTypeNone<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    collector_type_running_ <span class=\"token operator\">=</span> collector_type_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    last_gc_cause_ <span class=\"token operator\">=</span> gc_cause<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>gc_cause <span class=\"token operator\">==</span> kGcCauseForAlloc <span class=\"token operator\">&amp;&amp;</span> runtime<span class=\"token operator\">-></span><span class=\"token function\">HasStatsEnabled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token operator\">++</span>runtime<span class=\"token operator\">-></span><span class=\"token function\">GetStats</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>gc_for_alloc_count<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token operator\">++</span>self<span class=\"token operator\">-></span><span class=\"token function\">GetStats</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>gc_for_alloc_count<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token keyword\">const</span> size_t bytes_allocated_before_gc <span class=\"token operator\">=</span> <span class=\"token function\">GetBytesAllocated</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token function\">DCHECK_LT</span><span class=\"token punctuation\">(</span>gc_type<span class=\"token punctuation\">,</span> collector<span class=\"token double-colon punctuation\">::</span>kGcTypeMax<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token function\">DCHECK_NE</span><span class=\"token punctuation\">(</span>gc_type<span class=\"token punctuation\">,</span> collector<span class=\"token double-colon punctuation\">::</span>kGcTypeNone<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  collector<span class=\"token double-colon punctuation\">::</span>GarbageCollector<span class=\"token operator\">*</span> collector <span class=\"token operator\">=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token comment\">// TODO: Clean this up.</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>compacting_gc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token function\">DCHECK</span><span class=\"token punctuation\">(</span>current_allocator_ <span class=\"token operator\">==</span> kAllocatorTypeBumpPointer <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>           current_allocator_ <span class=\"token operator\">==</span> kAllocatorTypeTLAB <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>           current_allocator_ <span class=\"token operator\">==</span> kAllocatorTypeRegion <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>           current_allocator_ <span class=\"token operator\">==</span> kAllocatorTypeRegionTLAB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>collector_type_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>      <span class=\"token keyword\">case</span> kCollectorTypeSS<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        semi_space_collector_<span class=\"token operator\">-></span><span class=\"token function\">SetFromSpace</span><span class=\"token punctuation\">(</span>bump_pointer_space_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        semi_space_collector_<span class=\"token operator\">-></span><span class=\"token function\">SetToSpace</span><span class=\"token punctuation\">(</span>temp_space_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        semi_space_collector_<span class=\"token operator\">-></span><span class=\"token function\">SetSwapSemiSpaces</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        collector <span class=\"token operator\">=</span> semi_space_collector_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>      <span class=\"token keyword\">case</span> kCollectorTypeCC<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        collector<span class=\"token double-colon punctuation\">::</span>ConcurrentCopying<span class=\"token operator\">*</span> active_cc_collector<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>use_generational_cc_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          <span class=\"token comment\">// TODO: Other threads must do the flip checkpoint before they start poking at</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>          <span class=\"token comment\">// active_concurrent_copying_collector_. So we should not concurrency here.</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          active_cc_collector <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>gc_type <span class=\"token operator\">==</span> collector<span class=\"token double-colon punctuation\">::</span>kGcTypeSticky<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                  young_concurrent_copying_collector_ <span class=\"token operator\">:</span> concurrent_copying_collector_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          active_concurrent_copying_collector_<span class=\"token punctuation\">.</span><span class=\"token function\">store</span><span class=\"token punctuation\">(</span>active_cc_collector<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                                                     std<span class=\"token double-colon punctuation\">::</span>memory_order_relaxed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          <span class=\"token function\">DCHECK</span><span class=\"token punctuation\">(</span>active_cc_collector<span class=\"token operator\">-></span><span class=\"token function\">RegionSpace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> region_space_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          collector <span class=\"token operator\">=</span> active_cc_collector<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          collector <span class=\"token operator\">=</span> active_concurrent_copying_collector_<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>memory_order_relaxed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      <span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        <span class=\"token function\">LOG</span><span class=\"token punctuation\">(</span>FATAL<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Invalid collector type \"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token generic-function\"><span class=\"token function\">static_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>size_t<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>collector_type_<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>collector <span class=\"token operator\">!=</span> active_concurrent_copying_collector_<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>memory_order_relaxed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>      temp_space_<span class=\"token operator\">-></span><span class=\"token function\">GetMemMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">Protect</span><span class=\"token punctuation\">(</span>PROT_READ <span class=\"token operator\">|</span> PROT_WRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>kIsDebugBuild<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        <span class=\"token comment\">// Try to read each page of the memory map in case mprotect didn't work properly b/19894268.</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        temp_space_<span class=\"token operator\">-></span><span class=\"token function\">GetMemMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">TryReadable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>      <span class=\"token function\">CHECK</span><span class=\"token punctuation\">(</span>temp_space_<span class=\"token operator\">-></span><span class=\"token function\">IsEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    gc_type <span class=\"token operator\">=</span> collector<span class=\"token double-colon punctuation\">::</span>kGcTypeFull<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// TODO: Not hard code this in.</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current_allocator_ <span class=\"token operator\">==</span> kAllocatorTypeRosAlloc <span class=\"token operator\">||</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>      current_allocator_ <span class=\"token operator\">==</span> kAllocatorTypeDlMalloc<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    collector <span class=\"token operator\">=</span> <span class=\"token function\">FindCollectorByGcType</span><span class=\"token punctuation\">(</span>gc_type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token function\">LOG</span><span class=\"token punctuation\">(</span>FATAL<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Invalid current allocator \"</span> <span class=\"token operator\">&lt;&lt;</span> current_allocator_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  <span class=\"token function\">CHECK</span><span class=\"token punctuation\">(</span>collector <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>      <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Could not find garbage collector with collector_type=\"</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>      <span class=\"token operator\">&lt;&lt;</span> <span class=\"token generic-function\"><span class=\"token function\">static_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>size_t<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>collector_type_<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" and gc_type=\"</span> <span class=\"token operator\">&lt;&lt;</span> gc_type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>  collector<span class=\"token operator\">-></span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span>gc_cause<span class=\"token punctuation\">,</span> clear_soft_references <span class=\"token operator\">||</span> runtime<span class=\"token operator\">-></span><span class=\"token function\">IsZygote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  <span class=\"token function\">IncrementFreedEver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  <span class=\"token function\">RequestTrim</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  <span class=\"token comment\">// Collect cleared references.</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  SelfDeletingTask<span class=\"token operator\">*</span> clear <span class=\"token operator\">=</span> reference_processor_<span class=\"token operator\">-></span><span class=\"token function\">CollectClearedReferences</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>  <span class=\"token comment\">// Grow the heap so that we know when to perform the next GC.</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  <span class=\"token function\">GrowForUtilization</span><span class=\"token punctuation\">(</span>collector<span class=\"token punctuation\">,</span> bytes_allocated_before_gc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>  old_native_bytes_allocated_<span class=\"token punctuation\">.</span><span class=\"token function\">store</span><span class=\"token punctuation\">(</span><span class=\"token function\">GetNativeBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  <span class=\"token function\">LogGC</span><span class=\"token punctuation\">(</span>gc_cause<span class=\"token punctuation\">,</span> collector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  <span class=\"token function\">FinishGC</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> gc_type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  <span class=\"token comment\">// Actually enqueue all cleared references. Do this after the GC has officially finished since</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>  <span class=\"token comment\">// otherwise we can deadlock.</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  clear<span class=\"token operator\">-></span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>  clear<span class=\"token operator\">-></span><span class=\"token function\">Finalize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>  <span class=\"token comment\">// Inform DDMS that a GC completed.</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>  <span class=\"token class-name\">Dbg</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">GcDidFinish</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>  <span class=\"token comment\">// Unload native libraries for class unloading. We do this after calling FinishGC to prevent</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>  <span class=\"token comment\">// deadlocks in case the JNI_OnUnload function does allocations.</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>    ScopedObjectAccess <span class=\"token function\">soa</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t<span class=\"token comment\">// è°ƒç”¨ JNI_OnUnload</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>    soa<span class=\"token punctuation\">.</span><span class=\"token function\">Vm</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">UnloadNativeLibraries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>  <span class=\"token keyword\">return</span> gc_type<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"call_destructors\"><a class=\"anchor\" href=\"#call_destructors\">#</a> call_destructors</h2>\n<p><code>call_destructors</code>  å‡½æ•°å¦‚ä¸‹ï¼Œæˆ‘ä»¬å‘ä¸Šæ‰¾æ‰¾çœ‹äº¤å‰å¼•ç”¨</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\bionic\\linker\\linker_soinfo.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">void</span> soinfo<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">call_destructors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>constructors_called<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ScopedTrace <span class=\"token function\">trace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"calling destructors: \"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// DT_FINI_ARRAY must be parsed in reverse order.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token function\">call_array</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DT_FINI_ARRAY\"</span><span class=\"token punctuation\">,</span> fini_array_<span class=\"token punctuation\">,</span> fini_array_count_<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// DT_FINI should be called after DT_FINI_ARRAY if both are present.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">call_function</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DT_FINI\"</span><span class=\"token punctuation\">,</span> fini_func_<span class=\"token punctuation\">,</span> <span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"soinfo_unload_impl\"><a class=\"anchor\" href=\"#soinfo_unload_impl\">#</a> soinfo_unload_impl</h3>\n<p>è¿™é‡Œæˆ‘ä»¬å‘ç° log ä»£ç ä¸­éƒ½å‡ºç°äº† <code>dlclose</code>  å­—æ ·ï¼Œé‚£ä¹ˆæ˜¾è€Œæ˜“è§è¿™åº”è¯¥å’Œ <code>dlclose</code>  è„±ä¸äº†å¹²ç³»ï¼Œåœ¨å¾€ä¸Šçœ‹çœ‹</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">soinfo_unload_impl</span><span class=\"token punctuation\">(</span>soinfo<span class=\"token operator\">*</span> root<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  ScopedTrace <span class=\"token function\">trace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">string</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unload \"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> root<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">bool</span> is_linked <span class=\"token operator\">=</span> root<span class=\"token operator\">-></span><span class=\"token function\">is_linked</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>root<span class=\"token operator\">-></span><span class=\"token function\">can_unload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>           <span class=\"token string\">\"... dlclose(root=\\\"%s\\\"@%p) ... not unloading - the load group is flagged with NODELETE\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>           root<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>           root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  soinfo_list_t unload_list<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  unload_list<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  soinfo_list_t local_unload_list<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  soinfo_list_t external_unload_list<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  soinfo<span class=\"token operator\">*</span> si <span class=\"token operator\">=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">// å°†è¦å¸è½½çš„ so çš„ soinfo æ·»åŠ åˆ° local_unload_list ä¸­</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>si <span class=\"token operator\">=</span> unload_list<span class=\"token punctuation\">.</span><span class=\"token function\">pop_front</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>local_unload_list<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    local_unload_list<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>si<span class=\"token operator\">-></span><span class=\"token function\">has_min_version</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      soinfo<span class=\"token operator\">*</span> child <span class=\"token operator\">=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>child <span class=\"token operator\">=</span> si<span class=\"token operator\">-></span><span class=\"token function\">get_children</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pop_front</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token function\">TRACE</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s@%p needs to unload %s@%p\"</span><span class=\"token punctuation\">,</span> si<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            child<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> child<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        child<span class=\"token operator\">-></span><span class=\"token function\">get_parents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>local_unload_list<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>child<span class=\"token operator\">-></span><span class=\"token function\">is_linked</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> child<span class=\"token operator\">-></span><span class=\"token function\">get_local_group_root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> root<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          external_unload_list<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>child<span class=\"token operator\">-></span><span class=\"token function\">get_parents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          unload_list<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token function\">async_safe_fatal</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"soinfo for \\\"%s\\\"@%p has no version\"</span><span class=\"token punctuation\">,</span> si<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  local_unload_list<span class=\"token punctuation\">.</span><span class=\"token function\">for_each</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>soinfo<span class=\"token operator\">*</span> si<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>           <span class=\"token string\">\"... dlclose: calling destructors for \\\"%s\\\"@%p ... \"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>           si<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>           si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token comment\">// è°ƒç”¨ call_destructors æ‰§è¡Œ final_array å’Œ final å‡½æ•°</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    si<span class=\"token operator\">-></span><span class=\"token function\">call_destructors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>           <span class=\"token string\">\"... dlclose: calling destructors for \\\"%s\\\"@%p ... done\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>           si<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>           si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token comment\">// è¿›è¡Œ soinfo æœ€åçš„æ”¶å°¾å·¥ä½œ</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>si <span class=\"token operator\">=</span> local_unload_list<span class=\"token punctuation\">.</span><span class=\"token function\">pop_front</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>           <span class=\"token string\">\"... dlclose: unloading \\\"%s\\\"@%p ...\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>           si<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>           si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token operator\">++</span>g_module_unload_counter<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token function\">notify_gdb_of_unload</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token function\">unregister_soinfo_tls</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">__libc_shared_globals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>unload_hook<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>      <span class=\"token function\">__libc_shared_globals</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">unload_hook</span><span class=\"token punctuation\">(</span>si<span class=\"token operator\">-></span>load_bias<span class=\"token punctuation\">,</span> si<span class=\"token operator\">-></span>phdr<span class=\"token punctuation\">,</span> si<span class=\"token operator\">-></span>phnum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token function\">get_cfi_shadow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">BeforeUnload</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token function\">soinfo_free</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>is_linked<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>si <span class=\"token operator\">=</span> external_unload_list<span class=\"token punctuation\">.</span><span class=\"token function\">pop_front</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>             <span class=\"token string\">\"... dlclose: unloading external reference \\\"%s\\\"@%p ...\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>             si<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>             si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>      <span class=\"token function\">soinfo_unload</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>             <span class=\"token string\">\"... dlclose: unload_si was not linked - not unloading external references ...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"soinfo_unload\"><a class=\"anchor\" href=\"#soinfo_unload\">#</a> soinfo_unload</h3>\n<p><code>soinfo_unload_impl</code>  è¢« <code>soinfo_unload</code>  è°ƒç”¨ï¼Œä¸»è¦è®©å¼•ç”¨è®¡æ•°å‡ä¸€ï¼Œç„¶åè°ƒç”¨æ ¸å¿ƒçš„å¸è½½é€»è¾‘</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">soinfo_unload</span><span class=\"token punctuation\">(</span>soinfo<span class=\"token operator\">*</span> unload_si<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token comment\">// Note that the library can be loaded but not linked;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">// in which case there is no root but we still need</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// to walk the tree and unload soinfos involved.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// This happens on unsuccessful dlopen, when one of</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// the DT_NEEDED libraries could not be linked/found.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// è¿™ä¸ª so ä¸ç®¡æœ‰æ²¡æœ‰è¢«é“¾æ¥ï¼Œåªè¦åŠ è½½äº†ï¼Œé‚£å¿…é¡»å¾— unload å¸è½½</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token keyword\">bool</span> is_linked <span class=\"token operator\">=</span> unload_si<span class=\"token operator\">-></span><span class=\"token function\">is_linked</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  soinfo<span class=\"token operator\">*</span> root <span class=\"token operator\">=</span> is_linked <span class=\"token operator\">?</span> unload_si<span class=\"token operator\">-></span><span class=\"token function\">get_local_group_root</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> unload_si<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>         <span class=\"token string\">\"... dlclose(realpath=\\\"%s\\\"@%p) ... load group root is \\\"%s\\\"@%p\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>         unload_si<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>         unload_si<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>         root<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>         root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token comment\">// å¦‚æœè¢«å…¶ä»–åº“é“¾æ¥äº† (å…¶å®å°±æ˜¯è¢«å¼•ç”¨äº†), é‚£å¸è½½çš„æ—¶å€™å¼•ç”¨è®¡æ•°å°± - 1</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  size_t ref_count <span class=\"token operator\">=</span> is_linked <span class=\"token operator\">?</span> root<span class=\"token operator\">-></span><span class=\"token function\">decrement_ref_count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ref_count <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>           <span class=\"token string\">\"... dlclose(root=\\\"%s\\\"@%p) ... not unloading - decrementing ref_count to %zd\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>           root<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>           root<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>           ref_count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token comment\">// æ‰§è¡Œæ ¸å¿ƒ unload æ“ä½œ</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token function\">soinfo_unload_impl</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"do_dlclose\"><a class=\"anchor\" href=\"#do_dlclose\">#</a> do_dlclose</h3>\n<p>æœä¸å…¶ç„¶ï¼Œæ˜¯è°ƒç”¨ <code>do_dlclose</code>  æ¥è¿›è¡Œå¸è½½çš„</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">do_dlclose</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> handle<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  ScopedTrace <span class=\"token function\">trace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dlclose\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  ProtectedDataGuard guard<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  soinfo<span class=\"token operator\">*</span> si <span class=\"token operator\">=</span> <span class=\"token function\">soinfo_from_handle</span><span class=\"token punctuation\">(</span>handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>si <span class=\"token operator\">==</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">DL_OPEN_ERR</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"invalid handle: %p\"</span><span class=\"token punctuation\">,</span> handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>         <span class=\"token string\">\"dlclose(handle=%p, realpath=\\\"%s\\\"@%p) ...\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>         handle<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>         si<span class=\"token operator\">-></span><span class=\"token function\">get_realpath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>         si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">// å¸è½½ soinfo</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token function\">soinfo_unload</span><span class=\"token punctuation\">(</span>si<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token function\">LD_LOG</span><span class=\"token punctuation\">(</span>kLogDlopen<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>         <span class=\"token string\">\"dlclose(handle=%p) ... done\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>         handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"__loader_dlclose\"><a class=\"anchor\" href=\"#__loader_dlclose\">#</a> __loader_dlclose</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//platform\\bionic\\linker\\dlfcn.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">__loader_dlclose</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> handle<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  ScopedPthreadMutexLocker <span class=\"token function\">locker</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>g_dl_mutex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">int</span> result <span class=\"token operator\">=</span> <span class=\"token function\">do_dlclose</span><span class=\"token punctuation\">(</span>handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">__bionic_format_dlerror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dlclose failed\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">linker_get_error_buffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"dlclose\"><a class=\"anchor\" href=\"#dlclose\">#</a> dlclose</h3>\n<p>æœ€ç»ˆæ¥åˆ°äº† <code>dlclose</code>  è¿™ä¸ªå‡½æ•°ï¼Œä½†æ˜¯å› ä¸º <code>dlclose</code>  çš„è°ƒç”¨å®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œæˆ‘ä»¬å¾ˆéš¾å»æ‰¾åˆ°ç©¶ç«Ÿæ˜¯å“ªä¸€ä¸ªå‡½æ•°è°ƒç”¨çš„ <code>dlclose</code>  æ¥å¯¹è¿™ä¸ª so æ‰§è¡Œæœ€ç»ˆçš„å¸è½½æ“ä½œ</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//E:\\android-platform\\bionic\\libdl\\libdl.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">__attribute__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>__weak__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">dlclose</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token operator\">*</span> handle<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">return</span> <span class=\"token function\">__loader_dlclose</span><span class=\"token punctuation\">(</span>handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"æ³¨é‡Šä¸­çš„çŸ›ç›¾ç‚¹\"><a class=\"anchor\" href=\"#æ³¨é‡Šä¸­çš„çŸ›ç›¾ç‚¹\">#</a> æ³¨é‡Šä¸­çš„çŸ›ç›¾ç‚¹</h3>\n<p>æˆ‘ä»¬å‘å‰çœ‹çœ‹ android å¼€å‘è€…ç•™ç»™æˆ‘ä»¬çš„æ³¨é‡Š</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\art\\runtime\\jni\\java_vm_ext.cc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">bool</span> <span class=\"token class-name\">JavaVMExt</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">LoadNativeLibrary</span><span class=\"token punctuation\">(</span>JNIEnv<span class=\"token operator\">*</span> env<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                                  <span class=\"token keyword\">const</span> std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">&amp;</span> path<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                                  jobject class_loader<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                                  jclass caller_class<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                                  std<span class=\"token double-colon punctuation\">::</span>string<span class=\"token operator\">*</span> error_msg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// é˜¶æ®µäºŒï¼šåŠ è½½ so</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// Open the shared library.  Because we're using a full path, the system</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// doesn't have to search through LD_LIBRARY_PATH.  (It may do so to</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// resolve this library's dependencies though.)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// Failures here are expected when java.library.path has several entries</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">// and we have to hunt for the lib.</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">// Below we dlopen but there is no paired dlclose, this would be necessary if we supported</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token comment\">// class unloading. Libraries will only be unloaded when the reference count (incremented by</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\">// dlopen) becomes zero from dlclose.</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token comment\">// Retrieve the library path from the classloader, if necessary.</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  ScopedLocalRef<span class=\"token operator\">&lt;</span>jstring<span class=\"token operator\">></span> <span class=\"token function\">library_path</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> <span class=\"token function\">GetLibrarySearchPath</span><span class=\"token punctuation\">(</span>env<span class=\"token punctuation\">,</span> class_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  Locks<span class=\"token double-colon punctuation\">::</span>mutator_lock_<span class=\"token operator\">-></span><span class=\"token function\">AssertNotHeld</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> path_str <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">nullptr</span> <span class=\"token operator\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token keyword\">bool</span> needs_native_bridge <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> nativeloader_error_msg <span class=\"token operator\">=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token comment\">// è°ƒç”¨ dlopen æ‰“å¼€ç›®æ ‡ so</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> handle <span class=\"token operator\">=</span> android<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">OpenNativeLibrary</span><span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      env<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      runtime_<span class=\"token operator\">-></span><span class=\"token function\">GetTargetSdkVersion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      path_str<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      class_loader<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token punctuation\">(</span>caller_location<span class=\"token punctuation\">.</span><span class=\"token function\">empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">nullptr</span> <span class=\"token operator\">:</span> caller_location<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      library_path<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token operator\">&amp;</span>needs_native_bridge<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token operator\">&amp;</span>nativeloader_error_msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token function\">VLOG</span><span class=\"token punctuation\">(</span>jni<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"[Call to dlopen(\\\"\"</span> <span class=\"token operator\">&lt;&lt;</span> path <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\\", RTLD_NOW) returned \"</span> <span class=\"token operator\">&lt;&lt;</span> handle <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"]\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><blockquote>\n<p>Below we dlopen but there is no paired dlclose, this would be necessary if we supported class unloading. Libraries will only be unloaded when the reference count (incremented by dlopen) becomes zero from dlclose.</p>\n</blockquote>\n<p>å½“è°ƒç”¨ <code>dlopen</code>  åŠ è½½ so æ—¶ï¼Œä¼šå¢åŠ ä¸€æ¬¡å¯¹ so çš„å¼•ç”¨è®¡æ•°ï¼Œè€Œå½“å¼•ç”¨è®¡æ•°å˜æˆ 0 ä¹‹åï¼Œä¾¿ä¼šè‡ªåŠ¨è°ƒç”¨ <code>dlclose</code>  å¸è½½ so</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//android-platform\\bionic\\linker\\linker.cpp</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> soinfo<span class=\"token operator\">*</span> <span class=\"token function\">find_library</span><span class=\"token punctuation\">(</span>android_namespace_t<span class=\"token operator\">*</span> ns<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>                            <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> rtld_flags<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                            <span class=\"token keyword\">const</span> android_dlextinfo<span class=\"token operator\">*</span> extinfo<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                            soinfo<span class=\"token operator\">*</span> needed_by<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  soinfo<span class=\"token operator\">*</span> si <span class=\"token operator\">=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// åŠ è½½ so æˆåŠŸï¼Œso çš„å¼•ç”¨æ¬¡æ•° + 1, å¯¹åº”äº† JavaVMExt::LoadNativeLibrary ä¸­</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">//so åŠ è½½æ—¶ è¿™ä¸€éƒ¨åˆ†çš„æ³¨é‡Šâ†“</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  Below we dlopen but there is no paired dlclose, this would be necessary if we supported</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  class unloading. Libraries will only be unloaded when the reference count (incremented by</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  dlopen) becomes zero from dlclose.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  */</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  si<span class=\"token operator\">-></span><span class=\"token function\">increment_ref_count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token keyword\">return</span> si<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>æ‰€ä»¥ç°åœ¨æˆ‘ä»¬çš„ç›®æ ‡ä»è°è°ƒç”¨äº† <code>dlclose</code>  å˜æˆäº†è°è°ƒç”¨äº† <code>soinfo::decrement_ref_count</code> , ä½†æ˜¯åœ¨ <code>soinfo_unload</code>  ä¸­ï¼Œä¸æ˜¯å·²ç»è°ƒç”¨è¿‡ <code>decrement_ref_count</code>  äº†å—ï¼Œè¿™æ®µæ³¨é‡Šå’Œå®é™…çš„æƒ…å†µæ€ä¹ˆçœ‹èµ·æ¥ç›¸äº’çŸ›ç›¾ï¼Ÿæˆ‘ä»¬æœŸæœ›çš„å‡½æ•°è°ƒç”¨æ˜¯ <code>anonymous_func-&gt;decrement_ref_count-&gt;dlclose</code> , ä½†æ˜¯å®é™…çš„è°ƒç”¨æµæ˜¯ <code>dlclose-&gt;decrement_ref_count</code> , è¿™å®Œå…¨æ˜¯ç›¸åçš„è°ƒç”¨è¿‡ç¨‹å‘€</p>\n<h2 id=\"ç¼–å†™demoè§‚å¯Ÿå¸è½½å‡½æ•°è°ƒç”¨å…ˆåæƒ…å†µ\"><a class=\"anchor\" href=\"#ç¼–å†™demoè§‚å¯Ÿå¸è½½å‡½æ•°è°ƒç”¨å…ˆåæƒ…å†µ\">#</a> ç¼–å†™ demo è§‚å¯Ÿå¸è½½å‡½æ•°è°ƒç”¨å…ˆåæƒ…å†µ</h2>\n<p>ç°åœ¨æˆ‘ä»¬å…‰ä»æºç å·²ç»å¾ˆéš¾å†é€†å‘åˆ†æå‡ºæœ€ç»ˆæ˜¯åœ¨å“ªä¸€ä¸ªå‡½æ•°ä¸­ä¾æ¬¡è°ƒç”¨äº† <code>JNI_OnUnload</code>  å’Œ <code>call_destructors</code> , æ‰€ä»¥æˆ‘ä»¬éœ€è¦å®é™…åŠ¨æ‰‹å†™ä¸€ä¸ªæµ‹è¯• demo, é€šè¿‡æ‰“å°æ—¥å¿—çš„æ–¹å¼ï¼Œé€šè¿‡ <code>logcat</code>  æ¥è§‚å¯Ÿå®é™…çš„è°ƒç”¨æƒ…å†µ</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;jni.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"stdio.h\"</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;dlfcn.h></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">extern</span> <span class=\"token string\">\"C\"</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;android/log.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">TAG</span> <span class=\"token string\">\"oacia_tag\"</span> <span class=\"token comment\">// è¿™ä¸ªæ˜¯è‡ªå®šä¹‰çš„ LOG çš„æ ‡è¯†</span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name function\">LOGD</span><span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span> <span class=\"token function\">__android_log_print</span><span class=\"token punctuation\">(</span>ANDROID_LOG_DEBUG<span class=\"token punctuation\">,</span>TAG <span class=\"token punctuation\">,</span>__VA_ARGS__<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>jint <span class=\"token function\">JNI_OnLoad</span><span class=\"token punctuation\">(</span>JavaVM<span class=\"token operator\">*</span> vm<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> reserved __unused<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token function\">LOGD</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"JNI_OnLoad called\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> JNI_VERSION_1_6<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">__attribute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>constructor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">before_main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token function\">LOGD</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"constructor called!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token function\">__attribute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>destructor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">after_main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token function\">LOGD</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"destructor called!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">JNI_OnUnload</span><span class=\"token punctuation\">(</span>JavaVM<span class=\"token operator\">*</span> vm<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span><span class=\"token operator\">*</span> reserved __unused<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token function\">LOGD</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"JNI_OnUnload called\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>ç„¶è€Œå½“é€€å‡º app æ—¶ï¼Œä¸è®º <code>JNI_OnUnload</code>  è¿˜æ˜¯ <code>destructor</code>  å‡æ²¡æœ‰è¢«è°ƒç”¨ï¼Œèµ°åˆ°è¿™é‡Œçœ‹èµ·æ¥å·²ç»è¿›å…¥æ­»èƒ¡åŒäº†ï¼Œå¯èƒ½è¿™ä¸¤ä¸ªå‡½æ•°ä»æœªè¢«è°ƒç”¨â€¦ é‚£æš‚æ—¶å…ˆåˆ°æ­¤ä¸ºæ­¢å§ï½è¦æ˜¯æœªæ¥æœ‰æ–°çš„å‘ç°çš„è¯å†ç»§ç»­å¸è½½è¿‡ç¨‹çš„åˆ†æ</p>\n<p><img data-src=\"/android-load-so/image-20240711144153063.png\" alt=\"image-20240711144153063\" style=\"aspect-ratio:1122 / 63;\"></p>\n<h1 id=\"å‚è€ƒèµ„æ–™\"><a class=\"anchor\" href=\"#å‚è€ƒèµ„æ–™\">#</a> å‚è€ƒèµ„æ–™</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cDovL2Ryb3BzLnhtZDUuY29tL3N0YXRpYy9kcm9wcy90aXBzLTEyMTIyLmh0bWw=\">Android Linker å­¦ä¹ ç¬”è®°</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ndHRpYW5rYWkuZ2l0aHViLmlvLzIwMTgvMDEvMDMvYW5kcm9pZCVFNyVCMyVCQiVFNyVCQiU5RiVFNSU4QSVBMCVFOCVCRCVCRHNvJUU3JTlBJTg0JUU2JUJBJTkwJUU3JUEwJTgxJUU1JTg4JTg2JUU2JTlFJTkwLw==\">Android ç³»ç»ŸåŠ è½½ so çš„æºç åˆ†æ</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zYW5mZW5nYW5kcm9pZC5naXRodWIuaW8vMjAyMS8wMS8xMC9tb2RpZnktbGlua2VyLXRvLWltcGxlbWVudC1wbHQtaG9vay8=\">Android åŠ¨æ€ä¿®æ”¹ Linker å®ç° LD_PRELOAD å…¨å±€åº“ PLT Hook</span></li>\n</ul>\n",
            "tags": []
        },
        {
            "id": "https://oacia.dev/wechat-mini-program-with-devtool/",
            "url": "https://oacia.dev/wechat-mini-program-with-devtool/",
            "title": "å¾®ä¿¡å°ç¨‹åºdevtoolæŠ“åŒ…+åç¼–è¯‘wxapkg",
            "date_published": "2024-01-30T07:55:11.000Z",
            "content_html": "<p>ä»Šå¤©é—²æ¥æ— äº‹ï¼Œä¸Šç½‘å†²æµªï¼Œçªç„¶å‘ç°ä¸€ä¸ªä»¤æˆ‘çœ¼å‰ä¸€äº®çš„é¡¹ç›®<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0phdmVsZXlRQVEvV2VDaGF0T3BlbkRldlRvb2xzLVB5dGhvbg==\"> WeChatOpenDevTools-Python</span>, è¿™è¿™è¿™ï¼Œçœ‹ README çš„ä»‹ç»ï¼Œæˆ‘å²‚ä¸æ˜¯å¯ä»¥åœ¨å°ç¨‹åºé‡Œé¢å¼€ devtool äº†å—ï¼ï¼Ÿ</p>\n<p>æƒ³æ¥ 2022 å¹´ä¹Ÿæœ‰ä¸ªå°ç¨‹åºç¾Šäº†ä¸ªç¾Šçˆ†ç«é‚£ä¼šå„¿ï¼Œæˆ‘ä¹Ÿå¯¹å°ç¨‹åºé€†å‘åˆ†æç©äº†ç©ï¼Œç„¶ååšäº†ä¸ªç ´è§£ç‰ˆçš„è‡ªå¨±è‡ªä¹äº†ä¸€ä¸‹ (å½“ç„¶ä¹Ÿæ˜¯ç®—æœ‹å‹åœˆæ’åæ»´), å½“æ—¶æ‹¿ <code>UnpackMiniApp.exe</code>  è§£å¯†äº† <code>wxapkg</code>  æ ¼å¼çš„å°ç¨‹åºï¼Œç„¶åç”¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3N5c3RlbS1jcHUvd3hhcHBVbnBhY2tlcg==\"> wxappUnpacker</span> å¼„å‡ºäº†å°ç¨‹åºçš„ js æºç æ¥ï¼Œå®¡è®¡ä¸€ä¸‹æ‰¾åˆ°ä¿®æ”¹çš„åœ°æ–¹ patch é€»è¾‘åˆ°æœ€å¼€å§‹çš„ <code>wxapkg</code>  åŒ…å°±ç ´è§£å¥½äº†</p>\n<p>è™½ç„¶ä½†æ˜¯ï¼Œé‚£æ—¶æˆ‘å°±åœ¨æƒ³å¾®ä¿¡å°ç¨‹åºæ—¢ç„¶ç”¨çš„æ˜¯æµè§ˆå™¨çš„å†…æ ¸ï¼Œé‚£ä¹ˆå¿…å®šæ˜¯æœ‰æ–¹æ³•å¯ä»¥å¼€å¯å¼€å‘è€…å·¥å…·çš„ï¼Œä¸è¿‡ç”±äºå½“æ—¶åœ¨ç½‘ä¸Šè¿˜æ²¡å‘ç°è¿™æ ·çš„æŠ€æœ¯æ‰€ä»¥ä¹Ÿå°±åªæ˜¯ä¸€ä¸ªæƒ³æ³•äº†ï¼Œç°åœ¨æ­£å·§ç¢°åˆ°äº†å¤§ä½¬å¼€æºäº†èƒ½å¤Ÿå¼€å¯å¾®ä¿¡å°ç¨‹åºçš„é¡¹ç›®ï¼Œäºæ˜¯æˆ‘ä¾¿æƒ³çœ‹çœ‹å°ç¨‹åº + devtool é€†å‘çš„æ„Ÿè§‰ç©¶ç«Ÿæ˜¯å¦‚ä½•çš„å‘¢ï½</p>\n<p>ç¢°å·§èº«è¾¹çš„äººåœ¨ç©å’¸é±¼ä¹‹ç‹ (è™½ç„¶æˆ‘æ²¡ç©è¿‡), ä½†æ˜¯å®ƒæ¯•ç«Ÿæ˜¯ä¸€ä¸ªå°ç¨‹åºï¼Œé‚£å°±æ‹¿å®ƒæ¥æµ…æµ…å°è¯•ä¸€ä¸‹ devtool é€†å‘çš„æ„Ÿè§‰æ˜¯æ€ä¹ˆæ ·çš„å’¯ <code>^.^</code></p>\n<div class=\"note warning\">\n<p>è®©å¾®ä¿¡å°ç¨‹åºå¼€å¯ devtool æœ‰è¢«å°å·çš„é£é™©ï¼Œè¯·åŠ¡å¿…ä½¿ç”¨<strong>å°å·</strong>ç™»å½•ç”µè„‘ç‰ˆå¾®ä¿¡ï¼ï¼ï¼</p>\n</div>\n<h1 id=\"å¾®ä¿¡å¼€å¯devtool\"><a class=\"anchor\" href=\"#å¾®ä¿¡å¼€å¯devtool\">#</a> å¾®ä¿¡å¼€å¯ devtool</h1>\n<ol>\n<li>ä» github ä¸Šä¸‹è½½é¡¹ç›®</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> clone https://github.com/JaveleyQAQ/WeChatOpenDevTools-Python.git</pre></td></tr></table></figure><ol start=\"2\">\n<li>ä¸‹è½½é¡¹ç›®ä¾èµ–</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pip <span class=\"token function\">install</span> <span class=\"token parameter variable\">-r</span> requirements.txt</pre></td></tr></table></figure><ol start=\"3\">\n<li>éœ€è¦å…ˆæ‰“å¼€ç”µè„‘ç‰ˆå¾®ä¿¡å¹¶ç™»å½•</li>\n<li>è¿è¡Œ <code>main.py</code></li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>python main.py</pre></td></tr></table></figure><p>éšä¾¿å¼€ä¸€ä¸ªå°ç¨‹åºï¼Œå‡ºç°ä¸‹åˆ—ä¿¡æ¯åˆ™ä»£è¡¨ devtool å¼€å¯æˆåŠŸ</p>\n<p><img data-src=\"/wechat-mini-program-with-devtool/image-20240201160604783.png\" alt=\"image-20240201160604783\" style=\"aspect-ratio:625 / 272;\"></p>\n<p>ç‚¹ä¸€ä¸‹å°ç¨‹åºå³ä¸Šè§’çš„ä¸‰ä¸ªç‚¹</p>\n<p><img data-src=\"/wechat-mini-program-with-devtool/image-20240201161923899.png\" alt=\"image-20240201161923899\" style=\"aspect-ratio:378 / 339;\"></p>\n<p>å°±å¯ä»¥å¼€å¯ devtool å•¦</p>\n<p><img data-src=\"/wechat-mini-program-with-devtool/image-20240201161816680.png\" alt=\"image-20240201161816680\" style=\"aspect-ratio:1182 / 789;\"></p>\n<h1 id=\"åç¼–è¯‘wxapkg\"><a class=\"anchor\" href=\"#åç¼–è¯‘wxapkg\">#</a> åç¼–è¯‘ wxapkg</h1>\n<p>devtool å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´åŠ æ–¹ä¾¿çš„æŠ“åˆ°å°ç¨‹åºçš„åŒ…ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡åç¼–è¯‘ wxapkg æ‹¿åˆ°å°ç¨‹åºçš„æºä»£ç ï¼Œå› ä¸ºåœ¨ devtool çš„ source é‡Œé¢ï¼Œå°ç¨‹åºçš„æºç éƒ½è¢«æ•´åˆåˆ°äº†ä¸€ä¸ª js é‡Œé¢å¾ˆéš¾çœ‹å‡ºä»£ç çš„å±‚æ¬¡ç»“æ„</p>\n<h2 id=\"æå–-wxapkg\"><a class=\"anchor\" href=\"#æå–-wxapkg\">#</a> æå– wxapkg</h2>\n<p>Windows é»˜è®¤å°ç¨‹åºçš„å­˜æ”¾è·¯å¾„ä¸º</p>\n<p><code>C:\\Users\\&#123;ç³»ç»Ÿç”¨æˆ·å&#125;\\Documents\\WeChat Files\\Applet\\&#123;å°ç¨‹åºçš„AppID&#125;\\</code></p>\n<p><img data-src=\"/wechat-mini-program-with-devtool/image-20240201164655557.png\" alt=\"image-20240201164655557\" style=\"aspect-ratio:653 / 129;\"></p>\n<h2 id=\"è§£å¯†-wxapkg\"><a class=\"anchor\" href=\"#è§£å¯†-wxapkg\">#</a> è§£å¯† wxapkg</h2>\n<p>ä½¿ç”¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3N1cGVyZGFzaHUvcGNfd3hhcGtnX2RlY3J5cHRfcHl0aG9u\"> pc_wxapkg_decrypt_python</span> æ¥è§£å¯† wxapkg</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>python .<span class=\"token punctuation\">\\</span>main.py <span class=\"token parameter variable\">--wxid</span> wx0840558555a454ed <span class=\"token parameter variable\">--file</span> .<span class=\"token punctuation\">\\</span>__APP__.wxapkg <span class=\"token parameter variable\">--output</span> dec.wxapkg</pre></td></tr></table></figure><p><img data-src=\"/wechat-mini-program-with-devtool/image-20240201165508082.png\" alt=\"image-20240201165508082\" style=\"aspect-ratio:1633 / 106;\"></p>\n<h2 id=\"è§£åŒ…-wxapkg\"><a class=\"anchor\" href=\"#è§£åŒ…-wxapkg\">#</a> è§£åŒ… wxapkg</h2>\n<p>ä½¿ç”¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3N5c3RlbS1jcHUvd3hhcHBVbnBhY2tlcg==\"> wxappUnpacker</span> æ¥è§£åŒ… wxapkg</p>\n<p>ç”±äºå’¸é±¼ä¹‹ç‹å°ç¨‹åºçš„åŒ…æ˜¯æœ‰å­åŒ…çš„ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨ - s å‚æ•°</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>.<span class=\"token punctuation\">\\</span>bingo.bat .<span class=\"token punctuation\">\\</span>dec.wxapkg <span class=\"token parameter variable\">-s</span><span class=\"token operator\">=</span>_subpackages_game_.wxapkg</pre></td></tr></table></figure><p>è§£åŒ…æˆåŠŸï½</p>\n<p><img data-src=\"/wechat-mini-program-with-devtool/image-20240201170202775.png\" alt=\"image-20240201170202775\" style=\"aspect-ratio:1275 / 857;\"></p>\n<p>ç®€å•çœ‹äº†ä¸€ä¸‹æ–‡ä»¶ç»“æ„ï¼Œè¿™æ¸¸æˆçœ‹èµ·æ¥æ˜¯ç”¨ coco2djs å†™çš„ï¼Œè€Œä¸”è¿™ js ä¹Ÿæ²¡æœ‰åŠ å¯†å…¨æ˜¯æºç ï¼Œhmmm å†é€†ä¸‹å»ä¸å°±å˜æˆä»£ç å®¡è®¡äº†å—â€¦ é‚£å°±åˆ°æ­¤ä¸ºæ­¢å’¯ï¼š)</p>\n<p><img data-src=\"/wechat-mini-program-with-devtool/image-20240201190634245.png\" alt=\"image-20240201190634245\" style=\"aspect-ratio:270 / 543;\"></p>\n<h1 id=\"å…¶ä»–\"><a class=\"anchor\" href=\"#å…¶ä»–\">#</a> å…¶ä»–</h1>\n<p>å°±è¿™æ ·ç»“æŸä¼¼ä¹æœ‰ç‚¹å¤ªæ½¦è‰äº†ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æˆ‘åˆ«çš„ä¸€äº›æƒ³æ³•</p>\n<p>æ—¢ç„¶å’¸é±¼ä¹‹ç‹ç”¨çš„æ˜¯ coco2djs, è€Œåœ¨å®˜ç½‘çš„æè¿°ä¸­ï¼Œcoco2d æ˜¯è·¨å¹³å°çš„ï¼Œé‚£æˆ‘è¦æ˜¯å¼€å‘äººå‘˜ï¼Œè‚¯å®šåœ¨å®‰å“ä¸Šç”¨çš„ä¹Ÿæ˜¯ coco2d</p>\n<p><img data-src=\"/wechat-mini-program-with-devtool/image-20240201191145377.png\" alt=\"image-20240201191145377\" style=\"aspect-ratio:417 / 458;\"></p>\n<p>æœä¸å…¶ç„¶ï¼Œä¸‹äº†ä¸€ä¸ª apk ç‰ˆçš„å’¸é±¼ä¹‹ç‹è§£åŒ…ä¹‹åï¼ŒçœŸçš„åœ¨é‡Œé¢å‘ç°äº† <code>libcocos2djs.so</code></p>\n<p><img data-src=\"/wechat-mini-program-with-devtool/image-20240201191250448.png\" alt=\"image-20240201191250448\" style=\"aspect-ratio:521 / 216;\"></p>\n<p>æœ‰è¶£çš„æ˜¯åœ¨ <code>assets</code>  ç›®å½•ä¸‹æœ‰ <code>libjiagu.so</code> , è¿™æ˜æ˜¾æ˜¯å¥—äº†ä¸€ä¸ª 360 åŠ å›ºæƒ³è¦ä¸ºéš¾é€†å‘çš„äººå‘€</p>\n<p>ä½† 360 åŠ å›ºçš„æ˜¯ dex, ä½†æ˜¯ coco2d çš„æºç ä¸å…¨æ˜¯ js å†™çš„å˜›ï¼Ÿå”¯ä¸€çš„ä½œç”¨åº”è¯¥å°±æ˜¯é˜²æ­¢é‡æ‰“åŒ…äº†å§</p>\n<p><img data-src=\"/wechat-mini-program-with-devtool/image-20240201191325364.png\" alt=\"image-20240201191325364\" style=\"aspect-ratio:791 / 416;\"></p>\n<p>è€Œä¸”è¿™ä¸ªæºä»£ç ç”šè‡³è¿ <code>coco2dx-js</code>  å†…ç½®çš„æŠŠæºç åŠ å¯†æˆ <code>jsc</code>  çš„åŠŸèƒ½éƒ½æ²¡æœ‰ï¼Œè¿™ä¸‹è¿å¯†é’¥éƒ½ä¸ç”¨æ‰¾äº†â€¦</p>\n<p><img data-src=\"/wechat-mini-program-with-devtool/image-20240201194515519.png\" alt=\"image-20240201194515519\" style=\"aspect-ratio:813 / 184;\"></p>\n<p>é‚£é¡ºä¾¿è®°å½•ä¸€ä¸‹åŠ å¯†æˆ jsc ç±»ä¼¼ä¸‹å›¾çš„æ ·å­è¯¥å¦‚ä½•åº”å¯¹å§</p>\n<p><img data-src=\"/wechat-mini-program-with-devtool/o3kwTv9h8S6nqCp.png\" alt=\"Jscç»“æ„\" style=\"aspect-ratio:434 / 310;\"></p>\n<p>å¾ˆç®€å•ï¼Œ <code>010editor</code>  æ‰“å¼€ <code>libcocos2djs.so</code>  å…¨å±€æœç´¢ <code>jsb-adapater</code> , å®ƒå‰é¢é‚£ä¸€ä¸²å­—ç¬¦ä¸²å°±æ˜¯ jsc çš„å¯†é’¥</p>\n<p><img data-src=\"/wechat-mini-program-with-devtool/EYTa4KC37WZMgdG.png\" alt=\"Hexä¸‹ key\" style=\"aspect-ratio:989 / 670;\"></p>\n<p>æ‹¿åˆ°äº†å¯†é’¥ï¼Œç”¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2x1Y2t5YWliaW4vY29jb3NjcmVhdG9yanNjZGVjcnlwdA==\"> cocoscreatorjscdecrypt</span> å°±å¯ä»¥è§£å¯†å‡ºæºç æ¥äº†</p>\n",
            "tags": []
        },
        {
            "id": "https://oacia.dev/telegram-bot-develop/",
            "url": "https://oacia.dev/telegram-bot-develop/",
            "title": "telegram bot åˆä½“éªŒåŠäº‘ç«¯éƒ¨ç½²",
            "date_published": "2023-12-31T13:08:18.000Z",
            "content_html": "<h1 id=\"å‰è¨€\"><a class=\"anchor\" href=\"#å‰è¨€\">#</a> å‰è¨€</h1>\n<p>ä¸ºä»€ä¹ˆçªç„¶æƒ³è¦å»åšä¸€ä¸ª <code>telegram bot</code>  äº†å‘¢ï¼Ÿ</p>\n<p>è¿™å°±è¦è¯´åˆ°å›°æ‰°æˆ‘å¾ˆä¹…çš„ä¸€ä¸ªå°é—®é¢˜äº†ï¼Œæˆ‘åœ¨åˆ·æŠ–éŸ³çš„è¿‡ç¨‹ä¸­ï¼Œçœ‹åˆ°æœ‰æ„æ€çš„è§†é¢‘æˆ–è€…å¥½çœ‹çš„å›¾ç‰‡ï¼Œå°±å¾ˆæƒ³è¦æŠŠå®ƒä»¬ç»™ä¿å­˜ä¸‹æ¥ï¼Œä½œä¸ºå£çº¸æˆ–è€…å’Œåˆ«äººåˆ†äº«ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™ <code>ä¿å­˜æœ¬åœ°</code> è¿™ä¸ªé€‰é¡¹æ˜¯ç°è‰²çš„ä¸è®©æˆ‘å»ä¿å­˜</p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231221356758.png\" alt=\"image-20231231221356758\" style=\"aspect-ratio:1080 / 381;\"></p>\n<p>è€Œä¸”æŠ–éŸ³åœ¨å›¾ç‰‡ä¿å­˜çš„è¿‡ç¨‹ä¸­æ€»æ˜¯ä¼šæ‰“ä¸Šæ°´å°ï¼Œå°±åƒä¸‹é¢è¿™ä¸ªæ ·å­ï¼Œå€˜è‹¥ç”¨ä½œå£çº¸æˆ–è€…æ—¥å¸¸æ‰“å¼€æ¥çœ‹çš„æ—¶å€™å°±æ„Ÿè§‰ååˆ†çš„â€¦ åˆ«æ‰­</p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231221840810.png\" alt=\"image-20231231221840810\" style=\"aspect-ratio:530 / 702;\"></p>\n<p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘å°±ä¼šæŠŠæŠ–éŸ³çš„è§†é¢‘æˆ–å›¾æ–‡åˆ†äº«é“¾æ¥å¤åˆ¶ä¸‹æ¥ï¼Œæ‰“å¼€å¾®ä¿¡å°ç¨‹åºï¼Œæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥æŠ–éŸ³æ— æ°´å°ä¸‹è½½çš„å°ç¨‹åºï¼Œå¿å—å‡ åç§’å¹¿å‘Šçš„ç…ç†¬ä¹‹åï¼Œç»ˆäºå¯ä»¥æˆåŠŸçš„æŠŠå›¾ç‰‡ä¿å­˜åˆ°æœ¬åœ°ï¼Œå¬èµ·æ¥ç›¸å½“çš„ä¸ä¾¿å§ï¼Œç„¶è€Œæˆ‘å·²ç»è¿›è¡Œä¸Šé¢çš„æ“ä½œä¸çŸ¥å¤šå°‘æ¬¡äº†ï¼Œæ‰€ä»¥äºŸéœ€ä¸€ä¸ªæ›´åŠ æ–¹ä¾¿çš„æ–¹å¼æ¥å¸®åŠ©æˆ‘å‡å°‘æ— æ„ä¹‰æ—¶é—´çš„æ¶ˆè€—</p>\n<p>è€Œåœ¨<a href=\"https://oacia.dev/douyin-favorites-pic/\">æŠ–éŸ³æ”¶è—å¤¹å›¾æ–‡æ‰¹é‡è·å–</a>è¿™ç¯‡ blog ä¸­ï¼Œæˆ‘å·²ç»åˆ©ç”¨ python ä»£ç ä¸‹è½½åˆ°äº†æŠ–éŸ³ä¸Šçš„æ— æ°´å°çš„è§†é¢‘å’Œå›¾ç‰‡ï¼Œé‚£ä¹ˆç°åœ¨è¦åšçš„å°±æ˜¯å¦‚ä½•ä¾¿æ·çš„è¿è¡Œè¿™æ®µ python ä»£ç å¹¶è¿”å›è§†é¢‘æˆ–å›¾ç‰‡ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘æƒ³åˆ°äº† <code>telegram bot</code> , å› ä¸º tg æˆ‘æ—¥å¸¸ä¹Ÿæ˜¯åœ¨ç”¨çš„ï¼Œæ‰“å¼€é€Ÿåº¦å¿«ï¼Œç•Œé¢ç®€æ´éƒ½æ˜¯æˆ‘é€‰æ‹©å®ƒçš„åŸå› ï¼Œè€Œ telegram bot ç®—æ˜¯ telegram çš„ç‰¹è‰²å§ï¼Œä¹‹å‰æ€»æ˜¯è§‰å¾— bot æ˜¯ä¸ªç¥ç§˜çš„å­˜åœ¨ï¼Œä½†æ˜¯è¿™ä¸¤å¤©çš„ bot åšä¸‹æ¥ï¼Œå‘ç°å…¶å®æ˜¯ç›¸å½“çš„ç®€å•çš„ï¼Œé˜…è¯»çº¯è‹±æ–‡æ–‡æ¡£ï¼Œè‡ªæˆ‘æ¢ç´¢çš„è¿‡ç¨‹ä¹ŸåŒæ ·å……æ»¡çš„ä¹è¶£ï¼è€Œä¸”æˆ‘è®¤ä¸ºä¹‹åæˆ‘è¿˜å¯ä»¥å‘è¿™ä¸ª bot ä¸­åŠ å…¥æ›´å¤šçš„æœ‰åˆ›é€ åŠ›çš„ï¼Œæé«˜ç”Ÿæ´»æ•ˆç‡çš„åŠŸèƒ½ï¼Œæ•¬è¯·æœŸå¾…ï½</p>\n<p>å¯ä»¥æ¥ç©ç©è¿™ä¸ª bot å™¢ï½<span class=\"exturl\" data-url=\"aHR0cHM6Ly90Lm1lL29hY2lhX2JvdA==\">https://t.me/oacia_bot</span></p>\n<p>bot çš„æºä»£ç å‘å¸ƒåœ¨ github ä¸Šé¢<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL29hY2lhL29hY2lhX2JvdA==\"> https://github.com/oacia/oacia_bot</span></p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231230233851.png\" alt=\"image-20231231230233851\" style=\"aspect-ratio:568 / 390;\"></p>\n<h1 id=\"tg-bot-pythonåº“é€‰æ‹©\"><a class=\"anchor\" href=\"#tg-bot-pythonåº“é€‰æ‹©\">#</a> tg bot python åº“é€‰æ‹©</h1>\n<p>æ—¢ç„¶æˆ‘ä»¬é€‰å®šäº†æ ¸å¿ƒä»£ç æ˜¯ç”¨ python ç¼–å†™çš„ï¼Œé‚£ä¹ˆé€‰æ‹©ä¸€ä¸ªç®€å•æ˜“ä¸Šæ‰‹çš„ telegram bot é›†æˆåº“å°±æ˜¾å¾—éå¸¸æœ‰å¿…è¦å•¦ï¼Œä»–ä»¬å°è£…äº† telegram å®˜æ–¹çš„<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3JlLnRlbGVncmFtLm9yZy9ib3RzL2FwaQ==\"> bot api</span>, æˆ‘ä»¬åªéœ€è¦è°ƒç”¨ python åº“ä½œè€…é›†æˆçš„å‡½æ•°å°±å¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨ bot api çš„å„ç§åŠŸèƒ½ï¼Œç°åœ¨ä¸»æµçš„ tg bot python åº“åˆ†åˆ«æ˜¯</p>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0xvbmFtaVdlYnMvVGVsZXRob24=\">telethon</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2V0ZXJubm9pci9weVRlbGVncmFtQm90QVBJ\">telebot</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3B5dGhvbi10ZWxlZ3JhbS1ib3QvcHl0aG9uLXRlbGVncmFtLWJvdA==\">python-telegram-bot</span></li>\n</ul>\n<p>æˆ‘æœ€ç»ˆé€‰æ‹©çš„åº“æ˜¯<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0xvbmFtaVdlYnMvVGVsZXRob24=\"> telethon</span>, åŸå› å¾ˆç®€å•ï¼Œ<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLnRlbGV0aG9uLmRldi9lbi9zdGFibGUv\"> å®˜æ–¹æ–‡æ¡£</span>å†™çš„å®åœ¨æ˜¯å¤ªè¯¦ç»†äº†ï¼è€Œ<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2V0ZXJubm9pci9weVRlbGVncmFtQm90QVBJ\"> telebot</span> æˆ‘ä¹Ÿå°è¯•äº†ï¼Œç„¶è€Œ API çš„å˜åŒ–å®åœ¨æ˜¯å¤ªå¤§äº†ï¼Œç½‘ä¸Šä½¿ç”¨æ—§ç‰ˆæœ¬çš„ telebot æ‰€å±•ç¤ºçš„ä»£ç å®Œå…¨æ²¡æœ‰å‚è€ƒä»·å€¼ï¼Œ<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3B5dGhvbi10ZWxlZ3JhbS1ib3QvcHl0aG9uLXRlbGVncmFtLWJvdA==\">python-telegram-bot</span> ç”¨æ³•å¾ˆå¤æ‚ï¼Œå®˜æ–¹æ–‡æ¡£å†™çš„ä¹Ÿä¸æ˜¯å¾ˆè¯¦ç»†å¯¼è‡´æˆ‘ç”¨èµ·æ¥ç›¸å½“ç—›è‹¦â€¦</p>\n<h1 id=\"telegram-bot\"><a class=\"anchor\" href=\"#telegram-bot\">#</a> telegram bot</h1>\n<p>ä»€ä¹ˆæ˜¯ telegram bot? è¿™æ˜¯<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3JlLnRlbGVncmFtLm9yZy9ib3Rz\">å®˜æ–¹æ–‡æ¡£</span>ä¸­çš„ä»‹ç»</p>\n<blockquote>\n<p>Bots are <strong>small applications</strong> that run entirely within the Telegram app. Users interact with bots through <strong>flexible interfaces</strong> that can support <strong>any kind of task or service</strong>.</p>\n</blockquote>\n<p>å®ƒå…¶å®æœ¬è´¨ä¸Šæ˜¯åŸºäº Telegram å®¢æˆ·ç«¯çš„ç¬¬ä¸‰æ–¹ç¨‹åºï¼Œæˆ‘ä»¬ç»™æœºå™¨äººå‘é€æ¶ˆæ¯ï¼Œæœºå™¨äººé€šè¿‡ä»£ç å¤„ç†æˆ‘ä»¬å‘é€çš„æ¶ˆæ¯ä¹‹åï¼Œå†å‘é€å›æ¶ˆæ¯ç»™æˆ‘ä»¬ï¼Œç±»ä¼¼äºä¸‹é¢æˆ‘å’Œæˆ‘çš„ bot çš„ç®€å•äº¤äº’</p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231223732245.png\" alt=\"image-20231231223732245\" style=\"aspect-ratio:641 / 1280;\"></p>\n<h1 id=\"botå®ç°ç®€å•çš„äº¤äº’\"><a class=\"anchor\" href=\"#botå®ç°ç®€å•çš„äº¤äº’\">#</a> bot å®ç°ç®€å•çš„äº¤äº’</h1>\n<p>å¤§å®¶å¯ä»¥çœ‹åˆ°ä¸Šæ–¹æˆ‘ä»¬åˆšåˆšå®ç°äº†ä¸€ä¸ªç®€å•çš„äº¤äº’ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ telethon æ¥å®ç°ä¸€ä¸‹å§ï½</p>\n<p>é¦–å…ˆå®‰è£… telethon</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pip <span class=\"token function\">install</span> telethon</pre></td></tr></table></figure><p>ä»£ç é•¿è¿™ä¸ªæ ·å­çš„ï¼Œä¸€çœ¼çœ‹ä¸Šå»æ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢ï½</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">from</span> telethon <span class=\"token keyword\">import</span> TelegramClient<span class=\"token punctuation\">,</span> events</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>api_id <span class=\"token operator\">=</span> <span class=\"token number\">12345678</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>api_hash <span class=\"token operator\">=</span> <span class=\"token string\">\"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>bot_token<span class=\"token punctuation\">:</span> <span class=\"token string\">\"1234567890:aaaaaaaaaaaaaaaaa-bbbbbbbbbbbbbbbbbb\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>session<span class=\"token punctuation\">:</span> <span class=\"token string\">\"oacia_bot\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>proxy <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"HTTP\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"127.0.0.1\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7890</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>client <span class=\"token operator\">=</span> TelegramClient<span class=\"token punctuation\">(</span>session<span class=\"token punctuation\">,</span> api_id<span class=\"token punctuation\">,</span> api_hash<span class=\"token punctuation\">,</span> proxy<span class=\"token operator\">=</span>proxy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>start<span class=\"token punctuation\">(</span>bot_token<span class=\"token operator\">=</span>bot_token<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token decorator annotation punctuation\">@client<span class=\"token punctuation\">.</span>on</span><span class=\"token punctuation\">(</span>events<span class=\"token punctuation\">.</span>NewMessage<span class=\"token punctuation\">(</span>pattern<span class=\"token operator\">=</span><span class=\"token string\">'(.*)'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">async</span> <span class=\"token keyword\">def</span> <span class=\"token function\">hello</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    user <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span>get_entity<span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>peer_id<span class=\"token punctuation\">.</span>user_id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">await</span> event<span class=\"token punctuation\">.</span>reply<span class=\"token punctuation\">(</span><span class=\"token string\">\"bot has received your message!\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span>send_message<span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"wow!</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>user<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">, you say </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>event<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>client<span class=\"token punctuation\">.</span>run_until_disconnected<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>api_id</code> , <code>api_hash</code>  å’Œ <code>bot_token</code>  æˆ‘å°†ä¼šä»‹ç»è·å–çš„æ–¹æ³•</p>\n<div class=\"note warning\">\n<p><code>api_id</code> , <code>api_hash</code>  å’Œ <code>bot_token</code> <strong> åƒä¸‡ä¸è¦æ³„æ¼ç»™å…¶ä»–äººï¼Œåƒä¸‡ä¸è¦ï¼ï¼</strong></p>\n</div>\n<h2 id=\"api_id-api_hash\"><a class=\"anchor\" href=\"#api_id-api_hash\">#</a> api_id api_hash</h2>\n<p>é¦–å…ˆå‰å¾€<span class=\"exturl\" data-url=\"aHR0cHM6Ly9teS50ZWxlZ3JhbS5vcmcv\"> https://my.telegram.org/</span>, è¾“å…¥æ‰‹æœºå·ï¼Œåœ¨ telegram ä¸Šæ¥æ”¶åˆ° <code>login code</code>  åè¿›å…¥</p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231224259408.png\" alt=\"image-20231231224259408\" style=\"aspect-ratio:1380 / 619;\"></p>\n<p>éšåç‚¹å‡»è¿™é‡Œçš„ <code>API development tools</code>  å»åˆ›å»ºä¸€ä¸ª app, è¿™é‡Œçš„æ•°æ®éšä¾¿å¡«ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ï¼Œå¦‚æœç½‘é¡µä¸€ç›´æŠ¥é”™ <code>ERROR</code> , é‚£ä¹ˆç™¾åˆ†ä¹‹ä¹åæ˜¯ä»£ç†çš„é—®é¢˜ï¼Œä¸€ç›´æ¢ä»£ç†ç›´åˆ°æˆåŠŸåˆ›å»º app</p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231224449272.png\" alt=\"image-20231231224449272\" style=\"aspect-ratio:743 / 293;\"></p>\n<p>åœ¨ <code>App configuration</code>  çš„ä½ç½®å°±å¯ä»¥å¾—åˆ°<strong> api_id</strong> å’Œ<strong> api_hash</strong></p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231224749993.png\" alt=\"image-20231231224749993\" style=\"aspect-ratio:932 / 316;\"></p>\n<h2 id=\"bot_token\"><a class=\"anchor\" href=\"#bot_token\">#</a> bot_token</h2>\n<p>æƒ³è¦åˆ›å»º telegram bot, æˆ‘ä»¬éœ€è¦å‘é€æ¶ˆæ¯ç»™<span class=\"exturl\" data-url=\"aHR0cHM6Ly90Lm1lL0JvdEZhdGhlcg==\"> botfather</span>, é€šè¿‡ <code>/newbot</code>  å‘½ä»¤ï¼Œè¾“å…¥ bot çš„ <code>name</code>  å’Œ <code>username</code>  ä¹‹åï¼Œæˆ‘ä»¬çš„ bot å°±è¢«åˆ›å»ºå¥½å•¦ï½çº¢æ¡†æ¡†é‡Œé¢çš„ token å°±æ˜¯æˆ‘ä»¬çš„ <code>bot_token</code></p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231225759299.png\" alt=\"image-20231231225759299\" style=\"aspect-ratio:454 / 912;\"></p>\n<p>ä¹‹åå°†ä¸Šé¢è·å–åˆ°çš„ä¸‰ä¸ªå‚æ•°å¡«å…¥ä»£ç ï¼Œè¿è¡Œ python è„šæœ¬ï¼Œè®¿é—® <code>t.me/[username]</code> , å°±å¯ä»¥å’Œæˆ‘ä»¬åˆ›å»ºçš„æœºå™¨äººäº¤äº’å•¦</p>\n<h1 id=\"botäº‘ç«¯éƒ¨ç½²\"><a class=\"anchor\" href=\"#botäº‘ç«¯éƒ¨ç½²\">#</a> bot äº‘ç«¯éƒ¨ç½²</h1>\n<p>å› ä¸ºæœ¬äººä»æœªæ‹¥æœ‰è¿‡ä¸€å°å±äºè‡ªå·±çš„æœåŠ¡å™¨ (äºŒè¿›åˆ¶æ ¹æœ¬ä¸éœ€è¦æœåŠ¡å™¨æ»´ï¼ğŸ˜„), æ‰€ä»¥å°±å°†ç›®å…‰è½¬å‘äº†ç½‘ä¸Šå…è´¹çš„äº‘æœåŠ¡éƒ¨ç½²ä¸Šï¼Œç»è¿‡ä¸‹é¢é‚£ä¹ˆå¤šäº‘æœåŠ¡çš„å°è¯•ï¼Œæˆ‘æœ€ç»ˆé€‰æ‹©å°†æœåŠ¡éƒ¨ç½²åœ¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9yZW5kZXIuY29tLw==\"> render</span> ä¸Šé¢äº†</p>\n<h2 id=\"google-colab\"><a class=\"anchor\" href=\"#google-colab\">#</a> google colab</h2>\n<p>ä¸€å¼€å§‹æˆ‘æ˜¯åœ¨ google çš„ colab ä¸Šé¢æ‰§è¡Œ bot ä»£ç çš„ï¼Œç›´æ¥åœ¨ google äº‘ç«¯ç¡¬ç›˜é‡Œé¢åˆ›å»ºä¸€ä¸ª ipynb æ–‡ä»¶å¹¶ç‚¹å‡»å°±å¯ä»¥è¿›å…¥ colab äº†ï¼Œä½†æ˜¯ colab åªèƒ½è¿ç»­è¿è¡Œ 12 ä¸ªå°æ—¶ï¼Œpass</p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231230811161.png\" alt=\"image-20231231230811161\" style=\"aspect-ratio:389 / 738;\"></p>\n<h2 id=\"github-codespace\"><a class=\"anchor\" href=\"#github-codespace\">#</a> github codespace</h2>\n<p>åæ¥æˆ‘æŠŠ bot ä»£ç æ”¾åˆ° github çš„ codespace é‡Œé¢è¿è¡Œï¼Œæ²¡æƒ³åˆ°åªèƒ½è¿è¡Œå‡ ååˆ†é’Ÿå°±æ–­å¼€äº† qaq</p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231230904330.png\" alt=\"image-20231231230904330\" style=\"aspect-ratio:1337 / 774;\"></p>\n<h2 id=\"vercel\"><a class=\"anchor\" href=\"#vercel\">#</a> vercel</h2>\n<p>ä¹‹åæˆ‘åˆæƒ³åˆ°äº†<span class=\"exturl\" data-url=\"aHR0cHM6Ly92ZXJjZWwuY29tLw==\"> vercel</span>, æ¯•ç«Ÿä¹‹å‰å°±æœ‰è¿‡ vercel éƒ¨ç½²é™æ€ç½‘ç«™çš„ç»éªŒï¼Œå¹¶ä¸”å»çœ‹äº† vercel çš„å®˜æ–¹æ–‡æ¡£ï¼Œæ˜¯å¯ä»¥æ”¯æŒ python çš„è¿è¡Œæ—¶çš„ï¼Œ<span class=\"exturl\" data-url=\"aHR0cHM6Ly92ZXJjZWwuY29tL2RvY3MvZnVuY3Rpb25zL3NlcnZlcmxlc3MtZnVuY3Rpb25zL3J1bnRpbWVzL3B5dGhvbiM=\">Using the Python Runtime with Serverless Functions</span></p>\n<p>ä½†æ˜¯å®ƒåªèƒ½é€šè¿‡è®¿é—®ç›¸åº”çš„ api è·¯ç”±æ¥è§¦å‘å‡½æ•°çš„æ‰§è¡Œï¼Œè€Œ telethon ä½¿ç”¨çš„æ˜¯ MTProto åè®®ç›´æ¥å’Œ telegram æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œå¹¶ä¸éœ€è¦å¯¹å¤–å¼€æ”¾ä¸€ä¸ªè·¯ç”±ï¼Œè¿™å°±æ„å‘³ç€ telethon åœ¨ vercel ä¸Šå°†æ— æ³•ä½¿ç”¨</p>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jb3JlLnRlbGVncmFtLm9yZy9tdHByb3Rv\">MTProto</span> is Telegramâ€™s own protocol to communicate with their API when you connect to their servers.</p>\n<p>Telethon is an alternative MTProto-based backend written entirely in Python and much easier to setup and use.</p>\n</blockquote>\n<p>å› æ­¤æˆ‘åˆå»é˜…è¯»äº† telebot çš„å®˜æ–¹æ–‡æ¡£ï¼Œç…§ç€<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3B5ZmJzZGs1OS9GbGFzay1DaGF0R1BULVRlbGVncmFtQm90LVZlcmNlbA==\"> Flask-ChatGPT-TelegramBot-Vercel</span> é‡Œé¢çš„ä»£ç é‡æ„äº†åŸæœ¬çš„è„šæœ¬</p>\n<p>è¿™é‡Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨ telegram çš„ webhook åŠŸèƒ½</p>\n<blockquote>\n<p>ä»€ä¹ˆæ˜¯ webhook?</p>\n<p>ç®€å•çš„è¯´å°±æ˜¯å°† telegram æœåŠ¡å™¨å‘é€ç»™ bot çš„ message åŒæ—¶ä¹Ÿè½¬å‘åˆ°è®¾å®šçš„ä¸€ä¸ª url ä¸Šï¼Œæ¶ˆæ¯çš„ json æ ¼å¼å¦‚ä¸‹æ–¹æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥å¤„ç†è¿™ä¸ªæ¶ˆæ¯å¹¶è¿”å›ç»™å‘é€æ¶ˆæ¯æ–¹ç›¸åº”çš„æ¶ˆæ¯</p>\n<figure class=\"highlight json\"><figcaption data-lang=\"JSON\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ok<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>result<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>             update_id<span class=\"token operator\">:</span> <span class=\"token number\">11223344</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>             message<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                  message_id<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>             from<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                  id<span class=\"token operator\">:</span> <span class=\"token number\">123456789</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                  is_bot<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                  first_name<span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                  username<span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                  language_code<span class=\"token operator\">:</span> <span class=\"token string\">\"en\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>             <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>             chat<span class=\"token operator\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                  id<span class=\"token operator\">:</span> <span class=\"token number\">123456789</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                  first_name<span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                  username<span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                  type<span class=\"token operator\">:</span> <span class=\"token string\">\"private\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>             <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>             date<span class=\"token operator\">:</span> <span class=\"token number\">1558784616</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>             text<span class=\"token operator\">:</span> <span class=\"token string\">\"My first message to this bot\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>             <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></blockquote>\n<p>è®¾ç½® webhook æ–¹æ³•å¾ˆç®€å•ï¼Œæµè§ˆå™¨è®¿é—®è¿™ä¸ªç½‘ç«™å°±å¯ä»¥äº† <code>https://api.telegram.org/bot&#123;$token&#125;/setWebhook?url=&#123;$webhook_url&#125;</code></p>\n<p>è¿™æ ·åšäº†ä¹‹åç¡®å®æ˜¯å¯ä»¥è¿›è¡Œç®€å•çš„äº¤äº’çš„ï¼Œä½†æ˜¯å½“æˆ‘è®© bot æ‰§è¡Œä¸‹è½½æŠ–éŸ³å›¾ç‰‡è¿™ç§è€—æ—¶ä»»åŠ¡çš„æ—¶å€™ï¼Œvercel å…è´¹ç‰ˆçš„å¼Šç«¯å°±ä½“ç°å‡ºæ¥äº†ï¼Œ<strong> ä¸€ä¸ªå‡½æ•°æœ€é•¿åªèƒ½æ‰§è¡Œ 10 ç§’ï¼Œ10 ç§’åè¿™ä¸ªå‡½æ•°å°†ä¼šè¢«å¼ºåˆ¶åœæ­¢</strong>ï¼Œå¤ªè‰°éš¾äº†ï¼Œåªèƒ½é‡æ–°æ‰¾æ‰¾å…¶ä»–æ–¹æ³•å’¯</p>\n<h2 id=\"render\"><a class=\"anchor\" href=\"#render\">#</a> render</h2>\n<p>æœ€ç»ˆæˆ‘çš„ bot ä»£ç æ˜¯éƒ¨ç½²åœ¨ render ä¸Šé¢çš„ï¼Œå…è´¹ç‰ˆæ¯ä¸ªæœˆ 750 å°æ—¶å®Œå…¨å¤Ÿç”¨äº† (è¦çŸ¥é“ä¸€ä¸ªæœˆæœ€é•¿ä¹Ÿå°± 744 å°æ—¶å‘¢)</p>\n<p>é¦–å…ˆæˆ‘ä»¬å»<span class=\"exturl\" data-url=\"aHR0cHM6Ly9yZW5kZXIuY29tLw==\"> render</span> ä¸Šæ³¨å†Œä¸€ä¸ªè´¦å·</p>\n<p>ç„¶ååœ¨å³ä¸Šè§’ç‚¹å‡» <code>New</code> , å¹¶åˆ›å»ºä¸€ä¸ª Web Service</p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231234329521.png\" alt=\"image-20231231234329521\" style=\"aspect-ratio:751 / 548;\"></p>\n<p>é€‰æ‹© <code>Build and deploy from a Git repository</code>  å¹¶ç‚¹å‡» <code>Next</code></p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231234639194.png\" alt=\"image-20231231234639194\" style=\"aspect-ratio:1024 / 647;\"></p>\n<p>ä½ å¯ä»¥å°†<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL29hY2lhL29hY2lhX2JvdA==\"> oacia_bot</span> fork åˆ°ä½ çš„ä»“åº“é‡Œé¢ï¼Œæˆ–è€…ç›´æ¥ç”¨ bot ä»“åº“çš„ git é“¾æ¥æ¥åˆ›å»º <code>https://github.com/oacia/oacia_bot</code></p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231234712486.png\" alt=\"image-20231231234712486\" style=\"aspect-ratio:1117 / 291;\"></p>\n<p>ä¹‹åå°±æ˜¯è®¾å®šè¿è¡Œçš„ç¯å¢ƒäº†ï¼Œåç§°ä¸é‡å¤å°±å¯ä»¥äº†ï¼Œregion è¡¨ç¤ºæœåŠ¡å™¨ï¼Œå“ªä¸ªæœåŠ¡å™¨ç¦»ä½ è¿‘å°±é€‰å“ªä¸ª</p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231234819187.png\" alt=\"image-20231231234819187\" style=\"aspect-ratio:1646 / 572;\"></p>\n<p>æ¥ä¸‹æ¥è¿™ä¸ª Start Command éœ€è¦å¡«å…¥ <code>python main.py</code> , æœåŠ¡å™¨ç¤ºä¾‹é€‰æ‹©å…è´¹å°±å¤Ÿç”¨äº†</p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231234859286.png\" alt=\"image-20231231234859286\" style=\"aspect-ratio:1604 / 836;\"></p>\n<p>å†å¾€ä¸‹çœ‹ï¼Œæˆ‘ä»¬è¦è®¾å®šè¿™å››ä¸ªç¯å¢ƒå˜é‡ï¼Œå‰é¢ä¸‰ä¸ªæˆ‘ä»¬ä¹‹å‰å°±è·å–è¿‡äº†ï¼Œå¡«å…¥å³å¯ï¼Œè¿™ä¸ª <code>RENDER_NAME</code>  æ˜¯æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„ <code>Web Service</code>  çš„åç§°</p>\n<p><img data-src=\"/telegram-bot-develop/image-20231231235238966.png\" alt=\"image-20231231235238966\" style=\"aspect-ratio:1624 / 590;\"></p>\n<p>è¿™ä¸ª <code>RENDER_NAME</code>  çš„ä½œç”¨æ˜¯ç»™ bot è®¾ç½® webhook ç”¨çš„ï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿ</p>\n<p>å› ä¸º render çš„å…è´¹äº‘æœåŠ¡åŒæ ·æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œå°±æ˜¯å¦‚æœ 15 åˆ†é’Ÿå†…æ²¡æœ‰æµé‡è®¿é—®æˆ‘ä»¬åˆ›å»ºçš„ web æœåŠ¡ï¼Œé‚£ä¹ˆè¿™ä¸ªæœåŠ¡å°†ä¼šè¢«æš‚åœï¼Œç›´åˆ°æœ‰æµé‡ç»è¿‡ web æœåŠ¡æ—¶ï¼Œè¿™ä¸ªæœåŠ¡æ‰ä¼šè¢«é‡æ–°å¯åŠ¨ï¼Œè€Œæˆ‘æ‰€ä½¿ç”¨çš„æ˜¯ telethon, è¦ç›´åˆ°æœåŠ¡å…³äº†å¯å°±æ˜¯çœŸå…³äº†ï¼Œtelethon åˆ›å»ºçš„ client ä¹Ÿå› æ­¤æ— æ³•å’Œ telegram æœåŠ¡å™¨é€šä¿¡äº†</p>\n<p>æ‰€ä»¥æˆ‘çš„åšæ³•æ˜¯ç»™ bot è®¾ç½®äº†ä¸€ä¸ª webhook</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>render_name <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>getenv<span class=\"token punctuation\">(</span><span class=\"token string\">\"RENDER_NAME\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> render_name<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"https://api.telegram.org/bot</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>bot_token<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">/setWebhook?url=https://</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>render_name<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">.onrender.com/webhook\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> requests<span class=\"token punctuation\">.</span>status_codes <span class=\"token operator\">==</span> <span class=\"token number\">200</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"set webhook successful\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>å¹¶ç”¨ flask å¼€æ”¾äº†ä¸€ä¸ª webhook çš„è·¯ç”±</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># render å¿…é¡»å¾—èµ·ä¸€ä¸ª http æœåŠ¡ï¼Œå¦åˆ™å°±ä¼šæ–­å¼€è¿æ¥....</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> Flask</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>app <span class=\"token operator\">=</span> Flask<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">home</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token string\">\"hello world\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/webhook'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">webhook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token string\">'ok'</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    app<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span>host<span class=\"token operator\">=</span><span class=\"token string\">'0.0.0.0'</span><span class=\"token punctuation\">,</span> port<span class=\"token operator\">=</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>å½“æœ‰äººç»™ bot å‘æ¶ˆæ¯æ—¶ï¼Œtelegram æœåŠ¡å™¨åŒæ—¶ä¹Ÿä¼šç»™æˆ‘ä»¬è®¾ç½®çš„ webhook ç½‘å€å‘é€ä¸€ä¸ª post çš„ http è¯·æ±‚ï¼Œè¿™æ ·æˆ‘ä»¬çš„ render æœåŠ¡å³ä½¿å› ä¸º 15 åˆ†é’Ÿæ²¡æœ‰æµé‡ç»è¿‡è€Œè¢«æš‚åœäº†ï¼Œä¹Ÿä¼šå› ä¸º telegram æœåŠ¡å™¨çš„æµé‡ç»è¿‡è€Œè¢«é‡å¯ï¼Œtelethon å°±å¯ä»¥å†æ¬¡æˆåŠŸçš„å’Œ telegram æœåŠ¡å™¨é€šè®¯å•¦ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ bot å¯ä»¥ä¸€ç›´åœ¨ render ä¸Šé¢è¿è¡Œ <code>~â™ª(^âˆ‡^*)</code></p>\n",
            "tags": []
        },
        {
            "id": "https://oacia.dev/two-way-SSL/",
            "url": "https://oacia.dev/two-way-SSL/",
            "title": "(doing)httpsåŒå‘è®¤è¯åŠç»•è¿‡æ–¹æ³•",
            "date_published": "2023-12-14T10:00:32.000Z",
            "content_html": "<p>æ—¥å¸¸çš„ APP ä¸ºäº†ä¸è¢«åˆ«äººé€šè¿‡æŠ“åŒ…è½¯ä»¶æŠ“å–ä¸æœåŠ¡å™¨é€šä¿¡çš„æµé‡ï¼Œæ‰€ä»¥ä¼šåœ¨æµé‡çš„å®‰å…¨ä¼ è¾“ä¸Šåšæ–‡ç« ï¼Œæœ€å®‰å…¨çš„åšæ³•å½“ç„¶æ˜¯ä½¿ç”¨ç§æœ‰åè®® (å³åè®®æ ¼å¼ä¸å…¬å¼€çš„åè®®), ä¾‹å¦‚æŠ–éŸ³çš„ quic åè®®ï¼Œå’¸é±¼çš„ spdy åè®®ç­‰ç­‰ï¼Œåˆ©ç”¨è¿™äº›ç§æœ‰åè®®åŒ…è£…æµé‡ï¼Œä»è€Œä½¿æŠ“åŒ…å·¥å…·æ— æ³•è¯†åˆ«å‡ºè¿™ä¸²æµé‡çš„å®é™…å†…å®¹æ˜¯ä»€ä¹ˆï¼Œæ‰€ä»¥å°±åªèƒ½æ”¾è¡Œè¿™æ®µæµé‡ï¼Œé¢å¯¹ç§æœ‰åè®®å€˜è‹¥åˆ©ç”¨ <code>reqable</code> , <code>fiddler</code> , <code>charles</code>  ç­‰å»æŠ“åŒ…æ˜¯æŠ“ä¸åˆ°çš„ï¼Œè€Œå”¯ä¸€èƒ½å¤ŸæŠ“åˆ°è¿™æ®µæµé‡çš„å°±æ˜¯ <code>wireshark</code> , å¹¶ä¸”è¿˜éœ€è¦å¯¹è¿™æ®µæµé‡ç¼–å†™ç‰¹å®šçš„è„šæœ¬è§£ææ‰å¯ä»¥çŸ¥é“è¿™æ®µæµé‡æ‰€æºå¸¦çš„å®é™…æ•°æ®</p>\n<p>é™¤äº†ç§æœ‰åè®®ä¹‹å¤–ï¼Œæƒ³è®©æµé‡ä¸Šçš„å®‰å…¨è¿˜å¯ä»¥ä½¿ç”¨ <code>SSL pinning</code>  çš„æ–¹æ³•æ¥é˜»æ­¢ä¸­é—´äººæŠ“åŒ…çš„å‘ç”Ÿï¼Œå¦‚ä½•è¿›è¡Œ HTTPS åŒå‘è®¤è¯ä»¥åŠä½¿ç”¨ frida å¯¹ <code>SSL pinning</code>  è¿›è¡Œç»•è¿‡æ˜¯æœ¬æ–‡æ‰€è¦è®¨è®ºçš„é‡ç‚¹</p>\n<h1 id=\"ssl-pinning\"><a class=\"anchor\" href=\"#ssl-pinning\">#</a> SSL pinning</h1>\n<p>è™½ç„¶ HTTPS é‡‡ç”¨äº†å…¬é’¥å’Œè¯ä¹¦çš„åŠ å¯†å’ŒéªŒè¯æ–¹å¼ï¼Œä½†ä¾ç„¶å­˜åœ¨ MIM (ä¸­é—´äººæ”»å‡») çš„å¯èƒ½æ€§ï¼Œå› ä¸ºè¯ä¹¦é¢å‘æœºæ„å¯èƒ½è¢«é»‘å®¢å…¥ä¾µï¼Œè€Œ HTTPS åªéªŒè¯äº†è¯ä¹¦çš„åˆæ³•æ€§ï¼Œå¹¶æ²¡æœ‰éªŒè¯å½“å‰æœåŠ¡å™¨æ˜¯å¦æ˜¯æˆ‘ä»¬è¦è®¿é—®çš„æœåŠ¡å™¨ï¼Œæ‰€ä»¥éœ€è¦å®¢æˆ·ç«¯å»éªŒè¯æœåŠ¡ç«¯è¯ä¹¦çš„åˆæ³•æ€§ï¼Œè¿™å°±æ˜¯ <code>SSL pinning</code> , å®ƒè¿˜æ˜¯ HTTPS å•å‘è®¤è¯çš„èŒƒç•´ä¹‹å†…ã€‚</p>\n<p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ç›®å‰æŠ“åŒ…å·¥å…· <code>Charles</code>  æ‰€é‡‡å–çš„æŠ“åŒ…æ–¹æ³•</p>\n<p><img data-src=\"/two-way-SSL/640.png\" alt=\"å›¾ç‰‡\" style=\"aspect-ratio:700 / 483;\"></p>\n<p>ä¸ºäº†ä¿è¯æˆ‘ä»¬å½“å‰è®¿é—®çš„æœåŠ¡å™¨å°±æ˜¯æˆ‘ä»¬éœ€è¦è®¿é—®çš„æœåŠ¡å™¨ï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»çš„å‘ç”Ÿï¼Œéœ€è¦é€šè¿‡ <code>SSL pinning</code>  çš„æ–¹å¼æ¥å®ç°ï¼Œå…¶åŒ…æ‹¬ Certificate Pinning å’Œ Public Key Pinning ä¸¤ç§ã€‚</p>\n<h2 id=\"è¯ä¹¦é”å®š\"><a class=\"anchor\" href=\"#è¯ä¹¦é”å®š\">#</a> è¯ä¹¦é”å®š</h2>\n<p>è¯ä¹¦é”å®šéœ€è¦æŠŠæœåŠ¡å™¨çš„è¯ä¹¦æå‰ä¸‹è½½å¹¶å†…ç½®åˆ°å®¢æˆ·ç«¯ä¸­ï¼Œå½“è¯·æ±‚å‘èµ·æ—¶ï¼Œé€šè¿‡æ¯”å¯¹è¯ä¹¦å†…å®¹æ¥ç¡®å®šè¿æ¥çš„åˆæ³•æ€§ï¼Œä½†ç”±äºè¯ä¹¦å­˜åœ¨è¿‡æœŸæ—¶é—´ï¼Œå› æ­¤å½“æœåŠ¡å™¨ç«¯è¯ä¹¦æ›´æ¢æ—¶ï¼Œéœ€åŒæ—¶æ›´æ¢å®¢æˆ·ç«¯è¯ä¹¦ã€‚</p>\n<p>æ—¢ç„¶æ˜¯è¦é”å®šè¯ä¹¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å®¢æˆ·ç«¯ä¸Šåº”è¯¥äº‹å…ˆå­˜åœ¨ä¸€ä¸ªè¯ä¹¦ï¼Œæˆ‘ä»¬æ‰èƒ½é”å®šè¿™ä¸ªè¯ä¹¦æ¥éªŒè¯æˆ‘ä»¬çœŸæ­£çš„æœåŠ¡ç«¯ï¼Œè€Œä¸æ˜¯ä»£ç†å·¥å…·ä¼ªé€ çš„æœåŠ¡ç«¯ã€‚</p>\n<p>å¦‚æœæ˜¯é”å®šè¯ä¹¦ï¼Œé‚£é€šå¸¸æƒ…å†µä¸‹ä¼šå°†è¯ä¹¦æ”¾ç½®åœ¨ <code>app/asset</code>  ç›®å½•ä¸‹ã€‚</p>\n<p>å…·ä½“æ“ä½œï¼šå°† APP ä»£ç å†…ç½®ä»…æ¥å—æŒ‡å®šåŸŸåçš„è¯ä¹¦ï¼Œè€Œä¸æ¥å—æ“ä½œç³»ç»Ÿæˆ–è€…æµè§ˆå™¨å†…ç½®çš„ CA æ ¹è¯ä¹¦å¯¹åº”çš„ä»»ä½•è¯ä¹¦ã€‚</p>\n<p>é€šè¿‡è¿™ç§æˆæƒæ–¹å¼ï¼Œä¿éšœäº† APP ä¸æœåŠ¡ç«¯é€šä¿¡çš„å”¯ä¸€æ€§å’Œå®‰å…¨æ€§ï¼Œå› æ­¤ç§»åŠ¨ç«¯ APP ä¸æœåŠ¡ç«¯ï¼ˆä¾‹å¦‚ API ç½‘å…³ï¼‰ä¹‹é—´çš„é€šä¿¡å¯ä»¥ä¿è¯ç»å¯¹çš„å®‰å…¨ã€‚</p>\n<h2 id=\"å…¬é’¥é”å®š\"><a class=\"anchor\" href=\"#å…¬é’¥é”å®š\">#</a> å…¬é’¥é”å®š</h2>\n<p>å…¬é’¥é”å®šåˆ™éœ€æå–è¯ä¹¦ä¸­çš„å…¬é’¥å†…ç½®åˆ°å®¢æˆ·ç«¯ä¸­ï¼Œé€šè¿‡æ¯”å¯¹å…¬é’¥å€¼æ¥éªŒè¯è¿æ¥çš„åˆæ³•æ€§ï¼Œç”±äºè¯ä¹¦æ›´æ¢ä¾ç„¶å¯ä»¥ä¿è¯å…¬é’¥ä¸€è‡´ï¼Œæ‰€ä»¥å…¬é’¥é”å®šä¸å­˜åœ¨å®¢æˆ·ç«¯é¢‘ç¹æ›´æ¢è¯ä¹¦çš„é—®é¢˜ï¼Œå¹¶ä¸”ä¹‹åæˆ‘ä»¬æ‰€ä½¿ç”¨çš„ <code>SSL pinning</code>  ä¹ŸåŒæ ·æ˜¯å…¬é’¥é”å®šã€‚</p>\n<h1 id=\"httpsåŒå‘è®¤è¯åŸç†\"><a class=\"anchor\" href=\"#httpsåŒå‘è®¤è¯åŸç†\">#</a> HTTPS åŒå‘è®¤è¯åŸç†</h1>\n<p>åŒå‘éªŒè¯ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨ç«¯è¯ä¹¦çš„æ­£ç¡®æ€§ï¼ŒæœåŠ¡å™¨ç«¯ä¹ŸéªŒè¯å®¢æˆ·ç«¯çš„è¯ä¹¦æ­£ç¡®æ€§ï¼Œå³</p>\n<ul>\n<li>æœåŠ¡ç«¯ä½¿ç”¨ <code>ca.crt</code>  æ ¡éªŒå®¢æˆ·ç«¯çš„ <code>client.crt</code>  å’Œ <code>client.key</code></li>\n<li>å®¢æˆ·ç«¯ä½¿ç”¨ <code>ca.crt</code>  æ ¡éªŒæœåŠ¡ç«¯çš„ <code>server.crt</code>  å’Œ <code>server.key</code></li>\n</ul>\n<p><img data-src=\"/two-way-SSL/ca-2way-auth-2.png\" alt=\"img\" style=\"aspect-ratio:301 / 271;\"></p>\n<p>è¯¦ç»†çš„ HTTPS è¿æ¥è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­çš„ <code>root.crt</code>  å³ <code>ca.crt</code></p>\n<p><img data-src=\"/two-way-SSL/p620909.png\" alt=\"image\" style=\"aspect-ratio:1492 / 1190;\"></p>\n<ol>\n<li>å®¢æˆ·ç«¯å‘èµ·å»ºç«‹ HTTPS è¿æ¥è¯·æ±‚ï¼Œå°† SSL åè®®ç‰ˆæœ¬çš„ä¿¡æ¯å‘é€ç»™æœåŠ¡ç«¯ï¼›</li>\n<li>æœåŠ¡å™¨ç«¯å°†æœ¬æœºçš„å…¬é’¥è¯ä¹¦ï¼ˆserver.crtï¼‰å‘é€ç»™å®¢æˆ·ç«¯ï¼›</li>\n<li>å®¢æˆ·ç«¯è¯»å–å…¬é’¥è¯ä¹¦ï¼ˆserver.crtï¼‰ï¼Œå–å‡ºäº†æœåŠ¡ç«¯å…¬é’¥ï¼›</li>\n<li>å®¢æˆ·ç«¯å°†å®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦ï¼ˆclient.crtï¼‰å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼›</li>\n<li>æœåŠ¡å™¨ç«¯ä½¿ç”¨æ ¹è¯ä¹¦ï¼ˆroot.crtï¼‰è§£å¯†å®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦ï¼Œæ‹¿åˆ°å®¢æˆ·ç«¯å…¬é’¥ï¼›</li>\n<li>å®¢æˆ·ç«¯å‘é€è‡ªå·±æ”¯æŒçš„åŠ å¯†æ–¹æ¡ˆç»™æœåŠ¡å™¨ç«¯ï¼›</li>\n<li>æœåŠ¡å™¨ç«¯æ ¹æ®è‡ªå·±å’Œå®¢æˆ·ç«¯çš„èƒ½åŠ›ï¼Œé€‰æ‹©ä¸€ä¸ªåŒæ–¹éƒ½èƒ½æ¥å—çš„åŠ å¯†æ–¹æ¡ˆï¼Œä½¿ç”¨å®¢æˆ·ç«¯çš„å…¬é’¥åŠ å¯†åå‘é€ç»™å®¢æˆ·ç«¯ï¼›</li>\n<li>å®¢æˆ·ç«¯ä½¿ç”¨è‡ªå·±çš„ç§é’¥è§£å¯†åŠ å¯†æ–¹æ¡ˆï¼Œç”Ÿæˆä¸€ä¸ªéšæœºæ•° Rï¼Œä½¿ç”¨æœåŠ¡å™¨å…¬é’¥åŠ å¯†åä¼ ç»™æœåŠ¡å™¨ç«¯ï¼›</li>\n<li>æœåŠ¡ç«¯ç”¨è‡ªå·±çš„ç§é’¥å»è§£å¯†è¿™ä¸ªå¯†æ–‡ï¼Œå¾—åˆ°äº†å¯†é’¥ R</li>\n<li>æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åœ¨åç»­é€šè®¯è¿‡ç¨‹ä¸­å°±ä½¿ç”¨è¿™ä¸ªå¯†é’¥ R è¿›è¡Œé€šä¿¡äº†ã€‚</li>\n</ol>\n<h1 id=\"è‡ªç­¾åè¯ä¹¦\"><a class=\"anchor\" href=\"#è‡ªç­¾åè¯ä¹¦\">#</a> è‡ªç­¾åè¯ä¹¦</h1>\n<h2 id=\"è¯ä¹¦å‡†å¤‡\"><a class=\"anchor\" href=\"#è¯ä¹¦å‡†å¤‡\">#</a> è¯ä¹¦å‡†å¤‡</h2>\n<p>åœ¨åˆ¶ä½œè¯ä¹¦å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹æ¯ä¸€ä¸ªè¯ä¹¦çš„æ ¼å¼</p>\n<ul>\n<li>JKSï¼šæ•°å­—è¯ä¹¦åº“ã€‚JKS é‡Œæœ‰ KeyEntry å’Œ CertEntryï¼Œåœ¨åº“é‡Œçš„æ¯ä¸ª Entry éƒ½æ˜¯é åˆ«åï¼ˆaliasï¼‰æ¥è¯†åˆ«çš„ã€‚</li>\n<li>P12ï¼šæ˜¯ PKCS12 çš„ç¼©å†™ã€‚åŒæ ·æ˜¯ä¸€ä¸ªå­˜å‚¨ç§é’¥çš„è¯ä¹¦åº“ï¼Œç”± .jks æ–‡ä»¶å¯¼å‡ºçš„ï¼Œç”¨æˆ·åœ¨ PC å¹³å°å®‰è£…ï¼Œç”¨äºæ ‡ç¤ºç”¨æˆ·çš„èº«ä»½ã€‚</li>\n<li>CERï¼šä¿—ç§°æ•°å­—è¯ä¹¦ï¼Œç›®çš„å°±æ˜¯ç”¨äºå­˜å‚¨å…¬é’¥è¯ä¹¦ï¼Œä»»ä½•äººéƒ½å¯ä»¥è·å–è¿™ä¸ªæ–‡ä»¶ ã€‚</li>\n<li>BKSï¼šç”±äº Android å¹³å°ä¸è¯†åˆ« .keystore å’Œ .jks æ ¼å¼çš„è¯ä¹¦åº“æ–‡ä»¶ï¼Œå› æ­¤ Android å¹³å°å¼•å…¥ä¸€ç§æ–°çš„è¯ä¹¦åº“æ ¼å¼ï¼ŒBKSã€‚</li>\n</ul>\n<p>æ•´ä¸ªåŒå‘è®¤è¯çš„æµç¨‹éœ€è¦å…­ä¸ªè¯ä¹¦æ–‡ä»¶ï¼š</p>\n<ul>\n<li>æœåŠ¡å™¨ç«¯å…¬é’¥è¯ä¹¦ï¼šserver.crt</li>\n<li>æœåŠ¡å™¨ç«¯ç§é’¥æ–‡ä»¶ï¼šserver.key</li>\n<li>æ ¹è¯ä¹¦ï¼šroot.crt</li>\n<li>å®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦ï¼šclient.crt</li>\n<li>å®¢æˆ·ç«¯ç§é’¥æ–‡ä»¶ï¼šclient.key</li>\n<li>å®¢æˆ·ç«¯é›†æˆè¯ä¹¦ï¼ˆåŒ…æ‹¬å…¬é’¥å’Œç§é’¥ï¼Œç”¨äºå®‰å“è®¿é—®åœºæ™¯ï¼‰ï¼šclient.bks</li>\n</ul>\n<h2 id=\"è¯ä¹¦åˆ¶ä½œ\"><a class=\"anchor\" href=\"#è¯ä¹¦åˆ¶ä½œ\">#</a> è¯ä¹¦åˆ¶ä½œ</h2>\n<p>å› ä¸ºè‡ªç­¾åè¯ä¹¦å®Œå…¨å…è´¹ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨è‡ªç­¾åè¯ä¹¦æ¥ä½œä¸ºæˆ‘ä»¬çš„å®¢æˆ·ç«¯ / æœåŠ¡ç«¯è¯ä¹¦</p>\n<p><img data-src=\"/two-way-SSL/p620908.png\" alt=\"image\" style=\"aspect-ratio:1448 / 706;\"></p>\n<h3 id=\"ç”Ÿæˆè‡ªç­¾åæ ¹è¯ä¹¦\"><a class=\"anchor\" href=\"#ç”Ÿæˆè‡ªç­¾åæ ¹è¯ä¹¦\">#</a> ç”Ÿæˆè‡ªç­¾åæ ¹è¯ä¹¦</h3>\n<ol>\n<li>åˆ›å»ºæ ¹è¯ä¹¦ç§é’¥ï¼š</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl genrsa <span class=\"token parameter variable\">-out</span> root.key <span class=\"token number\">1024</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>åˆ›å»ºæ ¹è¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼š</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl req <span class=\"token parameter variable\">-new</span> <span class=\"token parameter variable\">-out</span> root.csr <span class=\"token parameter variable\">-key</span> root.key</pre></td></tr></table></figure><p>è¿™ä¸€æ­¥ä»¥åŠä¸‹é¢ç”ŸæˆæœåŠ¡å™¨è¯·æ±‚æ–‡ä»¶å’Œå®¢æˆ·ç«¯è¯·æ±‚æ–‡ä»¶çš„è¿‡ç¨‹éƒ½éƒ½è¦æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>\n<ul>\n<li>æ ¹è¯ä¹¦çš„ Common Name å¡«å†™ root å°±å¯ä»¥ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„è¯ä¹¦è¿™ä¸ªå­—æ®µéœ€è¦å¡«å†™åŸŸåï¼Œä¸€å®šè¦æ³¨æ„çš„æ˜¯ï¼Œæ ¹è¯ä¹¦çš„è¿™ä¸ªå­—æ®µå’Œå®¢æˆ·ç«¯è¯ä¹¦ã€æœåŠ¡å™¨ç«¯è¯ä¹¦<strong>ä¸èƒ½ä¸€æ ·</strong></li>\n<li>å…¶ä»–æ‰€æœ‰å­—æ®µçš„å¡«å†™ï¼Œæ ¹è¯ä¹¦ã€æœåŠ¡å™¨ç«¯è¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦éœ€ä¿æŒä¸€è‡´æœ€åçš„å¯†ç å¯ä»¥ç›´æ¥<strong>å›è½¦è·³è¿‡</strong>ã€‚</li>\n</ul>\n<ol start=\"3\">\n<li>åˆ›å»ºæ ¹è¯ä¹¦ï¼š</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl x509 <span class=\"token parameter variable\">-req</span> <span class=\"token parameter variable\">-in</span> root.csr <span class=\"token parameter variable\">-out</span> root.crt <span class=\"token parameter variable\">-signkey</span> root.key <span class=\"token parameter variable\">-CAcreateserial</span> <span class=\"token parameter variable\">-days</span> <span class=\"token number\">3650</span></pre></td></tr></table></figure><p>ç»è¿‡ä¸Šé¢ä¸‰ä¸ªå‘½ä»¤è¡Œï¼Œæˆ‘ä»¬æœ€ç»ˆå¯ä»¥å¾—åˆ°ä¸€ä¸ªç­¾åæœ‰æ•ˆæœŸä¸º 10 å¹´çš„æ ¹è¯ä¹¦ root.crtï¼Œåé¢æˆ‘ä»¬å¯ä»¥ç”¨è¿™ä¸ªæ ¹è¯ä¹¦å»é¢å‘æœåŠ¡å™¨è¯ä¹¦å’Œå®¢æˆ·ç«¯è¯ä¹¦ã€‚</p>\n<h3 id=\"ç”Ÿæˆè‡ªç­¾åæœåŠ¡å™¨ç«¯è¯ä¹¦\"><a class=\"anchor\" href=\"#ç”Ÿæˆè‡ªç­¾åæœåŠ¡å™¨ç«¯è¯ä¹¦\">#</a> ç”Ÿæˆè‡ªç­¾åæœåŠ¡å™¨ç«¯è¯ä¹¦</h3>\n<ol>\n<li>ç”ŸæˆæœåŠ¡å™¨ç«¯è¯ä¹¦ç§é’¥ï¼š</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl genrsa <span class=\"token parameter variable\">-out</span> server.key <span class=\"token number\">1024</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦è¯·æ±‚æ–‡ä»¶ï¼Œè¿‡ç¨‹å’Œæ³¨æ„äº‹é¡¹å‚è€ƒæ ¹è¯ä¹¦ï¼Œæœ¬èŠ‚ä¸è¯¦è¿°ï¼š</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl req <span class=\"token parameter variable\">-new</span> <span class=\"token parameter variable\">-out</span> server.csr <span class=\"token parameter variable\">-key</span> server.key</pre></td></tr></table></figure><ol start=\"3\">\n<li>ç”ŸæˆæœåŠ¡å™¨ç«¯å…¬é’¥è¯ä¹¦</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl x509 <span class=\"token parameter variable\">-req</span> <span class=\"token parameter variable\">-in</span> server.csr <span class=\"token parameter variable\">-out</span> server.crt <span class=\"token parameter variable\">-CA</span> root.crt <span class=\"token parameter variable\">-CAkey</span> root.key <span class=\"token parameter variable\">-CAcreateserial</span> <span class=\"token parameter variable\">-days</span> <span class=\"token number\">3650</span></pre></td></tr></table></figure><p>ç»è¿‡ä¸Šé¢çš„ä¸‰ä¸ªå‘½ä»¤ï¼Œæˆ‘ä»¬å¾—åˆ°ï¼š</p>\n<ul>\n<li>\n<p>server.keyï¼šæœåŠ¡å™¨ç«¯çš„å¯†é’¥æ–‡ä»¶</p>\n</li>\n<li>\n<p>server.crtï¼šæœ‰æ•ˆæœŸåå¹´çš„æœåŠ¡å™¨ç«¯å…¬é’¥è¯ä¹¦ï¼Œä½¿ç”¨æ ¹è¯ä¹¦å’ŒæœåŠ¡å™¨ç«¯ç§é’¥æ–‡ä»¶ä¸€èµ·ç”Ÿæˆ</p>\n</li>\n</ul>\n<h3 id=\"ç”Ÿæˆè‡ªç­¾åå®¢æˆ·ç«¯è¯ä¹¦\"><a class=\"anchor\" href=\"#ç”Ÿæˆè‡ªç­¾åå®¢æˆ·ç«¯è¯ä¹¦\">#</a> ç”Ÿæˆè‡ªç­¾åå®¢æˆ·ç«¯è¯ä¹¦</h3>\n<ol>\n<li>ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦å¯†é’¥ï¼š</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl genrsa <span class=\"token parameter variable\">-out</span> client.key <span class=\"token number\">1024</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦è¯·æ±‚æ–‡ä»¶</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl req <span class=\"token parameter variable\">-new</span> <span class=\"token parameter variable\">-out</span> client.csr <span class=\"token parameter variable\">-key</span> client.key</pre></td></tr></table></figure><ol start=\"3\">\n<li>ç”Ÿå®¢æˆ·ç«¯è¯ä¹¦</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl x509 <span class=\"token parameter variable\">-req</span> <span class=\"token parameter variable\">-in</span> client.csr <span class=\"token parameter variable\">-out</span> client.crt <span class=\"token parameter variable\">-CA</span> root.crt <span class=\"token parameter variable\">-CAkey</span> root.key <span class=\"token parameter variable\">-CAcreateserial</span> <span class=\"token parameter variable\">-days</span> <span class=\"token number\">3650</span></pre></td></tr></table></figure><ol start=\"4\">\n<li>ç”Ÿå®¢æˆ·ç«¯ bks æ ¼å¼è¯ä¹¦</li>\n</ol>\n<p>æˆ‘ä»¬é¦–å…ˆæŸ¥çœ‹è‡ªå·±çš„ java ç‰ˆæœ¬ï¼Œä¾‹å¦‚æˆ‘ç°åœ¨çš„ java ç‰ˆæœ¬æ˜¯ jdk1.7</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS C:<span class=\"token punctuation\">\\</span>Users<span class=\"token punctuation\">\\</span>oacia<span class=\"token operator\">></span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">--version</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">java</span> <span class=\"token number\">17.0</span>.8 <span class=\"token number\">2023</span>-07-18 LTS</pre></td></tr></table></figure><p>ç„¶åå‰å¾€ [https://www.bouncycastle.org/latest_releases.html) ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ <code>bcprov</code> , æˆ‘çš„ jdk1.7 åº”è¯¥ä¸‹è½½çš„ jar åŒ…æ˜¯<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYm91bmN5Y2FzdGxlLm9yZy9kb3dubG9hZC9iY3Byb3YtamRrMTV0bzE4LTE3Ny5qYXI=\"> bcprov-jdk15to18-177.jar</span></p>\n<p>éšåè¾“å…¥ä¸‹åˆ—å‘½ä»¤å³å¯å°† crt æ ¼å¼çš„è¯ä¹¦è½¬æ¢ä¸º bks æ ¼å¼çš„è¯ä¹¦</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>keytool <span class=\"token parameter variable\">-import</span> <span class=\"token parameter variable\">-alias</span> client <span class=\"token parameter variable\">-file</span> .<span class=\"token punctuation\">\\</span>client.crt <span class=\"token parameter variable\">-keystore</span> .<span class=\"token punctuation\">\\</span>client.bks <span class=\"token parameter variable\">-storetype</span> BKS <span class=\"token parameter variable\">-provider</span> org.bouncycastle.jce.provider.BouncyCastleProvider <span class=\"token parameter variable\">-providerpath</span> .<span class=\"token punctuation\">\\</span>bcprov-jdk15to18-177.jar <span class=\"token parameter variable\">-storepass</span> <span class=\"token number\">123456</span></pre></td></tr></table></figure><p>åŒç†ï¼Œæˆ‘ä»¬å¯ä»¥å°†å°†æ ¹è¯ä¹¦ <code>root.crt</code>  ä¹Ÿè½¬æ¢ä¸º <code>root.bks</code> , å› ä¸ºåœ¨ Android ä¸­æ™ºèƒ½è¯†åˆ« bks æ ¼å¼çš„è¯ä¹¦</p>\n<p>##ã€€æ€»ç»“</p>\n<p>é€šè¿‡ä¸Šè¿°è¿‡ç¨‹è‡ªå®šä¹‰è¯ä¹¦çš„åˆ¶ä½œï¼Œæˆ‘ä»¬å·²ç»å¾—åˆ°äº†æ‰€éœ€è¦çš„è¯ä¹¦</p>\n<ul>\n<li>android å®¢æˆ·ç«¯\n<ul>\n<li><code>client.bks</code> : è¿™æ˜¯å®¢æˆ·ç«¯è¯ä¹¦ï¼Œéœ€è¦å‘é€ç»™æœåŠ¡ç«¯è¿›è¡Œæ ¡éªŒ</li>\n<li><code>root.bks</code> : è¿™æ˜¯æ ¹è¯ä¹¦ï¼Œç”¨æ¥æ ¡éªŒæœåŠ¡ç«¯è¯ä¹¦çš„åˆæ³•æ€§</li>\n</ul>\n</li>\n<li>python æœåŠ¡ç«¯\n<ul>\n<li><code>server.crt</code>  å’Œ <code>server.key</code> : è¿™æ˜¯æœåŠ¡ç«¯è¯ä¹¦ï¼Œéœ€è¦å‘é€ç»™å®¢æˆ·ç«¯è¿›è¡Œæ ¡éªŒ</li>\n<li><code>root.crt</code> : è¿™æ˜¯æ ¹è¯ä¹¦ï¼Œç”¨æ¥æ ¡éªŒå®¢æˆ·ç«¯è¯ä¹¦çš„åˆæ³•æ€§</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"androidå®¢æˆ·ç«¯\"><a class=\"anchor\" href=\"#androidå®¢æˆ·ç«¯\">#</a> Android å®¢æˆ·ç«¯</h2>\n<h1 id=\"å‚è€ƒèµ„æ–™\"><a class=\"anchor\" href=\"#å‚è€ƒèµ„æ–™\">#</a> å‚è€ƒèµ„æ–™</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20venBjaGNiZC9wLzEzNzA5NjkwLmh0bWw=\">å…³äºå•å‘è®¤è¯ä¸åŒå‘è®¤è¯ </span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZWxwLmFsaXl1bi5jb20vemgvYXBpLWdhdGV3YXkvdXNlci1ndWlkZS9tdXR1YWwtdGxzLWF1dGhlbnRpY2F0aW9uI3NlY3Rpb24tajhyLWFmeC03MTk=\">é˜¿é‡Œäº‘ HTTPS åŒå‘è®¤è¯</span></li>\n</ul>\n",
            "tags": []
        },
        {
            "id": "https://oacia.dev/blog-domain/",
            "url": "https://oacia.dev/blog-domain/",
            "title": "è¿™ä¸¤ä¸ªæœˆå…³äºåŸŸåçš„äºŒä¸‰äº‹",
            "date_published": "2023-12-12T16:59:22.000Z",
            "content_html": "<p>ä»Šå¤©åˆšåœ¨ <code>namesilo</code>  è´­ä¹°äº†ä¸€ä¸ªæ–°çš„åŸŸå <code>oacia.dev</code> , è¦æ˜¯æœ‰äººæ¥è¿‡æˆ‘çš„åšå®¢çš„è¯ï¼Œåº”è¯¥è®°å¾—è¿™ä¸ªåšå®¢æ›¾ç»çš„åŸŸåæ˜¯ <code>oacia.cc</code> , å½“ç„¶äº†æˆ‘ä¹Ÿéå¸¸å–œæ¬¢ <code>cc</code>  è¿™ä¸ªé¡¶çº§åŸŸåï¼Œè¿™ä¸ªåŸŸåæ˜¯æˆ‘ä¸€å¹´å‰æ³¨å†Œçš„ï¼Œä¸è¿‡ä¸å¹¸çš„æ˜¯åœ¨ä»Šå¹´ä¹æœˆä»½çš„æ—¶å€™ï¼Œæˆ‘çš„åŸŸåè¿‡æœŸäº†ï¼Œå½“æ—¶æˆ‘çœ‹åˆ° 75 å—çš„ç»­è´¹ä»·æ ¼è¿˜çº³é—·ä¸ºä»€ä¹ˆå˜è´µäº†ï¼Œå› ä¸ºå»å¹´çš„æ—¶å€™æˆ‘è®°å¾—éå¸¸æ¸…æ¥šç»­è´¹åªéœ€è¦ä¸‰åå¤šå…ƒçš„ï¼Œéšåå°±çœ‹åˆ°äº†<span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZWxwLmFsaXl1bi5jb20vbm90aWNlbGlzdC9hcnRpY2xlaWQvMTA2MTg3MDMwMi5odG1s\">é˜¿é‡Œäº‘çš„å…¬å‘Š</span>è¯´ <code>cc</code>  åŸŸåè¦æ¶¨ä»·äº†â€¦</p>\n<p><img data-src=\"/blog-domain/image-20231213011214762.png\" alt=\"image-20231213011214762\" style=\"aspect-ratio:1453 / 396;\"></p>\n<p>å”‰å¤ªéš¾å—äº†ï¼Œéšåæˆ‘å°±å»è…¾è®¯äº‘å’Œåä¸ºäº‘éƒ½å»æœäº†ä¸€ä¸‹ <code>cc</code>  è¿™ä¸ªé¡¶çº§åŸŸåçš„ä»·æ ¼ï¼ŒéšåæƒŠè®¶çš„å‘ç°åä¸ºäº‘åªéœ€è¦ 35 å…ƒ / å¹´ï¼Œå½“æ—¶æˆ‘æƒ³é‚£æˆ‘ç›´æ¥æŠŠåŸŸåè½¬åˆ°åä¸ºäº‘ä¸å°±å¥½äº†ï¼Œè½¬ç§»æ³¨å†Œå•†åº”è¯¥æ˜¯å¾ˆæ–¹ä¾¿çš„äº‹æƒ…å§ï¼Œéšåæˆ‘å°è¯•ä¸€ä¸‹æ‰å‘ç°ï¼Œ<strong> åŸŸåè¿‡æœŸä¹‹åå°±ä¸èƒ½å†è½¬ç§»åŸŸåäº†</strong>ï¼Œè€Œæˆ‘åˆä¸æ˜¯å¾ˆæƒ³åœ¨è´µäº†æ¥è¿‘ 50ï¼…ä»·æ ¼çš„é˜¿é‡Œäº‘ç»­è´¹åŸŸåï¼Œæ‰€ä»¥æˆ‘æƒ³çš„æ˜¯åŸŸååº”è¯¥å¾ˆå¿«å°±ä¼šè¢«åˆ é™¤äº†å§ï¼Œç»“æœå‘¢ï¼Œåˆå»ç½‘ä¸Šçœ‹äº†ä¸€ä¸‹ï¼Œcc åŸŸåè¦ç­‰ 30 å¤©çš„ç»­è´¹å®½é™æœŸå’Œ 29 å¤©çš„èµå›æœŸä¹‹åæ‰ä¼šè¢«å®Œå…¨åˆ é™¤å¼€æ”¾æ³¨å†Œ.</p>\n<p><img data-src=\"/blog-domain/image-20231213011944646.png\" alt=\"image-20231213011944646\" style=\"aspect-ratio:1182 / 722;\"></p>\n<p>è¿™å°±æ„å‘³ç€æˆ‘éœ€è¦ç­‰åˆ°ä¸¤ä¸ªæœˆä¹‹å (ä¹Ÿå°±æ˜¯ 12 æœˆä»½), è¿™ä¸ªåŸŸåæ‰èƒ½é‡æ–°è´­ä¹°ï¼Œæ‰€ä»¥è¿™æ®µæ—¶é—´åŸŸåè¿‡æœŸäº†ä¹‹åæˆ‘ä¹Ÿå°±æ²¡æœ‰å†ç®¡äº†ï¼Œæƒ³ç€æˆ‘åªè¦ç­‰åˆ° 12 æœˆä»½çš„æ—¶å€™å†é‡æ–°åœ¨åä¸ºäº‘æŠŠ <code>oacia.cc</code>  è¿™ä¸ªåŸŸåä¹°å›æ¥ä¸å°±è¡Œäº†</p>\n<p>äºæ˜¯ç­‰å‘€ç­‰å‘€ç­‰å‘€ç­‰å‘€ï¼Œç»ˆäºç†¬åˆ°äº†åäºŒæœˆä»½ï¼Œè¯´å®è¯è¿™ä¸¤ä¸ªæœˆåšå®¢æ— æ³•è®¿é—®çš„æ—¶é—´è®©æˆ‘å‘ç°æˆ‘çš„åšå®¢å¯¹æˆ‘æ¥è¯´æœ‰å¤šä¹ˆçš„é‡è¦ã€‚è¿™ä¸¤ä¸ªæœˆæˆ‘æ€»æ˜¯æ— å¿ƒç ”ç©¶ï¼Œæ•´å¤©ä¸çŸ¥é“æ€ä¹ˆçš„æ—¶é—´å°±è¿‡å»äº†ï¼Œç„¶åå°±åˆ°æ™šä¸Šäº†ï¼Œç„¶åå°±ç¡è§‰ç¡åˆ°ç¬¬äºŒå¤©ä¸­åˆèµ·æ¥ç»§ç»­æ¶ˆç£¨æ—¶é—´ï¼Œè¿™ç§æ„Ÿè§‰å°±å’Œæˆ‘å½“æ—¶é«˜è€ƒå®Œä¹‹ååœ¨å®¶æ— æ‰€äº‹äº‹çš„æ„Ÿè§‰ç‰¹åˆ«ç›¸ä¼¼ï¼Œé‚£ä¸€ç§ä¸€æ•´å¤©æ²¡æœ‰ç›®æ ‡çš„æ„Ÿè§‰è®©æˆ‘æ„Ÿè§‰ç‰¹åˆ«çš„ä¸èˆ’æœ.</p>\n<p>ä¸€ä¸ªåšå®¢ä¸ä»…èƒ½è®©æˆ‘å³æ—¶è®°å½•ä¸‹ç°åœ¨å­¦åˆ°çš„çŸ¥è¯†ï¼Œæˆ‘æƒ³è¿™æ›´æ˜¯ä¸€ç§ç£ä¿ƒæˆ‘å»åšè‡ªå·±æƒ³è¦åšçš„äº‹æƒ…çš„æ–¹å¼ï¼Œå› ä¸ºåšå®¢æ˜¯æ”¾åœ¨äº’è”ç½‘ä¸Šå¤§å®¶éƒ½å¯ä»¥çœ‹åˆ°ï¼Œæ‰€ä»¥æˆ‘å°±ä¼šåœ¨å†…å¿ƒæš—æš—åŠªåŠ›è¦å¥½å¥½å»ç ”ç©¶ï¼Œå†™ä¸€äº›çœŸæ­£å¹²è´§çš„æ–‡ç« ç»™å¤§å®¶çœ‹.</p>\n<p>å½“ä¸Šå‘¨æˆ‘å‘ç°åŸŸåå·²ç»è¿›å…¥ç­‰å¾…åˆ é™¤æœŸï¼Œå³åŸŸåç»ˆäºè¦è¢«æ³¨å†Œå±€åˆ é™¤ï¼Œæˆ‘å¯ä»¥é‡æ–°åˆ°åä¸ºäº‘æ³¨å†Œçš„æ—¶å€™ï¼Œæˆ‘æ¯ä¸€å¤©ï¼Œæ•´å¤©æ•´å¤©çš„å»çœ‹ <code>oacia.cc</code>  çš„ whois ä¿¡æ¯ï¼ŒæœŸå¾…ç€é‚£ä¸€å¤©æˆ‘é‡æ–°æ³¨å†Œåˆ° <code>oacia.cc</code>  è¿™ä¸ªåŸŸåï¼Œå°±åœ¨ä»Šå¤©ï¼Œ12 æœˆ 12 å·ï¼Œå½“åŸŸåç»ˆäºè¢«æ³¨å†Œå±€åˆ é™¤ä¹‹åï¼Œå½“æˆ‘æ»¡å¿ƒæ¬¢å–œçš„ç™»å½•åä¸ºäº‘å‡†å¤‡ä¹°å›åŸŸåçš„æ—¶å€™ï¼Œæˆ‘æ„•ç„¶å‘ç°ï¼Œè¿™ä¸ªåŸŸååœ¨åå‡ åˆ†é’Ÿå‰ï¼Œå°±åœ¨ä»Šå¤©ä¸‹åˆäº”ç‚¹å°±è¢«å…¶ä»–äººæŠ¢å…ˆæ³¨å†Œäº†</p>\n<p><img data-src=\"/blog-domain/image-20231213012749593.png\" alt=\"image-20231213012749593\" style=\"aspect-ratio:635 / 655;\"></p>\n<p>è¦è¯´ä¸éš¾å—è‚¯å®šæ˜¯å‡çš„ï¼Œå½“æ—¶æˆ‘æ„£åœ¨äº†ç”µè„‘å‰å¾ˆä¹…ï¼Œå¿ƒæƒ³ç€è¿™ä¸€å®šæ˜¯å‡çš„ï¼Œæˆ‘ä¹‹å‰æœç´¢è¿‡è¿™ä¸ªäºŒçº§åŸŸåï¼Œåªæœ‰ <code>com</code>  æ˜¯è¢«æ³¨å†Œçš„ï¼Œå…¶ä»–çš„é¡¶çº§åŸŸåéƒ½æ˜¯æ²¡æœ‰è¢«æ³¨å†Œè¿‡çš„ï¼Œç…§ç†æ¥è¯´ç›¸å½“çš„å†·é—¨æ‰å¯¹ï¼Œä¸è¿‡æœ‰ç‚¹é—æ†¾å‘¢ï¼Œ <code>oacia.cc</code>  è¿™ä¸ªé™ªä¼´äº†æˆ‘æ•´æ•´ä¸€å¹´çš„åŸŸåå°±ç¦»æˆ‘è€Œå»äº†ï¼Œå‘äº†ä¸€æ¡æ¨ç‰¹ä¹‹åæˆ‘ä¹Ÿåªèƒ½æš—è‡ªè‹¦ç¬‘ç€ï¼Œè°è®©æˆ‘æ…¢äººä¸€æ­¥å‘¢ï¼Œæˆ–è®¸æœ‰äººæ¯”æˆ‘æ›´éœ€è¦è¿™ä¸ªåŸŸåå‘¢ï½</p>\n<p>ä¸è¿‡æˆ‘çš„åšå®¢çš„åŸŸåè¿˜ç­‰ç€å®šä¸‹æ¥å‘¢ï¼Œæ•´ç†äº†ä¸€ä¸‹å¿ƒæƒ…ï¼Œæˆ‘å»å¤–é¢èµ°äº†èµ°ï¼Œå‡ºé—¨åƒäº†å®Œç‰›ä¸¼é¥­ï¼Œæƒ³ç€ç©¶ç«Ÿç”¨ä»€ä¹ˆæ–°åŸŸåå¥½å‘¢ï¼Œä½†æ˜¯åœ¨é˜¿é‡Œäº‘ä¸Šä¸‹ç¿»çœ‹ï¼Œæˆ‘è¿˜æ˜¯å¯¹æˆ‘é‚£é€å»çš„è€åŸŸåå¿µå¿µä¸å¿˜ã€‚æˆ‘çœ‹åˆ°äº† <code>oacia.life</code> , è¿™æˆ–è®¸æ„ä¸ºæ–°ç”Ÿ. <code>oacia.co</code> , å’Œæˆ‘ä¹‹å‰çš„åŸŸåé•¿çš„å¯çœŸåƒå‘¢ï¼Œä½†æ˜¯æˆ‘ä¸ç”±å¾—ä¼¤æ„Ÿäº†èµ·æ¥ï¼Œç®—äº†çœ‹åˆ° <code>co</code>  å®¹æ˜“è”æƒ³åˆ°å¤±å»çš„ <code>cc</code> , è¿˜æ˜¯æ¢ä¸€ä¸ªç½¢ã€‚éšåæˆ‘æƒ³ç€ä¸å¦‚ä¹°ä¸€ä¸ª com åŸŸåï¼Œè¿™ä¸ªé¡¶çº§åŸŸåå¬èµ·æ¥å°±ç›¸å½“çš„ä¸“ä¸šå‘ï¼Œä½†æ˜¯ <code>oacia.com</code>  è¿™ä¸ªåŸŸåå·²ç»è¢«æ³¨å†Œæ‰äº†ï¼Œæƒ³ç€åé¢åŠ å‡ ä¸ªæ•°å­—æ€ä¹ˆæ ·ï¼Ÿä¸è¿‡æˆ‘ä¸€çœ‹åˆ°è¿™ä¸ªåŸŸåï¼Œæ„Ÿè§‰è‹±æ–‡ + æ•°å­—ä¸å¤ªå¥½çœ‹ï¼Œæ‰€ä»¥ä¹Ÿå°± pass æ‰äº†</p>\n<p>ç„¶åæˆ‘å°±å»ç ”ç©¶äº†ä¸€ä¸‹åˆ«äººçš„åŸŸåç»´æœ¯å¤§ä½¬çš„åšå®¢ <code>weishu.me</code> , <code>oacia.me</code>  è¿™ä¸ªåŸŸåçœ‹èµ·æ¥ä¸é”™ï¼Œä½†æ˜¯æˆ‘åœ¨é˜¿é‡Œäº‘ï¼Œè…¾è®¯äº‘ï¼Œåä¸ºäº‘éƒ½æ‰¾ä¸åˆ°è¿™ä¸ªé¡¶çº§åŸŸåï¼Œæˆ‘çŒœåº”è¯¥æ˜¯å·²ç»ä¸‹æ¶äº†å§ï¼Œå› ä¸ºæˆ‘æŸ¥è¯¢äº†ä¸€ä¸‹ç»´æœ¯å¤§ä½¬çš„åšå®¢çš„ whois ä¿¡æ¯ï¼Œå‘ç°æ˜¯åœ¨é˜¿é‡Œäº‘æ³¨å†Œçš„.</p>\n<p>åæ¥æˆ‘çœ‹åˆ°äº† seeflower å¤§ä½¬çš„åšå®¢ <code>seeflower.dev</code> , è¿™ä¸ª dev å¬èµ·æ¥å¥½ä¸“ä¸šå‘ï¼Œè€Œä¸”æ„Ÿè§‰ä¹Ÿéå¸¸å¥‘åˆæˆ‘ä½œä¸º <code>developer</code>  çš„è‡ªæˆ‘å®šä½ï¼ŒåŒæ—¶æˆ‘è§‰å¾—è¿™ä¸ªåŸŸååº”è¯¥ä¹Ÿè°•ç¤ºç€æˆ‘çš„ blog çš„å†…å®¹å‘å±•çš„è¶Šæ¥è¶Šä¸°å¯Œï¼Œè’¸è’¸æ—¥ä¸Šï¼ç»„åˆäº†ä¸€ä¸‹åŸŸåï¼Œ <code>oacia.dev</code> , å¤©å‘è¿™ä¸ªåŸŸåä¸€å¬å°±è¶…çº§ coooooooool</p>\n<p>ä½†æ˜¯åœ¨é˜¿é‡Œäº‘ï¼Œè…¾è®¯äº‘ï¼Œåä¸ºäº‘éƒ½ä¸èƒ½è´­ä¹°è¿™ä¸ªåŸŸåï¼Œéšåæˆ‘å°†ç›®å…‰è½¬å‘äº†å…¨çƒçš„åŸŸåæ³¨å†Œå•†ï¼Œgodaddy ä¹Ÿä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› æ— æ³•è¿›å…¥</p>\n<p><img data-src=\"/blog-domain/image-20231213014614390.png\" alt=\"image-20231213014614390\" style=\"aspect-ratio:1035 / 599;\"></p>\n<p>è¿™è¯¥æ€ä¹ˆåŠå‘¢ï¼Œæˆ‘ç›®å‰ä¸ºæ­¢å”¯ä¸€çŸ¥é“çš„å…¨çƒåŸŸåæ³¨å†Œå•†å°±æ˜¯ godaddy äº†ï¼Œè¿™ä¸ªæ—¶å€™åˆè½®åˆ° whois æŸ¥è¯¢æ´¾ä¸Šç”¨åœºäº†ï¼Œæˆ‘å‘ç° <code>seeflower.dev</code>  æ˜¯åœ¨ <code>namesilo</code>  æ³¨å†Œçš„ï¼Œè€Œæ›´åŠ æ·±å…¥çš„äº†è§£ä¹‹åï¼Œæˆ‘å‘ç° <code>namesilo</code>  ç«Ÿç„¶å¯ä»¥ä½¿ç”¨æ”¯ä»˜å®å°±èƒ½æ”¯ä»˜ï¼Œå»æœç´¢äº†ä¸€ä¸‹ï¼Œ <code>oacia.dev</code>  è¿™ä¸ªåŸŸåè¿˜æ²¡æœ‰è¢«æ³¨å†Œå‘¢ï¼äºæ˜¯æˆ‘èŠ±äº† 12 åˆ€ï¼Œå®é™…ä»˜äº† 86 å—æŠŠåŸŸåä¹°å›æ¥äº†ï¼Œä»Šæ™šé…å¥½ CNAME ä¹‹åï¼Œç­‰ä¸€ä¸¤å¤©å dns åŸŸåè§£æåŒæ­¥å®Œæˆä¹‹åï¼Œæˆ‘çš„åšå®¢ç»ˆäºèƒ½å†æ¬¡è¢«è®¿é—®åˆ°äº†ï¼</p>\n<p>å›è¿‡å¤´æ¥ï¼Œå…œå…œè½¬è½¬ä¸¤ä¸ªæœˆï¼Œä¸ºäº†çœä¸‹æ¯å¹´ 30 å¤šå…ƒåŸŸåçš„è´¹ç”¨ï¼Œä¸ä»…åšå®¢åœæ‘†äº†ä¸¤ä¸ªæœˆä¹‹ä¹…ï¼Œæˆ‘æ„Ÿè§‰è‡ªå·±ä¹Ÿä¼¼ä¹é¢“åºŸäº†ä¸¤ä¸ªæœˆï¼ŒåŒæ—¶æˆ‘ä¹Ÿå¤±å»äº† <code>oacia.cc</code>  è¿™ä¸ªé™ªä¼´æˆ‘ä¸€å¹´çš„åŸŸåï¼Œå¹¶ä¸”èŠ±äº†æ¯”åœ¨é˜¿é‡Œäº‘ç»­è´¹ <code>oacia.cc</code>  åŸŸå (éœ€è¦æ¯å¹´ 75 å…ƒ) é«˜äº†åå¤šå…ƒçš„ä»·æ ¼ï¼Œåœ¨ <code>namesilo</code>  åˆé‡æ–°è´­ä¹°äº†æ–°çš„åŸŸå <code>oaica.dev</code>  (æ¯å¹´ 12 åˆ€ï¼Œçº¦åˆ 86 å…ƒ), ç°åœ¨æƒ³æ¥çœŸæ˜¯ä¸€æ®µçš„ç¥å¥‡çš„ç»å†ï¼Œåªæœ‰çœŸæ­£å¤±å»çš„æ—¶å€™ï¼Œæ‰ä¼šå‘ç°å®ƒæ›¾ç»å¯¹æˆ‘æ¥è¯´æœ‰å¤šä¹ˆçš„é‡è¦.</p>\n<p>äººç”Ÿä¸è¿‡æ˜¯ä¸€æ¬¡è·¯è¿‡ï¼Œä½•å¿…ä»€ä¹ˆéƒ½æŠ“ä½ä¸æ”¾ï¼Œç”¨å¿ƒäº«å—é€”ä¸­çš„é£æ™¯å°±å¥½.</p>\n<p>Bye, <strong>oacia.cc</strong></p>\n<p>Hello, <strong>oacia.dev</strong></p>\n",
            "tags": []
        },
        {
            "id": "https://oacia.dev/douyin-favorites-pic/",
            "url": "https://oacia.dev/douyin-favorites-pic/",
            "title": "æŠ–éŸ³æ”¶è—å¤¹å›¾æ–‡æ‰¹é‡è·å–",
            "date_published": "2023-11-09T13:24:38.000Z",
            "content_html": "<p>æœ€è¿‘æƒ³ç»™è‡ªå·±çš„åšå®¢å¤šå¢åŠ äº›å¥½çœ‹çš„å›¾ç‰‡å½“èƒŒæ™¯å›¾ï¼Œæ­£å¥½è¿™æ®µæ—¶é—´åˆ·æŠ–éŸ³çœ‹åˆ°äº†å¥½å¤šå¥½çœ‹çš„å›¾ç‰‡ï¼Œä¹ŸæŠŠä»–ä»¬ä¿å­˜åœ¨æ”¶è—å¤¹é‡Œé¢ï¼Œä½†æ˜¯æ­£å½“æˆ‘å…´è‡´å‹ƒå‹ƒçš„æƒ³æŠŠæˆ‘æ”¶è—å¤¹é‡Œé¢çš„å›¾ç‰‡ä¸‹è½½ä¸‹æ¥æ—¶ï¼Œå‘ç°å·¥ä½œé‡çœŸçš„çœŸçš„å¥½å¤§ï¼æ‰€ä»¥ç´¢æ€§å°±å†™ä¸ªå°è„šæœ¬æ¥è®©ç”Ÿæ´»æ›´åŠ è½»æ¾å’¯ï½</p>\n<p>é¦–å…ˆæˆ‘ä»¬æ‰“å¼€ç½‘é¡µç‰ˆæŠ–éŸ³ï¼Œæ¥åˆ°æ”¶è—å¤¹ï¼Œç„¶åç–¯ç‹‚å‘ä¸‹æ‹‰ç›´åˆ°æ”¶è—å¤¹çš„åº•éƒ¨</p>\n<p><img data-src=\"/douyin-favorites-pic/image-20231109212615660.png\" alt=\"image-20231109212615660\" style=\"aspect-ratio:1920 / 987;\"></p>\n<p>ç„¶ååœ¨ç½‘é¡µä¸Š <code>å³é”®-&gt;å¦å­˜ä¸º...</code>  æŠŠè¿™ä¸ª html ä¿å­˜ä¸º <code>mhtml</code>  æ ¼å¼</p>\n<p><img data-src=\"/douyin-favorites-pic/image-20231109212735019.png\" alt=\"image-20231109212735019\" style=\"aspect-ratio:622 / 417;\"></p>\n<p>æ¥ä¸‹æ¥å†™ä¸ªç®€å•çš„å°çˆ¬è™«ï¼ŒæŠ–éŸ³é‡Œé¢æ”¶è—çš„å›¾ç‰‡å°±ä¸‹è½½åˆ°ç”µè„‘ä¸Šå•¦ï½</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> re</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> requests</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> os</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">from</span> tqdm <span class=\"token keyword\">import</span> tqdm</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>header <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token string\">\"User-Agent\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Mobile Safari/537.36\"</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">douyin_pic</span><span class=\"token punctuation\">(</span>pid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\"># è·å– json æ•°æ®</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    p_id <span class=\"token operator\">=</span> <span class=\"token string\">\"https://m.douyin.com/web/api/v2/aweme/iteminfo/?reflow_source=reflow_page&amp;item_ids=&#123;&#125;&amp;a_bogus=\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>pid<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\"># print(p_id)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    p_rs <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>url<span class=\"token operator\">=</span>p_id<span class=\"token punctuation\">,</span> headers<span class=\"token operator\">=</span>header<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>json<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\"># print(p_rs)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\"># æ‹¿åˆ° images ä¸‹çš„åŸå›¾ç‰‡</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    images <span class=\"token operator\">=</span> p_rs<span class=\"token punctuation\">[</span><span class=\"token string\">'item_list'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'images'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\"># åˆ›å»º pic æ–‡ä»¶å¤¹</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>exists<span class=\"token punctuation\">(</span><span class=\"token string\">'douyin/pic'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        os<span class=\"token punctuation\">.</span>makedirs<span class=\"token punctuation\">(</span><span class=\"token string\">'douyin/pic'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\"># ä¸‹è½½æ— æ°´å°ç…§ç‰‡ (éå† images ä¸‹çš„æ•°æ®)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">for</span> index<span class=\"token punctuation\">,</span> im <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>images<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token comment\"># æ¯ä¸€æ¡æ•°æ®ä¸‹é¢éƒ½æœ‰å››ä¸ªåŸå›¾é“¾æ¥è¿™è¾¹ç”¨çš„æ˜¯ç¬¬ä¸€ä¸ª</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        p_req <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>url<span class=\"token operator\">=</span>im<span class=\"token punctuation\">[</span><span class=\"token string\">'url_list'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token comment\"># print(p_req)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token comment\"># ä¿å­˜å›¾ç‰‡</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token comment\"># æ‹¿åˆ°æ–‡ä»¶çš„é•¿åº¦ï¼Œå¹¶æŠŠ total åˆå§‹åŒ–ä¸º 0</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        total <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>p_req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'content-length'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token comment\"># æ‰“å¼€å½“å‰ç›®å½•çš„ fname æ–‡ä»¶ (åå­—ä½ æ¥ä¼ å…¥)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token comment\"># åˆå§‹åŒ– tqdmï¼Œä¼ å…¥æ€»æ•°ï¼Œæ–‡ä»¶åç­‰æ•°æ®ï¼Œæ¥ç€å°±æ˜¯å†™å…¥ï¼Œæ›´æ–°ç­‰æ“ä½œäº†</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'douyin/pic/</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>pid<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">_</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">.jpg'</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token builtin\">file</span><span class=\"token punctuation\">,</span> tqdm<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                total<span class=\"token operator\">=</span>total<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                unit<span class=\"token operator\">=</span><span class=\"token string\">'iB'</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                desc<span class=\"token operator\">=</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>pid<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> ç¬¬</span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>index<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\">å¼ å›¾ç‰‡\"</span></span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                unit_scale<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                unit_divisor<span class=\"token operator\">=</span><span class=\"token number\">1024</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> bar<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token keyword\">for</span> data <span class=\"token keyword\">in</span> p_req<span class=\"token punctuation\">.</span>iter_content<span class=\"token punctuation\">(</span>chunk_size<span class=\"token operator\">=</span><span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                size <span class=\"token operator\">=</span> <span class=\"token builtin\">file</span><span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                bar<span class=\"token punctuation\">.</span>update<span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        index <span class=\"token operator\">+=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'my.mhtml'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'r'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    data <span class=\"token operator\">=</span> f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">\"=\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>pic <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span>findall<span class=\"token punctuation\">(</span><span class=\"token string\">r'https://www.douyin.com/note/(\\d+)'</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token keyword\">for</span> p <span class=\"token keyword\">in</span> pic<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        douyin_pic<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token keyword\">except</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"pid </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>p<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> went wrong!!!\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure>",
            "tags": []
        },
        {
            "id": "https://oacia.dev/hina-AI-voice/",
            "url": "https://oacia.dev/hina-AI-voice/",
            "title": "I wanna hear your voice, hina",
            "date_published": "2023-11-06T09:31:57.000Z",
            "content_html": "<blockquote>\n<p>å¾ˆå–œæ¬¢æ—¥å¥ˆçš„å£°éŸ³ï¼Œæ‰€ä»¥ç”¨è‡ªå·±çš„ç”µè„‘è®­ç»ƒäº† hina çš„å£°éŸ³æ¨¡å‹ï¼Œå¹¶è®©å¥¹å”±äº†ä¸€é¦–æ­Œ</p>\n</blockquote>\n<div class=\"media-container\"><div class=\"player\" data-type=\"audio\" data-src=\"[{&quot;name&quot;:&quot;å•ç›¸æ€&quot;,&quot;url&quot;:&quot;/audio/hina_DanXiangSi.mp3&quot;}]\"></div></div>\n<h1 id=\"pythonè™šæ‹Ÿç¯å¢ƒæ­å»º\"><a class=\"anchor\" href=\"#pythonè™šæ‹Ÿç¯å¢ƒæ­å»º\">#</a> python è™šæ‹Ÿç¯å¢ƒæ­å»º</h1>\n<p>è¿™é‡Œæˆ‘ä½¿ç”¨çš„ Python ç‰ˆæœ¬ä¸º <code>Python3.9</code></p>\n<p><strong>å®‰è£… virtualenv</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pip <span class=\"token function\">install</span> virtualenv</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pip <span class=\"token function\">install</span> virtualenvwrapper  <span class=\"token comment\"># è¿™æ˜¯å¯¹ virtualenv çš„å°è£…ç‰ˆæœ¬ï¼Œä¸€å®šè¦åœ¨ virtualenv åå®‰è£…</span></pre></td></tr></table></figure><p><strong>åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</strong></p>\n<p>è¿™é‡Œæˆ‘åˆ›å»ºäº†åä¸º <code>hina</code>  çš„è™šæ‹Ÿç¯å¢ƒ</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS E:<span class=\"token punctuation\">\\</span>virtualenvs<span class=\"token operator\">></span> virtualenv hina</pre></td></tr></table></figure><p><strong>è¿›å…¥è™šæ‹Ÿç¯å¢ƒ</strong></p>\n<p>å‘½ä»¤è¡Œå‰é¢æœ‰ <code>(hina) </code> è¯´æ˜æˆ‘ä»¬å·²ç»è¿›å…¥äº†è¿™ä¸ªè™šæ‹Ÿç¯å¢ƒ</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS E:<span class=\"token punctuation\">\\</span>virtualenvs<span class=\"token operator\">></span> <span class=\"token builtin class-name\">cd</span> .<span class=\"token punctuation\">\\</span>hina<span class=\"token punctuation\">\\</span>Scripts<span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>PS E:<span class=\"token punctuation\">\\</span>virtualenvs<span class=\"token punctuation\">\\</span>hina<span class=\"token punctuation\">\\</span>Scripts<span class=\"token operator\">></span> .<span class=\"token punctuation\">\\</span>activate</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">(</span>hina<span class=\"token punctuation\">)</span> PS E:<span class=\"token punctuation\">\\</span>virtualenvs<span class=\"token punctuation\">\\</span>hina<span class=\"token punctuation\">\\</span>Scripts<span class=\"token operator\">></span></pre></td></tr></table></figure><h1 id=\"pytorchå®‰è£…\"><a class=\"anchor\" href=\"#pytorchå®‰è£…\">#</a> pytorch å®‰è£…</h1>\n<p>é¦–å…ˆè¿›å…¥<span class=\"exturl\" data-url=\"aHR0cHM6Ly9weXRvcmNoLm9yZy9nZXQtc3RhcnRlZC9sb2NhbGx5Lw==\"> pytorch å®˜ç½‘</span></p>\n<p><img data-src=\"/hina-AI-voice/image-20231106202001467.png\" alt=\"image-20231106202001467\" style=\"aspect-ratio:1009 / 375;\"></p>\n<p>ç„¶åè¾“å…¥ <code>nvidia-smi</code>  å‘½ä»¤æŸ¥çœ‹ N å¡ (å¿…é¡»æ˜¯ N å¡ï¼A å¡æ˜¯ä¸è¡Œçš„) æ”¯æŒçš„æœ€å¤§ CUDA ç‰ˆæœ¬ï¼Œæˆ‘è¿™é‡Œæ˜¯ <code>12.2</code></p>\n<p><img data-src=\"/hina-AI-voice/image-20231106202106566.png\" alt=\"image-20231106202106566\" style=\"aspect-ratio:1154 / 112;\"></p>\n<p>ç„¶åè¿è¡Œ <code>Run this Command</code>  ä¸­æ˜¾ç¤ºçš„å‘½ä»¤</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pip3 <span class=\"token function\">install</span> torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121</pre></td></tr></table></figure><h1 id=\"so-vits-svc-50ç¯å¢ƒæ­å»º\"><a class=\"anchor\" href=\"#so-vits-svc-50ç¯å¢ƒæ­å»º\">#</a> so vits svc 5.0 ç¯å¢ƒæ­å»º</h1>\n<p><strong>ä¸‹è½½æºç </strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> clone https://github.com/PlayVoice/so-vits-svc-5.0.git <span class=\"token parameter variable\">--depth</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><p><strong>å®‰è£…é¡¹ç›®ä¾èµ–</strong></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pip <span class=\"token function\">install</span> <span class=\"token parameter variable\">-r</span> .<span class=\"token punctuation\">\\</span>requirements.txt</pre></td></tr></table></figure><p><strong>ä¸‹è½½å…¶ä»–å¿…è¦æ–‡ä»¶</strong></p>\n<p>å› ä¸ºæœ‰æ–‡ä»¶éœ€è¦ä» <code>google drive</code>  ä¸‹è½½ï¼Œæ‰€ä»¥è®°å¾—æŒ‚å¥½ä»£ç†å“¦</p>\n<p>é¦–å…ˆä¸‹è½½ <code>gdown</code>  å’Œ <code>wget</code></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pip <span class=\"token function\">install</span> gdown, <span class=\"token function\">wget</span></pre></td></tr></table></figure><p>ç„¶ååœ¨é¡¹ç›®æ–‡ä»¶å¤¹å†…æ–°å»º <code>download.py</code></p>\n<p><img data-src=\"/hina-AI-voice/image-20231106195353674.png\" alt=\"image-20231106195353674\" style=\"aspect-ratio:797 / 382;\"></p>\n<p>å¹¶å°†ä¸‹é¢çš„ä»£ç  (æˆ‘å†™çš„ XD) å¤åˆ¶åˆ° <code>download.py</code>  ä¸­</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> gdown</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> wget</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> os</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>File_DICT <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\"># folder:https://drive.google.com/drive/folders/15oeBYf6Qn1edONkVLXe82MzdIi3O_9m3</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token comment\"># we only need best_model.pth.tar according to README.md</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token string\">\"Speaker-Encoder\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"best_model.pth.tar\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token string\">\"url\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1UPjQ2LVSIt3o-9QMKMJcdzT8aZRZCI-E\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token string\">\"output_path\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"speaker_pretrain/best_model.pth.tar\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token string\">\"gdrive\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token string\">\"whisper-large-v2\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"large-v2.pt\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token string\">\"url\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://openaipublic.azureedge.net/main/whisper/models/81f7c96c852ee8fc832187b0132e569d6c3065a3252ed18e56effd0b6a73e524/large-v2.pt\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token string\">\"output_path\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"whisper_pretrain/\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token string\">\"gdrive\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token string\">\"hubert_soft model\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"hubert-soft-0d54a1f4.pt\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token string\">\"url\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://github.com/bshall/hubert/releases/download/v0.1/hubert-soft-0d54a1f4.pt\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token string\">\"output_path\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"hubert_pretrain/\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token string\">\"gdrive\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token string\">\"crepe full\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"full.pth\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token string\">\"url\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://github.com/maxrmorrison/torchcrepe/raw/master/torchcrepe/assets/full.pth\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token string\">\"output_path\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"crepe/assets\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token string\">\"gdrive\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token string\">\"pretrain model\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"sovits5.0.pretrain.pth\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token string\">\"url\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://github.com/PlayVoice/so-vits-svc-5.0/releases/download/5.0/sovits5.0.pretrain.pth\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token string\">\"output_path\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"vits_pretrain/\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token string\">\"gdrive\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    REPO_PATH <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>dirname<span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>abspath<span class=\"token punctuation\">(</span>__file__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token keyword\">for</span> key<span class=\"token punctuation\">,</span> value <span class=\"token keyword\">in</span> File_DICT<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            path <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>REPO_PATH<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">[</span><span class=\"token string\">\"output_path\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Downloading &#123;&#125; to &#123;&#125;...\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token keyword\">if</span> value<span class=\"token punctuation\">[</span><span class=\"token string\">\"gdrive\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                gdown<span class=\"token punctuation\">.</span>download<span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token operator\">=</span>value<span class=\"token punctuation\">[</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> output<span class=\"token operator\">=</span>path<span class=\"token punctuation\">,</span> quiet<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Done!\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                wget<span class=\"token punctuation\">.</span>download<span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">[</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> out<span class=\"token operator\">=</span>path<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nDone!\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token keyword\">except</span> Exception <span class=\"token keyword\">as</span> e<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[!] Exception in download_binaries\\n&#123;&#125;\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    main<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>éšååœ¨è™šæ‹Ÿç¯å¢ƒä¸­è¿è¡Œ <code>download.py</code>  å°±å¯ä»¥å•¦</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">(</span>hina<span class=\"token punctuation\">)</span> PS E:<span class=\"token punctuation\">\\</span>AI<span class=\"token punctuation\">\\</span>so-vits-svc-5.<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>></span> python .<span class=\"token punctuation\">\\</span>download.py</pre></td></tr></table></figure><p>è¿è¡Œå¦‚ä¸‹å‘½ä»¤æµ‹è¯•ç¯å¢ƒæ˜¯å¦æ­å»ºæˆåŠŸ</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>python svc_inference.py <span class=\"token parameter variable\">--config</span> configs/base.yaml <span class=\"token parameter variable\">--model</span> ./vits_pretrain/sovits5.0.pretrain.pth <span class=\"token parameter variable\">--spk</span> ./configs/singers/singer0001.npy <span class=\"token parameter variable\">--wave</span> test.wav</pre></td></tr></table></figure><p>åœ¨å½“å‰ç›®å½•ä¸‹å‡ºç° <code>svc_out.wav</code>  å°±è¯´æ˜å¯ä»¥æ­£å¸¸ä½¿ç”¨å•¦</p>\n<p><img data-src=\"/hina-AI-voice/image-20231106203257692.png\" alt=\"image-20231106203257692\" style=\"aspect-ratio:819 / 566;\"></p>\n<h1 id=\"è·å–hinaçš„å£°éŸ³\"><a class=\"anchor\" href=\"#è·å–hinaçš„å£°éŸ³\">#</a> è·å– hina çš„å£°éŸ³</h1>\n<h2 id=\"ä»gamekeeä¸­è·å–\"><a class=\"anchor\" href=\"#ä»gamekeeä¸­è·å–\">#</a> ä» gamekee ä¸­è·å–</h2>\n<p>åœ¨<span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYS5nYW1la2VlLmNvbS84MzcyOS5odG1s\"> gamekee</span> ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è·å– hina çš„éŸ³é¢‘ï¼Œæˆ‘ä»¬åªéœ€è¦å†™ä¸€ä¸ªéå¸¸ easy çš„ python ä»£ç æ¥æŠŠ hina çš„å£°éŸ³ä¸‹è½½ä¸‹æ¥</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> requests</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">import</span> re</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> wget</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> os</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>HINA <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token string\">\"hina_water\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"https://ba.gamekee.com/83729.html\"</span><span class=\"token punctuation\">,</span><span class=\"token comment\">#æ—¥å¥ˆ - æ°´ç€</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token string\">\"hina\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"https://ba.gamekee.com/59934.html\"</span><span class=\"token comment\">#æ—¥å¥ˆ</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">for</span> key<span class=\"token punctuation\">,</span>value <span class=\"token keyword\">in</span> HINA<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>exists<span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        os<span class=\"token punctuation\">.</span>mkdir<span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    data <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    voices <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span>findall<span class=\"token punctuation\">(</span><span class=\"token string\">r'src=\"//(.*?\\.(?:mp3|wav))\"'</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">for</span> v <span class=\"token keyword\">in</span> voices<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        wget<span class=\"token punctuation\">.</span>download<span class=\"token punctuation\">(</span><span class=\"token string\">\"http://\"</span><span class=\"token operator\">+</span>v<span class=\"token punctuation\">,</span>key<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"download </span><span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span>v<span class=\"token punctuation\">&#125;</span></span><span class=\"token string\"> success\"</span></span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h2 id=\"ä»æ¸¸æˆèµ„æºä¸­è·å–\"><a class=\"anchor\" href=\"#ä»æ¸¸æˆèµ„æºä¸­è·å–\">#</a> ä»æ¸¸æˆèµ„æºä¸­è·å–</h2>\n<p>ç”±äº hina æ˜¯è”šè“æ¡£æ¡ˆä¸­çš„è§’è‰²ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°† hina çš„éŸ³é¢‘èµ„æºä»æ¸¸æˆæ–‡ä»¶ä¸­æå–å‡ºæ¥ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯åœ¨æ¨¡æ‹Ÿå™¨ä»è°·æ­Œå•†åº—ä¸­ä¸‹è½½è”šè“æ¡£æ¡ˆï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ¨¡æ‹Ÿå™¨æ˜¯é›·ç”µæ¨¡æ‹Ÿå™¨</p>\n<p>ç„¶ååœ¨ <code>è®¾ç½®-&gt;å…¶ä»–è®¾ç½®</code> ä¸­å¼€å¯ <code>ROOTæƒé™</code></p>\n<p><img data-src=\"/hina-AI-voice/image-20231106214153128.png\" alt=\"image-20231106214153128\" style=\"aspect-ratio:718 / 572;\"></p>\n<p>ç„¶åæˆ‘ä»¬åœ¨ä¾§è¾¹æ æ‰¾åˆ° <code>æ›´å¤š-&gt;å…±äº«æ–‡ä»¶-&gt;æ‰“å¼€å®‰å“æ–‡ä»¶å¤¹</code> ï¼Œæ‰¾åˆ°å®‰å“å…±äº«æ–‡ä»¶å¤¹æ–‡ä»¶åä¸º <code>/mnt/shared/Pictures</code></p>\n<p><img data-src=\"/hina-AI-voice/image-20231106214504493.png\" alt=\"image-20231106214504493\" style=\"aspect-ratio:551 / 122;\"></p>\n<p>éšåå®‰è£…<span class=\"exturl\" data-url=\"aHR0cDovL29hY2lhLmdpdGh1Yi5pby9oaW5hLUFJLXZvaWNlL01UJUU3JUFFJUExJUU3JTkwJTg2JUU1JTk5JUE4XzIuMTEuOC5hcGs=\"> MT ç®¡ç†å™¨</span>å¹¶æ‰“å¼€ï¼Œåœ¨å³ä¾§è¾¹æ è¿›å…¥ <code>mnt/shared/Pictures</code></p>\n<p><img data-src=\"/hina-AI-voice/image-20231106214608077.png\" alt=\"image-20231106214608077\" style=\"aspect-ratio:554 / 984;\"></p>\n<p>åœ¨å·¦ä¾§è¾¹æ è¿›å…¥ <code>/storage/emulated/0/Android/data</code> , æ‰¾åˆ°æ–‡ä»¶å¤¹åç§°ä¸º <code>com.nexon.bluearchive</code> , è¿™ä¸ªæ–‡ä»¶å¤¹æ˜¯è”šè“æ¡£æ¡ˆå…¨éƒ¨éŸ³é¢‘å›¾ç‰‡èµ„æºæ–‡ä»¶çš„æ‰€åœ¨ä½ç½®ï¼Œé•¿æŒ‰è¯¥æ–‡ä»¶å¤¹ï¼Œå¹¶é€‰æ‹© <code>å¤åˆ¶-&gt;</code></p>\n<p><img data-src=\"/hina-AI-voice/image-20231106214839294.png\" alt=\"image-20231106214839294\" style=\"aspect-ratio:554 / 984;\"></p>\n<p>ç­‰åˆ°å¤åˆ¶å®Œæˆä¹‹åï¼Œåœ¨ä¾§è¾¹æ ç‚¹å‡» <code>æ›´å¤š-&gt;å…±äº«æ–‡ä»¶-&gt;æ‰“å¼€ç”µè„‘æ–‡ä»¶å¤¹</code> å³å¯æ‰¾åˆ°ä¿å­˜åˆ°ç”µè„‘ä¸Šçš„è”šè“æ¡£æ¡ˆèµ„æºæ–‡ä»¶ï½</p>\n<p>éšåæˆ‘ä»¬è¿›å…¥åˆ° <code>com.nexon.bluearchive\\files\\PUB\\Resource\\GameData\\MediaResources\\Audio\\VOC_JP\\JP_Hina</code> , è¿™é‡Œå°±æ˜¯ hina çš„å…¨éƒ¨éŸ³é¢‘å•¦</p>\n<p><img data-src=\"/hina-AI-voice/image-20231106215532353.png\" alt=\"image-20231106215532353\" style=\"aspect-ratio:1507 / 813;\"></p>\n<p>ç”±äºè·å–åˆ°çš„æ˜¯ <code>ogg</code>  æ ¼å¼çš„æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ ¼å¼å·¥å‚æŠŠ <code>ogg</code>  æ–‡ä»¶å…¨éƒ¨è½¬æ¢æˆ <code>wav</code>  æ–‡ä»¶</p>\n<p>ç„¶ååœ¨æ–°å»ºä¸€ä¸ª <code>so-vits-svc-5.0\\dataset_raw\\JP_Hina</code>  æ–‡ä»¶å¤¹ï¼Œå¹¶å°†æˆ‘ä»¬è½¬æ¢å®Œæˆçš„ hina çš„éŸ³é¢‘å¤åˆ¶åˆ°è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­</p>\n<h1 id=\"æ•°æ®é¢„å¤„ç†\"><a class=\"anchor\" href=\"#æ•°æ®é¢„å¤„ç†\">#</a> æ•°æ®é¢„å¤„ç†</h1>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>python svc_preprocessing.py <span class=\"token parameter variable\">-t</span> <span class=\"token number\">2</span></pre></td></tr></table></figure><p>-tï¼šæŒ‡å®šçº¿ç¨‹æ•°ï¼Œå¿…é¡»æ˜¯æ­£æ•´æ•°ä¸”ä¸å¾—è¶…è¿‡ CPU æ€»æ ¸å¿ƒæ•°ï¼Œä¸€èˆ¬å†™ 2 å°±å¯ä»¥äº†</p>\n<p><strong>è¿›é˜¶å‘½ä»¤</strong></p>\n<ol>\n<li>é‡é‡‡æ ·</li>\n</ol>\n<p>ç”Ÿæˆé‡‡æ ·ç‡ 16000Hz éŸ³é¢‘ï¼Œå­˜å‚¨è·¯å¾„ä¸ºï¼š./data_svc/waves-16k</p>\n<blockquote>\n<p>python prepare/preprocess_a.py -w ./dataset_raw -o ./data_svc/waves-16k -s 16000</p>\n</blockquote>\n<p>ç”Ÿæˆé‡‡æ ·ç‡ 32000Hz éŸ³é¢‘ï¼Œå­˜å‚¨è·¯å¾„ä¸ºï¼š./data_svc/waves-32k</p>\n<blockquote>\n<p>python prepare/preprocess_a.py -w ./dataset_raw -o ./data_svc/waves-32k -s 32000</p>\n</blockquote>\n<ol start=\"2\">\n<li>ä½¿ç”¨ 16K éŸ³é¢‘ï¼Œæå–éŸ³é«˜</li>\n</ol>\n<blockquote>\n<p>python prepare/preprocess_crepe.py -w data_svc/waves-16k/ -p data_svc/pitch</p>\n</blockquote>\n<ol start=\"3\">\n<li>ä½¿ç”¨ 16k éŸ³é¢‘ï¼Œæå–å†…å®¹ç¼–ç </li>\n</ol>\n<blockquote>\n<p>python prepare/preprocess_ppg.py -w data_svc/waves-16k/ -p data_svc/whisper</p>\n</blockquote>\n<ol start=\"4\">\n<li>ä½¿ç”¨ 16k éŸ³é¢‘ï¼Œæå–å†…å®¹ç¼–ç </li>\n</ol>\n<blockquote>\n<p>python prepare/preprocess_hubert.py -w data_svc/waves-16k/ -v data_svc/hubert</p>\n</blockquote>\n<ol start=\"5\">\n<li>ä½¿ç”¨ 16k éŸ³é¢‘ï¼Œæå–éŸ³è‰²ç¼–ç </li>\n</ol>\n<blockquote>\n<p>python prepare/preprocess_speaker.py data_svc/waves-16k/ data_svc/speaker</p>\n</blockquote>\n<ol start=\"6\">\n<li>æå–éŸ³è‰²ç¼–ç å‡å€¼ï¼›ç”¨äºæ¨ç†ï¼Œä¹Ÿå¯ä½œä¸ºå‘éŸ³äººç»Ÿä¸€éŸ³è‰²ç”¨äºç”Ÿæˆè®­ç»ƒç´¢å¼•ï¼ˆæ•°æ®éŸ³è‰²å˜åŒ–ä¸å¤§çš„æƒ…å†µä¸‹ï¼‰</li>\n</ol>\n<blockquote>\n<p>python prepare/preprocess_speaker_ave.py data_svc/speaker/ data_svc/singer</p>\n</blockquote>\n<ol start=\"7\">\n<li>ä½¿ç”¨ 32k éŸ³é¢‘ï¼Œæå–çº¿æ€§è°±</li>\n</ol>\n<blockquote>\n<p>python prepare/preprocess_spec.py -w data_svc/waves-32k/ -s data_svc/specs</p>\n</blockquote>\n<ol start=\"8\">\n<li>ä½¿ç”¨ 32k éŸ³é¢‘ï¼Œç”Ÿæˆè®­ç»ƒç´¢å¼•</li>\n</ol>\n<blockquote>\n<p>python prepare/preprocess_train.py</p>\n</blockquote>\n<ol start=\"9\">\n<li>è®­ç»ƒæ–‡ä»¶è°ƒè¯•</li>\n</ol>\n<blockquote>\n<p>python prepare/preprocess_zzz.py</p>\n</blockquote>\n<h1 id=\"è®­ç»ƒ\"><a class=\"anchor\" href=\"#è®­ç»ƒ\">#</a> è®­ç»ƒ</h1>\n<ol>\n<li>\n<p>å‚æ•°è°ƒæ•´<br>\nå¦‚æœåŸºäºé¢„è®­ç»ƒæ¨¡å‹å¾®è°ƒï¼Œéœ€è¦ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1BsYXlWb2ljZS9zby12aXRzLXN2Yy01LjAvcmVsZWFzZXMvdGFnLzUuMA==\"> sovits5.0.pretrain.pth</span> å¹¶ä¸”æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹é¢<br>\nå¹¶ä¸”ä¿®æ”¹ <code>configs/base.yaml</code>  çš„å‚æ•° <code>pretrain: &quot;./vits_pretrain/sovits5.0.pretrain.pth&quot;</code> ï¼Œå¹¶é€‚å½“è°ƒå°å­¦ä¹ ç‡ï¼ˆå»ºè®®ä» 5e-5 å¼€å§‹å°è¯•ï¼‰<br>\n<strong>learning_rate &amp; batch_size &amp; accum_step ä¸ºä¸‰ä¸ªç´§å¯†ç›¸å…³çš„å‚æ•°ï¼Œéœ€è¦ä»”ç»†è°ƒèŠ‚</strong><br>\n<strong> batch_size ä¹˜ä»¥ accum_step é€šå¸¸ç­‰äº 16 æˆ– 32ï¼Œå¯¹äºä½æ˜¾å­˜ GPUï¼Œå¯ä»¥å°è¯• batch_size = 4ï¼Œaccum_step = 4</strong></p>\n</li>\n<li>\n<p>å¼€å§‹è®­ç»ƒ</p>\n<pre><code>python svc_trainer.py -c configs/base.yaml -n sovits5.0\n</code></pre>\n</li>\n<li>\n<p>æ¢å¤è®­ç»ƒ</p>\n<pre><code>python svc_trainer.py -c configs/base.yaml -n sovits5.0 -p chkpt/sovits5.0/sovits5.0_0***.pt\n</code></pre>\n</li>\n<li>\n<p>è®­ç»ƒæ—¥å¿—å¯è§†åŒ–</p>\n<pre><code>tensorboard --logdir logs/\n</code></pre>\n</li>\n</ol>\n<h1 id=\"äººå£°ä¼´å¥åˆ†ç¦»\"><a class=\"anchor\" href=\"#äººå£°ä¼´å¥åˆ†ç¦»\">#</a> äººå£°ä¼´å¥åˆ†ç¦»</h1>\n<p>æƒ³è®© hina å”±å‡ºå•ç›¸æ€ï¼Œé‚£ä¹ˆæœ‰ä¼´å¥æ˜¯è‚¯å®šä¸è¡Œæ»´ï¼Œæˆ‘ä»¬éœ€è¦å°†äººå£°å’Œä¼´å¥åˆ†ç¦»</p>\n<h2 id=\"uvr5\"><a class=\"anchor\" href=\"#uvr5\">#</a> UVR5</h2>\n<p>è¿™é‡Œéœ€è¦ä½¿ç”¨åˆ°çš„å·¥å…·æ˜¯<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL0Fuam9rMDcvdWx0aW1hdGV2b2NhbHJlbW92ZXJndWk=\"> Ultimate Vocal Remover 5 (UVR5)</span>, å¹¶ä¸‹è½½å¯¹åº”çš„å¤„ç†æ¨¡å‹ã€‚</p>\n<p>å¯ä»¥å‰å¾€<span class=\"exturl\" data-url=\"aHR0cHM6Ly9tdnNlcC5jb20vcXVhbGl0eV9jaGVja2VyL3N5bnRoX2xlYWRlcmJvYXJk\">è¿™ä¸ªç½‘ç«™</span>æŸ¥çœ‹æ¨¡å‹çš„å¾—åˆ†</p>\n<p>ä¸€äº›æ¨èçš„å¤„ç†æ¨¡å‹å’ŒåŠŸèƒ½å¦‚ä¸‹ï¼š</p>\n<ul>\n<li><code>Demucs | MDX23C</code> : åˆ†ç¦»äººå£°åŠä¼´å¥</li>\n<li><code>VR Architecture - 5_HP-Karaoke-UVR</code> : åˆ†ç¦»å’Œå£°</li>\n<li><code>VR Architecture - UVR-DeEcho-DeReverb</code> : å»é™¤æ··å“å’Œå›å£°</li>\n</ul>\n<p>å¯ä»¥å…ˆä½¿ç”¨ <code>Demucs | MDX23C</code>  æ¥åˆ†ç¦»äººå£°åŠä¼´å¥ï¼Œå¦‚æœå¬åˆ°äººå£°æœ‰å’Œå£°çš„è¯ï¼Œå¯ä»¥ç”¨ <code>VR Architecture - 5_HP-Karaoke-UVR</code>  æ¥äºŒæ¬¡å¤„ç†</p>\n<p>å½“ç„¶ï¼Œä¸ºäº†æ–¹ä¾¿ä¹Ÿå¯ä»¥ç›´æ¥å» b ç«™æ‰¾åˆ°åˆ«äººåˆ†ç¦»å¥½çš„äººå£°ç”¨å•¦ï½</p>\n<h1 id=\"æ¨ç†\"><a class=\"anchor\" href=\"#æ¨ç†\">#</a> æ¨ç†</h1>\n<ol>\n<li>\n<p>å¯¼å‡ºæ¨ç†æ¨¡å‹ï¼šæ–‡æœ¬ç¼–ç å™¨ï¼ŒFlow ç½‘ç»œï¼ŒDecoder ç½‘ç»œï¼›åˆ¤åˆ«å™¨å’ŒåéªŒç¼–ç å™¨ç­‰åªåœ¨è®­ç»ƒä¸­ä½¿ç”¨</p>\n<pre><code>python svc_export.py --config configs/base.yaml --checkpoint_path chkpt/sovits5.0/sovits5.0_0***.pt\n</code></pre>\n</li>\n<li>\n<p>æ¨ç†</p>\n</li>\n</ol>\n<ul>\n<li>\n<p>å¦‚æœä¸æƒ³æ‰‹åŠ¨è°ƒæ•´ f0ï¼Œåªéœ€è¦æœ€ç»ˆçš„æ¨ç†ç»“æœï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤å³å¯</p>\n<pre><code>python svc_inference.py --config configs/base.yaml --model sovits5.0.pth --spk ./data_svc/singer/ä¿®æ”¹æˆå¯¹åº”çš„åç§°.npy --wave test.wav --shift 0\n</code></pre>\n</li>\n<li>\n<p>å¦‚æœéœ€è¦æ‰‹åŠ¨è°ƒæ•´ f0ï¼Œä¾æ®ä¸‹é¢çš„æµç¨‹æ“ä½œ</p>\n<ul>\n<li>\n<p>ä½¿ç”¨ whisper æå–å†…å®¹ç¼–ç ï¼Œç”Ÿæˆ test.ppg.npy</p>\n<pre><code>python whisper/inference.py -w test.wav -p test.ppg.npy\n</code></pre>\n</li>\n<li>\n<p>ä½¿ç”¨ hubert æå–å†…å®¹ç¼–ç ï¼Œç”Ÿæˆ test.vec.npy</p>\n<pre><code>python hubert/inference.py -w test.wav -v test.vec.npy\n</code></pre>\n</li>\n<li>\n<p>æå– csv æ–‡æœ¬æ ¼å¼ F0 å‚æ•°ï¼Œç”¨ Excel æ‰“å¼€ csv æ–‡ä»¶ï¼Œå¯¹ç…§ Audition æˆ–è€… SonicVisualiser æ‰‹åŠ¨ä¿®æ”¹é”™è¯¯çš„ F0</p>\n<pre><code>python pitch/inference.py -w test.wav -p test.csv\n</code></pre>\n</li>\n<li>\n<p>æœ€ç»ˆæ¨ç†</p>\n<pre><code>python svc_inference.py --config configs/base.yaml --model sovits5.0.pth --spk ./data_svc/singer/ä¿®æ”¹æˆå¯¹åº”çš„åç§°.npy --wave test.wav --ppg test.ppg.npy --vec test.vec.npy --pit test.csv --shift 0\n</code></pre>\n</li>\n</ul>\n</li>\n</ul>\n<ol start=\"3\">\n<li>\n<p>ä¸€äº›æ³¨æ„ç‚¹<br>\nå½“æŒ‡å®šâ€“ppg åï¼Œå¤šæ¬¡æ¨ç†åŒä¸€ä¸ªéŸ³é¢‘æ—¶ï¼Œå¯ä»¥é¿å…é‡å¤æå–éŸ³é¢‘å†…å®¹ç¼–ç ï¼›æ²¡æœ‰æŒ‡å®šï¼Œä¹Ÿä¼šè‡ªåŠ¨æå–</p>\n<p>å½“æŒ‡å®šâ€“vec åï¼Œå¤šæ¬¡æ¨ç†åŒä¸€ä¸ªéŸ³é¢‘æ—¶ï¼Œå¯ä»¥é¿å…é‡å¤æå–éŸ³é¢‘å†…å®¹ç¼–ç ï¼›æ²¡æœ‰æŒ‡å®šï¼Œä¹Ÿä¼šè‡ªåŠ¨æå–</p>\n<p>å½“æŒ‡å®šâ€“pit åï¼Œå¯ä»¥åŠ è½½æ‰‹å·¥è°ƒæ•™çš„ F0 å‚æ•°ï¼›æ²¡æœ‰æŒ‡å®šï¼Œä¹Ÿä¼šè‡ªåŠ¨æå–</p>\n<p>ç”Ÿæˆæ–‡ä»¶åœ¨å½“å‰ç›®å½• svc_out.wav</p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">args</th>\n<th style=\"text-align:center\">â€“config</th>\n<th style=\"text-align:center\">â€“model</th>\n<th style=\"text-align:center\">â€“spk</th>\n<th style=\"text-align:center\">â€“wave</th>\n<th style=\"text-align:center\">â€“ppg</th>\n<th style=\"text-align:center\">â€“vec</th>\n<th style=\"text-align:center\">â€“pit</th>\n<th style=\"text-align:center\">â€“shift</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">name</td>\n<td style=\"text-align:center\">é…ç½®æ–‡ä»¶</td>\n<td style=\"text-align:center\">æ¨¡å‹æ–‡ä»¶</td>\n<td style=\"text-align:center\">éŸ³è‰²æ–‡ä»¶</td>\n<td style=\"text-align:center\">éŸ³é¢‘æ–‡ä»¶</td>\n<td style=\"text-align:center\">ppg å†…å®¹</td>\n<td style=\"text-align:center\">hubert å†…å®¹</td>\n<td style=\"text-align:center\">éŸ³é«˜å†…å®¹</td>\n<td style=\"text-align:center\">å‡é™è°ƒ</td>\n</tr>\n</tbody>\n</table>\n</li>\n<li>\n<p>å»å™ªåå¤„ç†</p>\n</li>\n</ol>\n<pre><code>python svc_inference_post.py --ref test.wav --svc svc_out.wav --out svc_out_post.wav\n</code></pre>\n",
            "tags": []
        },
        {
            "id": "https://oacia.dev/flutter-ACTF-native-app/",
            "url": "https://oacia.dev/flutter-ACTF-native-app/",
            "title": "flutteré€†å‘ ACTF native app",
            "date_published": "2023-10-31T10:04:59.000Z",
            "content_html": "<h1 id=\"å‰è¨€\"><a class=\"anchor\" href=\"#å‰è¨€\">#</a> å‰è¨€</h1>\n<p>ç®—äº†ä¸€ä¸‹å¥½é•¿æ—¶é—´æ²¡æ‰“è¿‡ CTF äº†ï¼Œå‰ä¸¤å¤©çœ‹åˆ° ACTF é€†å‘æœ‰é“ flutter é€†å‘é¢˜å°±è¿‡æ¥ç©ç©å•¦ï¼ŒèŠ±äº†ä¸€ä¸ªä¸‹åˆåšå®Œäº†ã€‚è¯´æ¥ä¹Ÿå·§ï¼Œæˆ‘ç»™ DASCTF åæœˆèµ›å‡ºçš„é€†å‘é¢˜å…¶ä¸­ä¸€é“ä¹Ÿæ˜¯ flutter, ä¸è¿‡é‚£é¢˜æˆ‘éš¾åº¦é™çš„ç›¸å½“ä¹‹ä½å•¦ï¼Œä¸çŸ¥é“æœ‰å¤šå°‘äººåšå‡ºæ¥äº†å‘¢ï½</p>\n<h1 id=\"è¿˜åŸå‡½æ•°å\"><a class=\"anchor\" href=\"#è¿˜åŸå‡½æ•°å\">#</a> è¿˜åŸå‡½æ•°å</h1>\n<p>flutter é€†å‘çš„ä¸€å¤§éš¾ç‚¹å°±æ˜¯ä¸çŸ¥é“ <code>libapp.so</code>  çš„å‡½æ•°åï¼Œè™½ç„¶æœ‰å·¥å…· <code>reflutter</code>  å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¾—åˆ°å…¶ä¸­çš„ç¬¦å·ï¼Œä½†æ˜¯æˆ‘ä¸ªäººè®¤ä¸ºåŸºäºå¯¹ <code>libflutter.so</code>  æºç æ’æ¡©åé‡ç¼–è¯‘å†é‡æ‰“åŒ… apk çš„æ–¹å¼å…·æœ‰æå¤§çš„ä¸å¯é¢„æ–™æ€§ï¼Œææœ‰å¯èƒ½å¯¼è‡´ apk é—ªé€€ï¼Œè¿™ä¸€é¢˜ä¾¿å‡ºç°äº†è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘å°†ä»‹ç»çš„å·¥å…· <code>blutter</code>  æ˜¯çº¯é™æ€åˆ†ææ¥è¿˜åŸå‡½æ•°åï¼Œæ›´ä»¤äººæƒŠå–œçš„æ˜¯å®ƒæä¾›äº† <code>IDApython</code>  è„šæœ¬æ¥è®©æˆ‘ä»¬å¯ä»¥åœ¨ IDA ä¸­å¯¹å‡½æ•°è¿›è¡Œé‡å‘½åï¼Œè€Œè¿™ä¸ªé¡¹ç›®ä¸­æä¾›çš„å…¶ä»–æ–‡ä»¶ä¹Ÿç›¸å½“å¥½ç”¨</p>\n<h2 id=\"blutterçš„ç¼–è¯‘åŠä½¿ç”¨\"><a class=\"anchor\" href=\"#blutterçš„ç¼–è¯‘åŠä½¿ç”¨\">#</a> blutter çš„ç¼–è¯‘åŠä½¿ç”¨</h2>\n<p>blutter é¡¹ç›®åœ°å€</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>https<span class=\"token operator\">:</span><span class=\"token comment\">//github.com/worawit/blutter</span></pre></td></tr></table></figure><p>åœ¨å„ä¸ªå¹³å°å¦‚ä½•ç¼–è¯‘åœ¨è¿™ä¸ªé¡¹ç›®çš„ README.md ä¸­å†™çš„å·²ç»ç›¸å½“è¯¦ç»†äº†ï¼Œè¿™é‡Œæˆ‘å°±ç®€å•ä»‹ç»ä¸€ä¸‹ Windows ä¸Šçš„ç¼–è¯‘è¿‡ç¨‹å§ï¼Œæ³¨æ„ä¸€ä¸‹è¿™äº›å‘½ä»¤éœ€è¦å…¨ç¨‹è¿è¡Œåœ¨ä»£ç†ç¯å¢ƒå¦åˆ™ä¼šå¯¼è‡´æ— æ³•ä¸‹è½½</p>\n<p>é¦–å…ˆ clone é¡¹ç›®</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">git</span> clone https://github.com/worawit/blutter <span class=\"token parameter variable\">--depth</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><p>éšåè¿è¡Œåˆå§‹åŒ–è„šæœ¬</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> .<span class=\"token punctuation\">\\</span>blutter<span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>python .<span class=\"token punctuation\">\\</span>scripts<span class=\"token punctuation\">\\</span>init_env_win.py</pre></td></tr></table></figure><p>è¯·æ³¨æ„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ‰“å¼€ <code>x64 Native Tools Command Prompt</code> , å®ƒå¯ä»¥åœ¨ <code>Visual Studio</code>  æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031182720564.png\" alt=\"image-20231031182720564\" style=\"aspect-ratio:349 / 588;\"></p>\n<p>ç„¶åè¿è¡Œ <code>blutter.py</code>  å¹¶æä¾› <code>libapp.so</code>  å’Œ <code>libflutter.so</code>  çš„æ–‡ä»¶å¤¹è·¯å¾„ä»¥åŠè¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>python .<span class=\"token punctuation\">\\</span>blutter.py <span class=\"token punctuation\">..</span><span class=\"token punctuation\">\\</span>chall<span class=\"token punctuation\">\\</span>lib<span class=\"token punctuation\">\\</span>arm64-v8a<span class=\"token punctuation\">\\</span> .<span class=\"token punctuation\">\\</span>output</pre></td></tr></table></figure><p><img data-src=\"/flutter-ACTF-native-app/image-20231031183050383.png\" alt=\"image-20231031183050383\" style=\"aspect-ratio:1223 / 639;\"></p>\n<p>è¾“å‡ºæ–‡ä»¶å¤¹ç›®å½•å¦‚ä¸‹</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031183135453.png\" alt=\"image-20231031183135453\" style=\"aspect-ratio:264 / 482;\"></p>\n<p>éšåæˆ‘ä»¬ç”¨ ida åç¼–è¯‘ <code>libapp.so</code> , å¹¶è¿è¡Œè¾“å‡ºæ–‡ä»¶å¤¹ä¸­çš„ IDApython è„šæœ¬ <code>ida_script/addNames.py</code> , ç¬¦å·å°±è¢«å…¨éƒ¨æ¢å¤å‡ºæ¥å•¦</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031183441477.png\" alt=\"image-20231031183441477\" style=\"aspect-ratio:899 / 857;\"></p>\n<h1 id=\"hookå…³é”®å‡½æ•°-è·å–å‡½æ•°å‚æ•°\"><a class=\"anchor\" href=\"#hookå…³é”®å‡½æ•°-è·å–å‡½æ•°å‚æ•°\">#</a> hook å…³é”®å‡½æ•° è·å–å‡½æ•°å‚æ•°</h1>\n<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦å…³æ³¨çš„å‡½æ•°æ˜¯ <code>flutter_application_1_main__LongPressDemoState::_onTap</code> , å› ä¸ºåœ¨ flutter çš„å¼€å‘ä¸­ï¼ŒonTap å‡½æ•°æ˜¯æŒ‰é’®ç‚¹å‡»ä¹‹åçš„å“åº”å‡½æ•°</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031183702090.png\" alt=\"image-20231031183702090\" style=\"aspect-ratio:864 / 431;\"></p>\n<p>éšåæˆ‘ä»¬è¿›å…¥ <code>sub_1DE500</code> , åœ¨è¯¥å‡½æ•°ä¸­åŒå‡» <code>sub_1DE59C</code>  è¿›å…¥</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031183814522.png\" alt=\"image-20231031183814522\" style=\"aspect-ratio:1264 / 860;\"></p>\n<p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬å‘ç°äº† <code>256</code> , <code>%</code> , <code>^</code>  è¿™äº›ç‰¹å¾ï¼Œåˆç†çŒœæµ‹ä¸€ä¸‹ç®—æ³•å¯èƒ½æ˜¯ RC4<img data-src=\"/flutter-ACTF-native-app/image-20231031185252569.png\" alt=\"image-20231031185252569\" style=\"aspect-ratio:786 / 294;\"></p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031185414233.png\" alt=\"image-20231031185414233\" style=\"aspect-ratio:592 / 244;\"></p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031185438467.png\" alt=\"image-20231031185438467\" style=\"aspect-ratio:568 / 141;\"></p>\n<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨è¾“å‡ºæ–‡ä»¶å¤¹ä¸­çš„ <code>blutter_frida.js</code> hook ä¸€ä¸‹ <code>sub_1DE59C</code>  çœ‹çœ‹æƒ…å†µ</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031185604019.png\" alt=\"image-20231031185604019\" style=\"aspect-ratio:1920 / 1078;\"></p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS D:<span class=\"token punctuation\">\\</span>hgame<span class=\"token punctuation\">\\</span>ACTF<span class=\"token punctuation\">\\</span>native app<span class=\"token punctuation\">\\</span>work<span class=\"token punctuation\">\\</span>blutter<span class=\"token operator\">></span> frida <span class=\"token parameter variable\">-U</span> <span class=\"token parameter variable\">-f</span> <span class=\"token string\">\"com.example.flutter_application_1\"</span> <span class=\"token parameter variable\">-l</span> .<span class=\"token punctuation\">\\</span>output<span class=\"token punctuation\">\\</span>blutter_frida.js</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>Pixel <span class=\"token number\">3</span>::com.example.flutter_application_1 <span class=\"token punctuation\">]</span>-<span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Unhandle class id: <span class=\"token number\">46</span>, TypeArguments</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>GrowableList@6d00488c29 <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token number\">188676</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token string\">\"key\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"Unhandle class id: 46, TypeArguments\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token number\">34</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token string\">\"key\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token number\">184</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token number\">132</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token number\">137</span>,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token number\">215</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token number\">146</span>,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token number\">65</span>,</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token number\">86</span>,</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      <span class=\"token number\">157</span>,</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token number\">123</span>,</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token number\">100</span>,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token number\">179</span>,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token number\">131</span>,</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      <span class=\"token number\">112</span>,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token number\">170</span>,</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token number\">97</span>,</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token number\">210</span>,</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token number\">163</span>,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      <span class=\"token number\">179</span>,</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token number\">17</span>,</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token number\">171</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token number\">245</span>,</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token number\">30</span>,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token number\">194</span>,</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      <span class=\"token number\">144</span>,</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token number\">37</span>,</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token number\">41</span>,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token number\">235</span>,</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token number\">121</span>,</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token number\">146</span>,</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token number\">210</span>,</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      <span class=\"token number\">174</span>,</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      <span class=\"token number\">92</span>,</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token number\">204</span>,</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token number\">22</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span>,</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬åª hook åˆ°ä¸€ä¸ªæ•°ç»„çš„å€¼ï¼Œå¦ä¸€ä¸ªæ•°ç»„çš„ç±»å‹æ˜¯ <code>TypeArguments</code> , ç ”ç©¶äº†ä¸€ä¸‹ <code>blutter_frida.js</code>  åå‘ç°ä½œè€…è¿˜æ²¡æœ‰å¯¹è¿™ç§æ•°æ®ç±»å‹æ ¼å¼æä¾› hook æ”¯æŒ</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031185952753.png\" alt=\"image-20231031185952753\" style=\"aspect-ratio:1401 / 667;\"></p>\n<h1 id=\"idaåŠ¨æ€è°ƒè¯•libappso\"><a class=\"anchor\" href=\"#idaåŠ¨æ€è°ƒè¯•libappso\">#</a> IDA åŠ¨æ€è°ƒè¯• libapp.so</h1>\n<p>ç°åœ¨æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæ•°ç»„ï¼Œæˆ‘ä»¬å°±æš‚æ—¶è®¤ä¸ºå®ƒå°±æ˜¯ flag ç»è¿‡åŠ å¯†ä¹‹åå¾—åˆ°çš„ç»“æœï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åœ¨ IDA ä¸­å¯¹ <code>sub_1DE59C</code>  ä¸‹æ–­ç‚¹åŠ¨æ€è°ƒè¯•æ¥æ›´åŠ æ·±å…¥çš„ç ”ç©¶ä¸€ä¸‹</p>\n<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å°† IDA æ–‡ä»¶å¤¹ä¸­çš„ <code>dbgsrv/android_server64</code>  push åˆ°æ‰‹æœºä¸Šé¢ï¼Œç„¶åè¿è¡Œä¸€ä¸‹å¹¶ä¸”æŒ‡å®šç«¯å£</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>blueline:/data/local/tmp <span class=\"token comment\"># ./as64 -p 11112</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>IDA Android <span class=\"token number\">64</span>-bit remote debug server<span class=\"token punctuation\">(</span>ST<span class=\"token punctuation\">)</span> v7.7.27. Hex-Rays <span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token number\">2004</span>-2022</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Listening on <span class=\"token number\">0.0</span>.0.0:11112<span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>éšåç«¯å£è½¬å‘ä¸€ä¸‹</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>PS C:<span class=\"token punctuation\">\\</span>Users<span class=\"token punctuation\">\\</span>oacia<span class=\"token operator\">></span> adb forward tcp:11112 tcp:11112</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">11112</span></pre></td></tr></table></figure><p>åœ¨ IDA ä¸­é€‰æ‹©è°ƒè¯•å™¨ä¸º <code>Android debugger</code></p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031190502580.png\" alt=\"image-20231031190502580\" style=\"aspect-ratio:436 / 371;\"></p>\n<p>éšåç‚¹å‡» <code>Debugger-&gt;Debugger options...</code>  é€‰æ‹©å¦‚ä¸‹é…ç½®</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031190621711.png\" alt=\"image-20231031190621711\" style=\"aspect-ratio:594 / 578;\"></p>\n<p>ç‚¹å‡» <code>Debugger-&gt;Process options...</code> , <code>Hostname</code>  ä¿®æ”¹ä¸º <code>127.0.0.1</code> , <code>Port</code>  ä¿®æ”¹ä¸º <code>11112</code></p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031190653343.png\" alt=\"image-20231031190653343\" style=\"aspect-ratio:699 / 363;\"></p>\n<p>ç„¶åç‚¹å‡» <code>Debugger-&gt;Attach to process...</code> , é™„åŠ åˆ°æˆ‘ä»¬ç›®æ ‡åŒ…åçš„è¿›ç¨‹ä¸Šé¢</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031190932527.png\" alt=\"image-20231031190932527\" style=\"aspect-ratio:600 / 639;\"></p>\n<p>å¼¹å‡ºè¯¥å¼¹çª—é€‰æ‹© Same å³å¯</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031191001330.png\" alt=\"image-20231031191001330\" style=\"aspect-ratio:1045 / 302;\"></p>\n<p>åœ¨æ‰‹æœºä¸Šç‚¹å‡»æŒ‰é’®ï¼Œç„¶ååœ¨ IDA ä¸­ç‚¹å‡»è¿™ä¸ªç»¿è‰²çš„å‰ªå¤´ï¼Œå°±å¯ä»¥åŠ¨æ€è°ƒè¯•å•¦</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031191049306.png\" alt=\"image-20231031191049306\" style=\"aspect-ratio:561 / 136;\"></p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031191123141.png\" alt=\"image-20231031191123141\" style=\"aspect-ratio:1920 / 1080;\"></p>\n<p>åœ¨åŠ¨æ€è°ƒè¯•ä¹‹åï¼ŒæœªçŸ¥çš„å˜é‡ä¹Ÿé€æ¸æµ®ç°äº†å‡ºæ¥ï¼Œè¿™é‡Œæˆ‘ä»¬å‘ç°äº† <code>v28&gt;=256</code> , é‚£ä¹ˆå¾ˆæœ‰å¯èƒ½å°±æ˜¯ RC4 äº†å“¦</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031191544680.png\" alt=\"image-20231031191544680\" style=\"aspect-ratio:956 / 565;\"></p>\n<p>æ—¢ç„¶è¿™æ ·ï¼Œé‚£ä¹ˆç›´æ¥åœ¨è¿™é‡Œå”¯ä¸€çš„å¼‚æˆ–çš„åœ°æ–¹ç”¨ IDA å» trace ä¸€ä¸‹ï¼ŒæŠŠå¼‚æˆ–çš„æ•°ç»„ dump ä¸‹æ¥ä¸å°±è¡Œäº†ï¼š)</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031192301154.png\" alt=\"image-20231031192301154\" style=\"aspect-ratio:1920 / 1080;\"></p>\n<p>äºæ˜¯æˆ‘ä»¬å¾—åˆ°äº†è¢«å¼‚æˆ–çš„æ•°ç»„äº†</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031193001825.png\" alt=\"image-20231031193001825\" style=\"aspect-ratio:1548 / 176;\"></p>\n<p>ä½†æ˜¯åœ¨å¼‚æˆ–è¿ç®—çš„åœ°æ–¹ä¸‹æ–­ç‚¹ä¹‹åï¼Œæˆ‘è¾“å…¥çš„æ•°å…¨éƒ½æ˜¯ <code>1</code> , è¿™é‡Œè¢«å¼‚æˆ–çš„æ•°ä¹Ÿå…¨æ˜¯ <code>0xce</code></p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031194118997.png\" alt=\"image-20231031194118997\" style=\"aspect-ratio:955 / 293;\"></p>\n<p>æ‰€ä»¥è«éä¸æ˜¯ RC4? è®© 0xce å’Œ <code>0x31</code>  å¼‚æˆ–ä¸€ä¸‹çœ‹çœ‹ï¼Œç«Ÿç„¶æ˜¯ <code>0xff</code>  è¿™ä¹ˆæœ‰æ„ä¹‰çš„æ•°å­—</p>\n<p><img data-src=\"/flutter-ACTF-native-app/image-20231031194218233.png\" alt=\"image-20231031194218233\" style=\"aspect-ratio:250 / 70;\"></p>\n<p>æ‰€ä»¥ exp ä¹Ÿå°±èƒ½å†™å‡ºæ¥å•¦ï½</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>final <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">184</span><span class=\"token punctuation\">,</span> <span class=\"token number\">132</span><span class=\"token punctuation\">,</span> <span class=\"token number\">137</span><span class=\"token punctuation\">,</span> <span class=\"token number\">215</span><span class=\"token punctuation\">,</span> <span class=\"token number\">146</span><span class=\"token punctuation\">,</span> <span class=\"token number\">65</span><span class=\"token punctuation\">,</span> <span class=\"token number\">86</span><span class=\"token punctuation\">,</span> <span class=\"token number\">157</span><span class=\"token punctuation\">,</span> <span class=\"token number\">123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span> <span class=\"token number\">179</span><span class=\"token punctuation\">,</span> <span class=\"token number\">131</span><span class=\"token punctuation\">,</span> <span class=\"token number\">112</span><span class=\"token punctuation\">,</span> <span class=\"token number\">170</span><span class=\"token punctuation\">,</span> <span class=\"token number\">97</span><span class=\"token punctuation\">,</span> <span class=\"token number\">210</span><span class=\"token punctuation\">,</span> <span class=\"token number\">163</span><span class=\"token punctuation\">,</span> <span class=\"token number\">179</span><span class=\"token punctuation\">,</span> <span class=\"token number\">17</span><span class=\"token punctuation\">,</span> <span class=\"token number\">171</span><span class=\"token punctuation\">,</span> <span class=\"token number\">245</span><span class=\"token punctuation\">,</span> <span class=\"token number\">30</span><span class=\"token punctuation\">,</span> <span class=\"token number\">194</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>         <span class=\"token number\">144</span><span class=\"token punctuation\">,</span> <span class=\"token number\">37</span><span class=\"token punctuation\">,</span> <span class=\"token number\">41</span><span class=\"token punctuation\">,</span> <span class=\"token number\">235</span><span class=\"token punctuation\">,</span> <span class=\"token number\">121</span><span class=\"token punctuation\">,</span> <span class=\"token number\">146</span><span class=\"token punctuation\">,</span> <span class=\"token number\">210</span><span class=\"token punctuation\">,</span> <span class=\"token number\">174</span><span class=\"token punctuation\">,</span> <span class=\"token number\">92</span><span class=\"token punctuation\">,</span> <span class=\"token number\">204</span><span class=\"token punctuation\">,</span> <span class=\"token number\">22</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>xor <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">14</span><span class=\"token punctuation\">,</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span> <span class=\"token number\">68</span><span class=\"token punctuation\">,</span> <span class=\"token number\">80</span><span class=\"token punctuation\">,</span> <span class=\"token number\">29</span><span class=\"token punctuation\">,</span> <span class=\"token number\">201</span><span class=\"token punctuation\">,</span> <span class=\"token number\">241</span><span class=\"token punctuation\">,</span> <span class=\"token number\">46</span><span class=\"token punctuation\">,</span> <span class=\"token number\">197</span><span class=\"token punctuation\">,</span> <span class=\"token number\">208</span><span class=\"token punctuation\">,</span> <span class=\"token number\">123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">79</span><span class=\"token punctuation\">,</span> <span class=\"token number\">187</span><span class=\"token punctuation\">,</span> <span class=\"token number\">55</span><span class=\"token punctuation\">,</span> <span class=\"token number\">234</span><span class=\"token punctuation\">,</span> <span class=\"token number\">104</span><span class=\"token punctuation\">,</span> <span class=\"token number\">40</span><span class=\"token punctuation\">,</span> <span class=\"token number\">117</span><span class=\"token punctuation\">,</span> <span class=\"token number\">133</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> <span class=\"token number\">67</span><span class=\"token punctuation\">,</span> <span class=\"token number\">137</span><span class=\"token punctuation\">,</span> <span class=\"token number\">91</span><span class=\"token punctuation\">,</span> <span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">136</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>       <span class=\"token number\">177</span><span class=\"token punctuation\">,</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span> <span class=\"token number\">234</span><span class=\"token punctuation\">,</span> <span class=\"token number\">24</span><span class=\"token punctuation\">,</span> <span class=\"token number\">27</span><span class=\"token punctuation\">,</span> <span class=\"token number\">26</span><span class=\"token punctuation\">,</span> <span class=\"token number\">214</span><span class=\"token punctuation\">,</span> <span class=\"token number\">122</span><span class=\"token punctuation\">,</span> <span class=\"token number\">217</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>flag <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">chr</span><span class=\"token punctuation\">(</span>xor<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">^</span>final<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">^</span><span class=\"token number\">0xff</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>final<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># Iu2xpwXLAK734btEt9kXIhfpRgTlu6KuI0</span></pre></td></tr></table></figure>",
            "tags": []
        },
        {
            "id": "https://oacia.dev/unidbg-usage/",
            "url": "https://oacia.dev/unidbg-usage/",
            "title": "unidbg usage",
            "date_published": "2023-10-26T09:26:55.000Z",
            "content_html": "<h1 id=\"ä¸‹è½½åœ°å€\"><a class=\"anchor\" href=\"#ä¸‹è½½åœ°å€\">#</a> ä¸‹è½½åœ°å€</h1>\n<pre><code class=\"language-https\">https://github.com/zhkl0228/unidbg\n</code></pre>\n<p>æºç ä¸‹è½½å®Œæˆåä½¿ç”¨ IDEA æ‰“å¼€å³å¯ä½¿ç”¨</p>\n<h1 id=\"å¿«é€Ÿä½¿ç”¨\"><a class=\"anchor\" href=\"#å¿«é€Ÿä½¿ç”¨\">#</a> å¿«é€Ÿä½¿ç”¨</h1>\n<p>å¥—ç”¨ä»¥ä¸‹æ¨¡æ¿ï¼Œå°†åŒ…åç­‰å‚æ•°æ›¿æ¢æˆå¯¹åº”çš„å­—ç¬¦ä¸²å³å¯å¿«é€Ÿä½¿ç”¨ unidbg</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>oacia</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>github<span class=\"token punctuation\">.</span>unidbg<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">AndroidEmulator</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>github<span class=\"token punctuation\">.</span>unidbg<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Module</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>github<span class=\"token punctuation\">.</span>unidbg<span class=\"token punctuation\">.</span>arm<span class=\"token punctuation\">.</span>backend<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Unicorn2Factory</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>github<span class=\"token punctuation\">.</span>unidbg<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span>android<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">AndroidEmulatorBuilder</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>github<span class=\"token punctuation\">.</span>unidbg<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span>android<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">AndroidResolver</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>github<span class=\"token punctuation\">.</span>unidbg<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span>android<span class=\"token punctuation\">.</span>dvm<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">DalvikModule</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>github<span class=\"token punctuation\">.</span>unidbg<span class=\"token punctuation\">.</span>linux<span class=\"token punctuation\">.</span>android<span class=\"token punctuation\">.</span>dvm<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">VM</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>github<span class=\"token punctuation\">.</span>unidbg<span class=\"token punctuation\">.</span>memory<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">Memory</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">import</span> <span class=\"token import\"><span class=\"token namespace\">java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">File</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Myunidbg</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AndroidEmulator</span> emulator<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">VM</span> vm<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">DalvikModule</span> dm<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Module</span> <span class=\"token keyword\">module</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Myunidbg</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token comment\">// åˆ›å»ºæ¨¡æ‹Ÿå™¨</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        emulator <span class=\"token operator\">=</span> <span class=\"token class-name\">AndroidEmulatorBuilder</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">for64Bit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            \t<span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                hypervisor å¼•æ“å¯ä»¥åœ¨æ­è½½äº† Apple Silicon èŠ¯ç‰‡çš„è®¾å¤‡ä¸Šæ¨¡æ‹Ÿæ‰§è¡Œ</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                KVM å¼•æ“å¯ä»¥åœ¨æ ‘è“æ´¾ä¸Šæ¨¡æ‹Ÿæ‰§è¡Œ</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                Dynarmic å¼•æ“æ˜¯ä¸ºäº†æ›´å¿«çš„æ¨¡æ‹Ÿæ‰§è¡Œ</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                Unicorn æ˜¯æœ€å¼ºå¤§æœ€å®Œå–„çš„æ¨¡æ‹Ÿæ‰§è¡Œå¼•æ“ï¼Œä½†å®ƒçš„ç¼ºç‚¹æ˜¯æ…¢</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                */</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">addBackendFactory</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Unicorn2Factory</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">setProcessName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"com.oacia.test\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token comment\">// è·å–æ“ä½œå†…å­˜çš„æ¥å£</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token class-name\">Memory</span> memory <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getMemory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token comment\">// è®¾ç½® andorid ç³»ç»Ÿåº“ç‰ˆæœ¬</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        memory<span class=\"token punctuation\">.</span><span class=\"token function\">setLibraryResolver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">AndroidResolver</span><span class=\"token punctuation\">(</span><span class=\"token number\">26</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token comment\">// åˆ›å»ºè™šæ‹Ÿæœº</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        vm <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">createDalvikVM</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token comment\">// å¼€å¯ log</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        vm<span class=\"token punctuation\">.</span><span class=\"token function\">setVerbose</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token comment\">// åŠ è½½ç›®æ ‡åº“</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        dm <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"E:\\\\oacia\\\\libtprt.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">module</span> <span class=\"token operator\">=</span> dm<span class=\"token punctuation\">.</span><span class=\"token function\">getModule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        <span class=\"token comment\">// æ‰§è¡Œ JNIOnLoadï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        dm<span class=\"token punctuation\">.</span><span class=\"token function\">callJNI_OnLoad</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å¦‚æœè¿è¡Œæ—¶æç¤ºç¼ºå°‘æŸäº›åº“ï¼Œå¯ä»¥åœ¨<strong>åŠ è½½ç›®æ ‡åº“å‰</strong>æ·»åŠ å¦‚ä¸‹ä»£ç é¢„åŠ è½½ç¼ºå°‘çš„ç³»ç»Ÿåº“ï¼Œç³»ç»Ÿåº“çš„ä½ç½®ä½äº <code>/system/lib64/</code> , å°†è¿™äº›ç³»ç»Ÿåº“ä»æ‰‹æœºå¤åˆ¶åˆ°ç”µè„‘ä¸Šå³å¯</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>vm<span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"f:\\\\androidlib\\\\libc.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>vm<span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"f:\\\\androidlib\\\\libm.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>vm<span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"f:\\\\androidlib\\\\libstdc++.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>vm<span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"f:\\\\androidlib\\\\ld-android.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>vm<span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"f:\\\\androidlib\\\\libdl.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>å¦‚æœåœ¨ JNI å±‚ä¸­è°ƒç”¨äº† java å±‚ä¸­çš„å‡½æ•°ï¼ŒåŒæ ·ä¼šå¼•èµ· unidbg å¼•æ“æŠ¥é”™ï¼Œæ­¤æ—¶éœ€è¦è‡ªè¡Œè¡¥å……ç¼ºå¤±çš„ java å±‚çš„æ–¹æ³•ï¼Œå¹¶é‡å†™è°ƒç”¨ Java å±‚å‡½æ•°æ—¶ç”¨åˆ°çš„ JNI æ–¹æ³•ï¼Œç¼ºå°‘å˜é‡çš„æƒ…å†µåŒç†</p>\n<p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨è¿™ä¸ª JNI å‡½æ•°ä¸­è°ƒç”¨äº† java å±‚ä¸­ <code>base64</code>  è¿™ä¸ªæ–¹æ³•</p>\n<p><img data-src=\"/unidbg-usage/2052730-20210613211815383-1064330698.png\" alt=\"img\" style=\"aspect-ratio:1827 / 1300;\"></p>\n<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ unidbg çš„ Java æ–‡ä»¶ä¸­è¡¥å……ä¸Šå¯¹åº”çš„æ–¹æ³•</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MainActivitymethod1</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractJni</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">DvmClass</span> <span class=\"token class-name\">MainActivityClass</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    * base64 æ˜¯ java å±‚çš„æ–¹æ³•ï¼Œè¿™é‡Œé‡å†™ callObjectMethodV æ–¹æ³•ï¼šä¸€æ—¦å‘ç°è°ƒç”¨çš„æ˜¯ java å±‚çš„ base64 æ–¹æ³•ï¼Œè¿™é‡Œå°±ç”¨è‡ªå·±å¤ç°çš„ base64 æ–¹æ³•æ›¿æ¢</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    * */</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">DvmObject</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">callObjectMethodV</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BaseVM</span> vm<span class=\"token punctuation\">,</span> <span class=\"token class-name\">DvmObject</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> dvmObject<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> signature<span class=\"token punctuation\">,</span> <span class=\"token class-name\">VaList</span> vaList<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"callObjectMethodV->\"</span><span class=\"token operator\">+</span>signature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>signature<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"com/example/testjni/MainActivity->base64(Ljava/lang/String;)Ljava/lang/String;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token class-name\">DvmObject</span> dvmobj<span class=\"token operator\">=</span>vaList<span class=\"token punctuation\">.</span><span class=\"token function\">getObjectArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token class-name\">String</span> arg<span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> dvmobj<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token class-name\">String</span> result<span class=\"token operator\">=</span><span class=\"token function\">base64</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringObject</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">callObjectMethodV</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span> dvmObject<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">,</span> vaList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    * staticcontent æ˜¯ java å±‚çš„é™æ€å˜é‡ï¼›getStaticObjectFieldï¼Œä¸€æ—¦æ£€æµ‹åˆ° so å±‚å¼•ç”¨è¿™ä¸ªå˜é‡ï¼Œé‚£ä¹ˆè‡ªå·±è¿”å›è¿™ä¸ªå˜é‡çš„å€¼</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    * */</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">DvmObject</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getStaticObjectField</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BaseVM</span> vm<span class=\"token punctuation\">,</span> <span class=\"token class-name\">DvmClass</span> dvmClass<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> signature<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getStaticObjectField->\"</span><span class=\"token operator\">+</span>signature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>signature<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"com/example/testjni/MainActivity->staticcontent:Ljava/lang/String;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringObject</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span><span class=\"token string\">\"staticcontent\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// æºç  public static string staticcontent = \"staticcontent\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">getStaticObjectField</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span> dvmClass<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    * objcontent æ˜¯ java å±‚çš„å˜é‡ï¼›è¿™é‡Œé‡å†™ getObjectField æ–¹æ³•ï¼Œä¸€æ—¦æ£€æµ‹åˆ° so å±‚å¼•ç”¨è¿™ä¸ªå˜é‡ï¼Œé‚£ä¹ˆè‡ªå·±è¿”å›è¿™ä¸ªå˜é‡çš„å€¼</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    * */</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">DvmObject</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getObjectField</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BaseVM</span> vm<span class=\"token punctuation\">,</span> <span class=\"token class-name\">DvmObject</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> dvmObject<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> signature<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"getObjectField->\"</span><span class=\"token operator\">+</span>signature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>signature<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"com/example/testjni/MainActivity->objcontent:Ljava/lang/String;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StringObject</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span><span class=\"token string\">\"objcontent\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//public string objcontent</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">getObjectField</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span> dvmObject<span class=\"token punctuation\">,</span> signature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    * java å±‚çš„æ–¹æ³•ï¼Œè¿™é‡Œéœ€è¦å¤ç°ï¼Œå¦åˆ™ä¸çŸ¥é“æ€ä¹ˆæ‰§è¡Œ</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    * */</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">base64</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> arg3<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token class-name\">String</span> result<span class=\"token operator\">=</span><span class=\"token class-name\">Base64</span><span class=\"token punctuation\">.</span><span class=\"token function\">encodeBase64String</span><span class=\"token punctuation\">(</span>arg3<span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"androidemulatoræ“ä½œ\"><a class=\"anchor\" href=\"#androidemulatoræ“ä½œ\">#</a> AndroidEmulator æ“ä½œ</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">AndroidEmulator_use</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// è·å–å†…å­˜æ“ä½œæ¥å£</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">Memory</span> memory <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getMemory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// è·å–è¿›ç¨‹ pid</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">int</span> pid <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getPid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// åˆ›å»ºè™šæ‹Ÿæœº</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token class-name\">VM</span> dalvikVM <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">createDalvikVM</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// åˆ›å»ºè™šæ‹Ÿæœºå¹¶æŒ‡å®š APK æ–‡ä»¶</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token class-name\">VM</span> dalvikVM <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">createDalvikVM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"E:/oacia/my.apk\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// è·å–å·²åˆ›å»ºçš„è™šæ‹Ÿæœº</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token class-name\">VM</span> dalvikVM <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getDalvikVM</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// æ˜¾ç¤ºå½“å‰å¯„å­˜å™¨çŠ¶æ€ å¯æŒ‡å®šå¯„å­˜å™¨</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    emulator<span class=\"token punctuation\">.</span><span class=\"token function\">showRegs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// è·å–åç«¯ CPU</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token class-name\">Backend</span> backend <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getBackend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token comment\">// è·å–è¿›ç¨‹å</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token class-name\">String</span> processName <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getProcessName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">// è·å–å¯„å­˜å™¨</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token class-name\">RegisterContext</span> context <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">//Trace è¯»å†…å­˜</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    emulator<span class=\"token punctuation\">.</span><span class=\"token function\">traceRead</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">//Trace å†™å†…æ¶¦</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    emulator<span class=\"token punctuation\">.</span><span class=\"token function\">traceWrite</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token comment\">//Trace æ±‡ç¼–</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    emulator<span class=\"token punctuation\">.</span><span class=\"token function\">traceCode</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">// æ˜¯å¦æ­£åœ¨è¿è¡Œ</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">boolean</span> running <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">isRunning</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"memoryæ“ä½œ\"><a class=\"anchor\" href=\"#memoryæ“ä½œ\">#</a> Memory æ“ä½œ</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">Memory_use</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">Memory</span> memory <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getMemory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">// æŒ‡å®š Android SDK ç‰ˆæœ¬</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    memory<span class=\"token punctuation\">.</span><span class=\"token function\">setLibraryResolver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">AndroidResolver</span><span class=\"token punctuation\">(</span><span class=\"token number\">23</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// æ‹¿åˆ°ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å†…å­˜åœ°å€ï¼Œé€šè¿‡è¯¥æŒ‡é’ˆå¯æ“ä½œå†…å­˜</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token class-name\">UnidbgPointer</span> pointer <span class=\"token operator\">=</span> memory<span class=\"token punctuation\">.</span><span class=\"token function\">pointer</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x4000000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// è·å–å½“å‰å†…å­˜æ˜ å°„æƒ…å†µ</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token class-name\">Collection</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MemoryMap</span><span class=\"token punctuation\">></span></span> memoryMap <span class=\"token operator\">=</span> memory<span class=\"token punctuation\">.</span><span class=\"token function\">getMemoryMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// æ ¹æ®æ¨¡å—åæ¥æ‹¿åˆ°æŸä¸ªæ¨¡å—</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token class-name\">Module</span> <span class=\"token keyword\">module</span> <span class=\"token operator\">=</span> memory<span class=\"token punctuation\">.</span><span class=\"token function\">findModule</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"module name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">// æ ¹æ®åœ°å€æ‹¿åˆ°æŸä¸ªæ¨¡å—</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token class-name\">Module</span> <span class=\"token keyword\">module</span> <span class=\"token operator\">=</span> memory<span class=\"token punctuation\">.</span><span class=\"token function\">findModuleByAddress</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x40000000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"vmæ“ä½œ\"><a class=\"anchor\" href=\"#vmæ“ä½œ\">#</a> VM æ“ä½œ</h1>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">VM_use</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// æ¨èæŒ‡å®š APK æ–‡ä»¶ï¼ŒUnidbg ä¼šè‡ªåŠ¨åšè®¸å¤šå›ºå®šçš„æ“ä½œ</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">VM</span> vm <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">createDalvikVM</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"E:\\\\oacia\\\\my.apk\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// æ˜¯å¦è¾“å‡º JNI è¿è¡Œæ—¥å¿—</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    vm<span class=\"token punctuation\">.</span><span class=\"token function\">setVerbose</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// åŠ è½½ SO æ¨¡å— å‚æ•°äºŒè®¾ç½®æ˜¯å¦è‡ªåŠ¨è°ƒç”¨ init å‡½æ•°</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token class-name\">DalvikModule</span> dalvikModule <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"E:\\\\oacia\\\\libc.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">// è®¾ç½® JNI äº¤äº’æ¥å£ å‚æ•°éœ€å®ç° Jni æ¥å£ï¼Œæ¨èä½¿ç”¨ this ç»§æ‰¿ AbstractJni</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    vm<span class=\"token punctuation\">.</span><span class=\"token function\">setJni</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// è·å– JNIEnv æŒ‡é’ˆï¼Œå¯ä½œä¸ºå‚æ•°ä¼ é€’</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token class-name\">Pointer</span> jniEnv <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token function\">getJNIEnv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// è·å– JavaVM æŒ‡é’ˆï¼Œå¯ä½œä¸ºå‚æ•°ä¼ é€’</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token class-name\">Pointer</span> javaVM <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token function\">getJavaVM</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">// è°ƒç”¨ JNI_OnLoad å‡½æ•°</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    vm<span class=\"token punctuation\">.</span><span class=\"token function\">callJNI_OnLoad</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">,</span>dalvikModule<span class=\"token punctuation\">.</span><span class=\"token function\">getModule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token comment\">// å‘ VM æ·»åŠ å…¨å±€å¯¹è±¡ï¼Œè¿”å›è¯¥å¯¹è±¡çš„ hash å€¼</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">int</span> hash <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token function\">addGlobalObject</span><span class=\"token punctuation\">(</span>dvmObj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">// è·å–è™šæ‹Ÿæœºä¸­çš„å¯¹è±¡ï¼Œå‚æ•°ä¸ºè¯¥å¯¹è±¡çš„ hash å€¼</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token class-name\">DvmObject</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> object <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token function\">getObject</span><span class=\"token punctuation\">(</span>hash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"æ–¹æ³•è°ƒç”¨\"><a class=\"anchor\" href=\"#æ–¹æ³•è°ƒç”¨\">#</a> æ–¹æ³•è°ƒç”¨</h1>\n<h2 id=\"è°ƒç”¨å¯¼å‡ºå‡½æ•°\"><a class=\"anchor\" href=\"#è°ƒç”¨å¯¼å‡ºå‡½æ•°\">#</a> è°ƒç”¨å¯¼å‡ºå‡½æ•°</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è°ƒç”¨å¯¼å‡ºå‡½æ•°</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">call_export_function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">Module</span> oacia_module <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">File</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"E:/oacia/liboacia.so\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getModule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">Number</span> result <span class=\"token operator\">=</span>  oacia_module<span class=\"token punctuation\">.</span><span class=\"token function\">callFunction</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">,</span><span class=\"token string\">\"_Z3addii\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"_Z3addii result:\"</span><span class=\"token operator\">+</span>result<span class=\"token punctuation\">.</span><span class=\"token function\">intValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"è°ƒç”¨jniå‡½æ•°\"><a class=\"anchor\" href=\"#è°ƒç”¨jniå‡½æ•°\">#</a> è°ƒç”¨ JNI å‡½æ•°</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è°ƒç”¨ JNI å‡½æ•°</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">call_JNI_function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">// è°ƒç”¨ jni å‡½æ•°ï¼Œå¯¹äºåŠ¨æ€æ³¨å†Œçš„ jni å‡½æ•°å¿…é¡»åœ¨å®Œæˆåœ°å€çš„ç»‘å®šæ‰èƒ½è°ƒç”¨</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">DvmClass</span> <span class=\"token class-name\">MainActivity_dvmclass</span> <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token function\">resolveClass</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"com/example/unicorncourse08/MainActivity\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// å…ˆæŠŠç±»æ‰¾åˆ°ï¼Œè¿™é‡Œçš„åŸç†å¾ˆåƒåå°„</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">DvmObject</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> resultobj <span class=\"token operator\">=</span> <span class=\"token class-name\">MainActivity_dvmclass</span><span class=\"token punctuation\">.</span><span class=\"token function\">callStaticJniMethodObject</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">,</span><span class=\"token string\">\"stringFromJNI1(Ljava/lang/String;)Ljava/lang/String;\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"helloworld\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// å†é€šè¿‡ç±»å»è°ƒç”¨é‡Œé¢çš„å‡½æ•°</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"resultobj:\"</span><span class=\"token operator\">+</span>resultobj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"è°ƒç”¨ä»»æ„å‡½æ•°\"><a class=\"anchor\" href=\"#è°ƒç”¨ä»»æ„å‡½æ•°\">#</a> è°ƒç”¨ä»»æ„å‡½æ•°</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è°ƒç”¨ä»»æ„å‡½æ•°</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">call_any_function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">// è·å– JNIEnv *</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token class-name\">Pointer</span> jniEnv <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token function\">getJNIEnv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// åˆ›å»º jobject å¯¹è±¡</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token class-name\">DvmObject</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> thiz <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token function\">resolveClass</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"com.oacia.test\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">newObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// å‡†å¤‡å…¥å‚</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> args <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    args<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>jniEnv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    args<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token function\">addLocalObject</span><span class=\"token punctuation\">(</span>thiz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    args<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span><span class=\"token function\">addLocalObject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">StringObject</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">,</span><span class=\"token string\">\"XuE\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">// æ ¹æ®åœ°å€è°ƒç”¨</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token class-name\">Number</span> numbers <span class=\"token operator\">=</span> <span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span><span class=\"token function\">callFunction</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">,</span> <span class=\"token number\">0x9180</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">.</span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>numbers<span class=\"token punctuation\">.</span><span class=\"token function\">intValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"è°ƒç”¨å½¢å‚æ˜¯æŒ‡é’ˆç±»å‹çš„å‡½æ•°\"><a class=\"anchor\" href=\"#è°ƒç”¨å½¢å‚æ˜¯æŒ‡é’ˆç±»å‹çš„å‡½æ•°\">#</a> è°ƒç”¨å½¢å‚æ˜¯æŒ‡é’ˆç±»å‹çš„å‡½æ•°</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è°ƒç”¨å½¢å‚æ˜¯æŒ‡é’ˆç±»å‹çš„å‡½æ•°</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">// å‡è®¾æˆ‘ä»¬éœ€è¦è°ƒç”¨çš„å‡½æ•°ä¸º void md5 (const uint8_t *initial_msg, size_t initial_len, uint8_t *digest);</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// å…¶ä¸­ initial_msg å’Œ digest éƒ½æ˜¯æŒ‡é’ˆç±»å‹</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">call_argv_point_type_function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token class-name\">String</span> initial <span class=\"token operator\">=</span> <span class=\"token string\">\"unidbg\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">int</span> initial_length <span class=\"token operator\">=</span> initial<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// å¼€è¾Ÿä¸€å—çš„ç©ºé—´æ¥å­˜æ”¾ç¬¬ä¸€ä¸ªå‚æ•°</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token class-name\">MemoryBlock</span> initial_msg <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getMemory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span>initial_length<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token class-name\">UnidbgPointer</span> initial_msg_ptr <span class=\"token operator\">=</span> initial_msg<span class=\"token punctuation\">.</span><span class=\"token function\">getPointer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\">// å°†å‚æ•° 1 å†™å…¥</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    initial_msg_ptr<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>initial<span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token comment\">// å¼€è¾Ÿä¸€å— 16 å­—èŠ‚çš„ç©ºé—´æ¥å­˜æ”¾ç¬¬ 2 ä¸ªå‚æ•°</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token class-name\">MemoryBlock</span> digest <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getMemory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token class-name\">UnidbgPointer</span> digest_ptr<span class=\"token operator\">=</span>digest<span class=\"token punctuation\">.</span><span class=\"token function\">getPointer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">// å‡†å¤‡å…¥å‚</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> args <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    args<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>initial_msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    args<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>initial_length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    args<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>digest_ptr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token comment\">// æ‰§è¡Œ</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span><span class=\"token function\">callFunction</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">,</span> <span class=\"token number\">0x7A8D</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">.</span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">// æ‰“å°ç»“æœ</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token class-name\">Inspector</span><span class=\"token punctuation\">.</span><span class=\"token function\">inspect</span><span class=\"token punctuation\">(</span>digest_ptr<span class=\"token punctuation\">.</span><span class=\"token function\">getByteArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"digest\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"unidbg-hook\"><a class=\"anchor\" href=\"#unidbg-hook\">#</a> unidbg hook</h1>\n<p>Unidbg åœ¨ Android ä¸Šæ”¯æŒçš„ Hookï¼Œå¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»</p>\n<ul>\n<li>Unidbg å†…ç½®çš„ç¬¬ä¸‰æ–¹ Hook æ¡†æ¶ï¼ŒåŒ…æ‹¬ xHook/Whale/HookZz</li>\n<li>Unicorn Hook ä»¥åŠ Unidbg åŸºäºå®ƒå°è£…çš„ Console Debugger</li>\n</ul>\n<p>é€‰ç”¨å“ªç§ hook æ¡†æ¶ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹ä¸¤ç‚¹</p>\n<ul>\n<li>å¦‚æœä»¥æ¨¡æ‹Ÿæ‰§è¡Œä¸ºç›®çš„ï¼Œå»ºè®®ä½¿ç”¨ç¬¬ä¸‰æ–¹ Hook æ–¹æ¡ˆï¼Œarm32 ä¸‹ HookZz çš„æ”¯æŒè¾ƒå¥½ï¼Œarm64 ä¸‹ Dobby çš„æ”¯æŒè¾ƒå¥½ï¼ŒHookZz/Dobby Hook ä¸æˆåŠŸæ—¶ï¼Œå¦‚æœå‡½æ•°æ˜¯å¯¼å‡ºå‡½æ•°ï¼Œä½¿ç”¨ xHookï¼Œå¦åˆ™ä½¿ç”¨ Whaleã€‚</li>\n<li>å¦‚æœä»¥ç®—æ³•è¿˜åŸä¸ºç›®çš„ï¼Œå»ºè®®ä½¿ç”¨ Console Debugger å’Œ Unicorn Hookï¼Œå¹¶å»ºè®®ä¸ä¼˜å…ˆä½¿ç”¨ç¬¬ä¸‰æ–¹ Hook æ–¹æ¡ˆã€‚</li>\n</ul>\n<h2 id=\"åŸºç¡€çŸ¥è¯†\"><a class=\"anchor\" href=\"#åŸºç¡€çŸ¥è¯†\">#</a> åŸºç¡€çŸ¥è¯†</h2>\n<h3 id=\"è·å–soçš„åŸºå€\"><a class=\"anchor\" href=\"#è·å–soçš„åŸºå€\">#</a> è·å– so çš„åŸºå€</h3>\n<p><strong>åŠ è½½ä¸€ä¸ª so</strong></p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// åŠ è½½ so åˆ°è™šæ‹Ÿå†…å­˜</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">DalvikModule</span> dm <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libnative-lib.so\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// åŠ è½½å¥½çš„ so å¯¹åº”ä¸ºä¸€ä¸ªæ¨¡å—</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">module</span> <span class=\"token operator\">=</span> dm<span class=\"token punctuation\">.</span><span class=\"token function\">getModule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// æ‰“å° libnative-lib.so åœ¨ Unidbg è™šæ‹Ÿå†…å­˜ä¸­çš„åŸºåœ°å€</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"baseAddr:\"</span><span class=\"token operator\">+</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>åŠ è½½å¤šä¸ª so</strong></p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// è·å–æŸä¸ªå…·ä½“ SO çš„å¥æŸ„</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">Module</span> yourModule <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getMemory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">findModule</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"yourModuleName\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// æ‰“å°å…¶åŸºåœ°å€</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"baseAddr:\"</span><span class=\"token operator\">+</span>yourModule<span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>å¦‚æœåªä¸»åŠ¨åŠ è½½ä¸€ä¸ª soï¼Œå…¶åŸºå€æ’ä¸º 0x40000000 , è¿™æ˜¯ä¸€ä¸ªæ£€æµ‹ Unidbg çš„ç‚¹ï¼Œå¯ä»¥åœ¨  <code>com/github/unidbg/memory/Memory.java</code>  ä¸­åšä¿®æ”¹</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Memory</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">IO</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Loader</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">StackMemory</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">long</span> <span class=\"token constant\">STACK_BASE</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span>xc0000000L<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">int</span> <span class=\"token constant\">STACK_SIZE_OF_PAGE</span> <span class=\"token operator\">=</span> <span class=\"token number\">256</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1024k</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token comment\">// ä¿®æ”¹å†…å­˜æ˜ å°„çš„èµ·å§‹åœ°å€</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token keyword\">long</span> <span class=\"token constant\">MMAP_BASE</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span>x40000000L<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token class-name\">UnidbgPointer</span> <span class=\"token function\">allocateStack</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token class-name\">UnidbgPointer</span> <span class=\"token function\">pointer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">void</span> <span class=\"token function\">setStackPoint</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> sp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"è·å–å¯¼å‡ºå‡½æ•°åœ°å€\"><a class=\"anchor\" href=\"#è·å–å¯¼å‡ºå‡½æ•°åœ°å€\">#</a> è·å–å¯¼å‡ºå‡½æ•°åœ°å€</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// åŠ è½½ so åˆ°è™šæ‹Ÿå†…å­˜</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">DalvikModule</span> dm <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libnative-lib.so\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// åŠ è½½å¥½çš„ libnative-lib.so å¯¹åº”ä¸ºä¸€ä¸ªæ¨¡å—</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">module</span> <span class=\"token operator\">=</span> dm<span class=\"token punctuation\">.</span><span class=\"token function\">getModule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">int</span> address <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span><span class=\"token function\">findSymbolByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"funcNmae\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"è·å–éå¯¼å‡ºå‡½æ•°åœ°å€\"><a class=\"anchor\" href=\"#è·å–éå¯¼å‡ºå‡½æ•°åœ°å€\">#</a> è·å–éå¯¼å‡ºå‡½æ•°åœ°å€</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// åŠ è½½ so åˆ°è™šæ‹Ÿå†…å­˜</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token class-name\">DalvikModule</span> dm <span class=\"token operator\">=</span> vm<span class=\"token punctuation\">.</span><span class=\"token function\">loadLibrary</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libnative-lib.so\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// åŠ è½½å¥½çš„ so å¯¹åº”ä¸ºä¸€ä¸ªæ¨¡å—</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">module</span> <span class=\"token operator\">=</span> dm<span class=\"token punctuation\">.</span><span class=\"token function\">getModule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">//offsetï¼Œåœ¨ IDA ä¸­æŸ¥çœ‹</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">int</span> offset <span class=\"token operator\">=</span> <span class=\"token number\">0x1768</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">// çœŸå®åœ°å€ = baseAddr + offset</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> address <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span>base <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"console-debugger\"><a class=\"anchor\" href=\"#console-debugger\">#</a> Console Debugger</h2>\n<h3 id=\"åŸºç¡€hook\"><a class=\"anchor\" href=\"#åŸºç¡€hook\">#</a> åŸºç¡€ hook</h3>\n<p><strong>ä½¿ç”¨ Console Debugger ä¸‹æ–­ç‚¹</strong></p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// debug</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>emulator<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addBreakPoint</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span><span class=\"token function\">findSymbolByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64_encode\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ul>\n<li>è¿è¡Œåˆ°å¯¹åº”åœ°å€æ—¶è§¦å‘æ–­ç‚¹ï¼Œç±»ä¼¼äº GDB è°ƒè¯•æˆ–è€… IDA è°ƒè¯•ï¼Œæ—¶æœºä¸º<strong>ç›®æ ‡æŒ‡ä»¤æ‰§è¡Œå‰</strong></li>\n<li>Console Debugger ç”¨äºè¾…åŠ©ç®—æ³•åˆ†æï¼Œå¿«é€Ÿåˆ†æã€ç¡®è®¤æŸä¸ªå‡½æ•°çš„åŠŸèƒ½ã€‚å¹¶ä¸”<strong>åªèƒ½åœ¨ Unicorn å¼•æ“ä¸‹</strong>æ‰å¯ä»¥ä½¿ç”¨</li>\n</ul>\n<p><strong>äº¤äº’å‘½ä»¤</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>c<span class=\"token operator\">:</span> <span class=\"token keyword\">continue</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>n<span class=\"token operator\">:</span> step over</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>bt<span class=\"token operator\">:</span> back trace</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>st hex<span class=\"token operator\">:</span> search stack</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>shw hex<span class=\"token operator\">:</span> search writable heap</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>shr hex<span class=\"token operator\">:</span> search readable heap</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>shx hex<span class=\"token operator\">:</span> search executable heap</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>nb<span class=\"token operator\">:</span> <span class=\"token keyword\">break</span> at next block</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>s<span class=\"token operator\">|</span>si<span class=\"token operator\">:</span> step into</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>s<span class=\"token punctuation\">[</span>decimal<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> execute specified amount instruction</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">s</span><span class=\"token punctuation\">(</span>blx<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> execute util BLX mnemonic<span class=\"token punctuation\">,</span> low performance</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token function\">m</span><span class=\"token punctuation\">(</span>op<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>size<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> show memory<span class=\"token punctuation\">,</span> <span class=\"token keyword\">default</span> size is <span class=\"token number\">0x70</span><span class=\"token punctuation\">,</span> size may hex or decimal</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>mr0<span class=\"token operator\">-</span>mr7<span class=\"token punctuation\">,</span> mfp<span class=\"token punctuation\">,</span> mip<span class=\"token punctuation\">,</span> msp <span class=\"token punctuation\">[</span>size<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> show memory of specified <span class=\"token keyword\">register</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token function\">m</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>size<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> show memory of specified address<span class=\"token punctuation\">,</span> address must start with <span class=\"token number\">0</span>x</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>wr0<span class=\"token operator\">-</span>wr7<span class=\"token punctuation\">,</span> wfp<span class=\"token punctuation\">,</span> wip<span class=\"token punctuation\">,</span> wsp <span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span><span class=\"token operator\">:</span> write specified <span class=\"token keyword\">register</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token function\">wb</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">ws</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">wi</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span><span class=\"token operator\">:</span> <span class=\"token function\">write</span> <span class=\"token punctuation\">(</span>byte<span class=\"token punctuation\">,</span> <span class=\"token keyword\">short</span><span class=\"token punctuation\">,</span> integer<span class=\"token punctuation\">)</span> memory of specified address<span class=\"token punctuation\">,</span> address must start with <span class=\"token number\">0</span>x</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token function\">wx</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span>hex<span class=\"token operator\">></span><span class=\"token operator\">:</span> write bytes to memory at specified address<span class=\"token punctuation\">,</span> address must start with <span class=\"token number\">0</span>x</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token function\">b</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> add temporarily breakpoint<span class=\"token punctuation\">,</span> address must start with <span class=\"token number\">0</span>x<span class=\"token punctuation\">,</span> can be module offset</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>b<span class=\"token operator\">:</span> add breakpoint of <span class=\"token keyword\">register</span> PC</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>r<span class=\"token operator\">:</span> remove breakpoint of <span class=\"token keyword\">register</span> PC</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>blr<span class=\"token operator\">:</span> add temporarily breakpoint of <span class=\"token keyword\">register</span> LR</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token function\">p</span> <span class=\"token punctuation\">(</span>assembly<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> patch assembly at PC address</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>where<span class=\"token operator\">:</span> show java stack trace</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>trace <span class=\"token punctuation\">[</span>begin end<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> Set trace instructions</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>traceRead <span class=\"token punctuation\">[</span>begin end<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> Set trace memory read</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>traceWrite <span class=\"token punctuation\">[</span>begin end<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> Set trace memory write</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>vm<span class=\"token operator\">:</span> view loaded modules</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>vbs<span class=\"token operator\">:</span> view breakpoints</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>d<span class=\"token operator\">|</span>dis<span class=\"token operator\">:</span> show disassemble</pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token function\">d</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span>x<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> show disassemble at specify address</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>stop<span class=\"token operator\">:</span> stop emulation</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>run <span class=\"token punctuation\">[</span>arg<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> run test</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>cc size<span class=\"token operator\">:</span> convert <span class=\"token keyword\">asm</span> from <span class=\"token number\">0x400008a0</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x400008a0</span> <span class=\"token operator\">+</span> size bytes to c function</pre></td></tr></table></figure><p><strong>æŒä¹…åŒ– hook</strong></p>\n<p>onHit è¿”å› ture æ—¶ï¼Œæ–­ç‚¹è§¦å‘æ—¶ä¸ä¼šè¿›å…¥äº¤äº’ç•Œé¢ï¼›ä¸º false æ—¶ä¼šã€‚å½“å‡½æ•°è¢«è°ƒç”¨äº†ä¸‰äº”ç™¾æ¬¡æ—¶ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å®ƒåå¤åœä¸‹æ¥ï¼Œç„¶åä¸åœ â€œcâ€ æ¥ç»§ç»­è¿è¡Œã€‚</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">HookByConsoleDebugger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    emulator<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addBreakPoint</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span><span class=\"token function\">findSymbolByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64_encode\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BreakPointCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">onHit</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token class-name\">RegisterContext</span> context <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> input <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getPointerArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">int</span> length <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getIntArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> buffer <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getPointerArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token class-name\">Inspector</span><span class=\"token punctuation\">.</span><span class=\"token function\">inspect</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span><span class=\"token function\">getByteArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"base64 input\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token comment\">// OnLeave</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            emulator<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addBreakPoint</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">getLRPointer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>peer<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BreakPointCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">onHit</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                    <span class=\"token class-name\">String</span> result <span class=\"token operator\">=</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64 result:\"</span><span class=\"token operator\">+</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"ä¿®æ”¹å‚æ•°\"><a class=\"anchor\" href=\"#ä¿®æ”¹å‚æ•°\">#</a> ä¿®æ”¹å‚æ•°</h3>\n<ol>\n<li>ä¸‹æ–­ç‚¹ï¼Œè¿è¡Œä»£ç åè¿›å…¥ debugger</li>\n</ol>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>emulator<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addBreakPoint</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span><span class=\"token function\">findSymbolByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64_encode\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>é€šè¿‡å‘½ä»¤ä¿®æ”¹å‚æ•° 1 å’Œ 2</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>wx0x40002403 68656c6c6f20776f726c64</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span>-----------------------------------------------------------------------------<span class=\"token operator\">&lt;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span><span class=\"token number\">14</span>:06:46 <span class=\"token number\">165</span><span class=\"token punctuation\">]</span>RX@0x40002403<span class=\"token punctuation\">[</span>libhookinunidbg.so<span class=\"token punctuation\">]</span>0x2403, <span class=\"token assign-left variable\">md5</span><span class=\"token operator\">=</span>5eb63bbbe01eeed093cb22bb8f5acdc3, <span class=\"token assign-left variable\">hex</span><span class=\"token operator\">=</span>68656c6c6f20776f726c64</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>size: <span class=\"token number\">11</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>0000: <span class=\"token number\">68</span> <span class=\"token number\">65</span> 6C 6C 6F <span class=\"token number\">20</span> <span class=\"token number\">77</span> 6F <span class=\"token number\">72</span> 6C <span class=\"token number\">64</span>                   hello world</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>^-----------------------------------------------------------------------------^</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>wr1 <span class=\"token number\">11</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token assign-left variable\">r1</span><span class=\"token operator\">=</span>0xb</pre></td></tr></table></figure><p>Console Debugger æ”¯æŒä¸‹åˆ—å†™æ“ä½œ</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>wr0-wr7, wfp, wip, wsp <span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>: <span class=\"token function\">write</span> specified register</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>wb<span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span>, ws<span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span>, wi<span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span>value<span class=\"token operator\">></span>: <span class=\"token function\">write</span> <span class=\"token punctuation\">(</span>byte, short, integer<span class=\"token punctuation\">)</span> memory of specified address, address must start with 0x</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>wx<span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span>hex<span class=\"token operator\">></span>: <span class=\"token function\">write</span> bytes to memory at specified address, address must start with 0x</pre></td></tr></table></figure><p>æŒä¹…åŒ–ä¸­çš„ä¿®æ”¹å‚æ•°</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">ReplaceArgByConsoleDebugger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    emulator<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addBreakPoint</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span><span class=\"token function\">findSymbolByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64_encode\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BreakPointCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">onHit</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token class-name\">RegisterContext</span> context <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token class-name\">String</span> fakeInput <span class=\"token operator\">=</span> <span class=\"token string\">\"hello world\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">int</span> length <span class=\"token operator\">=</span> fakeInput<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token comment\">// ä¿®æ”¹ r1 å€¼ä¸ºæ–°é•¿åº¦</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getBackend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reg_write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArmConst</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UC_ARM_REG_R1</span><span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token class-name\">MemoryBlock</span> fakeInputBlock <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getMemory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            fakeInputBlock<span class=\"token punctuation\">.</span><span class=\"token function\">getPointer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>fakeInput<span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token comment\">// ä¿®æ”¹ r0 ä¸ºæŒ‡å‘æ–°å­—ç¬¦ä¸²çš„æ–°æŒ‡é’ˆ</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getBackend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reg_write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArmConst</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UC_ARM_REG_R0</span><span class=\"token punctuation\">,</span> fakeInputBlock<span class=\"token punctuation\">.</span><span class=\"token function\">getPointer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>peer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> buffer <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getPointerArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token comment\">// OnLeave</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            emulator<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addBreakPoint</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">getLRPointer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>peer<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BreakPointCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">onHit</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                    <span class=\"token class-name\">String</span> result <span class=\"token operator\">=</span> buffer<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64 result:\"</span><span class=\"token operator\">+</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"ä¿®æ”¹è¿”å›å€¼\"><a class=\"anchor\" href=\"#ä¿®æ”¹è¿”å›å€¼\">#</a> ä¿®æ”¹è¿”å›å€¼</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">ReplaceRetByConsoleDebugger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    emulator<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addBreakPoint</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span><span class=\"token function\">findSymbolByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"verifyApkSign\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BreakPointCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">onHit</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token class-name\">RegisterContext</span> context <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token comment\">// OnLeave</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            emulator<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addBreakPoint</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">getLRPointer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>peer<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BreakPointCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">onHit</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                    emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getBackend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reg_write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArmConst</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UC_ARM_REG_R0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"æ›¿æ¢å‡½æ•°\"><a class=\"anchor\" href=\"#æ›¿æ¢å‡½æ•°\">#</a> æ›¿æ¢å‡½æ•°</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">ReplaceFuncByConsoleDebugger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    emulator<span class=\"token punctuation\">.</span><span class=\"token function\">attach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addBreakPoint</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span><span class=\"token function\">findSymbolByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"verifyApkSign\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BreakPointCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">onHit</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"æ›¿æ¢å‡½æ•° verifyApkSign\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token class-name\">RegisterContext</span> registerContext <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getBackend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reg_write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArmConst</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UC_ARM_REG_PC</span><span class=\"token punctuation\">,</span> registerContext<span class=\"token punctuation\">.</span><span class=\"token function\">getLRPointer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>peer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getBackend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reg_write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArmConst</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UC_ARM_REG_R0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"unicorn-hook\"><a class=\"anchor\" href=\"#unicorn-hook\">#</a> Unicorn Hook</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">HookByUnicorn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">long</span> start <span class=\"token operator\">=</span> <span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span>base<span class=\"token operator\">+</span><span class=\"token number\">0x97C</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">long</span> end <span class=\"token operator\">=</span> <span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span>base<span class=\"token operator\">+</span><span class=\"token number\">0x97C</span><span class=\"token operator\">+</span><span class=\"token number\">0x17A</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getBackend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">hook_add_new</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">CodeHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">hook</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Backend</span> backend<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> address<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> size<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span> user<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token class-name\">RegisterContext</span> registerContext <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>address <span class=\"token operator\">==</span> <span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span>base <span class=\"token operator\">+</span> <span class=\"token number\">0x97C</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>                <span class=\"token keyword\">int</span> r0 <span class=\"token operator\">=</span> registerContext<span class=\"token punctuation\">.</span><span class=\"token function\">getIntByReg</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArmConst</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UC_ARM_REG_R0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"0x97C å¤„ r0:\"</span><span class=\"token operator\">+</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">.</span><span class=\"token function\">toHexString</span><span class=\"token punctuation\">(</span>r0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token comment\">//capstone å¼•æ“çš„ä½¿ç”¨</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token class-name\">Capstone</span> capstone <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Capstone</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Capstone</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CS_ARCH_ARM64</span><span class=\"token punctuation\">,</span><span class=\"token class-name\">Capstone</span><span class=\"token punctuation\">.</span><span class=\"token constant\">CS_MODE_ARM</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> bytes <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getBackend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mem_read</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                <span class=\"token class-name\">Instruction</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> disasm <span class=\"token operator\">=</span> capstone<span class=\"token punctuation\">.</span><span class=\"token function\">disasm</span><span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">onAttach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Unicorn<span class=\"token punctuation\">.</span>UnHook</span> unHook<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">detach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> start<span class=\"token punctuation\">,</span> end<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"xhook\"><a class=\"anchor\" href=\"#xhook\">#</a> xHook</h2>\n<p>xHook æ˜¯çˆ±å¥‡è‰ºå¼€æºçš„ Android PLT hook æ¡†æ¶ï¼Œä¼˜ç‚¹æ˜¯æŒºç¨³å®šå¥½ç”¨ï¼Œç¼ºç‚¹æ˜¯ä¸èƒ½ Hook Sub_xxx å­å‡½æ•°ã€‚</p>\n<h3 id=\"åŸºç¡€hook-2\"><a class=\"anchor\" href=\"#åŸºç¡€hook-2\">#</a> åŸºç¡€ hook</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">HookByXhook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">IxHook</span> xHook <span class=\"token operator\">=</span> <span class=\"token class-name\">XHookImpl</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    xHook<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libhookinunidbg.so\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"base64_encode\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReplaceCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token class-name\">HookStatus</span> <span class=\"token function\">onCall</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HookContext</span> context<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> originFunction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> input <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getPointerArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">int</span> length <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getIntArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> buffer <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getPointerArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token class-name\">Inspector</span><span class=\"token punctuation\">.</span><span class=\"token function\">inspect</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span><span class=\"token function\">getByteArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"base64 input\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            context<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token class-name\">HookStatus</span><span class=\"token punctuation\">.</span><span class=\"token function\">RET</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">,</span> originFunction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">postCall</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HookContext</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> buffer <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64 result:\"</span><span class=\"token operator\">+</span>buffer<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token comment\">// ä½¿å…¶ç”Ÿæ•ˆ</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    xHook<span class=\"token punctuation\">.</span><span class=\"token function\">refresh</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"ä¿®æ”¹å‚æ•°-2\"><a class=\"anchor\" href=\"#ä¿®æ”¹å‚æ•°-2\">#</a> ä¿®æ”¹å‚æ•°</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">ReplaceArgByXhook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">IxHook</span> xHook <span class=\"token operator\">=</span> <span class=\"token class-name\">XHookImpl</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    xHook<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"libhookinunidbg.so\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"base64_encode\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReplaceCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token class-name\">HookStatus</span> <span class=\"token function\">onCall</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HookContext</span> context<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> originFunction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token class-name\">String</span> fakeInput <span class=\"token operator\">=</span> <span class=\"token string\">\"hello world\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">int</span> length <span class=\"token operator\">=</span> fakeInput<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token comment\">// ä¿®æ”¹ r1 å€¼ä¸ºæ–°é•¿åº¦</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getBackend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reg_write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArmConst</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UC_ARM_REG_R1</span><span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token class-name\">MemoryBlock</span> fakeInputBlock <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getMemory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span>length<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            fakeInputBlock<span class=\"token punctuation\">.</span><span class=\"token function\">getPointer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>fakeInput<span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token comment\">// ä¿®æ”¹ r0 ä¸ºæŒ‡å‘æ–°å­—ç¬¦ä¸²çš„æ–°æŒ‡é’ˆ</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getBackend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reg_write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArmConst</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UC_ARM_REG_R0</span><span class=\"token punctuation\">,</span> fakeInputBlock<span class=\"token punctuation\">.</span><span class=\"token function\">getPointer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>peer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> buffer <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getPointerArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            context<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token class-name\">HookStatus</span><span class=\"token punctuation\">.</span><span class=\"token function\">RET</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">,</span> originFunction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">postCall</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HookContext</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> buffer <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64 result:\"</span><span class=\"token operator\">+</span>buffer<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// ä½¿å…¶ç”Ÿæ•ˆ</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    xHook<span class=\"token punctuation\">.</span><span class=\"token function\">refresh</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"æ›¿æ¢å‡½æ•°-2\"><a class=\"anchor\" href=\"#æ›¿æ¢å‡½æ•°-2\">#</a> æ›¿æ¢å‡½æ•°</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">ReplaceFuncByHookZz</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">HookZz</span> hook <span class=\"token operator\">=</span> <span class=\"token class-name\">HookZz</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    hook<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span><span class=\"token function\">findSymbolByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"verifyApkSign\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAddress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReplaceCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token class-name\">HookStatus</span> <span class=\"token function\">onCall</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HookContext</span> context<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> originFunction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getBackend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">reg_write</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Unicorn</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UC_ARM_REG_R0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token class-name\">HookStatus</span><span class=\"token punctuation\">.</span><span class=\"token function\">RET</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">,</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">getLR</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"hookzz\"><a class=\"anchor\" href=\"#hookzz\">#</a> HookZz</h2>\n<p>HookZz ç°åœ¨å« Dobbyï¼ŒUnidbg ä¸­æ˜¯ HookZz å’Œ Dobby æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ Hook åº“ï¼Œå› ä¸ºä½œè€…è®¤ä¸º HookZz åœ¨ arm32 ä¸Šæ”¯æŒè¾ƒå¥½ï¼ŒDobby åœ¨ arm64 ä¸Šæ”¯æŒè¾ƒå¥½ã€‚HookZz æ˜¯ inline hook æ–¹æ¡ˆï¼Œå› æ­¤å¯ä»¥ Hook Sub_xxxï¼Œç¼ºç‚¹æ˜¯çŸ­å‡½æ•°å¯èƒ½å‡º bugï¼Œå—é™äº inline Hook åŸç†ã€‚</p>\n<h3 id=\"åŸºç¡€hook-3\"><a class=\"anchor\" href=\"#åŸºç¡€hook-3\">#</a> åŸºç¡€ hook</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">HookByHookZz</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">IHookZz</span> hookZz <span class=\"token operator\">=</span> <span class=\"token class-name\">HookZz</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// åŠ è½½ HookZzï¼Œæ”¯æŒ inline hook</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    hookZz<span class=\"token punctuation\">.</span><span class=\"token function\">enable_arm_arm64_b_branch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æµ‹è¯• enable_arm_arm64_b_branchï¼Œå¯æœ‰å¯æ— </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    hookZz<span class=\"token punctuation\">.</span><span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span><span class=\"token function\">findSymbolByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64_encode\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WrapCallback</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HookZzArm32RegisterContext</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">preCall</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HookZzArm32RegisterContext</span> context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HookEntryInfo</span> info<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> input <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getPointerArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token keyword\">int</span> length <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getIntArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> buffer <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getPointerArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            <span class=\"token class-name\">Inspector</span><span class=\"token punctuation\">.</span><span class=\"token function\">inspect</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span><span class=\"token function\">getByteArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"base64 input\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            context<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">postCall</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HookZzArm32RegisterContext</span> context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HookEntryInfo</span> info<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> buffer <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64 result:\"</span><span class=\"token operator\">+</span>buffer<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    hookZz<span class=\"token punctuation\">.</span><span class=\"token function\">disable_arm_arm64_b_branch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"ä¿®æ”¹å‚æ•°-3\"><a class=\"anchor\" href=\"#ä¿®æ”¹å‚æ•°-3\">#</a> ä¿®æ”¹å‚æ•°</h3>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">ReplaceArgByHookZz</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">IHookZz</span> hookZz <span class=\"token operator\">=</span> <span class=\"token class-name\">HookZz</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// åŠ è½½ HookZzï¼Œæ”¯æŒ inline hook</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    hookZz<span class=\"token punctuation\">.</span><span class=\"token function\">enable_arm_arm64_b_branch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// æµ‹è¯• enable_arm_arm64_b_branchï¼Œå¯æœ‰å¯æ— </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    hookZz<span class=\"token punctuation\">.</span><span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span><span class=\"token function\">findSymbolByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64_encode\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WrapCallback</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HookZzArm32RegisterContext</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">preCall</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HookZzArm32RegisterContext</span> context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HookEntryInfo</span> info<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> input <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getPointerArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token class-name\">String</span> fakeInput <span class=\"token operator\">=</span> <span class=\"token string\">\"hello world\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            input<span class=\"token punctuation\">.</span><span class=\"token function\">setString</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> fakeInput<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            context<span class=\"token punctuation\">.</span><span class=\"token function\">setR1</span><span class=\"token punctuation\">(</span>fakeInput<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> buffer <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getPointerArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            context<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">postCall</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HookZzArm32RegisterContext</span> context<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HookEntryInfo</span> info<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> buffer <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64 result:\"</span><span class=\"token operator\">+</span>buffer<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    hookZz<span class=\"token punctuation\">.</span><span class=\"token function\">disable_arm_arm64_b_branch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"whale\"><a class=\"anchor\" href=\"#whale\">#</a> Whale</h2>\n<p>Whale æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„ Hook æ¡†æ¶ï¼Œåœ¨ Andorid Native Hook ä¸Šä¹Ÿæ˜¯ inline Hook æ–¹æ¡ˆ</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">HookByWhale</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token class-name\">IWhale</span> whale <span class=\"token operator\">=</span> <span class=\"token class-name\">Whale</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    whale<span class=\"token punctuation\">.</span><span class=\"token function\">inlineHookFunction</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span><span class=\"token function\">findSymbolByName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64_encode\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReplaceCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token class-name\">Pointer</span> buffer<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token class-name\">HookStatus</span> <span class=\"token function\">onCall</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> originFunction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token class-name\">RegisterContext</span> context <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token class-name\">Pointer</span> input <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getPointerArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>            <span class=\"token keyword\">int</span> length <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getIntArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>            buffer <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span><span class=\"token function\">getPointerArg</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token class-name\">Inspector</span><span class=\"token punctuation\">.</span><span class=\"token function\">inspect</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span><span class=\"token function\">getByteArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"base64 input\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            <span class=\"token keyword\">return</span> <span class=\"token class-name\">HookStatus</span><span class=\"token punctuation\">.</span><span class=\"token function\">RET</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">,</span> originFunction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token annotation punctuation\">@Override</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">postCall</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Emulator</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> emulator<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HookContext</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64 result:\"</span><span class=\"token operator\">+</span>buffer<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"unidbgå¸¸ç”¨è„šæœ¬\"><a class=\"anchor\" href=\"#unidbgå¸¸ç”¨è„šæœ¬\">#</a> unidbg å¸¸ç”¨è„šæœ¬</h1>\n<h2 id=\"patch\"><a class=\"anchor\" href=\"#patch\">#</a> Patch</h2>\n<ol>\n<li>\n<p>æ–¹æ³•ä¸€</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">Patch1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">// 00 20 00 bf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">int</span> patchCode <span class=\"token operator\">=</span> <span class=\"token number\">0xBF002000</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// movs r0,0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getMemory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pointer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span>base <span class=\"token operator\">+</span> <span class=\"token number\">0x8CA</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>patchCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p>æ–¹æ³•äºŒ</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">Patch2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> patchCode <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x20</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">)</span> <span class=\"token number\">0xBF</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getBackend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mem_write</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span>base <span class=\"token operator\">+</span> <span class=\"token number\">0x8CA</span><span class=\"token punctuation\">,</span> patchCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n<li>\n<p>æ–¹æ³•ä¸‰</p>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">Patch3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Keystone</span> keystone <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Keystone</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">KeystoneArchitecture<span class=\"token punctuation\">.</span>Arm</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">KeystoneMode<span class=\"token punctuation\">.</span>ArmThumb</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token class-name\">KeystoneEncoded</span> encoded <span class=\"token operator\">=</span> keystone<span class=\"token punctuation\">.</span><span class=\"token function\">assemble</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"movs r0,0;nop\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> patchCode <span class=\"token operator\">=</span> encoded<span class=\"token punctuation\">.</span><span class=\"token function\">getMachineCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getMemory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pointer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span>base <span class=\"token operator\">+</span> <span class=\"token number\">0x8CA</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> patchCode<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> patchCode<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"å†…å­˜æ£€ç´¢\"><a class=\"anchor\" href=\"#å†…å­˜æ£€ç´¢\">#</a> å†…å­˜æ£€ç´¢</h2>\n<figure class=\"highlight java\"><figcaption data-lang=\"java\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token class-name\">SearchAndPatch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> patterns <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">)</span> <span class=\"token number\">0x80</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">)</span> <span class=\"token number\">0xb5</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x6f</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x46</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">)</span> <span class=\"token number\">0x84</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">)</span> <span class=\"token number\">0xb0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x03</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">)</span> <span class=\"token number\">0x90</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x02</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">)</span> <span class=\"token number\">0x91</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token class-name\">Collection</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Pointer</span><span class=\"token punctuation\">></span></span> pointers <span class=\"token operator\">=</span> <span class=\"token function\">searchMemory</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">,</span> <span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span>base<span class=\"token operator\">+</span><span class=\"token keyword\">module</span><span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span> patterns<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>pointers<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Keystone</span> keystone <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Keystone</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">KeystoneArchitecture<span class=\"token punctuation\">.</span>Arm</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">KeystoneMode<span class=\"token punctuation\">.</span>ArmThumb</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token class-name\">KeystoneEncoded</span> encoded <span class=\"token operator\">=</span> keystone<span class=\"token punctuation\">.</span><span class=\"token function\">assemble</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"movs r0,0;nop\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> patchCode <span class=\"token operator\">=</span> encoded<span class=\"token punctuation\">.</span><span class=\"token function\">getMachineCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Pointer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">)</span> pointers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> patchCode<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> patchCode<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">private</span> <span class=\"token class-name\">Collection</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Pointer</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">searchMemory</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> start<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> end<span class=\"token punctuation\">,</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Pointer</span><span class=\"token punctuation\">></span></span> pointers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> i <span class=\"token operator\">=</span> start<span class=\"token punctuation\">,</span> m <span class=\"token operator\">=</span> end <span class=\"token operator\">-</span> data<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> m<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> oneByte <span class=\"token operator\">=</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getBackend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mem_read</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> oneByte<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> emulator<span class=\"token punctuation\">.</span><span class=\"token function\">getBackend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mem_read</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            pointers<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UnidbgPointer</span><span class=\"token punctuation\">.</span><span class=\"token function\">pointer</span><span class=\"token punctuation\">(</span>emulator<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            i <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">return</span> pointers<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"å‚è€ƒèµ„æ–™\"><a class=\"anchor\" href=\"#å‚è€ƒèµ„æ–™\">#</a> å‚è€ƒèµ„æ–™</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vcjB5c3VlL3AvMTUyMzgzODkuaHRtbA==\">Unidbg æ–‡æ¡£æ›´æ–° (ä¸€)</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vcjB5c3VlL3AvMTU0NTczMDIuaHRtbA==\">Unidbg æ–‡æ¡£æ…¢æ›´ (äºŒ)</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9yZWFvLmlvLzkw\">Unidbg Hook å¤§å…¨</span></li>\n<li></li>\n</ul>\n",
            "tags": []
        },
        {
            "id": "https://oacia.dev/CBCTF-2023/",
            "url": "https://oacia.dev/CBCTF-2023/",
            "title": "CBCTF auuuu3å’Œvm_flutterå‡ºé¢˜æ€è·¯åŠwp",
            "date_published": "2023-10-23T06:42:47.000Z",
            "content_html": "<p>å»å¹´ CBCTF çš„æ—¶å€™ï¼Œæˆ‘å½“æ—¶ä¸ºè¿™ä¸ªæ¯”èµ›å‡ºäº†ä¸€é“é€†å‘é¢˜å«åš <code>CBNET</code> , å¯æ˜¯ç›´åˆ°ç»“æŸä¹‹åæ‰ç»ˆäºæœ‰äº†ä¸€è§£ï¼Œæˆ‘é‚£æ—¶éå¸¸è‡ªè´£ï¼Œæ„Ÿè§‰è‡ªå·±æŠŠé¢˜ç›®å‡ºéš¾äº†å¯¼è‡´å¤§å®¶éƒ½åšä¸å‡ºæ¥ï¼Œé‚£æ¬¡æ¯”èµ›ç»“æŸä¹‹åå‡ ä¸ªå¸ˆå‚…æ‰¾æˆ‘é—®è¿™é¢˜ï¼Œæˆ‘å‘ç°åŸæ¥æ˜¯æˆ‘è‡ªå·±è®¾è®¡çš„è‡ªå®šä¹‰ç®—æ³•éš¾ä½äº†å¤§å®¶ï¼Œå¤§å®¶ä¸ä¼šå†™é€†å‘è„šæœ¬å¯¼è‡´çš„ã€‚æ‰€ä»¥ä»Šå¹´çš„ CBCTF, æˆ‘æ€»ç»“äº†å»å¹´å‡ºé¢˜çš„ç»éªŒï¼Œç»™è‡ªå·±ä»Šå¹´å‡ºé¢˜å®šçš„ç›®æ ‡çš„å°±æ˜¯å¸Œæœ›æ¯ä¸€ä¸ªäººéƒ½å¯ä»¥å»å°è¯•ç€å»åšä¸€ä¸‹ï¼Œå¹¶ä¸”ä¸åœ¨ç®—æ³•çš„å±‚é¢å»ä¸ºéš¾å¤§å®¶.</p>\n<p>auuuu3 çš„å‡ºé¢˜çµæ„Ÿä¸»è¦åœ¨ä¸ŠåŠå¹´çœ‹åˆ°è¿‡ä¸€ç¯‡æ–‡ç« ï¼Œè¯´æ˜¯æœ‰ hacker åœ¨å‹ç¼©åŒ…é‡Œè—äº†ä¸€ä¸ªæ— æ¯’çš„ autoit exe è§£é‡Šå™¨ï¼Œç„¶åè¿™ä¸ªè§£é‡Šå™¨è¿è¡Œæ¶æ„çš„ au3 è„šæœ¬æ¥å®ç°æ¶æ„è¡Œä¸ºï¼Œå½“æ—¶æˆ‘å°±åœ¨æƒ³è¦æ˜¯æŠŠè¿™ä¸ª au3 è„šæœ¬ç¼–è¯‘æˆ exe ä¹‹åä¼šä¸ä¼šå¾ˆæœ‰è¶£å‘¢ï½æ‰€ä»¥å°±å¼€å§‹äº†å°è¯•ï¼Œå†™äº†ä¸€ä¸ª demo è‡ªå·±åšäº†ä¸€ä¸‹ï¼Œå‘ç°ç›´æ¥ç”¨ ida é€†å‘çš„éš¾åº¦ç›¸å½“çš„é«˜ï¼Œéœ€è¦æå¼ºçš„é€†å‘æ°´å¹³æ‰å¯ä»¥åšå‡ºæ¥ï¼Œæ‰€ä»¥æˆ‘å°±å»ç½‘ä¸Šå¯»æ‰¾å¯ä»¥é€†å‘ autoit çš„å·¥å…·ï¼Œä¸€å¼€å§‹ç”¨å®˜æ–¹è‡ªå¸¦çš„ exe2aut æ˜¯å¯ä»¥æˆåŠŸå¾—åˆ°æºç çš„ï¼Œéšåæˆ‘å»ç¿»çœ‹äº† autoit å®˜æ–¹çš„æ–‡æ¡£ï¼Œå‘ç°è¿™ä¸ª exe2aut åœ¨ autoitv3.2.5.1 ä¹‹åå°±è¢«ç§»é™¤äº†ï¼Œä¸ºäº†ç¨ç¨å¢åŠ ä¸€äº›éš¾åº¦ï¼Œæ‰€ä»¥æˆ‘å°±é€‰ç”¨äº†é«˜ç‰ˆæœ¬çš„ autoit æ¥ç¼–è¯‘ exe, ç„¶åå°±å‘ç°ä¸ç®¡æ˜¯å®˜æ–¹çš„ exe2aut, è¿˜æ˜¯ github ä¸Šé«˜ star çš„ <code>AutoDec</code> , <code>autoitqds</code> , <code>myAut2Exe</code>  è¿™äº›å·¥å…·å…¨éƒ¨éƒ½åç¼–è¯‘æºç æŠ¥é”™äº†ï¼Œæ­£å½“æˆ‘æ‹…å¿ƒè‡ªå·±åˆè¦æŠŠä¸­ç­‰é¢˜å‡ºæˆå›°éš¾é¢˜çš„æ—¶å€™ï¼Œæˆ‘åˆå‘ç°äº†ä¸€ä¸ªå·¥å…·ï¼Œä»–å« <code>autoit-ripper</code> , å¯ä»¥å®Œç¾çš„åç¼–è¯‘é«˜ç‰ˆæœ¬çš„ autoit, æ€è·¯ä¹Ÿæ˜¯è§£æ autoit è™šæ‹Ÿæœºï¼Œæœ‰å…´è¶£çš„å¯ä»¥å»çœ‹ä¸€çœ‹å®ƒçš„æºç ï¼Œè¿˜æ˜¯æŒºæœ‰è¶£çš„ï¼Œè‡³äºé€†å‘ç®—æ³•ï¼Œæˆ‘ä»…ä»…æ˜¯ç”¨ shellcode åŠ è½½äº†ä¸€ä¸ª dll, è¿™ä¸ª dll é‡Œé¢ä¹Ÿåªæœ‰ä¸€ä¸ª xxtea, åº”è¯¥é€†å‘èµ·æ¥æ˜¯éå¸¸è½»æ¾çš„</p>\n<p>vm_flutter çš„å‡ºé¢˜çµæ„Ÿæ˜¯æˆ‘åœ¨å…«æœˆæœ«åšå®Œè…¾è®¯æ¸¸æˆå®‰å…¨ç«èµ›å®‰å“åˆèµ›é¢˜ä¹‹åï¼Œå¯¹è¿™é¢˜ä¸­çš„ vm æœ‰äº†è¾ƒæ·±çš„æ„Ÿæ‚Ÿä¹‹åå†³å®šè®¾è®¡çš„ï¼Œåœ¨è§£é‚£é¢˜çš„ vm çš„æ—¶å€™ï¼Œæˆ‘å¯¹äºå®ƒçš„ opcode æŒ‡ä»¤çœŸçš„æ˜¯å…¨ç„¶ä¸çŸ¥ï¼Œæ‰€ä»¥æˆ‘å» hook äº† vm ç›¸å…³çš„å‡½æ•°æˆåŠŸçš„è§£å‡ºäº† vm, è¦æ˜¯æƒ³çœ‹è¿™åœºæ¯”èµ›é¢˜è§£çš„å¯ä»¥ç§»æ­¥æˆ‘åšå®¢çš„<a href=\"https://oacia.dev/sec-2023\">è¿™ç¯‡æ–‡ç« </a>ã€‚å›åˆ° vm_flutter, è¿™é¢˜åœ¨æ¯”èµ›ç»“æŸä¹‹ååªæœ‰ä¸€è§£æˆ‘æ„Ÿè§‰å…¶å®æŒºæ„å¤–çš„ï¼Œåº”è¯¥å¯ä»¥æœ‰æ›´å¤šäººå¯ä»¥åšå‡ºæ¥è¿™é¢˜ã€‚å‡º vm_flutter çš„æ—¶å€™ï¼Œæˆ‘æƒ³è¦è®¾è®¡ä¸€ä¸ªå¤§å®¶ä¸çŸ¥é“ opcode çš„ç¯å¢ƒï¼Œæˆ‘æƒ³æœ€å¥½çš„æ–¹æ³•å°±æ˜¯ç”¨ flutter æ¡†æ¶ï¼Œç„¶åæŠŠ opcode æ”¾åœ¨ dart å±‚ä¸­ï¼Œä½†æ˜¯æˆ‘åˆå¸Œæœ›å¤§å®¶å¯ä»¥å¾ˆå¿«çš„æ‰¾å‡º vm çš„å‡½æ•°æ¯”å¦‚ <code>push</code> , <code>pop</code> , <code>add</code>  ç­‰ç­‰å‡½æ•°æ‰€åœ¨çš„ä½ç½®ï¼Œæ‰€ä»¥æˆ‘å°†è¿™äº›å‡½æ•°å…¨éƒ¨éƒ½å®šä¹‰åœ¨äº† java å±‚ä¸­ï¼Œè¿™æ ·å¤§å®¶ç”¨ jadx æˆ– jeb åç¼–è¯‘ä¹‹åï¼Œå°±å¯ä»¥å¾ˆå¿«æ‰¾åˆ°ä»–ä»¬äº†ã€‚æ¥ä¸‹æ¥çš„éœ€è¦è§£å†³çš„é—®é¢˜å°±æ˜¯å¦‚ä½•è®© flutter çš„ dart å±‚å»è°ƒç”¨åŸç”Ÿå®‰å“ä¸­çš„ java å±‚ä¸­çš„å‡½æ•°ï¼Œè¿™é‡Œæˆ‘ç”¨çš„æ–¹æ³•æ˜¯æˆ‘ä¸ŠåŠå¹´åœ¨é€†å‘ä¸€ä¸ª flutter æ¡†æ¶çš„æ¸¸æˆå«åš<em>è£…æ‰®å°‘å¥³</em>çš„æ—¶å€™å­¦ä¹ åˆ°çš„ï¼Œè¿™ä¸ª app ä½¿ç”¨ <code>MethodChannel</code>  ç®¡é“é€šä¿¡çš„æ–¹å¼å®ç° dart å±‚å’ŒåŸç”Ÿå®‰å“ä¹‹é—´çš„é€šä¿¡ï¼Œè€Œé€šè®¯çš„æ¶ˆæ¯æˆ‘ä¹Ÿæ²¡æœ‰ä¿®æ”¹ï¼Œç”šè‡³å­—ç¬¦ä¸²éƒ½æ˜¯ vm æœ‰å…³çš„å­—ç¬¦ä¸²ã€‚ä½†æ˜¯æ–¹æ³•åæ··æ·†å…¶å®æ˜¯åœ¨æˆ‘çš„é¢„æœŸä¹‹å¤–ï¼Œè¿™å…¶å®æ˜¯ build apk çš„æ—¶å€™ flutter è‡ªåŠ¨æŠŠæ–¹æ³•åæ··æ·†äº†çš„ï¼Œä¸æ˜¯æˆ‘å¹²çš„ï¼ï¼(æœ¬æ¥æˆ‘æ˜¯æƒ³è®©å¤§å®¶ä¸€ä¸‹å°±å¯ä»¥çŸ¥é“ java å±‚å‡½æ•°çš„å«ä¹‰çš„), ç„¶åæˆ‘è¿˜æŠŠæœ€ç»ˆçš„ check å‡½æ•°ä¹Ÿæ”¾åœ¨äº† java å±‚ä¸­ï¼Œè€Œä¸æ˜¯åœ¨ vm ä¸­å» check,dart å±‚é€šè¿‡ check çš„ç»“æœå»å¼¹å‡º right æˆ– wrong, æ‰€ä»¥è¿™æ ·åº”è¯¥èƒ½æ›´åŠ é™ä½å¤§å®¶è§£é¢˜çš„éš¾åº¦äº†ï½</p>\n<h1 id=\"auuuu3\"><a class=\"anchor\" href=\"#auuuu3\">#</a> auuuu3</h1>\n<p>æœ¬é¢˜æ˜¯ç”± autoit ç¼–å†™è€Œæˆçš„ exeï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œé€šè¿‡è§£æ autoit åŠ¨æ€è„šæœ¬è¯­è¨€æ¥æ‰§è¡Œå‘½ä»¤ï¼Œå€˜è‹¥ä½¿ç”¨ IDA æˆ– od ç›´æ¥é€†å‘ï¼Œé‚£ä¹ˆæ˜¯éœ€è¦èŠ±è´¹ä¸€æ®µæ—¶é—´åœ¨è¿™é¢˜ä¸Šçš„ã€‚å¹¶ä¸”æ ¹æ®å®˜æ–¹çš„è¯´æ³•ï¼Œåœ¨ v3.2.5.1 ä¹‹åçš„ autoit ç‰ˆæœ¬ä¸­å°†ä¸å†æ‹¥æœ‰è‡ªå¸¦çš„åç¼–è¯‘å·¥å…·ï¼Œæœ¬é¢˜æ‰€ä½¿ç”¨çš„ autoit ç‰ˆæœ¬åœ¨ v3.2.5.1 ä¹‹ä¸Šã€‚</p>\n<p><img data-src=\"/CBCTF-2023/image-20231024100923652.png\" alt=\"image-20231024100923652\" style=\"aspect-ratio:907 / 273;\"></p>\n<p>ä¸è¿‡å¥½åœ¨å·²ç»æœ‰äººå¸®åŠ©æˆ‘ä»¬åˆ†æå‡ºäº†è™šæ‹ŸæŒ‡ä»¤å¯¹åº”çš„å«ä¹‰ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å·¥å…·å³å¯å¿«é€Ÿå¾—åˆ°æºç ã€‚</p>\n<p>æŸ¥å£³ï¼Œè¿™æ˜¯ç”¨ autoit ç¼–è¯‘è€Œæˆçš„ exeï¼Œæ— å£³ã€‚</p>\n<p><img data-src=\"/CBCTF-2023/1698113274705-1.png\" alt=\"img\" style=\"aspect-ratio:817 / 494;\"></p>\n<p>ä½¿ç”¨ <code>AutoIt-Ripper</code>  å¾—åˆ°è¯¥ exe çš„æºç </p>\n<pre><code class=\"language-Shell\">https://github.com/nazywam/AutoIt-Ripper\n</code></pre>\n<p><img data-src=\"/CBCTF-2023/image-20231024100948515.png\" alt=\"image-20231024100948515\" style=\"aspect-ratio:747 / 98;\"></p>\n<p>é€šè¿‡æœç´¢å­—ç¬¦ä¸² <code>wrong</code>  å®šä½åˆ°å…³é”®å‡½æ•°</p>\n<p><img data-src=\"/CBCTF-2023/image-20231024101011962.png\" alt=\"image-20231024101011962\" style=\"aspect-ratio:1920 / 1078;\"></p>\n<p>åˆ†æåŠ å¯†æµç¨‹ï¼Œé¦–å…ˆåˆ¤æ–­è¾“å…¥æ˜¯å¦æ»¡è¶³ 38 ä½ï¼Œå¦‚æœæ»¡è¶³ï¼Œåˆ™å°†è¾“å…¥ç»è¿‡ <code>ENC</code>  å‡½æ•°åŠ å¯†ï¼Œ <code>ENC</code>  å‡½æ•°å¦‚ä¸‹</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Func <span class=\"token function\">ENC</span> <span class=\"token punctuation\">(</span> $DATA <span class=\"token punctuation\">,</span> $KEY <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        $DATA <span class=\"token operator\">=</span> <span class=\"token function\">Binary</span> <span class=\"token punctuation\">(</span> $DATA <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        Local $DATALEN <span class=\"token operator\">=</span> <span class=\"token function\">BinaryLen</span> <span class=\"token punctuation\">(</span> $DATA <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        If $DATALEN <span class=\"token operator\">=</span> <span class=\"token number\">0</span> Then</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                Return <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        ElseIf $DATALEN <span class=\"token operator\">&lt;</span> <span class=\"token number\">8</span> Then</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                $DATALEN <span class=\"token operator\">=</span> <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        EndIf</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        Local $OPCODE <span class=\"token operator\">=</span> <span class=\"token string\">\"0x83EC14B83400000099538B5C2420558B6C242056578B7C9DFCF7FB89C683C606C74424180000000085F68D76FF0F8EEA000000896C24288D4BFF8D549D00894C2410895424148974242081442418B979379E8B4C2418C1E90281E103000000894C241C31F6397424107E568B5424288BCF8B6CB204C1E9058D14AD0000000033CA8BD58BC7C1EA03C1E00433D003CA8B5424188BDE81E303000000335C241C8B4424308B1C9833D533DF03D333CA8B542428010CB28B0CB2463974241089CF7FAA8B5424288BCF8B2AC1E9058D14AD0000000033CA8BD58BC7C1EA03C1E00433D003CA8B5424188BDE81E303000000335C241C8B4424308B1C9833D533DF03D3FF4C242033CA8B542414014AFC8B4AFC8B54242089CF420F8F2DFFFFFF5F31C05E5D5B83C414C21000\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        Local $CODEBUFFER <span class=\"token operator\">=</span> <span class=\"token function\">DllStructCreate</span> <span class=\"token punctuation\">(</span> <span class=\"token string\">\"byte[\"</span> <span class=\"token operator\">&amp;</span> <span class=\"token function\">BinaryLen</span> <span class=\"token punctuation\">(</span> $OPCODE <span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token string\">\"]\"</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token function\">DllStructSetData</span> <span class=\"token punctuation\">(</span> $CODEBUFFER <span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">,</span> $OPCODE <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        Local $V <span class=\"token operator\">=</span> <span class=\"token function\">DllStructCreate</span> <span class=\"token punctuation\">(</span> <span class=\"token string\">\"byte[\"</span> <span class=\"token operator\">&amp;</span> <span class=\"token function\">Ceiling</span> <span class=\"token punctuation\">(</span> $DATALEN <span class=\"token operator\">/</span> <span class=\"token number\">4</span> <span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">4</span> <span class=\"token operator\">&amp;</span> <span class=\"token string\">\"]\"</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token function\">DllStructSetData</span> <span class=\"token punctuation\">(</span> $V <span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">,</span> $DATA <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        Local $K <span class=\"token operator\">=</span> <span class=\"token function\">DllStructCreate</span> <span class=\"token punctuation\">(</span> <span class=\"token string\">\"byte[16]\"</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token function\">DllStructSetData</span> <span class=\"token punctuation\">(</span> $K <span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">,</span> $KEY <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token function\">DllCall</span> <span class=\"token punctuation\">(</span> <span class=\"token string\">\"user32.dll\"</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">\"none\"</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">\"CallWindowProc\"</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">\"ptr\"</span> <span class=\"token punctuation\">,</span> <span class=\"token function\">DllStructGetPtr</span> <span class=\"token punctuation\">(</span> $CODEBUFFER <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">\"ptr\"</span> <span class=\"token punctuation\">,</span> <span class=\"token function\">DllStructGetPtr</span> <span class=\"token punctuation\">(</span> $V <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">\"int\"</span> <span class=\"token punctuation\">,</span> <span class=\"token function\">Ceiling</span> <span class=\"token punctuation\">(</span> $DATALEN <span class=\"token operator\">/</span> <span class=\"token number\">4</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">\"ptr\"</span> <span class=\"token punctuation\">,</span> <span class=\"token function\">DllStructGetPtr</span> <span class=\"token punctuation\">(</span> $K <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">,</span> <span class=\"token string\">\"int\"</span> <span class=\"token punctuation\">,</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        Local $RET <span class=\"token operator\">=</span> <span class=\"token function\">DllStructGetData</span> <span class=\"token punctuation\">(</span> $V <span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        $CODEBUFFER <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        $V <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        $K <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        Return $RET</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>EndFunc</pre></td></tr></table></figure><p>å¯ä»¥å‘ç°å‡½æ•°åŠ¨æ€åŠ è½½äº†ä¸€ä¸ª dll, ç„¶åä» dll è°ƒç”¨åŠ å¯†å‡½æ•°è¿›è¡ŒåŠ å¯†</p>\n<p>ä½¿ç”¨å¦‚ä¸‹è„šæœ¬å°† <code>OPCODE</code>  ä»¥å­—èŠ‚çš„å½¢å¼å†™å…¥æ–‡ä»¶ï¼Œæ–¹ä¾¿ä½¿ç”¨ IDA è¿›è¡Œåˆ†æ</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> binascii</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>opcode <span class=\"token operator\">=</span> <span class=\"token string\">\"83EC14B83400000099538B5C2420558B6C242056578B7C9DFCF7FB89C683C606C74424180000000085F68D76FF0F8EEA000000896C24288D4BFF8D549D00894C2410895424148974242081442418B979379E8B4C2418C1E90281E103000000894C241C31F6397424107E568B5424288BCF8B6CB204C1E9058D14AD0000000033CA8BD58BC7C1EA03C1E00433D003CA8B5424188BDE81E303000000335C241C8B4424308B1C9833D533DF03D333CA8B542428010CB28B0CB2463974241089CF7FAA8B5424288BCF8B2AC1E9058D14AD0000000033CA8BD58BC7C1EA03C1E00433D003CA8B5424188BDE81E303000000335C241C8B4424308B1C9833D533DF03D3FF4C242033CA8B542414014AFC8B4AFC8B54242089CF420F8F2DFFFFFF5F31C05E5D5B83C414C21000\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>hex_bytes <span class=\"token operator\">=</span> binascii<span class=\"token punctuation\">.</span>a2b_hex<span class=\"token punctuation\">(</span>opcode<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"enc.dll\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>hex_bytes<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p>ä¼ªä»£ç å¦‚ä¸‹ï¼Œå¯ä»¥å‘ç°åŠ å¯†ç®—æ³•ä¸º xxtea</p>\n<p><img data-src=\"/CBCTF-2023/image-20231024101111920.png\" alt=\"image-20231024101111920\" style=\"aspect-ratio:1920 / 1080;\"></p>\n<p>ç¼–å†™ exp å¾—åˆ° flag</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> binascii</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">from</span> ctypes <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">import</span> struct</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">MX</span><span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> total<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    temp1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">.</span>value <span class=\"token operator\">>></span> <span class=\"token number\">5</span> <span class=\"token operator\">^</span> y<span class=\"token punctuation\">.</span>value <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">.</span>value <span class=\"token operator\">>></span> <span class=\"token number\">3</span> <span class=\"token operator\">^</span> z<span class=\"token punctuation\">.</span>value <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    temp2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>total<span class=\"token punctuation\">.</span>value <span class=\"token operator\">^</span> y<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">&amp;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> e<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">]</span> <span class=\"token operator\">^</span> z<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">return</span> c_uint32<span class=\"token punctuation\">(</span>temp1 <span class=\"token operator\">^</span> temp2<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">def</span> <span class=\"token function\">decrypt</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    delta <span class=\"token operator\">=</span> <span class=\"token number\">0x61C88647</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    rounds <span class=\"token operator\">=</span> <span class=\"token number\">6</span> <span class=\"token operator\">+</span> <span class=\"token number\">52</span> <span class=\"token operator\">//</span> n</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    total <span class=\"token operator\">=</span> c_uint32<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span>rounds <span class=\"token operator\">*</span> delta<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    y <span class=\"token operator\">=</span> c_uint32<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    e <span class=\"token operator\">=</span> c_uint32<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">while</span> rounds <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        e<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>total<span class=\"token punctuation\">.</span>value <span class=\"token operator\">>></span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token keyword\">for</span> p <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            z <span class=\"token operator\">=</span> c_uint32<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">[</span>p <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            v<span class=\"token punctuation\">[</span>p<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> c_uint32<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">[</span>p<span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> MX<span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> total<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            y<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> v<span class=\"token punctuation\">[</span>p<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        z <span class=\"token operator\">=</span> c_uint32<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">[</span>n <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        v<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> c_uint32<span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> MX<span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> total<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        y<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> v<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        total<span class=\"token punctuation\">.</span>value <span class=\"token operator\">+=</span> delta</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        rounds <span class=\"token operator\">-=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">return</span> v</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    ct <span class=\"token operator\">=</span> <span class=\"token string\">\"7218181A02F79F4B5773E8FFE83FE732DF96259FF2B86AAB945468A132A83D83CF9D750E316C8675\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    ct <span class=\"token operator\">=</span> binascii<span class=\"token punctuation\">.</span>a2b_hex<span class=\"token punctuation\">(</span>ct<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    flag <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    key <span class=\"token operator\">=</span> <span class=\"token string\">\"Wowww111auUu3\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    v <span class=\"token operator\">=</span> struct<span class=\"token punctuation\">.</span>unpack<span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;10I'</span><span class=\"token punctuation\">,</span> ct<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    k <span class=\"token operator\">=</span> struct<span class=\"token punctuation\">.</span>unpack<span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;4I'</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">b'\\x00'</span> <span class=\"token operator\">*</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    v <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    k <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    n <span class=\"token operator\">=</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    res <span class=\"token operator\">=</span> decrypt<span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">,</span> v<span class=\"token punctuation\">,</span> k<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">for</span> r <span class=\"token keyword\">in</span> res<span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>to_bytes<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'little'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> end<span class=\"token operator\">=</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h1 id=\"vm_flutter\"><a class=\"anchor\" href=\"#vm_flutter\">#</a> vm_flutter</h1>\n<p>è™½ç„¶è¿™ä¸ª apk æ˜¯ä½¿ç”¨ flutter ç¼–å†™çš„ï¼Œä½†æ˜¯å…¶å®åœ¨æœ¬é¢˜ä¸­ flutter ä»…ä»…æ˜¯çº¸è€è™èˆ¬çš„å­˜åœ¨ã€‚</p>\n<p>åœ¨æœ¬é¢˜çš„é¢˜ç›®æè¿°ä¸­ç»™å‡ºäº†ä¸¤ä¸ªæç¤ºï¼Œç¬¬ä¸€æ˜¯å¯¹ flag çš„åŠ å¯†ç®—æ³•æœ‰ä¸”åªæœ‰ä¸€ä¸ª vmï¼Œç¬¬äºŒæ˜¯å…¨éƒ¨ vm ç›¸å…³çš„å‡½æ•°éƒ½å®šä¹‰åœ¨ Java å±‚ä¸­ï¼Œdart å±‚ä»…ä»…åªæ˜¯è°ƒç”¨ java å±‚ä¸­å®šä¹‰çš„å‡½æ•°ã€‚æ‰€ä»¥æ ¹æ®è¿™ä¸¤ä¸ªæç¤ºï¼Œå°±å¯ä»¥è”æƒ³åˆ°ä½¿ç”¨ frida ç­‰ hook æ¡†æ¶å» hook java å±‚ä¸­ vm ç›¸å…³çš„å‡½æ•°ï¼Œæ‰“å°å‡ºè™šæ‹ŸæŒ‡ä»¤æ¥è¿›è¡Œåˆ†æï¼Œå¦‚æœå¯ä»¥æƒ³åˆ°è¿™ä¸€ç‚¹ï¼Œé‚£ä¹ˆè¿™é¢˜å°±è¿åˆƒè€Œè§£äº†ã€‚å€˜è‹¥ä½¿ç”¨ reflutter ç­‰ flutter é€†å‘å·¥å…·ï¼Œé‚£ä¹ˆå°†ä¼šåœ¨ dart è™šæ‹Ÿæœºä¸­è¶Šé™·è¶Šæ·±ï¼š(</p>\n<p>åœ¨æœ¬é¢˜ä¸­ï¼Œopcode æ˜¯åœ¨ dart å±‚è¢«å®šä¹‰çš„ï¼Œä½†æ˜¯è¿™å…¶å®æ— å…³ç´§è¦ï¼Œå› ä¸º vm ç›¸å…³çš„å‡½æ•°æ˜¯åœ¨ java å±‚ä¸­å®šä¹‰çš„ï¼Œæˆ‘ä»¬å¯¹ vm å‡½æ•° hook çš„è¿‡ç¨‹å…¶å®å°±æ˜¯å¯¹ opcode çš„ â€œè§£è¯»â€ è¿‡ç¨‹ï¼Œé€šè¿‡ hook çš„æ“ä½œï¼Œæˆ‘ä»¬å°±å¯ä»¥å°† vm å¯¹å†…éƒ¨æ ˆæˆ–å†…å­˜çš„æ“ä½œæ˜ å°„ä¸ºå¯è¯»çš„ã€å¯ä»¥ç†è§£çš„è™šæ‹ŸæŒ‡ä»¤æ¥è¿›è¡Œåˆ†æã€‚</p>\n<p>æ‰€ä»¥è®¾è®¡æœ¬é¢˜ä¹Ÿæ˜¯åŸºäºè¿™ç§æ€æƒ³ï¼Œä½¿ç”¨ç›®å‰å®‰å“å±‚é¢é€†å‘éš¾åº¦éå¸¸é«˜çš„ flutter æ¡†æ¶ï¼Œæ¥æ¨¡æ‹Ÿç±»ä¼¼ vmprotect è¿™ç±»å¼ºå£³ opcode æœªçŸ¥çš„åœºæ™¯ï¼Œç”šè‡³åœ¨ vmprotect ä¸­ opcode ä¼šåœ¨é—´éš”ä¸å®šæ—¶é—´åéšæœºå˜æ¢ã€‚è™½ç„¶æˆ‘ä»¬ä¸çŸ¥é“ opcodeï¼Œä½†æ˜¯ä¸‡å˜ä¸ç¦»å…¶å®—ï¼Œvm è§£æ opcode ä¹‹åæœ€ç»ˆè¦æ‰§è¡Œçš„æ“ä½œæ˜¯ä¸ä¼šå˜çš„ã€‚</p>\n<p>è·å– flag çš„è¿‡ç¨‹å¦‚ä¸‹</p>\n<p>ä½¿ç”¨ jadx åç¼–è¯‘ï¼Œå‘ç°æ–¹æ³•åè¢«æ··æ·†ï¼Œä½†æ˜¯è¿›å…¥ <code>com.dasctf.vm_flutter.vm_flutter.MainActivity</code>  å¯ä»¥çœ‹åˆ° vm ç›¸å…³çš„å­—ç¬¦ä¸²</p>\n<p><img data-src=\"/CBCTF-2023/image-20231024101207340.png\" alt=\"image-20231024101207340\" style=\"aspect-ratio:747 / 958;\"></p>\n<p>é€šè¿‡ç»™ <code>c2</code>  èµ‹ä¸åŒçš„å€¼æ¥è°ƒç”¨ vm ä¸­çš„å‡½æ•°</p>\n<p><img data-src=\"/CBCTF-2023/image-20231024101214972.png\" alt=\"image-20231024101214972\" style=\"aspect-ratio:672 / 748;\"></p>\n<p>æ ¹æ®å­—ç¬¦ä¸²çš„æç¤ºï¼Œæˆ‘ä»¬ä¾¿çŸ¥é“äº†è¢«æ··æ·†çš„ vm çš„å‡½æ•°éƒ½æ˜¯ä»€ä¹ˆå«ä¹‰</p>\n<p><img data-src=\"/CBCTF-2023/image-20231024101220002.png\" alt=\"image-20231024101220002\" style=\"aspect-ratio:813 / 848;\"></p>\n<p>åŒæ—¶æˆ‘ä»¬è¿˜åœ¨è¿™é‡Œå‘ç°äº†æœ€ç»ˆçš„æ ¡éªŒå‡½æ•°ï¼Œå¯ä»¥æ¨æµ‹æœ€ç»ˆçš„ flag åº”è¯¥æœ‰ 33 ä½</p>\n<p><img data-src=\"/CBCTF-2023/image-20231024101225270.png\" alt=\"image-20231024101225270\" style=\"aspect-ratio:1707 / 277;\"></p>\n<p>ä½¿ç”¨ frida hook vm å‡½æ•°æ¥è·å– vm æŒ‡ä»¤</p>\n<figure class=\"highlight js\"><figcaption data-lang=\"JavaScript\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">function</span> <span class=\"token function\">hook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Java<span class=\"token punctuation\">.</span><span class=\"token function\">perform</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token keyword\">const</span> activity <span class=\"token operator\">=</span> Java<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"k.b\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        activity<span class=\"token punctuation\">.</span>a<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">implementation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Lshift\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        activity<span class=\"token punctuation\">.</span>b<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">implementation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Rshift\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        activity<span class=\"token punctuation\">.</span>c<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">implementation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"add\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        activity<span class=\"token punctuation\">.</span>d<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">implementation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"and\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        activity<span class=\"token punctuation\">.</span>e<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">implementation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"load \"</span><span class=\"token operator\">+</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        activity<span class=\"token punctuation\">.</span>f<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">implementation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mul\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        activity<span class=\"token punctuation\">.</span>g<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">implementation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"or\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        activity<span class=\"token punctuation\">.</span>h<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">implementation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pop\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        activity<span class=\"token punctuation\">.</span>i<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">implementation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"push \"</span><span class=\"token operator\">+</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        activity<span class=\"token punctuation\">.</span>j<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">implementation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"store \"</span><span class=\"token operator\">+</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        activity<span class=\"token punctuation\">.</span>k<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">implementation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sub\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        activity<span class=\"token punctuation\">.</span>l<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">implementation</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"xor\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span>hook<span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸‹åˆ—å‘½ä»¤æ³¨å…¥è„šæœ¬</p>\n<pre><code class=\"language-Shell\">frida -U -l .\\hook.js -f &quot;com.dasctf.vm_flutter.vm_flutter&quot;\n</code></pre>\n<p>æˆ‘ä»¬è¾“å…¥ 33 ä½çš„æ•°å­—ï¼Œä¾‹å¦‚ <code>000000000000000000000000000000000</code> ,frida æ‰“å°çš„å†…å®¹å¦‚ä¸‹</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>store <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>push <span class=\"token number\">176</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>push <span class=\"token number\">11</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>load <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>store <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>store <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>push <span class=\"token number\">198</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>push <span class=\"token number\">18</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>load <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>store <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>store <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>push <span class=\"token number\">66</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>push <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>load <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>store <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>store <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>push <span class=\"token number\">199</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>push <span class=\"token number\">18</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>load <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>store <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>store <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>push <span class=\"token number\">170</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>push <span class=\"token number\">14</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>load <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>store <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>store <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>push <span class=\"token number\">32</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>push <span class=\"token number\">13</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>load <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>store <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>store <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>push <span class=\"token number\">31</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>push <span class=\"token number\">14</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>load <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>store <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>store <span class=\"token number\">7</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>push <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>push <span class=\"token number\">18</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>load <span class=\"token number\">7</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>store <span class=\"token number\">7</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>store <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>push <span class=\"token number\">26</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>push <span class=\"token number\">13</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>load <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>store <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>store <span class=\"token number\">9</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>push <span class=\"token number\">89</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>push <span class=\"token number\">18</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>load <span class=\"token number\">9</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>store <span class=\"token number\">9</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>store <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>push <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>push <span class=\"token number\">17</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>load <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>store <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>store <span class=\"token number\">11</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>push <span class=\"token number\">119</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>push <span class=\"token number\">19</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>load <span class=\"token number\">11</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>store <span class=\"token number\">11</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>store <span class=\"token number\">12</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>push <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>push <span class=\"token number\">17</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>load <span class=\"token number\">12</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>store <span class=\"token number\">12</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>store <span class=\"token number\">13</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>push <span class=\"token number\">90</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>push <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>load <span class=\"token number\">13</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>store <span class=\"token number\">13</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>store <span class=\"token number\">14</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>push <span class=\"token number\">104</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>push <span class=\"token number\">13</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>load <span class=\"token number\">14</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>store <span class=\"token number\">14</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>store <span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>push <span class=\"token number\">174</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>push <span class=\"token number\">19</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>load <span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>store <span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>store <span class=\"token number\">16</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>push <span class=\"token number\">146</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>push <span class=\"token number\">11</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>load <span class=\"token number\">16</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>store <span class=\"token number\">16</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>store <span class=\"token number\">17</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>push <span class=\"token number\">179</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>push <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>load <span class=\"token number\">17</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"143\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>store <span class=\"token number\">17</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>store <span class=\"token number\">18</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>push <span class=\"token number\">67</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>push <span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>load <span class=\"token number\">18</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>store <span class=\"token number\">18</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>store <span class=\"token number\">19</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>push <span class=\"token number\">73</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>push <span class=\"token number\">11</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>load <span class=\"token number\">19</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"160\"></td><td><pre>store <span class=\"token number\">19</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>store <span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>push <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>push <span class=\"token number\">12</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>load <span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"167\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"168\"></td><td><pre>store <span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>store <span class=\"token number\">21</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>push <span class=\"token number\">92</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>push <span class=\"token number\">19</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>load <span class=\"token number\">21</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"175\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"176\"></td><td><pre>store <span class=\"token number\">21</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>store <span class=\"token number\">22</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>push <span class=\"token number\">170</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>push <span class=\"token number\">19</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>load <span class=\"token number\">22</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"183\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"184\"></td><td><pre>store <span class=\"token number\">22</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>store <span class=\"token number\">23</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>push <span class=\"token number\">160</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>push <span class=\"token number\">9</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>load <span class=\"token number\">23</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"191\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"192\"></td><td><pre>store <span class=\"token number\">23</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>store <span class=\"token number\">24</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>push <span class=\"token number\">166</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>push <span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>load <span class=\"token number\">24</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"199\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"200\"></td><td><pre>store <span class=\"token number\">24</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>store <span class=\"token number\">25</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>push <span class=\"token number\">47</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>push <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>load <span class=\"token number\">25</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"207\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"208\"></td><td><pre>store <span class=\"token number\">25</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>store <span class=\"token number\">26</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>push <span class=\"token number\">155</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>push <span class=\"token number\">19</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>load <span class=\"token number\">26</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"215\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"216\"></td><td><pre>store <span class=\"token number\">26</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>store <span class=\"token number\">27</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>push <span class=\"token number\">115</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>push <span class=\"token number\">9</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>load <span class=\"token number\">27</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"223\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"224\"></td><td><pre>store <span class=\"token number\">27</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>store <span class=\"token number\">28</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>push <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>push <span class=\"token number\">13</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>load <span class=\"token number\">28</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"231\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"232\"></td><td><pre>store <span class=\"token number\">28</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>store <span class=\"token number\">29</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>push <span class=\"token number\">52</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>push <span class=\"token number\">12</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>load <span class=\"token number\">29</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"239\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"240\"></td><td><pre>store <span class=\"token number\">29</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>store <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>push <span class=\"token number\">42</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>push <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>load <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"247\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"248\"></td><td><pre>store <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>store <span class=\"token number\">31</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>push <span class=\"token number\">96</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>push <span class=\"token number\">19</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>load <span class=\"token number\">31</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"255\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"256\"></td><td><pre>store <span class=\"token number\">31</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>store <span class=\"token number\">32</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>push <span class=\"token number\">72</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>push <span class=\"token number\">7</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>load <span class=\"token number\">32</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"263\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"264\"></td><td><pre>store <span class=\"token number\">32</span></pre></td></tr></table></figure><p>åˆ†æä¸€ä¸‹ vm æŒ‡ä»¤ï¼Œè¿™é‡Œæœ‰ä¸ªç›¸åŒçš„ç»“æ„ï¼Œç»è¿‡åˆ†æåå¯ä»¥å‘ç°è¿™æ˜¯æ ‡å‡†çš„æ ˆå¼è™šæ‹Ÿæœºï¼Œå…ˆå°†æ“ä½œæ•°å‹å…¥æ ˆä¸­ï¼Œç„¶åè¿›è¡Œè¿ç®—æ—¶ä»æ ˆé¡¶å–å›ï¼Œæ‰€ä»¥æ­¤å¤„çš„ vm åŠ å¯†æ˜¯å¯¹è¾“å…¥åŠ ä¸Šä¸€ä¸ªæ•°ï¼Œå†å»å¼‚æˆ–ä¸€ä¸ªæ•°</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>push <span class=\"token number\">48</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>store <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>push <span class=\"token number\">176</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>push <span class=\"token number\">11</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>load <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>store <span class=\"token number\">0</span></pre></td></tr></table></figure><p>ç¼–å†™ exp å¾—åˆ° flag</p>\n<figure class=\"highlight python\"><figcaption data-lang=\"python\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">import</span> re</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>output <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">'''push 48</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>store 0</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>push 176</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>push 11</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>load 0</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>store 0</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>store 1</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>push 198</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>push 18</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>load 1</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>store 1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>store 2</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>push 66</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>push 5</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>load 2</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>store 2</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>store 3</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>push 199</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>push 18</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>load 3</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>store 3</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>store 4</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>push 170</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>push 14</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>load 4</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>store 4</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>store 5</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>push 32</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>push 13</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>load 5</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>store 5</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>store 6</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>push 31</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>push 14</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>load 6</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>store 6</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>store 7</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>push 60</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>push 18</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>load 7</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>store 7</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>store 8</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>push 26</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>push 13</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>load 8</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>store 8</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>store 9</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>push 89</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>push 18</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>load 9</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>store 9</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>store 10</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>push 60</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>push 17</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>load 10</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>store 10</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>store 11</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>push 119</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>push 19</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>load 11</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>store 11</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>store 12</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>push 60</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>push 17</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>load 12</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>store 12</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>store 13</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>push 90</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>push 5</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>load 13</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>store 13</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>store 14</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>push 104</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>push 13</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>load 14</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>store 14</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>store 15</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>push 174</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>push 19</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>load 15</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>store 15</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>store 16</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>push 146</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>push 11</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>load 16</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>store 16</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"140\"></td><td><pre>store 17</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>push 179</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>push 5</pre></td></tr><tr><td data-num=\"143\"></td><td><pre>load 17</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"145\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>store 17</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>store 18</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>push 67</pre></td></tr><tr><td data-num=\"150\"></td><td><pre>push 15</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>load 18</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"153\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"154\"></td><td><pre>store 18</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>store 19</pre></td></tr><tr><td data-num=\"157\"></td><td><pre>push 73</pre></td></tr><tr><td data-num=\"158\"></td><td><pre>push 11</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>load 19</pre></td></tr><tr><td data-num=\"160\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"161\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>store 19</pre></td></tr><tr><td data-num=\"163\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"164\"></td><td><pre>store 20</pre></td></tr><tr><td data-num=\"165\"></td><td><pre>push 50</pre></td></tr><tr><td data-num=\"166\"></td><td><pre>push 12</pre></td></tr><tr><td data-num=\"167\"></td><td><pre>load 20</pre></td></tr><tr><td data-num=\"168\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"169\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"170\"></td><td><pre>store 20</pre></td></tr><tr><td data-num=\"171\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"172\"></td><td><pre>store 21</pre></td></tr><tr><td data-num=\"173\"></td><td><pre>push 92</pre></td></tr><tr><td data-num=\"174\"></td><td><pre>push 19</pre></td></tr><tr><td data-num=\"175\"></td><td><pre>load 21</pre></td></tr><tr><td data-num=\"176\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"177\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"178\"></td><td><pre>store 21</pre></td></tr><tr><td data-num=\"179\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"180\"></td><td><pre>store 22</pre></td></tr><tr><td data-num=\"181\"></td><td><pre>push 170</pre></td></tr><tr><td data-num=\"182\"></td><td><pre>push 19</pre></td></tr><tr><td data-num=\"183\"></td><td><pre>load 22</pre></td></tr><tr><td data-num=\"184\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"185\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"186\"></td><td><pre>store 22</pre></td></tr><tr><td data-num=\"187\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"188\"></td><td><pre>store 23</pre></td></tr><tr><td data-num=\"189\"></td><td><pre>push 160</pre></td></tr><tr><td data-num=\"190\"></td><td><pre>push 9</pre></td></tr><tr><td data-num=\"191\"></td><td><pre>load 23</pre></td></tr><tr><td data-num=\"192\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"193\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"194\"></td><td><pre>store 23</pre></td></tr><tr><td data-num=\"195\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"196\"></td><td><pre>store 24</pre></td></tr><tr><td data-num=\"197\"></td><td><pre>push 166</pre></td></tr><tr><td data-num=\"198\"></td><td><pre>push 15</pre></td></tr><tr><td data-num=\"199\"></td><td><pre>load 24</pre></td></tr><tr><td data-num=\"200\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"201\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"202\"></td><td><pre>store 24</pre></td></tr><tr><td data-num=\"203\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"204\"></td><td><pre>store 25</pre></td></tr><tr><td data-num=\"205\"></td><td><pre>push 47</pre></td></tr><tr><td data-num=\"206\"></td><td><pre>push 8</pre></td></tr><tr><td data-num=\"207\"></td><td><pre>load 25</pre></td></tr><tr><td data-num=\"208\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"209\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"210\"></td><td><pre>store 25</pre></td></tr><tr><td data-num=\"211\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"212\"></td><td><pre>store 26</pre></td></tr><tr><td data-num=\"213\"></td><td><pre>push 155</pre></td></tr><tr><td data-num=\"214\"></td><td><pre>push 19</pre></td></tr><tr><td data-num=\"215\"></td><td><pre>load 26</pre></td></tr><tr><td data-num=\"216\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"217\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"218\"></td><td><pre>store 26</pre></td></tr><tr><td data-num=\"219\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"220\"></td><td><pre>store 27</pre></td></tr><tr><td data-num=\"221\"></td><td><pre>push 115</pre></td></tr><tr><td data-num=\"222\"></td><td><pre>push 9</pre></td></tr><tr><td data-num=\"223\"></td><td><pre>load 27</pre></td></tr><tr><td data-num=\"224\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"225\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"226\"></td><td><pre>store 27</pre></td></tr><tr><td data-num=\"227\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"228\"></td><td><pre>store 28</pre></td></tr><tr><td data-num=\"229\"></td><td><pre>push 60</pre></td></tr><tr><td data-num=\"230\"></td><td><pre>push 13</pre></td></tr><tr><td data-num=\"231\"></td><td><pre>load 28</pre></td></tr><tr><td data-num=\"232\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"233\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"234\"></td><td><pre>store 28</pre></td></tr><tr><td data-num=\"235\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"236\"></td><td><pre>store 29</pre></td></tr><tr><td data-num=\"237\"></td><td><pre>push 52</pre></td></tr><tr><td data-num=\"238\"></td><td><pre>push 12</pre></td></tr><tr><td data-num=\"239\"></td><td><pre>load 29</pre></td></tr><tr><td data-num=\"240\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"241\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"242\"></td><td><pre>store 29</pre></td></tr><tr><td data-num=\"243\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"244\"></td><td><pre>store 30</pre></td></tr><tr><td data-num=\"245\"></td><td><pre>push 42</pre></td></tr><tr><td data-num=\"246\"></td><td><pre>push 5</pre></td></tr><tr><td data-num=\"247\"></td><td><pre>load 30</pre></td></tr><tr><td data-num=\"248\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"249\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"250\"></td><td><pre>store 30</pre></td></tr><tr><td data-num=\"251\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"252\"></td><td><pre>store 31</pre></td></tr><tr><td data-num=\"253\"></td><td><pre>push 96</pre></td></tr><tr><td data-num=\"254\"></td><td><pre>push 19</pre></td></tr><tr><td data-num=\"255\"></td><td><pre>load 31</pre></td></tr><tr><td data-num=\"256\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"257\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"258\"></td><td><pre>store 31</pre></td></tr><tr><td data-num=\"259\"></td><td><pre>push 48</pre></td></tr><tr><td data-num=\"260\"></td><td><pre>store 32</pre></td></tr><tr><td data-num=\"261\"></td><td><pre>push 72</pre></td></tr><tr><td data-num=\"262\"></td><td><pre>push 7</pre></td></tr><tr><td data-num=\"263\"></td><td><pre>load 32</pre></td></tr><tr><td data-num=\"264\"></td><td><pre>add</pre></td></tr><tr><td data-num=\"265\"></td><td><pre>xor</pre></td></tr><tr><td data-num=\"266\"></td><td><pre>store 32'''</pre></td></tr><tr><td data-num=\"267\"></td><td><pre>pattern <span class=\"token operator\">=</span> <span class=\"token string\">r'push\\s+(\\d+)'</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>final <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">255</span><span class=\"token punctuation\">,</span> <span class=\"token number\">149</span><span class=\"token punctuation\">,</span> <span class=\"token number\">26</span><span class=\"token punctuation\">,</span> <span class=\"token number\">146</span><span class=\"token punctuation\">,</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token number\">115</span><span class=\"token punctuation\">,</span> <span class=\"token number\">150</span><span class=\"token punctuation\">,</span> <span class=\"token number\">68</span><span class=\"token punctuation\">,</span> <span class=\"token number\">36</span><span class=\"token punctuation\">,</span> <span class=\"token number\">222</span><span class=\"token punctuation\">,</span> <span class=\"token number\">185</span><span class=\"token punctuation\">,</span> <span class=\"token number\">240</span><span class=\"token punctuation\">,</span> <span class=\"token number\">74</span><span class=\"token punctuation\">,</span> <span class=\"token number\">45</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">234</span><span class=\"token punctuation\">,</span> <span class=\"token number\">236</span><span class=\"token punctuation\">,</span> <span class=\"token number\">215</span><span class=\"token punctuation\">,</span> <span class=\"token number\">62</span><span class=\"token punctuation\">,</span> <span class=\"token number\">114</span><span class=\"token punctuation\">,</span> <span class=\"token number\">178</span><span class=\"token punctuation\">,</span> <span class=\"token number\">46</span><span class=\"token punctuation\">,</span> <span class=\"token number\">205</span><span class=\"token punctuation\">,</span> <span class=\"token number\">209</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>         <span class=\"token number\">214</span><span class=\"token punctuation\">,</span> <span class=\"token number\">83</span><span class=\"token punctuation\">,</span> <span class=\"token number\">233</span><span class=\"token punctuation\">,</span> <span class=\"token number\">34</span><span class=\"token punctuation\">,</span> <span class=\"token number\">82</span><span class=\"token punctuation\">,</span> <span class=\"token number\">74</span><span class=\"token punctuation\">,</span> <span class=\"token number\">67</span><span class=\"token punctuation\">,</span> <span class=\"token number\">36</span><span class=\"token punctuation\">,</span> <span class=\"token number\">204</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>matches <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span>findall<span class=\"token punctuation\">(</span>pattern<span class=\"token punctuation\">,</span> output<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre><span class=\"token comment\">#print(matches)</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>final<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">chr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>final<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>matches<span class=\"token punctuation\">[</span>i <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>matches<span class=\"token punctuation\">[</span>i <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> end<span class=\"token operator\">=</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure>",
            "tags": []
        },
        {
            "id": "https://oacia.dev/lowmemorykiller/",
            "url": "https://oacia.dev/lowmemorykiller/",
            "title": "lowmemorykilleråŸç†åˆ†æ",
            "date_published": "2023-10-10T07:40:53.000Z",
            "content_html": "<h1 id=\"lowmemorykilleræ¦‚è¿°\"><a class=\"anchor\" href=\"#lowmemorykilleræ¦‚è¿°\">#</a> lowmemorykiller æ¦‚è¿°</h1>\n<p>Android çš„è®¾è®¡ç†å¿µä¹‹ä¸€ï¼Œä¾¿æ˜¯åº”ç”¨ç¨‹åºé€€å‡ºï¼Œä½†è¿›ç¨‹è¿˜ä¼šç»§ç»­å­˜åœ¨ç³»ç»Ÿä»¥ä¾¿å†æ¬¡å¯åŠ¨æ—¶æé«˜å“åº”æ—¶é—´ã€‚è¿™æ ·çš„è®¾è®¡ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å†…å­˜åœ°å€ç©ºé—´ï¼Œéšç€åº”ç”¨æ‰“å¼€æ•°é‡çš„å¢å¤šï¼Œç³»ç»Ÿå·²ä½¿ç”¨çš„å†…å­˜è¶Šæ¥è¶Šå¤§ï¼Œå°±å¾ˆæœ‰å¯èƒ½å¯¼è‡´ç³»ç»Ÿå†…å­˜ä¸è¶³ï¼Œé‚£ä¹ˆéœ€è¦ä¸€ä¸ªèƒ½ç®¡ç†æ‰€æœ‰è¿›ç¨‹ï¼Œæ ¹æ®ä¸€å®šç­–ç•¥æ¥é‡Šæ”¾è¿›ç¨‹çš„ç­–ç•¥ï¼Œè¿™ä¾¿æœ‰äº† <code>lmk</code> ï¼Œå…¨ç§°ä¸º LowMemoryKiller (ä½å†…å­˜æ€æ‰‹)ï¼Œå®ƒä½¿ç”¨ <code>lmkd</code>  æ¥å†³å®šä»€ä¹ˆæ—¶æœºæ€æ‰ä»€ä¹ˆè¿›ç¨‹.</p>\n<p>Android åŸºäº Linux çš„ç³»ç»Ÿï¼Œå…¶å® Linux æœ‰ç±»ä¼¼çš„å†…å­˜ç®¡ç†ç­–ç•¥ â€”â€”OOM killer (Out Of Memory Killer), OOM çš„ç­–ç•¥æ›´å¤šçš„æ˜¯ç”¨äºåˆ†é…å†…å­˜ä¸è¶³æ—¶è§¦å‘ï¼Œå°†å¾—åˆ†æœ€é«˜çš„è¿›ç¨‹æ€æ‰ã€‚è€Œ <code>LowMemoryKiller</code>  åˆ™ä¼šæ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥ä¸€æ¬¡ï¼Œå½“ç³»ç»Ÿå‰©ä½™å¯ç”¨å†…å­˜è¾ƒä½æ—¶ï¼Œä¾¿ä¼šè§¦å‘æ€è¿›ç¨‹çš„ç­–ç•¥ï¼Œæ ¹æ®ä¸åŒçš„å‰©ä½™å†…å­˜æ¡£ä½æ¥æ¥é€‰æ‹©æ€ä¸åŒä¼˜å…ˆçº§çš„è¿›ç¨‹ï¼Œè€Œä¸æ˜¯ç­‰åˆ° OOM æ—¶å†æ¥æ€è¿›ç¨‹ï¼ŒçœŸæ­£ OOM æ—¶ç³»ç»Ÿå¯èƒ½å·²ç»å¤„äºå¼‚å¸¸çŠ¶æ€ï¼Œç³»ç»Ÿæ›´å¸Œæœ›çš„æ˜¯æœªé›¨ç»¸ç¼ªï¼Œåœ¨å†…å­˜å¾ˆä½æ—¶æ¥æ€æ‰ä¸€äº›ä¼˜å…ˆçº§è¾ƒä½çš„è¿›ç¨‹æ¥ä¿éšœåç»­æ“ä½œçš„é¡ºåˆ©è¿›è¡Œã€‚</p>\n<p>ä¸ <code>lowmemorykiller</code>  ç›¸å…³çš„æºç è·¯å¾„</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>msm-google<span class=\"token punctuation\">\\</span>drivers<span class=\"token punctuation\">\\</span>staging<span class=\"token punctuation\">\\</span>android<span class=\"token punctuation\">\\</span>lowmemorykiller.c</pre></td></tr></table></figure><h1 id=\"lowmemorykilleråŸºæœ¬åŸç†\"><a class=\"anchor\" href=\"#lowmemorykilleråŸºæœ¬åŸç†\">#</a> lowmemorykiller åŸºæœ¬åŸç†</h1>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* drivers/misc/lowmemorykiller.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * The lowmemorykiller driver lets user-space specify (æŒ‡å®š) a set of memory thresholds (é˜ˆå€¼)</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * where processes with a range of oom_score_adj values will get killed. Specify</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * the minimum oom_score_adj values in</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * /sys/module/lowmemorykiller/parameters/adj and the number of free pages in</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * /sys/module/lowmemorykiller/parameters/minfree. Both files take a comma</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * separated list of numbers in ascending order (æŒ‰å‡åºåºåˆ—).</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * For example, write \"0,8\" to /sys/module/lowmemorykiller/parameters/adj and</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> * \"1024,4096\" to /sys/module/lowmemorykiller/parameters/minfree to kill</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> * processes with a oom_score_adj value of 8 or higher when the free memory</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> * drops below 4096 pages and kill processes with a oom_score_adj value of 0 or</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> * higher when the free memory drops below 1024 pages.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"16\"></td><td><pre> * The driver considers memory used for caches to be free, but if a large</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> * percentage of the cached memory is locked this can be very inaccurate (ä¸å‡†ç¡®)</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * and processes may not get killed until the normal oom killer is triggered.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> */</pre></td></tr></table></figure><p>æ‰€æœ‰åº”ç”¨è¿›ç¨‹éƒ½æ˜¯ä» zygote å­µåŒ–å‡ºæ¥çš„ï¼Œè®°å½•åœ¨ AMS ä¸­ mLruProcesses åˆ—è¡¨ä¸­ï¼Œç”± AMS è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼ŒAMS ä¸­ä¼šæ ¹æ®è¿›ç¨‹çš„çŠ¶æ€æ›´æ–°è¿›ç¨‹å¯¹åº”çš„ oom_adj å€¼ï¼Œè¿™ä¸ªå€¼ä¼šé€šè¿‡æ–‡ä»¶ä¼ é€’åˆ° kernel ä¸­å»ï¼Œkernel æœ‰ä¸ªä½å†…å­˜å›æ”¶æœºåˆ¶ï¼Œåœ¨å†…å­˜è¾¾åˆ°ä¸€å®šé˜€å€¼æ—¶ä¼šè§¦å‘æ¸…ç† oom_adj å€¼é«˜çš„è¿›ç¨‹è…¾å‡ºæ›´å¤šçš„å†…å­˜ç©ºé—´ï¼Œè¿™å°±æ˜¯ Lowmemorykiller å·¥ä½œåŸç†ã€‚</p>\n<p>è¿™ä¸€å¼ å›¾å¾ˆå¥½çš„è¡¨ç¤ºäº† lmk çš„åŸç†</p>\n<p><img data-src=\"/lowmemorykiller/1836169-15d36c6cfee0a381.webp\" alt=\"img\" style=\"aspect-ratio:844 / 622;\"></p>\n<p>ä½†å¯¹äºæˆ‘çš„ pixel3, å†…æ ¸ç‰ˆæœ¬ <code>Linux4.9</code>  æ¥è¯´æ²¡æœ‰ <code>lowmemorykiller</code>  è¿™ä¸ªæ¨¡å—</p>\n<p><img data-src=\"/lowmemorykiller/image-20231011090236210.png\" alt=\"image-20231011090236210\" style=\"aspect-ratio:783 / 52;\"></p>\n<p>å¾€ä¸‹ç¿»äº†ç¿»æºç ï¼Œæ‰å‘ç°åŸæ¥ <code>lowmemorykiller</code>  å·²ç»ä¸æ˜¯ä¸€ä¸ªæ¨¡å—äº†</p>\n<p><img data-src=\"/lowmemorykiller/image-20231011090349845.png\" alt=\"image-20231011090349845\" style=\"aspect-ratio:1920 / 1079;\"></p>\n<p>(å­˜ç–‘)<span class=\"spoiler\" title=\"å””~è¢«çœ‹åˆ°äº†å‘¢\"> å¹¶ä¸”è¿™äº›é˜ˆå€¼è¢«ç¡¬ç¼–ç åœ¨æºç ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´æ— æ³•é€šè¿‡ä¿®æ”¹ /sys/module/lowmemorykiller/parameters/adj å’Œ /sys/module/lowmemorykiller/parameters/minfree æ¥æ”¹å˜ lowmemorykiller çš„æ€è¿›ç¨‹ç­–ç•¥</span></p>\n<p><img data-src=\"/lowmemorykiller/image-20231011090514060.png\" alt=\"image-20231011090514060\" style=\"aspect-ratio:604 / 606;\"></p>\n<p>è§£é‡Šä¸€ä¸‹è¿™é‡Œå„ä¸ªå€¼çš„å«ä¹‰ï¼šå½“å†…å­˜ä½äº 64MB æ—¶ï¼Œç³»ç»Ÿä¼šæ€æ­» <code>adj&gt;=12</code>  çº§åˆ«çš„è¿›ç¨‹ï¼›å½“å†…å­˜ä½äº 16MB æ—¶ï¼Œç³»ç»Ÿä¼šæ€æ­» <code>adj&gt;=6</code>  çº§åˆ«çš„è¿›ç¨‹â€¦ ä»¥æ­¤ç±»æ¨</p>\n<p>å¯¹äºåº”ç”¨è¿›ç¨‹æ¥è¯´ï¼Œéœ€è¦æœ‰è‡ªèº«çš„ adjï¼Œç”± AMS è´Ÿè´£æ›´æ–°ã€‚å®šä¹‰åœ¨ oom_adj å’Œ oom_score_adj æ–‡ä»¶ä¸­ï¼š</p>\n<ul>\n<li><code>/proc/pid/oom_adj</code> ï¼šä»£è¡¨å½“å‰è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œè¿™ä¸ªä¼˜å…ˆçº§æ˜¯ kernel ä¸­çš„ä¼˜å…ˆçº§ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</li>\n<li><code>/proc/pid/oom_score_adj</code> ï¼šè¿™ä¸ªæ˜¯ AMS ä¸Šå±‚çš„ä¼˜å…ˆçº§ï¼Œä¸ ProcessList ä¸­çš„ä¼˜å…ˆçº§å¯¹åº”ï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</li>\n</ul>\n<p>å‰å°è¿›ç¨‹çš„ <code>oom_adj</code>  ä¸º 0, <code>oom_score_adj</code>  ä¹Ÿä¸º 0, è¡¨ç¤ºä¸å¯è¢«æ€æ­»</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>blueline:/ <span class=\"token comment\"># ps -A | grep ez</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>u0_a243      <span class=\"token number\">16722</span>   <span class=\"token number\">994</span> <span class=\"token number\">14961560</span> <span class=\"token number\">221328</span> SyS_epoll_wait     <span class=\"token number\">0</span> S com.example.ezandroid</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>blueline:/ <span class=\"token comment\"># cat /proc/16722/oom_adj</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>blueline:/ <span class=\"token comment\"># cat /proc/16722/oom_score_adj</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">0</span></pre></td></tr></table></figure><p><code>oom_adj</code>  å’Œ <code>oom_score_adj</code>  çš„è½¬æ¢å…³ç³»ä¸º</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//msm-google\\drivers\\staging\\android\\lowmemorykiller.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * /proc/&lt;pid>/oom_score_adj set to OOM_SCORE_ADJ_MIN disables oom killing for</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * pid.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> */</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">OOM_SCORE_ADJ_MIN</span>\t<span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">OOM_SCORE_ADJ_MAX</span>\t<span class=\"token expression\"><span class=\"token number\">1000</span></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * /proc/&lt;pid>/oom_adj set to -17 protects from the oom killer for legacy</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> * purposes.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> */</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">OOM_DISABLE</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">17</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">/* inclusive */</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">OOM_ADJUST_MIN</span> <span class=\"token expression\"><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">OOM_ADJUST_MAX</span> <span class=\"token expression\"><span class=\"token number\">15</span></span></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">short</span> <span class=\"token function\">lowmem_oom_adj_to_oom_score_adj</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">short</span> oom_adj<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oom_adj <span class=\"token operator\">==</span> OOM_ADJUST_MAX<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> OOM_SCORE_ADJ_MAX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>oom_adj <span class=\"token operator\">*</span> OOM_SCORE_ADJ_MAX<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token operator\">-</span>OOM_DISABLE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"lowmemorykilleræœºåˆ¶å‰–æ\"><a class=\"anchor\" href=\"#lowmemorykilleræœºåˆ¶å‰–æ\">#</a> LowmemoryKiller æœºåˆ¶å‰–æ</h1>\n<p>æ€»çš„æ¥è¯´ï¼Œ<strong>Framework å±‚é€šè¿‡è°ƒæ•´ adj çš„å€¼å’Œé˜ˆå€¼æ•°ç»„ï¼Œè¾“é€ç»™ kernel ä¸­çš„ lmkï¼Œä¸º lmk æä¾›æ€è¿›ç¨‹çš„ä¾æ®</strong>ï¼Œå› ä¸ºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ç›¸äº’éš”ç¦»ï¼Œå°±é‡‡ç”¨äº†æ–‡ä»¶èŠ‚ç‚¹è¿›è¡Œé€šè®¯ï¼Œç”¨ <code>socket</code>  å°† adj çš„å€¼ä¸é˜ˆå€¼æ•°ç»„ä¼ ç»™ lmkd (5.0 ä¹‹åä¸åœ¨ç”± AMS ç›´æ¥ä¸ lmk é€šä¿¡ï¼Œå¼•å…¥ lmkd å®ˆæŠ¤è¿›ç¨‹)ï¼Œlmkd å°†è¿™äº›å€¼å†™åˆ°å†…æ ¸èŠ‚ç‚¹ä¸­ã€‚lmk é€šè¿‡è¯»å–è¿™äº›èŠ‚ç‚¹ï¼Œå®ç°è¿›ç¨‹çš„ killï¼Œæ‰€ä»¥æ•´ä¸ª lmk æœºåˆ¶å¤§æ¦‚å¯åˆ†æˆä¸‰å±‚ã€‚</p>\n<p><img data-src=\"/lowmemorykiller/1836169-1c2fcdb2bd0a6664.webp\" alt=\"img\" style=\"aspect-ratio:975 / 474;\"></p>\n<h1 id=\"shrinkeræœºåˆ¶ç®€ä»‹\"><a class=\"anchor\" href=\"#shrinkeræœºåˆ¶ç®€ä»‹\">#</a> shrinker æœºåˆ¶ç®€ä»‹</h1>\n<p>LMK é©±åŠ¨é€šè¿‡æ³¨å†Œ shrinker æ¥å®ç°çš„ï¼Œshrinker æ˜¯ linux kernel æ ‡å‡†çš„å›æ”¶å†…å­˜ page çš„æœºåˆ¶ï¼Œç”±å†…æ ¸çº¿ç¨‹ kswapd è´Ÿè´£ç›‘æ§ã€‚</p>\n<p>å½“å†…å­˜ä¸è¶³æ—¶ kswapd çº¿ç¨‹ä¼šéå†ä¸€å¼  shrinker é“¾è¡¨ï¼Œå¹¶å›è°ƒå·²æ³¨å†Œçš„ shrinker å‡½æ•°æ¥å›æ”¶å†…å­˜ pageï¼Œkswapd è¿˜ä¼šå‘¨æœŸæ€§å”¤é†’æ¥æ‰§è¡Œå†…å­˜æ“ä½œã€‚æ¯ä¸ª zone ç»´æŠ¤ active_list å’Œ inactive_list é“¾è¡¨ï¼Œå†…æ ¸æ ¹æ®é¡µé¢æ´»åŠ¨çŠ¶æ€å°† page åœ¨è¿™ä¸¤ä¸ªé“¾è¡¨ä¹‹é—´ç§»åŠ¨ï¼Œæœ€ç»ˆé€šè¿‡ shrink_slab å’Œ shrink_zone æ¥å›æ”¶å†…å­˜é¡µ</p>\n<h1 id=\"lowmemorykilleråˆå§‹åŒ–\"><a class=\"anchor\" href=\"#lowmemorykilleråˆå§‹åŒ–\">#</a> lowmemorykiller åˆå§‹åŒ–</h1>\n<p><strong>æ³¨å†Œ shrinker</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//msm-google\\drivers\\staging\\android\\lowmemorykiller.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">shrinker</span> lowmem_shrinker <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token punctuation\">.</span>scan_objects <span class=\"token operator\">=</span> lowmem_scan<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token punctuation\">.</span>count_objects <span class=\"token operator\">=</span> lowmem_count<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">.</span>seeks <span class=\"token operator\">=</span> DEFAULT_SEEKS <span class=\"token operator\">*</span> <span class=\"token number\">16</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> __init <span class=\"token function\">lowmem_init</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token function\">register_shrinker</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>lowmem_shrinker<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token function\">lmk_event_init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>å…¶ä¸­ shrinker ç»“æ„ä½“çš„å‚æ•°å¦‚ä¸‹ï¼Œå½“ count_objects è¿”å›é 0 å€¼æ—¶ä¼šè§¦å‘ scan_objects å›è°ƒå‡½æ•°</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//msm-google\\include\\linux\\shrinker.h</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/*</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * A callback you can register to apply pressure to ageable caches.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @count_objects should return the number of freeable items in the cache. If</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * there are no objects to free or the number of freeable items cannot be</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> * determined, it should return 0. No deadlock checks should be done during the</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> * count callback - the shrinker relies on aggregating scan counts that couldn't</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> * be executed due to potential deadlocks to be run at a later call when the</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> * deadlock condition is no longer pending.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> * @scan_objects will only be called if @count_objects returned a non-zero</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> * value for the number of freeable objects. The callout should scan the cache</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> * and attempt to free items from the cache. It should then return the number</pre></td></tr><tr><td data-num=\"15\"></td><td><pre> * of objects freed during the scan, or SHRINK_STOP if progress cannot be made</pre></td></tr><tr><td data-num=\"16\"></td><td><pre> * due to potential deadlocks. If SHRINK_STOP is returned, then no further</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> * attempts to call the @scan_objects will be made from the current reclaim</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> * context.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> * @flags determine the shrinker abilities, like numa awareness</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> */</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">struct</span> <span class=\"token class-name\">shrinker</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>count_objects<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">shrinker</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t\t       <span class=\"token keyword\">struct</span> <span class=\"token class-name\">shrink_control</span> <span class=\"token operator\">*</span>sc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>scan_objects<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">shrinker</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\t\t      <span class=\"token keyword\">struct</span> <span class=\"token class-name\">shrink_control</span> <span class=\"token operator\">*</span>sc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token keyword\">int</span> seeks<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* seeks to recreate an obj */</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token keyword\">long</span> batch<span class=\"token punctuation\">;</span>\t<span class=\"token comment\">/* reclaim batch size, 0 = default */</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> flags<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token comment\">/* These are for internal use */</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">list_head</span> list<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token comment\">/* objs pending delete, per node */</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token class-name\">atomic_long_t</span> <span class=\"token operator\">*</span>nr_deferred<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"lowmem_count\"><a class=\"anchor\" href=\"#lowmem_count\">#</a> lowmem_count</h1>\n<p><strong>ç»Ÿè®¡ç¼“å­˜</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//msm-google\\drivers\\staging\\android\\lowmemorykiller.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> <span class=\"token function\">lowmem_count</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">shrinker</span> <span class=\"token operator\">*</span>s<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\t\t\t  <span class=\"token keyword\">struct</span> <span class=\"token class-name\">shrink_control</span> <span class=\"token operator\">*</span>sc<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token function\">global_node_page_state</span><span class=\"token punctuation\">(</span>NR_ACTIVE_ANON<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token function\">global_node_page_state</span><span class=\"token punctuation\">(</span>NR_ACTIVE_FILE<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token function\">global_node_page_state</span><span class=\"token punctuation\">(</span>NR_INACTIVE_ANON<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token function\">global_node_page_state</span><span class=\"token punctuation\">(</span>NR_INACTIVE_FILE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ul>\n<li>ANONï¼šåŒ¿åé¡µï¼ŒåŒ¿åä»£è¡¨æ²¡æœ‰åå¤‡å­˜å‚¨ï¼Œè¿™ç§å†…å­˜å¦‚æœæƒ³å›æ”¶ï¼Œéœ€è¦æ¢å‡ºåˆ°ç¡¬ç›˜ä¸Šçš„ swap åˆ†åŒºï¼›</li>\n<li>FILEï¼šæ–‡ä»¶é¡µï¼Œæ–‡ä»¶ä»£è¡¨æœ‰æ–‡ä»¶å¯¹åº”ï¼Œè¿™ç§å†…å­˜å¦‚æœæƒ³å›æ”¶ï¼Œåªéœ€å°†æœ‰æ•°æ®æ›´æ–°çš„è„é¡µï¼ˆdirty pageï¼‰å†™å›åˆ°ç£ç›˜çš„æ–‡ä»¶ä¸­å³å¯ã€‚</li>\n</ul>\n<p>å†…å­˜çš„è®¡ç®— = æ´»è·ƒåŒ¿åé¡µ + æ´»è·ƒæ–‡ä»¶é¡µ + éæ´»è·ƒåŒ¿åé¡µ + éæ´»è·ƒæ–‡ä»¶é¡µã€‚</p>\n<h1 id=\"lowmem_scan\"><a class=\"anchor\" href=\"#lowmem_scan\">#</a> lowmem_scan</h1>\n<p><strong>é‡Šæ”¾ç¼“å­˜</strong></p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">//msm-google\\drivers\\staging\\android\\lowmemorykiller.c</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">static</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> <span class=\"token function\">lowmem_scan</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">struct</span> <span class=\"token class-name\">shrinker</span> <span class=\"token operator\">*</span>s<span class=\"token punctuation\">,</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">shrink_control</span> <span class=\"token operator\">*</span>sc<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">task_struct</span> <span class=\"token operator\">*</span>tsk<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">task_struct</span> <span class=\"token operator\">*</span>selected <span class=\"token operator\">=</span> <span class=\"token constant\">NULL</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> rem <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token keyword\">int</span> tasksize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t<span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token keyword\">short</span> min_score_adj <span class=\"token operator\">=</span> OOM_SCORE_ADJ_MAX <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">int</span> minfree <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token keyword\">int</span> selected_tasksize <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t<span class=\"token keyword\">short</span> selected_oom_score_adj<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token keyword\">int</span> array_size <span class=\"token operator\">=</span> <span class=\"token function\">ARRAY_SIZE</span><span class=\"token punctuation\">(</span>lowmem_adj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token comment\">// å½“å‰ç³»ç»Ÿå‰©ä½™å†…å­˜å¤§å°ï¼Œç®—æ³•ä¸ºï¼šåŸºäº free æ€»é‡å»é™¤å…¶ä¸­ä½œä¸º reserve ç®¡ç†ç»“æ„çš„éƒ¨åˆ†</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token keyword\">int</span> other_free <span class=\"token operator\">=</span> <span class=\"token function\">global_page_state</span><span class=\"token punctuation\">(</span>NR_FREE_PAGES<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> totalreserve_pages<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token comment\">// å½“å‰ç³»ç»Ÿ page cache çš„å¤§å°</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t<span class=\"token keyword\">int</span> other_file <span class=\"token operator\">=</span> <span class=\"token function\">global_node_page_state</span><span class=\"token punctuation\">(</span>NR_FILE_PAGES<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t\t\t<span class=\"token function\">global_node_page_state</span><span class=\"token punctuation\">(</span>NR_SHMEM<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\t\t<span class=\"token function\">global_node_page_state</span><span class=\"token punctuation\">(</span>NR_UNEVICTABLE<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\t\t<span class=\"token function\">total_swapcache_pages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lowmem_adj_size <span class=\"token operator\">&lt;</span> array_size<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\tarray_size <span class=\"token operator\">=</span> lowmem_adj_size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lowmem_minfree_size <span class=\"token operator\">&lt;</span> array_size<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\tarray_size <span class=\"token operator\">=</span> lowmem_minfree_size<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token comment\">// éå†æœ€å°å†…å­˜é˜ˆå€¼ï¼Œå¦‚æœå½“å‰å†…å­˜ä½äºé˜ˆå€¼ï¼ŒåŒæ—¶å½“å‰ page cache ä¹Ÿä½äºé˜ˆå€¼ï¼Œ</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token comment\">//(å†…å­˜å……è£•æ—¶ä¼šæœ‰å¤§é‡å†…å­˜å……å½“ page cache ä»¥æé«˜ç³»ç»Ÿ IO æ€§èƒ½)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token comment\">// åˆ™ä¸º min_score_adj èµ‹å€¼åé€€å‡º for å¾ªç¯</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> array_size<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\tminfree <span class=\"token operator\">=</span> lowmem_minfree<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>other_free <span class=\"token operator\">&lt;</span> minfree <span class=\"token operator\">&amp;&amp;</span> other_file <span class=\"token operator\">&lt;</span> minfree<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t\tmin_score_adj <span class=\"token operator\">=</span> lowmem_adj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t<span class=\"token function\">lowmem_print</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"lowmem_scan %lu, %x, ofree %d %d, ma %hd\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t     sc<span class=\"token operator\">-></span>nr_to_scan<span class=\"token punctuation\">,</span> sc<span class=\"token operator\">-></span>gfp_mask<span class=\"token punctuation\">,</span> other_free<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t     other_file<span class=\"token punctuation\">,</span> min_score_adj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token comment\">// å¦‚æœ min_score_adj ç­‰äºåˆå€¼ï¼Œåˆ™è¡¨ç¤ºå†…å­˜å……è¶³ï¼Œé€€å‡ºå‡½æ•°</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>min_score_adj <span class=\"token operator\">==</span> OOM_SCORE_ADJ_MAX <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t<span class=\"token function\">lowmem_print</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"lowmem_scan %lu, %x, return 0\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t     sc<span class=\"token operator\">-></span>nr_to_scan<span class=\"token punctuation\">,</span> sc<span class=\"token operator\">-></span>gfp_mask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\tselected_oom_score_adj <span class=\"token operator\">=</span> min_score_adj<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token comment\">// å†…æ ¸ RCU (Read-Copy Update) åŒæ­¥æœºåˆ¶</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token comment\">// éšæ„è¯»ï¼Œä½†æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦å…ˆå¤åˆ¶ä¸€ä»½å‰¯æœ¬ï¼Œåœ¨å‰¯æœ¬ä¸Šå®Œæˆä¿®æ”¹ï¼Œå†ä¸€æ¬¡æ€§åœ°æ›¿æ¢æ—§æ•°æ®</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t<span class=\"token function\">rcu_read_lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t<span class=\"token comment\">// éå†ç³»ç»Ÿè¿›ç¨‹ï¼Œè¦å¼€å§‹æ€è¿›ç¨‹äº†</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token function\">for_each_process</span><span class=\"token punctuation\">(</span>tsk<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t<span class=\"token keyword\">struct</span> <span class=\"token class-name\">task_struct</span> <span class=\"token operator\">*</span>p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t<span class=\"token keyword\">short</span> oom_score_adj<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t<span class=\"token comment\">// å†…æ ¸è¿›ç¨‹ï¼Œè·³è¿‡</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tsk<span class=\"token operator\">-></span>flags <span class=\"token operator\">&amp;</span> PF_KTHREAD<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token comment\">// å¯¹äºæ™®é€šç”¨æˆ·è¿›ç¨‹æ¥è¯´ï¼Œmm æŒ‡å‘è™šæ‹Ÿåœ°å€ç©ºé—´çš„ç”¨æˆ·ç©ºé—´éƒ¨åˆ†ï¼Œè€Œå¯¹äºå†…æ ¸çº¿ç¨‹ï¼Œmm ä¸º NULLã€‚</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t<span class=\"token comment\">// å†…æ ¸çº¿ç¨‹å’Œæ™®é€šçš„è¿›ç¨‹é—´çš„åŒºåˆ«åœ¨äºå†…æ ¸çº¿ç¨‹æ²¡æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œmm æŒ‡é’ˆè¢«è®¾ç½®ä¸º NULLï¼›</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t<span class=\"token comment\">// å®ƒåªåœ¨å†…æ ¸ç©ºé—´è¿è¡Œï¼Œä»æ¥ä¸åˆ‡æ¢åˆ°ç”¨æˆ·ç©ºé—´å»ï¼›å¹¶ä¸”å’Œæ™®é€šè¿›ç¨‹ä¸€æ ·ï¼Œå¯ä»¥è¢«è°ƒåº¦ï¼Œä¹Ÿå¯ä»¥è¢«æŠ¢å ã€‚</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t\t<span class=\"token comment\">// å¦‚æœæ˜¯å†…æ ¸çº¿ç¨‹ï¼Œç›´æ¥è·³è¿‡</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t\tp <span class=\"token operator\">=</span> <span class=\"token function\">find_lock_task_mm</span><span class=\"token punctuation\">(</span>tsk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">task_lmk_waiting</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t    <span class=\"token function\">time_before_eq</span><span class=\"token punctuation\">(</span>jiffies<span class=\"token punctuation\">,</span> lowmem_deathpending_timeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t\t<span class=\"token function\">task_unlock</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t\t<span class=\"token function\">rcu_read_unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>\t\t\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t<span class=\"token comment\">// å¦‚æœå½“å‰æ‰¾åˆ°çš„è¿›ç¨‹çš„ oom_score_adj æ¯”å½“å‰éœ€è¦æ€çš„æœ€å°ä¼˜å…ˆçº§è¿˜ä½ï¼Œä¸æ€</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\toom_score_adj <span class=\"token operator\">=</span> p<span class=\"token operator\">-></span>signal<span class=\"token operator\">-></span>oom_score_adj<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oom_score_adj <span class=\"token operator\">&lt;</span> min_score_adj<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t\t<span class=\"token function\">task_unlock</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t<span class=\"token comment\">// è·å–è¿›ç¨‹çš„å ç”¨å†…å­˜å¤§å° (rss å€¼)</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t<span class=\"token comment\">//rss: resident set size, the non-swappend physical memory that a task has used in.</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\ttasksize <span class=\"token operator\">=</span> <span class=\"token function\">get_mm_rss</span><span class=\"token punctuation\">(</span>p<span class=\"token operator\">-></span>mm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\t<span class=\"token function\">task_unlock</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tasksize <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t<span class=\"token comment\">// é¦–ä¸ªè¿›ç¨‹ï¼Œselected å€¼å¿…ä¸º NULL</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>selected<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t\t<span class=\"token comment\">// é«˜ä¼˜å…ˆçº§è¿›ç¨‹ï¼Œä¸æ€</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oom_score_adj <span class=\"token operator\">&lt;</span> selected_oom_score_adj<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t\t<span class=\"token comment\">// åŒä¼˜å…ˆçº§è¿›ç¨‹ï¼Œå¦‚æœè¯¥è¿›ç¨‹å ç”¨å†…å­˜å°äºé˜ˆå€¼ï¼ŒåŒæ ·ä¸æ€</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oom_score_adj <span class=\"token operator\">==</span> selected_oom_score_adj <span class=\"token operator\">&amp;&amp;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t\t    tasksize <span class=\"token operator\">&lt;=</span> selected_tasksize<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>\t\t<span class=\"token comment\">// å·²ç»æ‰¾åˆ°äº†éœ€è¦ kill çš„è¿›ç¨‹ï¼Œæ›´æ–°å®ƒçš„ tasksize ä¸ oom_score_adj</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>\t\tselected <span class=\"token operator\">=</span> p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>\t\tselected_tasksize <span class=\"token operator\">=</span> tasksize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>\t\tselected_oom_score_adj <span class=\"token operator\">=</span> oom_score_adj<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>\t\t<span class=\"token function\">lowmem_print</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"select '%s' (%d), adj %hd, size %d, to kill\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\t\t     p<span class=\"token operator\">-></span>comm<span class=\"token punctuation\">,</span> p<span class=\"token operator\">-></span>pid<span class=\"token punctuation\">,</span> oom_score_adj<span class=\"token punctuation\">,</span> tasksize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>selected<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>\t\t<span class=\"token keyword\">long</span> cache_size <span class=\"token operator\">=</span> other_file <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>PAGE_SIZE <span class=\"token operator\">/</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>\t\t<span class=\"token keyword\">long</span> cache_limit <span class=\"token operator\">=</span> minfree <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>PAGE_SIZE <span class=\"token operator\">/</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>\t\t<span class=\"token keyword\">long</span> free <span class=\"token operator\">=</span> other_free <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>PAGE_SIZE <span class=\"token operator\">/</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t\t<span class=\"token function\">task_lock</span><span class=\"token punctuation\">(</span>selected<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>\t\t<span class=\"token comment\">// å‘é€ SIGKILL ä¿¡å·ï¼Œæ€æ­»è¿™ä¸ªè¿›ç¨‹</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\t<span class=\"token function\">send_sig</span><span class=\"token punctuation\">(</span>SIGKILL<span class=\"token punctuation\">,</span> selected<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>selected<span class=\"token operator\">-></span>mm<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>\t\t\t<span class=\"token function\">task_set_lmk_waiting</span><span class=\"token punctuation\">(</span>selected<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>\t\t<span class=\"token function\">task_unlock</span><span class=\"token punctuation\">(</span>selected<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>\t\t<span class=\"token function\">trace_lowmemory_kill</span><span class=\"token punctuation\">(</span>selected<span class=\"token punctuation\">,</span> cache_size<span class=\"token punctuation\">,</span> cache_limit<span class=\"token punctuation\">,</span> free<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>\t\t<span class=\"token function\">lowmem_print</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Killing '%s' (%d) (tgid %d), adj %hd,\\n\"</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>\t\t\t\t <span class=\"token string\">\"   to free %ldkB on behalf of '%s' (%d) because\\n\"</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>\t\t\t\t <span class=\"token string\">\"   cache %ldkB is below limit %ldkB for oom_score_adj %hd\\n\"</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>\t\t\t\t <span class=\"token string\">\"   Free memory is %ldkB above reserved\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>\t\t\t     selected<span class=\"token operator\">-></span>comm<span class=\"token punctuation\">,</span> selected<span class=\"token operator\">-></span>pid<span class=\"token punctuation\">,</span> selected<span class=\"token operator\">-></span>tgid<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>\t\t\t     selected_oom_score_adj<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>\t\t\t     selected_tasksize <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>PAGE_SIZE <span class=\"token operator\">/</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>\t\t\t     current<span class=\"token operator\">-></span>comm<span class=\"token punctuation\">,</span> current<span class=\"token operator\">-></span>pid<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>\t\t\t     cache_size<span class=\"token punctuation\">,</span> cache_limit<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>\t\t\t     min_score_adj<span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t\t\t     free<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>\t\tlowmem_deathpending_timeout <span class=\"token operator\">=</span> jiffies <span class=\"token operator\">+</span> HZ<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>\t\trem <span class=\"token operator\">+=</span> selected_tasksize<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>\t\t<span class=\"token function\">get_task_struct</span><span class=\"token punctuation\">(</span>selected<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>\t<span class=\"token function\">lowmem_print</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"lowmem_scan %lu, %x, return %lu\\n\"</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>\t\t     sc<span class=\"token operator\">-></span>nr_to_scan<span class=\"token punctuation\">,</span> sc<span class=\"token operator\">-></span>gfp_mask<span class=\"token punctuation\">,</span> rem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>\t<span class=\"token function\">rcu_read_unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>selected<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>\t\t<span class=\"token function\">handle_lmk_event</span><span class=\"token punctuation\">(</span>selected<span class=\"token punctuation\">,</span> selected_tasksize<span class=\"token punctuation\">,</span> min_score_adj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>\t\t<span class=\"token function\">put_task_struct</span><span class=\"token punctuation\">(</span>selected<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>\t<span class=\"token keyword\">return</span> rem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"å‚è€ƒèµ„æ–™\"><a class=\"anchor\" href=\"#å‚è€ƒèµ„æ–™\">#</a> å‚è€ƒèµ„æ–™</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXR5dWFuLmNvbS8yMDE2LzA5LzE3L2FuZHJvaWQtbG93bWVtb3J5a2lsbGVyLw==\">Android LowMemoryKiller åŸç†åˆ†æ</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8yMjFmNGEyNDZiNDU=\">Android è¿›ç¨‹ç³»åˆ—ç¬¬å…­ç¯‡ â€”LowmemoryKiller æœºåˆ¶åˆ†æ (ä¸Š)</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC85ODBiNmNlNGUwNTE=\">Android è¿›ç¨‹ç³»åˆ—ç¬¬ä¸ƒç¯‡ â€”LowmemoryKiller æœºåˆ¶åˆ†æ (ä¸­)</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC83YmQzZDBlZThhNTY=\">Android è¿›ç¨‹ç³»åˆ—ç¬¬å…«ç¯‡ â€”LowmemoryKiller æœºåˆ¶åˆ†æ (ä¸‹)</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81MDAyNTk2ODQ=\">linux å†…æ ¸ï¼šä¸€æ–‡è¯»æ‡‚ lowmemorykiller æœºåˆ¶</span></li>\n</ul>\n",
            "tags": []
        }
    ]
}